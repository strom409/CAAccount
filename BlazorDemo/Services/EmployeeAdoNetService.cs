using DevExpress.DataProcessing.InMemoryDataProcessor;
using Microsoft.Data.SqlClient;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using static BlazorDemo.Pages.Definitions.EditGrowerAgreement_;
//using static System.Runtime.InteropServices.JavaScript.JSType;

namespace BlazorDemo.Services
{
    public class EmployeeAdoNetService : IEmployeeService
    {
        private readonly SqlConnectionConfiguration _configuration;
        private readonly AppStateService _appState;
        public EmployeeAdoNetService(SqlConnectionConfiguration configuration, AppStateService appState)



        //  public EmployeeAdoNetService(SqlConnectionConfiguration configuration, IHubContext<DataHub> hubContext)
        {
            _configuration = configuration;
            _appState = appState;
        }



        public async Task<bool> DoesProductExistAsync(string Prodname)

        {
            CompanyModel companyModel = new CompanyModel();
            using (SqlConnection connection = new SqlConnection(_configuration.Value))
            {
                await connection.OpenAsync();

                var command = new SqlCommand(
                    "SELECT COUNT(1) FROM prodtype WHERE Name = @Name",
                    connection);

                command.Parameters.AddWithValue("@Name", Prodname);

                int count = (int)command.ExecuteScalar();
                return count > 0;


            } // Connection is automatically closed and disposed here
        }

        public async Task<bool> AddProduct(CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "insert into dbo.prodtype (id,name,prodetails) values((select max(id+1) from prodtype),@Prodname,@Prodetails)";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Prodname", companyModel.Prodname);
                cmd.Parameters.AddWithValue("@Prodetails", companyModel.Prodetails);
                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }

        public async Task<bool> DoesServiceExistAsync(string stname)

        {
            CompanyModel companyModel = new CompanyModel();
            using (SqlConnection connection = new SqlConnection(_configuration.Value))
            {
                await connection.OpenAsync();

                var command = new SqlCommand(
                    "SELECT COUNT(1) FROM servicetypes WHERE sname = @Name",
                    connection);

                command.Parameters.AddWithValue("@Name", stname);

                int count = (int)command.ExecuteScalar();
                return count > 0;


            } // Connection is automatically closed and disposed here
        }

        public async Task<bool> AddService(CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "insert into dbo.servicetypes (id,sname,sdescrip) values((select isnull(max(id+1),1) from servicetypes),@Stname,@Stdetails)";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Stname", companyModel.Stname);
                cmd.Parameters.AddWithValue("@Stdetails", companyModel.Stdetails);
                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }


        public async Task<bool> DoesCratetypeExistAsync(string stname)

        {
            CompanyModel companyModel = new CompanyModel();
            using (SqlConnection connection = new SqlConnection(_configuration.Value))
            {
                await connection.OpenAsync();

                var command = new SqlCommand(
                    "SELECT COUNT(1) FROM crtypes WHERE name = @Name",
                    connection);

                command.Parameters.AddWithValue("@Name", stname);

                int count = (int)command.ExecuteScalar();
                return count > 0;


            } // Connection is automatically closed and disposed here
        }

        public async Task<bool> AddCrateTypes(CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "insert into dbo.crtypes (id,name,Crqty) values((select isnull(max(id+1),1) from crtypes),@Crname,@Crqty)";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Crname", companyModel.Crname);
                //   cmd.Parameters.Add("@Crqty", SqlDbType.Decimal,companyModel.Crqty);
                cmd.Parameters.Add("@Crqty", SqlDbType.Decimal).Value = companyModel.Crqty;

                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }



        public async Task<bool> DoesCrateflagExistAsync(string stname)

        {
            CompanyModel companyModel = new CompanyModel();
            using (SqlConnection connection = new SqlConnection(_configuration.Value))
            {
                await connection.OpenAsync();

                var command = new SqlCommand(
                    "SELECT COUNT(1) FROM CrateFlags WHERE name = @Name",
                    connection);

                command.Parameters.AddWithValue("@Name", stname);

                int count = (int)command.ExecuteScalar();
                return count > 0;


            } // Connection is automatically closed and disposed here
        }

        public async Task<bool> AddCrateflag(CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "insert into dbo.CrateFlags (id,name,ftype,srtype) values((select isnull(max(id+1),1) from CrateFlags),@Cfname,@Cfstat,@Cflag)";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Cfname", companyModel.Cfname);
                cmd.Parameters.AddWithValue("@Cfstat", companyModel.Cfstat);
                cmd.Parameters.AddWithValue("@Cflag", companyModel.Cflag);


                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }



















        public async Task<bool> DoesPackageExistAsync(string Pkname)

        {
            CompanyModel companyModel = new CompanyModel();
            using (SqlConnection connection = new SqlConnection(_configuration.Value))
            {
                await connection.OpenAsync();

                var command = new SqlCommand(
                    "SELECT COUNT(1) FROM ptype WHERE Name = @Name",
                    connection);

                command.Parameters.AddWithValue("@Name", Pkname);

                int count = (int)command.ExecuteScalar();
                return count > 0;


            } // Connection is automatically closed and disposed here
        }






















        public async Task<bool> AddPackage(CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "insert into dbo.ptype (id,name,pdescrip) values((select max(id+1) from ptype),@Pkname,@Pkdetails)";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Pkname", companyModel.Pkname);
                cmd.Parameters.AddWithValue("@Pkdetails", companyModel.Pkdetails);
                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }














        public async Task<bool> DoesQualityExistAsync(string Qname)

        {
            CompanyModel companyModel = new CompanyModel();
            using (SqlConnection connection = new SqlConnection(_configuration.Value))
            {
                await connection.OpenAsync();

                var command = new SqlCommand(
                    "SELECT COUNT(1) FROM prodqaul WHERE Name = @Name",
                    connection);

                command.Parameters.AddWithValue("@Name", Qname);

                int count = (int)command.ExecuteScalar();
                return count > 0;


            } // Connection is automatically closed and disposed here
        }

        public async Task<bool> AddQuality(CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "insert into dbo.prodqaul (id,name,qdescrip) values((select isnull(max(id+1),1) from prodqaul),@Qname,@Qdetails)";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Qname", companyModel.Qname);
                cmd.Parameters.AddWithValue("@Qdetails", companyModel.Qdetails);
                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }






























        public async Task<bool> AddBank(CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "insert into dbo.Bank_info (Id,Name,branch,bankname,ifsc,accname,Accno) values((select max(id+1) from Bank_info),@Name,@Branch,@bankname,@ifsc,@accname,@Accno)";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Name", companyModel.Bname);
                cmd.Parameters.AddWithValue("@Branch", companyModel.Branch);
                cmd.Parameters.AddWithValue("@bankname", companyModel.Accname);
                cmd.Parameters.AddWithValue("@ifsc", companyModel.Ifsc);
                cmd.Parameters.AddWithValue("@accname", companyModel.Accname);
                cmd.Parameters.AddWithValue("@Accno", companyModel.Accno);






                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }

        public async Task<CompanyModel?> addCrateIssue(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomicity
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("addCrateIssueproc", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fix: Remove extra space in "@userid " (should be "@userid")
                            cmd.Parameters.AddWithValue("@Cdate", EditModel.CrateIssueDated);
                            cmd.Parameters.AddWithValue("@Partyname", EditModel.GrowerGroupName);
                            cmd.Parameters.AddWithValue("@GrowerName", EditModel.GrowerName);
                            cmd.Parameters.AddWithValue("@challanName", EditModel.ChallanName);
                            cmd.Parameters.AddWithValue("@userid", EditModel.UserId); // Fixed parameter name
                            cmd.Parameters.AddWithValue("@crateMark", EditModel.CrissueMark);
                            cmd.Parameters.AddWithValue("@Vehno", EditModel.Vehno);
                            cmd.Parameters.AddWithValue("@Remarks", EditModel.CrissueRemarks);
                            cmd.Parameters.AddWithValue("@Qty", EditModel.CrissueQty);

                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit(); // Commit only if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback(); // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }







        public async Task<CompanyModel?> AddPreinward(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomicity
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("UploadPreinwardtemp", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fix: Remove extra space in "@userid " (should be "@userid")
                            cmd.Parameters.AddWithValue("@pdate", EditModel.PreinwardDate);
                            cmd.Parameters.AddWithValue("@Partyname", EditModel.GrowerGroupName);
                            cmd.Parameters.AddWithValue("@GrowerName", EditModel.GrowerName);
                            cmd.Parameters.AddWithValue("@challanName", EditModel.ChallanName);
                            cmd.Parameters.AddWithValue("@challanNo", EditModel.ChallanNo);
                            cmd.Parameters.AddWithValue("@username", EditModel.GlobalUserName); // Fixed parameter name
                            cmd.Parameters.AddWithValue("@productName", EditModel.Itemname);
                            cmd.Parameters.AddWithValue("@KhataName", EditModel.PreInwardKhata);
                            cmd.Parameters.AddWithValue("@vehno", EditModel.Vehno);
                            cmd.Parameters.AddWithValue("@Remarks", EditModel.PreInwardRemarks);
                            cmd.Parameters.AddWithValue("@Qty", EditModel.PreInwardQty);
                            cmd.Parameters.AddWithValue("@CrateType", EditModel.PreCrateType);
                            cmd.Parameters.AddWithValue("@SchemeName", EditModel.ServiceId);
                            cmd.Parameters.AddWithValue("@companyCrates", EditModel.StoreQty);
                            cmd.Parameters.AddWithValue("@OwnCrates", EditModel.OwnQty);
                            cmd.Parameters.AddWithValue("@uom", EditModel.PreInwardUom);
                            cmd.Parameters.AddWithValue("@chamberId", EditModel.ChamberId);
                            cmd.Parameters.AddWithValue("@VariertyName", EditModel.VarietyId);
                            cmd.Parameters.AddWithValue("@preirn", EditModel.TempGateInIrn);
                            cmd.Parameters.AddWithValue("@Gateid", EditModel.TempGateInId);





                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit(); // Commit only if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback(); // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }









        public async Task<CompanyModel?> AddMixlot(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomicity
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("AddMixlot", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fix: Remove extra space in "@userid " (should be "@userid")
                            cmd.Parameters.AddWithValue("@Preid", 1);
                            cmd.Parameters.AddWithValue("@KhataName", EditModel.Mixlotkhata);
                            cmd.Parameters.AddWithValue("@VariertyName", EditModel.VarietyId);
                            cmd.Parameters.AddWithValue("@Mixqty", EditModel.SplitlotQty);
                            cmd.Parameters.AddWithValue("@Lotno", EditModel.Lotno);






                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks,unitid FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                    EditModel.Mixlotno = rdr.GetInt32(rdr.GetOrdinal("unitid"));

                                }
                            }
                        }

                        transaction.Commit(); // Commit only if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback(); // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }
























        public async Task<CompanyModel?> UpdatePrn(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomicity
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("UpdatePrn", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fix: Remove extra space in "@userid " (should be "@userid")
                            cmd.Parameters.AddWithValue("@pdate", EditModel.PreinwardDate);
                            cmd.Parameters.AddWithValue("@Partyname", EditModel.GrowerGroupName);
                            cmd.Parameters.AddWithValue("@GrowerName", EditModel.GrowerName);
                            cmd.Parameters.AddWithValue("@challanName", EditModel.ChallanName);
                            cmd.Parameters.AddWithValue("@challanNo", EditModel.ChallanNo);
                            cmd.Parameters.AddWithValue("@username", EditModel.GlobalUserName); // Fixed parameter name
                            cmd.Parameters.AddWithValue("@vehno", EditModel.Vehno);
                            cmd.Parameters.AddWithValue("@Remarks", EditModel.PreInwardRemarks);
                            cmd.Parameters.AddWithValue("@preirn", EditModel.PreInIrn);
                            cmd.Parameters.AddWithValue("@Gateid", EditModel.PreInwardId);





                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit(); // Commit only if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback(); // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }


        public async Task<CompanyModel?> PostPrn(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomicity
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("UploadPreinwardFinal", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fix: Remove extra space in "@userid " (should be "@userid")
                            cmd.Parameters.AddWithValue("@pdate", EditModel.PreinwardDate);
                            cmd.Parameters.AddWithValue("@Partyname", EditModel.GrowerGroupName);
                            cmd.Parameters.AddWithValue("@GrowerName", EditModel.GrowerName);
                            cmd.Parameters.AddWithValue("@challanName", EditModel.ChallanName);
                            cmd.Parameters.AddWithValue("@challanNo", EditModel.ChallanNo);
                            cmd.Parameters.AddWithValue("@username", EditModel.GlobalUserName); // Fixed parameter name
                            cmd.Parameters.AddWithValue("@vehno", EditModel.Vehno);
                            cmd.Parameters.AddWithValue("@Remarks", EditModel.PreInwardRemarks);
                            cmd.Parameters.AddWithValue("@chamberid", EditModel.ChamberId);

                            cmd.Parameters.AddWithValue("@preirn", EditModel.TempGateInIrn);
                            cmd.Parameters.AddWithValue("@Gateid", EditModel.TempGateInId);





                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit(); // Commit only if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback(); // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }




        public async Task<CompanyModel?> GenerateDraftReport(string bankid,CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomicity
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("generaterepackreport", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fix: Remove extra space in "@userid " (should be "@userid")
                            cmd.Parameters.AddWithValue("@d1", EditModel.DraftDatefrom);
                            cmd.Parameters.AddWithValue("@d2", EditModel.DraftDateTo);

                            cmd.Parameters.AddWithValue("@Partyid", EditModel.Partyid);
                         
                            cmd.Parameters.AddWithValue("@Recep", EditModel.ReceipeName);
                            cmd.Parameters.AddWithValue("@variety", EditModel.VarietyId);
                            cmd.Parameters.AddWithValue("@stype", EditModel.stockType); // Fixed parameter name
                            cmd.Parameters.AddWithValue("@Draftid", bankid ?? (object)DBNull.Value);
                            cmd.Parameters.AddWithValue("@Receipeid", 0);
                            cmd.Parameters.AddWithValue("@Brandidid", 0);
                         




                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit(); // Commit only if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback(); // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }



        public async Task<CompanyModel?> GenerateOutwardReport(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomicity
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("GenerateOutwardReport", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fix: Remove extra space in "@userid " (should be "@userid")
                            cmd.Parameters.AddWithValue("@d1", EditModel.Outdatefrom);
                            cmd.Parameters.AddWithValue("@d2", EditModel.OutdateTo);

                            cmd.Parameters.AddWithValue("@Partyid", EditModel.Partyid);

                            cmd.Parameters.AddWithValue("@Recep", EditModel.ReceipeName);
                            cmd.Parameters.AddWithValue("@variety", EditModel.VarietyId);
                             cmd.Parameters.AddWithValue("@Draftid", EditModel.DraftIrn);
                            cmd.Parameters.AddWithValue("@Outward", EditModel.OutwardIrn);
                            cmd.Parameters.AddWithValue("@Username", EditModel.UserName);


                            cmd.Parameters.AddWithValue("@Receipeid", 0);
                            cmd.Parameters.AddWithValue("@Brandidid", 0);
                            cmd.Parameters.AddWithValue("@Userid", 0);





                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit(); // Commit only if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback(); // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }

























        // UpdateQualityProc
        public async Task<CompanyModel?> AddQualityProc(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomicity
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("AddQuality", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fix: Remove extra space in "@userid " (should be "@userid")
                            cmd.Parameters.AddWithValue("@Preinwardid", EditModel.PreInwardId);
                            cmd.Parameters.AddWithValue("@Lotno", EditModel.Lotno);
                            cmd.Parameters.AddWithValue("@pressure", EditModel.AvgPressure);
                            cmd.Parameters.AddWithValue("@AvgWeight", EditModel.AvgWeight);
                            cmd.Parameters.AddWithValue("@createdby", EditModel.GlobalUserName);
                            cmd.Parameters.AddWithValue("@remarks", EditModel.QualityRemarks); // Fixed parameter name
                            cmd.Parameters.AddWithValue("@avgsizeName", EditModel.AvgSize);
                            cmd.Parameters.AddWithValue("@bgradeAvgCrate", EditModel.BGradeAvgType);
                            cmd.Parameters.AddWithValue("@BgradeValue", EditModel.BGradeAvgValue);

                            cmd.Parameters.AddWithValue("@bgrade1", EditModel.BGradeAvg1);
                            cmd.Parameters.AddWithValue("@bgrade2", EditModel.BGradeAvg2);
                            cmd.Parameters.AddWithValue("@pressure1", EditModel.Pressure1);
                            cmd.Parameters.AddWithValue("@pressure2", EditModel.Pressure2);
                            cmd.Parameters.AddWithValue("@pressure3", EditModel.Pressure3);
                            cmd.Parameters.AddWithValue("@Weight1", EditModel.AvgWeight1);
                            cmd.Parameters.AddWithValue("@Weight2", EditModel.AvgWeight2);
                            cmd.Parameters.AddWithValue("@Weight3", EditModel.AvgWeight3);
                            cmd.Parameters.AddWithValue("@lesscolor", EditModel.LessColorPercentage);
                            cmd.Parameters.AddWithValue("@Brandid", EditModel.VarietyId);
                            cmd.Parameters.AddWithValue("@chambershift", EditModel.NewchamberId);
                            cmd.Parameters.AddWithValue("@WaterCore", EditModel.HasWaterCore);
                            cmd.Parameters.AddWithValue("@Scabe", EditModel.HasScab);
                            cmd.Parameters.AddWithValue("@bitterrot", EditModel.HasBitterRot);
                            cmd.Parameters.AddWithValue("@olla", EditModel.HasOlla);
                            cmd.Parameters.AddWithValue("@flyspeck", EditModel.HasFlySpeck);


                            cmd.Parameters.AddWithValue("@Rusting", EditModel.HasRusting);
                            cmd.Parameters.AddWithValue("@bitterpit", EditModel.HasBitterPit);
                            cmd.Parameters.AddWithValue("@blouch", EditModel.HasBlouch);
                            cmd.Parameters.AddWithValue("@sanjose", EditModel.HasSanjose);
                            cmd.Parameters.AddWithValue("@Touch", EditModel.HasTouch);
                            cmd.Parameters.AddWithValue("@Sunburn", EditModel.HasSunburn);
                            cmd.Parameters.AddWithValue("@insecthole", EditModel.HasInsectHole);
                            cmd.Parameters.AddWithValue("@scar", EditModel.HasScar);













                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit(); // Commit only if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback(); // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }





        public async Task<CompanyModel?> UpdateDock(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomicity
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("UpdateDock", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fix: Remove extra space in "@userid " (should be "@userid")
                            cmd.Parameters.AddWithValue("@Lotno", EditModel.Lotno);
                            cmd.Parameters.AddWithValue("@createdby", EditModel.GlobalUserName);
                            cmd.Parameters.AddWithValue("@Brandid", EditModel.VarietyId);
                            cmd.Parameters.AddWithValue("@Tlocation", EditModel.Templocation);
                            cmd.Parameters.AddWithValue("@VCrates", EditModel.VerfiedQty);
                            cmd.Parameters.AddWithValue("@VownCrates", EditModel.VerfiedOwnCrates);
                            cmd.Parameters.AddWithValue("@VCompCrates", EditModel.VerfiedCompanyCrates);
                            cmd.Parameters.AddWithValue("@VPetties", EditModel.Verfiedpetties);
                            cmd.Parameters.AddWithValue("@Vbins", EditModel.Verfiedbins);
                            cmd.Parameters.AddWithValue("@VPallets", EditModel.Verfiedpallets);
                            cmd.Parameters.AddWithValue("@isgrading", EditModel.IsGrading);
                            cmd.Parameters.AddWithValue("@cratemarka", EditModel.CrateMarka);








                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit(); // Commit only if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback(); // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }






        public async Task<CompanyModel?> AddBoxDetails(CompanyModel EditModel, int id)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomicity
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("AddBoxDetails", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fix: Remove extra space in "@userid " (should be "@userid")
                            cmd.Parameters.AddWithValue("@PackingOrderId", id);
                            cmd.Parameters.AddWithValue("@Hcase", EditModel.HcaseName);
                            cmd.Parameters.AddWithValue("@Box", EditModel.BoxName);







                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit(); // Commit only if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback(); // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }





























        public async Task<CompanyModel?> InsertLocation(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomicity
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("InsertLocation", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fix: Remove extra space in "@userid " (should be "@userid")
                            cmd.Parameters.AddWithValue("@Lotno", EditModel.Lotno);
                            cmd.Parameters.AddWithValue("@LotIrn", EditModel.LotIrn);

                            cmd.Parameters.AddWithValue("@createdby", EditModel.GlobalUserName);
                            cmd.Parameters.AddWithValue("@LocationId", EditModel.Templocation);
                            cmd.Parameters.AddWithValue("@Chamberid", EditModel.ChamberId);
                            cmd.Parameters.AddWithValue("@FloorName", EditModel.FloorName);
                            cmd.Parameters.AddWithValue("@MatrixName", EditModel.MatrixName);


                            cmd.Parameters.AddWithValue("@RowName", EditModel.RowName);


                            cmd.Parameters.AddWithValue("@ColumName", EditModel.ColumName);
                            cmd.Parameters.AddWithValue("@TotalBins", EditModel.Verfiedbins);
                            cmd.Parameters.AddWithValue("@TotalCrates", EditModel.CrateNos);








                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit(); // Commit only if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback(); // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }
















        public async Task<CompanyModel?> UpdateQualityProc(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomicity
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("UpdateQualityProc", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fix: Remove extra space in "@userid " (should be "@userid")
                            cmd.Parameters.AddWithValue("@Preinwardid", EditModel.PreInwardId);
                            cmd.Parameters.AddWithValue("@Lotno", EditModel.Lotno);
                            cmd.Parameters.AddWithValue("@pressure", EditModel.AvgPressure);
                            cmd.Parameters.AddWithValue("@AvgWeight", EditModel.AvgWeight);
                            cmd.Parameters.AddWithValue("@createdby", EditModel.GlobalUserName);
                            cmd.Parameters.AddWithValue("@remarks", EditModel.QualityRemarks); // Fixed parameter name
                            cmd.Parameters.AddWithValue("@avgsizeName", EditModel.AvgSize);
                            cmd.Parameters.AddWithValue("@bgradeAvgCrate", EditModel.BGradeAvgType);
                            cmd.Parameters.AddWithValue("@BgradeValue", EditModel.BGradeAvgValue);

                            cmd.Parameters.AddWithValue("@bgrade1", EditModel.BGradeAvg1);
                            cmd.Parameters.AddWithValue("@bgrade2", EditModel.BGradeAvg2);
                            cmd.Parameters.AddWithValue("@pressure1", EditModel.Pressure1);
                            cmd.Parameters.AddWithValue("@pressure2", EditModel.Pressure2);
                            cmd.Parameters.AddWithValue("@pressure3", EditModel.Pressure3);
                            cmd.Parameters.AddWithValue("@Weight1", EditModel.AvgWeight1);
                            cmd.Parameters.AddWithValue("@Weight2", EditModel.AvgWeight2);
                            cmd.Parameters.AddWithValue("@Weight3", EditModel.AvgWeight3);
                            cmd.Parameters.AddWithValue("@lesscolor", EditModel.LessColorPercentage);
                            cmd.Parameters.AddWithValue("@Brandid", EditModel.VarietyId);
                            cmd.Parameters.AddWithValue("@chambershift", EditModel.NewchamberId);
                            cmd.Parameters.AddWithValue("@WaterCore", EditModel.HasWaterCore);
                            cmd.Parameters.AddWithValue("@Scabe", EditModel.HasScab);
                            cmd.Parameters.AddWithValue("@bitterrot", EditModel.HasBitterRot);
                            cmd.Parameters.AddWithValue("@olla", EditModel.HasOlla);
                            cmd.Parameters.AddWithValue("@flyspeck", EditModel.HasFlySpeck);


                            cmd.Parameters.AddWithValue("@Rusting", EditModel.HasRusting);
                            cmd.Parameters.AddWithValue("@bitterpit", EditModel.HasBitterPit);
                            cmd.Parameters.AddWithValue("@blouch", EditModel.HasBlouch);
                            cmd.Parameters.AddWithValue("@sanjose", EditModel.HasSanjose);
                            cmd.Parameters.AddWithValue("@Touch", EditModel.HasTouch);
                            cmd.Parameters.AddWithValue("@Sunburn", EditModel.HasSunburn);
                            cmd.Parameters.AddWithValue("@insecthole", EditModel.HasInsectHole);
                            cmd.Parameters.AddWithValue("@scar", EditModel.HasScar);













                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit(); // Commit only if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback(); // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }



        public async Task<CompanyModel?> UpdateTrid(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomicity
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("UpdateTrid", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fix: Remove extra space in "@userid " (should be "@userid")
                            cmd.Parameters.AddWithValue("@productName", EditModel.Itemname);
                            cmd.Parameters.AddWithValue("@KhataName", EditModel.PreInwardKhata);
                            cmd.Parameters.AddWithValue("@Qty", EditModel.PreInwardQty);
                            cmd.Parameters.AddWithValue("@CrateType", EditModel.PreCrateType);
                            cmd.Parameters.AddWithValue("@SchemeName", EditModel.ServiceId);
                            cmd.Parameters.AddWithValue("@companyCrates", EditModel.StoreQty);
                            cmd.Parameters.AddWithValue("@OwnCrates", EditModel.OwnQty);
                            cmd.Parameters.AddWithValue("@uom", EditModel.PreInwardUom);
                            cmd.Parameters.AddWithValue("@chamberId", EditModel.ChamberId);
                            cmd.Parameters.AddWithValue("@VariertyName", EditModel.VarietyId);
                            cmd.Parameters.AddWithValue("@preirn", EditModel.TempGateInIrn);
                            cmd.Parameters.AddWithValue("@Gateid", EditModel.TempGateInId);
                            cmd.Parameters.AddWithValue("@Trid", EditModel.Trid);





                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit(); // Commit only if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback(); // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }







        public async Task<CompanyModel?> UpdateLotno(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomicity
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("UpdateLotno", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fix: Remove extra space in "@userid " (should be "@userid")
                            cmd.Parameters.AddWithValue("@productName", EditModel.Itemname);
                            cmd.Parameters.AddWithValue("@KhataName", EditModel.PreInwardKhata);
                            cmd.Parameters.AddWithValue("@Qty", EditModel.PreInwardQty);
                            cmd.Parameters.AddWithValue("@CrateType", EditModel.PreCrateType);
                            cmd.Parameters.AddWithValue("@SchemeName", EditModel.ServiceId);
                            cmd.Parameters.AddWithValue("@companyCrates", EditModel.StoreQty);
                            cmd.Parameters.AddWithValue("@OwnCrates", EditModel.OwnQty);
                            cmd.Parameters.AddWithValue("@uom", EditModel.PreInwardUom);
                            cmd.Parameters.AddWithValue("@chamberId", EditModel.ChamberId);
                            cmd.Parameters.AddWithValue("@VariertyName", EditModel.VarietyId);
                            cmd.Parameters.AddWithValue("@preirn", EditModel.PreInIrn);
                            cmd.Parameters.AddWithValue("@Gateid", EditModel.PreInwardId);
                            cmd.Parameters.AddWithValue("@trid", EditModel.Lotno);





                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit(); // Commit only if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback(); // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }












        public async Task<CompanyModel?> GeneratePreinward(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomicity
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("GeneratePreinward", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fix: Remove extra space in "@userid " (should be "@userid")
                            cmd.Parameters.AddWithValue("@pdate", EditModel.PreinwardDate);
                            cmd.Parameters.AddWithValue("@Partyname", EditModel.GrowerGroupName);
                            cmd.Parameters.AddWithValue("@GrowerName", EditModel.GrowerName);
                            cmd.Parameters.AddWithValue("@challanName", EditModel.ChallanName);
                            cmd.Parameters.AddWithValue("@challanNo", EditModel.ChallanNo);
                            cmd.Parameters.AddWithValue("@vehno", EditModel.Vehno);
                            cmd.Parameters.AddWithValue("@Remarks", EditModel.PreInwardRemarks);

                            cmd.Parameters.AddWithValue("@username", EditModel.GlobalUserName); // Fixed parameter name




                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit(); // Commit only if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback(); // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }



        public async Task AddCheckedItemsToDatabase(List<CompanyModel> checkedItems, int Tempid)
        {
            using (SqlConnection connection = new SqlConnection(_configuration.Value))

            {
                await connection.OpenAsync();

                using (SqlTransaction transaction = connection.BeginTransaction())
                {
                    try
                    {
                        foreach (var item in checkedItems)
                        {
                            using (SqlCommand command = new SqlCommand("AddTemplots", connection, transaction))
                            {
                                command.CommandType = CommandType.StoredProcedure;
                                command.Connection = connection;
                                command.Transaction = transaction;




                                command.Parameters.AddWithValue("@temporderId", Tempid);
                                command.Parameters.AddWithValue("@LotNo", item.Lotno);

                                command.Parameters.AddWithValue("@OrderQty", item.OrderQty);




                                await command.ExecuteNonQueryAsync();
                                command.Parameters.Clear();
                            }
                        }

                        transaction.Commit();
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();
                        throw new Exception($"Database insert failed: {ex.Message}", ex);
                    }
                }
            }
        }




        public async Task AddCheckedItemsToDatabaseRaw(List<CompanyModel> checkedItems, int Tempid)
        {
            using (SqlConnection connection = new SqlConnection(_configuration.Value))

            {
                await connection.OpenAsync();

                using (SqlTransaction transaction = connection.BeginTransaction())
                {
                    try
                    {
                        foreach (var item in checkedItems)
                        {
                            using (SqlCommand command = new SqlCommand("AddTemplotsraw", connection, transaction))
                            {
                                command.CommandType = CommandType.StoredProcedure;
                                command.Connection = connection;
                                command.Transaction = transaction;




                                command.Parameters.AddWithValue("@temporderId", Tempid);
                                command.Parameters.AddWithValue("@LotNo", item.Lotno);
                                command.Parameters.AddWithValue("@Partyid", item.GrowerGroupName);
                                command.Parameters.AddWithValue("@Growerid", item.GrowerName);

                                command.Parameters.AddWithValue("@OrderQty", item.OrderQty);




                                await command.ExecuteNonQueryAsync();
                                command.Parameters.Clear();
                            }
                        }

                        transaction.Commit();
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();
                        throw new Exception($"Database insert failed: {ex.Message}", ex);
                    }
                }
            }
        }












        public async Task<CompanyModel?> GeneratePreDemand(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomicity
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("GeneratePreDemand", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;


                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit(); // Commit only if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback(); // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }



        public async Task<CompanyModel?> GeneratePreOutward(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomicity
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("GeneratePreOutward", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;


                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit(); // Commit only if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback(); // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }




        public async Task<CompanyModel?> GeneratePreDraft(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomicity
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("GeneratePreDraft", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;


                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit(); // Commit only if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback(); // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }












        public async Task<CompanyModel?> UpdatePreinwardHead(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomicity
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("UpdatePreinwardHead", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fix: Remove extra space in "@userid " (should be "@userid")
                            cmd.Parameters.AddWithValue("@pdate", EditModel.PreinwardDate);
                            cmd.Parameters.AddWithValue("@Partyname", EditModel.GrowerGroupName);
                            cmd.Parameters.AddWithValue("@GrowerName", EditModel.GrowerName);
                            cmd.Parameters.AddWithValue("@challanName", EditModel.ChallanName);
                            cmd.Parameters.AddWithValue("@challanNo", EditModel.ChallanNo);
                            cmd.Parameters.AddWithValue("@username", EditModel.GlobalUserName); // Fixed parameter name
                            cmd.Parameters.AddWithValue("@vehno", EditModel.Vehno);
                            cmd.Parameters.AddWithValue("@Remarks", EditModel.PreInwardRemarks);
                            cmd.Parameters.AddWithValue("@Pid", EditModel.PreInwardId);




                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit(); // Commit only if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback(); // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }

















        public async Task<CompanyModel?> CheckChamberAllocation(string selectedPurchase)
        {
            CompanyModel EditModel = new CompanyModel();



            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomicity
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("Check_allocation", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fix: Remove extra space in "@userid " (should be "@userid")

                            cmd.Parameters.AddWithValue("@partyname", selectedPurchase);

                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit(); // Commit only if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback(); // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }




        public async Task<bool> AddBuilding(CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "insert into dbo.Building_master (Id,Bcode,Buname,Bstat,BuildDetails) values((select max(id+1) from building_master),@Bucode,@Buildname,@Bustat,@Budetails)";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Bucode", companyModel.Bucode);
                cmd.Parameters.AddWithValue("@Bustat", companyModel.Bustat);
                cmd.Parameters.AddWithValue("@Buildname", companyModel.Buildname);
                cmd.Parameters.AddWithValue("@Budetails", companyModel.Budetails);

                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }








        public async Task<bool> AddUnit(CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "insert into dbo.Unit_master(Id,Ucode,UnitName,Stat,details) values((select ISNULL(max(id+1),1) from Unit_master),@Ucode,@Unitname,@Stat,@Dets)";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Ucode", companyModel.Ucode);
                cmd.Parameters.AddWithValue("@Unitname", companyModel.Unitname);
                cmd.Parameters.AddWithValue("@Stat", companyModel.Ustat);
                cmd.Parameters.AddWithValue("@Dets", companyModel.Unitdetails);

                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }














        public async Task<bool> DeleteEmployee(string id)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "delete dbo.Employees where Id=@Id";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Id", id);

                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }



        public async Task<bool> DeleteBank(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "delete dbo.Bank_info where Id=@Id";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Id", companyModel.Bid);

                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }
        public async Task<bool> DeleteTrid(int selectedGrowerId, int selectedId)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "delete gateinmaster where Trid=@Id and GateInId=@Gid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Id", selectedGrowerId);
                cmd.Parameters.AddWithValue("@Gid", selectedId);


                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }

        public async Task<bool> DeleteTempLot(int selectedGrowerId, int selectedId)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "delete LotOutTranstemp where lotno=@Id and tempid=@Gid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Id", selectedGrowerId);
                cmd.Parameters.AddWithValue("@Gid", selectedId);


                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }

        public async Task<bool> DeleteTempOutward(int selectedGrowerId, int selectedId)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "delete outwardtemp where id=@Id and tempid=@Gid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Id", selectedGrowerId);
                cmd.Parameters.AddWithValue("@Gid", selectedId);


                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }


        public async Task<bool> DeleteSlot(int STrid)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "update Grading_calendar set flagdeleted=1 where id=@Id";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Id", STrid);


                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }











        public async Task<bool> DeleteAllTrid(int STrid)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "delete gateinmaster where GateInId=@Id and Qty>0";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Id", STrid);


                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }












        public async Task<bool> DeleteProduct(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "delete dbo.Prodtype where Id=@Id";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Id", companyModel.Bid);

                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }



        public async Task<bool> DeletePalletId(int id, int DemandId)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "update REPACKDRAFTITEMS set flagdeleted=1 where PackingDraftitemid=@Id and Draftid=@Demandid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Id", id);
                cmd.Parameters.AddWithValue("@Demandid", DemandId);

                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }


        public async Task<bool> DeletePalletlot(int id, int DemandId)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "update DraftOutTrans set flagdeleted=1 where id=@Id and Draftid=@Demandid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Id", id);
                cmd.Parameters.AddWithValue("@Demandid", DemandId);

                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }



        public async Task<bool> DeletePackage(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "delete dbo.ptype where Id=@Id";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Id", companyModel.Pkid);

                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }

        public async Task<bool> DeleteService(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "delete dbo.Servicetypes where Id=@Id";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Id", companyModel.Skid);

                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }


        public async Task<bool> DeleteCrateTypes(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "delete dbo.crtypes where Id=@Id";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Id", companyModel.Crid);

                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }



        public async Task<bool> DeleteCrateflag(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "delete dbo.CrateFlags where Id=@Id";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Id", companyModel.Cfid);

                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }










        public async Task<bool> DeleteQuality(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "delete FROM dbo.prodqaul where Id=@Id";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Id", companyModel.Qid);

                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }




        public async Task<bool> DeleteUnit(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "delete from dbo.Unit_master where Id=@Id";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Id", companyModel.Uid);

                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }



        public async Task<bool> DeleteBuilding(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "delete from dbo.building_master where id=@Id";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Id", companyModel.Buid);

                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }









        public async Task<bool> EditCompany(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "update dbo.company set email=@Email,State=@State,City=@City,Contact1=@Phone,contact2=@Mobile,Pincode=@Pincode , Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Id", id);
                cmd.Parameters.AddWithValue("@Name", companyModel.Name);
                cmd.Parameters.AddWithValue("@Gst", companyModel.Gst);
                cmd.Parameters.AddWithValue("@Regno", companyModel.Regno);
                cmd.Parameters.AddWithValue("@Pan", companyModel.Pan);
                cmd.Parameters.AddWithValue("@Website", companyModel.Website);
                cmd.Parameters.AddWithValue("@Caddress", companyModel.Caddress);

                cmd.Parameters.AddWithValue("@City", companyModel.City);
                cmd.Parameters.AddWithValue("@State", companyModel.State);
                cmd.Parameters.AddWithValue("@Pincode", companyModel.Pincode);
                cmd.Parameters.AddWithValue("@Email", companyModel.Email);
                cmd.Parameters.AddWithValue("@Phone", companyModel.Phone);
                cmd.Parameters.AddWithValue("@Mobile", companyModel.Mobile);




                //cmd.Parameters.AddWithValue("@Company", employee.Company);
                //cmd.Parameters.AddWithValue("@City", employee.City);

                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }

        public async Task<bool> updatebank(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "update dbo.bank_info set Name=@Bname,Branch=@Branch,BankName=@BankName,Ifsc=@Ifsc,Accname=@Accname,Accno=@Accno where id=@Id";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };

                cmd.Parameters.AddWithValue("@Id", companyModel.Bid);
                cmd.Parameters.AddWithValue("@Bname", companyModel.Bname);
                cmd.Parameters.AddWithValue("@Branch", companyModel.Branch);
                cmd.Parameters.AddWithValue("@BankName", companyModel.Accname);
                cmd.Parameters.AddWithValue("@Ifsc", companyModel.Ifsc);
                cmd.Parameters.AddWithValue("@Accname", companyModel.Accname);
                cmd.Parameters.AddWithValue("@Accno", companyModel.Accno);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }




        public async Task<bool> updateunit(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "update dbo.Unit_master set Ucode=@Ucode,UnitName=@Unitname,Stat=@Stat,details=@Dets where  id=@Id";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };
                cmd.Parameters.AddWithValue("@Id", companyModel.Uid);

                cmd.Parameters.AddWithValue("@Ucode", companyModel.Ucode);
                cmd.Parameters.AddWithValue("@Unitname", companyModel.Unitname);
                cmd.Parameters.AddWithValue("@Stat", companyModel.Ustat);
                cmd.Parameters.AddWithValue("@Dets", companyModel.Unitdetails);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }





        public async Task<bool> updateproduct(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "update dbo.prodtype set name=@Prodname,Prodetails=@Prodetails where  id=@Id";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };
                cmd.Parameters.AddWithValue("@Id", companyModel.Prodid);

                cmd.Parameters.AddWithValue("@Prodname", companyModel.Prodname);
                cmd.Parameters.AddWithValue("@Prodetails", companyModel.Prodetails);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }

        public async Task<bool> UpdateLotOrderQuantity(CompanyModel EditModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "update LotOutTranstemp set OrderQty=@oqty where lotno=@Lotno and Tempid=@Tempid";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };
                cmd.Parameters.AddWithValue("@oqty", EditModel.OrderQty);

                cmd.Parameters.AddWithValue("@Lotno", EditModel.Lotno);
                cmd.Parameters.AddWithValue("@Tempid", EditModel.TempOrderId);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }




        public async Task<bool> UpdateSachetQty(CompanyModel EditModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "update DraftSachettemp set SachetQty=@oqty where receipid=@Receipd and DraftId=@Lotno ";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };
                cmd.Parameters.AddWithValue("@oqty", EditModel.SachetQty);

                cmd.Parameters.AddWithValue("@Lotno", EditModel.DraftId);

                cmd.Parameters.AddWithValue("@Receipd", EditModel.ReceipeId);



                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }

        public async Task<bool> UpdatePurchaseRate(CompanyModel EditModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "update LotOutTranstemp set ItemMarka=@prelot,Pallets=@oqty where tempid=@Lotno and VerifiedBrandId=@Receipd ";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };
                cmd.Parameters.AddWithValue("@prelot", EditModel.Ratetype);

                cmd.Parameters.AddWithValue("@oqty", EditModel.VarietyRate);

                cmd.Parameters.AddWithValue("@Lotno", EditModel.TempOrderId);

                cmd.Parameters.AddWithValue("@Receipd", EditModel.Brandid);



                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }







        public async Task<bool> UpdatePurchaseRateKg(CompanyModel EditModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "update LotOutTranstemp set ItemMarka=@prelot,Pallets=@oqty,receivedqty=@Bgrade where tempid=@Lotno and VerifiedBrandId=@Receipd";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };
                cmd.Parameters.AddWithValue("@prelot", EditModel.Ratetype);

                cmd.Parameters.AddWithValue("@oqty", EditModel.VarietyRateAgrade);
                cmd.Parameters.AddWithValue("@Bgrade", EditModel.VarietyRateBgrade);


                cmd.Parameters.AddWithValue("@Lotno", EditModel.TempOrderId);

                cmd.Parameters.AddWithValue("@Receipd", EditModel.Brandid);



                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }























        public async Task<bool> AddReportData(int ltno)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "update GateInTransreport set Tempid=7006691129 where lotno=@Lotno";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };
                cmd.Parameters.AddWithValue("@Lotno", ltno);



                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }

        public async Task<bool> FilterOutReporData()
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "delete from GateInTransreport where Tempid not in(7006691129)";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };


                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }
        public async Task<bool> UpdateDraftQuantity(CompanyModel EditModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "update StoreOutTransrep set count=1,OrderQty=@oqty where lotno=@Lotno and TempDraftId=@Tempid";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };
                cmd.Parameters.AddWithValue("@oqty", EditModel.GradingQty);

                cmd.Parameters.AddWithValue("@Lotno", EditModel.Lotno);
                cmd.Parameters.AddWithValue("@Tempid", EditModel.TempDraftId);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }




















        public async Task<bool> updatepackage(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "update dbo.ptype set name=@Pkname,pdescrip=@Pkdetails where  id=@Id";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };
                cmd.Parameters.AddWithValue("@Id", companyModel.Pkid);

                cmd.Parameters.AddWithValue("@Pkname", companyModel.Pkname);
                cmd.Parameters.AddWithValue("@Pkdetails", companyModel.Pkdetails);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }


        public async Task<bool> ForceUpload(int id, String Frems)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "update StoreOutTrans set PreLotPrefix=@fix,remarks=@Pkname where  outid=@Id";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };
                cmd.Parameters.AddWithValue("@Id", id);

                cmd.Parameters.AddWithValue("@Pkname", Frems);
                cmd.Parameters.AddWithValue("@fix", "FORCE");



                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }






        public async Task<bool> updateCratetypes(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "update dbo.crtypes set name=@Crname,Crqty=@Crqty where  id=@Id";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };
                cmd.Parameters.AddWithValue("@Id", companyModel.Crid);

                cmd.Parameters.AddWithValue("@Crname", companyModel.Crname);
                cmd.Parameters.AddWithValue("@Crqty", companyModel.Crqty);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }
















        public async Task<bool> updatePackage(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "update dbo.ptype set name=@Pkname,pdescrip=@Pkdetails where  id=@Id";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };
                cmd.Parameters.AddWithValue("@Id", companyModel.Pkid);

                cmd.Parameters.AddWithValue("@Pkname", companyModel.Pkname);
                cmd.Parameters.AddWithValue("@Pkdetails", companyModel.Pkdetails);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }








        public async Task<bool> updateService(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "update dbo.servicetypes set sname=@Stname,sdescrip=@Stdetails where  id=@Id";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };
                cmd.Parameters.AddWithValue("@Id", companyModel.Skid);

                cmd.Parameters.AddWithValue("@Stname", companyModel.Stname);
                cmd.Parameters.AddWithValue("@Stdetails", companyModel.Stdetails);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }
        public async Task<bool> UpdateGrowerStatus(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "UpdateGrowerStatus";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Growerid", companyModel.Growerid);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }

        public async Task<bool> GenchamberAgg(int id)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "GenchamberAgg";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Growerid", id);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }



        public async Task<bool> GenGrowerAgg(int id)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "GenGrowerAgg";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Growerid", id);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }



        public async Task<bool> UpdateAssignStatus(int id, string avuser)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "UpdateAssignStatus";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Demandid", id);
                cmd.Parameters.AddWithValue("@Username", avuser);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }


















        public async Task<bool> UpdatePackingorderStatus(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "UpdatePackingorderStatus";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Growerid", id);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }






        public async Task<bool> UpdateOrderStatus(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "UpdateOrderStatus";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Growerid", companyModel.DemandNo);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }


        public async Task<bool> UpdateOrderStatusraw(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "UpdateOrderStatusraw";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Growerid", companyModel.DemandNo);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }




        public async Task<bool> UpdateOutwardStatus(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "UpdateOutwardStatus";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Growerid", companyModel.Outwardno);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }


























        public async Task<bool> LockUnlockChamber(int chamberId, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "UpdatechamberStatus";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Growerid", chamberId);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }



        public async Task<bool> UpdateuserStatus(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "UpdateuserStatus";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Growerid", id);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }



        public async Task<bool> UpdateuserGroupStatus(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "UpdateuserGroupStatus";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Growerid", id);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }




        public async Task<bool> UpdateGroupStatus(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "UpdateGroupStatus";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Mid", companyModel.Mid);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }


        public async Task<bool> UpdatePagePreview(string pagepreview, bool pval, string usergroup)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "UpdatePagePreview";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Pagename", pagepreview);
                cmd.Parameters.AddWithValue("@PageVal", pval);
                cmd.Parameters.AddWithValue("@Ugroup", usergroup);





                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }



        public async Task<bool> UpdateAddValPreview(string pagepreview, bool pval, string usergroup)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "UpdateAddValPreview";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Pagename", pagepreview);
                cmd.Parameters.AddWithValue("@PageVal", pval);
                cmd.Parameters.AddWithValue("@Ugroup", usergroup);





                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }



        public async Task<bool> UpdateEditValPreview(string pagepreview, bool pval, string usergroup)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "UpdateEditValPreview";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Pagename", pagepreview);
                cmd.Parameters.AddWithValue("@PageVal", pval);
                cmd.Parameters.AddWithValue("@Ugroup", usergroup);





                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }





        public async Task<bool> UpdateViewPreview(string pagepreview, bool pval, string usergroup)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "UpdateViewValPreview";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Pagename", pagepreview);
                cmd.Parameters.AddWithValue("@PageVal", pval);
                cmd.Parameters.AddWithValue("@Ugroup", usergroup);





                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }



        public async Task<bool> UpdateAppValPreview(string pagepreview, bool pval, string usergroup)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "UpdateAppValPreview";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Pagename", pagepreview);
                cmd.Parameters.AddWithValue("@PageVal", pval);
                cmd.Parameters.AddWithValue("@Ugroup", usergroup);





                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }





















        public async Task<bool> UpdateDelValPreview(string pagepreview, bool pval, string usergroup)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "UpdateDelValPreview";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Pagename", pagepreview);
                cmd.Parameters.AddWithValue("@PageVal", pval);
                cmd.Parameters.AddWithValue("@Ugroup", usergroup);





                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }


















        public async Task<bool> UpdatePurchaseGroupStatus(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "UpdatePurchaseGroupStatus";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Mid", companyModel.Pid);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }






        public async Task<bool> UpdateMsubGroupStatus(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "UpdateMsubGroupStatus";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Mid", companyModel.SubAccid);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }

        public async Task<bool> UpdateVoucherStatus(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "UpdateVoucherStatus";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Mid", companyModel.VoucherId);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }


        public async Task<bool> UpdatesubGroupStatus(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "updatesubgroupstatus";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Mid", companyModel.SubGroupId);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }



        public async Task<bool> UpdatevehStatus(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "UpdatevehStatus";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Mid", companyModel.Vehid);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }

        //GenerateStickers(EditModel.Lotno, EditModel.Unitname, EditModel.StickerNo);

        public async Task<bool> GenerateStickers(int Lotno, string unitname, int stno)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "GenerateStickers";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Lotno", Lotno);
                cmd.Parameters.AddWithValue("@unitname", unitname);
                cmd.Parameters.AddWithValue("@stno", stno);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }








        public async Task<bool> UpdateItemStatus(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "updateitemstatus";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Mid", companyModel.Itemid);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }




        public async Task<CompanyModel?> UpdateSubGroup(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdateSubGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@MaccGrp", EditModel.SubaccGrp);
                    cmd.Parameters.AddWithValue("@MaccDetails", EditModel.SubGroupDetails);
                    cmd.Parameters.AddWithValue("@UserId", EditModel.UserId);
                    cmd.Parameters.AddWithValue("@Mid", EditModel.SubGroupId);
                    cmd.Parameters.AddWithValue("@SubAcgrp", EditModel.SubgroupName);












                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }












        public async Task<bool> UpdateSubGrowerStatus(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "UpdateSubGrowerStatus";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure,
                };
                cmd.Parameters.AddWithValue("@Growerid", companyModel.SubGrowerId);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }














        public async Task<bool> updateQuality(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "update dbo.prodqaul set name=@Qname,qdescrip=@Qdetails where  id=@Id";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };
                cmd.Parameters.AddWithValue("@Id", companyModel.Qid);

                cmd.Parameters.AddWithValue("@Qname", companyModel.Qname);
                cmd.Parameters.AddWithValue("@Qdetails", companyModel.Qdetails);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }
































        public async Task<bool> updateCrateflag(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "update dbo.CrateFlags set name=@Cfname,ftype=@Cfstat,srtype=@Cflag where  id=@Id";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };
                cmd.Parameters.AddWithValue("@Id", companyModel.Cfid);

                cmd.Parameters.AddWithValue("@Cfname", companyModel.Cfname);
                cmd.Parameters.AddWithValue("@Cfstat", companyModel.Cfstat);
                cmd.Parameters.AddWithValue("@Cflag", companyModel.Cflag);






                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }













        public async Task<bool> updateBuilding(int id, CompanyModel companyModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "update dbo.building_master set Bcode=@Bucode,Buname=@BuildName,Bstat=@Bustat,BuildDetails=@Budetails where  id=@Id";
                //const string query = "update dbo.company set Regno=@regno,website=@website,Pan=@pan ,cname = @Name, gst = @Gst, addr = @Caddress where cid=@Id";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text,
                };
                cmd.Parameters.AddWithValue("@Id", companyModel.Buid);

                cmd.Parameters.AddWithValue("@Bucode", companyModel.Bucode);
                cmd.Parameters.AddWithValue("@BuildName", companyModel.Buildname);
                cmd.Parameters.AddWithValue("@Bustat", companyModel.Bustat);
                cmd.Parameters.AddWithValue("@Budetails", companyModel.Budetails);




                con.Open();
                await cmd.ExecuteNonQueryAsync();

                con.Close();
                cmd.Dispose();
            }
            return true;
        }
























        public async Task<List<CompanyModel>> GetBanks()
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select * from dbo.Bank_info";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Bid = rdr.GetInt32(rdr.GetOrdinal("id")),

                        Bname = rdr["Name"].ToString(),
                        Accno = rdr["Accno"].ToString(),
                        Branch = rdr["Branch"].ToString(),
                        Ifsc = rdr["ifsc"].ToString(),
                        Accname = rdr["accname"].ToString()


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }





        public async Task<List<CompanyModel>> GetChambersAsync()
        {
            List<CompanyModel> allChambers = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "SELECT c.status,c.ChamberId as Id,c.ChamberName as Name,c.qty,c.ctype,c.Status,ISNULL(SUM(ca.qty), 0) as AllocatedQty,(c.qty - ISNULL(SUM(ca.qty), 0)) as RemainingQty FROM Chamber c LEFT JOIN Challocation ca ON c.ChamberId = ca.Chamber GROUP BY c.ChamberId, c.ChamberName, c.qty, c.qty, c.Status,c.ctype ORDER BY c.ChamberId";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        ChamberId = rdr.GetInt32(rdr.GetOrdinal("Id")),
                        IsLocked = rdr.GetBoolean(rdr.GetOrdinal("Status")),
                        ChamberName = rdr["Name"].ToString(),
                        //ChamberType = rdr["ctype"].ToString(),
                        // AllocatedQty = rdr.GetInt32(rdr.GetOrdinal("AllocatedQty")),
                        ChamberAllocationqty = rdr.GetDecimal(rdr.GetOrdinal("AllocatedQty")),
                        //RemainingQty = rdr.GetInt32(rdr.GetOrdinal("RemainingQty")),
                        Capacity = rdr.GetInt32(rdr.GetOrdinal("qty")),

                    };
                    allChambers.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return allChambers;
        }

        public async Task<List<CompanyModel>> Getchamberdet(int chamberid)
        {
            List<CompanyModel> Getallocation = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"WITH InTrans AS (
    SELECT 
        LocationChamberId,
        partyid,
        SUM(verifiedQty) AS TotalInQty
    FROM GateInTrans
    WHERE LocationChamberId = @chamberid
        AND verifiedQty > 0
    GROUP BY LocationChamberId, partyid
),
OutTrans AS (
    SELECT 
        LocationChamberId,
        partyid,
        SUM(OrderQty) AS TotalOutQty
    FROM lotouttrans
    WHERE LocationChamberId = @chamberid
    GROUP BY LocationChamberId, partyid
)
SELECT 
    ch.chamberid,
    i.partyid,
    ch.chambername, 
    p.partytypeid + '-' + p.partyname AS PartyName,
    ISNULL(i.TotalInQty, 0) AS InQty,
    ISNULL(o.TotalOutQty, 0) AS OQty,
    ISNULL(i.TotalInQty, 0) - ISNULL(o.TotalOutQty, 0) AS TbQty
FROM InTrans i
LEFT JOIN OutTrans o ON i.LocationChamberId = o.LocationChamberId 
    AND i.partyid = o.partyid
LEFT JOIN chamber ch ON i.LocationChamberId = ch.chamberid
LEFT JOIN party p ON i.partyid = p.partyid
ORDER BY 
    ch.chamberid, i.partyid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@chamberid", chamberid);

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        ChamberId = rdr.GetInt32(rdr.GetOrdinal("chamberid")),

                        Partyid = rdr.GetInt32(rdr.GetOrdinal("partyid")),

                        ChamberName = rdr["chambername"].ToString(),

                        GrowerGroupName = rdr["PartyName"].ToString(),
                        ChamberInqty = rdr.GetInt32(rdr.GetOrdinal("Inqty")),
                        Chamberoutqty = rdr.GetInt32(rdr.GetOrdinal("Oqty")),
                        Chamberbalqty = rdr.GetInt32(rdr.GetOrdinal("Tbqty")),



                    };
                    Getallocation.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Getallocation;
        }

        public async Task<List<CompanyModel>> Getchamberdetgrowers(int partyid, int chamberid)
        {
            List<CompanyModel> GetSubGrowers = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"WITH InTrans AS (
    SELECT 
        LocationChamberId,
        growerid,
        SUM(verifiedQty) AS TotalInQty
    FROM GateInTrans
    WHERE LocationChamberId = @chamberid and partyid=@partyid
        AND verifiedQty > 0
    GROUP BY LocationChamberId,growerid
),
OutTrans AS (
    SELECT 
        LocationChamberId,
        growerid,
        SUM(OrderQty) AS TotalOutQty
    FROM lotouttrans
    WHERE LocationChamberId = @chamberid and partyid=@partyid
    GROUP BY LocationChamberId,growerid
)
SELECT 
    ch.chamberid,
    i.growerid,
    ch.chambername, 
    p.partytypeid + '-' + p.partyname AS PartyName,
    ISNULL(i.TotalInQty, 0) AS InQty,
    ISNULL(o.TotalOutQty, 0) AS OQty,
    ISNULL(i.TotalInQty, 0) - ISNULL(o.TotalOutQty, 0) AS TbQty
FROM InTrans i
LEFT JOIN OutTrans o ON i.LocationChamberId = o.LocationChamberId 
    AND i.growerid = o.growerid
LEFT JOIN chamber ch ON i.LocationChamberId = ch.chamberid
LEFT JOIN partysub p ON i.growerid = p.partyid
ORDER BY 
    ch.chamberid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@partyid", partyid);

                cmd.Parameters.AddWithValue("@chamberid", chamberid);

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        ChamberId = rdr.GetInt32(rdr.GetOrdinal("chamberid")),


                        ChamberName = rdr["chambername"].ToString(),


                        GrowerName = rdr["PartyName"].ToString(),

                        ChamberInqty = rdr.GetInt32(rdr.GetOrdinal("InQty")),

                        Chamberoutqty = rdr.GetInt32(rdr.GetOrdinal("OQty")),
                        Chamberbalqty = rdr.GetInt32(rdr.GetOrdinal("TbQty")),
                    };
                    GetSubGrowers.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetSubGrowers;
        }




        public async Task<List<CompanyModel>> GetChambersInAsync()
        {
            List<CompanyModel> allChambers = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT 
    c.status,
    c.ChamberId as Id,
    c.ChamberName as Name,
    c.Status,
    ISNULL(SUM(ca.VerifiedQty), 0) as InQty,
    ISNULL((SELECT SUM(OrderQty) FROM StoreOutTrans WHERE LocationChamberId = c.ChamberId), 0) as OutQty,
    (ISNULL(SUM(ca.VerifiedQty), 0) - ISNULL((SELECT SUM(OrderQty) FROM StoreOutTrans WHERE LocationChamberId = c.ChamberId), 0)) as CurrentStock,
   ISNULL(convert(varchar(30), min(ca.Gateindate), 104), '') as mindate,
    ISNULL(convert(varchar(30), (SELECT min(DeliveryDate) FROM StoreOutTrans WHERE LocationChamberId = c.ChamberId), 104), '') as maxdate
FROM Chamber c 
LEFT JOIN GateInTrans ca ON c.ChamberId = ca.LocationChamberId 
GROUP BY c.ChamberId, c.ChamberName, c.status 
ORDER BY c.ChamberId
";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        ChamberId = rdr.GetInt32(rdr.GetOrdinal("Id")),
                        IsLocked = rdr.GetBoolean(rdr.GetOrdinal("Status")),
                        ChamberName = rdr["Name"].ToString(),
                        ChamberinDate = rdr["mindate"].ToString(),
                        ChamberOutDate = rdr["maxdate"].ToString(),

                        ChamberInqty = rdr.GetInt32(rdr.GetOrdinal("InQty")),
                        ChamberOutqty = rdr.GetInt32(rdr.GetOrdinal("OutQty")),
                        ChamberBalance = rdr.GetInt32(rdr.GetOrdinal("CurrentStock")),


                    };
                    allChambers.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return allChambers;
        }
















        public async Task<List<CompanyModel>> GetallUnits()
        {
            List<CompanyModel> StoreUnits = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select * from dbo.Unit_master";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Uid = rdr.GetInt32(rdr.GetOrdinal("id")),

                        Unitname = rdr["UnitName"].ToString(),
                        Ucode = rdr["Ucode"].ToString(),
                        Ustat = rdr["Stat"].ToString(),
                        Unitdetails = rdr["details"].ToString(),


                    };
                    StoreUnits.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return StoreUnits;
        }


        public async Task<List<CompanyModel>> GetallReceipe()
        {
            List<CompanyModel> Receipelist = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct recipename from dbo.Recipe";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {


                        ReceipeName = rdr["recipename"].ToString(),



                    };
                    Receipelist.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Receipelist;
        }

        public async Task<List<CompanyModel>> GetAllBoxBrands()
        {
            List<CompanyModel> Boxlist = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct ItemName from dbo.purchaseitem where packageid in(6,7)";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {


                        BoxBrand = rdr["ItemName"].ToString(),



                    };
                    Boxlist.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Boxlist;
        }



        public async Task<List<CompanyModel>> GetTemplocations()
        {
            List<CompanyModel> GetallLocation = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select * from dbo.location_master";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Templocation = rdr["name"].ToString(),


                    };
                    GetallLocation.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetallLocation;
        }

        public async Task<List<CompanyModel>> GetallBuildings()
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select * from dbo.building_master";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Buid = rdr.GetInt32(rdr.GetOrdinal("id")),

                        Buildname = rdr["Buname"].ToString(),
                        Bucode = rdr["Bcode"].ToString(),
                        Bustat = rdr["Bstat"].ToString(),
                        Budetails = rdr["BuildDetails"].ToString(),


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }



        public async Task<List<CompanyModel>> GetHcase()
        {
            List<CompanyModel> Hcaselist = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct itemName from dbo.purchaseitem where packageid=7";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        HcaseName = rdr["itemName"].ToString(),


                    };
                    Hcaselist.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Hcaselist;
        }



        public async Task<List<CompanyModel>> GetBox()
        {
            List<CompanyModel> Boxlist = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct itemName from dbo.purchaseitem where packageid=6";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        BoxName = rdr["itemName"].ToString(),


                    };
                    Boxlist.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Boxlist;
        }



        public async Task<List<CompanyModel>> GetAllGateTrans()
        {
            List<CompanyModel> gateTransList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct p.partytypeid+'-'+ rtrim(p.partyname) as ggroup,convert(varchar(max),ps.partyid)  +'-'+ ps.partyname as sgroup,pq.name as varname,cm.chambername as chambername from gateintrans g left join party p on g.partyid=p.partyid left join partysub ps on g.GrowerId =ps.partyid left join prodqaul pq on g.VerifiedBrandId=pq.id left join chamber cm on g.LocationChamberId=cm.chamberid where g.flagdeleted=0 and dockpost=1";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        GrowerGroupName = rdr["ggroup"].ToString(),
                        GrowerName = rdr["sgroup"].ToString(),
                        VarietyId = rdr["varname"].ToString(),
                        ChamberName = rdr["chambername"].ToString(),


                    };
                    gateTransList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return gateTransList;
        }



























        public async Task<List<CompanyModel>> Getallrecepegrades()
        {
            List<CompanyModel> Rgrades = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct Gradename from dbo.itemgrades";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        ReceipeGrade = rdr["Gradename"].ToString(),


                    };
                    Rgrades.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Rgrades;
        }






        public async Task<List<CompanyModel>> GetallProducts()
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select * from dbo.prodtype";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Prodid = rdr.GetInt32(rdr.GetOrdinal("id")),

                        Prodname = rdr["name"].ToString(),
                        Prodetails = rdr["prodetails"].ToString(),


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }


        public async Task<List<CompanyModel>> GetallPackage()
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select * from dbo.ptype";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Pkid = rdr.GetInt32(rdr.GetOrdinal("id")),

                        Pkname = rdr["name"].ToString(),
                        Pkdetails = rdr["pdescrip"].ToString(),


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }



        public async Task<List<CompanyModel>> GetallChambers()
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select * from dbo.Chamber order by chamberid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        ChamberId = rdr.GetInt32(rdr.GetOrdinal("chamberid")),

                        ChamberName = rdr["chambername"].ToString(),
                        ChamberType = rdr["ctype"].ToString(),
                        Unitname = rdr["unitname"].ToString(),
                        Capacity = rdr.GetInt32(rdr.GetOrdinal("Qty")),
                        chamberstatus = rdr.GetBoolean(rdr.GetOrdinal("status"))

,


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }




        public async Task<List<CompanyModel>> GetallChamberslist(int unitid)
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select * from dbo.Chamber  order by chamberid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                //cmd.Parameters.AddWithValue("@Unitid", unitid);
                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        ChamberId = rdr.GetInt32(rdr.GetOrdinal("chamberid")),

                        ChamberName = rdr["chambername"].ToString(),
                        ChamberType = rdr["ctype"].ToString(),
                        Unitname = rdr["unitname"].ToString(),
                        Capacity = rdr.GetInt32(rdr.GetOrdinal("Qty")),
                        chamberstatus = rdr.GetBoolean(rdr.GetOrdinal("status"))

,


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }








        public async Task<List<CompanyModel>> GetallChambersParty(int unitid, string GrowerName)
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT * FROM dbo.Chamber 
WHERE unitid = @Unitid 
  AND chamberid IN (
    SELECT locationchamberid FROM gateintrans 
    WHERE flagdeleted = 0 
      AND partyid IN (
        SELECT partyid FROM party 
        WHERE partytypeid + '-' + RTRIM(partyname) = @Growername
      )
    UNION
    SELECT chamberid FROM TransferinTrans 
    WHERE flagdeleted = 0 
      AND partyid IN (
        SELECT partyid FROM party 
        WHERE partytypeid + '-' + RTRIM(partyname) = @Growername
      )
  )
ORDER BY chamberid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Unitid", unitid);
                cmd.Parameters.AddWithValue("@Growername", GrowerName);
                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        ChamberId = rdr.GetInt32(rdr.GetOrdinal("chamberid")),

                        ChamberName = rdr["chambername"].ToString(),
                        ChamberType = rdr["ctype"].ToString(),
                        Unitname = rdr["unitname"].ToString(),
                        Capacity = rdr.GetInt32(rdr.GetOrdinal("Qty")),
                        chamberstatus = rdr.GetBoolean(rdr.GetOrdinal("status"))

,


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }

        public async Task<List<CompanyModel>> GetallChambersIn()
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select * from dbo.Chamber where chamberid in(select locationchamberid from gateintrans where  flagdeleted=0) order by chamberid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
              
                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        ChamberId = rdr.GetInt32(rdr.GetOrdinal("chamberid")),

                        ChamberName = rdr["chambername"].ToString(),
                        ChamberType = rdr["ctype"].ToString(),
                        Unitname = rdr["unitname"].ToString(),
                        Capacity = rdr.GetInt32(rdr.GetOrdinal("Qty")),
                        chamberstatus = rdr.GetBoolean(rdr.GetOrdinal("status"))

,


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }

        public async Task<List<CompanyModel>> GetallChambersPartydemand(int unitid, string GrowerName)
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT DISTINCT ca.chambername
FROM LotOutTrans l
LEFT OUTER JOIN party ps ON ps.partyid = l.PartyId 
LEFT OUTER JOIN chamber ca ON  l.LocationChamberId= ca.chamberid 

WHERE 
    -- Filter only completed records
    (
        l.outid IN (
            SELECT s.outid 
            FROM StoreOutTrans s 
            GROUP BY s.outid
            HAVING SUM(COALESCE(s.orderqty, 0)) = (
                SELECT SUM(COALESCE(l2.orderqty, 0))
                FROM LotOutTrans l2
                WHERE l2.outid = s.outid
            )
        )
        OR EXISTS (
            SELECT 1 
            FROM StoreOutTrans s 
            WHERE s.outid = l.outid 
            AND s.PreLotPrefix = 'FORCE'
        )
    )
    AND l.UnitId = @unitid
    AND l.DemandStatus = 'Approved'
    -- Mandatory conditions for partyid and chambername
    AND ps.partytypeid + '-' + ps.partyname = @partyid  -- Replace @partyid with actual value
   
    AND l.demandirn IS NOT NULL";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Unitid", unitid);
                cmd.Parameters.AddWithValue("@partyid", GrowerName);
               
                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                       
                        ChamberName = rdr["chambername"].ToString()
                       

,


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }



        public async Task<List<CompanyModel>> GetallChambersSub(int unitid, string GrowerName, string subgrower)
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select * from dbo.Chamber where unitid=@Unitid  AND chamberid in(select locationchamberid from gateintrans where   GrowerId in(select partyid from partysub where convert(varchar(max),partyid)  +'-'+ partyname=@Subgrower) and flagdeleted=0 and partyid in(select partyid from party where  partytypeid+'-'+ rtrim(partyname)=@Growername)) order by chamberid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Unitid", unitid);
                cmd.Parameters.AddWithValue("@Growername", subgrower);
                cmd.Parameters.AddWithValue("@Subgrower", GrowerName);
                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        ChamberId = rdr.GetInt32(rdr.GetOrdinal("chamberid")),

                        ChamberName = rdr["chambername"].ToString(),
                        ChamberType = rdr["ctype"].ToString(),
                        Unitname = rdr["unitname"].ToString(),
                        Capacity = rdr.GetInt32(rdr.GetOrdinal("Qty")),
                        chamberstatus = rdr.GetBoolean(rdr.GetOrdinal("status"))

,


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }






















        public async Task<List<CompanyModel>> GetallpartyLots(int unitid, string availgrower)
        {
            List<CompanyModel> GetAllLots = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct LotIrn as Irn from dbo.GateinTrans where partyid in(select partyid from party where  partytypeid+'-'+ rtrim(partyname)=@Growername) and dockpost=1 and flagdeleted=0 and lotirn is not null   and unitid=@Unitid  order by LotIrn";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Unitid", unitid);
                cmd.Parameters.AddWithValue("@Growername", availgrower);


                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        LotIrn = rdr["Irn"].ToString()


,


                    };
                    GetAllLots.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetAllLots;
        }

























        public async Task<List<CompanyModel>> GetLots(int unitid)
        {
            List<CompanyModel> GetAllLots = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct LotIrn as Irn from dbo.GateinTrans where dockpost=1 and flagdeleted=0 and lotirn is not null   and unitid=@Unitid  order by LotIrn";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Unitid", unitid);
                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        LotIrn = rdr["Irn"].ToString()


,


                    };
                    GetAllLots.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetAllLots;
        }



        public async Task<List<CompanyModel>> GetallchamberGrowerlist(string GrowerName)
        {
            List<CompanyModel> GetgrowerList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select partytypeid+'-'+ rtrim(partyname) as Groupname from party WHERE status=1 and flagdeleted=0 and type='C' and partyid in(select partyid from gateintrans where flagdeleted=0 and locationchamberid in(select chamberid from chamber where chambername=@Growername))";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Growername", GrowerName);

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        GrowerName = rdr["Groupname"].ToString()



                    };
                    GetgrowerList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetgrowerList;
        }




















        public async Task<List<CompanyModel>> GetallGrowerlist()
        {
            List<CompanyModel> GetgrowerList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select partytypeid+'-'+ rtrim(partyname) as Groupname from party WHERE status=1 and flagdeleted=0 and type='C'";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        GrowerName = rdr["Groupname"].ToString(),
                        OutwardGrowerGroup = rdr["Groupname"].ToString()




                    };
                    GetgrowerList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetgrowerList;
        }

        public async Task<List<CompanyModel>> GetSalesGrower()
        {
            List<CompanyModel> GetgrowerList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select partytypeid+'-'+ rtrim(partyname) as Groupname from party WHERE status=1 and flagdeleted=0 and isnull(masterid,0)=1 and type='C'";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        GrowerName = rdr["Groupname"].ToString(),
                        OutwardGrowerGroup = rdr["Groupname"].ToString()




                    };
                    GetgrowerList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetgrowerList;
        }




        public async Task<List<CompanyModel>> BillGrowers(int unit)
        {
            List<CompanyModel> GetgrowerList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"select    ps.partytypeid + '-' + ps.partyname AS PartyName from party ps

where partyid in(

SELECT DISTINCT ps.partyid
FROM LotOutTrans l
LEFT OUTER JOIN party ps ON ps.partyid = l.PartyId 
WHERE 
    -- Filter only completed records
    (
        l.outid IN (
            SELECT s.outid 
            FROM StoreOutTrans s 
            GROUP BY s.outid
            HAVING SUM(COALESCE(s.orderqty, 0)) = (
                SELECT SUM(COALESCE(l2.orderqty, 0))
                FROM LotOutTrans l2
                WHERE l2.outid = s.outid
            )
        )
        OR EXISTS (
            SELECT 1 
            FROM StoreOutTrans s 
            WHERE s.outid = l.outid 
            AND s.PreLotPrefix = 'FORCE'
        )
    )
    AND l.UnitId = @Unitid 
    AND l.DemandStatus = 'Approved'
    AND ps.partyid IS NOT NULL  -- Ensure we have a valid partyid
)";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text

            };
            cmd.Parameters.AddWithValue("@Unitid", unit);

            con.Open();
            SqlDataReader rdr = await cmd.ExecuteReaderAsync();

            while (rdr.Read())
            {
                CompanyModel companyModel = new CompanyModel
                {
                    GrowerGroupName = rdr["PartyName"].ToString(),




                };
                GetgrowerList.Add(companyModel);
            }
            con.Close();
            cmd.Dispose();
        }
            return GetgrowerList;
        }






        public async Task<List<CompanyModel>> BillOrders(CompanyModel EditModel,int unit)
        {
            List<CompanyModel> GetBilldemand = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT DISTINCT l.demandirn
FROM LotOutTrans l
LEFT OUTER JOIN party ps ON ps.partyid = l.PartyId 
LEFT OUTER JOIN chamber ca ON  l.LocationChamberId= ca.chamberid 

WHERE 
    -- Filter only completed records
    (
        l.outid IN (
            SELECT s.outid 
            FROM StoreOutTrans s 
            GROUP BY s.outid
            HAVING SUM(COALESCE(s.orderqty, 0)) = (
                SELECT SUM(COALESCE(l2.orderqty, 0))
                FROM LotOutTrans l2
                WHERE l2.outid = s.outid
            )
        )
        OR EXISTS (
            SELECT 1 
            FROM StoreOutTrans s 
            WHERE s.outid = l.outid 
            AND s.PreLotPrefix = 'FORCE'
        )
    )
    AND l.UnitId = @unitid
    AND l.DemandStatus = 'Approved'
and  l.demandirn not in(select DemandIRN from ProcessedDemandsmain where  chamberid=@chambername and Unitid=@Unitid and flagdeleted=0)
    -- Mandatory conditions for partyid and chambername
    AND ps.partytypeid + '-' + ps.partyname = @partyid  -- Replace @partyid with actual value
    AND ca.ChamberName = @chambername  -- Replace @chambername with actual value
    AND l.demandirn IS NOT NULL
ORDER BY l.demandirn";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text

                };
                cmd.Parameters.AddWithValue("@Unitid", unit);
                cmd.Parameters.AddWithValue("@partyid", EditModel.GrowerGroupName);
                cmd.Parameters.AddWithValue("@chambername", EditModel.ChamberName);


                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        DemandIrn = rdr["demandirn"].ToString(),




                    };
                    GetBilldemand.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetBilldemand;
        }


        public async Task<List<CompanyModel>> BillOrdersDetails(CompanyModel EditModel, int unit)
        {
            List<CompanyModel> GetDailyPreinwardtemp = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"
select demandirn,convert(varchar(30),outdate,104) as outdate,sum(OrderQty) as OrderQty from StoreOutTrans where locationchamberid in(select chamberid from chamber where chambername =@chambername)
and demandirn in(

SELECT DISTINCT l.demandirn
FROM LotOutTrans l
LEFT OUTER JOIN party ps ON ps.partyid = l.PartyId 
LEFT OUTER JOIN chamber ca ON  l.LocationChamberId= ca.chamberid 

WHERE 
    -- Filter only completed records
    (
        l.outid IN (
            SELECT s.outid 
            FROM StoreOutTrans s 
            GROUP BY s.outid
            HAVING SUM(COALESCE(s.orderqty, 0)) = (
                SELECT SUM(COALESCE(l2.orderqty, 0))
                FROM LotOutTrans l2
                WHERE l2.outid = s.outid
            )
        )
        OR EXISTS (
            SELECT 1 
            FROM StoreOutTrans s 
            WHERE s.outid = l.outid 
            AND s.PreLotPrefix = 'FORCE'
        )
    )
    AND l.UnitId = @unitid
    AND l.DemandStatus = 'Approved'
and  l.demandirn not in(select DemandIRN from ProcessedDemandsmain where chamberid=@chambername and Unitid=@Unitid and flagdeleted=0)
    -- Mandatory conditions for partyid and chambername
    AND ps.partytypeid + '-' + ps.partyname = @partyid  -- Replace @partyid with actual value
    AND ca.ChamberName = @chambername  -- Replace @chambername with actual value
    AND l.demandirn IS NOT NULL) group by demandirn,outdate order by demandirn
";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text

                };
                cmd.Parameters.AddWithValue("@Unitid", unit);
                cmd.Parameters.AddWithValue("@partyid", EditModel.GrowerGroupName);
                cmd.Parameters.AddWithValue("@chambername", EditModel.ChamberName);


                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        DemandIrn = rdr["demandirn"].ToString(),
                        StoreoutDate = rdr["outdate"].ToString(),
                        OrderQty = rdr.GetInt32(rdr.GetOrdinal("OrderQty")),




                    };
                    GetDailyPreinwardtemp.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinwardtemp;
        }














        public async Task<List<CompanyModel>> GetallGrowerlistwithin()
        {
            List<CompanyModel> GetgrowerList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select partytypeid+'-'+ rtrim(partyname) as Groupname from party WHERE status=1  and partyid in(select partyid from gateintrans where flagdeleted=0 ) and flagdeleted=0 and type='C'";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        GrowerName = rdr["Groupname"].ToString()



                    };
                    GetgrowerList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetgrowerList;
        }



        public async Task<CompanyModel?> GetDemandGrower(string demandirn)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = @"select distinct partytypeid+'-'+ rtrim(partyname) as Groupname from party WHERE partyid in(select partyid from LotOutTrans where demandirn=@Dirn)";
                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@Dirn", demandirn);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                // companyModel.Growerid = reader.GetInt32(reader.GetOrdinal("id")),





                                GrowerGroupName = reader["Groupname"] as string,



                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }






        public async Task<bool> SaveDemandsToDatabase(List<string> demandIRNs,CompanyModel EditModel,int Unit)
        {
            SqlConnection connection = null;
            SqlTransaction transaction = null;

            try
            {
                //var connectionString = _configuration.GetConnectionString(_configuration.Value);
                //using (SqlConnection con = new SqlConnection(_configuration.Value))


                    connection = new SqlConnection(_configuration.Value);
                await connection.OpenAsync();

                // Begin transaction
                transaction = connection.BeginTransaction();

                try
                {
                    // Delete all existing records first
                    var deleteSql = "DELETE FROM ProcessedDemands";
                    using (var deleteCommand = new SqlCommand(deleteSql, connection, transaction))
                    {
                        await deleteCommand.ExecuteNonQueryAsync();
                    }

                    // Insert new selected demands
                    var insertSql = @"
                INSERT INTO ProcessedDemands 
                (DemandIRN,billdate,partyid,growerid,billtype,chamberid,Unitid,createdby)
                VALUES (@DemandIRN,@Billdate,@Partyid,@GrowerId,@Billtype,@Chamber,@Unitid,@userid)";

                    foreach (var irn in demandIRNs)
                    {
                        using (var insertCommand = new SqlCommand(insertSql, connection, transaction))
                        {
                            insertCommand.Parameters.AddWithValue("@DemandIRN", irn);
                            insertCommand.Parameters.AddWithValue("@Billdate", EditModel.Billdate);
                            insertCommand.Parameters.AddWithValue("@Partyid", EditModel.GrowerGroupName);
                            insertCommand.Parameters.AddWithValue("@GrowerId", EditModel.GrowerName);
                            insertCommand.Parameters.AddWithValue("@Chamber", EditModel.ChamberName);
                            insertCommand.Parameters.AddWithValue("@Billtype", EditModel.Billtype);
                            insertCommand.Parameters.AddWithValue("@Unitid",Unit);
                            insertCommand.Parameters.AddWithValue("@userid", EditModel.GlobalUserName);


                            await insertCommand.ExecuteNonQueryAsync();
                        }
                    }

                    // Commit transaction
                    transaction.Commit();

                
                    return true;
                }
                catch (Exception ex)
                {
                    // Rollback transaction if any error occurs
                    transaction?.Rollback();
              
                    return false;
                }
            }
            catch (Exception ex)
            {
             
                return false;
            }
            finally
            {
                // Ensure connection is closed
                transaction?.Dispose();
                connection?.Close();
                connection?.Dispose();
            }
        }









        public async Task<List<CompanyModel>> GetallGrowerlistnew()
        {
            List<CompanyModel> GetgrowerList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select partytypeid+'-'+ rtrim(partyname) as Groupname from party WHERE type='C'";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        GrowerGroupName = rdr["Groupname"].ToString()



                    };
                    GetgrowerList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetgrowerList;
        }



        public async Task<List<CompanyModel>> GetallStatus()
        {
            List<CompanyModel> Getstatuslist = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select rtrim(statname) as status from allstat";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        GrowerActive = rdr["status"].ToString()



                    };
                    Getstatuslist.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Getstatuslist;
        }


        public async Task<List<CompanyModel>> GetUserlist()
        {
            List<CompanyModel> Getallpackusers = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select rtrim(username) as username from users where userid in(select distinct userid from outward)";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        UserName = rdr["username"].ToString()



                    };
                    Getallpackusers.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Getallpackusers;
        }













        public async Task<List<CompanyModel>> GetallAccountlist()
        {
            List<CompanyModel> GetgrowerList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select rtrim(subname) as subname from AccountSubGroups";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        AccountGroup = rdr["subname"].ToString()



                    };
                    GetgrowerList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetgrowerList;
        }

        public async Task<List<CompanyModel>> Getalloutwardlist()
        {
            List<CompanyModel> Getalloutwards = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct outwardirn as outwardirn from outward where flagdeleted=0";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        OutwardIrn = rdr["outwardirn"].ToString()



                    };
                    Getalloutwards.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Getalloutwards;
        }


        public async Task<List<CompanyModel>> GetMaxCrateIdno()
        {
            List<CompanyModel> GetMaxCrateId = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select max(cid) as cid from crateissue";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        CrissueId = Convert.ToInt32(rdr["cid"]),



                    };
                    GetMaxCrateId.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetMaxCrateId;
        }





        public async Task<List<CompanyModel>> GetallLedgerAccounts()
        {
            List<CompanyModel> GetgrowerList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select rtrim(type)+'-'+partytypeid  +'-'+ rtrim(partyname) as allaccounts from party where flagdeleted=0 and status=1 and islock=0";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        TransactionName = rdr["allaccounts"].ToString()



                    };
                    GetgrowerList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetgrowerList;
        }

        public async Task<List<CompanyModel>> GetallStockPacking(int Unit,string username)
        {
            List<CompanyModel> PackingOrderist = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT DISTINCT po.packingorderno
FROM packingorderitems po
INNER JOIN (
    -- Get packing orders where total dispatch > total outward
    SELECT d.packingorderid
    FROM dispatch d
    LEFT JOIN (
        SELECT packingorderid, SUM(qty) as total_outward
        FROM outward
        WHERE unitid = @Unitid and flagdeleted=0
        GROUP BY packingorderid
    ) o ON d.packingorderid = o.packingorderid
    WHERE d.unitid =@Unitid
    GROUP BY d.packingorderid
    HAVING SUM(d.qty) > COALESCE(MAX(o.total_outward), 0)
) available ON po.PackingOrderId = available.packingorderid
WHERE po.userid IN (SELECT userid FROM users WHERE username = @Uname)";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Unitid", Unit);

                cmd.Parameters.AddWithValue("@Uname", username);
                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        PackingOrderIrn = rdr["packingorderno"].ToString()



                    };
                    PackingOrderist.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return PackingOrderist;
        }

        public async Task<List<CompanyModel>> GetallDraftno(int Unit)
        {
            List<CompanyModel> PackingOrderist = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT DISTINCT draftirn from DraftOutTrans 
where unitid=@Unitid and Draftstat=@draftstat";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Unitid", Unit);

                cmd.Parameters.AddWithValue("@draftstat", "Open");
                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        DraftIrn = rdr["draftirn"].ToString()



                    };
                    PackingOrderist.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return PackingOrderist;
        }


        public async Task<List<CompanyModel>> GetallDraftnobill(int Unit)
        {
            List<CompanyModel> PackingOrderist = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT DISTINCT draftirn from DraftOutTrans 
where Draftstat=@draftstat and flagdeleted=0 and draftirn not in(Select  draftirn from GradingPackingfinal)" ;
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Unitid", Unit);

                cmd.Parameters.AddWithValue("@draftstat", "Closed");
                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                       DraftIrn = rdr["draftirn"].ToString()



                    };
                    PackingOrderist.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return PackingOrderist;
        }



        public async Task<List<CompanyModel>> GetItemNameByGroup(string selectedPurchase)
        {
            List<CompanyModel> GetItemGroup = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct itemname as item from masterItems where prGroup in(select id from PurchaseGroup where mastername=@mname and flagdeleted=0)";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                cmd.Parameters.AddWithValue("@mname", selectedPurchase);

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        PurchaseItemName = rdr["item"].ToString()



                    };
                    GetItemGroup.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetItemGroup;
        }



        public async Task<List<CompanyModel>> GetSubGrowerByGroup(string selectedPurchase)
        {
            List<CompanyModel> GetSubGrowerGroup = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct convert(varchar(max),partyid)  +'-'+ partyname as partyname from partysub where status=1 and flagdeleted=0 and MainId in(select partyid from party where partytypeid  +'-'+ partyname =@selectedpurchase)";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                cmd.Parameters.AddWithValue("@selectedpurchase", selectedPurchase);

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        GrowerName = rdr["partyname"].ToString(),
                        OutwardGrowerName = rdr["partyname"].ToString(),
                        Orderby = rdr["partyname"].ToString()



                    };
                    GetSubGrowerGroup.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetSubGrowerGroup;
        }

        public async Task<List<CompanyModel>> GetSubGrowerWithIn(string selectedPurchase, int Unit)
        {
            List<CompanyModel> GetSubGrowerGroup = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT DISTINCT convert(varchar(max),partyid) + '-' + partyname as partyname 
FROM partysub 
WHERE status=1 
  AND flagdeleted=0 
  AND partyid IN (SELECT GrowerId FROM gateintrans WHERE flagdeleted=0 AND unitid=@unit)
  AND MainId IN (SELECT partyid FROM party WHERE partytypeid + '-' + partyname = @selectedpurchase)

UNION

SELECT DISTINCT convert(varchar(max),partyid) + '-' + partyname 
FROM partysub 
WHERE status=1 
  AND flagdeleted=0 
  AND partyid IN (SELECT GrowerId FROM gateintrans WHERE flagdeleted=0 AND unitid=@unit)
  AND MainId IN (SELECT partyid FROM party WHERE partytypeid + '-' + partyname = @selectedpurchase)";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                cmd.Parameters.AddWithValue("@selectedpurchase", selectedPurchase);
                cmd.Parameters.AddWithValue("@unit", Unit);

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        GrowerName = rdr["partyname"].ToString(),
                              OrderBy = rdr["partyname"].ToString()


                    };
                    GetSubGrowerGroup.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetSubGrowerGroup;
        }

        public async Task<List<CompanyModel>> GetSubGrowerWithInabraq()
        {
            List<CompanyModel> GetSubGrowerGroup = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT DISTINCT convert(varchar(max),partyid) + '-' + partyname as partyname 
FROM partysub 
WHERE status=1 
  AND flagdeleted=0 and
  mainid=@mainid";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                cmd.Parameters.AddWithValue("@mainid", 39);

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        TransferTo = rdr["partyname"].ToString(),
                        OrderBy = rdr["partyname"].ToString()


                    };
                    GetSubGrowerGroup.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetSubGrowerGroup;
        }


        public async Task<List<CompanyModel>> GetToSubGrowerByGroup(string selectedPurchase)
        {
            List<CompanyModel> GetToSubGrowerGroup = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct convert(varchar(max),partyid)  +'-'+ partyname as partyname from partysub where flagdeleted=0 and status=1 and MainId in(select partyid from party where partytypeid  +'-'+ partyname =@selectedpurchase)";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                cmd.Parameters.AddWithValue("@selectedpurchase", selectedPurchase);

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        CrTransferGrower = rdr["partyname"].ToString()



                    };
                    GetToSubGrowerGroup.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetToSubGrowerGroup;
        }


        public async Task<List<CompanyModel>> GetChallanByGroup(string selectedPurchase, string SelectedSubgrower)
        {
            List<CompanyModel> GetChallanGroup = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct convert(varchar(max),id)  +'-'+ ChallanName  as ChallanName from ChallanMaster where  MainId in(select partyid from party where partytypeid  +'-'+ partyname =@SelectedSubgrower) and subid in(select partyid from partysub where  convert(varchar(max),partyid)  +'-'+ partyname=@selectedPurchase)";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                cmd.Parameters.AddWithValue("@selectedpurchase", selectedPurchase);
                cmd.Parameters.AddWithValue("@SelectedSubgrower", SelectedSubgrower);

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        ChallanName = rdr["ChallanName"].ToString()



                    };
                    GetChallanGroup.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetChallanGroup;
        }


        public async Task<List<CompanyModel>> GetallVeh()
        {
            List<CompanyModel> Vehlist = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select rtrim(vehno) + space(1)+'('+ rtrim(drivername)+space(1)+')'+space(1)+'('+rtrim(contactno)+')' as vehno from vehinfo";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Vehno = rdr["vehno"].ToString()



                    };
                    Vehlist.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Vehlist;
        }



        public async Task<List<CompanyModel>> GetallCrateMarks()
        {
            List<CompanyModel> GetCrateMark = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct CrateMark from Crateissue";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        CrissueMark = rdr["CrateMark"].ToString()



                    };
                    GetCrateMark.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetCrateMark;
        }
        //GetDailyCratesProcAdjustment


        public async Task<List<CompanyModel>> GetDailyCratesProc()
        {
            List<CompanyModel> GetDailyCrates = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT
    ci.cid,ci.Trno,
    ci.Dated,
	p.partytypeid  +'-'+ p.partyname AS PartyName,
 convert(varchar(max),ps.partyid)  +'-'+ ps.partyname AS GrowerName,
    convert(varchar(max),cm.id)  +'-'+ cm.ChallanName as ChallanName,
      rtrim(vi.vehno) + space(1)+'('+ rtrim(vi.drivername)+space(1)+')'+space(1)+'('+rtrim(vi.contactno)+')' as vehno,


	ci.CrateMark,
    ci.qty,
    ci.trflag,
ci.Remarks
FROM crateissue ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.groowerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
WHERE  ci.trflag='Crate Issue' and ci.flagdeleted=0 and CONVERT(date, ci.Dated) = CONVERT(date, GETDATE()) order by ci.cid desc";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        CrissueId = Convert.ToInt32(rdr["cid"]),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                        ChallanName = rdr["challanname"].ToString(),
                        Vehno = rdr["vehno"].ToString(),
                        CrissueMark = rdr["CrateMark"].ToString(),
                        CrissueQty = Convert.ToDecimal(rdr["qty"]),
                        CrateIssueDated = Convert.ToDateTime(rdr["Dated"]),
                        CrissueFlag = rdr["trflag"].ToString(),
                        CrissueRemarks = rdr["Remarks"].ToString(),
                        CrateCrn = rdr["Trno"].ToString(),






                    };
                    GetDailyCrates.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyCrates;
        }

        public async Task<List<CompanyModel>> GetDailyCratesProcAdjustment()
        {
            List<CompanyModel> GetDailyCrates = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT 
    ca.Trno,ca.dated,ca.cid,
    p_from.partyname AS PartyName, -- Party name for partyid
    p_to.partyname AS transferGroupName,    -- Party name for partyidto
    ps_groower.partyname AS GrowerName, -- Partysub name for groowerid
    ps_grower_to.partyname AS TransferGrowerName -- Partysub name for groweridto
	,ca.remarks,ca.qty
FROM 
    crateadjustment ca
-- Join to get party names for partyid and partyidto
LEFT JOIN party p_from ON ca.partyid = p_from.partyid
LEFT JOIN party p_to ON ca.partyidto = p_to.partyid
-- Join to get partysub names for groowerid and groweridto
LEFT JOIN partysub ps_groower ON ca.groowerid = ps_groower.partyid
LEFT JOIN partysub ps_grower_to ON ca.groweridto = ps_grower_to.partyid
where ca.flagdeleted=0 
 order by ca.cid desc";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        CrissueId = Convert.ToInt32(rdr["cid"]),
                        CrateIssueDated = Convert.ToDateTime(rdr["dated"]),

                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                        CrTransferGrowerGroup = rdr["transferGroupName"].ToString(),
                        CrTransferGrower = rdr["TransferGrowerName"].ToString(),


                        CrissueQty = Convert.ToDecimal(rdr["qty"]),

                        CrissueRemarks = rdr["Remarks"].ToString(),
                        CrateCrn = rdr["Trno"].ToString(),






                    };
                    GetDailyCrates.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyCrates;
        }




        public async Task<List<CompanyModel>> GetDailyPreinwardProc(string username)
        {
            List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT
    ci.Lotno,
    ci.PreInIrn,ci.LotIrn,
    ci.GateInDate,
    p.partytypeid + '-' + p.partyname AS PartyName,
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
    CONVERT(varchar(max), cm.id) + '-' + cm.ChallanName AS ChallanName,
    RTRIM(vi.vehno) + SPACE(1) + '(' + RTRIM(vi.drivername) + SPACE(1) + ')' + SPACE(1) + '(' + RTRIM(vi.contactno) + ')' AS vehno,
    ci.qty,
    ci.Remarks,
    ci.preInirn,ui.uname as username,
    
    -- New Status Field
    CASE 
        WHEN EXISTS (
            SELECT 1 
            FROM QualityControl qi 
            WHERE qi.LotNo = ci.LotNo
        ) THEN 'Completed'
        ELSE 'Pending'
    END AS Status

FROM GateInTrans ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.growerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
LEFT JOIN users ui ON ci.createdby = ui.id


WHERE  
    ci.Createdby IN (SELECT id FROM users WHERE uname = @uname) 
    AND ci.flagdeleted = 0 
    AND CONVERT(date, ci.GateInDate) = CONVERT(date, GETDATE()) 
ORDER BY ci.GateInId DESC";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text

                };
                cmd.Parameters.AddWithValue("@uname", username);

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Lotno = Convert.ToInt32(rdr["Lotno"]),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                        ChallanName = rdr["challanname"].ToString(),
                        Vehno = rdr["vehno"].ToString(),
                        PreInwardQty = Convert.ToDecimal(rdr["qty"]),
                        PreinwardDate = Convert.ToDateTime(rdr["GateinDate"]),

                        CrissueRemarks = rdr["Remarks"].ToString(),
                        PreInIrn = rdr["PreInIrn"].ToString(),
                        Lotstatus = rdr["Status"].ToString(),
                        LotIrn = rdr["LotIrn"].ToString(),
                        GlobalUserName = rdr["username"].ToString(),






                    };
                    GetDailyPreinward.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinward;
        }



        public async Task<List<CompanyModel>> GetPendingQualityProc(int UnitId, string Prestat)
        {
            List<CompanyModel> GetPendingQuality = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT p.partytypeid + '-' + p.partyname AS PartyName,
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,ci.Lotno, ci.PreInIrn, ci.LotIrn, pq.name as variety,ci.qty,

qcon.Pressure,qcon.AvgWeight,qcon.bgradavg,cmr.chambername as Chamber,
    CASE 
        WHEN ci.flagdeleted = 1 THEN 'Deleted'
        WHEN EXISTS (SELECT 1 FROM QualityControl qi WHERE qi.LotNo = ci.LotNo) THEN 'Completed'
        ELSE 'Pending'
    END AS Status
FROM GateInTrans ci


LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.growerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
LEFT JOIN users ui ON ci.createdby = ui.id
LEFT JOIN prodqaul pq ON ci.varietyid = pq.id
LEFT JOIN servicetypes st ON ci.schemeid = st.id
LEFT JOIN unit_master um ON ci.Unitid = um.id
LEFT JOIN PTYPE pt ON ci.packageid = pt.id
LEFT JOIN users ur ON ci.Createdby = ur.id
LEFT JOIN chamber cmr ON ci.LocationChamberId = cmr.chamberid

LEFT JOIN QualityControl qcon ON ci.lotno = qcon.lotno
 
 where ci.UnitId=@unitid and 
(
    (@status = 'Deleted' AND ci.flagdeleted = 1)
    OR 
    (@status = 'Completed' AND ci.flagdeleted = 0 AND EXISTS (SELECT 1 FROM QualityControl qi WHERE qi.LotNo = ci.LotNo))
    OR 
    (@status = 'Pending' AND ci.flagdeleted = 0 AND NOT EXISTS (SELECT 1 FROM QualityControl qi WHERE qi.LotNo = ci.LotNo)))
  ORDER BY ci.GateInId DESC";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text

                };
                cmd.Parameters.AddWithValue("@unitid", UnitId);
                cmd.Parameters.AddWithValue("@status", Prestat);

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Lotno = Convert.ToInt32(rdr["Lotno"]),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                        VarietyId = rdr["variety"].ToString(),
                        PreInwardQty = Convert.ToDecimal(rdr["qty"]),

                        PreInIrn = rdr["PreInIrn"].ToString(),
                        PreInwardStatus = rdr["Status"].ToString(),
                        LotIrn = rdr["LotIrn"].ToString(),
                        //AvgPressure = Convert.ToDecimal(rdr["pressure"]),
                        //AvgWeight = Convert.ToDecimal(rdr["AvgWeight"]),

                        //BGradeAvgValue = rdr["Bgradavg"].ToString(),

                        ChamberName = rdr["Chamber"].ToString()




                    };
                    GetPendingQuality.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetPendingQuality;
        }




        public async Task<List<CompanyModel>> GetStoreOutStatus(string stat, int UnitId, string demandirn, string avuser)
        {
            List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT 
    l.isAssigned AS Assign,
    ps.partytypeid + '-' + ps.partyname AS PartyName,
    l.demandirn,
    l.outid,
    MAX(l.otype) AS otype,
    SUM(COALESCE(l.orderqty, 0)) AS TotalLotOrderQty,
    ISNULL((
        SELECT SUM(COALESCE(s.orderqty, 0)) 
        FROM StoreOutTrans s 
        WHERE s.outid = l.outid 
    ), 0) AS TotalStoreOrderQty,
    ISNULL((
        SELECT SUM(COALESCE(df.orderqty, 0)) 
        FROM DraftOutTrans df 
        WHERE df.outid = l.outid 
    ), 0) AS TotalDraftedQty,
    CASE 
        WHEN EXISTS (
            SELECT 1 
            FROM StoreOutTrans s 
            WHERE s.outid = l.outid 
            AND s.PreLotPrefix = 'FORCE'
        ) THEN 'Completed'
        WHEN SUM(COALESCE(l.orderqty, 0)) = ISNULL((
            SELECT SUM(COALESCE(s.orderqty, 0)) 
            FROM StoreOutTrans s 
            WHERE s.outid = l.outid
        ), 0) THEN 'Completed'
        ELSE 'Pending'
    END AS Status
FROM LotOutTrans l
LEFT OUTER JOIN party ps ON ps.partyid = l.PartyId 
WHERE 
    (
        (@status = 'Completed' AND (
            l.outid IN (
                SELECT s.outid 
                FROM StoreOutTrans s 
                GROUP BY s.outid
                HAVING SUM(COALESCE(s.orderqty, 0)) = (
                    SELECT SUM(COALESCE(l2.orderqty, 0))
                    FROM LotOutTrans l2
                    WHERE l2.outid = s.outid
                )
            )
            OR EXISTS (
                SELECT 1 
                FROM StoreOutTrans s 
                WHERE s.outid = l.outid 
                AND s.PreLotPrefix = 'FORCE'
            )
        ))
        OR 
        (@status = 'Pending' AND (
            l.outid NOT IN (
                SELECT s.outid 
                FROM StoreOutTrans s 
                GROUP BY s.outid
                HAVING SUM(COALESCE(s.orderqty, 0)) = (
                    SELECT SUM(COALESCE(l2.orderqty, 0))
                    FROM LotOutTrans l2
                    WHERE l2.outid = s.outid
                )
            )
            AND NOT EXISTS (  -- Changed from OR to AND
                SELECT 1 
                FROM StoreOutTrans s 
                WHERE s.outid = l.outid 
                AND s.PreLotPrefix = 'FORCE'
            )
        ))
        OR (@status IS NULL OR @status = '')
    )
    AND l.UnitId = @unit 
    AND l.DemandStatus = 'Approved'
   
    AND (@demandirn IS NULL OR @demandirn = '' OR l.demandirn = @demandirn)
GROUP BY 
    l.outid,
    l.isAssigned,
    l.demandirn,
    ps.partytypeid + '-' + ps.partyname
ORDER BY l.outid desc";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text

                };
                cmd.Parameters.AddWithValue("@status", stat);

                cmd.Parameters.AddWithValue("@unit", UnitId);
                cmd.Parameters.AddWithValue("@demandirn", demandirn);
                cmd.Parameters.AddWithValue("@username", avuser);

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        IsuserAssigned = rdr.GetBoolean(rdr.GetOrdinal("Assign")),
                        DemandIrn = rdr["demandirn"].ToString(),

                        GrowerGroupName = rdr["PartyName"].ToString(),
                        OrderType = rdr["otype"].ToString(),
                        TotalOrderQty = Convert.ToInt32(rdr["TotalLotOrderQty"]),

                        TotalStoreOut = Convert.ToInt32(rdr["TotalStoreOrderQty"]),
                        DraftedQty = Convert.ToInt32(rdr["TotalDraftedQty"]),

                        DemandNo = Convert.ToInt32(rdr["outid"]),

                        StoreStat = rdr["Status"].ToString(),







                    };
                    GetDailyPreinward.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinward;
        }
























        public async Task<List<CompanyModel>> GetPendingLocationProc(int UnitId, string Prestat)
        {
            List<CompanyModel> GetPendingQuality = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT
   
   

    p.partytypeid + '-' + p.partyname AS PartyName,
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName, pt.name as UOM, ci.LotIrn, pq.name as variety,ci.VerifiedQty as Qty,ci.LocationChamberId as Chamber,

lf.FloorName,lf.MatrixName,lf.RowName,lf.ColumnName,ci.bins,lf.TotalCrates,ci.Lotno,
    CASE 
        
        WHEN EXISTS (SELECT 1 FROM locationfinal lf WHERE lf.LotNo = ci.LotNo) THEN 'Completed'
        ELSE 'Pending'
    END AS Status
FROM GateInTrans ci


LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.growerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
LEFT JOIN users ui ON ci.createdby = ui.id
LEFT JOIN prodqaul pq ON ci.varietyid = pq.id
LEFT JOIN servicetypes st ON ci.schemeid = st.id
LEFT JOIN unit_master um ON ci.Unitid = um.id
LEFT JOIN PTYPE pt ON ci.packageid = pt.id
LEFT JOIN users ur ON ci.Createdby = ur.id
LEFT JOIN location_master lm ON ci.locationMasterId  = lm.id
LEFT JOIN prodtype pd ON ci.itemid = pd.id

LEFT JOIN QualityControl qcon ON ci.lotno = qcon.lotno

LEFT JOIN locationfinal lf ON ci.lotno = lf.lotno

WHERE 

ci.UnitId=@unitid and  ci.dockpost=1 and
(
    (@status = 'Deleted' AND ci.flagdeleted = 1)
    OR 
    (@status = 'Completed' AND ci.flagdeleted = 0 AND EXISTS (SELECT 1 FROM locationfinal lf WHERE lf.LotNo = ci.LotNo))
    OR 
    (@status = 'Pending' AND ci.flagdeleted = 0 AND NOT EXISTS (SELECT 1 FROM locationfinal lf WHERE lf.LotNo = ci.LotNo)))
	
ORDER BY ci.GateInId DESC";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text

                };
                cmd.Parameters.AddWithValue("@unitid", UnitId);
                cmd.Parameters.AddWithValue("@status", Prestat);

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Lotno = Convert.ToInt32(rdr["Lotno"]),
                        LotIrn = rdr["LotIrn"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        VarietyId = rdr["variety"].ToString(),
                        ChamberId = Convert.ToInt32(rdr["Chamber"]),
                        PreInwardUom = rdr["UOM"].ToString(),
                        VerfiedQty = Convert.ToDecimal(rdr["Qty"]),
                        Verfiedbins = rdr["bins"] != DBNull.Value ? Convert.ToDecimal(rdr["bins"]) : 0,
                        PreInwardStatus = rdr["Status"].ToString(),
                        FloorName = rdr["FloorName"]?.ToString() ?? "",
                        MatrixName = rdr["MatrixName"]?.ToString() ?? "",
                        RowName = rdr["RowName"]?.ToString() ?? "",
                        ColumName = rdr["ColumnName"]?.ToString() ?? "",

                        CrateNos = rdr["TotalCrates"] != DBNull.Value ? Convert.ToDecimal(rdr["TotalCrates"]) : 0,




                    };
                    GetPendingQuality.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetPendingQuality;
        }





        public async Task<List<CompanyModel>> GetPendingDockPro(int UnitId, int Dockposting)
        {
            List<CompanyModel> GetPendingQuality = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT	 p.partytypeid + '-' + p.partyname AS PartyName,
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,ci.Lotno, ci.PreInIrn, ci.LotIrn, pq.name as variety,ci.qty,

ci.LocationChamberId as Chamber,
    CASE 
        WHEN ci.flagdeleted = 1 THEN 'Deleted'
        WHEN EXISTS (SELECT 1 FROM QualityControl qi WHERE qi.LotNo = ci.LotNo) THEN 'Yes'
        ELSE 'Pending'
    END AS Quality,ci.LocationChamberId as Chamber,isnull(tl.name,'NA') as Location,ci.VerifiedQty,ci.VerifiedCompanyCrates,ci.VerifiedOwnCrates,ci.VerifiedWoodenPetty,ci.Pallets,ci.Bins,
	 CASE 
        WHEN ci.isStickerPrinted = 1 THEN 'Yes'
         ELSE 'No'
    END AS StickerPrinted,ci.cratemarka,ci.KhataName,ci.dockpost
FROM GateInTrans ci


LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.growerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
LEFT JOIN users ui ON ci.createdby = ui.id
LEFT JOIN prodqaul pq ON ci.varietyid = pq.id
LEFT JOIN servicetypes st ON ci.schemeid = st.id
LEFT JOIN unit_master um ON ci.Unitid = um.id
LEFT JOIN PTYPE pt ON ci.packageid = pt.id
LEFT JOIN users ur ON ci.Createdby = ur.id
LEFT JOIN location_master tl ON ci.OriginID = tl.id
 
 where

 ci.lotno in(select lotno from qualitycontrol)
and ci.UnitId=@unitid  and ci.dockpost=@Trid ORDER BY ci.GateInId DESC

";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text

                };
                cmd.Parameters.AddWithValue("@unitid", UnitId);
                cmd.Parameters.AddWithValue("@Trid", Dockposting);

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        DockPost = rdr["dockpost"] != DBNull.Value ? Convert.ToInt32(rdr["dockpost"]) : 0,

                        Lotno = rdr["Lotno"] != DBNull.Value ? Convert.ToInt32(rdr["Lotno"]) : 0,
                        GrowerGroupName = rdr["PartyName"]?.ToString() ?? "",
                        GrowerName = rdr["GrowerName"]?.ToString() ?? "",
                        VarietyId = rdr["variety"]?.ToString() ?? "",

                        PreInwardQty = rdr["qty"] != DBNull.Value ? Convert.ToDecimal(rdr["qty"]) : 0,

                        PreInwardKhata = rdr["KhataName"]?.ToString() ?? "",

                        PreInIrn = rdr["PreInIrn"]?.ToString() ?? "",
                        PreInwardStatus = rdr["Quality"]?.ToString() ?? "",
                        LotIrn = rdr["LotIrn"]?.ToString() ?? "",

                        ChamberId = rdr["Chamber"] != DBNull.Value ? Convert.ToInt32(rdr["Chamber"]) : 0,

                        Templocation = rdr["Location"]?.ToString() ?? "",

                        VerfiedQty = rdr["VerifiedQty"] != DBNull.Value ? Convert.ToDecimal(rdr["VerifiedQty"]) : 0,
                        VerfiedOwnCrates = rdr["VerifiedOwnCrates"] != DBNull.Value ? Convert.ToDecimal(rdr["VerifiedOwnCrates"]) : 0,
                        VerfiedCompanyCrates = rdr["VerifiedCompanyCrates"] != DBNull.Value ? Convert.ToDecimal(rdr["VerifiedCompanyCrates"]) : 0,
                        Verfiedpetties = rdr["VerifiedWoodenPetty"] != DBNull.Value ? Convert.ToDecimal(rdr["VerifiedWoodenPetty"]) : 0,
                        Verfiedbins = rdr["Bins"] != DBNull.Value ? Convert.ToDecimal(rdr["Bins"]) : 0,
                        Verfiedpallets = rdr["Pallets"] != DBNull.Value ? Convert.ToDecimal(rdr["Pallets"]) : 0,

                        Stickerprinted = rdr["StickerPrinted"]?.ToString() ?? "",
                        CrateMarka = rdr["cratemarka"]?.ToString() ?? "",

                    };
                    GetPendingQuality.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetPendingQuality;
        }
















        public async Task<List<CompanyModel>> GetDailyPreinwardProctemp(int Tempid)
        {
            List<CompanyModel> GetDailyPreinwardtemp = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"
SELECT
    ci.trid ,prt.name as item,pt.name as package,ci.khataName,ci.cratetype,pq.name as variety,
    ci.qty,st.sname,  ci.GateInId ,ci.PreInIrn
    
FROM gateinmaster ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.growerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
LEFT JOIN users ui ON ci.createdby = ui.id
LEFT JOIN prodqaul pq ON ci.varietyid = pq.id
LEFT JOIN servicetypes st ON ci.schemeid = st.id
LEFT JOIN unit_master um ON ci.Unitid = um.id
LEFT JOIN PTYPE pt ON ci.packageid = pt.id
LEFT JOIN users ur ON ci.Createdby = ur.id
LEFT JOIN prodtype prt ON ci.itemid = prt.id
WHERE 
 GateInId=@gateid and qty>0


ORDER BY trid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text

                };
                cmd.Parameters.AddWithValue("@gateid", Tempid);

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Trid = Convert.ToInt32(rdr["trid"]),
                        Itemname = rdr["item"].ToString(),
                        PreInwardUom = rdr["package"].ToString(),
                        PreInwardKhata = rdr["khataName"].ToString(),
                        VarietyId = rdr["variety"].ToString(),
                        PreInwardQty = Convert.ToDecimal(rdr["qty"]),
                        PreCrateType = rdr["cratetype"].ToString(),
                        ServiceId = rdr["sname"].ToString(),


                    };
                    GetDailyPreinwardtemp.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinwardtemp;
        }



























        public async Task<List<CompanyModel>> GetDailyCratesProcOut()
        {
            List<CompanyModel> GetDailyCrates = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT
    ci.cid,ci.Trno,

    ci.Dated,
	p.partytypeid  +'-'+ p.partyname AS PartyName,
 convert(varchar(max),ps.partyid)  +'-'+ ps.partyname AS GrowerName,
    convert(varchar(max),cm.id)  +'-'+ cm.ChallanName as ChallanName,
      rtrim(vi.vehno) + space(1)+'('+ rtrim(vi.drivername)+space(1)+')'+space(1)+'('+rtrim(vi.contactno)+')' as vehno,


	ci.CrateMark,
    ci.qty,
    ci.trflag,
ci.Remarks
FROM crateissue ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.groowerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
WHERE  ci.trflag in('Empty Returned','Petty Returned') and ci.flagdeleted=0 and CONVERT(date, ci.Dated) = CONVERT(date, GETDATE()) order by ci.cid desc";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        CrissueId = Convert.ToInt32(rdr["cid"]),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                        ChallanName = rdr["challanname"].ToString(),
                        Vehno = rdr["vehno"].ToString(),
                        CrissueMark = rdr["CrateMark"].ToString(),
                        CrissueQty = Convert.ToDecimal(rdr["qty"]),
                        CrateIssueDated = Convert.ToDateTime(rdr["Dated"]),
                        CrissueFlag = rdr["trflag"].ToString(),
                        CrissueRemarks = rdr["Remarks"].ToString(),
                        CrateCrn = rdr["Trno"].ToString(),







                    };
                    GetDailyCrates.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyCrates;
        }







        public async Task<List<CompanyModel>> GetDailyCratesProcEmpty()
        {
            List<CompanyModel> GetDailyCrates = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT
    ci.cid,ci.Trno,

    ci.Dated,
	p.partytypeid  +'-'+ p.partyname AS PartyName,
 convert(varchar(max),ps.partyid)  +'-'+ ps.partyname AS GrowerName,
    convert(varchar(max),cm.id)  +'-'+ cm.ChallanName as ChallanName,
      rtrim(vi.vehno) + space(1)+'('+ rtrim(vi.drivername)+space(1)+')'+space(1)+'('+rtrim(vi.contactno)+')' as vehno,


	ci.CrateMark,
    ci.qty,
    ci.trflag,
ci.Remarks
FROM crateissue ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.groowerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
WHERE  ci.trflag='Empty Receive' and ci.flagdeleted=0 and CONVERT(date, ci.Dated) = CONVERT(date, GETDATE()) order by ci.cid desc";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        CrissueId = Convert.ToInt32(rdr["cid"]),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                        ChallanName = rdr["challanname"].ToString(),
                        Vehno = rdr["vehno"].ToString(),
                        CrissueMark = rdr["CrateMark"].ToString(),
                        CrissueQty = Convert.ToDecimal(rdr["qty"]),
                        CrateIssueDated = Convert.ToDateTime(rdr["Dated"]),
                        CrissueFlag = rdr["trflag"].ToString(),
                        CrissueRemarks = rdr["Remarks"].ToString(),
                        CrateCrn = rdr["Trno"].ToString(),






                    };
                    GetDailyCrates.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyCrates;
        }




        public async Task<List<CompanyModel>> GetCrateSummaryMain()
        {
            List<CompanyModel> GetDailyCrates = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("CratesummaryMain", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!

                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"select b.partyid,b. partytypeid  +'-'+ b.partyname as Partyname,a.Agreement,a.crateissue,a.Cratereceive as Filled,a.EmptyReceive as Empty,adjgiven as Adjustmentto,adjreceived as Adjustmentreceive,
(crateissue+adjreceived)-(crateReceive+emptyReceive+adjgiven) as CrBalance,GrowerReceive,GrowerReturn,GrowerReceive-GrowerReturn as SelfBalance,
pettyReceive,PettyReturn,pettyReceive-PettyReturn as Pbalance


from CrateAnalysissummary a,party b where a.partyid=b.partyid order by a.partyid ";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Partyid = Convert.ToInt32(rdr["partyid"]),


                        GrowerGroupName = rdr["Partyname"].ToString(),
                        CrateAgreement = Convert.ToDecimal(rdr["Agreement"]),
                        CrateIssue = Convert.ToDecimal(rdr["crateissue"]),
                        CrateReceive = Convert.ToDecimal(rdr["Filled"]),
                        EmptyReceive = Convert.ToDecimal(rdr["Empty"]),
                        CrateBalance = Convert.ToDecimal(rdr["CrBalance"]),
                        SelfCrateReceive = Convert.ToDecimal(rdr["GrowerReceive"]),
                        EmptyReturn = Convert.ToDecimal(rdr["GrowerReturn"]),
                        SelfCrateBalance = Convert.ToDecimal(rdr["SelfBalance"]),
                        PettyReceive = Convert.ToDecimal(rdr["pettyReceive"]),
                        PettyReturn = Convert.ToDecimal(rdr["PettyReturn"]),
                        PettyBalance = Convert.ToDecimal(rdr["Pbalance"]),
                        CrateAdjustmentGiven = Convert.ToDecimal(rdr["Adjustmentto"]),
                        CrateAdjustmentTaken = Convert.ToDecimal(rdr["Adjustmentreceive"]),




                    };
                    GetDailyCrates.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyCrates;
        }



        public async Task<List<CompanyModel>> Getdraftdash(int unit)
        {
            List<CompanyModel> Growerslots = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
           
                const string query = @"SELECT 
    r.recipeid,
    r.recipename,
    ig.gradename,
    combined.marka,
    SUM(generated_qty) AS total_generated_qty,
    SUM(ordered_qty) AS total_ordered_qty,
    SUM(generated_qty) - SUM(ordered_qty) AS balance_qty
FROM (
    SELECT recipeid, gradeid, marka, qty AS generated_qty, 0 AS ordered_qty
    FROM repackdraftitems 
    WHERE flagdeleted = 0 and unitid=@unitid
    UNION ALL
    SELECT recipeid, gradeid, marka, 0 AS generated_qty, qty AS ordered_qty
    FROM packingorderitems 
    WHERE flagdeleted = 0 and unitid=@unitid
) combined
INNER JOIN recipe r ON combined.recipeid = r.recipeid
INNER JOIN itemgrades ig ON combined.gradeid = ig.id
GROUP BY r.recipeid, r.recipename, ig.gradename, combined.marka
ORDER BY ig.gradename, combined.marka, r.recipeid;";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@unitid", unit);
                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        ReceipeName = rdr["recipename"].ToString(),
                        ReceipeGrade = rdr["gradename"].ToString(),
                        ReceipeMarka = rdr["marka"].ToString(),
                        ReceipeQty = Convert.ToInt32(rdr["total_generated_qty"]),
                        PackingQty = Convert.ToInt32(rdr["total_ordered_qty"]),
                       Recipebalance = Convert.ToInt32(rdr["balance_qty"]),



                    };
                    Growerslots.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Growerslots;
        }





        public async Task<List<CompanyModel>> Getdraftdashdetail(int unit, int partyId)
        {
            List<CompanyModel> Growerslots = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                string query;

                if (partyId == 0)
                {
                    // Simplified query for all parties (no filtering)
                    query = @"SELECT 
    r.recipeid,
    r.recipename,
    pq.name AS product_quality,
    ig.gradename,
    combined.marka,
    combined.draftirn,
    combined.palletirn AS pallet_irn,
    combined.Palletno AS pallet_number,
    SUM(combined.generated_qty) AS total_generated_qty,
    SUM(combined.ordered_qty) AS total_ordered_qty,
    SUM(combined.generated_qty) - SUM(combined.ordered_qty) AS balance_qty
FROM (
    SELECT 
        rdi.recipeid, 
        rdi.gradeid, 
        rdi.marka, 
        rdi.PackingDraftno as draftirn, 
        rdi.palletirn, 
        rdi.Palletno, 
        rdi.brandid, 
        rdi.qty AS generated_qty, 
        0 AS ordered_qty
    FROM repackdraftitems rdi
    WHERE rdi.flagdeleted = 0
    
    UNION ALL
    
    SELECT 
        poi.recipeid, 
        poi.gradeid, 
        poi.marka, 
        poi.draftirn, 
        poi.palletirn, 
        poi.Palletno, 
        poi.brandid, 
        0 AS generated_qty, 
        poi.qty AS ordered_qty
    FROM packingorderitems poi
    WHERE poi.flagdeleted = 0
) combined
INNER JOIN recipe r ON combined.recipeid = r.recipeid
INNER JOIN itemgrades ig ON combined.gradeid = ig.id
INNER JOIN prodqaul pq ON combined.brandid = pq.id
GROUP BY 
    r.recipeid, 
    r.recipename, 
    pq.name, 
    ig.gradename, 
    combined.marka, 
    combined.draftirn, 
    combined.palletirn, 
    combined.Palletno
ORDER BY combined.Palletno";
                }
                else
                {
                    // Optimized query with party filtering
                    query = @"WITH PartyPallets AS (
    SELECT DISTINCT 
        rdi.PackingDraftno as draftirn,
        rdi.Palletno,
        rdi.palletirn
    FROM repackdraftitems rdi
    INNER JOIN (
        SELECT DISTINCT draftid
        FROM DraftOutTrans 
        WHERE partyid = @partyId
    ) partyDrafts ON rdi.draftid = partyDrafts.draftid
    WHERE rdi.flagdeleted = 0
)
SELECT 
    r.recipeid,
    r.recipename,
    pq.name AS product_quality,
    ig.gradename,
    combined.marka,
    combined.draftirn,
    combined.palletirn AS pallet_irn,
    combined.Palletno AS pallet_number,
    SUM(combined.generated_qty) AS total_generated_qty,
    SUM(combined.ordered_qty) AS total_ordered_qty,
    SUM(combined.generated_qty) - SUM(combined.ordered_qty) AS balance_qty
FROM (
    -- Generated quantities for the selected party
    SELECT 
        rdi.recipeid, 
        rdi.gradeid, 
        rdi.marka, 
        rdi.PackingDraftno as draftirn, 
        rdi.palletirn, 
        rdi.Palletno, 
        rdi.brandid, 
        rdi.qty AS generated_qty, 
        0 AS ordered_qty
    FROM repackdraftitems rdi
    INNER JOIN (
        SELECT DISTINCT draftid
        FROM DraftOutTrans 
        WHERE partyid = @partyId
    ) partyDrafts ON rdi.draftid = partyDrafts.draftid
    WHERE rdi.flagdeleted = 0
    
    UNION ALL
    
    -- Ordered quantities for same pallets/draftirns
    SELECT 
        poi.recipeid, 
        poi.gradeid, 
        poi.marka, 
        poi.draftirn, 
        poi.palletirn, 
        poi.Palletno, 
        poi.brandid, 
        0 AS generated_qty, 
        poi.qty AS ordered_qty
    FROM packingorderitems poi
    WHERE poi.flagdeleted = 0
    AND EXISTS (
        SELECT 1 FROM PartyPallets pp 
        WHERE pp.draftirn = poi.draftirn 
        AND pp.Palletno = poi.Palletno
    )
) combined
INNER JOIN recipe r ON combined.recipeid = r.recipeid
INNER JOIN itemgrades ig ON combined.gradeid = ig.id
INNER JOIN prodqaul pq ON combined.brandid = pq.id
GROUP BY 
    r.recipeid, 
    r.recipename, 
    pq.name, 
    ig.gradename, 
    combined.marka, 
    combined.draftirn, 
    combined.palletirn, 
    combined.Palletno
ORDER BY combined.Palletno";
                }

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                // Add parameters
                cmd.Parameters.AddWithValue("@unitid", unit);

                if (partyId != 0)
                {
                    cmd.Parameters.AddWithValue("@partyId", partyId);
                }

                try
                {
                    con.Open();
                    SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                    while (rdr.Read())
                    {
                        CompanyModel companyModel = new CompanyModel
                        {
                            ReceipeName = rdr["recipename"].ToString(),
                            ReceipeGrade = rdr["gradename"].ToString(),
                            ReceipeMarka = rdr["marka"].ToString(),
                            ReceipeQty = Convert.ToInt32(rdr["total_generated_qty"]),
                            PackingQty = Convert.ToInt32(rdr["total_ordered_qty"]),
                            Recipebalance = Convert.ToInt32(rdr["balance_qty"]),
                            VarietyId = rdr["product_quality"].ToString(),
                            DraftIrn = rdr["draftirn"].ToString(),
                            PalletName = rdr["pallet_irn"].ToString(),
                        };
                        Growerslots.Add(companyModel);
                    }

                    rdr.Close();
                }
                catch (Exception ex)
                {
                    throw new Exception($"Error fetching stock quantity: {ex.Message}", ex);
                }
                finally
                {
                    con.Close();
                    cmd.Dispose();
                }
            }

            return Growerslots;
        }
        public async Task<List<CompanyModel>> Getdraftdashdetailavail(int unit, int partyId)
        {
            List<CompanyModel> Growerslots = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
               

                string query;
                if (partyId == 0)
                {
                    query = @"SELECT 
    r.recipeid,
    r.recipename,
    pq.name AS product_quality,
    ig.gradename,
    combined.marka,
    combined.draftirn,
    combined.palletirn AS pallet_irn,
    combined.Palletno AS pallet_number,
    SUM(combined.generated_qty) AS total_generated_qty,
    SUM(combined.ordered_qty) AS total_ordered_qty,
    SUM(combined.generated_qty) - SUM(combined.ordered_qty) AS balance_qty
FROM (
    SELECT 
        rdi.recipeid, 
        rdi.gradeid, 
        rdi.marka, 
        rdi.PackingDraftno as draftirn, 
        rdi.palletirn, 
        rdi.Palletno, 
        rdi.brandid, 
        ISNULL(rdi.qty, 0) AS generated_qty,  -- ISNULL here
        0 AS ordered_qty
    FROM repackdraftitems rdi
    WHERE rdi.flagdeleted = 0
    
    UNION ALL
    
    SELECT 
        poi.recipeid, 
        poi.gradeid, 
        poi.marka, 
        poi.draftirn, 
        poi.palletirn, 
        poi.Palletno, 
        poi.brandid, 
        0 AS generated_qty, 
        ISNULL(poi.qty, 0) AS ordered_qty  -- ISNULL here
    FROM packingorderitems poi
    WHERE poi.flagdeleted = 0
) combined
INNER JOIN recipe r ON combined.recipeid = r.recipeid
INNER JOIN itemgrades ig ON combined.gradeid = ig.id
INNER JOIN prodqaul pq ON combined.brandid = pq.id
GROUP BY 
    r.recipeid, 
    r.recipename, 
    pq.name, 
    ig.gradename, 
    combined.marka, 
    combined.draftirn, 
    combined.palletirn, 
    combined.Palletno
HAVING (SUM(combined.generated_qty) - SUM(combined.ordered_qty)) > 0  -- Simple comparison
ORDER BY combined.Palletno";
                }
                else
                {
                    query = @"WITH PartyPallets AS (
    SELECT DISTINCT 
        rdi.PackingDraftno as draftirn,
        rdi.Palletno,
        rdi.palletirn
    FROM repackdraftitems rdi
    INNER JOIN (
        SELECT DISTINCT draftid
        FROM DraftOutTrans 
        WHERE partyid = @partyId
    ) partyDrafts ON rdi.draftid = partyDrafts.draftid
    WHERE rdi.flagdeleted = 0
)
SELECT 
    r.recipeid,
    r.recipename,
    pq.name AS product_quality,
    ig.gradename,
    combined.marka,
    combined.draftirn,
    combined.palletirn AS pallet_irn,
    combined.Palletno AS pallet_number,
    SUM(combined.generated_qty) AS total_generated_qty,
    SUM(combined.ordered_qty) AS total_ordered_qty,
    SUM(combined.generated_qty) - SUM(combined.ordered_qty) AS balance_qty
FROM (
    SELECT 
        rdi.recipeid, 
        rdi.gradeid, 
        rdi.marka, 
        rdi.PackingDraftno as draftirn, 
        rdi.palletirn, 
        rdi.Palletno, 
        rdi.brandid, 
        ISNULL(rdi.qty, 0) AS generated_qty,  -- ISNULL here
        0 AS ordered_qty
    FROM repackdraftitems rdi
    INNER JOIN (
        SELECT DISTINCT draftid
        FROM DraftOutTrans 
        WHERE partyid = @partyId
    ) partyDrafts ON rdi.draftid = partyDrafts.draftid
    WHERE rdi.flagdeleted = 0
    
    UNION ALL
    
    SELECT 
        poi.recipeid, 
        poi.gradeid, 
        poi.marka, 
        poi.draftirn, 
        poi.palletirn, 
        poi.Palletno, 
        poi.brandid, 
        0 AS generated_qty, 
        ISNULL(poi.qty, 0) AS ordered_qty  -- ISNULL here
    FROM packingorderitems poi
    WHERE poi.flagdeleted = 0
    AND EXISTS (
        SELECT 1 FROM PartyPallets pp 
        WHERE pp.draftirn = poi.draftirn 
        AND pp.Palletno = poi.Palletno
    )
) combined
INNER JOIN recipe r ON combined.recipeid = r.recipeid
INNER JOIN itemgrades ig ON combined.gradeid = ig.id
INNER JOIN prodqaul pq ON combined.brandid = pq.id
GROUP BY 
    r.recipeid, 
    r.recipename, 
    pq.name, 
    ig.gradename, 
    combined.marka, 
    combined.draftirn, 
    combined.palletirn, 
    combined.Palletno
HAVING (SUM(combined.generated_qty) - SUM(combined.ordered_qty)) > 0  -- Simple comparison
ORDER BY combined.Palletno";
                }

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                // Add parameters
                cmd.Parameters.AddWithValue("@unitid", unit);

                if (partyId != 0)
                {
                    cmd.Parameters.AddWithValue("@partyId", partyId);
                }

                try
                {
                    con.Open();
                    SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                    while (rdr.Read())
                    {
                        CompanyModel companyModel = new CompanyModel
                        {
                            ReceipeName = rdr["recipename"].ToString(),
                            ReceipeGrade = rdr["gradename"].ToString(),
                            ReceipeMarka = rdr["marka"].ToString(),
                            ReceipeQty = Convert.ToInt32(rdr["total_generated_qty"]),
                            PackingQty = Convert.ToInt32(rdr["total_ordered_qty"]),
                            Recipebalance = Convert.ToInt32(rdr["balance_qty"]),
                            VarietyId = rdr["product_quality"].ToString(),
                            DraftIrn = rdr["draftirn"].ToString(),
                            PalletName = rdr["pallet_irn"].ToString(),
                        };
                        Growerslots.Add(companyModel);
                    }

                    rdr.Close();
                }
                catch (Exception ex)
                {
                    throw new Exception($"Error fetching stock quantity: {ex.Message}", ex);
                }
                finally
                {
                    con.Close();
                    cmd.Dispose();
                }
            }

            return Growerslots;
        }

        public async Task<List<CompanyModel>> Getdraftdashdetailfinish(int unit, int partyId)
        {
            List<CompanyModel> Growerslots = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                string query;
                if (partyId == 0)
                {
                    query = @"SELECT 
    r.recipeid,
    r.recipename,
    pq.name AS product_quality,
    ig.gradename,
    combined.marka,
    combined.draftirn,
    combined.palletirn AS pallet_irn,
    combined.Palletno AS pallet_number,
    SUM(combined.generated_qty) AS total_generated_qty,
    SUM(combined.ordered_qty) AS total_ordered_qty,
    SUM(combined.generated_qty) - SUM(combined.ordered_qty) AS balance_qty
FROM (
    SELECT 
        rdi.recipeid, 
        rdi.gradeid, 
        rdi.marka, 
        rdi.PackingDraftno as draftirn, 
        rdi.palletirn, 
        rdi.Palletno, 
        rdi.brandid, 
        ISNULL(rdi.qty, 0) AS generated_qty,
        0 AS ordered_qty
    FROM repackdraftitems rdi
    WHERE rdi.flagdeleted = 0
    
    UNION ALL
    
    SELECT 
        poi.recipeid, 
        poi.gradeid, 
        poi.marka, 
        poi.draftirn, 
        poi.palletirn, 
        poi.Palletno, 
        poi.brandid, 
        0 AS generated_qty, 
        ISNULL(poi.qty, 0) AS ordered_qty
    FROM packingorderitems poi
    WHERE poi.flagdeleted = 0
) combined
INNER JOIN recipe r ON combined.recipeid = r.recipeid
INNER JOIN itemgrades ig ON combined.gradeid = ig.id
INNER JOIN prodqaul pq ON combined.brandid = pq.id
GROUP BY 
    r.recipeid, 
    r.recipename, 
    pq.name, 
    ig.gradename, 
    combined.marka, 
    combined.draftirn, 
    combined.palletirn, 
    combined.Palletno
-- Use ABS() with a small tolerance for decimal comparison
HAVING ABS(SUM(combined.generated_qty) - SUM(combined.ordered_qty)) < 0.001
ORDER BY combined.Palletno";
                }
                else
                {
                    query = @"WITH PartyPallets AS (
    SELECT DISTINCT 
        rdi.PackingDraftno as draftirn,
        rdi.Palletno,
        rdi.palletirn
    FROM repackdraftitems rdi
    INNER JOIN (
        SELECT DISTINCT draftid
        FROM DraftOutTrans 
        WHERE partyid = @partyId
    ) partyDrafts ON rdi.draftid = partyDrafts.draftid
    WHERE rdi.flagdeleted = 0
)
SELECT 
    r.recipeid,
    r.recipename,
    pq.name AS product_quality,
    ig.gradename,
    combined.marka,
    combined.draftirn,
    combined.palletirn AS pallet_irn,
    combined.Palletno AS pallet_number,
    SUM(combined.generated_qty) AS total_generated_qty,
    SUM(combined.ordered_qty) AS total_ordered_qty,
    SUM(combined.generated_qty) - SUM(combined.ordered_qty) AS balance_qty
FROM (
    SELECT 
        rdi.recipeid, 
        rdi.gradeid, 
        rdi.marka, 
        rdi.PackingDraftno as draftirn, 
        rdi.palletirn, 
        rdi.Palletno, 
        rdi.brandid, 
        ISNULL(rdi.qty, 0) AS generated_qty,
        0 AS ordered_qty
    FROM repackdraftitems rdi
    INNER JOIN (
        SELECT DISTINCT draftid
        FROM DraftOutTrans 
        WHERE partyid = @partyId
    ) partyDrafts ON rdi.draftid = partyDrafts.draftid
    WHERE rdi.flagdeleted = 0
    
    UNION ALL
    
    SELECT 
        poi.recipeid, 
        poi.gradeid, 
        poi.marka, 
        poi.draftirn, 
        poi.palletirn, 
        poi.Palletno, 
        poi.brandid, 
        0 AS generated_qty, 
        ISNULL(poi.qty, 0) AS ordered_qty
    FROM packingorderitems poi
    WHERE poi.flagdeleted = 0
    AND EXISTS (
        SELECT 1 FROM PartyPallets pp 
        WHERE pp.draftirn = poi.draftirn 
        AND pp.Palletno = poi.Palletno
    )
) combined
INNER JOIN recipe r ON combined.recipeid = r.recipeid
INNER JOIN itemgrades ig ON combined.gradeid = ig.id
INNER JOIN prodqaul pq ON combined.brandid = pq.id
GROUP BY 
    r.recipeid, 
    r.recipename, 
    pq.name, 
    ig.gradename, 
    combined.marka, 
    combined.draftirn, 
    combined.palletirn, 
    combined.Palletno
-- Use ABS() with a small tolerance for decimal comparison
HAVING ABS(SUM(combined.generated_qty) - SUM(combined.ordered_qty)) < 0.001
ORDER BY combined.Palletno";
                }


                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                // Add parameters
                cmd.Parameters.AddWithValue("@unitid", unit);

                if (partyId != 0)
                {
                    cmd.Parameters.AddWithValue("@partyId", partyId);
                }

                try
                {
                    con.Open();
                    SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                    while (rdr.Read())
                    {
                        CompanyModel companyModel = new CompanyModel
                        {
                            ReceipeName = rdr["recipename"].ToString(),
                            ReceipeGrade = rdr["gradename"].ToString(),
                            ReceipeMarka = rdr["marka"].ToString(),
                            ReceipeQty = Convert.ToInt32(rdr["total_generated_qty"]),
                            PackingQty = Convert.ToInt32(rdr["total_ordered_qty"]),
                            Recipebalance = Convert.ToInt32(rdr["balance_qty"]),
                            VarietyId = rdr["product_quality"].ToString(),
                            DraftIrn = rdr["draftirn"].ToString(),
                            PalletName = rdr["pallet_irn"].ToString(),
                        };
                        Growerslots.Add(companyModel);
                    }

                    rdr.Close();
                }
                catch (Exception ex)
                {
                    throw new Exception($"Error fetching stock quantity: {ex.Message}", ex);
                }
                finally
                {
                    con.Close();
                    cmd.Dispose();
                }
            }

            return Growerslots;
        }
   




        public async Task<List<CompanyModel>> GetRecipeQty(int DraftId)
        {

            List<CompanyModel> GetTotalReceipeQty = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("GetRecipeQty", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;

                    cmd3.Parameters.AddWithValue("@DraftId", DraftId);

                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"select draftid, rc.Recipeid,rc.recipename,isnull(sum(draftqty),0) as DraftQty, isnull(sum(SachetQty),0) as SacQty from DraftSachettemp ds left join Recipe rc on rc.Recipeid = ds.receipid group by rc.Recipeid,draftid, receipid ,recipename";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        DraftId = Convert.ToInt32(rdr["Draftid"]),
                        ReceipeName = rdr["recipename"]?.ToString(),
                        TotalReceipeQty = Convert.ToInt32(rdr["DraftQty"]),
                        SachetQty = Convert.ToInt32(rdr["SacQty"]),
                        ReceipeId = Convert.ToInt32(rdr["Recipeid"]),





                    };
                    GetTotalReceipeQty.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetTotalReceipeQty;
        }

        public async Task<List<CompanyModel>> GetVarietyRates(int DraftId)
        {

            List<CompanyModel> GetTotalReceipeQty = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"select VerifiedBrandId,pq.name as Vareity,sum(OrderQty) as Qty,isnull(pallets,0) as Rate from LotOutTranstemp lp
left join 
prodqaul pq 
on lp.VerifiedBrandId=pq.id 

where tempid=@DraftId group by  VerifiedBrandId,pq.name,pallets";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@DraftId", DraftId);
                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        Brandid = Convert.ToInt32(rdr["VerifiedBrandId"]),
                        VarietyId = rdr["Vareity"]?.ToString(),
                        VarietyQty = Convert.ToInt32(rdr["Qty"]),
                        VarietyRate = Convert.ToInt32(rdr["Rate"]),






                    };
                    GetTotalReceipeQty.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetTotalReceipeQty;
        }

        public async Task<List<CompanyModel>> GetVarietyRatesKg(int DraftId)
        {

            List<CompanyModel> GetTotalReceipeQty = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"select VerifiedBrandId,pq.name as Vareity,sum(OrderQty*ConditionID) as Agrade,sum(OrderQty*SchemeMapId) as Bgrade,isnull(pallets,0) as AgradeRate,isnull(ReceivedQty,0) as BgradeRate from LotOutTranstemp lp
left join 
prodqaul pq 
on lp.VerifiedBrandId=pq.id 

where tempid=@DraftId group by  VerifiedBrandId,pq.name,pallets,ReceivedQty";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@DraftId", DraftId);
                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        Brandid = Convert.ToInt32(rdr["VerifiedBrandId"]),
                        VarietyId = rdr["Vareity"]?.ToString(),
                        VarietyQtyAgrade = Convert.ToDecimal(rdr["Agrade"]),
                        VarietyQtyBgrade = Convert.ToDecimal(rdr["Bgrade"]),

                        VarietyRateAgrade = Convert.ToDecimal(rdr["AgradeRate"]),
                        VarietyRateBgrade = Convert.ToDecimal(rdr["BgradeRate"]),







                    };
                    GetTotalReceipeQty.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetTotalReceipeQty;
        }


        public async Task<List<CompanyModel>> generateCrateReport(CompanyModel EditModel)
        {
            List<CompanyModel> GetDailyCrates = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Build the dynamic WHERE clause based on filter values
                var whereConditions = new List<string>();
                var parameters = new List<SqlParameter>();

                whereConditions.Add("ci.flagdeleted = 0");

                // Date range filter
                if (EditModel.CrateDatefrom != null && EditModel.CrateDateto != null)
                {
                    whereConditions.Add("ci.Dated BETWEEN @d1 AND @d2");
                    parameters.Add(new SqlParameter("@d1", EditModel.CrateDatefrom));
                    parameters.Add(new SqlParameter("@d2", EditModel.CrateDateto));
                }
                else if (EditModel.CrateDatefrom != null)
                {
                    whereConditions.Add("ci.Dated >= @d1");
                    parameters.Add(new SqlParameter("@d1", EditModel.CrateDatefrom));
                }
                else if (EditModel.CrateDateto != null)
                {
                    whereConditions.Add("ci.Dated <= @d2");
                    parameters.Add(new SqlParameter("@d2", EditModel.CrateDateto));
                }

                // Party ID filter
                if (EditModel.Partyid > 0)
                {
                    whereConditions.Add("ci.partyid = @Partyid");
                    parameters.Add(new SqlParameter("@Partyid", EditModel.Partyid));
                }

                // Grower ID filter
                if (EditModel.Growerid > 0)
                {
                    whereConditions.Add("ci.groowerid = @Groowerid");
                    parameters.Add(new SqlParameter("@Groowerid", EditModel.Growerid));
                }

                // Challan ID filter
                if (EditModel.ChallanId > 0)
                {
                    whereConditions.Add("ci.challanid = @challanId");
                    parameters.Add(new SqlParameter("@challanId", EditModel.ChallanId));
                }

                // Crate Mark filter - Handle NULL values
                if (!string.IsNullOrWhiteSpace(EditModel.CrissueMark))
                {
                    whereConditions.Add("ci.CrateMark = @cratemark");
                    parameters.Add(new SqlParameter("@cratemark", EditModel.CrissueMark));
                }
                else
                {
                    // When CrissueMark is NULL, don't filter by it (return all records for this field)
                    whereConditions.Add("(ci.CrateMark IS NOT NULL OR ci.CrateMark IS NULL)");
                }

                // Transaction Flag filter - Handle NULL values
                if (!string.IsNullOrWhiteSpace(EditModel.CrissueFlag))
                {
                    whereConditions.Add("ci.trflag = @trflag");
                    parameters.Add(new SqlParameter("@trflag", EditModel.CrissueFlag));
                }
                else
                {
                    // When CrissueFlag is NULL, don't filter by it
                    whereConditions.Add("(ci.trflag IS NOT NULL OR ci.trflag IS NULL)");
                }

                // Vehicle Name filter - Handle NULL values
                if (!string.IsNullOrWhiteSpace(EditModel.Vehno))
                {
                    whereConditions.Add("vi.vehno LIKE '%' + @vehname + '%'");
                    parameters.Add(new SqlParameter("@vehname", EditModel.Vehno));
                }
                else
                {
                    // When Vehno is NULL, don't filter by it
                    whereConditions.Add("(vi.vehno IS NOT NULL OR vi.vehno IS NULL)");
                }

                // Build the final query
                string whereClause = string.Join(" AND ", whereConditions);

                string query = $@"
    SELECT
        ci.cid,
        ci.Trno,
        ci.Dated,
        p.partytypeid + '-' + p.partyname AS PartyName,
        CONVERT(VARCHAR(MAX), ps.partyid) + '-' + ps.partyname AS GrowerName,
        CONVERT(VARCHAR(MAX), cm.id) + '-' + cm.ChallanName as ChallanName,
        RTRIM(vi.vehno) + SPACE(1) + '(' + RTRIM(vi.drivername) + SPACE(1) + ')' + SPACE(1) + '(' + RTRIM(vi.contactno) + ')' as vehno,
        ci.CrateMark,
        ci.qty,
        ci.trflag,
        ci.Remarks
    FROM CrateIssue ci
    LEFT JOIN party p ON ci.partyid = p.partyid
    LEFT JOIN partysub ps ON ci.groowerid = ps.partyid
    LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
    LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
    WHERE {whereClause}
    ORDER BY ci.cid";

                using (SqlCommand cmd = new SqlCommand(query, con))
                {
                    cmd.CommandType = CommandType.Text;

                    // Add all parameters to the command
                    foreach (var param in parameters)
                    {
                        cmd.Parameters.Add(param);
                    }

                    using (SqlDataReader rdr = await cmd.ExecuteReaderAsync())
                    {
                        while (await rdr.ReadAsync())
                        {
                            CompanyModel companyModel = new CompanyModel
                            {
                                CrissueId = Convert.ToInt32(rdr["cid"]),
                                GrowerGroupName = rdr["PartyName"].ToString(),
                                GrowerName = rdr["GrowerName"].ToString(),
                                ChallanName = rdr["challanname"].ToString(),
                                Vehno = rdr["vehno"].ToString(),
                                CrissueMark = rdr["CrateMark"].ToString(),
                                CrissueQty = Convert.ToDecimal(rdr["qty"]),
                                CrateIssueDated = Convert.ToDateTime(rdr["Dated"]),
                                CrissueFlag = rdr["trflag"].ToString(),
                                CrissueRemarks = rdr["Remarks"].ToString(),
                                CrateCrn = rdr["Trno"].ToString(),
                            };
                            GetDailyCrates.Add(companyModel);
                        }
                    }
                }
            }

            return GetDailyCrates;
        }










        public async Task<List<CompanyModel>> Generateoutwardpanel(CompanyModel EditModel,int unit)
        {
            List<CompanyModel> GetPackingStock = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Build the dynamic WHERE clause based on filter values
                var whereConditions = new List<string>();
                var parameters = new List<SqlParameter>();

                whereConditions.Add("ci.flagdeleted = 0");
                if (unit > 0)
                {
                    whereConditions.Add("ci.unitid = @UnitId");
                    parameters.Add(new SqlParameter("@UnitId", unit));
                }
                // Date range filter
                if (EditModel.OutwardDatefrom != null && EditModel.OutwardDateto != null)
                {
                    whereConditions.Add("ci.OutwardDate BETWEEN @d1 AND @d2");
                    parameters.Add(new SqlParameter("@d1", EditModel.OutwardDatefrom));
                    parameters.Add(new SqlParameter("@d2", EditModel.OutwardDateto));
                }
                else if (EditModel.OutwardDatefrom != null)
                {
                    whereConditions.Add("ci.OutwardDate >= @d1");
                    parameters.Add(new SqlParameter("@d1", EditModel.OutwardDatefrom));
                }
                else if (EditModel.OutwardDateto != null)
                {
                    whereConditions.Add("ci.OutwardDate <= @d2");
                    parameters.Add(new SqlParameter("@d2", EditModel.OutwardDateto));
                }

                // Party ID filter
                if (EditModel.Partyid > 0)
                {
                    whereConditions.Add("ci.partyid = @Partyid");
                    parameters.Add(new SqlParameter("@Partyid", EditModel.Partyid));
                }

                // Grower ID filter
                if (EditModel.Growerid > 0)
                {
                    whereConditions.Add("ci.groowerid = @Groowerid");
                    parameters.Add(new SqlParameter("@Groowerid", EditModel.Growerid));
                }

               
                if (!string.IsNullOrWhiteSpace(EditModel.OutwardStatus))
                {
                    whereConditions.Add("ci.approved = @cratemark");
                    parameters.Add(new SqlParameter("@cratemark", EditModel.OutwardStatus));
                }
                else
                {
                    // When CrissueMark is NULL, don't filter by it (return all records for this field)
                    whereConditions.Add("(ci.approved IS NOT NULL OR ci.approved IS NULL)");
                }

                // Transaction Flag filter - Handle NULL values
                if (!string.IsNullOrWhiteSpace(EditModel.Outwardtype))
                {
                    whereConditions.Add("ci.outwardtype = @trflag");
                    parameters.Add(new SqlParameter("@trflag", EditModel.Outwardtype));
                }
                else
                {
                    // When CrissueFlag is NULL, don't filter by it
                    whereConditions.Add("(ci.outwardtype IS NOT NULL OR ci.outwardtype IS NULL)");
                }

                if (!string.IsNullOrWhiteSpace(EditModel.OutwardIrn))
                {
                    whereConditions.Add("ci.outwardirn = @out");
                    parameters.Add(new SqlParameter("@out", EditModel.OutwardIrn));
                }
                else
                {
                    // When CrissueFlag is NULL, don't filter by it
                    whereConditions.Add("(ci.outwardirn IS NOT NULL OR ci.outwardirn IS NULL)");
                }

                if (!string.IsNullOrWhiteSpace(EditModel.PackingOrderIrn))
                {
                    whereConditions.Add("ci.PackingOrderIrn = @packorder");
                    parameters.Add(new SqlParameter("@packorder", EditModel.PackingOrderIrn));
                }
                else
                {
                    // When CrissueFlag is NULL, don't filter by it
                    whereConditions.Add("(ci.PackingOrderIrn IS NOT NULL OR ci.PackingOrderIrn IS NULL)");
                }




                string whereClause = string.Join(" AND ", whereConditions);

                string query = $@"
     SELECT ci.outwardid,
      ci.outwardirn,
      ci.packingorderirn,
      ci.OutwardDate,
      p.partytypeid + '-' + p.partyname AS PartyName,
    
     sum( ci.qty) as Qty,
	      CONVERT(VARCHAR(MAX), ps.partyid) + '-' + ps.partyname AS GrowerName,
		  vi.vehno,ci.approved

  FROM outward ci
  LEFT JOIN party p ON ci.partyid = p.partyid
  LEFT JOIN partysub ps ON ci.growerid = ps.partyid
      
  LEFT JOIN vehinfo vi ON ci.vehid = vi.vid

   WHERE {whereClause}

  group by   ci.packingorderirn,
      ci.OutwardDate,
      p.partytypeid + '-' + p.partyname , CONVERT(VARCHAR(MAX), ps.partyid) + '-' + ps.partyname,  vi.vehno,ci.approved,ci.outwardirn,ci.outwardid
    
  ORDER BY ci.outwardid desc";

                using (SqlCommand cmd = new SqlCommand(query, con))
                {
                    cmd.CommandType = CommandType.Text;

                    // Add all parameters to the command
                    foreach (var param in parameters)
                    {
                        cmd.Parameters.Add(param);
                    }

                    using (SqlDataReader rdr = await cmd.ExecuteReaderAsync())
                    {
                        while (await rdr.ReadAsync())
                        {
                            CompanyModel companyModel = new CompanyModel
                            {
                                Outwardno = Convert.ToInt32(rdr["outwardid"]),
                                OutwardIrn = rdr["outwardirn"].ToString(),
                                PackingOrderIrn = rdr["packingorderirn"].ToString(),
                                OutwardGrowerGroup = rdr["PartyName"].ToString(),
                                Vehno = rdr["vehno"].ToString(),
                                OutwardGrowerName = rdr["GrowerName"].ToString(),
                                OutwardQty = Convert.ToInt32(rdr["Qty"]),

                                OutwardDate = Convert.ToDateTime(rdr["OutwardDate"]),
                                OutwardStatus = rdr["approved"].ToString()
                              
                            };
                            GetPackingStock.Add(companyModel);
                        }
                    }
                }
            }

            return GetPackingStock;
        }









        public async Task<List<CompanyModel>> GenerateoutwardpanelDel(CompanyModel EditModel, int unit)
        {
            List<CompanyModel> GetPackingStock = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Build the dynamic WHERE clause based on filter values
                var whereConditions = new List<string>();
                var parameters = new List<SqlParameter>();

                whereConditions.Add("ci.flagdeleted = 1");
                if (unit > 0)
                {
                    whereConditions.Add("ci.unitid = @UnitId");
                    parameters.Add(new SqlParameter("@UnitId", unit));
                }
                // Date range filter
                if (EditModel.OutwardDatefrom != null && EditModel.OutwardDateto != null)
                {
                    whereConditions.Add("ci.OutwardDate BETWEEN @d1 AND @d2");
                    parameters.Add(new SqlParameter("@d1", EditModel.OutwardDatefrom));
                    parameters.Add(new SqlParameter("@d2", EditModel.OutwardDateto));
                }
                else if (EditModel.OutwardDatefrom != null)
                {
                    whereConditions.Add("ci.OutwardDate >= @d1");
                    parameters.Add(new SqlParameter("@d1", EditModel.OutwardDatefrom));
                }
                else if (EditModel.OutwardDateto != null)
                {
                    whereConditions.Add("ci.OutwardDate <= @d2");
                    parameters.Add(new SqlParameter("@d2", EditModel.OutwardDateto));
                }

                // Party ID filter
                if (EditModel.Partyid > 0)
                {
                    whereConditions.Add("ci.partyid = @Partyid");
                    parameters.Add(new SqlParameter("@Partyid", EditModel.Partyid));
                }

                // Grower ID filter
                if (EditModel.Growerid > 0)
                {
                    whereConditions.Add("ci.groowerid = @Groowerid");
                    parameters.Add(new SqlParameter("@Groowerid", EditModel.Growerid));
                }


                if (!string.IsNullOrWhiteSpace(EditModel.OutwardStatus))
                {
                    whereConditions.Add("ci.approved = @cratemark");
                    parameters.Add(new SqlParameter("@cratemark", EditModel.OutwardStatus));
                }
                else
                {
                    // When CrissueMark is NULL, don't filter by it (return all records for this field)
                    whereConditions.Add("(ci.approved IS NOT NULL OR ci.approved IS NULL)");
                }

                // Transaction Flag filter - Handle NULL values
                if (!string.IsNullOrWhiteSpace(EditModel.Outwardtype))
                {
                    whereConditions.Add("ci.outwardtype = @trflag");
                    parameters.Add(new SqlParameter("@trflag", EditModel.Outwardtype));
                }
                else
                {
                    // When CrissueFlag is NULL, don't filter by it
                    whereConditions.Add("(ci.outwardtype IS NOT NULL OR ci.outwardtype IS NULL)");
                }

                if (!string.IsNullOrWhiteSpace(EditModel.OutwardIrn))
                {
                    whereConditions.Add("ci.outwardirn = @out");
                    parameters.Add(new SqlParameter("@out", EditModel.OutwardIrn));
                }
                else
                {
                    // When CrissueFlag is NULL, don't filter by it
                    whereConditions.Add("(ci.outwardirn IS NOT NULL OR ci.outwardirn IS NULL)");
                }

                if (!string.IsNullOrWhiteSpace(EditModel.PackingOrderIrn))
                {
                    whereConditions.Add("ci.PackingOrderIrn = @packorder");
                    parameters.Add(new SqlParameter("@packorder", EditModel.PackingOrderIrn));
                }
                else
                {
                    // When CrissueFlag is NULL, don't filter by it
                    whereConditions.Add("(ci.PackingOrderIrn IS NOT NULL OR ci.PackingOrderIrn IS NULL)");
                }




                string whereClause = string.Join(" AND ", whereConditions);

                string query = $@"
     SELECT ci.outwardid,
      ci.outwardirn,
      ci.packingorderirn,
      ci.OutwardDate,
      p.partytypeid + '-' + p.partyname AS PartyName,
    
     sum( ci.qty) as Qty,
	      CONVERT(VARCHAR(MAX), ps.partyid) + '-' + ps.partyname AS GrowerName,
		  vi.vehno,ci.approved

  FROM outward ci
  LEFT JOIN party p ON ci.partyid = p.partyid
  LEFT JOIN partysub ps ON ci.growerid = ps.partyid
      
  LEFT JOIN vehinfo vi ON ci.vehid = vi.vid

   WHERE {whereClause}

  group by   ci.packingorderirn,
      ci.OutwardDate,
      p.partytypeid + '-' + p.partyname , CONVERT(VARCHAR(MAX), ps.partyid) + '-' + ps.partyname,  vi.vehno,ci.approved,ci.outwardirn,ci.outwardid
    
  ORDER BY ci.outwardirn desc";

                using (SqlCommand cmd = new SqlCommand(query, con))
                {
                    cmd.CommandType = CommandType.Text;

                    // Add all parameters to the command
                    foreach (var param in parameters)
                    {
                        cmd.Parameters.Add(param);
                    }

                    using (SqlDataReader rdr = await cmd.ExecuteReaderAsync())
                    {
                        while (await rdr.ReadAsync())
                        {
                            CompanyModel companyModel = new CompanyModel
                            {
                                Outwardno = Convert.ToInt32(rdr["outwardid"]),
                                OutwardIrn = rdr["outwardirn"].ToString(),
                                PackingOrderIrn = rdr["packingorderirn"].ToString(),
                                OutwardGrowerGroup = rdr["PartyName"].ToString(),
                                Vehno = rdr["vehno"].ToString(),
                                OutwardGrowerName = rdr["GrowerName"].ToString(),
                                OutwardQty = Convert.ToInt32(rdr["Qty"]),

                                OutwardDate = Convert.ToDateTime(rdr["OutwardDate"]),
                                OutwardStatus = rdr["approved"].ToString()

                            };
                            GetPackingStock.Add(companyModel);
                        }
                    }
                }
            }

            return GetPackingStock;
        }
































        public async Task<List<CompanyModel>> generateCrateReportBack(CompanyModel EditModel)
        {
            List<CompanyModel> Growerslots = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Build the dynamic WHERE clause based on filter values
                var whereConditions = new List<string>();
                var parameters = new List<SqlParameter>();

                whereConditions.Add("ci.flagdeleted = 0");

                // Date range filter
                if (EditModel.PreinwardDate != null && EditModel.PreinwardDateTo != null)
                {
                    whereConditions.Add("ci.GateInDate BETWEEN @d1 AND @d2");
                    parameters.Add(new SqlParameter("@d1", EditModel.PreinwardDate));
                    parameters.Add(new SqlParameter("@d2", EditModel.PreinwardDateTo));
                }
                else if (EditModel.PreinwardDate != null)
                {
                    whereConditions.Add("ci.PreinwardDate >= @d1");
                    parameters.Add(new SqlParameter("@d1", EditModel.PreinwardDate));
                }
                else if (EditModel.PreinwardDateTo != null)
                {
                    whereConditions.Add("ci.GateInDate <= @d2");
                    parameters.Add(new SqlParameter("@d2", EditModel.PreinwardDateTo));
                }

                // Party ID filter
                if (EditModel.Partyid > 0)
                {
                    whereConditions.Add("ci.partyid = @Partyid");
                    parameters.Add(new SqlParameter("@Partyid", EditModel.Partyid));
                }

                // Grower ID filter
                if (EditModel.Growerid > 0)
                {
                    whereConditions.Add("ci.groowerid = @Groowerid");
                    parameters.Add(new SqlParameter("@Groowerid", EditModel.Growerid));
                }

                // Challan ID filter
              

                // Crate Mark filter - Handle NULL values
                if (!string.IsNullOrWhiteSpace(EditModel.Itemname))
                {
                    whereConditions.Add("ci.itemname = @itemname");
                    parameters.Add(new SqlParameter("@itemname", EditModel.Itemname));
                }
                else
                {
                    // When CrissueMark is NULL, don't filter by it (return all records for this field)
                    whereConditions.Add("(ci.Itemname IS NOT NULL OR ci.Itemname IS NULL)");
                }

                // Transaction Flag filter - Handle NULL values
                if (!string.IsNullOrWhiteSpace(EditModel.vehname))
                {
                    whereConditions.Add("ci.trflag = @trflag");
                    parameters.Add(new SqlParameter("@trflag", EditModel.CrissueFlag));
                }
                else
                {
                    // When CrissueFlag is NULL, don't filter by it
                    whereConditions.Add("(ci.trflag IS NOT NULL OR ci.trflag IS NULL)");
                }

                // Vehicle Name filter - Handle NULL values
                if (!string.IsNullOrWhiteSpace(EditModel.Vehno))
                {
                    whereConditions.Add("vi.vehno LIKE '%' + @vehname + '%'");
                    parameters.Add(new SqlParameter("@vehname", EditModel.Vehno));
                }
                else
                {
                    // When Vehno is NULL, don't filter by it
                    whereConditions.Add("(vi.vehno IS NOT NULL OR vi.vehno IS NULL)");
                }

                // Build the final query
                string whereClause = string.Join(" AND ", whereConditions);

                string query = $@"
    SELECT
        ci.cid,
        ci.Trno,
        ci.Dated,
        p.partytypeid + '-' + p.partyname AS PartyName,
        CONVERT(VARCHAR(MAX), ps.partyid) + '-' + ps.partyname AS GrowerName,
        CONVERT(VARCHAR(MAX), cm.id) + '-' + cm.ChallanName as ChallanName,
        RTRIM(vi.vehno) + SPACE(1) + '(' + RTRIM(vi.drivername) + SPACE(1) + ')' + SPACE(1) + '(' + RTRIM(vi.contactno) + ')' as vehno,
        ci.CrateMark,
        ci.qty,
        ci.trflag,
        ci.Remarks
    FROM CrateIssue ci
    LEFT JOIN party p ON ci.partyid = p.partyid
    LEFT JOIN partysub ps ON ci.groowerid = ps.partyid
    LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
    LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
    WHERE {whereClause}
    ORDER BY ci.cid";

                using (SqlCommand cmd = new SqlCommand(query, con))
                {
                    cmd.CommandType = CommandType.Text;

                    // Add all parameters to the command
                    foreach (var param in parameters)
                    {
                        cmd.Parameters.Add(param);
                    }

                    using (SqlDataReader rdr = await cmd.ExecuteReaderAsync())
                    {
                        while (await rdr.ReadAsync())
                        {
                            CompanyModel companyModel = new CompanyModel
                            {
                                CrissueId = Convert.ToInt32(rdr["cid"]),
                                GrowerGroupName = rdr["PartyName"].ToString(),
                                GrowerName = rdr["GrowerName"].ToString(),
                                ChallanName = rdr["challanname"].ToString(),
                                Vehno = rdr["vehno"].ToString(),
                                CrissueMark = rdr["CrateMark"].ToString(),
                                CrissueQty = Convert.ToDecimal(rdr["qty"]),
                                CrateIssueDated = Convert.ToDateTime(rdr["Dated"]),
                                CrissueFlag = rdr["trflag"].ToString(),
                                CrissueRemarks = rdr["Remarks"].ToString(),
                                CrateCrn = rdr["Trno"].ToString(),
                            };
                            Growerslots.Add(companyModel);
                        }
                    }
                }
            }

            return Growerslots;
        }

        public async Task<CompanyModel?> generateCrateReportpdf(CompanyModel EditModel)
        {
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();
                var whereConditions = new List<string>();
                var parameters = new List<SqlParameter>();

                whereConditions.Add("ci.flagdeleted = 0");

                // Date range filter
                if (EditModel.CrateDatefrom != null && EditModel.CrateDateto != null)
                {
                    whereConditions.Add("ci.Dated BETWEEN @d1 AND @d2");
                    parameters.Add(new SqlParameter("@d1", EditModel.CrateDatefrom));
                    parameters.Add(new SqlParameter("@d2", EditModel.CrateDateto));
                }
                else if (EditModel.CrateDatefrom != null)
                {
                    whereConditions.Add("ci.Dated >= @d1");
                    parameters.Add(new SqlParameter("@d1", EditModel.CrateDatefrom));
                }
                else if (EditModel.CrateDateto != null)
                {
                    whereConditions.Add("ci.Dated <= @d2");
                    parameters.Add(new SqlParameter("@d2", EditModel.CrateDateto));
                }

                // Party ID filter
                if (EditModel.Partyid > 0)
                {
                    whereConditions.Add("ci.partyid = @Partyid");
                    parameters.Add(new SqlParameter("@Partyid", EditModel.Partyid));
                }

                // Grower ID filter
                if (EditModel.Growerid > 0)
                {
                    whereConditions.Add("ci.groowerid = @Groowerid");
                    parameters.Add(new SqlParameter("@Groowerid", EditModel.Growerid));
                }

                // Challan ID filter
                if (EditModel.ChallanId > 0)
                {
                    whereConditions.Add("ci.challanid = @challanId");
                    parameters.Add(new SqlParameter("@challanId", EditModel.ChallanId));
                }

                // Crate Mark filter - Handle NULL values
                if (!string.IsNullOrWhiteSpace(EditModel.CrissueMark))
                {
                    whereConditions.Add("ci.CrateMark = @cratemark");
                    parameters.Add(new SqlParameter("@cratemark", EditModel.CrissueMark));
                }
                else
                {
                    // When CrissueMark is NULL, don't filter by it (return all records for this field)
                    whereConditions.Add("(ci.CrateMark IS NOT NULL OR ci.CrateMark IS NULL)");
                }

                // Transaction Flag filter - Handle NULL values
                if (!string.IsNullOrWhiteSpace(EditModel.CrissueFlag))
                {
                    whereConditions.Add("ci.trflag = @trflag");
                    parameters.Add(new SqlParameter("@trflag", EditModel.CrissueFlag));
                }
                else
                {
                    // When CrissueFlag is NULL, don't filter by it
                    whereConditions.Add("(ci.trflag IS NOT NULL OR ci.trflag IS NULL)");
                }

                // Vehicle Name filter - Handle NULL values
                if (!string.IsNullOrWhiteSpace(EditModel.Vehno))
                {
                    whereConditions.Add("vi.vehno LIKE '%' + @vehname + '%'");
                    parameters.Add(new SqlParameter("@vehname", EditModel.Vehno));
                }
                else
                {
                    // When Vehno is NULL, don't filter by it
                    whereConditions.Add("(vi.vehno IS NOT NULL OR vi.vehno IS NULL)");
                }

                // Build the final query
                string whereClause = string.Join(" AND ", whereConditions);

                // Delete existing data
                using (SqlCommand cmd2 = new SqlCommand($@"DELETE FROM crateissuereports", con))
                {
                    cmd2.CommandType = CommandType.Text;
                    await cmd2.ExecuteNonQueryAsync();
                }

                // Insert new data WITH PARAMETERS
                using (SqlCommand cmd = new SqlCommand($@"
INSERT INTO crateissuereports(cid, Trno, Dated, PartyName, GrowerName, ChallanName, vehid, vehname,CrateMark, qty, trflag, Remarks, cidval)
SELECT
    ci.cid,
    ci.Trno,
    ci.Dated,
    p.partytypeid + '-' + p.partyname AS PartyName,
    CONVERT(VARCHAR(MAX), ps.partyid) + '-' + ps.partyname AS GrowerName,
    CONVERT(VARCHAR(MAX), cm.id) + '-' + cm.ChallanName as ChallanName,
    ci.vehid,
    RTRIM(vi.vehno) + SPACE(1) + '(' + RTRIM(vi.drivername) + SPACE(1) + ')' + SPACE(1) + '(' + RTRIM(vi.contactno) + ')' as vehno,
    ci.CrateMark,
    ci.qty,
    ci.trflag,
    ci.Remarks,
    1
FROM CrateIssue ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.groowerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
WHERE {whereClause}
ORDER BY ci.cid", con))
                {
                    cmd.CommandType = CommandType.Text;

                    // ADD ALL PARAMETERS TO THE COMMAND - THIS WAS MISSING
                    foreach (var param in parameters)
                    {
                        cmd.Parameters.Add(new SqlParameter(param.ParameterName, param.Value ?? DBNull.Value));
                    }

                    await cmd.ExecuteNonQueryAsync();
                }

                con.Close();
                return EditModel;
            }
        }





    



        //            public async Task<List<CompanyModel>> generateCrateReportpdf(CompanyModel EditModel)
        //    {
        //        List<CompanyModel> GetDailyCrates = new List<CompanyModel>();

        //        using (SqlConnection con = new SqlConnection(_configuration.Value))
        //        {
        //            await con.OpenAsync();

        //            // Build the dynamic WHERE clause based on filter values
        //            var whereConditions = new List<string>();
        //            var parameters = new List<SqlParameter>();

        //            whereConditions.Add("ci.flagdeleted = 0");

        //            // Date range filter
        //            if (EditModel.CrateDatefrom != null && EditModel.CrateDateto != null)
        //            {
        //                whereConditions.Add("ci.Dated BETWEEN @d1 AND @d2");
        //                parameters.Add(new SqlParameter("@d1", EditModel.CrateDatefrom));
        //                parameters.Add(new SqlParameter("@d2", EditModel.CrateDateto));
        //            }
        //            else if (EditModel.CrateDatefrom != null)
        //            {
        //                whereConditions.Add("ci.Dated >= @d1");
        //                parameters.Add(new SqlParameter("@d1", EditModel.CrateDatefrom));
        //            }
        //            else if (EditModel.CrateDateto != null)
        //            {
        //                whereConditions.Add("ci.Dated <= @d2");
        //                parameters.Add(new SqlParameter("@d2", EditModel.CrateDateto));
        //            }

        //            // Party ID filter
        //            if (EditModel.Partyid > 0)
        //            {
        //                whereConditions.Add("ci.partyid = @Partyid");
        //                parameters.Add(new SqlParameter("@Partyid", EditModel.Partyid));
        //            }

        //            // Grower ID filter
        //            if (EditModel.Growerid > 0)
        //            {
        //                whereConditions.Add("ci.groowerid = @Groowerid");
        //                parameters.Add(new SqlParameter("@Groowerid", EditModel.Growerid));
        //            }

        //            // Challan ID filter
        //            if (EditModel.ChallanId > 0)
        //            {
        //                whereConditions.Add("ci.challanid = @challanId");
        //                parameters.Add(new SqlParameter("@challanId", EditModel.ChallanId));
        //            }

        //            // Crate Mark filter - Handle NULL values
        //            if (!string.IsNullOrWhiteSpace(EditModel.CrissueMark))
        //            {
        //                whereConditions.Add("ci.CrateMark = @cratemark");
        //                parameters.Add(new SqlParameter("@cratemark", EditModel.CrissueMark));
        //            }
        //            else
        //            {
        //                // When CrissueMark is NULL, don't filter by it (return all records for this field)
        //                whereConditions.Add("(ci.CrateMark IS NOT NULL OR ci.CrateMark IS NULL)");
        //            }

        //            // Transaction Flag filter - Handle NULL values
        //            if (!string.IsNullOrWhiteSpace(EditModel.CrissueFlag))
        //            {
        //                whereConditions.Add("ci.trflag = @trflag");
        //                parameters.Add(new SqlParameter("@trflag", EditModel.CrissueFlag));
        //            }
        //            else
        //            {
        //                // When CrissueFlag is NULL, don't filter by it
        //                whereConditions.Add("(ci.trflag IS NOT NULL OR ci.trflag IS NULL)");
        //            }

        //            // Vehicle Name filter - Handle NULL values
        //            if (!string.IsNullOrWhiteSpace(EditModel.Vehno))
        //            {
        //                whereConditions.Add("vi.vehno LIKE '%' + @vehname + '%'");
        //                parameters.Add(new SqlParameter("@vehname", EditModel.Vehno));
        //            }
        //            else
        //            {
        //                // When Vehno is NULL, don't filter by it
        //                whereConditions.Add("(vi.vehno IS NOT NULL OR vi.vehno IS NULL)");
        //            }

        //            // Build the final query
        //            string whereClause = string.Join(" AND ", whereConditions);

        //            string query = $@"
        //SELECT
        //    ci.cid,
        //    ci.Trno,
        //    ci.Dated,
        //    p.partytypeid + '-' + p.partyname AS PartyName,
        //    CONVERT(VARCHAR(MAX), ps.partyid) + '-' + ps.partyname AS GrowerName,
        //    CONVERT(VARCHAR(MAX), cm.id) + '-' + cm.ChallanName as ChallanName,
        //    RTRIM(vi.vehno) + SPACE(1) + '(' + RTRIM(vi.drivername) + SPACE(1) + ')' + SPACE(1) + '(' + RTRIM(vi.contactno) + ')' as vehno,
        //    ci.CrateMark,
        //    ci.qty,
        //    ci.trflag,
        //    ci.Remarks
        //FROM CrateIssue ci
        //LEFT JOIN party p ON ci.partyid = p.partyid
        //LEFT JOIN partysub ps ON ci.groowerid = ps.partyid
        //LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
        //LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
        //WHERE {whereClause}
        //ORDER BY ci.cid";

        //            using (SqlCommand cmd = new SqlCommand(query, con))
        //            {
        //                cmd.CommandType = CommandType.Text;

        //                // Add all parameters to the command
        //                foreach (var param in parameters)
        //                {
        //                    cmd.Parameters.Add(param);
        //                }

        //                using (SqlDataReader rdr = await cmd.ExecuteReaderAsync())
        //                {
        //                    while (await rdr.ReadAsync())
        //                    {
        //                        CompanyModel companyModel = new CompanyModel
        //                        {
        //                            CrissueId = Convert.ToInt32(rdr["cid"]),
        //                            GrowerGroupName = rdr["PartyName"].ToString(),
        //                            GrowerName = rdr["GrowerName"].ToString(),
        //                            ChallanName = rdr["challanname"].ToString(),
        //                            Vehno = rdr["vehno"].ToString(),
        //                            CrissueMark = rdr["CrateMark"].ToString(),
        //                            CrissueQty = Convert.ToDecimal(rdr["qty"]),
        //                            CrateIssueDated = Convert.ToDateTime(rdr["Dated"]),
        //                            CrissueFlag = rdr["trflag"].ToString(),
        //                            CrissueRemarks = rdr["Remarks"].ToString(),
        //                            CrateCrn = rdr["Trno"].ToString(),
        //                        };
        //                        GetDailyCrates.Add(companyModel);
        //                    }
        //                }
        //            }
        //        }

        //        return GetDailyCrates;
        //    }

        public async Task<List<CompanyModel>> generateCrateReportdel(CompanyModel EditModel)

        {
            List<CompanyModel> GetDailyCrates = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("generateCrateReportdel", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;
                    cmd3.Parameters.AddWithValue("@d1", EditModel.CrateDatefrom);
                    cmd3.Parameters.AddWithValue("@d2", EditModel.CrateDateto);
                    cmd3.Parameters.AddWithValue("@Partyid", EditModel.Partyid);
                    cmd3.Parameters.AddWithValue("@Groowerid", EditModel.Growerid);
                    cmd3.Parameters.AddWithValue("@challanId", EditModel.ChallanId);
                    cmd3.Parameters.AddWithValue("@cratemark", EditModel.CrissueMark);
                    cmd3.Parameters.AddWithValue("@vehid", 0);
                    cmd3.Parameters.AddWithValue("@trflag", EditModel.CrissueFlag);
                    cmd3.Parameters.AddWithValue("@vehname", EditModel.Vehno);




                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"SELECT
    ci.cid,
ci.Trno,

    ci.Dated,
	p.partytypeid  +'-'+ p.partyname AS PartyName,
 convert(varchar(max),ps.partyid)  +'-'+ ps.partyname AS GrowerName,
    convert(varchar(max),cm.id)  +'-'+ cm.ChallanName as ChallanName,
     rtrim(vi.vehno) + space(1)+'('+ rtrim(vi.drivername)+space(1)+')'+space(1)+'('+rtrim(vi.contactno)+')' as vehno,


	ci.CrateMark,
    ci.qty,
    ci.trflag,
ci.Remarks
FROM CrateIssuereports ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.groowerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
WHERE   ci.flagdeleted=1 order by ci.cid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        CrissueId = Convert.ToInt32(rdr["cid"]),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                        ChallanName = rdr["challanname"].ToString(),
                        Vehno = rdr["vehno"].ToString(),
                        CrissueMark = rdr["CrateMark"].ToString(),
                        CrissueQty = Convert.ToDecimal(rdr["qty"]),
                        CrateIssueDated = Convert.ToDateTime(rdr["Dated"]),
                        CrissueFlag = rdr["trflag"].ToString(),
                        CrissueRemarks = rdr["Remarks"].ToString(),
                        CrateCrn = rdr["Trno"].ToString(),




                    };
                    GetDailyCrates.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyCrates;
        }


        public async Task<List<CompanyModel>> generatePreinwardReport(CompanyModel EditModel)
        {
            List<CompanyModel> GetDailyCrates = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("generatePreinwardReport", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;
                    cmd3.Parameters.AddWithValue("@d1", EditModel.PreinwardDate);
                    cmd3.Parameters.AddWithValue("@d2", EditModel.PreinwardDateTo);
                    cmd3.Parameters.AddWithValue("@Partyid", EditModel.Partyid);
                    cmd3.Parameters.AddWithValue("@Groowerid", EditModel.Growerid);

                    cmd3.Parameters.AddWithValue("@vehname", EditModel.Vehno);
                    cmd3.Parameters.AddWithValue("@itemname", EditModel.ItemName);

                    cmd3.Parameters.AddWithValue("@uom", EditModel.PreInwardUom);
                    cmd3.Parameters.AddWithValue("@stat", EditModel.PreInwardStatus);
                    cmd3.Parameters.AddWithValue("@vehid", 0);
                    cmd3.Parameters.AddWithValue("@itemid", 0);
                    cmd3.Parameters.AddWithValue("@uomid", 0);
                    
                     cmd3.Parameters.AddWithValue("@SearchText", EditModel.CommonSearch);
        


                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"SELECT
    ci.cid,
ci.Trno,

    ci.Dated,
	p.partytypeid  +'-'+ p.partyname AS PartyName,
 convert(varchar(max),ps.partyid)  +'-'+ ps.partyname AS GrowerName,
    convert(varchar(max),cm.id)  +'-'+ cm.ChallanName as ChallanName,
     rtrim(vi.vehno) + space(1)+'('+ rtrim(vi.drivername)+space(1)+')'+space(1)+'('+rtrim(vi.contactno)+')' as vehno,


	ci.CrateMark,
    ci.qty,
    ci.trflag,
ci.Remarks
FROM CrateIssuereports ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.groowerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
WHERE   ci.flagdeleted=0 order by ci.cid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        //CrissueId = Convert.ToInt32(rdr["cid"]),
                        //GrowerGroupName = rdr["PartyName"].ToString(),
                        //GrowerName = rdr["GrowerName"].ToString(),
                        //ChallanName = rdr["challanname"].ToString(),
                        //Vehno = rdr["vehno"].ToString(),
                        //CrissueMark = rdr["CrateMark"].ToString(),
                        //CrissueQty = Convert.ToDecimal(rdr["qty"]),
                        //CrateIssueDated = Convert.ToDateTime(rdr["Dated"]),
                        //CrissueFlag = rdr["trflag"].ToString(),
                        //CrissueRemarks = rdr["Remarks"].ToString(),
                        //CrateCrn = rdr["Trno"].ToString(),




                    };
                    GetDailyCrates.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyCrates;
        }


        public async Task<List<CompanyModel>> generateinwardReport(CompanyModel EditModel)
        {
            List<CompanyModel> GetDailyCrates = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("generateinwardReport", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;
                    cmd3.Parameters.AddWithValue("@d1", EditModel.PreinwardDate);
                    cmd3.Parameters.AddWithValue("@d2", EditModel.PreinwardDateTo);
                    cmd3.Parameters.AddWithValue("@Partyid", EditModel.Partyid);
                    cmd3.Parameters.AddWithValue("@Groowerid", EditModel.Growerid);

                    cmd3.Parameters.AddWithValue("@vehname", EditModel.Vehno);
                    cmd3.Parameters.AddWithValue("@itemname", EditModel.ItemName);

                    cmd3.Parameters.AddWithValue("@uom", EditModel.PreInwardUom);
                    cmd3.Parameters.AddWithValue("@stat", EditModel.PreInwardStatus);
                    cmd3.Parameters.AddWithValue("@vehid", 0);
                    cmd3.Parameters.AddWithValue("@itemid", 0);
                    cmd3.Parameters.AddWithValue("@uomid", 0);

                    cmd3.Parameters.AddWithValue("@SearchText", EditModel.CommonSearch);
                    cmd3.Parameters.AddWithValue("@Chambername", EditModel.ChamberName);
                    cmd3.Parameters.AddWithValue("@chamberid", 0);



                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"SELECT
    ci.cid,
ci.Trno,

    ci.Dated,
	p.partytypeid  +'-'+ p.partyname AS PartyName,
 convert(varchar(max),ps.partyid)  +'-'+ ps.partyname AS GrowerName,
    convert(varchar(max),cm.id)  +'-'+ cm.ChallanName as ChallanName,
     rtrim(vi.vehno) + space(1)+'('+ rtrim(vi.drivername)+space(1)+')'+space(1)+'('+rtrim(vi.contactno)+')' as vehno,


	ci.CrateMark,
    ci.qty,
    ci.trflag,
ci.Remarks
FROM CrateIssuereports ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.groowerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
WHERE   ci.flagdeleted=0 order by ci.cid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        //CrissueId = Convert.ToInt32(rdr["cid"]),
                        //GrowerGroupName = rdr["PartyName"].ToString(),
                        //GrowerName = rdr["GrowerName"].ToString(),
                        //ChallanName = rdr["challanname"].ToString(),
                        //Vehno = rdr["vehno"].ToString(),
                        //CrissueMark = rdr["CrateMark"].ToString(),
                        //CrissueQty = Convert.ToDecimal(rdr["qty"]),
                        //CrateIssueDated = Convert.ToDateTime(rdr["Dated"]),
                        //CrissueFlag = rdr["trflag"].ToString(),
                        //CrissueRemarks = rdr["Remarks"].ToString(),
                        //CrateCrn = rdr["Trno"].ToString(),




                    };
                    GetDailyCrates.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyCrates;
        }












































        public async Task<List<CompanyModel>> DraftStockReport()
        {
            List<CompanyModel> DraftStock = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT G.DRAFTID,cp.cname,g.packinglotprefix, ps.partytypeid + '-' + ps.partyname AS PartyName,g.endeffdt,
    g.PackingDraftitemid,
    g.PackingDraftno,
    g.palletno, 
    g.palletIrn,
    pr.itemname,
    rp.recipename,
    ig.Gradename,
    g.Qty as TotalQty,
    COALESCE(po.allocated_qty, 0) as AllocatedQty,
    (g.Qty - COALESCE(po.allocated_qty, 0)) as AvailableQty,
    g.marka,
    pq.name as BrandName,
    lf.name as Location
FROM REPACKDRAFTITEMS g
LEFT JOIN party ps on g.lotno = ps.partyid

LEFT JOIN company cp on g.PackingCountId = cp.cid
LEFT JOIN users ur on g.Createdby = ur.userid
LEFT JOIN Recipe rp on g.RecipeId = rp.RecipeId
LEFT JOIN itemgrades ig ON g.gradeid = ig.id
LEFT JOIN prodqaul pq ON g.brandid = pq.id
LEFT JOIN location_master lf ON g.locationid = lf.id
LEFT JOIN purchaseitem Pr ON g.packageid = Pr.id
LEFT JOIN (
    SELECT 
        palletno,
        unitid,
        SUM(Qty) as allocated_qty
    FROM packingorderitems
    WHERE flagdeleted = 0
    GROUP BY palletno, unitid
) po ON g.palletno = po.palletno AND g.unitid = po.unitid
WHERE g.flagdeleted = 0
ORDER BY g.palletno";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        DraftId = rdr.GetInt32(rdr.GetOrdinal("DRAFTID")),
                        cname = rdr["cname"].ToString(),

                    };
                    DraftStock.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return DraftStock;
        }







        public async Task<List<CompanyModel>> generateDemandReport(CompanyModel EditModel,int unit)
        {
            List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("generateDemandReport", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;
                    cmd3.Parameters.AddWithValue("@d1", EditModel.OrderDatefrom);
                    cmd3.Parameters.AddWithValue("@d2", EditModel.OrderDateto);
                    cmd3.Parameters.AddWithValue("@Partyid", EditModel.Partyid);
                    cmd3.Parameters.AddWithValue("@Groowerid", EditModel.Growerid);
                 
                    cmd3.Parameters.AddWithValue("@OrderBy", EditModel.OrderBy);
                  
                    cmd3.Parameters.AddWithValue("@Status", EditModel.DemandStatus);
                    cmd3.Parameters.AddWithValue("@Demandirn", EditModel.DemandIrn);

                    cmd3.Parameters.AddWithValue("@unit", unit);

                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"SELECT
    ci.OutId,
ci.demandirn,ci.orderDate,ci.DeliveryDate,p.partytypeid  +'-'+ p.partyname AS PartyName,

sum(ci.OrderQty) as Qty,

	ci.OrderByName,
   
	ci.otype ,
    ci.DemandStatus 
FROM LotOutTransReport ci
LEFT JOIN party p ON ci.partyid = p.partyid

group by   ci.OutId,ci.demandirn,ci.orderDate,ci.DeliveryDate,p.partytypeid  +'-'+ p.partyname,ci.OrderByName,
   
	ci.otype ,
    ci.DemandStatus order by  ci.OutId desc ";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        DemandNo = Convert.ToInt32(rdr["OutId"]),
                        DemandIrn = rdr["demandirn"].ToString(),
                        OrderDate = Convert.ToDateTime(rdr["orderDate"]),
                        DeliveryDate = Convert.ToDateTime(rdr["orderDate"]),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        OrderQty = Convert.ToInt32(rdr["Qty"]),
                        OrderBy = rdr["OrderByName"].ToString(),
                        OrderType = rdr["otype"].ToString(),
                        DemandStatus = rdr["DemandStatus"].ToString(),




                    };
                    GetDailyPreinward.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinward;
        }

        public async Task<List<CompanyModel>> generateRawCrateReport(CompanyModel EditModel, int unit)
        {
            List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("generateRawCrateReport", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;
                    cmd3.Parameters.AddWithValue("@d1", EditModel.OrderDatefrom);
                    cmd3.Parameters.AddWithValue("@d2", EditModel.OrderDateto);
                    cmd3.Parameters.AddWithValue("@Partyid", EditModel.Partyid);
                    cmd3.Parameters.AddWithValue("@Groowerid", EditModel.Growerid);

                    cmd3.Parameters.AddWithValue("@OrderBy", EditModel.OrderBy);

                    cmd3.Parameters.AddWithValue("@Status", EditModel.DemandStatus);
                    cmd3.Parameters.AddWithValue("@Demandirn", EditModel.DemandIrn);

                    cmd3.Parameters.AddWithValue("@unit", unit);

                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"SELECT
    ci.OutId,
ci.demandirn,ci.orderDate,ci.DeliveryDate,p.partytypeid  +'-'+ p.partyname AS PartyName,
CONVERT(VARCHAR(MAX), ps.partyid) + '-' + ps.partyname as GrowerName,
sum(ci.OrderQty) as Qty,

	ci.OrderByName,
   
	ci.otype ,
    ci.DemandStatus 
FROM TransferOutTransreport ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.ToGrowerId = ps.partyid

group by   ci.OutId,ci.demandirn,ci.orderDate,ci.DeliveryDate,p.partytypeid  +'-'+ p.partyname,ci.OrderByName,ps.partyid , ps.partyname,
   
	ci.otype ,
    ci.DemandStatus order by  ci.OutId desc ";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        DemandNo = Convert.ToInt32(rdr["OutId"]),
                        DemandIrn = rdr["demandirn"].ToString(),
                        OrderDate = Convert.ToDateTime(rdr["orderDate"]),
                        DeliveryDate = Convert.ToDateTime(rdr["orderDate"]),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        OrderQty = Convert.ToInt32(rdr["Qty"]),
                        OrderBy = rdr["OrderByName"].ToString(),
                        TransferType = rdr["otype"].ToString(),
                        DemandStatus = rdr["DemandStatus"].ToString(),
                        TransferTo = rdr["GrowerName"].ToString(),



                    };
                    GetDailyPreinward.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinward;
        }





        public async Task<List<CompanyModel>> generateCompleteDraft(CompanyModel EditModel, int unit)
        {
            List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("generateCompleteDraft", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;
                    cmd3.Parameters.AddWithValue("@d1", EditModel.DraftDatefrom);
                    cmd3.Parameters.AddWithValue("@d2", EditModel.DraftDateTo);
                    cmd3.Parameters.AddWithValue("@Partyid", EditModel.Partyid);
                    cmd3.Parameters.AddWithValue("@DraftIrn", EditModel.DraftIrn);
                    cmd3.Parameters.AddWithValue("@Draftstat", EditModel.Draftstat);

                    cmd3.Parameters.AddWithValue("@unit", unit);

                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"WITH DistinctDrafts AS (
    SELECT  
        draftid, 
        draftirn,
        demandirn, 
        orderqty,
        Draftstat,
        otype,
        CONVERT(varchar(40), draftdate, 104) AS DrafDate,
        partyid,
        growerid
    FROM DraftOutTransReport WHERE flagdeleted=0
),
DistinctDemands AS (
    SELECT 
        draftid, 
        STRING_AGG(demandirn, ', ') AS Demandirn
    FROM (
        SELECT DISTINCT draftid, demandirn
        FROM DistinctDrafts
        WHERE demandirn IS NOT NULL
    ) d
    GROUP BY draftid
),
DistinctGrowers AS (
    SELECT 
        draftid, 
        STRING_AGG(CONVERT(VARCHAR(MAX), partyid) + '-' + partyname, CHAR(13) + CHAR(10)) AS GrowerName
    FROM (
        SELECT DISTINCT dd.draftid, ps.partyid, ps.partyname
        FROM DistinctDrafts dd
        LEFT JOIN partysub ps ON dd.growerid = ps.partyid
        WHERE ps.partyid IS NOT NULL
    ) g
    GROUP BY draftid
),
QtyAggregates AS (
    SELECT draftid,
           SUM(ISNULL(pdi.qty, 0)) AS DanaQty
    FROM RepackDraftItems pdi where flagdeleted=0
    GROUP BY draftid
),
OrderAggregates AS (
    SELECT draftid,
           SUM(orderqty) AS GradingQty
    FROM DistinctDrafts
    GROUP BY draftid
)
SELECT 
    dd.draftid,
    dd.draftirn,
    dd.Draftstat,
    dem.Demandirn,
    isnull( qa.DanaQty,0) as DanaQty,
    oa.GradingQty,
    dd.otype,
    dd.DrafDate,
    p.partytypeid + '-' + p.partyname + ' ' + gr.GrowerName AS GrowerName
FROM (
    SELECT DISTINCT draftid, draftirn, Draftstat, otype, DrafDate, partyid
    FROM DistinctDrafts
) dd
LEFT JOIN DistinctDemands dem ON dd.draftid = dem.draftid
LEFT JOIN DistinctGrowers gr ON dd.draftid = gr.draftid
LEFT JOIN QtyAggregates qa ON dd.draftid = qa.draftid
LEFT JOIN OrderAggregates oa ON dd.draftid = oa.draftid
LEFT JOIN party p ON dd.partyid = p.partyid
ORDER BY dd.draftid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();
                
                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        DraftId = Convert.ToInt32(rdr["draftid"]),
                        DraftIrn = rdr["draftirn"].ToString(),
                       DemandIrn = rdr["Demandirn"].ToString(),
                        PackingDraftDate = rdr["DrafDate"].ToString(),
                        GrowerCombine = rdr["GrowerName"].ToString(),
                        GradingQty = Convert.ToInt32(rdr["GradingQty"]),
                        DanaQty = Convert.ToInt32(rdr["DanaQty"]),

                        OrderType = rdr["otype"].ToString(),
                        Draftstat = rdr["Draftstat"].ToString(),




                    };
                    GetDailyPreinward.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinward;
        }



        public async Task<List<CompanyModel>> generateCompleteDraftOpen(CompanyModel EditModel, int unit)
        {
            List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("generateCompleteDraftOpen", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;
                    cmd3.Parameters.AddWithValue("@d1", EditModel.DraftDatefrom);
                    cmd3.Parameters.AddWithValue("@d2", EditModel.DraftDateTo);
                    cmd3.Parameters.AddWithValue("@Partyid", EditModel.Partyid);
                    cmd3.Parameters.AddWithValue("@DraftIrn", EditModel.DraftIrn);
                    cmd3.Parameters.AddWithValue("@Draftstat", EditModel.Draftstat);

                    cmd3.Parameters.AddWithValue("@unit", unit);

                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"WITH DistinctDrafts AS (
    SELECT  
        draftid, 
        draftirn,
        demandirn, 
        orderqty,
        Draftstat,
        otype,
        CONVERT(varchar(40), draftdate, 104) AS DrafDate,
        partyid,
        growerid
    FROM DraftOutTransReport
),
DistinctDemands AS (
    SELECT 
        draftid, 
        STRING_AGG(demandirn, ', ') AS Demandirn
    FROM (
        SELECT DISTINCT draftid, demandirn
        FROM DistinctDrafts
        WHERE demandirn IS NOT NULL
    ) d
    GROUP BY draftid
),
DistinctGrowers AS (
    SELECT 
        draftid, 
        STRING_AGG(CONVERT(VARCHAR(MAX), partyid) + '-' + partyname, CHAR(13) + CHAR(10)) AS GrowerName
    FROM (
        SELECT DISTINCT dd.draftid, ps.partyid, ps.partyname
        FROM DistinctDrafts dd
        LEFT JOIN partysub ps ON dd.growerid = ps.partyid
        WHERE ps.partyid IS NOT NULL
    ) g
    GROUP BY draftid
),
QtyAggregates AS (
    SELECT draftid,
           SUM(ISNULL(pdi.qty, 0)) AS DanaQty
    FROM RepackDraftItems pdi where flagdeleted=0
    GROUP BY draftid
),
OrderAggregates AS (
    SELECT draftid,
           SUM(orderqty) AS GradingQty
    FROM DistinctDrafts
    GROUP BY draftid
)
SELECT 
    dd.draftid,
    dd.draftirn,
    dd.Draftstat,
    dem.Demandirn,
    isnull( qa.DanaQty,0) as DanaQty,
    oa.GradingQty,
    dd.otype,
    dd.DrafDate,
    p.partytypeid + '-' + p.partyname + ' ' + gr.GrowerName AS GrowerName
FROM (
    SELECT DISTINCT draftid, draftirn, Draftstat, otype, DrafDate, partyid
    FROM DistinctDrafts
) dd
LEFT JOIN DistinctDemands dem ON dd.draftid = dem.draftid
LEFT JOIN DistinctGrowers gr ON dd.draftid = gr.draftid
LEFT JOIN QtyAggregates qa ON dd.draftid = qa.draftid
LEFT JOIN OrderAggregates oa ON dd.draftid = oa.draftid
LEFT JOIN party p ON dd.partyid = p.partyid
ORDER BY dd.draftid desc";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        DraftId = Convert.ToInt32(rdr["draftid"]),
                        DraftIrn = rdr["draftirn"].ToString(),
                        DemandIrn = rdr["Demandirn"].ToString(),
                        PackingDraftDate = rdr["DrafDate"].ToString(),
                        GrowerCombine = rdr["GrowerName"].ToString(),
                        GradingQty = Convert.ToInt32(rdr["GradingQty"]),
                        DanaQty = Convert.ToInt32(rdr["DanaQty"]),

                        OrderType = rdr["otype"].ToString(),
                        Draftstat = rdr["Draftstat"].ToString(),




                    };
                    GetDailyPreinward.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinward;
        }







        public async Task<List<CompanyModel>> generateCompletepackingorderOpen(CompanyModel EditModel, int unit)
        {
            List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("generatepackingorders", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;
                    cmd3.Parameters.AddWithValue("@d1", EditModel.PackingOrderDatefrom);
                    cmd3.Parameters.AddWithValue("@d2", EditModel.PackingOrderDateto);
                    cmd3.Parameters.AddWithValue("@PackingId", EditModel.PackingOrderIrn);
                    cmd3.Parameters.AddWithValue("@DraftIrn", EditModel.DraftIrn);
                    cmd3.Parameters.AddWithValue("@Draftstat", EditModel.PackingOrderStatus);

                    cmd3.Parameters.AddWithValue("@unit", unit);

                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"WITH DistinctDrafts AS (
    SELECT  
        packingorderid,  -- Added packingorderid
        packingorderno,
        draftid, 
        draftirn,
        Vehid,
        qty,
        PackingOrderDate,
        packingorderstat,
        CONVERT(varchar(40), packingorderdate, 104) AS DrafDate,
        partyid,
        growerid,challanid
    FROM PackingOrderItemsreport WHERE flagdeleted=0
),
DistinctDemands AS (
    SELECT 
        packingorderno,
        STRING_AGG(draftirn, ', ') AS DraftIRNs,
        COUNT(DISTINCT draftirn) AS DraftCount
    FROM (
        SELECT DISTINCT packingorderno, draftirn
        FROM DistinctDrafts
        WHERE draftirn IS NOT NULL
    ) d
    GROUP BY packingorderno
),
DistinctGrowers AS (
    SELECT 
        packingorderno,
        STRING_AGG(CONVERT(VARCHAR(MAX), partyid) + '-' + partyname, CHAR(13) + CHAR(10)) AS GrowerName
    FROM (
        SELECT DISTINCT dd.packingorderno, ps.partyid, ps.partyname
        FROM DistinctDrafts dd
        LEFT JOIN partysub ps ON dd.growerid = ps.partyid
        WHERE ps.partyid IS NOT NULL
    ) g
    GROUP BY packingorderno
),
OrderAggregates AS (
    SELECT 
        packingorderno,
        SUM(qty) AS TotalGradingQty
    FROM DistinctDrafts
    GROUP BY packingorderno
)
SELECT 
    dd.packingorderid,  -- Added as first column
    dd.packingorderno,
    dem.DraftIRNs,
    dem.DraftCount,
    dd.packingorderstat,
    dd.PackingOrderDate,
    oa.TotalGradingQty,
    p.partytypeid + '-' + p.partyname AS PartyInfo,
    ps.partytypeid + '-' + ps.partyname AS GrowerInfo,
	cm.ChallanName ,
    vh.vehno
FROM (
    SELECT DISTINCT 
        packingorderid,  -- Added packingorderid
        packingorderno,
        packingorderstat,
        PackingOrderDate, 
        partyid,
        vehid,
        growerid,ChallanId 
    FROM DistinctDrafts
) dd
LEFT JOIN DistinctDemands dem ON dd.packingorderno = dem.packingorderno
LEFT JOIN DistinctGrowers gr ON dd.packingorderno = gr.packingorderno
LEFT JOIN OrderAggregates oa ON dd.packingorderno = oa.packingorderno
LEFT JOIN party p ON dd.partyid = p.partyid
LEFT JOIN partysub ps ON dd.growerid =ps.partyid
LEFT JOIN ChallanMaster cm ON dd.challanid = cm.Id
LEFT JOIN vehinfo vh ON dd.vehid = vh.vid
ORDER BY dd.packingorderno desc";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Packingorderid = Convert.ToInt32(rdr["packingorderid"]),
                        PackingOrderIrn = rdr["packingorderno"].ToString(),
                      DraftIrn = rdr["DraftIRNs"].ToString(),
                        PackingOrderDate = Convert.ToDateTime(rdr["PackingOrderDate"]),
                        PackingOrderStatus =rdr["packingorderstat"].ToString(),
                        selectedPackingQty = Convert.ToInt32(rdr["TotalGradingQty"]),
                        GrowerGroupName = rdr["PartyInfo"].ToString(),
                          GrowerName = rdr["GrowerInfo"].ToString(),
                        ChallanName = rdr["ChallanName"].ToString(),
                        Vehno = rdr["vehno"].ToString(),
                    };
                    GetDailyPreinward.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinward;
        }








        public async Task<List<CompanyModel>> Unitbillingreport(CompanyModel EditModel, int unit)
        {
            List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                
                const string query = @"SELECT i.invoiceno,i.createddate,cm.chambername,
    
    i.InvoiceDate,
	i.InvoicePrefix,i.billtype,
    i.TotalAmt,
    i.CreatedBy,ur.username,
    i.CreatedDate,py.partytypeid  +'-'+ py.partyname as PartyName,convert(varchar(max),ps.partyid)  +'-'+ ps.partyname as GrowerName,
    STRING_AGG(p.DemandIRN, ', ') AS DemandIRNList
FROM InvoiceFinal i
LEFT JOIN ProcessedDemandsmain p 
    ON i.InvoiceNo = p.InvoiceNo 
    AND i.Unitid = p.Unitid
	LEFT JOIN users ur on i.CreatedBy=ur.userid 
	  LEFT JOIN party py ON i.partyid = Py.partyid
   
      LEFT JOIN partysub ps ON i.groupid = Ps.partyid
    LEFT JOIN chamber cm ON i.ChamberId = cm.chamberid
	WHERE i.Unitid = @unitid
GROUP BY 
    i.InvoicePrefix,
    i.InvoiceDate,
    i.TotalAmt,
    i.CreatedBy,
    i.CreatedDate,
    i.InvoiceNo,
    i.Unitid,ur.username,py.partytypeid  +'-'+ py.partyname,convert(varchar(max),ps.partyid)  +'-'+ ps.partyname,cm.chambername,i.billtype
ORDER BY i.InvoiceNo DESC";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@unitid", unit);

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        InvoiceNo = Convert.ToInt32(rdr["invoiceno"]),
                        InvoiceIrn = rdr["InvoicePrefix"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                       Billdate = Convert.ToDateTime(rdr["InvoiceDate"]),
                        BillAmount = Convert.ToDecimal(rdr["TotalAmt"]),
                        BillCreatedate = Convert.ToDateTime(rdr["createddate"]),
                        UserName = rdr["username"].ToString(),
                        ChamberName = rdr["chambername"].ToString(),
                        Billtype = rdr["billtype"].ToString(),

                        DemandIrn = rdr["DemandIRNList"].ToString(),
                     
                    };
                    GetDailyPreinward.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinward;
        }


        public async Task<List<CompanyModel>> UnitGradingBillreport(CompanyModel EditModel, int unit)
        {
            List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {

                const string query = @"select distinct invoiceid,convert(varchar(20),InvoiceDate,104) as InvoiceDate,InvoiceIrn,DRaftirn,convert(varchar(20),ps.partyid)+'-'+ps.partyname as PartyName from GradingPackingFinal Gp

left join party ps
on ps.partyid=gp.Partyid 
where gp.unitid=@unitid
order by invoiceid Desc";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@unitid", unit);

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        InvoiceNo = Convert.ToInt32(rdr["invoiceid"]),
                        InvoiceIrn = rdr["InvoiceIrn"].ToString(),
                        //GrowerGroupName = rdr["PartyName"].ToString(),
                       // Billdate = Convert.ToDateTime(rdr["InvoiceDate"]),
                        ///DraftIrn = rdr["DRaftirn"].ToString(),

                    };
                    GetDailyPreinward.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinward;
        }











        //        public async Task<List<CompanyModel>> GenerateDraftReport(string Dirn)
        //        {
        //            List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();

        //            using (SqlConnection con = new SqlConnection(_configuration.Value))
        //            {
        //                const string query = @"SELECT 
        //    g.LOTNO,g.lotirn,
        //    g.VerifiedQty AS GateInQty,c.partytypeid  +'-'+ c.partyname as PartyName,  CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
        //     COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0) AS TotalOutQty,
        //    (g.VerifiedQty - COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0)) AS BalanceQty,g.verifiedQty ,prt.name as itemname, pt.name as package,g.khataname,pq.name as quality,g.locationchamberid,
        //	isnull(FloorName+space(1)+lf.MatrixName+lf.RowName+space(1)+lf.ColumnName ,'NA') as tlocation,g.locationchamberid as chamber,cm.ChallanName,st.sname
        //FROM GateInTransrep g
        //LEFT JOIN LOTOUTTRANS o ON g.LOTNO = o.LOTNO
        //LEFT JOIN PARTY C ON G.PARTYID = C.PARTYID
        //LEFT JOIN PARTYsub ps ON G.GrowerId = PS.PARTYID
        //LEFT JOIN prodtype prt ON g.itemid = prt.id
        //LEFT JOIN PTYPE pt ON g.packageid = pt.id
        //LEFT JOIN prodqaul pq ON g.varietyid = pq.id
        //LEFT JOIN challanmaster cm ON g.challanid = cm.id  
        //LEFT JOIN servicetypes st ON g.schemeid = st.id
        //LEFT JOIN locationFinal lf ON g.lotno =lf.lotno
        //GROUP BY g.LOTNO, g.VerifiedQty,c.partytypeid  +'-'+ c.partyname,convert(varchar(max),ps.partyid)  +'-'+ ps.partyname,prt.name ,pt.name,g.khataname,pq.name,cm.ChallanName,st.sname,
        //FloorName+space(1)+lf.MatrixName+lf.RowName+space(1)+lf.ColumnName,g.locationchamberid,g.lotirn
        //having  (g.VerifiedQty - COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0)) >0
        //ORDER BY g.LOTNO";
        //                SqlCommand cmd = new SqlCommand(query, con)
        //                {
        //                    CommandType = CommandType.Text


        //            };
        //                cmd.Parameters.AddWithValue("@Dirn", Dirn);

        //                con.Open();

        //                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

        //                while (rdr.Read())
        //                {
        //                    CompanyModel companyModel = new CompanyModel
        //                    {
        //                        Lotno = Convert.ToInt32(rdr["LOTNO"]),
        //                        LotIrn = rdr["lotirn"].ToString(),
        //                        GrowerGroupName = rdr["PartyName"].ToString(),

        //                        GrowerCombine = rdr["PartyName"].ToString() + " " + rdr["GrowerName"].ToString(),
        //                        VerfiedQty = Convert.ToInt32(rdr["GateInQty"]),
        //                        OutQty = Convert.ToInt32(rdr["TotalOutQty"]),
        //                        Lotbalance = Convert.ToInt32(rdr["BalanceQty"]),
        //                        Alotbal = Convert.ToInt32(rdr["BalanceQty"]),

        //                        ItemName = rdr["itemname"].ToString(),
        //                        Prodetails = rdr["package"].ToString(),
        //                        PreInwardKhata = rdr["khataname"].ToString(),
        //                        VarietyId = rdr["quality"].ToString(),
        //                        ChamberId = Convert.ToInt32(rdr["locationchamberid"]),
        //                        Templocation = rdr["tlocation"].ToString(),
        //                        ChallanName = rdr["ChallanName"].ToString(),
        //                        ServiceId = rdr["sname"].ToString(),
        //                    };
        //                    GetDailyPreinward.Add(companyModel);
        //                }
        //                con.Close();
        //                cmd.Dispose();
        //            }
        //            return GetDailyPreinward;
        //        }





        public async Task<List<CompanyModel>> GenerateLotReport(CompanyModel EditModel, int unit)
        {
            List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("GenerateLotReport", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;
                    
                    cmd3.Parameters.AddWithValue("@Partyid", EditModel.Partyid);
                    cmd3.Parameters.AddWithValue("@Groowerid", EditModel.Growerid);

                    cmd3.Parameters.AddWithValue("@varietyid", EditModel.VarietyId);

                    cmd3.Parameters.AddWithValue("@chamberid", EditModel.ChamberName);
                    cmd3.Parameters.AddWithValue("@LotId", EditModel.LotIrn);


                    cmd3.Parameters.AddWithValue("@unit", unit);

                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"SELECT 
    g.LOTNO,g.lotirn,
    g.VerifiedQty AS GateInQty,c.partytypeid  +'-'+ c.partyname as PartyName,  CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
     COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0) AS TotalOutQty,
    (g.VerifiedQty - COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0)) AS BalanceQty,g.verifiedQty ,prt.name as itemname, pt.name as package,g.khataname,pq.name as quality,
	isnull(FloorName+space(1)+lf.MatrixName+lf.RowName+space(1)+lf.ColumnName ,'NA') as tlocation,cr.chambername as chamber,cm.ChallanName,st.sname
FROM GateInTransrep g
LEFT JOIN LOTOUTTRANS o ON g.LOTNO = o.LOTNO
LEFT JOIN PARTY C ON G.PARTYID = C.PARTYID
LEFT JOIN PARTYsub ps ON G.GrowerId = PS.PARTYID
LEFT JOIN prodtype prt ON g.itemid = prt.id
LEFT JOIN PTYPE pt ON g.packageid = pt.id
LEFT JOIN prodqaul pq ON g.varietyid = pq.id
LEFT JOIN challanmaster cm ON g.challanid = cm.id  
LEFT JOIN servicetypes st ON g.schemeid = st.id
LEFT JOIN locationFinal lf ON g.lotno =lf.lotno
LEFT JOIN chamber cr ON g.locationchamberid =cr.chamberid
GROUP BY g.LOTNO, g.VerifiedQty,c.partytypeid  +'-'+ c.partyname,convert(varchar(max),ps.partyid)  +'-'+ ps.partyname,prt.name ,pt.name,g.khataname,pq.name,cm.ChallanName,st.sname,
FloorName+space(1)+lf.MatrixName+lf.RowName+space(1)+lf.ColumnName,cr.chambername ,g.lotirn
having  (g.VerifiedQty - COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0)) >0
ORDER BY g.LOTNO";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Lotno = Convert.ToInt32(rdr["LOTNO"]),
                        LotIrn = rdr["lotirn"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                        GrowerCombine = rdr["PartyName"].ToString() + " " + rdr["GrowerName"].ToString(),
                        VerfiedQty = Convert.ToInt32(rdr["GateInQty"]),
                        OutQty = Convert.ToInt32(rdr["TotalOutQty"]),
                        Lotbalance = Convert.ToInt32(rdr["BalanceQty"]),
                         Alotbal = Convert.ToInt32(rdr["BalanceQty"]),

                        ItemName = rdr["itemname"].ToString(),
                        Prodetails = rdr["package"].ToString(),
                        PreInwardKhata = rdr["khataname"].ToString(),
                        VarietyId = rdr["quality"].ToString(),
                        ChamberName = rdr["chamber"].ToString(),
                        Templocation = rdr["tlocation"].ToString(),
                        ChallanName = rdr["ChallanName"].ToString(),
                        ServiceId = rdr["sname"].ToString(),
                    };
                    GetDailyPreinward.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinward;
        }

        public async Task<List<CompanyModel>> GeneraterawReport(CompanyModel EditModel, int unit)
        {
            List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("GenerateLotReport", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;

                    cmd3.Parameters.AddWithValue("@Partyid", EditModel.Partyid);
                    cmd3.Parameters.AddWithValue("@Groowerid", EditModel.Growerid);

                    cmd3.Parameters.AddWithValue("@varietyid", EditModel.VarietyId);

                    cmd3.Parameters.AddWithValue("@chamberid", EditModel.ChamberName);
                    cmd3.Parameters.AddWithValue("@LotId", EditModel.LotIrn);


                    cmd3.Parameters.AddWithValue("@unit", unit);

                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"SELECT 
    g.LOTNO,g.lotirn,
    g.VerifiedQty AS GateInQty,c.partytypeid  +'-'+ c.partyname as PartyName,  CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
      COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0) AS TotalOutQty,
    (g.VerifiedQty - COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0)) AS BalanceQty,g.verifiedQty ,prt.name as itemname, pt.name as package,g.khataname,pq.name as quality,
	isnull(FloorName+space(1)+lf.MatrixName+lf.RowName+space(1)+lf.ColumnName ,'NA') as tlocation,cr.chambername as chamber,cm.ChallanName,st.sname
FROM ProcessLotqtyfinal lm
LEFT JOIN gateintrans G ON g.LOTNO = LM.LOTNO
LEFT JOIN LOTOUTTRANS o ON g.LOTNO = o.LOTNO
LEFT JOIN PARTY C ON lm.PARTYID = C.PARTYID
LEFT JOIN PARTYsub ps ON lm.GrowerId = PS.PARTYID
LEFT JOIN prodtype prt ON g.itemid = prt.id
LEFT JOIN PTYPE pt ON g.packageid = pt.id
LEFT JOIN prodqaul pq ON g.varietyid = pq.id
LEFT JOIN challanmaster cm ON g.challanid = cm.id  
LEFT JOIN servicetypes st ON g.schemeid = st.id
LEFT JOIN locationFinal lf ON g.lotno =lf.lotno
left JOIN chamber cr ON g.locationchamberid =cr.chamberid
GROUP BY cr.chambername,g.LOTNO, g.VerifiedQty,c.partytypeid  +'-'+ c.partyname,convert(varchar(max),ps.partyid)  +'-'+ ps.partyname,prt.name ,pt.name,g.khataname,pq.name,cm.ChallanName,st.sname,
FloorName+space(1)+lf.MatrixName+lf.RowName+space(1)+lf.ColumnName,g.lotirn,lm.inqty,lm.outqty,lm.transferinqty,lm.transferoutqty
having (lm.inqty+lm.transferinqty)-(lm.outqty+lm.transferoutqty)>0



ORDER BY g.LOTNO




";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Lotno = Convert.ToInt32(rdr["LOTNO"]),
                        LotIrn = rdr["lotirn"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                        GrowerCombine = rdr["PartyName"].ToString() + " " + rdr["GrowerName"].ToString(),
                        VerfiedQty = Convert.ToInt32(rdr["GateInQty"]),
                        OutQty = Convert.ToInt32(rdr["TotalOutQty"]),
                        Lotbalance = Convert.ToInt32(rdr["BalanceQty"]),
                        Alotbal = Convert.ToInt32(rdr["BalanceQty"]),

                        ItemName = rdr["itemname"].ToString(),
                        Prodetails = rdr["package"].ToString(),
                        PreInwardKhata = rdr["khataname"].ToString(),
                        VarietyId = rdr["quality"].ToString(),
                        ChamberName = rdr["chamber"].ToString(),
                        Templocation = rdr["tlocation"].ToString(),
                        ChallanName = rdr["ChallanName"].ToString(),
                        ServiceId = rdr["sname"].ToString(),
                    };
                    GetDailyPreinward.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinward;
        }

        public async Task<List<CompanyModel>> GeneraterawReportComplete(CompanyModel EditModel)
        {
            List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("GenerateLotReportcomplete", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;

                    cmd3.Parameters.AddWithValue("@Partyid", EditModel.Partyid);
                    cmd3.Parameters.AddWithValue("@Groowerid", EditModel.Growerid);

                    cmd3.Parameters.AddWithValue("@varietyid", EditModel.VarietyId);

                    cmd3.Parameters.AddWithValue("@chamberid", EditModel.ChamberName);
                    cmd3.Parameters.AddWithValue("@LotId", EditModel.LotIrn);


                 

                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"SELECT 
    g.LOTNO,
    
    -- Append ""PT"" to lotirn when TransferInQty > 0
    CASE 
        WHEN lm.TransferInQty > 0 THEN 'PT '+g.lotirn 
        ELSE g.lotirn 
    END AS lotirn,
    
    c.partytypeid + '-' + c.partyname as PartyName,  
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
    
    -- Apply logic: if TransferInQty > 0 then VerifiedQty should be 0, else actual value
    CASE 
        WHEN lm.TransferInQty > 0 THEN 0
        ELSE g.verifiedQty 
    END AS verifiedQty,
    
    COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0) AS TotalOutQty,
    lm.TransferInQty,
    lm.TransferOutQty,
    
 
	 CASE 
        WHEN lm.TransferInQty > 0 THEN  lm.TransferInQty
        ELSE g.verifiedQty 
    END -( COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0)+lm.TransferOutQty ) as BalanceQty,

    prt.name as itemname, 
    pt.name as package,
    g.khataname,
    pq.name as quality,
    isnull(FloorName + space(1) + lf.MatrixName + lf.RowName + space(1) + lf.ColumnName, 'NA') as tlocation,
    cr.chambername as chamber,
    cm.ChallanName,
    st.sname
    
FROM ProcessLotqtyfinal lm
LEFT JOIN gateintrans G ON g.LOTNO = LM.LOTNO
LEFT JOIN LOTOUTTRANS o ON g.LOTNO = o.LOTNO
LEFT JOIN PARTY C ON lm.PARTYID = C.PARTYID
LEFT JOIN PARTYsub ps ON lm.GrowerId = PS.PARTYID
LEFT JOIN prodtype prt ON g.itemid = prt.id
LEFT JOIN PTYPE pt ON g.packageid = pt.id
LEFT JOIN prodqaul pq ON g.varietyid = pq.id
LEFT JOIN challanmaster cm ON g.challanid = cm.id  
LEFT JOIN servicetypes st ON g.schemeid = st.id
LEFT JOIN locationFinal lf ON g.lotno = lf.lotno
LEFT JOIN chamber cr ON g.locationchamberid = cr.chamberid

GROUP BY 
    cr.chambername,
    g.LOTNO, 
    g.lotirn,  -- Add g.lotirn to GROUP BY
    g.verifiedQty,
    c.partytypeid + '-' + c.partyname,
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname,
    prt.name,
    pt.name,
    g.khataname,
    pq.name,
    cm.ChallanName,
    st.sname,
    FloorName + space(1) + lf.MatrixName + lf.RowName + space(1) + lf.ColumnName,
    lm.inqty,
    lm.outqty,
    lm.transferinqty,
    lm.transferoutqty
    
ORDER BY g.LOTNO;";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Lotno = Convert.ToInt32(rdr["LOTNO"]),
                        LotIrn = rdr["lotirn"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                        GrowerCombine = rdr["PartyName"].ToString() + " " + rdr["GrowerName"].ToString(),
                        VerfiedQty = Convert.ToInt32(rdr["verifiedQty"]),
                        OutQty = Convert.ToInt32(rdr["TotalOutQty"]),
                        Lotbalance = Convert.ToInt32(rdr["BalanceQty"]),
                        Alotbal = Convert.ToInt32(rdr["BalanceQty"]),
                        TransferInQty = Convert.ToInt32(rdr["TransferInQty"]),
                        TransferOutQty = Convert.ToInt32(rdr["TransferOutQty"]),

                        ItemName = rdr["itemname"].ToString(),
                        Prodetails = rdr["package"].ToString(),
                        PreInwardKhata = rdr["khataname"].ToString(),
                        VarietyId = rdr["quality"].ToString(),
                        ChamberName = rdr["chamber"].ToString(),
                        Templocation = rdr["tlocation"].ToString(),
                        ChallanName = rdr["ChallanName"].ToString(),
                        ServiceId = rdr["sname"].ToString(),
                    };
                    GetDailyPreinward.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinward;
        }

        public async Task<List<CompanyModel>> GeneraterawReportCompleteAvail(CompanyModel EditModel)
        {
            List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("GenerateLotReportcomplete", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;

                    cmd3.Parameters.AddWithValue("@Partyid", EditModel.Partyid);
                    cmd3.Parameters.AddWithValue("@Groowerid", EditModel.Growerid);

                    cmd3.Parameters.AddWithValue("@varietyid", EditModel.VarietyId);

                    cmd3.Parameters.AddWithValue("@chamberid", EditModel.ChamberName);
                    cmd3.Parameters.AddWithValue("@LotId", EditModel.LotIrn);




                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"SELECT 
    g.LOTNO,
    
    -- Append ""PT"" to lotirn when TransferInQty > 0
    CASE 
        WHEN lm.TransferInQty > 0 THEN 'PT '+g.lotirn 
        ELSE g.lotirn 
    END AS lotirn,
    
    c.partytypeid + '-' + c.partyname as PartyName,  
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
    
    -- Apply logic: if TransferInQty > 0 then VerifiedQty should be 0, else actual value
    CASE 
        WHEN lm.TransferInQty > 0 THEN 0
        ELSE g.verifiedQty 
    END AS verifiedQty,
    
    COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0) AS TotalOutQty,
    lm.TransferInQty,
    lm.TransferOutQty,
    
 
	 CASE 
        WHEN lm.TransferInQty > 0 THEN  lm.TransferInQty
        ELSE g.verifiedQty 
    END -( COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0)+lm.TransferOutQty ) as BalanceQty,

    prt.name as itemname, 
    pt.name as package,
    g.khataname,
    pq.name as quality,
    isnull(FloorName + space(1) + lf.MatrixName + lf.RowName + space(1) + lf.ColumnName, 'NA') as tlocation,
    cr.chambername as chamber,
    cm.ChallanName,
    st.sname
    
FROM ProcessLotqtyfinal lm
LEFT JOIN gateintrans G ON g.LOTNO = LM.LOTNO
LEFT JOIN LOTOUTTRANS o ON g.LOTNO = o.LOTNO
LEFT JOIN PARTY C ON lm.PARTYID = C.PARTYID
LEFT JOIN PARTYsub ps ON lm.GrowerId = PS.PARTYID
LEFT JOIN prodtype prt ON g.itemid = prt.id
LEFT JOIN PTYPE pt ON g.packageid = pt.id
LEFT JOIN prodqaul pq ON g.varietyid = pq.id
LEFT JOIN challanmaster cm ON g.challanid = cm.id  
LEFT JOIN servicetypes st ON g.schemeid = st.id
LEFT JOIN locationFinal lf ON g.lotno = lf.lotno
LEFT JOIN chamber cr ON g.locationchamberid = cr.chamberid

GROUP BY 
    cr.chambername,
    g.LOTNO, 
    g.lotirn,  -- Add g.lotirn to GROUP BY
    g.verifiedQty,
    c.partytypeid + '-' + c.partyname,
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname,
    prt.name,
    pt.name,
    g.khataname,
    pq.name,
    cm.ChallanName,
    st.sname,
    FloorName + space(1) + lf.MatrixName + lf.RowName + space(1) + lf.ColumnName,
    lm.inqty,
    lm.outqty,
    lm.transferinqty,
    lm.transferoutqty
    	having 	 CASE 
        WHEN lm.TransferInQty > 0 THEN  lm.TransferInQty
        ELSE g.verifiedQty 
    END -( COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0)+lm.TransferOutQty ) >0

ORDER BY g.LOTNO;";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Lotno = Convert.ToInt32(rdr["LOTNO"]),
                        LotIrn = rdr["lotirn"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                        GrowerCombine = rdr["PartyName"].ToString() + " " + rdr["GrowerName"].ToString(),
                        VerfiedQty = Convert.ToInt32(rdr["verifiedQty"]),
                        OutQty = Convert.ToInt32(rdr["TotalOutQty"]),
                        Lotbalance = Convert.ToInt32(rdr["BalanceQty"]),
                        Alotbal = Convert.ToInt32(rdr["BalanceQty"]),
                        TransferInQty = Convert.ToInt32(rdr["TransferInQty"]),
                        TransferOutQty = Convert.ToInt32(rdr["TransferOutQty"]),

                        ItemName = rdr["itemname"].ToString(),
                        Prodetails = rdr["package"].ToString(),
                        PreInwardKhata = rdr["khataname"].ToString(),
                        VarietyId = rdr["quality"].ToString(),
                        ChamberName = rdr["chamber"].ToString(),
                        Templocation = rdr["tlocation"].ToString(),
                        ChallanName = rdr["ChallanName"].ToString(),
                        ServiceId = rdr["sname"].ToString(),
                    };
                    GetDailyPreinward.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinward;
        }

        public async Task<List<CompanyModel>> GeneraterawReportCompleteFinish(CompanyModel EditModel)
        {
            List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("GenerateLotReportcomplete", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;

                    cmd3.Parameters.AddWithValue("@Partyid", EditModel.Partyid);
                    cmd3.Parameters.AddWithValue("@Groowerid", EditModel.Growerid);

                    cmd3.Parameters.AddWithValue("@varietyid", EditModel.VarietyId);

                    cmd3.Parameters.AddWithValue("@chamberid", EditModel.ChamberName);
                    cmd3.Parameters.AddWithValue("@LotId", EditModel.LotIrn);




                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"SELECT 
    g.LOTNO,
    
    -- Append ""PT"" to lotirn when TransferInQty > 0
    CASE 
        WHEN lm.TransferInQty > 0 THEN 'PT '+g.lotirn 
        ELSE g.lotirn 
    END AS lotirn,
    
    c.partytypeid + '-' + c.partyname as PartyName,  
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
    
    -- Apply logic: if TransferInQty > 0 then VerifiedQty should be 0, else actual value
    CASE 
        WHEN lm.TransferInQty > 0 THEN 0
        ELSE g.verifiedQty 
    END AS verifiedQty,
    
    COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0) AS TotalOutQty,
    lm.TransferInQty,
    lm.TransferOutQty,
    
 
	 CASE 
        WHEN lm.TransferInQty > 0 THEN  lm.TransferInQty
        ELSE g.verifiedQty 
    END -( COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0)+lm.TransferOutQty ) as BalanceQty,

    prt.name as itemname, 
    pt.name as package,
    g.khataname,
    pq.name as quality,
    isnull(FloorName + space(1) + lf.MatrixName + lf.RowName + space(1) + lf.ColumnName, 'NA') as tlocation,
    cr.chambername as chamber,
    cm.ChallanName,
    st.sname
    
FROM ProcessLotqtyfinal lm
LEFT JOIN gateintrans G ON g.LOTNO = LM.LOTNO
LEFT JOIN LOTOUTTRANS o ON g.LOTNO = o.LOTNO
LEFT JOIN PARTY C ON lm.PARTYID = C.PARTYID
LEFT JOIN PARTYsub ps ON lm.GrowerId = PS.PARTYID
LEFT JOIN prodtype prt ON g.itemid = prt.id
LEFT JOIN PTYPE pt ON g.packageid = pt.id
LEFT JOIN prodqaul pq ON g.varietyid = pq.id
LEFT JOIN challanmaster cm ON g.challanid = cm.id  
LEFT JOIN servicetypes st ON g.schemeid = st.id
LEFT JOIN locationFinal lf ON g.lotno = lf.lotno
LEFT JOIN chamber cr ON g.locationchamberid = cr.chamberid

GROUP BY 
    cr.chambername,
    g.LOTNO, 
    g.lotirn,  -- Add g.lotirn to GROUP BY
    g.verifiedQty,
    c.partytypeid + '-' + c.partyname,
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname,
    prt.name,
    pt.name,
    g.khataname,
    pq.name,
    cm.ChallanName,
    st.sname,
    FloorName + space(1) + lf.MatrixName + lf.RowName + space(1) + lf.ColumnName,
    lm.inqty,
    lm.outqty,
    lm.transferinqty,
    lm.transferoutqty
    	having 	 CASE 
        WHEN lm.TransferInQty > 0 THEN  lm.TransferInQty
        ELSE g.verifiedQty 
    END -( COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0)+lm.TransferOutQty ) =0

ORDER BY g.LOTNO;";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Lotno = Convert.ToInt32(rdr["LOTNO"]),
                        LotIrn = rdr["lotirn"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                        GrowerCombine = rdr["PartyName"].ToString() + " " + rdr["GrowerName"].ToString(),
                        VerfiedQty = Convert.ToInt32(rdr["verifiedQty"]),
                        OutQty = Convert.ToInt32(rdr["TotalOutQty"]),
                        Lotbalance = Convert.ToInt32(rdr["BalanceQty"]),
                        Alotbal = Convert.ToInt32(rdr["BalanceQty"]),
                        TransferInQty = Convert.ToInt32(rdr["TransferInQty"]),
                        TransferOutQty = Convert.ToInt32(rdr["TransferOutQty"]),

                        ItemName = rdr["itemname"].ToString(),
                        Prodetails = rdr["package"].ToString(),
                        PreInwardKhata = rdr["khataname"].ToString(),
                        VarietyId = rdr["quality"].ToString(),
                        ChamberName = rdr["chamber"].ToString(),
                        Templocation = rdr["tlocation"].ToString(),
                        ChallanName = rdr["ChallanName"].ToString(),
                        ServiceId = rdr["sname"].ToString(),
                    };
                    GetDailyPreinward.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinward;
        }




        public async Task<List<CompanyModel>> GeneraterawReportEdit(CompanyModel EditModel, int unit, int tempid)
        {
            List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("GenerateLotReportEdit", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;

                    cmd3.Parameters.AddWithValue("@Partyid", EditModel.Partyid);
                    cmd3.Parameters.AddWithValue("@Groowerid", EditModel.Growerid);

                    cmd3.Parameters.AddWithValue("@varietyid", EditModel.VarietyId);

                    cmd3.Parameters.AddWithValue("@chamberid", EditModel.ChamberName);
                    cmd3.Parameters.AddWithValue("@LotId", EditModel.LotIrn);


                    cmd3.Parameters.AddWithValue("@unit", unit);
                    cmd3.Parameters.AddWithValue("@Tempid", tempid);
                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"SELECT 
    g.LOTNO,g.lotirn,
    g.VerifiedQty AS GateInQty,c.partytypeid  +'-'+ c.partyname as PartyName,  CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
      COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0) AS TotalOutQty,
    (g.VerifiedQty - COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0)) AS BalanceQty,g.verifiedQty ,prt.name as itemname, pt.name as package,g.khataname,pq.name as quality,
	isnull(FloorName+space(1)+lf.MatrixName+lf.RowName+space(1)+lf.ColumnName ,'NA') as tlocation,cr.chambername as chamber,cm.ChallanName,st.sname
FROM ProcessLotqtyfinal lm
LEFT JOIN gateintrans G ON g.LOTNO = LM.LOTNO
LEFT JOIN LOTOUTTRANS o ON g.LOTNO = o.LOTNO
LEFT JOIN PARTY C ON lm.PARTYID = C.PARTYID
LEFT JOIN PARTYsub ps ON lm.GrowerId = PS.PARTYID
LEFT JOIN prodtype prt ON g.itemid = prt.id
LEFT JOIN PTYPE pt ON g.packageid = pt.id
LEFT JOIN prodqaul pq ON g.varietyid = pq.id
LEFT JOIN challanmaster cm ON g.challanid = cm.id  
LEFT JOIN servicetypes st ON g.schemeid = st.id
LEFT JOIN locationFinal lf ON g.lotno =lf.lotno
left JOIN chamber cr ON g.locationchamberid =cr.chamberid
GROUP BY cr.chambername,g.LOTNO, g.VerifiedQty,c.partytypeid  +'-'+ c.partyname,convert(varchar(max),ps.partyid)  +'-'+ ps.partyname,prt.name ,pt.name,g.khataname,pq.name,cm.ChallanName,st.sname,
FloorName+space(1)+lf.MatrixName+lf.RowName+space(1)+lf.ColumnName,g.lotirn,lm.inqty,lm.outqty,lm.transferinqty,lm.transferoutqty
having (lm.inqty+lm.transferinqty)-(lm.outqty+lm.transferoutqty)>0



ORDER BY g.LOTNO




";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Lotno = Convert.ToInt32(rdr["LOTNO"]),
                        LotIrn = rdr["lotirn"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                        GrowerCombine = rdr["PartyName"].ToString() + " " + rdr["GrowerName"].ToString(),
                        VerfiedQty = Convert.ToInt32(rdr["GateInQty"]),
                        OutQty = Convert.ToInt32(rdr["TotalOutQty"]),
                        Lotbalance = Convert.ToInt32(rdr["BalanceQty"]),
                        Alotbal = Convert.ToInt32(rdr["BalanceQty"]),

                        ItemName = rdr["itemname"].ToString(),
                        Prodetails = rdr["package"].ToString(),
                        PreInwardKhata = rdr["khataname"].ToString(),
                        VarietyId = rdr["quality"].ToString(),
                        ChamberName = rdr["chamber"].ToString(),
                        Templocation = rdr["tlocation"].ToString(),
                        ChallanName = rdr["ChallanName"].ToString(),
                        ServiceId = rdr["sname"].ToString(),
                    };
                    GetDailyPreinward.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinward;
        }













        public async Task<List<CompanyModel>> GeneratePackingReport(string selectedBankIds,string selectedGradeIds,string selectedRecipeIds,string packgrower, int unit,string pelletno)
        {
            List<CompanyModel> GetPackingStock = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
               
                const string query = @"SELECT 
    g.draftid,
    g.PackingDraftno,
    c.partytypeid + '-' + c.partyname as PartyName,
    g.Palletno,
    g.marka,
    ig.gradename,
    pq.name,
    rc.recipename,
    g.qty,
    COALESCE(o.TotalOrderQty, 0) AS TotalOrderQty,
    (g.Qty - COALESCE(o.TotalOrderQty, 0)) AS BalanceQty
FROM RepackDraftItems g
LEFT JOIN (
    SELECT Draftid, palletno, unitid, SUM(Qty) as TotalOrderQty
    FROM packingorderitems 
    WHERE flagdeleted = 0
    GROUP BY Draftid, palletno, unitid
) o ON g.DraftId = o.Draftid AND g.Palletno = o.palletno AND g.unitid = o.unitid
LEFT JOIN DraftOutTrans dt ON g.DraftId = dt.Draftid 
LEFT JOIN PARTY C ON dt.PARTYID = C.PARTYID
LEFT JOIN itemgrades ig ON g.gradeid = ig.id
LEFT JOIN prodqaul pq ON g.brandid = pq.id
LEFT JOIN Recipe rc ON g.RecipeId = rc.Recipeid
WHERE 
    g.unitid = @Unit    and g.flagdeleted=0
    AND (CASE WHEN @DraftIds IS NULL THEN 1 ELSE CASE WHEN dt.DraftId IN (SELECT value FROM STRING_SPLIT(@DraftIds, ',')) THEN 1 ELSE 0 END END) = 1
    AND (CASE WHEN @GradeIds IS NULL THEN 1 ELSE CASE WHEN g.gradeid IN (SELECT value FROM STRING_SPLIT(@GradeIds, ',')) THEN 1 ELSE 0 END END) = 1
    AND (CASE WHEN @RecipeIds IS NULL THEN 1 ELSE CASE WHEN g.RecipeId IN (SELECT value FROM STRING_SPLIT(@RecipeIds, ',')) THEN 1 ELSE 0 END END) = 1
    AND (@PackGrower IS NULL OR c.partytypeid + '-' + c.partyname = @PackGrower)
    AND (@Pellet IS NULL OR g.palletIrn = @Pellet)
GROUP BY 
    g.draftid, g.PackingDraftno, c.partytypeid + '-' + c.partyname, 
    g.Palletno, g.marka, ig.gradename, pq.name, rc.recipename, 
    g.qty, COALESCE(o.TotalOrderQty, 0)
	HAVING (g.Qty - COALESCE(o.TotalOrderQty, 0)) > 0
ORDER BY g.Palletno";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                cmd.Parameters.AddWithValue("@DraftIds", selectedBankIds ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@GradeIds", selectedGradeIds ?? (object)DBNull.Value);

                cmd.Parameters.AddWithValue("@RecipeIds", selectedRecipeIds ?? (object)DBNull.Value);

                cmd.Parameters.AddWithValue("@PackGrower", packgrower ?? (object)DBNull.Value);
            

                cmd.Parameters.AddWithValue("@Unit", unit);

                cmd.Parameters.AddWithValue("@Pellet", pelletno ?? (object)DBNull.Value);
                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        DraftId = Convert.ToInt32(rdr["draftid"]),
                        DraftIrn = rdr["PackingDraftno"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        PalletId = Convert.ToInt32(rdr["Palletno"]),
                      ReceipeMarka = rdr["marka"].ToString(),
                        ReceipeGrade = rdr["gradename"].ToString(),

                        VarietyId = rdr["name"].ToString(),
                        ReceipeName = rdr["recipename"].ToString(),
                      
                        ReceipeQty = Convert.ToInt32(rdr["qty"]),
                        PackingQty = Convert.ToInt32(rdr["TotalOrderQty"]),
                        Recipebalance = Convert.ToInt32(rdr["BalanceQty"]),
                        totavqty = Convert.ToInt32(rdr["BalanceQty"]),
                    };
                    GetPackingStock.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetPackingStock;
        }


        public async Task<List<CompanyModel>> GenerateDispatchReport(string packgrower, string Tlocation, int unit, CompanyModel EditModel)
        {
            List<CompanyModel> GetPackingStock = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {

                const string query = @"SELECT 
    p.draftid,  p.palletno,
    p.PackingOrderId, p.PackingOrderno,p.palletIrn,lm.name,ur.username,
    c.partytypeid + '-' + c.partyname as PartyName,
    p.Palletno,
    p.marka,
    ig.gradename,
    pq.name as variety,
    rc.recipename,
    p.qty AS PackingQty,
    COALESCE(d.TotalDispatchedQty, 0) AS TotalDispatchedQty,
    (p.Qty - COALESCE(d.TotalDispatchedQty, 0)) AS AvailableQty
FROM packingorderitems p
LEFT JOIN (
    SELECT PackingOrderId, palletno, unitid, SUM(Qty) as TotalDispatchedQty
    FROM dispatch 
    WHERE flagdeleted = 0
    GROUP BY PackingOrderId, palletno, unitid
) d ON p.PackingOrderId = d.PackingOrderId AND p.Palletno = d.palletno AND p.unitid = d.unitid
LEFT JOIN PARTY C ON p.PARTYID = C.PARTYID
LEFT JOIN itemgrades ig ON p.gradeid = ig.id
LEFT JOIN prodqaul pq ON p.brandid = pq.id
LEFT JOIN Recipe rc ON p.RecipeId = rc.Recipeid
LEFT JOIN location_master lm ON p.LocationId = lm.id 
LEFT JOIN users ur ON p.userid = ur.userid
WHERE 
    p.unitid = @Unit and p.approved=1
    AND p.flagdeleted = 0  -- Active packing order items only
    AND (@Locate IS NULL OR lm.name = @Locate)
    AND (@Packingorderno IS NULL OR p.PackingOrderno = @Packingorderno)

	    AND p.PackingOrderDate >= @PackingDateFrom
    AND p.PackingOrderDate <= @PackingDate
    --AND (@Marka IS NULL OR p.marka = @Marka)
GROUP BY p.PackingOrderno,p.palletIrn,lm.name,ur.username,
    p.draftid, p.PackingOrderId, c.partytypeid + '-' + c.partyname, 
    p.Palletno, p.marka, ig.gradename, pq.name, rc.recipename, 
    p.qty, COALESCE(d.TotalDispatchedQty, 0)
HAVING (p.Qty - COALESCE(d.TotalDispatchedQty, 0)) > 0
ORDER BY p.PackingOrderId";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

             

                cmd.Parameters.AddWithValue("@Packingorderno", packgrower ?? (object)DBNull.Value);

                cmd.Parameters.AddWithValue("@Locate", Tlocation ?? (object)DBNull.Value);


                cmd.Parameters.AddWithValue("@Unit", unit);

                cmd.Parameters.AddWithValue("@PackingDateFrom", EditModel.PackingOrderDatefrom);
                cmd.Parameters.AddWithValue("@PackingDate", EditModel.PackingOrderDateto);


                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        PalletId = Convert.ToInt32(rdr["palletno"]),
                        PackingOrderIrn = rdr["PackingOrderno"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        PalletName = rdr["palletIrn"].ToString(),
                        PackingQty = Convert.ToInt32(rdr["PackingQty"]),
                        DispatchQty = Convert.ToInt32(rdr["TotalDispatchedQty"]),
                        Packingbalance = Convert.ToInt32(rdr["AvailableQty"]),
                        ActualPackingbalance = Convert.ToInt32(rdr["AvailableQty"]),
                        VarietyId = rdr["variety"].ToString(),
                       ReceipeName = rdr["recipename"].ToString(),
                        ReceipeGrade = rdr["gradename"].ToString(),
                        ReceipeMarka = rdr["marka"].ToString(),
                        UserName = rdr["username"].ToString(),
                        ReceipeLocation = rdr["name"].ToString(),
                        Packingorderid = Convert.ToInt32(rdr["PackingOrderId"]),
                        //PackingQty = Convert.ToInt32(rdr["TotalOrderQty"]),
                        //Recipebalance = Convert.ToInt32(rdr["BalanceQty"]),
                        //totavqty = Convert.ToInt32(rdr["BalanceQty"]),
                    };
                    GetPackingStock.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetPackingStock;
        }


        public async Task<List<CompanyModel>> GenerateDispatchReportComplete(string packgrower, string Tlocation, int unit, CompanyModel EditModel)
        {
            List<CompanyModel> GetPackingStock = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {

                const string query = @"SELECT d.dispatcherid,
    p.draftid,  p.palletno,
    p.PackingOrderId, p.PackingOrderno,p.palletIrn,lm.name,ur.username,
    c.partytypeid + '-' + c.partyname as PartyName,
    p.Palletno,
    p.marka,
    ig.gradename,
    pq.name as variety,
    rc.recipename,
    p.qty AS PackingQty,
    COALESCE(d.TotalDispatchedQty, 0) AS TotalDispatchedQty,
    (p.Qty - COALESCE(d.TotalDispatchedQty, 0)) AS AvailableQty
FROM packingorderitems p
LEFT JOIN (
    SELECT dispatcherid,PackingOrderId, palletno, unitid, SUM(Qty) as TotalDispatchedQty
    FROM dispatch 
    WHERE flagdeleted = 0
    GROUP BY PackingOrderId, palletno, unitid,dispatcherid
) d ON p.PackingOrderId = d.PackingOrderId AND p.Palletno = d.palletno AND p.unitid = d.unitid
LEFT JOIN PARTY C ON p.PARTYID = C.PARTYID
LEFT JOIN itemgrades ig ON p.gradeid = ig.id
LEFT JOIN prodqaul pq ON p.brandid = pq.id
LEFT JOIN Recipe rc ON p.RecipeId = rc.Recipeid
LEFT JOIN location_master lm ON p.LocationId = lm.id 
LEFT JOIN users ur ON p.userid = ur.userid
WHERE 
    p.unitid = @Unit and p.approved=1
    AND p.flagdeleted = 0  -- Active packing order items only
    AND (@Locate IS NULL OR lm.name = @Locate)
    AND (@Packingorderno IS NULL OR p.PackingOrderno = @Packingorderno)

	    AND p.PackingOrderDate >= @PackingDateFrom
    AND p.PackingOrderDate <= @PackingDate
    --AND (@Marka IS NULL OR p.marka = @Marka)
GROUP BY p.PackingOrderno,p.palletIrn,lm.name,ur.username,d.dispatcherid,
    p.draftid, p.PackingOrderId, c.partytypeid + '-' + c.partyname, 
    p.Palletno, p.marka, ig.gradename, pq.name, rc.recipename, 
    p.qty, COALESCE(d.TotalDispatchedQty, 0)
HAVING (p.Qty - COALESCE(d.TotalDispatchedQty, 0)) = 0
ORDER BY p.PackingOrderId";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };



                cmd.Parameters.AddWithValue("@Packingorderno", packgrower ?? (object)DBNull.Value);

                cmd.Parameters.AddWithValue("@Locate", Tlocation ?? (object)DBNull.Value);


                cmd.Parameters.AddWithValue("@Unit", unit);

                cmd.Parameters.AddWithValue("@PackingDateFrom", EditModel.PackingOrderDatefrom);
                cmd.Parameters.AddWithValue("@PackingDate", EditModel.PackingOrderDateto);


                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel

                    {

                        DispatcherId = Convert.ToInt32(rdr["dispatcherid"]),
                        PalletId = Convert.ToInt32(rdr["palletno"]),
                        PackingOrderIrn = rdr["PackingOrderno"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        PalletName = rdr["palletIrn"].ToString(),
                        PackingQty = Convert.ToInt32(rdr["PackingQty"]),
                        DispatchQty = Convert.ToInt32(rdr["TotalDispatchedQty"]),
                        Packingbalance = Convert.ToInt32(rdr["AvailableQty"]),
                        ActualPackingbalance = Convert.ToInt32(rdr["AvailableQty"]),
                        VarietyId = rdr["variety"].ToString(),
                        ReceipeName = rdr["recipename"].ToString(),
                        ReceipeGrade = rdr["gradename"].ToString(),
                        ReceipeMarka = rdr["marka"].ToString(),
                        UserName = rdr["username"].ToString(),
                        ReceipeLocation = rdr["name"].ToString(),
                        Packingorderid = Convert.ToInt32(rdr["PackingOrderId"]),
                        //PackingQty = Convert.ToInt32(rdr["TotalOrderQty"]),
                        //Recipebalance = Convert.ToInt32(rdr["BalanceQty"]),
                        //totavqty = Convert.ToInt32(rdr["BalanceQty"]),
                    };
                    GetPackingStock.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetPackingStock;
        }







        public async Task<List<CompanyModel>> GenerateDispatchReportpend(int unit, CompanyModel EditModel)
        {
            List<CompanyModel> GetPackingStock = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {

                const string query = @"SELECT 
    p.draftid,  p.palletno,
    p.PackingOrderId, p.PackingOrderno,p.palletIrn,lm.name,ur.username,
    c.partytypeid + '-' + c.partyname as PartyName,
    p.Palletno,
    p.marka,
    ig.gradename,
    pq.name as variety,
    rc.recipename,
    p.qty AS PackingQty,
    COALESCE(d.TotalDispatchedQty, 0) AS TotalDispatchedQty,
    (p.Qty - COALESCE(d.TotalDispatchedQty, 0)) AS AvailableQty
FROM packingorderitems p
LEFT JOIN (
    SELECT PackingOrderId, palletno, unitid, SUM(Qty) as TotalDispatchedQty
    FROM dispatch 
    WHERE flagdeleted = 0
    GROUP BY PackingOrderId, palletno, unitid
) d ON p.PackingOrderId = d.PackingOrderId AND p.Palletno = d.palletno AND p.unitid = d.unitid
LEFT JOIN PARTY C ON p.PARTYID = C.PARTYID
LEFT JOIN itemgrades ig ON p.gradeid = ig.id
LEFT JOIN prodqaul pq ON p.brandid = pq.id
LEFT JOIN Recipe rc ON p.RecipeId = rc.Recipeid
LEFT JOIN location_master lm ON p.LocationId = lm.id 
LEFT JOIN users ur ON p.userid = ur.userid
WHERE 
    p.unitid = @Unit and p.approved=1
    AND p.flagdeleted = 0  
  
GROUP BY p.PackingOrderno,p.palletIrn,lm.name,ur.username,
    p.draftid, p.PackingOrderId, c.partytypeid + '-' + c.partyname,
    p.Palletno, p.marka, ig.gradename, pq.name, rc.recipename, 
    p.qty, COALESCE(d.TotalDispatchedQty, 0)
HAVING (p.Qty - COALESCE(d.TotalDispatchedQty, 0)) > 0
ORDER BY p.PackingOrderId,p.palletIrn";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };




                cmd.Parameters.AddWithValue("@Unit", unit);

           
                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                      
                        PalletId = Convert.ToInt32(rdr["palletno"]),
                        PackingOrderIrn = rdr["PackingOrderno"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        PalletName = rdr["palletIrn"].ToString(),
                        PackingQty = Convert.ToInt32(rdr["PackingQty"]),
                        DispatchQty = Convert.ToInt32(rdr["TotalDispatchedQty"]),
                        Packingbalance = Convert.ToInt32(rdr["AvailableQty"]),
                        ActualPackingbalance = Convert.ToInt32(rdr["AvailableQty"]),
                        VarietyId = rdr["variety"].ToString(),
                        ReceipeName = rdr["recipename"].ToString(),
                        ReceipeGrade = rdr["gradename"].ToString(),
                        ReceipeMarka = rdr["marka"].ToString(),
                        UserName = rdr["username"].ToString(),
                        ReceipeLocation = rdr["name"].ToString(),
                        Packingorderid = Convert.ToInt32(rdr["PackingOrderId"]),
                        //PackingQty = Convert.ToInt32(rdr["TotalOrderQty"]),
                        //Recipebalance = Convert.ToInt32(rdr["BalanceQty"]),
                        //totavqty = Convert.ToInt32(rdr["BalanceQty"]),
                    };
                    GetPackingStock.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetPackingStock;
        }






















        public async Task<List<CompanyModel>> GenerateOutwardReport(string packgrower,int unit, CompanyModel EditModel)
        {
            List<CompanyModel> GetPackingStock = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {

                const string query = @"WITH DispatchDetails AS (
    SELECT 
        d.DispatcherId,
        d.PackingOrderId,
        d.palletno,
        d.unitid,
        d.qty AS DispatchQty,
        -- Get outward quantity for THIS specific dispatch
        COALESCE((
            SELECT SUM(o.Qty) 
            FROM Outward o 
            WHERE o.PackingOrderId = d.PackingOrderId 
                AND o.palletno = d.palletno 
                AND o.unitid = d.unitid
                AND o.DispatcherId = d.DispatcherId  -- Match by DispatcherId
                AND o.flagdeleted = 0
        ), 0) AS OutwardQtyForThisDispatch,
        -- Calculate available for this dispatch
        d.qty - COALESCE((
            SELECT SUM(o.Qty) 
            FROM Outward o 
            WHERE o.PackingOrderId = d.PackingOrderId 
                AND o.palletno = d.palletno 
                AND o.unitid = d.unitid
                AND o.DispatcherId = d.DispatcherId
                AND o.flagdeleted = 0
        ), 0) AS AvailableForThisDispatch
    FROM dispatch d
    WHERE d.flagdeleted = 0
        AND d.PackingOrderId IN (SELECT PackingOrderId FROM packingorderitems WHERE packingorderno = @Packingorderno)
        AND d.unitid = @Unit
),
PalletSummary AS (
    -- Get total outward per pallet
    SELECT 
        PackingOrderId,
        palletno,
        unitid,
        SUM(DispatchQty) AS TotalPackingQty,
        SUM(OutwardQtyForThisDispatch) AS TotalOutwardQty,
        SUM(AvailableForThisDispatch) AS TotalAvailableQty,
        -- Find which dispatcher has available quantity (take the first one with available qty > 0)
        MAX(CASE WHEN AvailableForThisDispatch > 0 THEN DispatcherId END) AS AvailableDispatcherId
    FROM DispatchDetails
    GROUP BY PackingOrderId, palletno, unitid
    HAVING SUM(AvailableForThisDispatch) > 0
)
SELECT 
    ps.AvailableDispatcherId as DispatcherId,  
    ps.palletno,
    c.partytypeid + '-' + c.partyname as PartyName,
    ps.PackingOrderId,
    po.PackingOrderno,
    po.palletIrn,
    lm.name as LocationName,
    ur.username,
    po.marka,
    ig.gradename,
    pq.name as pql,
    rc.recipename,
    rtrim(vi.vehno) as vehno,
    ps.TotalPackingQty,
    ps.TotalOutwardQty,
    ps.TotalAvailableQty AS AvailableQty
FROM PalletSummary ps
INNER JOIN packingorderitems po ON ps.PackingOrderId = po.PackingOrderId 
    AND ps.unitid = po.unitid 
    AND ps.palletno = po.palletno
and po.flagdeleted =0
LEFT JOIN itemgrades ig ON po.gradeid = ig.id
LEFT JOIN prodqaul pq ON po.brandid = pq.id
LEFT JOIN Recipe rc ON po.RecipeId = rc.Recipeid
LEFT JOIN location_master lm ON po.LocationId = lm.id 
LEFT JOIN users ur ON po.createdby = ur.userid
LEFT JOIN vehinfo vi ON po.Vehid = vi.vid
LEFT JOIN party c ON po.partyid = c.partyid
WHERE po.approved = 1
ORDER BY ps.palletno;";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };



                cmd.Parameters.AddWithValue("@Packingorderno", packgrower ?? (object)DBNull.Value);

          

                cmd.Parameters.AddWithValue("@Unit", unit);



                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        DispatcherId = Convert.ToInt32(rdr["DispatcherId"]),
                        PalletId = Convert.ToInt32(rdr["palletno"]),
                        PackingOrderIrn = rdr["PackingOrderno"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        PalletName = rdr["palletIrn"].ToString(),
                        DispatchQty = Convert.ToInt32(rdr["TotalPackingQty"]),
                        OutwardQty = Convert.ToInt32(rdr["TotalOutwardQty"]),
                        Outwardbalance = Convert.ToInt32(rdr["AvailableQty"]),
                        OutwardPackingbalance = Convert.ToInt32(rdr["AvailableQty"]),
                        VarietyId = rdr["pql"].ToString(),
                        ReceipeName = rdr["recipename"].ToString(),
                        ReceipeGrade = rdr["gradename"].ToString(),
                        ReceipeMarka = rdr["marka"].ToString(),
                        Vehno = rdr["vehno"].ToString(),
                        Packingorderid = Convert.ToInt32(rdr["PackingOrderId"]),
                        //PackingQty = Convert.ToInt32(rdr["TotalOrderQty"]),
                        //Recipebalance = Convert.ToInt32(rdr["BalanceQty"]),
                        //totavqty = Convert.ToInt32(rdr["BalanceQty"]),
                    };
                    GetPackingStock.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetPackingStock;
        }


        public async Task<List<CompanyModel>> GenerateOutwardReporttemp(int tempid,int unit,int orderid)
        {
            List<CompanyModel> GetPackingStockTemp = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {

                const string query = @"WITH UniqueOutwardTemp AS (
    SELECT 
        ot.id,ot.returnflag,
        ot.PackingOrderId,
        ot.palletno,
        ot.unitid,
        ot.Qty,
        ot.tempid,   ot.dispatcherid,
        ot.flagdeleted,
        ROW_NUMBER() OVER (PARTITION BY ot.id ORDER BY ot.id) as rn
    FROM Outwardtemp ot
    WHERE ot.flagdeleted = 0 
        AND ot.tempid = @tempid
)
SELECT 
    uot.id as id,uot.returnflag,
    p.palletno,
    c.partytypeid + '-' + c.partyname as PartyName,
    p.PackingOrderId, 
    po.PackingOrderno,
    po.palletIrn,
    lm.name as LocationName,
    ur.username,
    po.marka,
    ig.gradename,
    pq.name as pql,
    rc.recipename,
    RTRIM(vi.vehno) as vehno,
    p.qty AS PackingQty,
    uot.Qty as DispatchedQty,
    (p.qty - ISNULL(uot.Qty, 0)) AS AvailableQty
FROM UniqueOutwardTemp uot
INNER JOIN dispatch p 
    ON uot.PackingOrderId = p.PackingOrderId 
    AND uot.palletno = p.palletno 
    AND uot.unitid = p.unitid
    AND p.flagdeleted = 0
INNER JOIN packingorderitems po 
    ON p.PackingOrderId = po.PackingOrderId 
    AND p.unitId = po.unitid 
    AND p.palletno = po.palletno
	  AND p.DispatcherId = uot.DispatcherId
    AND po.approved = 1
and po.flagdeleted=0
    AND po.unitid =@Unit
 and po.flagdeleted=0
LEFT JOIN party c ON po.partyid = c.partyid
LEFT JOIN itemgrades ig ON po.gradeid = ig.id
LEFT JOIN prodqaul pq ON po.brandid = pq.id
LEFT JOIN Recipe rc ON po.RecipeId = rc.Recipeid
LEFT JOIN location_master lm ON po.LocationId = lm.id 
LEFT JOIN users ur ON p.createdby = ur.userid
LEFT JOIN vehinfo vi ON po.Vehid = vi.vid
WHERE uot.rn = 1  -- Only get one record per outwardtemp id
    AND p.PackingOrderId =@OrderId
ORDER BY p.palletno, uot.id";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };




                cmd.Parameters.AddWithValue("@tempid", tempid);

                cmd.Parameters.AddWithValue("@Unit", unit);
                cmd.Parameters.AddWithValue("@OrderId", orderid);




                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        Outwardid = Convert.ToInt32(rdr["id"]),
                        PalletId = Convert.ToInt32(rdr["palletno"]),
                        PackingOrderIrn = rdr["PackingOrderno"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        PalletName = rdr["palletIrn"].ToString(),
                        DispatchQty = Convert.ToInt32(rdr["PackingQty"]),
                        OutwardQty = Convert.ToInt32(rdr["DispatchedQty"]),
                        Outwardbalance = Convert.ToInt32(rdr["AvailableQty"]),
                        OutwardPackingbalance = Convert.ToInt32(rdr["AvailableQty"]),
                        VarietyId = rdr["pql"].ToString(),
                        ReceipeName = rdr["recipename"].ToString(),
                        ReceipeGrade = rdr["gradename"].ToString(),
                        ReceipeMarka = rdr["marka"].ToString(),
                        Vehno = rdr["vehno"].ToString(),
                        Packingorderid = Convert.ToInt32(rdr["PackingOrderId"]),
                        IsReturned = Convert.ToBoolean(rdr["returnflag"]),
                        //PackingQty = Convert.ToInt32(rdr["TotalOrderQty"]),
                        //Recipebalance = Convert.ToInt32(rdr["BalanceQty"]),
                        //totavqty = Convert.ToInt32(rdr["BalanceQty"]),
                    };
                    GetPackingStockTemp.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetPackingStockTemp;
        }

        public async Task<List<CompanyModel>> GenerateOutwardwithtemp(int tempid, int unit, int orderid)
        {
            List<CompanyModel> GetPackingStock = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {

                const string query = @"SELECT 
    p.DispatcherId, 
    p.palletno,
    c.partytypeid + '-' + c.partyname as PartyName,
    p.PackingOrderId, 
    po.PackingOrderno,
    po.palletIrn,
    lm.name as LocationName,
    ur.username,
    p.Palletno,
    po.marka,
    ig.gradename,
    pq.name as pql,
    rc.recipename,
    RTRIM(vi.vehno) as vehno,
    SUM(p.qty) AS PackingQty,
    COALESCE(o.TotalDispatchedQty, 0) AS TotalOutwardQty,
    COALESCE(ot.TotalOutwardTempQty, 0) AS TotalOutwardTempQty,
    (SUM(p.qty) - COALESCE(o.TotalDispatchedQty, 0) - COALESCE(ot.TotalOutwardTempQty, 0)) AS AvailableQty
FROM dispatch p
LEFT JOIN (
    SELECT 
        PackingOrderId, 
        palletno, 
        unitid,
        DispatcherId,
        SUM(Qty) as TotalDispatchedQty
    FROM Outward 
    WHERE flagdeleted = 0
    GROUP BY PackingOrderId, palletno, unitid, DispatcherId
) o ON p.PackingOrderId = o.PackingOrderId 
    AND p.Palletno = o.palletno 
    AND p.unitid = o.unitid
    AND p.DispatcherId = o.DispatcherId

LEFT JOIN (
    SELECT 
        PackingOrderId, 
        palletno, 
        unitid,
        DispatcherId,
        SUM(Qty) as TotalOutwardTempQty
    FROM Outwardtemp 
    WHERE flagdeleted = 0 and tempid=@tempid
    GROUP BY PackingOrderId, palletno, unitid, DispatcherId
) ot ON p.PackingOrderId = ot.PackingOrderId 
    AND p.Palletno = ot.palletno 
    AND p.unitid = ot.unitid
    AND p.DispatcherId = ot.DispatcherId

LEFT JOIN packingorderitems po ON p.PackingOrderId = po.PackingOrderId 
    AND p.unitId = po.unitid 
    AND p.palletno = po.palletno
and  po.flagdeleted = 0
LEFT JOIN itemgrades ig ON po.gradeid = ig.id
LEFT JOIN prodqaul pq ON po.brandid = pq.id
LEFT JOIN Recipe rc ON po.RecipeId = rc.Recipeid
LEFT JOIN location_master lm ON po.LocationId = lm.id 
LEFT JOIN users ur ON p.createdby = ur.userid
LEFT JOIN vehinfo vi ON po.Vehid = vi.vid
LEFT JOIN party c ON po.partyid = c.partyid
WHERE 
    po.unitid = @unit
    AND po.approved = 1 
    AND po.PackingOrderid = @orderid
    AND p.flagdeleted = 0
GROUP BY 
    p.DispatcherId, 
    p.palletno,
    c.partytypeid + '-' + c.partyname,
    p.PackingOrderId, 
    po.PackingOrderno,
    po.palletIrn,
    lm.name,
    ur.username,
    p.Palletno,
    po.marka,
    ig.gradename,
    pq.name,
    rc.recipename,
    RTRIM(vi.vehno),
    COALESCE(o.TotalDispatchedQty, 0),
    COALESCE(ot.TotalOutwardTempQty, 0)
HAVING (SUM(p.qty) - COALESCE(o.TotalDispatchedQty, 0) - COALESCE(ot.TotalOutwardTempQty, 0)) > 0
ORDER BY p.PackingOrderId, p.palletno, p.DispatcherId";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };




                cmd.Parameters.AddWithValue("@tempid", tempid);

                cmd.Parameters.AddWithValue("@Unit", unit);
                cmd.Parameters.AddWithValue("@OrderId", orderid);




                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        DispatcherId = Convert.ToInt32(rdr["DispatcherId"]),
                        PalletId = Convert.ToInt32(rdr["palletno"]),
                        PackingOrderIrn = rdr["PackingOrderno"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        PalletName = rdr["palletIrn"].ToString(),
                        DispatchQty = Convert.ToInt32(rdr["PackingQty"]),
                        OutwardQty = Convert.ToInt32(rdr["TotalOutwardQty"]),
                        Outwardbalance = Convert.ToInt32(rdr["AvailableQty"]),
                        OutwardPackingbalance = Convert.ToInt32(rdr["AvailableQty"]),
                        VarietyId = rdr["pql"].ToString(),
                        ReceipeName = rdr["recipename"].ToString(),
                        ReceipeGrade = rdr["gradename"].ToString(),
                        ReceipeMarka = rdr["marka"].ToString(),
                        Vehno = rdr["vehno"].ToString(),
                        Packingorderid = Convert.ToInt32(rdr["PackingOrderId"]),
                        //PackingQty = Convert.ToInt32(rdr["TotalOrderQty"]),
                        //Recipebalance = Convert.ToInt32(rdr["BalanceQty"]),
                        //totavqty = Convert.ToInt32(rdr["BalanceQty"]),
                    };
                    GetPackingStock.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetPackingStock;
        }



        public async Task<List<CompanyModel>> GenerateOutwardwithtempEdit(int tempid, int unit, int orderid)
        {
            List<CompanyModel> GetPackingStockTemp = new List<CompanyModel>();
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("ProcessEditOutward", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;


                    cmd3.Parameters.AddWithValue("@Tempid", tempid);
                    cmd3.Parameters.AddWithValue("@Order", orderid);
                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();


                const string query = @"WITH UniqueOutwardTemp AS (
    SELECT DISTINCT
        PackingOrderId,
        palletno,
        unitid,
        dispatcherid,
        SUM(Qty) as TotalQty,
        MIN(id) as id
    FROM Outwardtemp
    WHERE flagdeleted = 0 
        AND tempid = @tempid
    GROUP BY PackingOrderId, palletno, unitid, dispatcherid
),
UniquePackingOrder AS (
    SELECT DISTINCT
        PackingOrderId,
        unitid,
        palletno,
        MIN(PackingOrderno) as PackingOrderno,
        MIN(palletIrn) as palletIrn,
        MIN(partyid) as partyid,
        MIN(marka) as marka,
        MIN(gradeid) as gradeid,
        MIN(brandid) as brandid,
        MIN(RecipeId) as RecipeId,
        MIN(LocationId) as LocationId,
        MIN(Vehid) as Vehid
    FROM packingorderitems
    WHERE approved = 1 and flagdeleted = 0
        AND unitid = @Unit
    GROUP BY PackingOrderId, unitid, palletno
)
SELECT DISTINCT
    uot.id as id,
    p.palletno,
    c.partytypeid + '-' + c.partyname as PartyName,
    p.PackingOrderId, 
    po.PackingOrderno,
    po.palletIrn,
    lm.name as LocationName,
    ur.username,
    po.marka,
    ig.gradename,
    pq.name as pql,
    rc.recipename,
    RTRIM(vi.vehno) as vehno,
    p.qty AS PackingQty,
    uot.TotalQty as DispatchedQty,
    (p.qty - ISNULL(uot.TotalQty, 0)) AS AvailableQty
FROM UniqueOutwardTemp uot
INNER JOIN dispatch p 
    ON uot.PackingOrderId = p.PackingOrderId 
    AND uot.palletno = p.palletno 
    AND uot.unitid = p.unitid
and uot.dispatcherid=p.DispatcherId 
    AND p.flagdeleted = 0
INNER JOIN UniquePackingOrder po 
    ON p.PackingOrderId = po.PackingOrderId 
    AND p.unitId = po.unitid 
    AND p.palletno = po.palletno
LEFT JOIN party c ON po.partyid = c.partyid
LEFT JOIN itemgrades ig ON po.gradeid = ig.id
LEFT JOIN prodqaul pq ON po.brandid = pq.id
LEFT JOIN Recipe rc ON po.RecipeId = rc.Recipeid
LEFT JOIN location_master lm ON po.LocationId = lm.id 
LEFT JOIN users ur ON p.createdby = ur.userid
LEFT JOIN vehinfo vi ON po.Vehid = vi.vid
WHERE p.PackingOrderId = @OrderId
ORDER BY p.palletno, uot.id;";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };




                cmd.Parameters.AddWithValue("@tempid", tempid);

                cmd.Parameters.AddWithValue("@Unit", unit);
                cmd.Parameters.AddWithValue("@OrderId", orderid);




                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        Outwardid = Convert.ToInt32(rdr["id"]),
                        PalletId = Convert.ToInt32(rdr["palletno"]),
                        PackingOrderIrn = rdr["PackingOrderno"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        PalletName = rdr["palletIrn"].ToString(),
                        DispatchQty = Convert.ToInt32(rdr["PackingQty"]),
                        OutwardQty = Convert.ToInt32(rdr["DispatchedQty"]),
                        Outwardbalance = Convert.ToInt32(rdr["AvailableQty"]),
                        OutwardPackingbalance = Convert.ToInt32(rdr["AvailableQty"]),
                        VarietyId = rdr["pql"].ToString(),
                        ReceipeName = rdr["recipename"].ToString(),
                        ReceipeGrade = rdr["gradename"].ToString(),
                        ReceipeMarka = rdr["marka"].ToString(),
                        Vehno = rdr["vehno"].ToString(),
                        Packingorderid = Convert.ToInt32(rdr["PackingOrderId"]),
                        //PackingQty = Convert.ToInt32(rdr["TotalOrderQty"]),
                        //Recipebalance = Convert.ToInt32(rdr["BalanceQty"]),
                        //totavqty = Convert.ToInt32(rdr["BalanceQty"]),
                    };
                    GetPackingStockTemp.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetPackingStockTemp;
        }






















        public async Task<List<CompanyModel>> GeneratePackingReportEdit(string selectedBankIds, string selectedGradeIds, string selectedRecipeIds, string packgrower, int unit, string pelletno,int orderid)
        {
            List<CompanyModel> GetPackingStock = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {

                const string query = @"SELECT 
    g.draftid,
    g.PackingDraftno,
    c.partytypeid + '-' + c.partyname as PartyName,
    g.Palletno,
    g.marka,
    ig.gradename,
    pq.name,
    rc.recipename,
    g.qty,
    COALESCE(o.TotalOrderQty, 0) AS TotalOrderQty,
    (g.Qty - COALESCE(o.TotalOrderQty, 0)) AS BalanceQty
FROM RepackDraftItems g     
LEFT JOIN (
    SELECT Draftid, palletno, unitid, SUM(Qty) as TotalOrderQty
    FROM packingorderitems 
    WHERE flagdeleted = 0 
    GROUP BY Draftid, palletno, unitid
) o ON g.DraftId = o.Draftid AND g.Palletno = o.palletno AND g.unitid = o.unitid
LEFT JOIN DraftOutTrans dt ON g.DraftId = dt.Draftid 
LEFT JOIN PARTY C ON dt.PARTYID = C.PARTYID
LEFT JOIN itemgrades ig ON g.gradeid = ig.id
LEFT JOIN prodqaul pq ON g.brandid = pq.id
LEFT JOIN Recipe rc ON g.RecipeId = rc.Recipeid
WHERE 
    g.unitid = @Unit   and g.flagdeleted=0 and
g.Palletno not in(select Palletno from packingorderitems where packingorderid=@Orderid and flagdeleted=0)
    AND (CASE WHEN @DraftIds IS NULL THEN 1 ELSE CASE WHEN dt.DraftId IN (SELECT value FROM STRING_SPLIT(@DraftIds, ',')) THEN 1 ELSE 0 END END) = 1
    AND (CASE WHEN @GradeIds IS NULL THEN 1 ELSE CASE WHEN g.gradeid IN (SELECT value FROM STRING_SPLIT(@GradeIds, ',')) THEN 1 ELSE 0 END END) = 1
    AND (CASE WHEN @RecipeIds IS NULL THEN 1 ELSE CASE WHEN g.RecipeId IN (SELECT value FROM STRING_SPLIT(@RecipeIds, ',')) THEN 1 ELSE 0 END END) = 1
    AND (@PackGrower IS NULL OR c.partytypeid + '-' + c.partyname = @PackGrower)
    AND (@Pellet IS NULL OR g.palletIrn = @Pellet)
GROUP BY 
    g.draftid, g.PackingDraftno, c.partytypeid + '-' + c.partyname, 
    g.Palletno, g.marka, ig.gradename, pq.name, rc.recipename, 
    g.qty, COALESCE(o.TotalOrderQty, 0)
	HAVING (g.Qty - COALESCE(o.TotalOrderQty, 0)) > 0
ORDER BY g.Palletno";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                cmd.Parameters.AddWithValue("@DraftIds", selectedBankIds ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@GradeIds", selectedGradeIds ?? (object)DBNull.Value);

                cmd.Parameters.AddWithValue("@RecipeIds", selectedRecipeIds ?? (object)DBNull.Value);

                cmd.Parameters.AddWithValue("@PackGrower", packgrower ?? (object)DBNull.Value);


                cmd.Parameters.AddWithValue("@Unit", unit);

                cmd.Parameters.AddWithValue("@Pellet", pelletno ?? (object)DBNull.Value);
                      cmd.Parameters.AddWithValue("@Orderid", orderid);
                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        DraftId = Convert.ToInt32(rdr["draftid"]),
                        DraftIrn = rdr["PackingDraftno"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        PalletId = Convert.ToInt32(rdr["Palletno"]),
                        ReceipeMarka = rdr["marka"].ToString(),
                        ReceipeGrade = rdr["gradename"].ToString(),

                        VarietyId = rdr["name"].ToString(),
                        ReceipeName = rdr["recipename"].ToString(),

                        ReceipeQty = Convert.ToInt32(rdr["qty"]),
                        PackingQty = Convert.ToInt32(rdr["TotalOrderQty"]),
                        Recipebalance = Convert.ToInt32(rdr["BalanceQty"]),
                        totavqty = Convert.ToInt32(rdr["BalanceQty"]),
                    };
                    GetPackingStock.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetPackingStock;
        }






















        public async Task<List<CompanyModel>> GenerateSinglePackingReport(int outid)
        {
            List<CompanyModel> GetPackingStockEdit = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {

                const string query = @"SELECT 
    g.Packingdraftitemid,
    g.draftid,
    g.draftirn,
    c.partytypeid + '-' + c.partyname as PartyName,
    g.Palletno,
    g.marka,
    ig.gradename,
    pq.name,
    rc.recipename,g.qty as TotalOrderQty,
    COALESCE(o.TotalOrderQty, 0) AS Qty,
    pallet_totals.TotalPalletQty as PalletQty,
    (COALESCE(o.TotalOrderQty, 0) - pallet_totals.TotalPalletQty) AS BalanceQty,
    COALESCE(d.DispatchedQty, 0) AS DispatchedQty
FROM PackingOrderItems g 
LEFT JOIN (
    SELECT Draftid, palletno, unitid, SUM(Qty) as TotalOrderQty
    FROM RepackDraftItems 
    WHERE flagdeleted = 0
    GROUP BY Draftid, palletno, unitid
) o ON g.DraftId = o.Draftid AND g.Palletno = o.palletno AND g.unitid = o.unitid
LEFT JOIN (
    SELECT palletno, unitid, SUM(Qty) as DispatchedQty
    FROM dispatch 
    WHERE flagdeleted = 0
    GROUP BY palletno, unitid
) d ON g.Palletno = d.palletno AND g.unitid = d.unitid
LEFT JOIN (
    SELECT palletno, unitid, SUM(qty) as TotalPalletQty
    FROM PackingOrderItems 
    WHERE flagdeleted = 0
    GROUP BY palletno, unitid
) pallet_totals ON g.Palletno = pallet_totals.palletno AND g.unitid = pallet_totals.unitid
LEFT JOIN DraftOutTrans dt ON g.DraftId = dt.Draftid 
LEFT JOIN PARTY C ON g.PARTYID = C.PARTYID
LEFT JOIN itemgrades ig ON g.gradeid = ig.id
LEFT JOIN prodqaul pq ON g.brandid = pq.id
LEFT JOIN Recipe rc ON g.RecipeId = rc.Recipeid
WHERE 
    g.packingorderid =@outid and g.flagdeleted=0 
GROUP BY 
    g.Packingdraftitemid,
    g.draftid, 
    g.draftirn, 
    c.partytypeid + '-' + c.partyname, 
    g.Palletno, 
    g.marka, 
    ig.gradename, 
    pq.name, 
    rc.recipename, 
    g.qty, 
    COALESCE(o.TotalOrderQty, 0),
    COALESCE(d.DispatchedQty, 0),
    pallet_totals.TotalPalletQty
ORDER BY g.Palletno";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

              
                cmd.Parameters.AddWithValue("@outid", outid);

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        PackingId = Convert.ToInt32(rdr["Packingdraftitemid"]),
                        DraftId = Convert.ToInt32(rdr["draftid"]),
                        DraftIrn = rdr["draftIrn"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        PalletId = Convert.ToInt32(rdr["Palletno"]),
                        ReceipeMarka = rdr["marka"].ToString(),
                        ReceipeGrade = rdr["gradename"].ToString(),
                        PelletQty= Convert.ToInt32(rdr["PalletQty"]),
                        VarietyId = rdr["name"].ToString(),
                        ReceipeName = rdr["recipename"].ToString(),
                        DispatchQty= Convert.ToInt32(rdr["DispatchedQty"]),
                        ReceipeQty = Convert.ToInt32(rdr["qty"]),
                        PackingQty = Convert.ToInt32(rdr["TotalOrderQty"]),
                        selectedPackingQty = Convert.ToInt32(rdr["TotalOrderQty"]),
                        Recipebalance = Convert.ToInt32(rdr["BalanceQty"]),
                        totavqty = Convert.ToInt32(rdr["BalanceQty"]),
                    };
                    GetPackingStockEdit.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetPackingStockEdit;
        }







        public async Task<List<CompanyModel>> GenerateLotDraftReport(int Tempid,string dirn)
        {
            List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("GenerateDraftReport", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;

                    cmd3.Parameters.AddWithValue("@Tempid", Tempid);
                    cmd3.Parameters.AddWithValue("@Dirn", dirn);


                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"SELECT g.outid,
    g.LOTNO,g.lotirn,
    g.VerifiedQty AS GateInQty,c.partytypeid  +'-'+ c.partyname as PartyName,  CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
     COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0) AS TotalOutQty,
    (g.OrderQty - COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0)) AS BalanceQty,g.verifiedQty ,prt.name as itemname, pt.name as package,g.khataname,pq.name as quality,g.locationchamberid,
	isnull(FloorName+space(1)+lf.MatrixName+lf.RowName+space(1)+lf.ColumnName ,'NA') as tlocation,g.locationchamberid as chamber,cm.ChallanName,st.sname
FROM StoreOutTransrep g
LEFT JOIN DraftOutTrans  o ON g.LOTNO = o.LOTNO
LEFT JOIN PARTY C ON G.PARTYID = C.PARTYID
LEFT JOIN PARTYsub ps ON G.GrowerId = PS.PARTYID
LEFT JOIN prodtype prt ON g.itemid = prt.id
LEFT JOIN PTYPE pt ON g.packageid = pt.id
LEFT JOIN prodqaul pq ON g.varietyid = pq.id
LEFT JOIN challanmaster cm ON g.challanid = cm.id  
LEFT JOIN servicetypes st ON g.schemeid = st.id
LEFT JOIN locationFinal lf ON g.lotno =lf.lotno
where g.demandIrn=@Dirn and g.TempDraftid=@Tempid
GROUP BY g.outid,g.OrderQty,g.LOTNO, g.VerifiedQty,c.partytypeid  +'-'+ c.partyname,convert(varchar(max),ps.partyid)  +'-'+ ps.partyname,prt.name ,pt.name,g.khataname,pq.name,cm.ChallanName,st.sname,
FloorName+space(1)+lf.MatrixName+lf.RowName+space(1)+lf.ColumnName,g.locationchamberid,g.lotirn
having  (g.VerifiedQty - COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0)) >0
ORDER BY g.LOTNO";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Tempid", Tempid);
                cmd.Parameters.AddWithValue("@Dirn", dirn);

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        DemandNo = Convert.ToInt32(rdr["outid"]),

                        Lotno = Convert.ToInt32(rdr["LOTNO"]),
                        LotIrn = rdr["lotirn"].ToString(),
                        //GrowerGroupName = rdr["PartyName"].ToString(),

                        GrowerCombine = rdr["PartyName"].ToString() + " " + rdr["GrowerName"].ToString(),
                        VerfiedQty = Convert.ToInt32(rdr["GateInQty"]),
                        GradingQty  = Convert.ToInt32(rdr["TotalOutQty"]),
                        Lotbalance = Convert.ToInt32(rdr["BalanceQty"]),
                        TotalStoreOut = Convert.ToInt32(rdr["BalanceQty"]),

                        ItemName = rdr["itemname"].ToString(),
                        Prodetails = rdr["package"].ToString(),
                        PreInwardKhata = rdr["khataname"].ToString(),
                        VarietyId = rdr["quality"].ToString(),
                        ChamberId = Convert.ToInt32(rdr["locationchamberid"]),
                        Templocation = rdr["tlocation"].ToString(),
                        ChallanName = rdr["ChallanName"].ToString(),
                        ServiceId = rdr["sname"].ToString(),
                    };
                    GetDailyPreinward.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinward;
        }




        public async Task<List<CompanyModel>> GenerateLotDraftReportopen(int Tempid, string dirn)
        {
            List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("GenerateDraftReportopen", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;

                    cmd3.Parameters.AddWithValue("@Tempid", Tempid);
                    cmd3.Parameters.AddWithValue("@Dirn", dirn);


                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"SELECT g.id,g.outid,
    g.LOTNO,g.lotirn,
    g.VerifiedQty AS GateInQty,c.partytypeid  +'-'+ c.partyname as PartyName,  CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
     COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0) AS TotalOutQty,
    (g.OrderQty - COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0)) AS BalanceQty,g.verifiedQty ,prt.name as itemname, pt.name as package,g.khataname,pq.name as quality,g.locationchamberid,
	isnull(FloorName+space(1)+lf.MatrixName+lf.RowName+space(1)+lf.ColumnName ,'NA') as tlocation,g.locationchamberid as chamber,cm.ChallanName,st.sname
FROM StoreOutTransrep g
LEFT JOIN DraftOutTrans  o ON g.LOTNO = o.LOTNO
LEFT JOIN PARTY C ON G.PARTYID = C.PARTYID
LEFT JOIN PARTYsub ps ON G.GrowerId = PS.PARTYID
LEFT JOIN prodtype prt ON g.itemid = prt.id
LEFT JOIN PTYPE pt ON g.packageid = pt.id
LEFT JOIN prodqaul pq ON g.varietyid = pq.id
LEFT JOIN challanmaster cm ON g.challanid = cm.id  
LEFT JOIN servicetypes st ON g.schemeid = st.id
LEFT JOIN locationFinal lf ON g.lotno =lf.lotno
where g.demandIrn=@Dirn and g.TempDraftid=@Tempid
GROUP BY g.id,g.outid,g.OrderQty,g.LOTNO, g.VerifiedQty,c.partytypeid  +'-'+ c.partyname,convert(varchar(max),ps.partyid)  +'-'+ ps.partyname,prt.name ,pt.name,g.khataname,pq.name,cm.ChallanName,st.sname,
FloorName+space(1)+lf.MatrixName+lf.RowName+space(1)+lf.ColumnName,g.locationchamberid,g.lotirn
having  (g.VerifiedQty - COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0)) >0
ORDER BY g.LOTNO";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Tempid", Tempid);
                cmd.Parameters.AddWithValue("@Dirn", dirn);

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        DemandNo = Convert.ToInt32(rdr["outid"]),
                        Storeintid = Convert.ToInt32(rdr["id"]),
                        Lotno = Convert.ToInt32(rdr["LOTNO"]),
                        LotIrn = rdr["lotirn"].ToString(),
                        //GrowerGroupName = rdr["PartyName"].ToString(),

                        GrowerCombine = rdr["PartyName"].ToString() + " " + rdr["GrowerName"].ToString(),
                        VerfiedQty = Convert.ToInt32(rdr["GateInQty"]),
                        GradingQty = Convert.ToInt32(rdr["TotalOutQty"]),
                        Lotbalance = Convert.ToInt32(rdr["BalanceQty"]),
                        TotalStoreOut = Convert.ToInt32(rdr["BalanceQty"]),

                        ItemName = rdr["itemname"].ToString(),
                        Prodetails = rdr["package"].ToString(),
                        PreInwardKhata = rdr["khataname"].ToString(),
                        VarietyId = rdr["quality"].ToString(),
                        ChamberId = Convert.ToInt32(rdr["locationchamberid"]),
                        Templocation = rdr["tlocation"].ToString(),
                        ChallanName = rdr["ChallanName"].ToString(),
                        ServiceId = rdr["sname"].ToString(),
                    };
                    GetDailyPreinward.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinward;
        }



























        public async Task<List<CompanyModel>> GenerateLotReportwithtemp(CompanyModel EditModel, int unit,int tempid)
        {
            List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("GenerateLotReporttemp", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;

                    cmd3.Parameters.AddWithValue("@Partyid", EditModel.Partyid);
                    cmd3.Parameters.AddWithValue("@Groowerid", EditModel.Growerid);

                    cmd3.Parameters.AddWithValue("@varietyid", EditModel.VarietyId);

                    cmd3.Parameters.AddWithValue("@chamberid", EditModel.ChamberName);
                    cmd3.Parameters.AddWithValue("@LotId", EditModel.LotIrn);


                    cmd3.Parameters.AddWithValue("@unit", unit);
                    cmd3.Parameters.AddWithValue("@Tempid", tempid);


                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"SELECT 
    g.LOTNO,g.lotirn,
    g.VerifiedQty AS GateInQty,c.partytypeid  +'-'+ c.partyname as PartyName,  CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
      COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0) AS TotalOutQty,
    (g.VerifiedQty - COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0)) AS BalanceQty,g.verifiedQty ,prt.name as itemname, pt.name as package,g.khataname,pq.name as quality,
	isnull(FloorName+space(1)+lf.MatrixName+lf.RowName+space(1)+lf.ColumnName ,'NA') as tlocation,cr.chambername as chamber,cm.ChallanName,st.sname
FROM GateInTransrep g
LEFT JOIN LOTOUTTRANS o ON g.LOTNO = o.LOTNO
LEFT JOIN PARTY C ON G.PARTYID = C.PARTYID
LEFT JOIN PARTYsub ps ON G.GrowerId = PS.PARTYID
LEFT JOIN prodtype prt ON g.itemid = prt.id
LEFT JOIN PTYPE pt ON g.packageid = pt.id
LEFT JOIN prodqaul pq ON g.varietyid = pq.id
LEFT JOIN challanmaster cm ON g.challanid = cm.id  
LEFT JOIN servicetypes st ON g.schemeid = st.id
LEFT JOIN locationFinal lf ON g.lotno =lf.lotno
left JOIN chamber cr ON g.locationchamberid =cr.chamberid
GROUP BY cr.chambername,g.LOTNO, g.VerifiedQty,c.partytypeid  +'-'+ c.partyname,convert(varchar(max),ps.partyid)  +'-'+ ps.partyname,prt.name ,pt.name,g.khataname,pq.name,cm.ChallanName,st.sname,
FloorName+space(1)+lf.MatrixName+lf.RowName+space(1)+lf.ColumnName,g.lotirn
having  (g.VerifiedQty - COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0)) >0
ORDER BY g.LOTNO";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Lotno = Convert.ToInt32(rdr["LOTNO"]),
                        LotIrn = rdr["lotirn"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        Alotbal = Convert.ToInt32(rdr["BalanceQty"]),
                        GrowerName = rdr["GrowerName"].ToString(),
                        GrowerCombine = rdr["PartyName"].ToString() + " " + rdr["GrowerName"].ToString(),
                        VerfiedQty = Convert.ToInt32(rdr["GateInQty"]),
                        OutQty = Convert.ToInt32(rdr["TotalOutQty"]),
                        Lotbalance = Convert.ToInt32(rdr["BalanceQty"]),
                        ItemName = rdr["itemname"].ToString(),
                        Prodetails = rdr["package"].ToString(),
                        PreInwardKhata = rdr["khataname"].ToString(),
                        VarietyId = rdr["quality"].ToString(),
                        ChamberName = rdr["chamber"].ToString(),
                        Templocation = rdr["tlocation"].ToString(),
                        ChallanName = rdr["ChallanName"].ToString(),
                        ServiceId = rdr["sname"].ToString(),
                    };
                    GetDailyPreinward.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinward;
        }

        public async Task<List<CompanyModel>>  GeneraterawReportwithtemp(CompanyModel EditModel, int unit, int tempid)
        {
            List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("GenerateLotReporttemp", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;

                    cmd3.Parameters.AddWithValue("@Partyid", EditModel.Partyid);
                    cmd3.Parameters.AddWithValue("@Groowerid", EditModel.Growerid);

                    cmd3.Parameters.AddWithValue("@varietyid", EditModel.VarietyId);

                    cmd3.Parameters.AddWithValue("@chamberid", EditModel.ChamberName);
                    cmd3.Parameters.AddWithValue("@LotId", EditModel.LotIrn);


                    cmd3.Parameters.AddWithValue("@unit", unit);
                    cmd3.Parameters.AddWithValue("@Tempid", tempid);


                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"SELECT 
    g.LOTNO,
    g.lotirn,
    g.VerifiedQty AS GateInQty,
    c.partytypeid + '-' + c.partyname as PartyName,  
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
    COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0) AS TotalOutQty,
    COALESCE(SUM(CASE WHEN t.flagdeleted = 0 AND t.partyid = g.partyid AND t.growerid = g.growerid 
                      THEN t.orderqty ELSE 0 END), 0) AS TransferOutQty,
    COALESCE(SUM(CASE WHEN t.flagdeleted = 0 AND t.topartyid = g.partyid AND t.togrowerid = g.growerid 
                      THEN t.orderqty ELSE 0 END), 0) AS TransferInQty,
    (g.VerifiedQty 
     - COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0)
     - COALESCE(SUM(CASE WHEN t.flagdeleted = 0 AND t.partyid = g.partyid AND t.growerid = g.growerid 
                         THEN t.orderqty ELSE 0 END), 0)
     + COALESCE(SUM(CASE WHEN t.flagdeleted = 0 AND t.topartyid = g.partyid AND t.togrowerid = g.growerid 
                         THEN t.orderqty ELSE 0 END), 0)
    ) AS BalanceQty,
    g.verifiedQty,
    prt.name as itemname, 
    pt.name as package,
    g.khataname,
    pq.name as quality,
    ISNULL(FloorName + space(1) + lf.MatrixName + lf.RowName + space(1) + lf.ColumnName, 'NA') as tlocation,
    cr.chambername as chamber,
    cm.ChallanName,
    st.sname
FROM GateInTrans g
LEFT JOIN LOTOUTTRANS o ON g.LOTNO = o.LOTNO 
   
LEFT JOIN TransferOutTrans t ON g.LOTNO = t.LOTNO 
  
LEFT JOIN PARTY C ON G.PARTYID = C.PARTYID
LEFT JOIN PARTYsub ps ON G.GrowerId = PS.PARTYID
LEFT JOIN prodtype prt ON g.itemid = prt.id
LEFT JOIN PTYPE pt ON g.packageid = pt.id
LEFT JOIN prodqaul pq ON g.varietyid = pq.id
LEFT JOIN challanmaster cm ON g.challanid = cm.id  
LEFT JOIN servicetypes st ON g.schemeid = st.id
LEFT JOIN locationFinal lf ON g.lotno = lf.lotno
LEFT JOIN chamber cr ON g.locationchamberid = cr.chamberid


GROUP BY 
    g.LOTNO, 
    g.lotirn,
    g.VerifiedQty,
    c.partytypeid + '-' + c.partyname,
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname,
    prt.name,
    pt.name,
    g.khataname,
    pq.name,
    cm.ChallanName,
    st.sname,
    FloorName + space(1) + lf.MatrixName + lf.RowName + space(1) + lf.ColumnName,
    cr.chambername
	HAVING 
    (g.VerifiedQty 
     - COALESCE(SUM(CASE WHEN o.flagdeleted = 0 THEN o.OrderQty ELSE 0 END), 0)
     - COALESCE(SUM(CASE WHEN t.flagdeleted = 0 AND t.partyid = g.partyid
                         THEN t.orderqty ELSE 0 END), 0)
     + COALESCE(SUM(CASE WHEN t.flagdeleted = 0 AND t.topartyid = g.partyid
                         THEN t.orderqty ELSE 0 END), 0)
    ) > 0

ORDER BY g.LOTNO";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Lotno = Convert.ToInt32(rdr["LOTNO"]),
                        LotIrn = rdr["lotirn"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        Alotbal = Convert.ToInt32(rdr["BalanceQty"]),
                        GrowerName = rdr["GrowerName"].ToString(),
                        GrowerCombine = rdr["PartyName"].ToString() + " " + rdr["GrowerName"].ToString(),
                        VerfiedQty = Convert.ToInt32(rdr["GateInQty"]),
                        OutQty = Convert.ToInt32(rdr["TotalOutQty"]),
                        Lotbalance = Convert.ToInt32(rdr["BalanceQty"]),
                        ItemName = rdr["itemname"].ToString(),
                        Prodetails = rdr["package"].ToString(),
                        PreInwardKhata = rdr["khataname"].ToString(),
                        VarietyId = rdr["quality"].ToString(),
                        ChamberName = rdr["chamber"].ToString(),
                        Templocation = rdr["tlocation"].ToString(),
                        ChallanName = rdr["ChallanName"].ToString(),
                        ServiceId = rdr["sname"].ToString(),
                    };
                    GetDailyPreinward.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinward;
        }


        public async Task<List<CompanyModel>> GenerateTempLotReport(CompanyModel EditModel, int unit,int Tempid)
        {
            List<CompanyModel> GetDailyPreinwardTemp = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT 
    g.LOTNO,g.lotirn,
    g.VerifiedQty AS GateInQty,c.partytypeid  +'-'+ c.partyname as PartyName,  CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
    g.orderqty AS OrderQty, g.orderqty AS OrderQty,  g.verifiedQty-g.OrderQty as NetQty,
    (g.VerifiedQty - COALESCE(SUM(o.QTY), 0)) AS BalanceQty,g.verifiedQty ,prt.name as itemname, pt.name as package,g.khataname,pq.name as quality,
	lf.FinalLocationText as tlocation,cr.Chambername as chamber,cm.ChallanName,st.sname
FROM LotOutTranstemp g

LEFT JOIN LOTOUTTRANS o ON g.LOTNO = o.LOTNO
LEFT JOIN PARTY C ON G.PARTYID = C.PARTYID
LEFT JOIN PARTYsub ps ON G.GrowerId = PS.PARTYID
LEFT JOIN prodtype prt ON g.itemid = prt.id
LEFT JOIN PTYPE pt ON g.packageid = pt.id
LEFT JOIN prodqaul pq ON g.varietyid = pq.id
LEFT JOIN challanmaster cm ON g.challanid = cm.id  
LEFT JOIN servicetypes st ON g.schemeid = st.id
LEFT JOIN chamber cr ON g.locationchamberid =cr.chamberid

LEFT JOIN locationFinal lf ON g.lotno =lf.lotno
where g.tempid=@Tempid and g.unitid=@unit
GROUP BY g.orderqty,g.LOTNO, g.VerifiedQty,c.partytypeid  +'-'+ c.partyname ,  CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname,prt.name ,pt.name,g.khataname,pq.name,cm.ChallanName,st.sname,
FinalLocationText,cr.Chambername,g.lotirn

ORDER BY g.LOTNO";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Tempid", Tempid);
                cmd.Parameters.AddWithValue("@unit", unit);
                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Lotno = Convert.ToInt32(rdr["LOTNO"]),
                        LotIrn = rdr["lotirn"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                        OrderQty = Convert.ToInt32(rdr["OrderQty"]),
                        GrowerCombine = rdr["PartyName"].ToString() + " " + rdr["GrowerName"].ToString(),
                        Netqty= Convert.ToInt32(rdr["NetQty"]),
                        VerfiedQty = Convert.ToInt32(rdr["VerifiedQty"]),
                        //OutQty = Convert.ToInt32(rdr["TotalOutQty"]),
                        Alotbal = Convert.ToInt32(rdr["BalanceQty"]),
                        ItemName = rdr["itemname"].ToString(),
                        Prodetails = rdr["package"].ToString(),
                        PreInwardKhata = rdr["khataname"].ToString(),
                        VarietyId = rdr["quality"].ToString(),
                        ChamberName = rdr["Chamber"].ToString(),
                        Templocation = rdr["tlocation"].ToString(),
                        ChallanName = rdr["ChallanName"].ToString(),
                        ServiceId = rdr["sname"].ToString(),
                    };
                    GetDailyPreinwardTemp.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinwardTemp;
        }




        public async Task<List<CompanyModel>> GenerateTempLotReportEdit(CompanyModel EditModel, int unit, int Tempid)
        {
            List<CompanyModel> GetDailyPreinwardTemp = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("ProcessEditDemand", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;

                   
                    cmd3.Parameters.AddWithValue("@Tempid", Tempid);
                  
                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"SELECT g.Tempid,
    g.LOTNO,g.lotirn,
    g.VerifiedQty AS GateInQty,c.partytypeid  +'-'+ c.partyname as PartyName,  CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
    g.orderqty AS OrderQty, g.orderqty AS OrderQty,  g.verifiedQty-g.OrderQty as NetQty,
    (g.VerifiedQty - COALESCE(SUM(o.OrderQty), 0)) AS BalanceQty,g.verifiedQty ,prt.name as itemname, pt.name as package,g.khataname,pq.name as quality,g.locationchamberid,
	isnull(FloorName+space(1)+lf.MatrixName+lf.RowName+space(1)+lf.ColumnName ,'NA') as tlocation,g.locationchamberid as chamber,cm.ChallanName,st.sname
FROM LotOutTranstemp g

LEFT JOIN LOTOUTTRANS o ON g.LOTNO = o.LOTNO
LEFT JOIN PARTY C ON G.PARTYID = C.PARTYID
LEFT JOIN PARTYsub ps ON G.GrowerId = PS.PARTYID
LEFT JOIN prodtype prt ON g.itemid = prt.id
LEFT JOIN PTYPE pt ON g.packageid = pt.id
LEFT JOIN prodqaul pq ON g.varietyid = pq.id
LEFT JOIN challanmaster cm ON g.challanid = cm.id  
LEFT JOIN servicetypes st ON g.schemeid = st.id
LEFT JOIN locationFinal lf ON g.lotno =lf.lotno
where g.tempid in(select tempid from LotOutTranstemp where outid=@Tempid) and g.unitid=@unit and o.flagdeleted=0
GROUP BY  g.Tempid,g.orderqty,g.LOTNO, g.VerifiedQty,c.partytypeid  +'-'+ c.partyname ,  CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname,prt.name ,pt.name,g.khataname,pq.name,cm.ChallanName,st.sname,
FloorName+space(1)+lf.MatrixName+lf.RowName+space(1)+lf.ColumnName,g.locationchamberid,g.lotirn

ORDER BY g.LOTNO";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Tempid", Tempid);
                cmd.Parameters.AddWithValue("@unit", unit);
                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Lotno = Convert.ToInt32(rdr["LOTNO"]),
                        LotIrn = rdr["lotirn"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        OrderQty = Convert.ToInt32(rdr["OrderQty"]),
                        GrowerCombine = rdr["PartyName"].ToString() + " " + rdr["GrowerName"].ToString(),
                        Netqty = Convert.ToInt32(rdr["NetQty"]),
                        VerfiedQty = Convert.ToInt32(rdr["VerifiedQty"]),
                        //OutQty = Convert.ToInt32(rdr["TotalOutQty"]),
                        Alotbal = Convert.ToInt32(rdr["BalanceQty"])+ Convert.ToInt32(rdr["OrderQty"]),
                        ItemName = rdr["itemname"].ToString(),
                        Prodetails = rdr["package"].ToString(),
                        PreInwardKhata = rdr["khataname"].ToString(),
                        VarietyId = rdr["quality"].ToString(),
                        ChamberId = Convert.ToInt32(rdr["locationchamberid"]),
                        Templocation = rdr["tlocation"].ToString(),
                        ChallanName = rdr["ChallanName"].ToString(),
                        ServiceId = rdr["sname"].ToString(),
                    };
                    GetDailyPreinwardTemp.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinwardTemp;
        }

        public async Task<List<CompanyModel>> GenerateTempLotRawReportEdit(CompanyModel EditModel, int unit, int Tempid)
        {
            List<CompanyModel> GetDailyPreinwardTemp = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("ProcessEditDemandRaw", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;


                    cmd3.Parameters.AddWithValue("@Tempid", Tempid);

                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"SELECT g.Tempid,
    g.LOTNO,g.lotirn,
    g.VerifiedQty AS GateInQty,c.partytypeid  +'-'+ c.partyname as PartyName,  CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
    g.orderqty AS OrderQty, g.orderqty AS OrderQty,  g.verifiedQty-g.OrderQty as NetQty,
    (g.VerifiedQty - COALESCE(SUM(o.OrderQty), 0)) AS BalanceQty,g.verifiedQty ,prt.name as itemname, pt.name as package,g.khataname,pq.name as quality,g.locationchamberid,
	isnull(FloorName+space(1)+lf.MatrixName+lf.RowName+space(1)+lf.ColumnName ,'NA') as tlocation,g.locationchamberid as chamber,cm.ChallanName,st.sname
FROM LotOutTranstemp g

LEFT JOIN LOTOUTTRANS o ON g.LOTNO = o.LOTNO
LEFT JOIN PARTY C ON G.PARTYID = C.PARTYID
LEFT JOIN PARTYsub ps ON G.GrowerId = PS.PARTYID
LEFT JOIN prodtype prt ON g.itemid = prt.id
LEFT JOIN PTYPE pt ON g.packageid = pt.id
LEFT JOIN prodqaul pq ON g.varietyid = pq.id
LEFT JOIN challanmaster cm ON g.challanid = cm.id  
LEFT JOIN servicetypes st ON g.schemeid = st.id
LEFT JOIN locationFinal lf ON g.lotno =lf.lotno
where g.tempid in(select tempid from LotOutTranstemp where outid=@Tempid) and g.unitid=@unit and g.flagdeleted=0
GROUP BY  g.Tempid,g.orderqty,g.LOTNO, g.VerifiedQty,c.partytypeid  +'-'+ c.partyname ,  CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname,prt.name ,pt.name,g.khataname,pq.name,cm.ChallanName,st.sname,
FloorName+space(1)+lf.MatrixName+lf.RowName+space(1)+lf.ColumnName,g.locationchamberid,g.lotirn

ORDER BY g.LOTNO";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Tempid", Tempid);
                cmd.Parameters.AddWithValue("@unit", unit);
                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Lotno = Convert.ToInt32(rdr["LOTNO"]),
                        LotIrn = rdr["lotirn"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        OrderQty = Convert.ToInt32(rdr["OrderQty"]),
                        GrowerCombine = rdr["PartyName"].ToString() + " " + rdr["GrowerName"].ToString(),
                        Netqty = Convert.ToInt32(rdr["NetQty"]),
                        VerfiedQty = Convert.ToInt32(rdr["VerifiedQty"]),
                        //OutQty = Convert.ToInt32(rdr["TotalOutQty"]),
                        Alotbal = Convert.ToInt32(rdr["BalanceQty"]) + Convert.ToInt32(rdr["OrderQty"]),
                        ItemName = rdr["itemname"].ToString(),
                        Prodetails = rdr["package"].ToString(),
                        PreInwardKhata = rdr["khataname"].ToString(),
                        VarietyId = rdr["quality"].ToString(),
                        ChamberId = Convert.ToInt32(rdr["locationchamberid"]),
                        Templocation = rdr["tlocation"].ToString(),
                        ChallanName = rdr["ChallanName"].ToString(),
                        ServiceId = rdr["sname"].ToString(),
                    };
                    GetDailyPreinwardTemp.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinwardTemp;
        }


        public async Task<List<CompanyModel>> GenerateTempLotReportEditTemp(CompanyModel EditModel, int unit, int Tempid)
        {
            List<CompanyModel> GetDailyPreinwardTemp = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT g.Tempid,
    g.LOTNO,g.lotirn,
    g.VerifiedQty AS GateInQty,c.partytypeid  +'-'+ c.partyname as PartyName,  CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
    g.orderqty AS OrderQty, g.orderqty AS OrderQty,  isnull(g.verifiedQty-g.OrderQty,0) as NetQty,
    (g.VerifiedQty - COALESCE(SUM(o.OrderQty), 0)) AS BalanceQty,g.verifiedQty ,prt.name as itemname, pt.name as package,g.khataname,pq.name as quality,g.locationchamberid,
	isnull(FloorName+space(1)+lf.MatrixName+lf.RowName+space(1)+lf.ColumnName ,'NA') as tlocation,g.locationchamberid as chamber,cm.ChallanName,st.sname
FROM LotOutTranstemp g

LEFT JOIN LOTOUTTRANS o ON g.LOTNO = o.LOTNO
LEFT JOIN PARTY C ON G.PARTYID = C.PARTYID
LEFT JOIN PARTYsub ps ON G.GrowerId = PS.PARTYID
LEFT JOIN prodtype prt ON g.itemid = prt.id
LEFT JOIN PTYPE pt ON g.packageid = pt.id
LEFT JOIN prodqaul pq ON g.varietyid = pq.id
LEFT JOIN challanmaster cm ON g.challanid = cm.id  
LEFT JOIN servicetypes st ON g.schemeid = st.id
LEFT JOIN locationFinal lf ON g.lotno =lf.lotno
where g.tempid in(select tempid from LotOutTranstemp where outid=@Tempid) and g.unitid=@unit
GROUP BY  g.Tempid,g.orderqty,g.LOTNO, g.VerifiedQty,c.partytypeid  +'-'+ c.partyname ,  CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname,prt.name ,pt.name,g.khataname,pq.name,cm.ChallanName,st.sname,
FloorName+space(1)+lf.MatrixName+lf.RowName+space(1)+lf.ColumnName,g.locationchamberid,g.lotirn

ORDER BY g.LOTNO";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Tempid", Tempid);
                cmd.Parameters.AddWithValue("@unit", unit);
                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Lotno = Convert.ToInt32(rdr["LOTNO"]),
                        LotIrn = rdr["lotirn"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        OrderQty = Convert.ToInt32(rdr["OrderQty"]),
                        GrowerCombine = rdr["PartyName"].ToString() + " " + rdr["GrowerName"].ToString(),
                        Netqty = Convert.ToInt32(rdr["NetQty"]),
                        VerfiedQty = Convert.ToInt32(rdr["VerifiedQty"]),
                        //OutQty = Convert.ToInt32(rdr["TotalOutQty"]),
                        Alotbal = Convert.ToInt32(rdr["BalanceQty"]) + Convert.ToInt32(rdr["OrderQty"]),
                        ItemName = rdr["itemname"].ToString(),
                        Prodetails = rdr["package"].ToString(),
                        PreInwardKhata = rdr["khataname"].ToString(),
                        VarietyId = rdr["quality"].ToString(),
                        ChamberId = Convert.ToInt32(rdr["locationchamberid"]),
                        Templocation = rdr["tlocation"].ToString(),
                        ChallanName = rdr["ChallanName"].ToString(),
                        ServiceId = rdr["sname"].ToString(),
                    };
                    GetDailyPreinwardTemp.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinwardTemp;
        }













        public async Task<List<CompanyModel>> GetCrateSummarySubgrower(string GrowerGroupNameCrates)
        {
            List<CompanyModel> GetDailyCrates = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd3 = new SqlCommand("CratesummarySub", con))
                {
                    cmd3.CommandType = CommandType.StoredProcedure;

                    cmd3.Parameters.AddWithValue("@partyname", GrowerGroupNameCrates);


                    await cmd3.ExecuteNonQueryAsync();
                }
                con.Close();
                const string query = @"select b. partytypeid  +'-'+ b.partyname as Partyname,convert(varchar(max),c.partyid)  +'-'+ c.partyname as GrowerName,a.Agreement,a.crateissue,a.Cratereceive as Filled,a.EmptyReceive as Empty,adjgiven as Adjustmentto,adjreceived as Adjustmentreceive,
(crateissue+adjreceived)-(crateReceive+emptyReceive+adjgiven) as CrBalance,GrowerReceive,GrowerReturn,GrowerReceive-GrowerReturn as SelfBalance,
pettyReceive,PettyReturn,pettyReceive-PettyReturn as Pbalance from CrateAnalysissummary a,party b,partysub c where a.partyid=b.partyid 
and  a.partyid=c.mainid and a.subid=c.partyid
order by a.partyid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        GrowerGroupName = rdr["Partyname"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),

                        CrateAgreement = Convert.ToDecimal(rdr["Agreement"]),
                        CrateIssue = Convert.ToDecimal(rdr["crateissue"]),
                        CrateReceive = Convert.ToDecimal(rdr["Filled"]),
                        EmptyReceive = Convert.ToDecimal(rdr["Empty"]),
                        CrateBalance = Convert.ToDecimal(rdr["CrBalance"]),
                        SelfCrateReceive = Convert.ToDecimal(rdr["GrowerReceive"]),
                        EmptyReturn = Convert.ToDecimal(rdr["GrowerReturn"]),
                        SelfCrateBalance = Convert.ToDecimal(rdr["SelfBalance"]),
                        PettyReceive = Convert.ToDecimal(rdr["pettyReceive"]),
                        PettyReturn = Convert.ToDecimal(rdr["PettyReturn"]),
                        PettyBalance = Convert.ToDecimal(rdr["Pbalance"]),
                        CrateAdjustmentGiven = Convert.ToDecimal(rdr["Adjustmentto"]),
                        CrateAdjustmentTaken = Convert.ToDecimal(rdr["Adjustmentreceive"]),




                    };
                    GetDailyCrates.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyCrates;
        }





















        public async Task<List<CompanyModel>> GetDailyCratesProcBydate(DateTime DateFrom, DateTime Dateto)
        {
            List<CompanyModel> GetDailyCrates = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT
    ci.cid,ci.Trno,

    ci.Dated,
	p.partytypeid  +'-'+ p.partyname AS PartyName,
 convert(varchar(max),ps.partyid)  +'-'+ ps.partyname AS GrowerName,
   convert(varchar(max),cm.id)  +'-'+ cm.ChallanName as ChallanName,
       rtrim(vi.vehno) + space(1)+'('+ rtrim(vi.drivername)+space(1)+')'+space(1)+'('+rtrim(vi.contactno)+')' as vehno,


	ci.CrateMark,
    ci.qty,
    ci.trflag,
ci.Remarks
FROM crateissue ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.groowerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
WHERE ci.Trflag='Crate Issue' and ci.flagdeleted=0 and CONVERT(date, ci.Dated) >= CONVERT(date, @DateFrom) and CONVERT(date, ci.Dated) <= CONVERT(date, @Dateto) order by ci.cid desc";
                SqlCommand cmd = new SqlCommand(query, con)


                {

                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@DateFrom", DateFrom);
                cmd.Parameters.AddWithValue("@Dateto", Dateto);
                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        CrissueId = Convert.ToInt32(rdr["cid"]),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                        ChallanName = rdr["challanname"].ToString(),
                        Vehno = rdr["vehno"].ToString(),
                        CrissueMark = rdr["CrateMark"].ToString(),
                        CrissueQty = Convert.ToDecimal(rdr["qty"]),
                        CrateIssueDated = Convert.ToDateTime(rdr["Dated"]),
                        CrissueFlag = rdr["trflag"].ToString(),
                        CrissueRemarks = rdr["Remarks"].ToString(),
                        CrateCrn = rdr["Trno"].ToString(),






                    };
                    GetDailyCrates.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyCrates;
        }
        public async Task<List<CompanyModel>> GetDailyCratesProcAdjBydate(DateTime DateFrom, DateTime Dateto)
        {
            List<CompanyModel> GetDailyCrates = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT 
    ca.Trno,ca.dated,ca.cid,
    p_from.partyname AS PartyName, -- Party name for partyid
    p_to.partyname AS transferGroupName,    -- Party name for partyidto
    ps_groower.partyname AS GrowerName, -- Partysub name for groowerid
    ps_grower_to.partyname AS TransferGrowerName -- Partysub name for groweridto
	,ca.remarks,ca.qty
FROM 
    crateadjustment ca
-- Join to get party names for partyid and partyidto
LEFT JOIN party p_from ON ca.partyid = p_from.partyid
LEFT JOIN party p_to ON ca.partyidto = p_to.partyid
-- Join to get partysub names for groowerid and groweridto
LEFT JOIN partysub ps_groower ON ca.groowerid = ps_groower.partyid
LEFT JOIN partysub ps_grower_to ON ca.groweridto = ps_grower_to.partyid

WHERE  ca.flagdeleted=0 and CONVERT(date, ca.Dated) >= CONVERT(date, @DateFrom) and CONVERT(date, ca.Dated) <= CONVERT(date, @Dateto) order by ca.cid desc";
                SqlCommand cmd = new SqlCommand(query, con)


                {

                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@DateFrom", DateFrom);
                cmd.Parameters.AddWithValue("@Dateto", Dateto);
                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        CrissueId = Convert.ToInt32(rdr["cid"]),
                        CrateIssueDated = Convert.ToDateTime(rdr["dated"]),

                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                        CrTransferGrowerGroup = rdr["transferGroupName"].ToString(),
                        CrTransferGrower = rdr["TransferGrowerName"].ToString(),


                        CrissueQty = Convert.ToDecimal(rdr["qty"]),

                        CrissueRemarks = rdr["Remarks"].ToString(),
                        CrateCrn = rdr["Trno"].ToString(),






                    };
                    GetDailyCrates.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyCrates;
        }





        public async Task<List<CompanyModel>> GetPreinwardProcBydate(DateTime DateFrom, DateTime Dateto, string Prestat)
        {
            List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT
    ci.Lotno,
    ci.PreInIrn, ci.LotIrn, ci.GateInId,
    ci.GateInDate,
    p.partytypeid + '-' + p.partyname AS PartyName,
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
    CONVERT(varchar(max), cm.id) + '-' + cm.ChallanName AS ChallanName,
    RTRIM(vi.vehno) + SPACE(1) + '(' + RTRIM(vi.drivername) + SPACE(1) + ')' + SPACE(1) + '(' + RTRIM(vi.contactno) + ')' AS vehno,
    ci.qty, ci.sno, ci.createddate, ci.KhataName, ci.ChallanNo, ur.uname,
    ci.Remarks,
    ci.preInirn, ui.uname as username, pq.name as variety, ci.cratetype, st.sname, um.Ucode, pt.name,
    CASE 
        WHEN ci.flagdeleted = 1 THEN 'Deleted'
        WHEN EXISTS (SELECT 1 FROM QualityControl qi WHERE qi.LotNo = ci.LotNo) THEN 'Completed'
        ELSE 'Pending'
    END AS Status
FROM GateInTrans ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.growerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
LEFT JOIN users ui ON ci.createdby = ui.id
LEFT JOIN prodqaul pq ON ci.varietyid = pq.id
LEFT JOIN servicetypes st ON ci.schemeid = st.id
LEFT JOIN unit_master um ON ci.Unitid = um.id
LEFT JOIN PTYPE pt ON ci.packageid = pt.id
LEFT JOIN users ur ON ci.Createdby = ur.id
WHERE 
    (@status = 'Deleted' AND ci.flagdeleted = 1)
    OR 
    (@status = 'Completed' AND ci.flagdeleted = 0 AND EXISTS (SELECT 1 FROM QualityControl qi WHERE qi.LotNo = ci.LotNo))
    OR 
    (@status = 'Pending' AND ci.flagdeleted = 0 AND NOT EXISTS (SELECT 1 FROM QualityControl qi WHERE qi.LotNo = ci.LotNo))
    AND CONVERT(date, ci.GateInDate) >= CONVERT(date, @DateFrom) 
    AND CONVERT(date, ci.GateInDate) <= CONVERT(date, @DateTo)
ORDER BY ci.GateInId DESC";
                SqlCommand cmd = new SqlCommand(query, con)


                {

                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@DateFrom", DateFrom);
                cmd.Parameters.AddWithValue("@Dateto", Dateto);
                cmd.Parameters.AddWithValue("@status", Prestat);

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        PreInwardId = Convert.ToInt32(rdr["GateInId"]),
                        PreinwardDate = Convert.ToDateTime(rdr["GateInDate"]),

                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                        ChallanName = rdr["ChallanName"].ToString(),
                        Vehno = rdr["vehno"].ToString(),
                        PreInIrn = rdr["PreInIrn"].ToString(),
                        LotIrn = rdr["LotIrn"].ToString(),




                        PreInwardQty = Convert.ToDecimal(rdr["qty"]),

                        GlobalUserName = rdr["username"].ToString(),
                        PreInwardStatus = rdr["Status"].ToString(),






                    };
                    GetDailyPreinward.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinward;
        }



















        public async Task<List<CompanyModel>> GetDailyCratesProcBydateEmpty(DateTime DateFrom, DateTime Dateto)
        {
            List<CompanyModel> GetDailyCrates = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT
    ci.cid,ci.Trno,
    ci.Dated,
	p.partytypeid  +'-'+ p.partyname AS PartyName,
 convert(varchar(max),ps.partyid)  +'-'+ ps.partyname AS GrowerName,
   convert(varchar(max),cm.id)  +'-'+ cm.ChallanName as ChallanName,
       rtrim(vi.vehno) + space(1)+'('+ rtrim(vi.drivername)+space(1)+')'+space(1)+'('+rtrim(vi.contactno)+')' as vehno,


	ci.CrateMark,
    ci.qty,
    ci.trflag,
ci.Remarks
FROM crateissue ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.groowerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
WHERE ci.Trflag='Empty Receive' and ci.flagdeleted=0 and CONVERT(date, ci.Dated) >= CONVERT(date, @DateFrom) and CONVERT(date, ci.Dated) <= CONVERT(date, @Dateto) order by ci.cid desc";
                SqlCommand cmd = new SqlCommand(query, con)


                {

                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@DateFrom", DateFrom);
                cmd.Parameters.AddWithValue("@Dateto", Dateto);
                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        CrissueId = Convert.ToInt32(rdr["cid"]),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                        ChallanName = rdr["challanname"].ToString(),
                        Vehno = rdr["vehno"].ToString(),
                        CrissueMark = rdr["CrateMark"].ToString(),
                        CrissueQty = Convert.ToDecimal(rdr["qty"]),
                        CrateIssueDated = Convert.ToDateTime(rdr["Dated"]),
                        CrissueFlag = rdr["trflag"].ToString(),
                        CrissueRemarks = rdr["Remarks"].ToString(),
                        CrateCrn = rdr["Trno"].ToString(),






                    };
                    GetDailyCrates.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyCrates;
        }



        public async Task<List<CompanyModel>> GetDailyCratesProcBydateout(DateTime DateFrom, DateTime Dateto)
        {
            List<CompanyModel> GetDailyCrates = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT
    ci.cid,ci.Trno,

    ci.Dated,
	p.partytypeid  +'-'+ p.partyname AS PartyName,
 convert(varchar(max),ps.partyid)  +'-'+ ps.partyname AS GrowerName,
   convert(varchar(max),cm.id)  +'-'+ cm.ChallanName as ChallanName,
    rtrim(vi.vehno) + space(1)+'('+ rtrim(vi.drivername)+space(1)+')'+space(1)+'('+rtrim(vi.contactno)+')' as vehno,


	ci.CrateMark,
    ci.qty,
    ci.trflag,
ci.Remarks
FROM crateissue ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.groowerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
WHERE  ci.trflag in('Empty Returned','Petty Returned') and ci.flagdeleted=0 and CONVERT(date, ci.Dated) >= CONVERT(date, @DateFrom) and CONVERT(date, ci.Dated) <= CONVERT(date, @Dateto) order by ci.cid desc";
                SqlCommand cmd = new SqlCommand(query, con)


                {

                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@DateFrom", DateFrom);
                cmd.Parameters.AddWithValue("@Dateto", Dateto);
                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        CrissueId = Convert.ToInt32(rdr["cid"]),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                        ChallanName = rdr["challanname"].ToString(),
                        Vehno = rdr["vehno"].ToString(),
                        CrissueMark = rdr["CrateMark"].ToString(),
                        CrissueQty = Convert.ToDecimal(rdr["qty"]),
                        CrateIssueDated = Convert.ToDateTime(rdr["Dated"]),
                        CrissueFlag = rdr["trflag"].ToString(),
                        CrissueRemarks = rdr["Remarks"].ToString(),
                        CrateCrn = rdr["Trno"].ToString(),






                    };
                    GetDailyCrates.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyCrates;
        }























        public async Task<List<CompanyModel>> GetPurchaseorders()
        {
            List<CompanyModel> Purchaseorders = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct OrderId from purchaseOrder";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        PurchaseOrderId = Convert.ToInt32(rdr["OrderId"]),




                    };
                    Purchaseorders.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Purchaseorders;
        }
        public async Task<List<CompanyModel>> GetCrateorders()
        {
            List<CompanyModel> Purchaseorders = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct cid from crateissue where flagdeleted=0 and Trflag='Crate Issue'";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        CrissueId = Convert.ToInt32(rdr["cid"]),




                    };
                    Purchaseorders.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Purchaseorders;
        }
        public async Task<List<CompanyModel>> GetCrateordersEmpty()
        {
            List<CompanyModel> Purchaseorders = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct cid from crateissue where flagdeleted=0 and Trflag='Empty Receive'";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        CrissueId = Convert.ToInt32(rdr["cid"]),




                    };
                    Purchaseorders.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Purchaseorders;
        }

        public async Task<List<CompanyModel>> GetallVoucherTypes()
        {
            List<CompanyModel> GetgrowerListVr = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select rtrim(Mastername) as Allvouchers from VoucherGroup";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        TransactionType = rdr["Allvouchers"].ToString()



                    };
                    GetgrowerListVr.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetgrowerListVr;
        }















        public async Task<List<CompanyModel>> GetallMasterAccounts()
        {
            List<CompanyModel> GetgrowerList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select rtrim(masterName)  as masteraccounts from AccountMasters  where flagdeleted=0 and status=1";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        MaccGrp = rdr["masteraccounts"].ToString()



                    };
                    GetgrowerList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetgrowerList;
        }


        public async Task<List<CompanyModel>> GetallPurchaseCat()
        {
            List<CompanyModel> GetgrowerList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select rtrim(masterName)  as masteraccounts from PurchaseGroup  where flagdeleted=0";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        PurchGrp = rdr["masteraccounts"].ToString()



                    };
                    GetgrowerList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetgrowerList;
        }



        public async Task<List<CompanyModel>> GetallPurchaseuom()
        {
            List<CompanyModel> GetUomList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select rtrim(UomName)  as uoms from ItemUoms";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        ItemUom = rdr["uoms"].ToString()



                    };
                    GetUomList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetUomList;
        }


        public async Task<List<CompanyModel>> GetallPurchasegst()
        {
            List<CompanyModel> GetGstList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select rtrim(slabname)  as Gstslab from gstslabs";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        ItemGst = rdr["Gstslab"].ToString()



                    };
                    GetGstList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetGstList;
        }
























        public async Task<List<CompanyModel>> GetallMasterSubAccounts()
        {
            List<CompanyModel> GetgrowerListNew = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select rtrim(MasterSubname)  as masteraccounts from AccountMasterSub   where flagdeleted=0 and status=1";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        SubaccGrp = rdr["masteraccounts"].ToString()



                    };
                    GetgrowerListNew.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetgrowerListNew;
        }


        public async Task<List<CompanyModel>> GetFinyear()
        {
            List<CompanyModel> GetFinyearList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select rtrim(fname) as fname  from Finyear";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Fyear = rdr["fname"].ToString()



                    };
                    GetFinyearList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetFinyearList;
        }





        public async Task<List<CompanyModel>> GetServices()
        {
            List<CompanyModel> GetServiceList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select rtrim(sname) as sname  from servicetypes";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Atype = rdr["sname"].ToString()



                    };
                    GetServiceList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetServiceList;
        }

        public async Task<List<CompanyModel>> GetServicesfromAgreement(string selectedpurchase)
        {
            List<CompanyModel> GetGstList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select rtrim(sname) as sname  from servicetypes where id in(select [service] from growerAgreement where mainid in(select partyid from party where partytypeid  +'-'+ partyname=@Partyid ))";

                SqlCommand cmd = new SqlCommand(query, con)


                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Partyid", selectedpurchase);
                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Atype = rdr["sname"].ToString()



                    };
                    GetGstList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetGstList;
        }
        public async Task<List<CompanyModel>> GetItemname()
        {
            List<CompanyModel> Productype = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select rtrim(name) as pname  from prodtype";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Itemname = rdr["pname"].ToString()



                    };
                    Productype.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Productype;
        }














        public async Task<List<CompanyModel>> GetallGrowers()
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select *,  partytypeid + '-' + partyname AS PartyGroupName from party where type='C' and flagdeleted=0 order by partycode desc";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        Growerid = Convert.ToInt32(rdr["Partycode"]),
                        GrowerAddress = rdr["address"].ToString(),

                        GrowerName = rdr["PartyGroupName"].ToString(),
                        Cdated = rdr["createdon"].ToString(),
                        Grstatus = rdr["status"].ToString()



,


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }


        public async Task<List<CompanyModel>> GetallStock()
        {
            List<CompanyModel> Growers = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "SELECT p.partyid,p.partytypeid + '-' + p.partyname AS PartyName,  CAST(sum(companycrate) AS DECIMAL(18,2)) as ccrates,    CAST(sum(owncrate) AS DECIMAL(18,2)) as owncrates,    CAST(sum(qty) AS DECIMAL(18,2)) as qty,    CAST(sum(VerifiedCompanyCrates) AS DECIMAL(18,2)) as vccrates,    CAST(sum(VerifiedOwnCrates) AS DECIMAL(18,2)) as vcowncrates,    CAST(sum(VerifiedQty) AS DECIMAL(18,2)) as Vcqty,    CAST(sum(VerifiedWoodenPetty) AS DECIMAL(18,2)) as vcpetty  FROM gateintrans ci LEFT JOIN party p ON ci.partyid = p.partyid where ci.flagdeleted=0 and ci.dockpost=1 group by p.partyid,p.partytypeid + '-' + p.partyname order by partyid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                   
                    {

                        Growerid = rdr.GetInt32(rdr.GetOrdinal("partyid")),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        TotalPreQty = rdr.GetDecimal(rdr.GetOrdinal("qty")),
                        TotalPrecompanyQty = rdr.GetDecimal(rdr.GetOrdinal("ccrates")),
                        TotalPreownQty = rdr.GetDecimal(rdr.GetOrdinal("owncrates")),

                        TotalInQty = rdr.GetDecimal(rdr.GetOrdinal("Vcqty")),
                        TotalIncompanyQty = rdr.GetDecimal(rdr.GetOrdinal("vccrates")),
                        TotalInownQty = rdr.GetDecimal(rdr.GetOrdinal("vcowncrates")),
                        TotalInpettyQty = rdr.GetDecimal(rdr.GetOrdinal("vcpetty"))



,


                    };
                    Growers.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Growers;
        }
        //GetallStockChamber



    












        public async Task<List<CompanyModel>> GetallStockChamber(int GrowerId)
        {
            List<CompanyModel> Growers = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "SELECT p.chambername,CAST(sum(companycrate) AS DECIMAL(18,2)) as ccrates,CAST(sum(owncrate) AS DECIMAL(18,2)) as owncrates,CAST(sum(ci.qty) AS DECIMAL(18,2)) as qty,CAST(sum(VerifiedCompanyCrates) AS DECIMAL(18,2)) as vccrates,CAST(sum(VerifiedOwnCrates) AS DECIMAL(18,2)) as vcowncrates,CAST(sum(VerifiedQty) AS DECIMAL(18,2)) as Vcqty,CAST(sum(VerifiedWoodenPetty) AS DECIMAL(18,2)) as vcpetty  FROM gateintrans ci LEFT JOIN chamber p ON ci.LocationChamberId = p.chamberid where ci.flagdeleted=0 and ci.dockpost=1 and ci.PartyId=@Growerid group by p.chambername, p.chamberid order by p.chamberid ";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text

                };
                cmd.Parameters.AddWithValue("@Growerid", GrowerId);
                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel

                    {

                        //Growerid = rdr.GetInt32(rdr.GetOrdinal("partyid")),
                        ChamberName = rdr["chambername"].ToString(),
                        TotalPreQty = rdr.GetDecimal(rdr.GetOrdinal("qty")),
                        TotalPrecompanyQty = rdr.GetDecimal(rdr.GetOrdinal("ccrates")),
                        TotalPreownQty = rdr.GetDecimal(rdr.GetOrdinal("owncrates")),

                        TotalInQty = rdr.GetDecimal(rdr.GetOrdinal("Vcqty")),
                        TotalIncompanyQty = rdr.GetDecimal(rdr.GetOrdinal("vccrates")),
                        TotalInownQty = rdr.GetDecimal(rdr.GetOrdinal("vcowncrates")),
                        TotalInpettyQty = rdr.GetDecimal(rdr.GetOrdinal("vcpetty"))



,


                    };
                    Growers.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Growers;
        }




        public async Task<List<CompanyModel>> GetallStockGrowerlots(int GrowerId)
        {
            List<CompanyModel> Growerslots = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"
SELECT
     convert(varchar(20),ci.GateInDate,104) as GDated,ci.lotno,ci.PreInIrn,ci.lotirn,
	 p.partytypeid + '-' + p.partyname AS PartyName,
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,cm.challanName,ci.challanNo ,prt.name as item,pt.name as package,ci.khataName,
	ci.cratetype,pq.name as variety,cs.chambername,
    CAST(ci.qty AS DECIMAL(18,0)) as preinwardQty,
    CAST(ci.VerifiedCompanyCrates AS DECIMAL(18,0)) as VerifiedCompanyCrates,
    CAST(ci.VerifiedOwnCrates AS DECIMAL(18,0)) as VerifiedOwnCrates,
    CAST(ci.VerifiedWoodenPetty AS DECIMAL(18,0)) as VerifiedWoodenPetty,
    CAST(ci.verifiedqty AS DECIMAL(18,0)) as verifiedqty,ci.Remarks,CAST(ci.bins AS DECIMAL(18,0)) as bins
    
FROM GateInTrans ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.growerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
LEFT JOIN users ui ON ci.createdby = ui.id
LEFT JOIN prodqaul pq ON ci.varietyid = pq.id
LEFT JOIN servicetypes st ON ci.schemeid = st.id
LEFT JOIN unit_master um ON ci.Unitid = um.id
LEFT JOIN PTYPE pt ON ci.packageid = pt.id
LEFT JOIN users ur ON ci.Createdby = ur.id
LEFT JOIN chamber cs ON ci.LocationChamberId = cs.chamberid
LEFT JOIN prodtype prt ON ci.itemid = prt.id
WHERE 
 VerifiedQty>0 and GrowerId=@Growerid order by lotno";


                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text

                };
                cmd.Parameters.AddWithValue("@Growerid", GrowerId);
                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel

                    {
                        PreInwardKhata = rdr["khataName"].ToString(),

                        Lotno = rdr.GetInt32(rdr.GetOrdinal("lotno")),
                        EntryDate = rdr["GDated"].ToString(),
                        LotIrn = rdr["lotirn"].ToString(),
                        PreInIrn = rdr["PreInIrn"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                        ChallanName = rdr["challanName"].ToString(),
                        ChallanNo = rdr["challanNo"].ToString(),
                        VarietyId = rdr["variety"].ToString(),
                        ChamberName = rdr["chambername"].ToString(),
                        PreCrateType = rdr["cratetype"].ToString(),
                        PreInwardQty = rdr.GetDecimal(rdr.GetOrdinal("preinwardQty")),
                        VerfiedCompanyCrates = rdr.GetDecimal(rdr.GetOrdinal("VerifiedCompanyCrates")),
                        VerfiedOwnCrates = rdr.GetDecimal(rdr.GetOrdinal("VerifiedOwnCrates")),
                        Verfiedpetties = rdr.GetDecimal(rdr.GetOrdinal("VerifiedWoodenPetty")),
                        VerfiedQty = rdr.GetDecimal(rdr.GetOrdinal("verifiedqty")),
                        Verfiedbins = rdr.GetDecimal(rdr.GetOrdinal("bins"))












,


                    };
                    Growerslots.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Growerslots;
        }






        public async Task<List<CompanyModel>> Getsearchstock()
        {
            List<CompanyModel> Growerslots = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT
    convert(varchar(20),ci.GateInDate,104) as GDated,lf.lOCATION,
    ci.lotno,
    ci.PreInIrn,
    ci.lotirn,
    p.partytypeid + '-' + p.partyname AS PartyName,
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
    cm.challanName,
    ci.challanNo,
    prt.name as item,
    pt.name as package,
    ci.khataName,
    ci.cratetype,
    pq.name as variety,
    cs.chambername,
    CAST(ci.qty AS DECIMAL(18,0)) as preinwardQty,
    vi.vehno,
    CAST(ci.VerifiedCompanyCrates AS DECIMAL(18,0)) as VerifiedCompanyCrates,
    CAST(ci.VerifiedOwnCrates AS DECIMAL(18,0)) as VerifiedOwnCrates,
    CAST(ci.VerifiedWoodenPetty AS DECIMAL(18,0)) as VerifiedWoodenPetty,
    CAST(ci.verifiedqty AS DECIMAL(18,0)) as verifiedqty,
    ci.Remarks,
    CAST(ci.bins AS DECIMAL(18,0)) as bins,
    ISNULL(CAST(SUM(lot.OrderQty) AS DECIMAL(18,0)), 0) as outqty
    
FROM GateInTrans ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN locationFinal lf ON ci.lotno = lf.lotno
LEFT JOIN partysub ps ON ci.growerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
LEFT JOIN users ui ON ci.createdby = ui.id
LEFT JOIN prodqaul pq ON ci.varietyid = pq.id
LEFT JOIN servicetypes st ON ci.schemeid = st.id
LEFT JOIN unit_master um ON ci.Unitid = um.id
LEFT JOIN PTYPE pt ON ci.packageid = pt.id
LEFT JOIN users ur ON ci.Createdby = ur.id
LEFT JOIN chamber cs ON ci.LocationChamberId = cs.chamberid
LEFT JOIN prodtype prt ON ci.itemid = prt.id
LEFT JOIN lotouttrans lot ON ci.lotno = lot.lotno AND ci.Unitid = lot.unitid AND lot.flagdeleted=0
WHERE 
    ci.VerifiedQty > 0 
    AND ci.flagdeleted=0 
    AND ci.lotno IN (SELECT lotno FROM GateInTransreport) 
GROUP BY
    convert(varchar(20),ci.GateInDate,104),
    ci.lotno,
    ci.PreInIrn,
    ci.lotirn,
    p.partytypeid + '-' + p.partyname,
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname,
    cm.challanName,
    ci.challanNo,
    prt.name,
    pt.name,
    ci.khataName,
    ci.cratetype,
    pq.name,
    cs.chambername,
    CAST(ci.qty AS DECIMAL(18,0)),
    vi.vehno,
    CAST(ci.VerifiedCompanyCrates AS DECIMAL(18,0)),
    CAST(ci.VerifiedOwnCrates AS DECIMAL(18,0)),
    CAST(ci.VerifiedWoodenPetty AS DECIMAL(18,0)),
    CAST(ci.verifiedqty AS DECIMAL(18,0)),
    ci.Remarks,lf.lOCATION,
    CAST(ci.bins AS DECIMAL(18,0))
ORDER BY ci.lotno";


                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text

                };
                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel

                    {
                        PreInwardKhata = rdr["khataName"].ToString(),

                        Lotno = rdr.GetInt32(rdr.GetOrdinal("lotno")),
                        EntryDate = rdr["GDated"].ToString(),
                        LotIrn = rdr["lotirn"].ToString(),
                        PreInIrn = rdr["PreInIrn"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                        ChallanName = rdr["challanName"].ToString(),
                        ChallanNo = rdr["challanNo"].ToString(),
                        VarietyId = rdr["variety"].ToString(),
                        ChamberName = rdr["chambername"].ToString(),
                        PreCrateType = rdr["cratetype"].ToString(),
                        PreInwardQty = rdr.GetDecimal(rdr.GetOrdinal("preinwardQty")),
                        VerfiedCompanyCrates = rdr.GetDecimal(rdr.GetOrdinal("VerifiedCompanyCrates")),
                        VerfiedOwnCrates = rdr.GetDecimal(rdr.GetOrdinal("VerifiedOwnCrates")),
                        Verfiedpetties = rdr.GetDecimal(rdr.GetOrdinal("VerifiedWoodenPetty")),
                        VerfiedQty = rdr.GetDecimal(rdr.GetOrdinal("verifiedqty")),
                        Verfiedbins = rdr.GetDecimal(rdr.GetOrdinal("bins")),
                        VerfiedOut = rdr.GetDecimal(rdr.GetOrdinal("outqty")),

                        Vehno = rdr["vehno"].ToString(),
                             Prodname = rdr["package"].ToString(),
                             

                              Templocation = rdr["lOCATION"].ToString()







,


                    };
                    Growerslots.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Growerslots;
        }



        public async Task<List<CompanyModel>> GetsearchstockExcel()
        {
            List<CompanyModel> Growerslots = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"
SELECT
    ci.Lotno, 
    ci.Gateindate, 
    ci.companycrate, 
    ci.owncrate, 
    ci.itemMarka,
    ch.Chambername,
    ci.PreInIrn, 
    ci.LotIrn, 
    ci.GateInId, 
    ci.dtfrom, 
    ci.dtto, 
    ci.prelotprefix,
    convert(varchar(40),ci.Gateindate,104) as Dated, 
    pd.name as itemname, 
    um.unitname,
    p.partytypeid + '-' + p.partyname AS PartyName, 
    ci.VerifiedCompanyCrates, 
    ci.VerifiedOwnCrates, 
    ci.VerifiedWoodenpetty, 
    ci.VerifiedQty,
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
    CONVERT(varchar(max), cm.id) + '-' + cm.ChallanName AS ChallanName,
    RTRIM(vi.vehno) + SPACE(1) + '(' + RTRIM(vi.drivername) + SPACE(1) + ')' + SPACE(1) + '(' + RTRIM(vi.contactno) + ')' AS vehno,
    ci.qty, 
    ci.sno, 
    ci.createddate, 
    ci.KhataName, 
    ci.ChallanNo, 
    ur.uname,
    ci.Remarks, 
    LF.lOCATION AS LOCATION, 
    cast(bt.AvgWightPerQty as numeric(9,2)) as tavg,
    ci.preInirn, 
    ui.uname as username, 
    pq.name as variety, 
    ci.cratetype, 
    st.sname, 
    um.Ucode, 
    pt.name,
    CAST(BT.AvgWightPerQty * ci.VerifiedQty AS NUMERIC(18,2)) AS WEIGHTQTY,
    qc.ScabName, 
    qc.Pressure, 
    qc.AvgWeight, 
    qc.AvgWeight * ci.qty as Netwt,
    
    -- A-grade and B-grade weights
    (BT.AvgWightPerQty - (qc.bGradeAvgCrateValue - 1.55)) * ci.qty as Agrade,
    (qc.bGradeAvgCrateValue - 1.55) * ci.qty as bgrade,
    
    -- CORRECTED Percentage calculations with respect to Netwt
    CASE 
        WHEN bt.AvgWightPerQty * ci.qty > 0 
        THEN cast((((BT.AvgWightPerQty - (qc.bGradeAvgCrateValue - 1.55)) * ci.qty) / (bt.AvgWightPerQty * ci.qty)) * 100 as numeric(9,2))
        ELSE 0 
    END as Apercent,
    
    CASE 
        WHEN qc.AvgWeight * ci.qty > 0 
        THEN cast((((qc.bGradeAvgCrateValue - 1.55) * ci.qty) / (bt.AvgWightPerQty * ci.qty)) * 100 as numeric(9,2))
        ELSE 0 
    END as Bpercent,
    
    -- Individual crate weights
    cast (BT.AvgWightPerQty - (qc.bGradeAvgCrateValue - 1.55) as numeric(9,2)) as Agradecrate,
    cast( qc.bGradeAvgCrateValue - 1.55 as numeric(9,2)) as bgradecrate,
    
    qc.Avgsizename, 
    qc.Remarks as qcrem,
    
    -- Added out quantity from lotouttrans table
    ISNULL(CAST(SUM(lot.orderqty) AS DECIMAL(18,0)), 0) as outqty,
    
    -- Optional: Available quantity (inward - outward)
    CAST(ci.VerifiedQty AS DECIMAL(18,0)) - ISNULL(CAST(SUM(lot.OrderQty) AS DECIMAL(18,0)), 0) as availableqty

FROM GateInTransreport ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.growerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
LEFT JOIN users ui ON ci.createdby = ui.id
LEFT JOIN prodqaul pq ON ci.verifiedbrandid = pq.id
LEFT JOIN servicetypes st ON ci.schemeid = st.id
LEFT JOIN unit_master um ON ci.Unitid = um.id
LEFT JOIN PTYPE pt ON ci.packageid = pt.id
LEFT JOIN users ur ON ci.Createdby = ur.id
LEFT JOIN prodtype pd ON ci.itemid = pd.id
LEFT JOIN BridgeWeight BT ON ci.OriginID = BT.PreinwardId 
LEFT JOIN locationfinal LF ON ci.lotno = LF.Lotno
LEFT JOIN QualityControl qc ON ci.lotno = qc.Lotno
LEFT JOIN company cp ON ci.count = cp.cid 
LEFT JOIN chamber ch ON ci.locationchamberid = ch.Chamberid 
LEFT JOIN lotouttrans lot ON ci.lotno = lot.lotno AND ci.Unitid = lot.unitid

WHERE
    ci.VerifiedQty > 0 
    AND ci.lotno IN (SELECT lotno FROM GateInTransreport) 
    
GROUP BY
    ci.Lotno, 
    ci.Gateindate, 
    ci.companycrate, 
    ci.owncrate, 
    ci.itemMarka,
    ch.Chambername,
    ci.PreInIrn, 
    ci.LotIrn, 
    ci.GateInId, 
    ci.dtfrom, 
    ci.dtto, 
    ci.prelotprefix,
    convert(varchar(40),ci.Gateindate,104),
    pd.name, 
    um.unitname,
    p.partytypeid + '-' + p.partyname,
    ci.VerifiedCompanyCrates, 
    ci.VerifiedOwnCrates, 
    ci.VerifiedWoodenpetty, 
    ci.VerifiedQty,
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname,
    CONVERT(varchar(max), cm.id) + '-' + cm.ChallanName,
    RTRIM(vi.vehno) + SPACE(1) + '(' + RTRIM(vi.drivername) + SPACE(1) + ')' + SPACE(1) + '(' + RTRIM(vi.contactno) + ')',
    ci.qty, 
    ci.sno, 
    ci.createddate, 
    ci.KhataName, 
    ci.ChallanNo, 
    ur.uname,
    ci.Remarks, 
    LF.lOCATION,
    cast(bt.AvgWightPerQty as numeric(9,2)),
    ci.preInirn, 
    ui.uname,
    pq.name, 
    ci.cratetype, 
    st.sname, 
    um.Ucode, 
    pt.name,
    CAST(BT.AvgWightPerQty * ci.VerifiedQty AS NUMERIC(18,2)),
    qc.ScabName, 
    qc.Pressure, 
    qc.AvgWeight, 
    qc.AvgWeight * ci.qty,
    (BT.AvgWightPerQty - (qc.bGradeAvgCrateValue - 1.55)) * ci.qty,
    (qc.bGradeAvgCrateValue - 1.55) * ci.qty,
    CASE 
        WHEN bt.AvgWightPerQty * ci.qty > 0 
        THEN cast((((BT.AvgWightPerQty - (qc.bGradeAvgCrateValue - 1.55)) * ci.qty) / (bt.AvgWightPerQty * ci.qty)) * 100 as numeric(9,2))
        ELSE 0 
    END,
    CASE 
        WHEN qc.AvgWeight * ci.qty > 0 
        THEN cast((((qc.bGradeAvgCrateValue - 1.55) * ci.qty) / (bt.AvgWightPerQty * ci.qty)) * 100 as numeric(9,2))
        ELSE 0 
    END,
    cast (BT.AvgWightPerQty - (qc.bGradeAvgCrateValue - 1.55) as numeric(9,2)),
    cast( qc.bGradeAvgCrateValue - 1.55 as numeric(9,2)),
    qc.Avgsizename, 
    qc.Remarks,
    CAST(ci.VerifiedQty AS DECIMAL(18,0))

ORDER BY ci.lotno";



                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text

                };
                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel

                    {
                        PreInIrn = rdr["PreInIrn"].ToString(),
                        LotIrn = rdr["lotirn"].ToString(),
                        EntryDate = rdr["Dated"].ToString(),
                        GrowerGroupName = rdr["PartyName"].ToString(),
                        GrowerName = rdr["GrowerName"].ToString(),
                        ChallanName = rdr["challanName"].ToString(),
                        PreInwardKhata = rdr["khataName"].ToString(),
                        VarietyId = rdr["variety"].ToString(),
                        ChamberName = rdr["chambername"].ToString(),
                        Vehno = rdr["vehno"].ToString(),
                        // Safe decimal conversion with null handling
                        VerfiedCompanyCrates = rdr["VerifiedCompanyCrates"] != DBNull.Value ? Convert.ToDecimal(Convert.ToInt32(rdr["VerifiedCompanyCrates"])) : 0m,
                        VerfiedOwnCrates = rdr["VerifiedOwnCrates"] != DBNull.Value ? Convert.ToDecimal(Convert.ToInt32(rdr["VerifiedOwnCrates"])) : 0m,
                        Verfiedpetties = rdr["VerifiedWoodenPetty"] != DBNull.Value ? Convert.ToDecimal(Convert.ToInt32(rdr["VerifiedWoodenPetty"])) : 0m,
                        VerfiedQty = rdr["verifiedqty"] != DBNull.Value ? Convert.ToDecimal(Convert.ToInt32(rdr["verifiedqty"])) : 0m,
                        Scabename = rdr["ScabName"].ToString(),

                        // Safe decimal conversion for pressure and weights
                        AvgPressure = rdr["Pressure"] != DBNull.Value ? Convert.ToDecimal(rdr["Pressure"]) : 0m,
                        Netweight = rdr["tavg"] != DBNull.Value ? Convert.ToDecimal(rdr["tavg"]) : 0m,
                        TotalNetweight = rdr["WEIGHTQTY"] != DBNull.Value ? Convert.ToDecimal(rdr["WEIGHTQTY"]) : 0m,
                        TotalAgrade = rdr["Agrade"] != DBNull.Value ? Convert.ToDecimal(rdr["Agrade"]) : 0m,
                        TotalBgrade = rdr["bgrade"] != DBNull.Value ? Convert.ToDecimal(rdr["bgrade"]) : 0m,

                        // Percentage values - ensure they're divided by 100 if stored as whole numbers in database
                        TotalAgradePercent = rdr["Apercent"] != DBNull.Value ? Convert.ToDecimal(rdr["Apercent"]) / 100m : 0m,
                        TotalBgradePercent = rdr["Bpercent"] != DBNull.Value ? Convert.ToDecimal(rdr["Bpercent"]) / 100m : 0m,
                        TotalAgradepercrate = rdr["Agradecrate"] != DBNull.Value ? Convert.ToDecimal(rdr["Agradecrate"]) : 0m,
                        TotalBgradepercrate = rdr["bgradecrate"] != DBNull.Value ? Convert.ToDecimal(rdr["bgradecrate"]) : 0m,

                        Avgsizename = rdr["Avgsizename"].ToString(),
                        QualityRemarks = rdr["Remarks"].ToString(),
                        VerfiedOut = rdr["outqty"] != DBNull.Value ? Convert.ToDecimal(Convert.ToInt32(rdr["outqty"])) : 0m,
                        VerfiedAvailable = rdr["availableqty"] != DBNull.Value ? Convert.ToDecimal(Convert.ToInt32(rdr["availableqty"])) : 0m












,


                    };
                    Growerslots.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Growerslots;
        }













        public async Task<List<CompanyModel>> GetallStockGrower(int GrowerId)
        {
            List<CompanyModel> Growers = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "SELECT ci.GrowerId,p.partyid,convert(varchar(30),p.partyid) + '-' + p.partyname AS PartyName,  CAST(sum(companycrate) AS DECIMAL(18,2)) as ccrates,    CAST(sum(owncrate) AS DECIMAL(18,2)) as owncrates, CAST(sum(qty) AS DECIMAL(18,2)) as qty,    CAST(sum(VerifiedCompanyCrates) AS DECIMAL(18,2)) as vccrates,    CAST(sum(VerifiedOwnCrates) AS DECIMAL(18,2)) as vcowncrates,    CAST(sum(VerifiedQty) AS DECIMAL(18,2)) as Vcqty,    CAST(sum(VerifiedWoodenPetty) AS DECIMAL(18,2)) as vcpetty  FROM gateintrans ci LEFT JOIN partysub p ON ci.GrowerId = p.partyid where ci.flagdeleted=0 and ci.dockpost=1  and ci.PartyId=@Growerid group by ci.GrowerId ,p.partyid,convert(varchar(30),p.partyid) + '-' + p.partyname";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                    
            };
                cmd.Parameters.AddWithValue("@Growerid", GrowerId);
                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel

                    {

                        Growerid = rdr.GetInt32(rdr.GetOrdinal("GrowerId")),
                        GrowerName = rdr["PartyName"].ToString(),
                        TotalPreQty = rdr.GetDecimal(rdr.GetOrdinal("qty")),
                        TotalPrecompanyQty = rdr.GetDecimal(rdr.GetOrdinal("ccrates")),
                        TotalPreownQty = rdr.GetDecimal(rdr.GetOrdinal("owncrates")),

                        TotalInQty = rdr.GetDecimal(rdr.GetOrdinal("Vcqty")),
                        TotalIncompanyQty = rdr.GetDecimal(rdr.GetOrdinal("vccrates")),
                        TotalInownQty = rdr.GetDecimal(rdr.GetOrdinal("vcowncrates")),
                        TotalInpettyQty = rdr.GetDecimal(rdr.GetOrdinal("vcpetty"))



,


                    };
                    Growers.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Growers;
        }





        public async Task<CompanyModel> GetUserUnitsAsync(int userId)
        {
            CompanyModel companyModel = new CompanyModel();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "SELECT UnitID FROM UserUnitMap WHERE UserID = @UserID ORDER BY UnitID";
                using (SqlCommand cmd = new SqlCommand(query, con))
                {
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.AddWithValue("@UserID", userId);
                    await con.OpenAsync();

                    using (SqlDataReader rdr = await cmd.ExecuteReaderAsync())
                    {
                        while (await rdr.ReadAsync())
                        {
                            int unitId = rdr.GetInt32(0); // Get UnitID

                            // Set corresponding property to true
                            switch (unitId)
                            {
                                case 1:
                                    companyModel.Unit1 = true;
                                    break;
                                case 2:
                                    companyModel.Unit2 = true;
                                    break;
                                case 3:
                                    companyModel.Unit3 = true;
                                    break;
                                case 4:
                                    companyModel.Unit4 = true;
                                    break;
                                case 5:
                                    companyModel.Unit5 = true;
                                    break;
                            }
                        }
                    }
                }
            }

            return companyModel;
        }










        



        public async Task<List<CompanyModel>> GetPrivlist(string prestat)
        {
            List<CompanyModel> Userlist = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select pname,pageview,addval,EditVal,ViewVal,DelVal,Approval from userpriv where groupid in(select usergroupid from usergroup where name=@Pname and flagdeleted=0)";


                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Pname", prestat);
                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {


                        UserPrivname = rdr["pname"].ToString(),

                        Pageview = rdr.GetBoolean(rdr.GetOrdinal("pageview")),
                        AddVal = rdr.GetBoolean(rdr.GetOrdinal("addval")),
                        EditVal = rdr.GetBoolean(rdr.GetOrdinal("EditVal")),
                        ViewVal = rdr.GetBoolean(rdr.GetOrdinal("ViewVal")),
                        Delval = rdr.GetBoolean(rdr.GetOrdinal("DelVal")),
                        Appval = rdr.GetBoolean(rdr.GetOrdinal("Approval")),




                    };
                    Userlist.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Userlist;
        }

        public async Task<CompanyModel?> GetTradingPriv(string Ugroup)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                const string query = "select Addval,Editval,ViewVal,DelVal,Approval from userpriv where  Groupid in (select usergroupid from usergroup where name=@Ugroup) and pname=@pname";

                using (var cmd = new SqlCommand(query, con))
                {
                    cmd.Parameters.AddWithValue("@Ugroup", Ugroup);
                    cmd.Parameters.AddWithValue("@pname", "Trading and Transfers");


                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                TradeAdd = reader.GetBoolean(reader.GetOrdinal("Addval")),
                                TradeEdit = reader.GetBoolean(reader.GetOrdinal("Editval")),
                                TradeView = reader.GetBoolean(reader.GetOrdinal("ViewVal")),
                                TradeDel = reader.GetBoolean(reader.GetOrdinal("DelVal")),
                                TradeApp = reader.GetBoolean(reader.GetOrdinal("Approval")),




















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }



        public async Task<List<CompanyModel>> GetallUserGroup()
        {
            List<CompanyModel> Userlist = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct name as grpname from usergroup where status=1 and flagdeleted=0";


                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {


                        GlobalUserGroup = rdr["grpname"].ToString(),





                    };
                    Userlist.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Userlist;
        }

        public async Task<List<CompanyModel>> GetallUserGroupList()
        {
            List<CompanyModel> Userlist = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select usergroupid,name,Status from usergroup";


                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        UserGroupid = Convert.ToInt32(rdr["usergroupid"]),
                        UserGroupName = rdr["name"].ToString(),

                        UserGroupStatus = rdr["Status"].ToString(),




                    };
                    Userlist.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Userlist;
        }





        public async Task<List<CompanyModel>> GetallUsers()
        {
            List<CompanyModel> Userlist = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select a.userid,a.username,a.email,b.name as ugroup,a.status from users a left join usergroup b on a.usergroupid=b.usergroupid where a.status =1";


                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        Userid = Convert.ToInt32(rdr["userid"]),
                        GlobalUserName = rdr["username"].ToString(),

                        Useremail = rdr["email"].ToString(),

                        UserStatus = rdr["status"].ToString(),

                        GlobalUserGroup = rdr["ugroup"].ToString()
,


                    };
                    Userlist.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Userlist;
        }






        public async Task<List<CompanyModel>> GetallUsersactive()
        {
            List<CompanyModel> Userlist = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select a.userid,a.username,a.email,b.name as ugroup,a.status from users a left join usergroup b on a.usergroupid=b.usergroupid where a.status =1";


                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                         UserName = rdr["username"].ToString(),

                       


                    };
                    Userlist.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Userlist;
        }






























        public async Task<List<CompanyModel>> GetallAccounts()
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"
SELECT 
    u.Idno,
    u.partyid AS Code,
    s.Mastername,
    p.MasterSubname,
    o.Subname,
    u.[type]+'-'+u.partytypeid  +'-'+ u.partyname as Partyname,
    u.status,
    u.Approval,
  
  abs(ISNULL(ISNULL(t.TotalDebit, 0) - ISNULL(t.TotalCredit, 0), 0)) AS NetBalance,
     CASE 
        WHEN ISNULL(t.TotalDebit, 0) - ISNULL(t.TotalCredit, 0) > 0 THEN 'Dr'
        WHEN ISNULL(t.TotalDebit, 0) - ISNULL(t.TotalCredit, 0) < 0 THEN 'Cr'
        ELSE ''
    END AS Type
FROM party u 
LEFT JOIN AccountSubGroups o ON u.masterid = o.id
LEFT JOIN AccountMasterSub p ON o.MgroupId = p.ID
LEFT JOIN AccountMasters s ON p.MgroupId = s.id
LEFT JOIN (
    SELECT 
        id,
        SUM(Debit) AS TotalDebit,
        SUM(Credit) AS TotalCredit
    FROM Transactions 
    GROUP BY id
) t ON u.idno = t.id
WHERE u.flagdeleted = 0 and u.status=1";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Partyid = Convert.ToInt32(rdr["Idno"]),
                        Accountid = Convert.ToInt32(rdr["Code"]),
                        MaccGrp = rdr["Mastername"].ToString(),

                        SubaccGrp = rdr["MasterSubname"].ToString(),
                        SubgroupName = rdr["subname"].ToString(),
                        AccountName = rdr["Partyname"].ToString(),
                        Accountstatus = rdr["status"].ToString(),
                        AccountApproval = rdr["Approval"].ToString(),
                        AccountBalance = rdr.GetDecimal(rdr.GetOrdinal("NetBalance")),
                        BalanceType = rdr["Type"].ToString()






,


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }














        public async Task<List<CompanyModel>> GetallOutwards()
        {
            List<CompanyModel> outwardirn = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"
SELECT 
   distinct outwardirn from outward where 
flagdeleted = 0 ";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        OutwardIrn = rdr["outwardirn"].ToString()

                   





,


                    };
                    outwardirn.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return outwardirn;
        }
































        public async Task<List<string>> GetAllowedPagesAsync(string GlobalUserGroup)
        {
            var allowedPages = new List<string>();
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                string query = "SELECT pname FROM userpriv WHERE pageview=1 and GroupId in(select usergroupid from usergroup where name=@UserGroupId)";

                using (SqlCommand cmd = new SqlCommand(query, con))
                {
                    cmd.Parameters.AddWithValue("@UserGroupId", GlobalUserGroup);
                    await con.OpenAsync();

                    using (SqlDataReader reader = await cmd.ExecuteReaderAsync())
                    {
                        while (await reader.ReadAsync())
                        {
                            allowedPages.Add(reader["pname"].ToString());
                        }
                    }



                    return allowedPages;
                }
            }

        }


























        public async Task<List<CompanyModel>> GetallTransactions()
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"
SELECT t.tid as id,
    t.tdate,t.Remarks,t.ptype,
	vg.Mastername AS VoucherType,
    dp.[type]+'-'+dp.partytypeid  +'-'+ dp.partyname AS DebitPartyName,
    cp.[type]+'-'+cp.partytypeid  +'-'+ cp.partyname AS CreditPartyName,
t.remarks,
    t.Debit as Amount
    
FROM Transactions t 
LEFT JOIN party dp ON t.debitpartyid = dp.idno
LEFT JOIN party cp ON t.creditpartyid = cp.idno
LEFT JOIN vouchergroup vg ON t.Ttype = vg.id
where debit>0 and t.flagdeleted=0 order by t.tid";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        TransactionId = Convert.ToInt32(rdr["id"]),
                        TransactionCredit = rdr["CreditPartyName"].ToString(),
                        TransactionDebit = rdr["DebitPartyName"].ToString(),

                        TransactionAmount = rdr.GetDecimal(rdr.GetOrdinal("Amount")),
                        TransactionType = rdr["VoucherType"].ToString(),
                        TransactionRemarks = rdr["Remarks"].ToString(),
                        TransactionPaymentType = rdr["ptype"].ToString(),
                        TransactionDated = rdr["tdate"] as DateTime? ?? DateTime.MinValue








,


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }

        //        public async Task<List<CompanyModel>> GetLedgerDetails(int Partyid)
        //        {
        //            List<CompanyModel> banks = new List<CompanyModel>();

        //            using (SqlConnection con = new SqlConnection(_configuration.Value))
        //            {
        //                const string query = @"
        //SELECT 
        //    t.tid AS id,
        //    t.tdate,
        //    t.Remarks,
        //    t.ptype,
        //    vg.Mastername AS VoucherType,
        //    dp.[type] + '-' + dp.partytypeid + '-' + dp.partyname AS DebitPartyName,
        //    cp.[type] + '-' + cp.partytypeid + '-' + cp.partyname AS CreditPartyName,
        //    t.remarks,
        //    t.Debit,
        //    ISNULL(t.Credit, 0) AS Credit,

        //    -- Calculate running total
        //    abs(SUM(ISNULL(t.Debit, 0) - ISNULL(t.Credit, 0)) OVER (ORDER BY t.tid ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)) AS RunningTotal,

        //    -- Determine type based on running total
        //    CASE 
        //        WHEN SUM(ISNULL(t.Debit, 0) - ISNULL(t.Credit, 0)) OVER (ORDER BY t.tid ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) >= 0 THEN 'Dr'
        //        ELSE 'Cr'
        //    END AS Type

        //FROM Transactions t
        //LEFT JOIN party dp ON t.debitpartyid = dp.idno
        //LEFT JOIN party cp ON t.creditpartyid = cp.idno
        //LEFT JOIN vouchergroup vg ON t.Ttype = vg.id
        //WHERE t.id = @Id AND t.flagdeleted = 0
        //ORDER BY t.tid";

        //                SqlCommand cmd = new SqlCommand(query, con)
        //                {
        //                    CommandType = CommandType.Text
        //                };
        //                cmd.Parameters.AddWithValue("@Id", Partyid);

        //                con.Open();

        //                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

        //                while (rdr.Read())
        //                {
        //                    CompanyModel companyModel = new CompanyModel
        //                    {
        //                        TransactionId = Convert.ToInt32(rdr["id"]),
        //                        TransactionCredit = rdr["CreditPartyName"].ToString(),
        //                        TransactionDebit = rdr["DebitPartyName"].ToString(),
        //                        TransactionType = rdr["VoucherType"].ToString(),
        //                        TransactionRemarks = rdr["Remarks"].ToString(),
        //                        TransactionPaymentType = rdr["ptype"].ToString(),
        //                        TransactionDated = rdr["tdate"] as DateTime? ?? DateTime.MinValue,
        //                        TransactionRunning = rdr.GetDecimal(rdr.GetOrdinal("RunningTotal")),
        //                        TransactionDebitAmt = rdr.GetDecimal(rdr.GetOrdinal("Debit")),
        //                        TransactionCreditAmt = rdr.GetDecimal(rdr.GetOrdinal("Credit")),
        //                        BalanceType = rdr["Type"].ToString()










        //,


        //                    };
        //                    banks.Add(companyModel);
        //                }
        //                con.Close();
        //                cmd.Dispose();
        //            }
        //            return banks;
        //        }


        public async Task<List<CompanyModel>> GetallMasterGroup()
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select id,MasterName,CreatedDate,Status,Description from AccountMasters where flagdeleted=0 order by id desc";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        Mid = Convert.ToInt32(rdr["Id"]),
                        MaccGrp = rdr["MasterName"].ToString(),
                        MaccDetails = rdr["description"].ToString(),
                        MacStatus = rdr.GetBoolean(rdr.GetOrdinal("status")),
                        MacCreatedDate = rdr["createdDate"] as DateTime? ?? DateTime.MinValue


,


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }

        public async Task<List<CompanyModel>> GetallItemGroup()
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select b.mastername,a.itemid,a.itemname,a.itemuom,a.itemgst,a.itemhsn,a.status,a.Createdon from masterItems a,PurchaseGroup b where a.prGroup=b.id and a.flagdeleted=0 order by a.itemid ";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        PurchGrp = rdr["mastername"].ToString(),
                        Itemid = Convert.ToInt32(rdr["itemid"]),
                        PurchaseItemName = rdr["itemname"].ToString(),
                        ItemUom = rdr["itemuom"].ToString(),
                        ItemGst = rdr["itemgst"].ToString(),
                        ItemHsn = rdr["itemhsn"].ToString(),
                        ItemStatus = rdr.GetBoolean(rdr.GetOrdinal("status")),
                        ItemCreatedDate = rdr["createdon"] as DateTime? ?? DateTime.MinValue

,


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }

        public async Task<List<CompanyModel>> GetAllapckingDraft(int unit)
        {
            List<CompanyModel> Draftlist = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct PackingDraftno,DraftId from RepackDraftItems where UnitId =@unitid and flagdeleted=0 ";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@unitid", unit);

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        DraftId = Convert.ToInt32(rdr["DraftId"]),
                        DraftIrn = rdr["PackingDraftno"].ToString()
                       
,


                    };
                    Draftlist.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Draftlist;
        }

        public async Task<List<CompanyModel>> GetAllapckingDraftall()
        {
            List<CompanyModel> Draftlist = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct PackingDraftno,DraftId from RepackDraftItems where flagdeleted=0 ";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
             
                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        DraftId = Convert.ToInt32(rdr["DraftId"]),
                        DraftIrn = rdr["PackingDraftno"].ToString()

,


                    };
                    Draftlist.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Draftlist;
        }







        public async Task<List<CompanyModel>> GetAllapckingOrders(int unit)
        {
            List<CompanyModel> PackingOrderist = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct PackingOrderno,PackingOrderId from PackingOrderItems where approved=1 and UnitId =@unitid and flagdeleted=0 ";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@unitid", unit);

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Packingorderid = Convert.ToInt32(rdr["PackingOrderId"]),
                        PackingOrderIrn = rdr["PackingOrderno"].ToString()

,


                    };
                    PackingOrderist.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return PackingOrderist;
        }



















        public async Task<List<CompanyModel>> GetAllGrades(int unit)
        {
            List<CompanyModel> GradeList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct Gradename,id from itemgrades where id in(select distinct GradeId from RepackDraftItems where UnitId =@unitid and flagdeleted=0)";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@unitid", unit);

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Gradeid = Convert.ToInt32(rdr["id"]),
                        ReceipeGrade = rdr["Gradename"].ToString()

,


                    };
                    GradeList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GradeList;
        }



        public async Task<List<CompanyModel>> GetAllReceipes(int unit)
        {
            List<CompanyModel> Recipelist = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct  Recipeid,recipename from Recipe where Recipeid in(select distinct RecipeId from RepackDraftItems where UnitId =@unitid and flagdeleted=0)";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@unitid", unit);

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        ReceipeId = Convert.ToInt32(rdr["Recipeid"]),
                        ReceipeName = rdr["recipename"].ToString()

,


                    };
                    Recipelist.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Recipelist;
        }


        public async Task<List<CompanyModel>> GetPallets(int unit)
        {
            List<CompanyModel> GetAllpellets = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct palletno,PalletIrn from RepackDraftItems where UnitId =@unitid and flagdeleted=0";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@unitid", unit);

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        PalletName = rdr["PalletIrn"].ToString(),
                         PalletId  = Convert.ToInt32(rdr["palletno"])



,


                    };
                    GetAllpellets.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetAllpellets;
        }


        public async Task<List<CompanyModel>> GetAllVehGroup()
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select vid as Id,Vehno as Vehno,drivername as Driver,contactno as Contact,status,vehtype from vehinfo where flagdeleted=0 order by vid ";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Vehno = rdr["Vehno"].ToString(),
                        Vehid = Convert.ToInt32(rdr["Id"]),
                        VehDriver = rdr["Driver"].ToString(),
                        Vehtype = rdr["vehtype"].ToString(),
                        VehContact = rdr["Contact"].ToString(),

                        VehStatus = rdr.GetBoolean(rdr.GetOrdinal("status"))

,


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }















        public async Task<List<CompanyModel>> GetallPurchaseGroup()
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select id,MasterName,CreatedDate,Status,Description from PurchaseGroup where flagdeleted=0 order by id desc";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        Pid = Convert.ToInt32(rdr["Id"]),
                        PurchGrp = rdr["MasterName"].ToString(),
                        PurchDetails = rdr["description"].ToString(),
                        PurchStatus = rdr.GetBoolean(rdr.GetOrdinal("status")),
                        PurchCreatedDate = rdr["createdDate"] as DateTime? ?? DateTime.MinValue


,


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }








        public async Task<List<CompanyModel>> GetallVoucherGroup()
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select id,MasterName,CreatedDate,Status,Description from VoucherGroup where flagdeleted=0 order by id desc";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        VoucherId = Convert.ToInt32(rdr["Id"]),
                        VoucherName = rdr["MasterName"].ToString(),
                        VoucherRemarks = rdr["description"].ToString(),
                        VoucherStatus = rdr.GetBoolean(rdr.GetOrdinal("status")),
                        VoucherCreatedDate = rdr["createdDate"] as DateTime? ?? DateTime.MinValue


,


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }
















        public async Task<List<CompanyModel>> GetallMasterSubGroup()
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select a.id as Id,MasterName,MasterSubname,a.CreatedDate,a.Status,a.Description from AccountMasterSub a, AccountMasters b where a.mgroupid=b.id and a.flagdeleted=0 and a.status=1 order by id desc";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        SubAccid = Convert.ToInt32(rdr["Id"]),
                        MaccGrp = rdr["MasterName"].ToString(),
                        SubaccDetails = rdr["description"].ToString(),
                        SubaccGrp = rdr["MasterSubname"].ToString(),
                        SubAccStatus = rdr.GetBoolean(rdr.GetOrdinal("status")),

                        MacCreatedDate = rdr["createdDate"] as DateTime? ?? DateTime.MinValue


,


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }




        public async Task<List<CompanyModel>> GetallSubGroup()
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select a.id as Id,MasterSubname,subname,a.CreatedDate,a.Status,a.Description from AccountSubGroups a, AccountMasterSub b where a.mgroupid=b.id and a.flagdeleted=0 order by id desc";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        SubGroupId = Convert.ToInt32(rdr["Id"]),
                        SubaccGrp = rdr["MasterSubname"].ToString(),
                        SubGroupDetails = rdr["description"].ToString(),
                        SubgroupName = rdr["subname"].ToString(),
                        SubGroupStatus = rdr.GetBoolean(rdr.GetOrdinal("status")),

                        SubGroupCreated = rdr["createdDate"] as DateTime? ?? DateTime.MinValue


,


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }
















        public async Task<List<CompanyModel>> GetallChallanlist(String ChallanGroup)
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "SELECT id, ChallanName, Address, Phone1 +SPACE(1) + CAST(IsSMSPhone1 AS VARCHAR) AS Phone1, Phone2 +SPACE(2) + CAST(IsSMSPhone2 AS VARCHAR) AS Phone2 FROM challanmaster WHERE flagdeleted = 0 AND mainid IN(SELECT partycode FROM party WHERE partytypeid + '-' + RTRIM(partyname) = @GrowerGroup)";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                cmd.Parameters.AddWithValue("@GrowerGroup", ChallanGroup);

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        ChallanId = Convert.ToInt32(rdr["id"]),
                        ChallanName = rdr["ChallanName"].ToString(),

                        ChallanAddress = rdr["Address"].ToString(),
                        ChallanPhone1 = rdr["Phone1"].ToString(),
                        ChallanPhone2 = rdr["Phone2"].ToString()


                        //,
                        //                        ChallanName,
                        //                        Address,
                        //                        Phone1 + space(1) & IsSMSPhone1,
                        //                        Phone2 + space(2) & IsSMSPhone2


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }















        


             public async Task<List<CompanyModel>> GetallSubGrowersfull()
        {
            List<CompanyModel> GetSubGrowerGroupall = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "SELECT CONCAT(CAST(PartyID AS VARCHAR(MAX)), '-', PartyName) AS GrowerName FROM PartySub WHERE Status = 1;";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        OrderBy = rdr["GrowerName"].ToString(),
                        TransferTo = rdr["GrowerName"].ToString()








                    };
                    GetSubGrowerGroupall.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetSubGrowerGroupall;
        }





        public async Task<List<CompanyModel>> GetallSubGrowers(int Growerid)
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select  b.partytypeid+'-'+ rtrim(b.partyname) as Groupname,a.partycode as Code,a.GrowerName,a.address,a.status,a.Crateqtylimit as [Crate Issue],a.crateissuelimitper as [percent] from partysub a,party b where a.type=b.type and a.mainid=b.partycode and a.type='C' AND a.flagdeleted=0 AND a.status=1  and a.Mainid=@Growerid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Growerid", Growerid);

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        GrowerGroupName = rdr["Groupname"].ToString(),
                        SubGrowerId = Convert.ToInt32(rdr["Code"]),
                        GrowerName = rdr["GrowerName"].ToString(),
                        GrowerAddress = rdr["address"].ToString(),
                        GrowerRetAcitve = Convert.ToBoolean(rdr["status"]),
                        GrowerCrateissue = rdr.GetDecimal(rdr.GetOrdinal("Crate Issue")),
                        GrowerCratelimit = rdr.GetDecimal(rdr.GetOrdinal("percent"))






                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }

        public async Task<List<CompanyModel>> GetRunningChambers(int selectedid)
        {
            List<CompanyModel> Runningchambers = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "runningchambers";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.StoredProcedure
                };
                cmd.Parameters.AddWithValue("@Growerid", selectedid);

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        ChamberId = Convert.ToInt32(rdr["ChamberId"]),

                        ChamberAvailQty = rdr.GetDecimal(rdr.GetOrdinal("RemainingQty")),



                    };
                    Runningchambers.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Runningchambers;
        }




        public async Task<List<CompanyModel>> GetallCrateTypes()
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select * from dbo.crtypes order by id";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Crid = rdr.GetInt32(rdr.GetOrdinal("id")),

                        Crname = rdr["name"].ToString(),
                        Crqty = rdr.GetDecimal(rdr.GetOrdinal("crqty")),


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }





        public async Task<List<CompanyModel>> GetallService()
        {
            List<CompanyModel> ServiceType = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select * from dbo.servicetypes";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Skid = rdr.GetInt32(rdr.GetOrdinal("id")),

                        Stname = rdr["sname"].ToString(),
                        Stdetails = rdr["sdescrip"].ToString(),


                    };
                    ServiceType.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return ServiceType;
        }






        public async Task<List<CompanyModel>> GetallQuality()
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select * from dbo.prodqaul";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Qid = rdr.GetInt32(rdr.GetOrdinal("id")),

                        Qname = rdr["name"].ToString(),
                        Qdetails = rdr["qdescrip"].ToString(),


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }





        public async Task<List<CompanyModel>> GetallpartyQuality(int unitid, string GrowerName)
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select * from prodqaul where id in(select verifiedbrandid from gateintrans where Unitid=@Unitid and flagdeleted=0 and  partyid in(select partyid from party where  partytypeid+'-'+ rtrim(partyname)=@Growername))";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Unitid", unitid);
                cmd.Parameters.AddWithValue("@Growername", GrowerName);

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Qid = rdr.GetInt32(rdr.GetOrdinal("id")),

                        Qname = rdr["name"].ToString(),
                        Qdetails = rdr["qdescrip"].ToString(),


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }


        public async Task<List<CompanyModel>> GetallsubQuality(int unitid, string GrowerName,string SelectedSubgrower)
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select * from prodqaul where id in(select verifiedbrandid from gateintrans where Unitid=@Unitid and flagdeleted=0 and growerId in(select partyid from partysub where convert(varchar(max),partyid)  +'-'+ partyname=@Subgrower) and partyid in(select partyid from party where  partytypeid+'-'+ rtrim(partyname)=@Growername))";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Unitid", unitid);
                cmd.Parameters.AddWithValue("@Growername", SelectedSubgrower);
                cmd.Parameters.AddWithValue("@Subgrower", GrowerName);

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Qid = rdr.GetInt32(rdr.GetOrdinal("id")),

                        Qname = rdr["name"].ToString(),
                        Qdetails = rdr["qdescrip"].ToString(),


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }


        public async Task<List<CompanyModel>> GetallchamberQuality(string GrowerName)
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select * from prodqaul where id in(select VerifiedBrandId from gateintrans where flagdeleted=0 and  locationchamberid in(select chamberid from chamber where  chambername=@Growername))";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
            
                cmd.Parameters.AddWithValue("@Growername", GrowerName);

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Qid = rdr.GetInt32(rdr.GetOrdinal("id")),

                        Qname = rdr["name"].ToString(),
                        Qdetails = rdr["qdescrip"].ToString(),


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }

        public async Task<List<CompanyModel>> GetallchamberQualitysub(string GrowerName,string subgrower)
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select * from prodqaul where id in(select VerifiedBrandId from gateintrans where flagdeleted=0 and GrowerId in(select partyid from partysub where convert(varchar(max),partyid)  +'-'+ partyname= @subgrower) and locationchamberid in(select chamberid from chamber where  chambername=@Growername))";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                cmd.Parameters.AddWithValue("@Growername", GrowerName);
                cmd.Parameters.AddWithValue("@subgrower", subgrower);
                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Qid = rdr.GetInt32(rdr.GetOrdinal("id")),

                        Qname = rdr["name"].ToString(),
                        Qdetails = rdr["qdescrip"].ToString(),


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }




















        public async Task<CompanyModel?> AddGrowerGroup(CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("AddGrowerGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@GrowerGrp", companyModel.GrowerGroupName);
                    cmd.Parameters.AddWithValue("@GrowerName", companyModel.GrowerName);


                    cmd.Parameters.AddWithValue("@GrowerAddress", companyModel.GrowerAddress);
                    cmd.Parameters.AddWithValue("@GrowerCity", companyModel.GrowerCity);
                    cmd.Parameters.AddWithValue("@GrowerPincode", companyModel.GrowerPincode);
                    cmd.Parameters.AddWithValue("@GrowerState", companyModel.GrowerState);
                    cmd.Parameters.AddWithValue("@GrowerStatecode", companyModel.GrowerStatecode);
                    cmd.Parameters.AddWithValue("@GrowerEmail", companyModel.GrowerEmail);
                    cmd.Parameters.AddWithValue("@GrowerPan", companyModel.GrowerPan);
                    cmd.Parameters.AddWithValue("@GrowerGst", companyModel.GrowerGst);
                    cmd.Parameters.AddWithValue("@GrowerContact", companyModel.GrowerContact);
                    cmd.Parameters.AddWithValue("@GrowerStatus", companyModel.GrowerActive);
                    cmd.Parameters.AddWithValue("@Createdby", 1);
                    cmd.Parameters.AddWithValue("@Updatedby", 1);
                    cmd.Parameters.AddWithValue("@GrowerVillage", companyModel.GrowerVillage);
                    cmd.Parameters.AddWithValue("@graceperiod", companyModel.GrowerGrace);
                    cmd.Parameters.AddWithValue("@country", companyModel.GrowerCountry); // Assuming village is same as country? Check this logic.
                    cmd.Parameters.AddWithValue("@crateQtyLimit", companyModel.GrowerCrateissue);
                    cmd.Parameters.AddWithValue("@crateQtypercent", companyModel.GrowerCratelimit);
                    cmd.Parameters.AddWithValue("@GrowerisLock", companyModel.GrowerLock);
                    cmd.Parameters.AddWithValue("@Growerisflexi", companyModel.GrowerFlexi);

                    cmd.Parameters.AddWithValue("@growerRemarks", companyModel.GrowerRemarks);

                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }

                    return companyModel;
                }
            }



        }


        public async Task<CompanyModel?> AddTransaction(CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("AddTransaction", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@CreditGrp", companyModel.TransactionCredit);
                    cmd.Parameters.AddWithValue("@DebitGrp", companyModel.TransactionDebit);
                    cmd.Parameters.AddWithValue("@TransactionType", companyModel.TransactionType);
                    cmd.Parameters.AddWithValue("@PaymentType", companyModel.TransactionPaymentType);
                    cmd.Parameters.AddWithValue("@Dated", companyModel.TransactionDated);
                    cmd.Parameters.AddWithValue("@Remarks", companyModel.TransactionRemarks);
                    cmd.Parameters.AddWithValue("@Chno", companyModel.TransactionChequeno);
                    cmd.Parameters.AddWithValue("@Refno", companyModel.TransactionRefno);
                    cmd.Parameters.AddWithValue("@Amount", companyModel.TransactionAmount);
                    cmd.Parameters.AddWithValue("@Createdby", 1);

                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }





        public async Task<CompanyModel?> UpdateTransaction(CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdateTransaction", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    cmd.Parameters.AddWithValue("@TransactionId", companyModel.TransactionId);
                    cmd.Parameters.AddWithValue("@CreditGrp", companyModel.TransactionCredit);
                    cmd.Parameters.AddWithValue("@DebitGrp", companyModel.TransactionDebit);
                    cmd.Parameters.AddWithValue("@TransactionType", companyModel.TransactionType);
                    cmd.Parameters.AddWithValue("@PaymentType", companyModel.TransactionPaymentType);
                    cmd.Parameters.AddWithValue("@Dated", companyModel.TransactionDated);
                    cmd.Parameters.AddWithValue("@Remarks", companyModel.TransactionRemarks);
                    cmd.Parameters.AddWithValue("@Chno", companyModel.TransactionChequeno);
                    cmd.Parameters.AddWithValue("@Refno", companyModel.TransactionRefno);
                    cmd.Parameters.AddWithValue("@Amount", companyModel.TransactionAmount);
                    cmd.Parameters.AddWithValue("@Updatedby", 1);

                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }






















        public async Task<CompanyModel?> ValidateStoreOutTransQty(CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("ValidateStoreOutTransQty", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@OutID", companyModel.DemandNo);
                    cmd.Parameters.AddWithValue("@Lotno", companyModel.Lotno);


                    cmd.Parameters.AddWithValue("@NewQty", companyModel.TotalStoreOut);
                   
                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }

        public async Task<CompanyModel?> ValidateDemandEditQty(CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("ValidateDemandEditQty", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@OutID", companyModel.DemandNo);
                    cmd.Parameters.AddWithValue("@Lotno", companyModel.Lotno);


                    cmd.Parameters.AddWithValue("@NewQty", companyModel.OrderQty);

                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }

        public async Task<CompanyModel?> ValidatePelletQty(CompanyModel companyModel,int unit)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("ValidatePelletQty", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@OutID", companyModel.PalletId);
                 

                    cmd.Parameters.AddWithValue("@NewQty", companyModel.selectedPackingQty);
                    cmd.Parameters.AddWithValue("@unitid", unit);
                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }








        public async Task<CompanyModel?> ValidatedemandStatus(CompanyModel companyModel, int outid)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("ValidatedemandStatus", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@OutID", outid);


                
                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }





























        public async Task<CompanyModel?> ValidateStoreout(CompanyModel companyModel,int Trid, int selectedId)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("ValidateStoreout", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Lotid", Trid);
                    cmd.Parameters.AddWithValue("@Outid", selectedId);

                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }





        public async Task<CompanyModel?> ValidatePackingDraftpellet(int Selectedid, int unit,CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("ValidatePackingDraftpellet", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@OutID", Selectedid);


              
                    cmd.Parameters.AddWithValue("@unitid", unit);
                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }












































        public async Task<CompanyModel?> ValidatePelletDispatch(CompanyModel companyModel, int unit)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("ValidatePelletDispatch", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@OutID", companyModel.PalletId);


                    cmd.Parameters.AddWithValue("@NewQty", companyModel.DispatchQty);
                    cmd.Parameters.AddWithValue("@unitid", unit);
                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }

        public async Task<CompanyModel?> ValidatePelletoutward(CompanyModel companyModel, int unit,int tempid)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("ValidatePelletoutward", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@OutID", companyModel.PalletId);


                    cmd.Parameters.AddWithValue("@NewQty", companyModel.OutwardQty);
                    cmd.Parameters.AddWithValue("@unitid", unit);
                    cmd.Parameters.AddWithValue("@tempid", tempid);
                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }




        public async Task<CompanyModel?> ValidatePelletQtyEdit(CompanyModel companyModel, int unit)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("ValidatePelletQtyEdit", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@OutID", companyModel.PalletId);


                    cmd.Parameters.AddWithValue("@NewQty", companyModel.selectedPackingQty);
                    cmd.Parameters.AddWithValue("@unitid", unit);
                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }


        public async Task<CompanyModel?> ValidateSachetEditQty(CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("ValidateSachetEditQty", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Draftid", companyModel.DraftId);
                    cmd.Parameters.AddWithValue("@Recepid", companyModel.ReceipeId);


                    cmd.Parameters.AddWithValue("@NewQty", companyModel.SachetQty);
                  
                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }

















        public async Task<CompanyModel?> ValidatePackingDraft(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("ValidatePackingDraft", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@OutID", EditModel.DraftId);

                  
                    cmd.Parameters.AddWithValue("@Receipe", EditModel.ReceipeName);



                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }



        public async Task<CompanyModel?> ValidateDraftQty(CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("ValidateDraftQty", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@OutID", companyModel.DemandNo);
                    cmd.Parameters.AddWithValue("@Lotno", companyModel.Lotno);
                    cmd.Parameters.AddWithValue("@NewQty", companyModel.GradingQty);
                     await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }
















        public async Task<CompanyModel?> AddStoreOut(CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("AddStoreOut", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@OutID", companyModel.DemandNo);
                    cmd.Parameters.AddWithValue("@Lotno", companyModel.Lotno);


                    cmd.Parameters.AddWithValue("@NewQty", companyModel.TotalStoreOut);
                    cmd.Parameters.AddWithValue("@Createdby", companyModel.GlobalUserName);
                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }









        public async Task<CompanyModel?> AddAccountName(CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("AddAccountName", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@GrowerGrp", companyModel.AccountGroup);
                    cmd.Parameters.AddWithValue("@GrowerName", companyModel.AccountName);


                    cmd.Parameters.AddWithValue("@GrowerAddress", companyModel.AccountAddress);
                    cmd.Parameters.AddWithValue("@GrowerCity", companyModel.AccountCity);
                    cmd.Parameters.AddWithValue("@GrowerPincode", companyModel.AccountPincode);
                    cmd.Parameters.AddWithValue("@GrowerState", companyModel.AccountState);
                    cmd.Parameters.AddWithValue("@GrowerStatecode", companyModel.AccountStatecode);
                    cmd.Parameters.AddWithValue("@GrowerEmail", companyModel.AccountEmail);
                    cmd.Parameters.AddWithValue("@GrowerPan", companyModel.AccountPan);
                    cmd.Parameters.AddWithValue("@GrowerGst", companyModel.AccountGst);
                    cmd.Parameters.AddWithValue("@GrowerContact", companyModel.AccountContact);
                    cmd.Parameters.AddWithValue("@GrowerStatus", companyModel.AccountActive);
                    cmd.Parameters.AddWithValue("@Createdby", 1);
                    cmd.Parameters.AddWithValue("@Updatedby", 1);
                    cmd.Parameters.AddWithValue("@GrowerVillage", companyModel.AccountVillage);
                    cmd.Parameters.AddWithValue("@graceperiod", "1");
                    cmd.Parameters.AddWithValue("@country", companyModel.AccountCountry); // Assuming village is same as country? Check this logic.
                    cmd.Parameters.AddWithValue("@crateQtyLimit", 0);
                    cmd.Parameters.AddWithValue("@crateQtypercent", 0);
                    cmd.Parameters.AddWithValue("@GrowerisLock", companyModel.AccountLock);
                    cmd.Parameters.AddWithValue("@Growerisflexi", "0");

                    cmd.Parameters.AddWithValue("@growerRemarks", companyModel.AccountRemarks);
                    cmd.Parameters.AddWithValue("@growerapproval", companyModel.AccountApproval);
                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }

        public async Task<CompanyModel?> AdduserName(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("AdduserName", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Username", EditModel.UserName);
                    cmd.Parameters.AddWithValue("@Password", EditModel.UserPassword);


                    cmd.Parameters.AddWithValue("@Useremail", EditModel.Useremail);

                    cmd.Parameters.AddWithValue("@UserGroup", EditModel.GlobalUserGroup);
                    cmd.Parameters.AddWithValue("@Userstatus", EditModel.UserStatus);
                    cmd.Parameters.AddWithValue("@Unit1", EditModel.Unit1);
                    cmd.Parameters.AddWithValue("@Unit2", EditModel.Unit2);

                    cmd.Parameters.AddWithValue("@Unit3", EditModel.Unit3);

                    cmd.Parameters.AddWithValue("@Unit4", EditModel.Unit4);

                    cmd.Parameters.AddWithValue("@Unit5", EditModel.Unit5);
                    cmd.Parameters.AddWithValue("@Globalusername", EditModel.GlobalUserName);



                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }




        public async Task<CompanyModel?> AddNewChamber(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("AddNewChamber", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@ctype", EditModel.ChamberType);
                    cmd.Parameters.AddWithValue("@unit", EditModel.Unitname);


                    cmd.Parameters.AddWithValue("@Capacity", EditModel.Capacity);
                    cmd.Parameters.AddWithValue("@User", EditModel.GlobalUserName);




                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }

        public async Task<CompanyModel?> AddSlot(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("addslot", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Sdate", EditModel.calendardate);
                    cmd.Parameters.AddWithValue("@partyid", EditModel.GrowerGroupName);


                    cmd.Parameters.AddWithValue("@growerid", EditModel.GrowerName);


                    cmd.Parameters.AddWithValue("@Contact", EditModel.GrowerContact);
                    cmd.Parameters.AddWithValue("@Qty", EditModel.SlotQty);
                    cmd.Parameters.AddWithValue("@ttime", EditModel.calendartime);





                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }

        public async Task<CompanyModel?> UpdateSlot(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdateSlot", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!

                    cmd.Parameters.AddWithValue("@id", EditModel.Slotno);
                    cmd.Parameters.AddWithValue("@Sdate", EditModel.calendardate);
                    cmd.Parameters.AddWithValue("@partyid", EditModel.GrowerGroupName);


                    cmd.Parameters.AddWithValue("@growerid", EditModel.GrowerName);


                    cmd.Parameters.AddWithValue("@Contact", EditModel.GrowerContact);
                    cmd.Parameters.AddWithValue("@Qty", EditModel.SlotQty);
                    cmd.Parameters.AddWithValue("@ttime", EditModel.calendartime);





                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }

        public async Task<CompanyModel?> UpdateChamber(int chamberid, CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdateChamber", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;
                    cmd.Parameters.AddWithValue("@chamberid", chamberid);

                    cmd.Parameters.AddWithValue("@ctype", EditModel.ChamberType);
                    cmd.Parameters.AddWithValue("@unit", EditModel.Unitname);


                    cmd.Parameters.AddWithValue("@Capacity", EditModel.Capacity);
                    cmd.Parameters.AddWithValue("@User", EditModel.GlobalUserName);




                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }

        public async Task<CompanyModel?> AdduserGroupName(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("AdduserGroupName", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Usergroup", EditModel.UserGroupName);
                    cmd.Parameters.AddWithValue("@UsergroupRemarks", EditModel.UserGroupRemarks);


                    cmd.Parameters.AddWithValue("@Globalusername", EditModel.GlobalUserName);



                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }


        public async Task<CompanyModel?> UpdateuserName(CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdateuserName", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    cmd.Parameters.AddWithValue("@userid", companyModel.Userid);
                    cmd.Parameters.AddWithValue("@Username", companyModel.UserName);


                    cmd.Parameters.AddWithValue("@Useremail", companyModel.Useremail);

                    cmd.Parameters.AddWithValue("@UserGroup", companyModel.GlobalUserGroup);
                    cmd.Parameters.AddWithValue("@Userstatus", companyModel.UserStatus);
                    cmd.Parameters.AddWithValue("@Unit1", companyModel.Unit1);
                    cmd.Parameters.AddWithValue("@Unit2", companyModel.Unit2);

                    cmd.Parameters.AddWithValue("@Unit3", companyModel.Unit3);

                    cmd.Parameters.AddWithValue("@Unit4", companyModel.Unit4);

                    cmd.Parameters.AddWithValue("@Unit5", companyModel.Unit5);
                    cmd.Parameters.AddWithValue("@Globalusername", companyModel.GlobalUserName);



                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }





        public async Task<CompanyModel?> UpdateuserPassword(CompanyModel companyModel, string apassoword)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdateuserPassword", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    cmd.Parameters.AddWithValue("@userid", companyModel.Userid);
                    cmd.Parameters.AddWithValue("@Password", apassoword);



                    cmd.Parameters.AddWithValue("@Globalusername", companyModel.GlobalUserName);



                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }

        public async Task<CompanyModel?> UpdateUserPasswordAsync(CompanyModel companyModel, string username, string oldpassword, string newpassword)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdateuserPasswordcheck", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    cmd.Parameters.AddWithValue("@Globalusername", username);
                    cmd.Parameters.AddWithValue("@Opassword", oldpassword);

                    cmd.Parameters.AddWithValue("@Npassword", newpassword);




                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }
        public async Task<CompanyModel?> CheckUser(CompanyModel loginModel)
        {
            if (loginModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("checkuser", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    cmd.Parameters.AddWithValue("@uname", loginModel.GlobalUserName);
                    cmd.Parameters.AddWithValue("@pwd", loginModel.UserPassword);
                    cmd.Parameters.AddWithValue("@unit", loginModel.GlobalUnitName);





                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks,unitid,usergroup FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            loginModel.RetMessage = rdr["remarks"]?.ToString();
                            loginModel.RetFlag = rdr["flag"]?.ToString();
                            loginModel.GlobalUnitId = Convert.ToInt32(rdr["unitid"]);
                            loginModel.GlobalUserGroup = rdr["usergroup"]?.ToString();

                        }
                    }
                }

                return loginModel;
            }
        }






















        public async Task<CompanyModel?> GeneratePurchaseOrder(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("GeneratePurchaseOrder", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@PurchGrp", EditModel.AccountName);
                    cmd.Parameters.AddWithValue("@Odate", EditModel.PurchaseOrderDated);
                    cmd.Parameters.AddWithValue("@Billto", EditModel.PurchaseOrderBillto);
                    cmd.Parameters.AddWithValue("@Delto", EditModel.PurchaseOrderDel);
                    cmd.Parameters.AddWithValue("@Rems", EditModel.PurchaseOrderRemarks);
                    cmd.Parameters.AddWithValue("@UserId", EditModel.UserId);

                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }
     


           



            public async Task<CompanyModel?> AddAgreement(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("AddGrowerAgreement", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;
                    //Add("@BinRent", SqlDbType.Money).Value
                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@GrowerGrp", EditModel.GrowerGroupSelectName);
                    cmd.Parameters.AddWithValue("@Fyear", EditModel.Fyear);
                    cmd.Parameters.AddWithValue("@Adate", EditModel.Adated);
                    cmd.Parameters.AddWithValue("@InwardDate", EditModel.Idated);
                    cmd.Parameters.AddWithValue("@aqty", EditModel.Aqty);
                    cmd.Parameters.AddWithValue("@createdby", "1");
                    cmd.Parameters.AddWithValue("@item", EditModel.Itemname);
                    cmd.Parameters.AddWithValue("@bins", "1");

                    var storeRentParam = cmd.Parameters.Add("@StoreRent", SqlDbType.Decimal);
                    storeRentParam.Precision = 10;
                    storeRentParam.Scale = 2;
                    storeRentParam.Value = EditModel.StoreRent.HasValue
    ? (object)EditModel.StoreRent.Value
    : DBNull.Value;





                    //      cmd.Parameters.Add("@StoreRent", SqlDbType.Decimal).Value = EditModel.StoreRent;
                    ////      cmd.Parameters.AddWithValue("@Storerent", EditModel.StoreRent);
                    //      cmd.Parameters["@StoreRent"].Precision = 18;
                    //      cmd.Parameters["@StoreRent"].Scale = 2;

                    cmd.Parameters.AddWithValue("@BinRate ", EditModel.BinRent);
                    cmd.Parameters.AddWithValue("@CrateRental", EditModel.CrateRate);
                    cmd.Parameters.AddWithValue("@LabourRate", EditModel.LabourRate);

                    cmd.Parameters.AddWithValue("@GradingRate ", EditModel.GradingRent);
                    cmd.Parameters.AddWithValue("@PackingRate", EditModel.PackingRent);
                    cmd.Parameters.AddWithValue("@Service", EditModel.Atype); // Assuming village is same as country? Check this logic.
                    cmd.Parameters.AddWithValue("@RateType", EditModel.RentType);
                    cmd.Parameters.AddWithValue("@chamber", EditModel.Achambers);
                    cmd.Parameters.AddWithValue("@InvFlag", EditModel.InvestFlag);
                    cmd.Parameters.AddWithValue("@saleFlag", EditModel.SalesType);

                    cmd.Parameters.AddWithValue("@invQty", EditModel.InvestQty);
                    cmd.Parameters.AddWithValue("@invrate", EditModel.InvestRate);
                    cmd.Parameters.AddWithValue("@Commpercent", EditModel.Invpercent);

                    cmd.Parameters.AddWithValue("@Growerid", EditModel.Growerid);


                    await cmd.ExecuteNonQueryAsync();
                }


                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }






        public async Task<CompanyModel?> UpdateAgreement(CompanyModel EditModel, int AgreementId)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdateGrowerAgreement", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;
                    //Add("@BinRent", SqlDbType.Money).Value
                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@AgreementId", AgreementId);
                    cmd.Parameters.AddWithValue("@GrowerGrp", EditModel.GrowerGroupSelectName);

                    cmd.Parameters.AddWithValue("@Fyear", EditModel.Fyear);
                    cmd.Parameters.AddWithValue("@Adate", EditModel.Adated);
                    cmd.Parameters.AddWithValue("@InwardDate", EditModel.Idated);
                    cmd.Parameters.AddWithValue("@aqty", EditModel.Aqty);
                    cmd.Parameters.AddWithValue("@updatedby", "1");
                    cmd.Parameters.AddWithValue("@item", EditModel.Itemname);
                    cmd.Parameters.AddWithValue("@bins", "1");

                    var storeRentParam = cmd.Parameters.Add("@StoreRent", SqlDbType.Decimal);
                    storeRentParam.Precision = 10;
                    storeRentParam.Scale = 2;
                    storeRentParam.Value = EditModel.StoreRent.HasValue
    ? (object)EditModel.StoreRent.Value
    : DBNull.Value;





                    //      cmd.Parameters.Add("@StoreRent", SqlDbType.Decimal).Value = EditModel.StoreRent;
                    ////      cmd.Parameters.AddWithValue("@Storerent", EditModel.StoreRent);
                    //      cmd.Parameters["@StoreRent"].Precision = 18;
                    //      cmd.Parameters["@StoreRent"].Scale = 2;

                    cmd.Parameters.AddWithValue("@BinRate ", EditModel.BinRent);
                    cmd.Parameters.AddWithValue("@CrateRental", EditModel.CrateRate);
                    cmd.Parameters.AddWithValue("@LabourRate", EditModel.LabourRate);

                    cmd.Parameters.AddWithValue("@GradingRate ", EditModel.GradingRent);
                    cmd.Parameters.AddWithValue("@PackingRate", EditModel.PackingRent);
                    cmd.Parameters.AddWithValue("@Service", EditModel.Atype); // Assuming village is same as country? Check this logic.
                    cmd.Parameters.AddWithValue("@RateType", EditModel.RentType);
                    cmd.Parameters.AddWithValue("@chamber", EditModel.Achambers);
                    cmd.Parameters.AddWithValue("@InvFlag", EditModel.InvestFlag);
                    cmd.Parameters.AddWithValue("@saleFlag", EditModel.SalesType);

                    cmd.Parameters.AddWithValue("@invQty", EditModel.InvestQty);
                    cmd.Parameters.AddWithValue("@invrate", EditModel.InvestRate);
                    cmd.Parameters.AddWithValue("@Commpercent", EditModel.Invpercent);

                    cmd.Parameters.AddWithValue("@Growerid", EditModel.Growerid);


                    await cmd.ExecuteNonQueryAsync();
                }


                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }




















        public async Task<CompanyModel?> GetAgreementId(int agreementId)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "select a.*,b.name as ItemType,rtrim(c.sname) as Agtype from GrowerAgreement a,prodtype b,servicetypes  c where a.itemID=b.id and a.service=c.id and a.flagdeleted=0 AND  a.AgreementId = @AgreementId";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@AgreementId", agreementId);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                BinRent = reader.GetDecimal(reader.GetOrdinal("BinRate")),
                                StoreRent = reader.GetDecimal(reader.GetOrdinal("StoreRent")),
                                CrateRate = reader.GetDecimal(reader.GetOrdinal("Craterental")),
                                GradingRent = reader.GetDecimal(reader.GetOrdinal("GradingRate")),
                                PackingRent = reader.GetDecimal(reader.GetOrdinal("PackingRate")),
                                LabourRate = reader.GetDecimal(reader.GetOrdinal("LabourRate")),

                              Aqty = reader.GetDecimal(reader.GetOrdinal("qty")),
                                Fyear = reader["fyearid"] as string,
                                RentType = reader["RateType"] as string,
                                Itemname = reader["ItemType"] as string,
                                Atype = reader["Agtype"] as string,

                                Adated = reader["Dated"] as DateTime? ?? DateTime.MinValue,
                                Idated = reader["inwarddate"] as DateTime? ?? DateTime.MinValue,
                                Investmentflag = reader.GetBoolean(reader.GetOrdinal("Investment")),
                                InvestQty = reader.GetDecimal(reader.GetOrdinal("invqty")),
                                InvestRate = reader.GetDecimal(reader.GetOrdinal("InvRate")),
                                Invpercent = reader.GetDecimal(reader.GetOrdinal("Commpercent"))



                                //    cmd.Parameters.AddWithValue("@GrowerGrp", companyModel.GrowerGroupSelectName);
                                //cmd.Parameters.AddWithValue("@Fyear", companyModel.Fyear);
                                //cmd.Parameters.AddWithValue("@Adate", companyModel.Adated);
                                //cmd.Parameters.AddWithValue("@InwardDate", companyModel.Idated);
                                //cmd.Parameters.AddWithValue("@aqty", companyModel.Aqty);
                                //cmd.Parameters.AddWithValue("@createdby", "1");
                                //cmd.Parameters.AddWithValue("@item", companyModel.Itemname);
                                //cmd.Parameters.AddWithValue("@bins", "1");
                                //cmd.Parameters.AddWithValue("@Storerent", companyModel.StoreRent);
                                //cmd.Parameters.AddWithValue("@BinRate ", companyModel.BinRent);
                                //cmd.Parameters.AddWithValue("@CrateRental", companyModel.CrateRate);
                                //cmd.Parameters.AddWithValue("@LabourRate", companyModel.LabourRate);

                                //cmd.Parameters.AddWithValue("@GradingRate ", companyModel.GradingRent);
                                //cmd.Parameters.AddWithValue("@PackingRate", companyModel.PackingRent);
                                //cmd.Parameters.AddWithValue("@Service", companyModel.Atype); // Assuming village is same as country? Check this logic.
                                //cmd.Parameters.AddWithValue("@RateType", companyModel.RentType);
                                //cmd.Parameters.AddWithValue("@chamber", companyModel.Achambers);
                                //cmd.Parameters.AddWithValue("@InvFlag", companyModel.InvestFlag);
                                //cmd.Parameters.AddWithValue("@saleFlag", companyModel.SalesType);

                                //cmd.Parameters.AddWithValue("@invQty", companyModel.InvestQty);
                                //cmd.Parameters.AddWithValue("@invrate", companyModel.InvestRate);
                                //cmd.Parameters.AddWithValue("@Commpercent", companyModel.Invpercent);



















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }






        public async Task<List<CompanyModel>> GetSlotbydate(DateTime Slotdate)
        {
            List<CompanyModel> GetGroweralslot = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT
      ci.sdate,p.partytypeid + '-' + p.partyname AS PartyName,
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,ci.sdate,ci.Qty, ttime,ci.contact,ci.id
    
FROM Grading_calendar ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.growerid = ps.partyid

WHERE 
 ci.sdate=@Slotdate and ci.flagdeleted=0

ORDER BY id";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Slotdate", Slotdate);
                con.Open();
                SqlDataReader  reader = await cmd.ExecuteReaderAsync();

                while (reader.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        Slotno = reader.IsDBNull(reader.GetOrdinal("id")) ? 0 : reader.GetInt32(reader.GetOrdinal("id")),

                        calendardate = reader["sdate"] as DateTime? ?? DateTime.MinValue,
                        GrowerGroupName = reader["PartyName"] as string,
                        GrowerName = reader["GrowerName"] as string,
                        SlotQty = reader.IsDBNull(reader.GetOrdinal("Qty")) ? 0 : reader.GetInt32(reader.GetOrdinal("Qty")),
                        GrowerContact = reader["contact"] as string,

                        calendartime = reader["ttime"] as DateTime? ?? DateTime.MinValue,


                    };
                    GetGroweralslot.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetGroweralslot;
        }



        public async Task<CompanyModel?> GetMasterName(int Mid)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "select Mastername,description from AccountMasters where flagdeleted=0 AND  Id = @Mid";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@Mid", Mid);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                MaccGrp = reader["Mastername"] as string,
                                MaccDetails = reader["description"] as string
                                
                            

















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }


        public async Task<CompanyModel?> Getvehid(int vehid)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "select Vehno as Vehno,drivername as Driver,contactno as Contact,status,vehtype from vehinfo where flagdeleted=0 and  vid = @Mid";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@Mid", vehid);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                Vehno = reader["Vehno"] as string,
                                VehDriver = reader["Driver"] as string,
                                VehContact = reader["Contact"] as string,
                                Vehntype = reader["vehtype"] as string



















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }


        
             public async Task<CompanyModel?> GetAllocationpriv(string Ugroup)
        {
            CompanyModel? Privmodel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                const string query = "select Addval,Editval,ViewVal,DelVal from userpriv where  Groupid in (select usergroupid from usergroup where name=@Ugroup) and pname=@pname";

                using (var cmd = new SqlCommand(query, con))
                {
                    cmd.Parameters.AddWithValue("@Ugroup", Ugroup);
                    cmd.Parameters.AddWithValue("@pname", "Allocation");


                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            Privmodel = new CompanyModel
                            {

                                AllocationAdd = reader.GetBoolean(reader.GetOrdinal("Addval")),
                                AllocationEdit = reader.GetBoolean(reader.GetOrdinal("Editval")),
                                AllocationView = reader.GetBoolean(reader.GetOrdinal("ViewVal")),
                                AllocationDel = reader.GetBoolean(reader.GetOrdinal("DelVal")),



















                            };
                        }
                    }
                }
                con.Close();

            }

            return Privmodel;

        }




        public async Task<CompanyModel?> GetCratePrivs2(string Ugroup)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                const string query = "select Addval,Editval,ViewVal,DelVal from userpriv where  Groupid in (select usergroupid from usergroup where name=@Ugroup) and pname=@pname";

                using (var cmd = new SqlCommand(query, con))
                {
                    cmd.Parameters.AddWithValue("@Ugroup", Ugroup);
                    cmd.Parameters.AddWithValue("@pname", "Crates");


                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                CrateAdd = reader.GetBoolean(reader.GetOrdinal("Addval")),
                                CrateEdit = reader.GetBoolean(reader.GetOrdinal("Editval")),
                                CrateView = reader.GetBoolean(reader.GetOrdinal("ViewVal")),
                                CrateDel = reader.GetBoolean(reader.GetOrdinal("DelVal")),



















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }

        




                    public async Task<CompanyModel?> GetDemandPriv(string Ugroup)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                const string query = "select Addval,Editval,ViewVal,DelVal,Approval from userpriv where  Groupid in (select usergroupid from usergroup where name=@Ugroup) and pname=@pname";

                using (var cmd = new SqlCommand(query, con))
                {
                    cmd.Parameters.AddWithValue("@Ugroup", Ugroup);
                    cmd.Parameters.AddWithValue("@pname", "Demand Order");


                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                DemAdd = reader.GetBoolean(reader.GetOrdinal("Addval")),
                                DemEdit = reader.GetBoolean(reader.GetOrdinal("Editval")),
                                DemView = reader.GetBoolean(reader.GetOrdinal("ViewVal")),
                               DemDel = reader.GetBoolean(reader.GetOrdinal("DelVal")),
                                DemApp = reader.GetBoolean(reader.GetOrdinal("Approval")),




















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }



        public async Task<CompanyModel?> GetPackingOrderPriv(string Ugroup)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                const string query = "select Addval,Editval,ViewVal,DelVal,Approval from userpriv where  Groupid in (select usergroupid from usergroup where name=@Ugroup) and pname=@pname";

                using (var cmd = new SqlCommand(query, con))
                {
                    cmd.Parameters.AddWithValue("@Ugroup", Ugroup);
                    cmd.Parameters.AddWithValue("@pname", "Packing Order");


                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                PackingOrderAdd = reader.GetBoolean(reader.GetOrdinal("Addval")),
                                PackingOrderEdit = reader.GetBoolean(reader.GetOrdinal("Editval")),
                                PackingOrderView = reader.GetBoolean(reader.GetOrdinal("ViewVal")),
                                PackingOrderDel = reader.GetBoolean(reader.GetOrdinal("DelVal")),
                                PackingOrderApp = reader.GetBoolean(reader.GetOrdinal("Approval")),




















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }



        public async Task<CompanyModel?> GetPackingDraftPriv(string Ugroup)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                const string query = "select Addval,Editval,ViewVal,DelVal,Approval from userpriv where  Groupid in (select usergroupid from usergroup where name=@Ugroup) and pname=@pname";

                using (var cmd = new SqlCommand(query, con))
                {
                    cmd.Parameters.AddWithValue("@Ugroup", Ugroup);
                    cmd.Parameters.AddWithValue("@pname", "Packing Draft");


                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                PackingDraftAdd = reader.GetBoolean(reader.GetOrdinal("Addval")),
                                PackingDraftEdit = reader.GetBoolean(reader.GetOrdinal("Editval")),
                                PackingDraftView = reader.GetBoolean(reader.GetOrdinal("ViewVal")),
                                PackingDraftDel = reader.GetBoolean(reader.GetOrdinal("DelVal")),
                                PackingDraftApp = reader.GetBoolean(reader.GetOrdinal("Approval")),




















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }
























        public async Task<CompanyModel?> GetStoreOutPriv(string Ugroup)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                const string query = "select Addval,Editval,ViewVal,DelVal,Approval from userpriv where  Groupid in (select usergroupid from usergroup where name=@Ugroup) and pname=@pname";

                using (var cmd = new SqlCommand(query, con))
                {
                    cmd.Parameters.AddWithValue("@Ugroup", Ugroup);
                    cmd.Parameters.AddWithValue("@pname", "STORE OUT");


                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                StoreoutAdd = reader.GetBoolean(reader.GetOrdinal("Addval")),
                                StoreoutEdit = reader.GetBoolean(reader.GetOrdinal("Editval")),
                                StoreoutView = reader.GetBoolean(reader.GetOrdinal("ViewVal")),
                                StoreoutDel = reader.GetBoolean(reader.GetOrdinal("DelVal")),
                                StoreoutApp = reader.GetBoolean(reader.GetOrdinal("Approval")),




















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }





















        public async Task<CompanyModel?> GetPreinwardPriv(string Ugroup)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                const string query = "select Addval,Editval,ViewVal,DelVal from userpriv where  Groupid in (select usergroupid from usergroup where name=@Ugroup) and pname=@pname";

                using (var cmd = new SqlCommand(query, con))
                {
                    cmd.Parameters.AddWithValue("@Ugroup", Ugroup);
                    cmd.Parameters.AddWithValue("@pname", "Preinward");


                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                PreAdd = reader.GetBoolean(reader.GetOrdinal("Addval")),
                                PreEdit = reader.GetBoolean(reader.GetOrdinal("Editval")),
                                PreView = reader.GetBoolean(reader.GetOrdinal("ViewVal")),
                                PreDel = reader.GetBoolean(reader.GetOrdinal("DelVal")),



















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }


        public async Task<CompanyModel?> GetDispatchPriv(string Ugroup)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                const string query = "select Addval,Editval,ViewVal,DelVal from userpriv where  Groupid in (select usergroupid from usergroup where name=@Ugroup) and pname=@pname";

                using (var cmd = new SqlCommand(query, con))
                {
                    cmd.Parameters.AddWithValue("@Ugroup", Ugroup);
                    cmd.Parameters.AddWithValue("@pname", "Dispatch");


                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                DispatchAdd = reader.GetBoolean(reader.GetOrdinal("Addval")),
                                DispatchEdit = reader.GetBoolean(reader.GetOrdinal("Editval")),
                                DispatchView = reader.GetBoolean(reader.GetOrdinal("ViewVal")),
                                DispatchDel = reader.GetBoolean(reader.GetOrdinal("DelVal")),



















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }





        public async Task<CompanyModel?> GetDockPriv(string Ugroup)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                const string query = "select Addval,Editval,ViewVal,DelVal from userpriv where  Groupid in (select usergroupid from usergroup where name=@Ugroup) and pname=@pname";

                using (var cmd = new SqlCommand(query, con))
                {
                    cmd.Parameters.AddWithValue("@Ugroup", Ugroup);
                    cmd.Parameters.AddWithValue("@pname", "Dock");


                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                DockAdd = reader.GetBoolean(reader.GetOrdinal("Addval")),
                                DockEdit = reader.GetBoolean(reader.GetOrdinal("Editval")),
                                DockView = reader.GetBoolean(reader.GetOrdinal("ViewVal")),
                                DockDel = reader.GetBoolean(reader.GetOrdinal("DelVal")),



















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }


        public async Task<CompanyModel?> LocationPriv(string Ugroup)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                const string query = "select Addval,Editval,ViewVal,DelVal from userpriv where  Groupid in (select usergroupid from usergroup where name=@Ugroup) and pname=@pname";

                using (var cmd = new SqlCommand(query, con))
                {
                    cmd.Parameters.AddWithValue("@Ugroup", Ugroup);
                    cmd.Parameters.AddWithValue("@pname", "Location");


                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                LocAdd = reader.GetBoolean(reader.GetOrdinal("Addval")),
                                LocEdit = reader.GetBoolean(reader.GetOrdinal("Editval")),
                                LocView = reader.GetBoolean(reader.GetOrdinal("ViewVal")),
                                LocDel = reader.GetBoolean(reader.GetOrdinal("DelVal")),



















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }

        public async Task<CompanyModel?>FInaloutwardPriv(string Ugroup)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                const string query = "select Addval,Editval,ViewVal,DelVal,Approval from userpriv where  Groupid in (select usergroupid from usergroup where name=@Ugroup) and pname=@pname";

                using (var cmd = new SqlCommand(query, con))
                {
                    cmd.Parameters.AddWithValue("@Ugroup", Ugroup);
                    cmd.Parameters.AddWithValue("@pname", "Final OutWard");


                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                FoAdd = reader.GetBoolean(reader.GetOrdinal("Addval")),
                                FoEdit = reader.GetBoolean(reader.GetOrdinal("Editval")),
                                FoView = reader.GetBoolean(reader.GetOrdinal("ViewVal")),
                                FoDel = reader.GetBoolean(reader.GetOrdinal("DelVal")),
                                FoApp = reader.GetBoolean(reader.GetOrdinal("Approval"))



















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }
        public async Task<CompanyModel?>  GrowerPriv(string Ugroup)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                const string query = "select Addval,Editval,ViewVal,DelVal from userpriv where  Groupid in (select usergroupid from usergroup where name=@Ugroup) and pname=@pname";

                using (var cmd = new SqlCommand(query, con))
                {
                    cmd.Parameters.AddWithValue("@Ugroup", Ugroup);
                    cmd.Parameters.AddWithValue("@pname", "Grower Group");


                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                GroAdd = reader.GetBoolean(reader.GetOrdinal("Addval")),
                                GroEdit = reader.GetBoolean(reader.GetOrdinal("Editval")),
                                GroView = reader.GetBoolean(reader.GetOrdinal("ViewVal")),
                                GroDel = reader.GetBoolean(reader.GetOrdinal("DelVal")),



















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }

        public async Task<CompanyModel?> AgreePreview(string Ugroup)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                const string query = "select Addval,Editval,ViewVal,DelVal from userpriv where  Groupid in (select usergroupid from usergroup where name=@Ugroup) and pname=@pname";

                using (var cmd = new SqlCommand(query, con))
                {
                    cmd.Parameters.AddWithValue("@Ugroup", Ugroup);
                    cmd.Parameters.AddWithValue("@pname", "Agreement");


                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                AgreeAdd = reader.GetBoolean(reader.GetOrdinal("Addval")),
                                AgreeEdit  = reader.GetBoolean(reader.GetOrdinal("Editval")),
                                AgreeView = reader.GetBoolean(reader.GetOrdinal("ViewVal")),
                                AgreeDel = reader.GetBoolean(reader.GetOrdinal("DelVal")),



















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }




        public async Task<CompanyModel?> GetQcPriv(string Ugroup)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                const string query = "select Addval,Editval,ViewVal,DelVal from userpriv where  Groupid in (select usergroupid from usergroup where name=@Ugroup) and pname=@pname";

                using (var cmd = new SqlCommand(query, con))
                {
                    cmd.Parameters.AddWithValue("@Ugroup", Ugroup);
                    cmd.Parameters.AddWithValue("@pname", "Quality");


                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                QcAdd = reader.GetBoolean(reader.GetOrdinal("Addval")),
                                QcEdit = reader.GetBoolean(reader.GetOrdinal("Editval")),
                                QcView = reader.GetBoolean(reader.GetOrdinal("ViewVal")),
                                QckDel = reader.GetBoolean(reader.GetOrdinal("DelVal")),



















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }



        public async Task<CompanyModel?> GetBillPriv(string Ugroup)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                const string query = "select Addval,Editval,ViewVal,DelVal,approval from userpriv where  Groupid in (select usergroupid from usergroup where name=@Ugroup) and pname=@pname";

                using (var cmd = new SqlCommand(query, con))
                {
                    cmd.Parameters.AddWithValue("@Ugroup", Ugroup);
                    cmd.Parameters.AddWithValue("@pname", "Store Billing");


                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                BillAdd = reader.GetBoolean(reader.GetOrdinal("Addval")),
                                BillEdit = reader.GetBoolean(reader.GetOrdinal("Editval")),
                                BillView = reader.GetBoolean(reader.GetOrdinal("ViewVal")),
                                BillDel = reader.GetBoolean(reader.GetOrdinal("DelVal")),
                                BillApp = reader.GetBoolean(reader.GetOrdinal("approval")),



















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }







        public async Task<CompanyModel?> Getppdetails(string Ugroup)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                const string query = @"WITH AggregatedDemands AS(
    SELECT
        d.partyid,
        d.draftirn,
        d.demandirn,
        SUM(d.orderqty) AS total_qty,
        RIGHT(d.demandirn, CHARINDEX('/', REVERSE(d.demandirn)) -1) AS demand_last_digits
    FROM DraftOutTrans d
    WHERE d.draftirn = @ppirn
    GROUP BY d.partyid, d.draftirn, d.demandirn
)
SELECT


    p.partytypeid + '-' + p.partyname AS party_info,
    STRING_AGG(
        a.demand_last_digits + ' (' + CAST(a.total_qty AS VARCHAR) + ')',
        ', '
    ) AS demands_with_qty,
    SUM(a.total_qty) AS grand_total_qty
FROM AggregatedDemands a
INNER JOIN Party p ON a.partyid = p.partyid
GROUP BY a.draftirn, p.partytypeid, p.partyname";

                using (var cmd = new SqlCommand(query, con))
                {
                    cmd.Parameters.AddWithValue("@ppirn", Ugroup);
               

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                GrowerGroupName = reader["party_info"] as string,
                                PPdescrip = reader["demands_with_qty"] as string,
                                Pporderqty = Convert.ToDecimal(reader["grand_total_qty"]),



















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }































        public async Task<CompanyModel?> GetPurchaseGroupName(int Pid)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "select Mastername,description from PurchaseGroup where flagdeleted=0 AND  Id = @Mid";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@Mid", Pid);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                PurchGrp = reader["Mastername"] as string,
                                PurchDetails = reader["description"] as string



















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }

        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        public async Task<CompanyModel?> GetVoucherName(int VoucherId)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "select Mastername,description from VoucherGroup where flagdeleted=0 AND  Id = @Mid";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@Mid", VoucherId);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                VoucherName = reader["Mastername"] as string,
                                VoucherRemarks = reader["description"] as string



















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }



















        public async Task<CompanyModel?> GetAccountType(int Partyid)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "select type,partyid from party where flagdeleted=0 AND  Idno = @growerid";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@growerid", Partyid);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                AccountType = reader["type"] as string,


                                 Growerid = Convert.ToInt32(reader["partyid"])

















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }























        public async Task<CompanyModel?> GetMasterSubName(int SubAccid)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "select a.id,MasterName,MasterSubname,a.CreatedDate,a.Status,a.Description from AccountMasterSub a, AccountMasters b where a.mgroupid=b.id and a.flagdeleted=0  and a.Id = @Mid";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@Mid", SubAccid);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                MaccGrp = reader["Mastername"] as string,
                                SubaccDetails = reader["Description"] as string,
                                SubaccGrp = reader["MasterSubname"] as string
                                



















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }
        public async Task<CompanyModel?> GetItemName(int Itemid)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "select b.mastername,a.itemid,a.itemname,a.itemuom,a.itemgst,a.itemhsn,a.status,a.Createdon from masterItems a,PurchaseGroup b where a.prGroup=b.id and a.flagdeleted=0 and    a.itemid = @Mid";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@Mid", Itemid);

                    using (var rdr = await cmd.ExecuteReaderAsync())
                    {
                        if (await rdr.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                PurchGrp = rdr["mastername"].ToString(),
                                Itemid = Convert.ToInt32(rdr["itemid"]),
                                PurchaseItemName = rdr["itemname"].ToString(),
                                ItemUom = rdr["itemuom"].ToString(),
                                ItemGst = rdr["itemgst"].ToString(),
                                ItemHsn = rdr["itemhsn"].ToString(),
//                                ItemStatus = rdr.GetBoolean(rdr.GetOrdinal("status")),
//                                ItemCreatedDate = rdr["createdon"] as DateTime? ?? DateTime.MinValue

//,


















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }

        public async Task<CompanyModel?> GetOrderhead(int selectedGrowerId)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "select Order_Dated,rtrim(type)+'-'+partytypeid  +'-'+ rtrim(partyname) as partyname ,billto,daddress,a.remarks from purchaseorder a,party b where a.partyid=b.idno and  a.OrderId = @Mid";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@Mid", selectedGrowerId);

                    using (var rdr = await cmd.ExecuteReaderAsync())
                    {
                        if (await rdr.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                PurchaseOrderDated = rdr["Order_Dated"] as DateTime? ?? DateTime.MinValue,
                                AccountName = rdr["partyname"].ToString(),
                                PurchaseOrderBillto = rdr["billto"].ToString(),
                                PurchaseOrderDel = rdr["daddress"].ToString(),
                                PurchaseOrderRemarks= rdr["remarks"].ToString(),
                                //                                ItemStatus = rdr.GetBoolean(rdr.GetOrdinal("status")),
                                //                                ItemCreatedDate = rdr["createdon"] as DateTime? ?? DateTime.MinValue

                                //,


















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }



        public async Task<CompanyModel?> GetPurchaseOrderNo()
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "select max(OrderId) as Orno from purchaseOrder";

                using (var cmd = new SqlCommand(sql, con))
                {
                  
                    using (var rdr = await cmd.ExecuteReaderAsync())
                    {
                        if (await rdr.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                PurchaseOrderId = Convert.ToInt32(rdr["Orno"]),
                               
                                //                                ItemStatus = rdr.GetBoolean(rdr.GetOrdinal("status")),
                                //                                ItemCreatedDate = rdr["createdon"] as DateTime? ?? DateTime.MinValue

                                //,


















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }


        public async Task<CompanyModel?> GetPreinwardNo()
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "select GateInId,PreInIrn from  GateInMaster where GateInId in (select max(GateInId) as Orno from GateInMaster)";

                using (var cmd = new SqlCommand(sql, con))
                {

                    using (var rdr = await cmd.ExecuteReaderAsync())
                    {
                        if (await rdr.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                TempGateInId = Convert.ToInt32(rdr["GateInId"]),

                                TempGateInIrn = rdr["PreInIrn"].ToString(),
                                //                                ItemStatus = rdr.GetBoolean(rdr.GetOrdinal("status")),
                                //                                ItemCreatedDate = rdr["createdon"] as DateTime? ?? DateTime.MinValue

                                //,


















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }





        public async Task<CompanyModel?> GetPreDemandNo()
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "select idno from  predemand where idno in (select max(idno) as Orno from predemand)";

                using (var cmd = new SqlCommand(sql, con))
                {

                    using (var rdr = await cmd.ExecuteReaderAsync())
                    {
                        if (await rdr.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                TempOrderId = Convert.ToInt32(rdr["idno"]),

                              


















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }


        public async Task<CompanyModel?> GetPreOutwardNo()
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "select idno from  preoutward where idno in (select max(idno) as Orno from preoutward)";

                using (var cmd = new SqlCommand(sql, con))
                {

                    using (var rdr = await cmd.ExecuteReaderAsync())
                    {
                        if (await rdr.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                TempOutwardId = Convert.ToInt32(rdr["idno"]),




















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }




























        public async Task<CompanyModel?> GetPackingNo()
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "select isnull(max(packingorderid+1),1) as Packno from packingorderitems";

                using (var cmd = new SqlCommand(sql, con))
                {

                    using (var rdr = await cmd.ExecuteReaderAsync())
                    {
                        if (await rdr.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                Packingorderid = Convert.ToInt32(rdr["Packno"]),




















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }
        public async Task<CompanyModel?> GetOutwardNo()
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "Select isnull(max(outwardid + 1), 1) as packno from Outward";

                using (var cmd = new SqlCommand(sql, con))
                {

                    using (var rdr = await cmd.ExecuteReaderAsync())
                    {
                        if (await rdr.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                Outwardno = Convert.ToInt32(rdr["Packno"]),




















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }






        public async Task<CompanyModel?> GetPreDraftNo()
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "select idno from  predraft where idno in (select max(idno) as Orno from predraft)";

                using (var cmd = new SqlCommand(sql, con))
                {

                    using (var rdr = await cmd.ExecuteReaderAsync())
                    {
                        if (await rdr.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                TempDraftId = Convert.ToInt32(rdr["idno"]),




















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }








































        public async Task<CompanyModel?> GetTridDet(int selectedGrowerId,int selectedId)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = @"
SELECT
    ci.trid ,prt.name as item,pt.name as package,ci.khataName,ci.cratetype,pq.name as variety,
   st.sname, ci.qty,  ci.GateInId ,ci.PreInIrn
    
FROM gateinmaster ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.growerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
LEFT JOIN users ui ON ci.createdby = ui.id
LEFT JOIN prodqaul pq ON ci.varietyid = pq.id
LEFT JOIN servicetypes st ON ci.schemeid = st.id
LEFT JOIN unit_master um ON ci.Unitid = um.id
LEFT JOIN PTYPE pt ON ci.packageid = pt.id
LEFT JOIN users ur ON ci.Createdby = ur.id
LEFT JOIN prodtype prt ON ci.itemid = prt.id
WHERE 
 GateInId=@gateid and Trid=@Trid and qty>0


ORDER BY trid";
                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@Trid", selectedGrowerId);
                    cmd.Parameters.AddWithValue("@gateid", selectedId);


                    using (var rdr = await cmd.ExecuteReaderAsync())
                    {
                        if (await rdr.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                Itemname = rdr["item"].ToString(),
                                PreInwardUom = rdr["package"].ToString(),
                                PreInwardKhata = rdr["khataName"].ToString(),
                                VarietyId = rdr["variety"].ToString(),
                                PreInwardQty = Convert.ToDecimal(rdr["qty"]),
                                PreCrateType = rdr["cratetype"].ToString(),
                                ServiceId = rdr["sname"].ToString(),
                                TempGateInId = Convert.ToInt32(rdr["GateInId"]),
                                TempGateInIrn = rdr["PreInIrn"].ToString(),




















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }

        public async Task<CompanyModel?> DraftIdentity(int selectedGrowerId)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = @"sELECT g.PackingDraftitemid,pr.itemname,
  g.palletno, g.palletIrn,rp.recipename,ig.Gradename,g.Qty,g.marka,pq.name,lf.name as Location
FROM REPACKDRAFTITEMS g


LEFT JOIN users ur on g.Createdby = ur.userid
LEFT JOIN Recipe rp on g.RecipeId = rp.RecipeId
LEFT JOIN itemgrades ig ON g.gradeid = ig.id
LEFT JOIN prodqaul pq ON g.brandid = pq.id
LEFT JOIN location_master lf ON g.locationid = lf.id
LEFT JOIN Purchaseitem pr ON g.Packageid = Pr.id

where g.PackingDraftitemid =@Trid





ORDER BY g.palletno";
                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@Trid", selectedGrowerId);
                   
                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                DraftIdentity = Convert.ToInt32(reader["PackingDraftItemID"]),
                                PalletId = Convert.ToInt32(reader["palletno"]),
                                PalletName = reader["palletIrn"] as string,
                                ReceipeName = reader["recipename"] as string,
                                ReceipeGrade = reader["Gradename"] as string,
                                ReceipeQty = Convert.ToInt32(reader["Qty"]),
                                ReceipeMarka = reader["marka"] as string,
                                VarietyId = reader["name"] as string,
                                ReceipeLocation = reader["Location"] as string,
                                BoxBrand = reader["itemname"] as string,


















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }



















        public async Task<CompanyModel?> GetLotDet(int selectedGrowerId)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = @"
SELECT
    ci.lotno ,prt.name as item,pt.name as package,ci.khataName,ci.cratetype,pq.name as variety,
   st.sname, ci.qty,  ci.GateInId ,ci.PreInIrn
    
FROM GateInTrans ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.growerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
LEFT JOIN users ui ON ci.createdby = ui.id
LEFT JOIN prodqaul pq ON ci.varietyid = pq.id
LEFT JOIN servicetypes st ON ci.schemeid = st.id
LEFT JOIN unit_master um ON ci.Unitid = um.id
LEFT JOIN PTYPE pt ON ci.packageid = pt.id
LEFT JOIN users ur ON ci.Createdby = ur.id
LEFT JOIN prodtype prt ON ci.itemid = prt.id
WHERE 
 Lotno=@Trid and qty>0


ORDER BY Lotno";
                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@Trid", selectedGrowerId);
                   

                    using (var rdr = await cmd.ExecuteReaderAsync())
                    {
                        if (await rdr.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                Itemname = rdr["item"].ToString(),
                                PreInwardUom = rdr["package"].ToString(),
                                PreInwardKhata = rdr["khataName"].ToString(),
                                VarietyId = rdr["variety"].ToString(),
                                PreInwardQty = Convert.ToDecimal(rdr["qty"]),
                                PreCrateType = rdr["cratetype"].ToString(),
                                ServiceId = rdr["sname"].ToString(),
                                //PreInwardId = Convert.ToInt32(rdr["GateInId"]),
                                //PreInIrn = rdr["PreInIrn"].ToString(),
                                Lotno = Convert.ToInt32(rdr["lotno"]),
                                Prodname = rdr["item"].ToString(),



















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }

        public async Task<CompanyModel?> GetLotFullDet(int selectedGrowerId)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = @"
SELECT
      p.partytypeid + '-' + p.partyname AS PartyName,
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,cm.challanName,ci.challanNo,ci.lotno ,prt.name as item,pt.name as package,ci.khataName,ci.cratetype,pq.name as variety,
   st.sname, ci.qty,  ci.GateInId ,ci.PreInIrn,ci.LotIrn,ci.partyid,ci.LocationChamberId,ci.Remarks
    
FROM GateInTrans ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.growerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
LEFT JOIN users ui ON ci.createdby = ui.id
LEFT JOIN prodqaul pq ON ci.varietyid = pq.id
LEFT JOIN servicetypes st ON ci.schemeid = st.id
LEFT JOIN unit_master um ON ci.Unitid = um.id
LEFT JOIN PTYPE pt ON ci.packageid = pt.id
LEFT JOIN users ur ON ci.Createdby = ur.id
LEFT JOIN prodtype prt ON ci.itemid = prt.id
WHERE 
 Lotno=@Trid and qty>0


ORDER BY Lotno";
                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@Trid", selectedGrowerId);


                    using (var rdr = await cmd.ExecuteReaderAsync())
                    {
                        if (await rdr.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                              
                                GrowerGroupName = rdr["PartyName"].ToString(),

                                GrowerName = rdr["GrowerName"].ToString(),
                                Itemname = rdr["item"].ToString(),
                                PreInwardUom = rdr["package"].ToString(),
                                PreInwardKhata = rdr["khataName"].ToString(),
                                VarietyId = rdr["variety"].ToString(),
                                PreInwardQty = Convert.ToDecimal(rdr["qty"]),
                                PreCrateType = rdr["cratetype"].ToString(),
                                ServiceId = rdr["sname"].ToString(),
                                //PreInwardId = Convert.ToInt32(rdr["GateInId"]),
                                //PreInIrn = rdr["PreInIrn"].ToString(),
                                Lotno = Convert.ToInt32(rdr["lotno"]),
                                Prodname = rdr["item"].ToString(),
                                LotIrn = rdr["LotIrn"].ToString(),
                                Partyid = Convert.ToInt32(rdr["partyid"]),
                                ChamberId = Convert.ToInt32(rdr["LocationChamberId"]),
                                PreInwardRemarks= rdr["Remarks"].ToString(),
                                PreinwardStatus = "Yes",
                                ChallanName = rdr["ChallanName"]?.ToString() ?? "",
                                ChallanNo = rdr["ChallanNo"]?.ToString() ?? "",

















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }

        public async Task<CompanyModel?> GetLotFullLocation(int selectedGrowerId)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = @"
SELECT
      p.partytypeid + '-' + p.partyname AS PartyName,
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,cm.challanName,ci.challanNo,ci.lotno ,prt.name as item,pt.name as package,ci.khataName,ci.cratetype,pq.name as variety,
   st.sname, ci.verifiedQty as qty,  ci.GateInId ,ci.PreInIrn,ci.LotIrn,ci.partyid,ci.LocationChamberId,ci.Remarks,ci.Bins,ci.VerifiedCompanyCrates,ci.VerifiedOwnCrates,ci.VerifiedwoodenPetty,ci.CrateMarka,rtrim(ch.ctype) as ChamberType,lm.name as MasterLocation
    
FROM GateInTrans ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.growerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
LEFT JOIN users ui ON ci.createdby = ui.id
LEFT JOIN prodqaul pq ON ci.varietyid = pq.id
LEFT JOIN servicetypes st ON ci.schemeid = st.id
LEFT JOIN unit_master um ON ci.Unitid = um.id
LEFT JOIN PTYPE pt ON ci.packageid = pt.id
LEFT JOIN users ur ON ci.Createdby = ur.id
LEFT JOIN location_master lm ON ci.locationMasterid = lm.id
LEFT JOIN prodtype prt ON ci.itemid = prt.id

LEFT JOIN chamber ch ON ci.LocationChamberId = ch.chamberid

WHERE 
 Lotno=@Trid and ci.qty>0


ORDER BY Lotno";
                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@Trid", selectedGrowerId);


                    using (var rdr = await cmd.ExecuteReaderAsync())
                    {
                        if (await rdr.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                GrowerGroupName = rdr["PartyName"].ToString(),

                                GrowerName = rdr["GrowerName"].ToString(),
                                Itemname = rdr["item"].ToString(),
                                PreInwardUom = rdr["package"].ToString(),
                                PreInwardKhata = rdr["khataName"].ToString(),
                                VarietyId = rdr["variety"].ToString(),
                                VerfiedQty = Convert.ToDecimal(rdr["qty"]),
                                VerfiedCompanyCrates = Convert.ToDecimal(rdr["VerifiedCompanyCrates"]),
                                VerfiedOwnCrates = Convert.ToDecimal(rdr["VerifiedOwnCrates"]),
                                Verfiedpetties = Convert.ToDecimal(rdr["VerifiedwoodenPetty"]),
                                CrateMarka = rdr["CrateMarka"].ToString(),
                                ChamberType = rdr["ChamberType"].ToString(),
                                Verfiedbins = Convert.ToDecimal(rdr["Bins"]),

                                Templocation = rdr["MasterLocation"].ToString(),

                                PreCrateType = rdr["cratetype"].ToString(),
                                ServiceId = rdr["sname"].ToString(),
                                //PreInwardId = Convert.ToInt32(rdr["GateInId"]),
                                //PreInIrn = rdr["PreInIrn"].ToString(),
                                Lotno = Convert.ToInt32(rdr["lotno"]),
                                Prodname = rdr["item"].ToString(),
                                LotIrn = rdr["LotIrn"].ToString(),
                                Partyid = Convert.ToInt32(rdr["partyid"]),
                                ChamberId = Convert.ToInt32(rdr["LocationChamberId"]),
                                PreInwardRemarks = rdr["Remarks"].ToString(),
                                PreinwardStatus = "Yes",
                                ChallanName = rdr["ChallanName"]?.ToString() ?? "",
                                ChallanNo = rdr["ChallanNo"]?.ToString() ?? "",

















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }




        public async Task<CompanyModel?> GetLotFullQuality(int selectedGrowerId,int UnitId)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = @"


SELECT
      p.partytypeid + '-' + p.partyname AS PartyName,
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,ci.lotno ,prt.name as item,pt.name as package,ci.khataName,ci.cratetype,pq.name as variety,
   isnull(st.sname,'na') as sname, ci.qty,  ci.GateInId ,ci.PreInIrn,ci.LotIrn,ci.partyid,ci.LocationChamberId,ql.Pressure,ql.AvgWeight,ql.avgPressure1,ql.avgPressure2,ql.avgPressure3,
   ql.avgWeight1,ql.avgWeight2 ,ql.avgWeight3,ql.bGradeAvg1,ql.bGradeAvg2,ql.bGradeAvgCrateValue,ql.bGradeAvgCrate,ql.AvgsizeName,ql.ChamberIdtoShift,ql.remarks,ql.lesscolorperValue,qd.WaterCore,qd.scabe,
   qd.bitterpit,qd.bitterrot,qd.blouch,qd.flyspeck,qd.insecthole,qd.Rusting,qd.olla,qd.sanjose,qd.Touch,qd.Touch,qd.Sunburn,qd.scar 
    
FROM GateInTrans ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.growerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
LEFT JOIN users ui ON ci.createdby = ui.id
LEFT JOIN prodqaul pq ON ci.varietyid = pq.id
LEFT JOIN servicetypes st ON ci.schemeid = st.id
LEFT JOIN unit_master um ON ci.Unitid = um.id
LEFT JOIN PTYPE pt ON ci.packageid = pt.id
LEFT JOIN users ur ON ci.Createdby = ur.id
LEFT JOIN prodtype prt ON ci.itemid = prt.id
LEFT JOIN Qualitycontrol Ql ON ci.lotno = ql.lotno
LEFT JOIN Qualitydiseases Qd ON ci.lotno = Qd.lotno

WHERE 
 ci.Lotno=@Trid and qty>0 and ci.UnitId=@Unitid


ORDER BY Lotno";
                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@Trid", selectedGrowerId);
                    cmd.Parameters.AddWithValue("@Unitid", UnitId);


                    using (var rdr = await cmd.ExecuteReaderAsync())
                    {
                        if (await rdr.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                GrowerGroupName = rdr["PartyName"].ToString(),

                                GrowerName = rdr["GrowerName"].ToString(),
                                Itemname = rdr["item"].ToString(),
                                PreInwardUom = rdr["package"].ToString(),
                                PreInwardKhata = rdr["khataName"].ToString(),
                                VarietyId = rdr["variety"].ToString(),
                                PreInwardQty = Convert.ToDecimal(rdr["qty"]),
                                PreCrateType = rdr["cratetype"].ToString(),
                                ServiceId = rdr["sname"].ToString(),
                                Lotno = Convert.ToInt32(rdr["lotno"]),
                                Prodname = rdr["item"].ToString(),
                                LotIrn = rdr["LotIrn"].ToString(),
                                Partyid = Convert.ToInt32(rdr["partyid"]),
                                ChamberId = Convert.ToInt32(rdr["LocationChamberId"]),
                                AvgPressure= Convert.ToInt32(rdr["Pressure"]),
                                HasWaterCore  = rdr.GetBoolean(rdr.GetOrdinal("WaterCore")),
                                HasScab = rdr.GetBoolean(rdr.GetOrdinal("scabe")),
                                HasBitterPit = rdr.GetBoolean(rdr.GetOrdinal("bitterpit")),
                                HasBitterRot = rdr.GetBoolean(rdr.GetOrdinal("bitterrot")),
                                HasBlouch = rdr.GetBoolean(rdr.GetOrdinal("blouch")),
                                HasFlySpeck = rdr.GetBoolean(rdr.GetOrdinal("flyspeck")),
                                HasInsectHole = rdr.GetBoolean(rdr.GetOrdinal("insecthole")),
                                HasRusting = rdr.GetBoolean(rdr.GetOrdinal("Rusting")),
                                HasOlla = rdr.GetBoolean(rdr.GetOrdinal("olla")),
                                HasSanjose = rdr.GetBoolean(rdr.GetOrdinal("sanjose")),
                                HasTouch = rdr.GetBoolean(rdr.GetOrdinal("Touch")),
                                HasSunburn = rdr.GetBoolean(rdr.GetOrdinal("sunburn")),
                                HasScar = rdr.GetBoolean(rdr.GetOrdinal("scar")),
                                Pressure1 = Convert.ToInt32(rdr["avgPressure1"]),
                                Pressure2 = Convert.ToInt32(rdr["avgPressure2"]),
                                Pressure3= Convert.ToInt32(rdr["avgPressure3"]),

                                AvgWeight1 = Convert.ToInt32(rdr["avgWeight1"]),
                                AvgWeight2 = Convert.ToInt32(rdr["avgWeight2"]),
                                AvgWeight3 = Convert.ToInt32(rdr["avgWeight3"]),
                                LessColorPercentage = rdr["lesscolorperValue"].ToString(),
                                QualityRemarks = rdr["Remarks"].ToString(),
                                AvgSize= rdr["AvgsizeName"].ToString(),
                                BGradeAvgType = rdr["bGradeAvgCrate"].ToString(),
                                NewchamberId= Convert.ToInt32(rdr["ChamberIdtoShift"]),
                                BGradeAvg1 = Convert.ToInt32(rdr["bGradeAvg1"]),
                                BGradeAvg2 = Convert.ToInt32(rdr["bGradeAvg2"]),

























                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }

        public async Task<CompanyModel?> CheckInsertedQty(int Tempid)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "select isnull(sum(qty),0) as insqt from  GateInMaster where GateInId=@selectedprn";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@selectedprn", Tempid);
                    using (var rdr = await cmd.ExecuteReaderAsync())
                    {
                        if (await rdr.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {


                                
                                TempInsertedQty = Convert.ToDecimal(rdr["insqt"]),


















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }


        public async Task<CompanyModel?> Getassignuser(int selectedcrn)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = @"SELECT ISNULL((
    SELECT TOP 1 u.username
    FROM packingorderitems poi
    LEFT JOIN users u ON poi.userid = u.userid
    WHERE poi.packingorderid = @selectedcrn
), '.') as username
            ";
                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@selectedcrn", selectedcrn);
                    using (var rdr = await cmd.ExecuteReaderAsync())
                    {
                        if (await rdr.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                UserName = rdr["username"] as string,




















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }













        public async Task<CompanyModel?> GetCrateIdno(string selectedcrn)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "select cid  from crateissue where Trno=@selectedcrn";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@selectedcrn", selectedcrn);
                    using (var rdr = await cmd.ExecuteReaderAsync())
                    {
                        if (await rdr.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                CrissueretId = Convert.ToInt32(rdr["cid"]),

                              


















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }


        public async Task<CompanyModel?> GetCrateOrderNo()
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "select max(cid) as cid from crateissue";

                using (var cmd = new SqlCommand(sql, con))
                {

                    using (var rdr = await cmd.ExecuteReaderAsync())
                    {
                        if (await rdr.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                CrissueId = Convert.ToInt32(rdr["cid"]),

                                //                                ItemStatus = rdr.GetBoolean(rdr.GetOrdinal("status")),
                                //                                ItemCreatedDate = rdr["createdon"] as DateTime? ?? DateTime.MinValue

                                //,


















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }








        public async Task<CompanyModel?> GetSubGroupName(int Subgroupid)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "select a.id as Id,MasterSubname,subname,a.CreatedDate,a.Status,a.Description from AccountSubGroups a, AccountMasterSub b where a.mgroupid=b.id and a.flagdeleted=0   and a.Id = @Mid";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@Mid", Subgroupid);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                SubaccGrp = reader["MasterSubname"] as string,
                                SubaccDetails = reader["Description"] as string,
                                SubgroupName = reader["subname"] as string




















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }


















        public async Task<CompanyModel?> GetChallanId(int ChallanId)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "SELECT id, ChallanName, Address, Phone1, Phone2 ,Address,city,Village FROM challanmaster WHERE flagdeleted = 0 AND id=@ChallanId";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@ChallanId", ChallanId);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                              
                                ChallanName = reader["ChallanName"] as string,
                                ChallanAddress = reader["Address"] as string,
                                ChallanCity = reader["city"] as string,
                                ChallanVillage = reader["Village"] as string,
                                ChallanPhone1 = reader["Phone1"] as string,
                                ChallanPhone2 = reader["Phone2"] as string,
                             
















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }





        public async Task<CompanyModel?> ShowModal(int chamber)

        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "SELECT c.status,a.chamber,a.wid,partytypeid  +'-'+ partyname as PartyName ,SUM(a.qty) as TotalQuantity FROM challocation a LEFT JOIN party p ON a.wid = p.partyid LEFT JOIN chamber c ON a.chamber = c.chamberid WHERE a.chamber = 1 GROUP BY c.status,A.chamber,a.wid, p. partytypeid  +'-'+ partyname ORDER BY a.wid";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@chamber", chamber);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                Partyid = Convert.ToInt32(reader["wid"]),

                                GrowerGroupName = reader["PartyName"] as string,
                               ChamberAllocation = Convert.ToDecimal(reader["TotalQuantity"]),
                              
                               ChamberName= reader["chamber"] as string,
                                IsLocked = reader.GetBoolean(reader.GetOrdinal("status")),












                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }


























        public async Task<CompanyModel?> GetPreinwardId(int selectedGrowerId)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = @"SELECT ci.GateInId,ci.remarks,
    ci.Lotno,
    ci.PreInIrn,ci.LotIrn,
    ci.GateInDate,
    p.partytypeid + '-' + p.partyname AS PartyName,
    CONVERT(varchar(max), ps.partyid) +'-' + ps.partyname AS GrowerName,
    CONVERT(varchar(max), cm.id) +'-' + cm.ChallanName AS ChallanName,
    RTRIM(vi.vehno) +SPACE(1) + '(' + RTRIM(vi.drivername) + SPACE(1) + ')' + SPACE(1) + '(' + RTRIM(vi.contactno) + ')' AS vehno,
    ci.qty,ci.sno,ci.createddate,ci.KhataName,ci.ChallanNo ,ur.uname,
    ci.Remarks,
    ci.preInirn,ui.uname as username,pq.name as variety,ci.cratetype,st.sname,um.Ucode,pt.name,
    
    --New Status Field
    CASE
        WHEN EXISTS(
            SELECT 1
            FROM QualityControl qi
            WHERE qi.LotNo = ci.LotNo
        ) THEN 'Completed'
        ELSE 'Pending'
    END AS Status

FROM GateInTrans ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.growerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
LEFT JOIN users ui ON ci.createdby = ui.id
LEFT JOIN prodqaul pq ON ci.varietyid = pq.id
LEFT JOIN servicetypes st ON ci.schemeid = st.id
LEFT JOIN unit_master um ON ci.Unitid = um.id
LEFT JOIN PTYPE pt ON ci.packageid = pt.id
LEFT JOIN users ur ON ci.Createdby = ur.id


where ci.GateInId = @selectedGrowerId

ORDER BY ci.GateInId DESC
";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@selectedGrowerId", selectedGrowerId);

                    using (var rdr = await cmd.ExecuteReaderAsync())
                    {
                        if (await rdr.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {

                                PreInwardId = Convert.ToInt32(rdr["GateInId"]),
                                PreinwardDate = Convert.ToDateTime(rdr["GateInDate"]),

                                GrowerGroupName = rdr["PartyName"].ToString(),
                                GrowerName = rdr["GrowerName"].ToString(),
                                ChallanName = rdr["ChallanName"].ToString(),
                                Vehno = rdr["vehno"].ToString(),
                                PreInIrn = rdr["PreInIrn"].ToString(),
                                LotIrn = rdr["LotIrn"].ToString(),
                                ChallanNo = rdr["ChallanNo"].ToString(),


                                PreInwardQty = Convert.ToDecimal(rdr["qty"]),

                                GlobalUserName = rdr["username"].ToString(),
                                PreInwardStatus = rdr["Status"].ToString(),
                                PreInwardRemarks = rdr["Remarks"].ToString(),

















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }



        public async Task<List<CompanyModel>> GetPreinwardIdlist(int selectedGrowerId)
        {
            List<CompanyModel> GetDailyPreinwardView = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT ci.GateInId,ci.remarks,
    ci.Lotno,
    ci.PreInIrn,ci.LotIrn,ci.LocationChamberId,
    ci.GateInDate,
    p.partytypeid + '-' + p.partyname AS PartyName,
    CONVERT(varchar(max), ps.partyid) +'-' + ps.partyname AS GrowerName,
    CONVERT(varchar(max), cm.id) +'-' + cm.ChallanName AS ChallanName,
    RTRIM(vi.vehno) +SPACE(1) + '(' + RTRIM(vi.drivername) + SPACE(1) + ')' + SPACE(1) + '(' + RTRIM(vi.contactno) + ')' AS vehno,
    ci.qty,ci.sno,ci.createddate,ci.KhataName,ci.ChallanNo ,ur.uname,
    ci.Remarks,prn.name as product,
    ci.preInirn,ui.uname as username,pq.name as variety,ci.cratetype,st.sname,um.Ucode,pt.name,
    
    --New Status Field
    CASE
        WHEN EXISTS(
            SELECT 1
            FROM QualityControl qi
            WHERE qi.LotNo = ci.LotNo
        ) THEN 'Completed'
        ELSE 'Pending'
    END AS Status

FROM GateInTrans ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.growerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
LEFT JOIN users ui ON ci.createdby = ui.id
LEFT JOIN prodqaul pq ON ci.varietyid = pq.id
LEFT JOIN servicetypes st ON ci.schemeid = st.id
LEFT JOIN unit_master um ON ci.Unitid = um.id
LEFT JOIN PTYPE pt ON ci.packageid = pt.id
LEFT JOIN users ur ON ci.Createdby = ur.id

LEFT JOIN prodtype prn ON ci.itemid = prn.id


where ci.GateInId = @selectedGrowerId

ORDER BY ci.GateInId DESC";

                SqlCommand cmd = new SqlCommand(query, con)


                {

                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@selectedGrowerId", selectedGrowerId);

                con.Open();

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        LotIrn = rdr["LotIrn"].ToString(),

                        ItemName = rdr["Product"].ToString(),
                        PreInwardUom = rdr["name"].ToString(),


                        PreInwardQty = Convert.ToDecimal(rdr["qty"]),

                        PreInwardKhata = rdr["KhataName"].ToString(),
                        ServiceId = rdr["sname"].ToString(),
                        VarietyId = rdr["variety"].ToString(),

                        PreCrateType = rdr["cratetype"].ToString(),

                        ChamberId = Convert.ToInt32(rdr["LocationChamberId"]),
                        Lotno = Convert.ToInt32(rdr["Lotno"]),




                    };
                    GetDailyPreinwardView.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinwardView;
        }








        //public async Task<List<CompanyModel>> CallAllChambers()
        //{
        //    List<CompanyModel> allChambers = new List<CompanyModel>();

        //    using (SqlConnection con = new SqlConnection(_configuration.Value))
        //    {
        //        const string query = @"
        //    SELECT
        //        chamberid,
        //        chambername,
        //        MaxQuantity,
        //        QuantityConsumed,
        //        QuantityBalanced,
        //        IsLocked
        //    FROM chamber
        //    WHERE FlagDeleted = 0";


        //        SqlCommand cmd = new SqlCommand(query, con)


        //        {

        //            CommandType = CommandType.Text
        //        };
        //         con.Open();

        //        SqlDataReader reader = await cmd.ExecuteReaderAsync();

        //        while (reader.Read())
        //        {
        //            CompanyModel companyModel = new CompanyModel
        //            {
        //                ChamberName = reader.GetString(reader.GetOrdinal("chambername")),
        //                chamberstatus = reader.GetBoolean(reader.GetOrdinal("IsLocked")),

        //                // Nullable properties with proper handling
        //                Capacity = reader.IsDBNull(reader.GetOrdinal("MaxQuantity")) ?
        //                                null : (int?)reader.GetInt32(reader.GetOrdinal("MaxQuantity")),

        //                AllocatedQty = reader.IsDBNull(reader.GetOrdinal("QuantityConsumed")) ?
        //                                    null : (int?)reader.GetInt32(reader.GetOrdinal("QuantityConsumed")),

        //                RemainingQty = reader.IsDBNull(reader.GetOrdinal("QuantityBalanced")) ?
        //                                     null : (int?)reader.GetInt32(reader.GetOrdinal("QuantityBalanced"))



        //            };
        //            allChambers.Add(companyModel);
        //        }
        //        con.Close();
        //        cmd.Dispose();
        //    }
        //    return allChambers;
        //}













        //public async Task<CompanyModel?> GetAgreementId(int AgreementId ,CompanyModel companyModel)
        //{
        //    if (companyModel == null)
        //        return null;

        //    using (SqlConnection con = new SqlConnection(_configuration.Value))
        //    {
        //        await con.OpenAsync();

        //        using (SqlCommand cmd = new SqlCommand("AddGrowerAgreement", con))
        //        {
        //            cmd.CommandType = CommandType.StoredProcedure;

        //            // Make sure there are no extra spaces in parameter names!
        //            cmd.Parameters.AddWithValue("@GrowerGrp", companyModel.GrowerGroupSelectName);
        //            cmd.Parameters.AddWithValue("@Fyear", companyModel.Fyear);
        //            cmd.Parameters.AddWithValue("@Adate", companyModel.Adated);
        //            cmd.Parameters.AddWithValue("@InwardDate", companyModel.Idated);
        //            cmd.Parameters.AddWithValue("@aqty", companyModel.Aqty);
        //            cmd.Parameters.AddWithValue("@createdby", "1");
        //            cmd.Parameters.AddWithValue("@item", companyModel.Itemname);
        //            cmd.Parameters.AddWithValue("@bins", "1");
        //            cmd.Parameters.AddWithValue("@Storerent", companyModel.StoreRent);
        //            cmd.Parameters.AddWithValue("@BinRate ", companyModel.BinRent);
        //            cmd.Parameters.AddWithValue("@CrateRental", companyModel.CrateRate);
        //            cmd.Parameters.AddWithValue("@LabourRate", companyModel.LabourRate);

        //            cmd.Parameters.AddWithValue("@GradingRate ", companyModel.GradingRent);
        //            cmd.Parameters.AddWithValue("@PackingRate", companyModel.PackingRent);
        //            cmd.Parameters.AddWithValue("@Service", companyModel.Atype); // Assuming village is same as country? Check this logic.
        //            cmd.Parameters.AddWithValue("@RateType", companyModel.RentType);
        //            cmd.Parameters.AddWithValue("@chamber", companyModel.Achambers);
        //            cmd.Parameters.AddWithValue("@InvFlag", companyModel.InvestFlag);
        //            cmd.Parameters.AddWithValue("@saleFlag", companyModel.SalesType);

        //            cmd.Parameters.AddWithValue("@invQty", companyModel.InvestQty);
        //            cmd.Parameters.AddWithValue("@invrate", companyModel.InvestRate);
        //            cmd.Parameters.AddWithValue("@Commpercent", companyModel.Invpercent);



        //            await cmd.ExecuteNonQueryAsync();
        //        }

        //        // After stored procedure, retrieve message from dbo.svalidate
        //        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
        //        {
        //            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
        //            {
        //                if (rdr.Read())
        //                {
        //                    companyModel.RetMessage = rdr["remarks"]?.ToString();
        //                    companyModel.RetFlag = rdr["flag"]?.ToString();
        //                }
        //            }
        //        }

        //        return companyModel;
        //    }
        //}



        public async Task<List<Installment>> GetInstallmentsByGrowerAsync(int Agreementid)
        {
            var installments = new List<Installment>();

            using (var connection = new SqlConnection(_configuration.Value))
            {
                await connection.OpenAsync();

                const string query = @"SELECT Id, DueDate, Amount FROM installmentnew WHERE Agreementid = @Agreementid  ORDER BY DueDate";

                using (var cmd = new SqlCommand(query, connection))
                {
                    cmd.Parameters.AddWithValue("@Agreementid", Agreementid);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        while (await reader.ReadAsync())
                        {
                            installments.Add(new Installment
                            {
                                Id = reader.GetInt32(0),
                                DueDate = reader.GetDateTime(1),
                                Amount = reader.GetDecimal(2)
                            });
                        }
                    }
                }
            }

            return installments;
        }











        public async Task BulkInsertInstallmentsAsync(List<Installment> installments, CompanyModel EditModel)
        {
            using (SqlConnection connection = new SqlConnection(_configuration.Value))
            {
                await connection.OpenAsync();
             
                // Create and configure the DataTable
                DataTable installmentTable = new DataTable();
                installmentTable.Columns.Add("Id", typeof(int));
                installmentTable.Columns.Add("DueDate", typeof(DateTime));  // DueDate column added
                installmentTable.Columns.Add("Amount", typeof(decimal));
                installmentTable.Columns.Add("Atype", typeof(string));
                installmentTable.Columns.Add("GrowerGrp", typeof(string));
                installmentTable.Columns.Add("GrowerId", typeof(int));
                // Populate the DataTable with all installments
                foreach (var installment in installments)
                {
                    installmentTable.Rows.Add(
                        installment.Id,
                        installment.DueDate,  // Adding DueDate value
                        installment.Amount,
                        EditModel.Atype,
                        EditModel.GrowerGroupSelectName,
                           EditModel.Growerid
                    ); ;
                }

                using (SqlCommand cmd = new SqlCommand("sp_InsertInstallments", connection))
                {
                    cmd.CommandType = CommandType.StoredProcedure;
                    SqlParameter parameter = cmd.Parameters.AddWithValue(
                                   "@Installments",
                                   installmentTable
                               );
                    parameter.SqlDbType = SqlDbType.Structured;
                    parameter.TypeName = "dbo.InstallmentType";  // Must match your SQL type


                    await cmd.ExecuteNonQueryAsync();
                }
            }
        }



















        public async Task<List<CompanyModel>> GetallChallanlistAll(int SubgrowerId)
        {
            List<CompanyModel> Allchallan = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                const string query = "SELECT id, ChallanName, Address, Phone1 +SPACE(1) + CAST(IsSMSPhone1 AS VARCHAR) AS Phone1, Phone2 +SPACE(2) + CAST(IsSMSPhone2 AS VARCHAR) AS Phone2 FROM challanmaster WHERE flagdeleted = 0 AND subid = @SubgrowerId";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                cmd.Parameters.AddWithValue("@SubgrowerId", SubgrowerId);

                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        ChallanId = Convert.ToInt32(rdr["id"]),
                        ChallanName = rdr["ChallanName"].ToString(),

                        ChallanAddress = rdr["Address"].ToString(),
                        ChallanPhone1 = rdr["Phone1"].ToString(),
                        ChallanPhone2 = rdr["Phone2"].ToString()


                        //,
                        //                        ChallanName,
                        //                        Address,
                        //                        Phone1 + space(1) & IsSMSPhone1,
                        //                        Phone2 + space(2) & IsSMSPhone2


                    };
                    Allchallan.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Allchallan;
        }



        public async Task<List<CompanyModel>> GetChallocation(int chamberid)
        {
            List<CompanyModel> Getallocation = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                var query = "SELECT c.qty as capacity,a.chamber,a.ser,c.status,a.idno as id,a.wid,partytypeid  +'-'+ partyname as PartyName ,SUM(a.qty) as TotalQuantity FROM challocation a LEFT JOIN party p ON a.wid = p.partyid LEFT JOIN chamber c ON a.chamber = c.chamberid WHERE a.chamber = @chamberid GROUP BY a.chamber, a.ser, c.status,A.idno,a.wid,c.qty, p. partytypeid  +'-'+ partyname ORDER BY a.ser";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                cmd.Parameters.AddWithValue("@chamberid", chamberid);

                SqlDataReader reader = await cmd.ExecuteReaderAsync();

                while (reader.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        ChamberId = Convert.ToInt32(reader["chamber"]),
                        AllocationNo = Convert.ToInt32(reader["id"]),
                        GrowerGroupName = reader["PartyName"] as string,
                        ChamberAllocation = Convert.ToDecimal(reader["TotalQuantity"]),
                        chambercapcity = Convert.ToInt32(reader["capacity"]),

                        ChamberName = reader["chamber"] as string,
                        IsLocked = reader.GetBoolean(reader.GetOrdinal("status")),






                    };
                    Getallocation.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Getallocation;
        }



        public async Task<List<CompanyModel>> GetchsummaryGrowerdet(int chamberid)
        {
            List<CompanyModel> GetGrowerallocation = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                var query = "SELECT c.qty as capacity,a.chamber,a.ser,c.status,a.chamber as id,a.wid,partytypeid  +'-'+ partyname as PartyName ,SUM(a.qty) as TotalQuantity FROM challocation a LEFT JOIN party p ON a.wid = p.partyid LEFT JOIN chamber c ON a.chamber = c.chamberid WHERE a.wid = @chamberid GROUP BY a.chamber, a.ser, c.status,A.idno,a.wid,c.qty, p. partytypeid  +'-'+ partyname ORDER BY a.ser";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                cmd.Parameters.AddWithValue("@chamberid", chamberid);

                SqlDataReader reader = await cmd.ExecuteReaderAsync();

                while (reader.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        ChamberId = Convert.ToInt32(reader["chamber"]),
                        AllocationNo = Convert.ToInt32(reader["id"]),
                        GrowerGroupName = reader["PartyName"] as string,
                        ChamberAllocation = Convert.ToDecimal(reader["TotalQuantity"]),
                        chambercapcity = Convert.ToInt32(reader["capacity"]),

                        ChamberName = reader["chamber"] as string,
                        IsLocked = reader.GetBoolean(reader.GetOrdinal("status")),






                    };
                    GetGrowerallocation.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetGrowerallocation;
        }






        public async Task<CompanyModel?> Getchsummary(int chamberid)

        {
            CompanyModel? EditModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                var query = "SELECT (SELECT COALESCE(SUM(qty), 0) FROM chamber WHERE chamberid = @chamberid) AS capacity,   (SELECT COALESCE(SUM(qty), 0) FROM challocation WHERE chamber = @chamberid) AS TotalQuantity;";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                cmd.Parameters.AddWithValue("@chamberid", chamberid);

                SqlDataReader reader = await cmd.ExecuteReaderAsync();

                while (reader.Read())
                {
                    EditModel = new CompanyModel
                    {


                        chambercapacitytotal = Convert.ToInt32(reader["capacity"]),
                        chamberallotedtotal = Convert.ToInt32(reader["TotalQuantity"]),






                    };

                }
                con.Close();
                cmd.Dispose();
            }
            return EditModel;
        }




        public async Task<CompanyModel?> GetchsummaryGrower(int chamberid)

        {
            CompanyModel? EditModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                var query = "SELECT (SELECT COALESCE(SUM(qty), 0) FROM groweragreement WHERE mainid =@chamberid) AS TotalAgreementQty,    (SELECT COALESCE(SUM(qty), 0) FROM challocation WHERE wid = @chamberid) AS TotalAllocationQty;";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                cmd.Parameters.AddWithValue("@chamberid", chamberid);

                SqlDataReader reader = await cmd.ExecuteReaderAsync();

                while (reader.Read())
                {
                    EditModel = new CompanyModel
                    {


                        chambercapacitytotalgrower = Convert.ToInt32(reader["TotalAgreementQty"]),
                        chamberallotedtotalgrower = Convert.ToInt32(reader["TotalAllocationQty"]),






                    };

                }
                con.Close();
                cmd.Dispose();
            }
            return EditModel;
        }














        //public async Task<List<CompanyModel>> Getchsummary(int chamberid)
        //{
        //    List<CompanyModel> Getallocation = new List<CompanyModel>();

        //    using (SqlConnection con = new SqlConnection(_configuration.Value))

        //    {
        //        var query = "SELECT sum(c.qty) as capacity,SUM(a.qty) as TotalQuantity FROM challocation a LEFT JOIN party p ON a.wid = p.partyid LEFT JOIN chamber c ON a.chamber = c.chamberid WHERE a.chamber = @chamberid";

        //        SqlCommand cmd = new SqlCommand(query, con)
        //        {
        //            CommandType = CommandType.Text
        //        };

        //        con.Open();
        //        cmd.Parameters.AddWithValue("@chamberid", chamberid);

        //        SqlDataReader reader = await cmd.ExecuteReaderAsync();

        //        while (reader.Read())
        //        {
        //            CompanyModel companyModel = new CompanyModel
        //            {

        //                chambercapacitytotal = Convert.ToInt32(reader["capacity"]),
        //                chamberallotedtotal = Convert.ToInt32(reader["TotalQuantity"]),







        //            };
        //            Getallocation.Add(companyModel);
        //        }
        //        con.Close();
        //        cmd.Dispose();
        //    }
        //    return Getallocation;
        //}

        ////public async Task<CompanyModel?> Getallocationdet(int selectedno)
        ////{
        ////    if (EditModel == null)
        ////        return null;

        ////    using (SqlConnection con = new SqlConnection(_configuration.Value))
        ////    {
        ////        await con.OpenAsync();

        ////        var query = "SELECT a.chamber,a.ser,c.status,a.idno as id,a.wid,partytypeid  +'-'+ partyname as PartyName ,SUM(a.qty) as TotalQuantity FROM challocation a LEFT JOIN party p ON a.wid = p.partyid LEFT JOIN chamber c ON a.chamber = c.chamberid WHERE a.idno = @chamberid GROUP BY a.chamber, a.ser, c.status,A.idno,a.wid, p. partytypeid  +'-'+ partyname ORDER BY a.ser";
        ////        {
        ////            cmd.CommandType = CommandType.Text;

        ////            // Make sure there are no extra spaces in parameter names!
        ////            cmd.Parameters.AddWithValue("@Vehno", EditModel.Vehno);
        ////            cmd.Parameters.AddWithValue("@Drname", EditModel.VehDriver);
        ////            cmd.Parameters.AddWithValue("@drcontact", EditModel.VehContact);
        ////            cmd.Parameters.AddWithValue("@vrtype", EditModel.Vehntype);
        ////            cmd.Parameters.AddWithValue("@Userid", EditModel.UserId);
        ////            cmd.Parameters.AddWithValue("@vid", EditModel.Vehid);











        ////            await cmd.ExecuteNonQueryAsync();
        ////        }

        ////        // After stored procedure, retrieve message from dbo.svalidate
        ////        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
        ////        {
        ////            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
        ////            {
        ////                if (rdr.Read())
        ////                {
        ////                    EditModel.RetMessage = rdr["remarks"]?.ToString();
        ////                    EditModel.RetFlag = rdr["flag"]?.ToString();
        ////                }
        ////            }
        ////        }

        ////        return EditModel;
        ////    }
        ////}



        public async Task<CompanyModel?> Getallocationdet(int selectedno)

        {
            CompanyModel? EditModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))

            {
                var query = "SELECT a.chamber,a.ser,c.status,a.idno as id,a.wid,partytypeid  +'-'+ partyname as PartyName ,SUM(a.qty) as TotalQuantity FROM challocation a LEFT JOIN party p ON a.wid = p.partyid LEFT JOIN chamber c ON a.chamber = c.chamberid WHERE a.idno = @chamberid GROUP BY a.chamber, a.ser, c.status,A.idno,a.wid, p. partytypeid  +'-'+ partyname ORDER BY a.ser";

                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                cmd.Parameters.AddWithValue("@chamberid", selectedno);

                SqlDataReader reader = await cmd.ExecuteReaderAsync();

                while (reader.Read())
                {
                    EditModel = new CompanyModel
                    {

                       ChamberId = Convert.ToInt32(reader["chamber"]),
                       AllocationNo = Convert.ToInt32(reader["id"]),
                       GrowerGroupName = reader["PartyName"] as string,
                       ChamberAllocation = Convert.ToDecimal(reader["TotalQuantity"]),

                       ChamberName = reader["chamber"] as string,
                       IsLocked = reader.GetBoolean(reader.GetOrdinal("status")),






                    };
                 
                }
                con.Close();
                cmd.Dispose();
            }
            return EditModel;
        }






        public async Task<CompanyModel?> AddChallanGrower(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("AddChallanGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@GrowerId", EditModel.SubGrowerId);
                    cmd.Parameters.AddWithValue("@GrowerName", EditModel.GrowerName);
                    cmd.Parameters.AddWithValue("@Chname", EditModel.ChallanName);
                    cmd.Parameters.AddWithValue("@Chaddress", EditModel.ChallanAddress);
                    cmd.Parameters.AddWithValue("@Chvillage", EditModel.ChallanVillage);
                    cmd.Parameters.AddWithValue("@Chcity", EditModel.ChallanCity);
                    cmd.Parameters.AddWithValue("@Chphone1", EditModel.ChallanPhone1);
                    cmd.Parameters.AddWithValue("@Chphone2", EditModel.ChallanPhone2);
                    cmd.Parameters.AddWithValue("@Chsms1", EditModel.ChallanSMS1);
                    cmd.Parameters.AddWithValue("@Chsms2", EditModel.ChallanSMS2);



                   





                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }



        public async Task<CompanyModel?> AddChallandirect(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("AddChallanGroupdirect", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@GrowerId", 1);
                    cmd.Parameters.AddWithValue("@GrowerName", EditModel.GrowerName);
                    cmd.Parameters.AddWithValue("@Chname", EditModel.ChallanName);
                    cmd.Parameters.AddWithValue("@Chaddress", EditModel.ChallanAddress);
                    cmd.Parameters.AddWithValue("@Chvillage", EditModel.ChallanAddress);
                    cmd.Parameters.AddWithValue("@Chcity", EditModel.ChallanAddress);
                    cmd.Parameters.AddWithValue("@Chphone1", EditModel.ChallanPhone1);
                    cmd.Parameters.AddWithValue("@Chphone2", EditModel.ChallanPhone1);
                    cmd.Parameters.AddWithValue("@Chsms1", false);
                    cmd.Parameters.AddWithValue("@Chsms2", false);









                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }





        //  AddMasterSubGroup



        public async Task<CompanyModel?> AddMasterGroup(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("AddMasterAccountGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@MaccGrp", EditModel.MaccGrp);
                    cmd.Parameters.AddWithValue("@MaccDetails", EditModel.MaccDetails);
                    cmd.Parameters.AddWithValue("@UserId", EditModel.UserId);
                    









                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }

        public async Task<CompanyModel?> AddItemGroup(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("AddItemGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Purchgrp", EditModel.PurchGrp);
                    cmd.Parameters.AddWithValue("@ItemName", EditModel.PurchaseItemName);
                    cmd.Parameters.AddWithValue("@ItemUom", EditModel.ItemUom);
                    cmd.Parameters.AddWithValue("@ItemGst", EditModel.ItemGst);
                    cmd.Parameters.AddWithValue("@ItemHsn", EditModel.ItemHsn);
                    cmd.Parameters.AddWithValue("@UserId", EditModel.UserId);










                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }
        public async Task<CompanyModel?> Addveh(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("Addveh", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Vehno", EditModel.Vehno);
                    cmd.Parameters.AddWithValue("@Drname", EditModel.VehDriver);
                    cmd.Parameters.AddWithValue("@drcontact", EditModel.VehContact);
                    cmd.Parameters.AddWithValue("@Vrtype", EditModel.Vehntype);
                    cmd.Parameters.AddWithValue("@Userid", EditModel.UserId);
          









                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }
        public async Task<CompanyModel?> AddPurchaseOrderItem(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("AddPurchaseOrderItem", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@OrderId", EditModel.PurchaseOrderId);
                    cmd.Parameters.AddWithValue("@ItemName", EditModel.PurchaseItemName);
                    cmd.Parameters.AddWithValue("@ItemQty", EditModel.PurchaseOrderqty);
                    cmd.Parameters.AddWithValue("@otherdet", EditModel.PurchaseOrderItemDescrip);
                  








                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }

        public async Task<CompanyModel?> addCrateAdjustment(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomicity
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("addCrateAdjustment", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fix: Remove extra space in "@userid " (should be "@userid")
                            cmd.Parameters.AddWithValue("@Cdate", EditModel.CrateIssueDated);
                            cmd.Parameters.AddWithValue("@Partyname", EditModel.GrowerGroupName);
                            cmd.Parameters.AddWithValue("@GrowerName", EditModel.GrowerName);
                            cmd.Parameters.AddWithValue("@challanName", EditModel.CrTransferGrowerGroup);
                            cmd.Parameters.AddWithValue("@userid", EditModel.UserId); // Fixed parameter name
                          
                            cmd.Parameters.AddWithValue("@Vehno", EditModel.CrTransferGrower);
                            cmd.Parameters.AddWithValue("@Remarks", EditModel.CrissueRemarks);
                            cmd.Parameters.AddWithValue("@Qty", EditModel.CrissueQty);

                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit(); // Commit only if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback(); // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }





        public async Task<CompanyModel?> addCrateEmpty(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomic operations
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("addCrateEmpty", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fixed parameter names (removed space after "@userid")
                            cmd.Parameters.AddWithValue("@Cdate", EditModel.CrateIssueDated);
                            cmd.Parameters.AddWithValue("@Partyname", EditModel.GrowerGroupName);
                            cmd.Parameters.AddWithValue("@GrowerName", EditModel.GrowerName);
                            cmd.Parameters.AddWithValue("@challanName", EditModel.ChallanName);
                            cmd.Parameters.AddWithValue("@userid", EditModel.UserId);  // Fixed: removed space
                            cmd.Parameters.AddWithValue("@crateMark", EditModel.CrissueMark);
                            cmd.Parameters.AddWithValue("@Vehno", EditModel.Vehno);
                            cmd.Parameters.AddWithValue("@Remarks", EditModel.CrissueRemarks);
                            cmd.Parameters.AddWithValue("@Qty", EditModel.CrissueQty);

                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit();  // Only commit if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();  // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }


        public async Task<CompanyModel?> addCrateOut(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomic operations
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("addCrateOut", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fixed parameter names (removed space after "@userid")
                            cmd.Parameters.AddWithValue("@Cdate", EditModel.CrateIssueDated);
                            cmd.Parameters.AddWithValue("@Partyname", EditModel.GrowerGroupName);
                            cmd.Parameters.AddWithValue("@GrowerName", EditModel.GrowerName);
                            cmd.Parameters.AddWithValue("@challanName", EditModel.ChallanName);
                            cmd.Parameters.AddWithValue("@userid", EditModel.UserId);  // Fixed: removed space
                            cmd.Parameters.AddWithValue("@crateMark", EditModel.CrissueMark);
                            cmd.Parameters.AddWithValue("@Vehno", EditModel.Vehno);
                            cmd.Parameters.AddWithValue("@Remarks", EditModel.CrissueRemarks);
                            cmd.Parameters.AddWithValue("@Qty", EditModel.CrissueQty);
                            cmd.Parameters.AddWithValue("@trflag", EditModel.CrissueFlag);

                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit();  // Only commit if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();  // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }

        public async Task<CompanyModel?> AddFinalDemand(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomic operations
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("AddFinalDemand", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fixed parameter names (removed space after "@userid")
                            cmd.Parameters.AddWithValue("@tempid", EditModel.TempOrderId);
                            cmd.Parameters.AddWithValue("@Orderby", EditModel.OrderBy);
                            cmd.Parameters.AddWithValue("@OrderContact", EditModel.DemandContact);
                            cmd.Parameters.AddWithValue("@OrderType", EditModel.DemandStatus);
                            cmd.Parameters.AddWithValue("@Dremarks", EditModel.DemandRemarks);  // Fixed: removed space
                            cmd.Parameters.AddWithValue("@Dated", EditModel.OrderDate);
                            cmd.Parameters.AddWithValue("@DelDated", EditModel.DeliveryDate);
                            cmd.Parameters.AddWithValue("@Createdby", EditModel.GlobalUserName);


                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit();  // Only commit if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();  // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }



        public async Task<CompanyModel?> AddFinalRaw(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomic operations
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("AddFinalRaw", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fixed parameter names (removed space after "@userid")
                            cmd.Parameters.AddWithValue("@tempid", EditModel.TempOrderId);
                            cmd.Parameters.AddWithValue("@Orderby", EditModel.OrderBy);
                            cmd.Parameters.AddWithValue("@OrderContact", EditModel.DemandContact);
                            cmd.Parameters.AddWithValue("@OrderType", EditModel.TransferType);
                            cmd.Parameters.AddWithValue("@Dremarks", EditModel.DemandRemarks);  // Fixed: removed space
                            cmd.Parameters.AddWithValue("@Dated", EditModel.OrderDate);
                            cmd.Parameters.AddWithValue("@DelDated", EditModel.DeliveryDate);
                            cmd.Parameters.AddWithValue("@Createdby", EditModel.GlobalUserName);
                            cmd.Parameters.AddWithValue("@Transferto", EditModel.TransferTo);


                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit();  // Only commit if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();  // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }





        public async Task<CompanyModel?> updateFinalRaw(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomic operations
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("updateFinalRaw", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fixed parameter names (removed space after "@userid")
                            cmd.Parameters.AddWithValue("@Outid", EditModel.DemandNo);
                            cmd.Parameters.AddWithValue("@tempid", EditModel.TempOrderId);
                            cmd.Parameters.AddWithValue("@Orderby", EditModel.OrderBy);
                            cmd.Parameters.AddWithValue("@OrderContact", EditModel.DemandContact);
                            cmd.Parameters.AddWithValue("@OrderType", EditModel.TransferType);
                            cmd.Parameters.AddWithValue("@Dremarks", EditModel.DemandRemarks);  // Fixed: removed space
                            cmd.Parameters.AddWithValue("@Dated", EditModel.OrderDate);
                            cmd.Parameters.AddWithValue("@DelDated", EditModel.DeliveryDate);
                            cmd.Parameters.AddWithValue("@Createdby", EditModel.GlobalUserName);
                            cmd.Parameters.AddWithValue("@Transferto", EditModel.TransferTo);


                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit();  // Only commit if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();  // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }













        public async Task<CompanyModel?> AddFinalPacking(CompanyModel EditModel,int unit)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomic operations
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("AddFinalPacking", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fixed parameter names (removed space after "@userid")
                            cmd.Parameters.AddWithValue("@PalletId", EditModel.PalletId);
                            cmd.Parameters.AddWithValue("@PackingQty", EditModel.selectedPackingQty);
                            cmd.Parameters.AddWithValue("@Party", EditModel.GrowerGroupName);
                            cmd.Parameters.AddWithValue("@Grower", EditModel.GrowerName);
                            cmd.Parameters.AddWithValue("@Challan", EditModel.ChallanName);  // Fixed: removed space
                            cmd.Parameters.AddWithValue("@Dated", EditModel.PackingOrderDate);
                            cmd.Parameters.AddWithValue("@Vehno", EditModel.Vehno);

                            cmd.Parameters.AddWithValue("@Createdby", EditModel.GlobalUserName);
                            cmd.Parameters.AddWithValue("@Unitid", unit);
                            cmd.Parameters.AddWithValue("@Recipeid", EditModel.ReceipeName);
                            cmd.Parameters.AddWithValue("@PackingOrderId", EditModel.Packingorderid);
                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit();  // Only commit if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();  // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }
        public async Task<CompanyModel?> AddFinaloutward(CompanyModel EditModel, int unit)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomic operations
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("AddFinaloutward", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fixed parameter names (removed space after "@userid")
                            cmd.Parameters.AddWithValue("@PalletId", EditModel.PalletId);
                            cmd.Parameters.AddWithValue("@PackingQty", EditModel.OutwardQty);
                            cmd.Parameters.AddWithValue("@Party", EditModel.OutwardGrowerGroup);
                            cmd.Parameters.AddWithValue("@Grower", EditModel.OutwardGrowerName);
                            cmd.Parameters.AddWithValue("@Challan", EditModel.ChallanName);  // Fixed: removed space
                            cmd.Parameters.AddWithValue("@Dated", EditModel.OutwardDate);
                            cmd.Parameters.AddWithValue("@Vehno", EditModel.Vehno);

                            cmd.Parameters.AddWithValue("@Createdby", EditModel.GlobalUserName);
                            cmd.Parameters.AddWithValue("@Unitid", unit);
                            cmd.Parameters.AddWithValue("@Recipeid", EditModel.ReceipeName);
                            cmd.Parameters.AddWithValue("@PackingOrderId", EditModel.Packingorderid);
                            cmd.Parameters.AddWithValue("@dispatch", EditModel.DispatcherId);
                            
                            cmd.Parameters.AddWithValue("@Tempid", EditModel.TempOutwardId);
                            cmd.Parameters.AddWithValue("@Outfix", EditModel.OutwardFixid);
                            cmd.Parameters.AddWithValue("@Outwardno", EditModel.Outwardno);
                            cmd.Parameters.AddWithValue("@outwardtype", EditModel.Outwardtype);

                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit();  // Only commit if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();  // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }




        public async Task<CompanyModel?> UpdateFinaloutward(List<CompanyModel> checkedPellets, CompanyModel baseEditModel, int unit)
        {
            if (checkedPellets == null || !checkedPellets.Any() || baseEditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        // Build all commands in one transaction
                        foreach (var item in checkedPellets)
                        {
                            using (SqlCommand cmd = new SqlCommand("updateFinaloutwardback", con, transaction))
                            {
                                cmd.CommandType = CommandType.StoredProcedure;
                                cmd.CommandTimeout = 300; // Increase timeout for batch

                                cmd.Parameters.AddWithValue("@PalletId", item.PalletId);
                                cmd.Parameters.AddWithValue("@PackingQty", item.OutwardQty);
                                cmd.Parameters.AddWithValue("@Party", baseEditModel.OutwardGrowerGroup);
                                cmd.Parameters.AddWithValue("@Grower", baseEditModel.OutwardGrowerName);
                                cmd.Parameters.AddWithValue("@Challan", baseEditModel.ChallanName);
                                cmd.Parameters.AddWithValue("@Dated", baseEditModel.OutwardDate);
                                cmd.Parameters.AddWithValue("@Vehno", baseEditModel.Vehno);
                                cmd.Parameters.AddWithValue("@Tempid", baseEditModel.TempOutwardId);
                                cmd.Parameters.AddWithValue("@Createdby", baseEditModel.GlobalUserName);
                                cmd.Parameters.AddWithValue("@Unitid", unit);
                                cmd.Parameters.AddWithValue("@Recipeid", item.ReceipeName);
                                cmd.Parameters.AddWithValue("@PackingOrderId", baseEditModel.Packingorderid);
                                cmd.Parameters.AddWithValue("@dispatch", item.DispatcherId);
                                cmd.Parameters.AddWithValue("@Outfix", item.Outwardid);
                                cmd.Parameters.AddWithValue("@Outwardno", baseEditModel.Outwardno);

                                await cmd.ExecuteNonQueryAsync();
                            }
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    baseEditModel.RetMessage = rdr["remarks"]?.ToString();
                                    baseEditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit();
                        return baseEditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();
                        baseEditModel.RetMessage = $"Error: {ex.Message}";
                        baseEditModel.RetFlag = "FALSE";
                        return baseEditModel;
                    }
                }
            }
        }






        public async Task<CompanyModel?> truncoutward(CompanyModel EditModel, int unit,int outward)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomic operations
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("truncoutward", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fixed parameter names (removed space after "@userid")
                            cmd.Parameters.AddWithValue("@unit", unit);
                            cmd.Parameters.AddWithValue("@outward", outward);
                          
                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit();  // Only commit if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();  // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }

        public async Task<CompanyModel?> AddFinalDispatch(CompanyModel EditModel, int unit)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomic operations
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("AddFinalDispatch", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fixed parameter names (removed space after "@userid")
                            cmd.Parameters.AddWithValue("@PalletId", EditModel.PalletId);
                            cmd.Parameters.AddWithValue("@PackingQty", EditModel.DispatchQty);
                            cmd.Parameters.AddWithValue("@Createdby", EditModel.GlobalUserName);
                            cmd.Parameters.AddWithValue("@Unitid", unit);
                          
                            cmd.Parameters.AddWithValue("@PackingOrderId", EditModel.Packingorderid);
                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit();  // Only commit if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();  // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }






        public async Task<CompanyModel?> UpdateFinalPacking(CompanyModel EditModel, int unit,int packid)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomic operations
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("UpdateFinalPacking", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fixed parameter names (removed space after "@userid")
                            cmd.Parameters.AddWithValue("@PalletId", EditModel.PalletId);
                            cmd.Parameters.AddWithValue("@PackingQty", EditModel.selectedPackingQty);
                            cmd.Parameters.AddWithValue("@Party", EditModel.GrowerGroupName);
                            cmd.Parameters.AddWithValue("@Challan", EditModel.ChallanName);  // Fixed: removed space
                            cmd.Parameters.AddWithValue("@Dated", EditModel.PackingOrderDate);
                            cmd.Parameters.AddWithValue("@Vehno", EditModel.Vehno);

                            cmd.Parameters.AddWithValue("@Createdby", EditModel.GlobalUserName);
                            cmd.Parameters.AddWithValue("@Unitid", unit);
                            cmd.Parameters.AddWithValue("@Recipeid", EditModel.ReceipeName);
                            cmd.Parameters.AddWithValue("@PackingOrderId", packid);
                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit();  // Only commit if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();  // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }
































        public async Task<CompanyModel?> AddFinalDraft(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomic operations
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("AddFinalDraft", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fixed parameter names (removed space after "@userid")
                            cmd.Parameters.AddWithValue("@tempid", EditModel.TempDraftId);
                            cmd.Parameters.AddWithValue("@Dated", EditModel.DraftDate);
                            cmd.Parameters.AddWithValue("@Createdby", EditModel.GlobalUserName);


                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit();  // Only commit if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();  // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }
        public async Task<CompanyModel?> Addoutwardtemp(CompanyModel EditModel,int unit,int tempid)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomic operations
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("Addoutwardtemp", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fixed parameter names (removed space after "@userid")
                            cmd.Parameters.AddWithValue("@tempid", tempid);
                            cmd.Parameters.AddWithValue("@unitid", unit);
                            cmd.Parameters.AddWithValue("@PalletId", EditModel.PalletId);
                            cmd.Parameters.AddWithValue("@Qty", EditModel.OutwardQty);
                            cmd.Parameters.AddWithValue("@orderid", EditModel.Packingorderid);
                            cmd.Parameters.AddWithValue("@Createdby", EditModel.GlobalUserName);
                            cmd.Parameters.AddWithValue("@dispatchid", EditModel.DispatcherId);
                            cmd.Parameters.AddWithValue("@Retid", EditModel.IsReturned);

                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit();  // Only commit if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();  // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }

        public async Task<CompanyModel?> Addoutwardtempwithedit(CompanyModel EditModel, int unit, int tempid,int demand)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomic operations
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("Addoutwardtempedit", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fixed parameter names (removed space after "@userid")
                            cmd.Parameters.AddWithValue("@tempid", tempid);
                            cmd.Parameters.AddWithValue("@unitid", unit);
                            cmd.Parameters.AddWithValue("@PalletId", EditModel.PalletId);
                            cmd.Parameters.AddWithValue("@Qty", EditModel.OutwardQty);
                            cmd.Parameters.AddWithValue("@orderid", EditModel.Packingorderid);
                            cmd.Parameters.AddWithValue("@Createdby", EditModel.GlobalUserName);
                            cmd.Parameters.AddWithValue("@dispatchid", EditModel.DispatcherId);
                            cmd.Parameters.AddWithValue("@Retid", EditModel.IsReturned);
                            cmd.Parameters.AddWithValue("@Demandid", demand);
                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit();  // Only commit if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();  // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }


        public async Task<CompanyModel?> AddDraftitem(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomic operations
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("AddDraftitem", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fixed parameter names (removed space after "@userid")
                            cmd.Parameters.AddWithValue("@Draftid", EditModel.DraftId);
                            cmd.Parameters.AddWithValue("@Receipename", EditModel.ReceipeName);
                            cmd.Parameters.AddWithValue("@Qty", EditModel.ReceipeQty);
                            cmd.Parameters.AddWithValue("@Variety", EditModel.VarietyId);
                            cmd.Parameters.AddWithValue("@Marka", EditModel.ReceipeMarka);

                            cmd.Parameters.AddWithValue("@gradeId", EditModel.ReceipeGrade);
                            cmd.Parameters.AddWithValue("@locationId", EditModel.ReceipeLocation);
                            cmd.Parameters.AddWithValue("@Createdby", EditModel.GlobalUserName);
                            cmd.Parameters.AddWithValue("@unitId", EditModel.GlobalUnitId);

                            cmd.Parameters.AddWithValue("@Boxbrand", 1);


                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit();  // Only commit if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();  // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }

        public async Task<CompanyModel?> UpdateDraftitem(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomic operations
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("UpdateDraftitem", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fixed parameter names (removed space after "@userid")
                            cmd.Parameters.AddWithValue("@Draftidentity", EditModel.DraftIdentity);
                            cmd.Parameters.AddWithValue("@Draftid", EditModel.DraftId);

                            cmd.Parameters.AddWithValue("@Receipename", EditModel.ReceipeName);
                            cmd.Parameters.AddWithValue("@Qty", EditModel.ReceipeQty);
                            cmd.Parameters.AddWithValue("@Marka", EditModel.ReceipeMarka);
                            cmd.Parameters.AddWithValue("@gradeId", EditModel.ReceipeGrade);
                            cmd.Parameters.AddWithValue("@locationId", EditModel.ReceipeLocation);
                            cmd.Parameters.AddWithValue("@Updatedby", EditModel.GlobalUserName);
                     


                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit();  // Only commit if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();  // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }


        public async Task<CompanyModel?> VerifyDraft(CompanyModel EditModel,int id)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomic operations
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("VerifyDraft", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                             cmd.Parameters.AddWithValue("@Draftid", id);



                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit();  // Only commit if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();  // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }


        public async Task<CompanyModel?> VerifyRates(CompanyModel EditModel, int id)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomic operations
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("VerifyRates", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            cmd.Parameters.AddWithValue("@Draftid", id);



                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit();  // Only commit if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();  // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }




















        public async Task<CompanyModel?> CloseDraftDetails(CompanyModel EditModel, int id,int wt)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomic operations
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("CloseDraftDetails", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            cmd.Parameters.AddWithValue("@Draftid", id);

                            cmd.Parameters.AddWithValue("@Weight", wt);
                            cmd.Parameters.AddWithValue("@rems", EditModel.Repackremarks);




                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit();  // Only commit if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();  // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }


        public async Task<CompanyModel?> AddDraftQty(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomic operations
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("AddDraftQty", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fixed parameter names (removed space after "@userid")
                            cmd.Parameters.AddWithValue("@tempid", EditModel.DraftId);
                            cmd.Parameters.AddWithValue("@Dated", EditModel.DraftDate);
                            cmd.Parameters.AddWithValue("@Createdby", EditModel.GlobalUserName);
                            cmd.Parameters.AddWithValue("@outid", EditModel.DemandNo);
                            cmd.Parameters.AddWithValue("@Lotno", EditModel.Lotno);
                            cmd.Parameters.AddWithValue("@Dqty", EditModel.GradingQty);
                            cmd.Parameters.AddWithValue("@storeid", EditModel.Storeintid);


                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit();  // Only commit if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();  // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }






















        public async Task<CompanyModel?> UpdateFinalDemand(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomic operations
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("UpdateFinalDemand", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fixed parameter names (removed space after "@userid")

                            cmd.Parameters.AddWithValue("@Outid", EditModel.DemandNo);

                            cmd.Parameters.AddWithValue("@tempid", EditModel.TempOrderId);
                            cmd.Parameters.AddWithValue("@Orderby", EditModel.OrderBy);
                            cmd.Parameters.AddWithValue("@OrderContact", EditModel.DemandContact);
                            cmd.Parameters.AddWithValue("@OrderType", EditModel.DemandStatus);
                            cmd.Parameters.AddWithValue("@Dremarks", EditModel.DemandRemarks);  // Fixed: removed space
                            cmd.Parameters.AddWithValue("@Dated", EditModel.OrderDate);
                            cmd.Parameters.AddWithValue("@DelDated", EditModel.DeliveryDate);
                            cmd.Parameters.AddWithValue("@Createdby", EditModel.GlobalUserName);


                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit();  // Only commit if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();  // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }


        public async Task<CompanyModel?> UpdateFinalSachet(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // Start a transaction to ensure atomic operations
                using (SqlTransaction transaction = con.BeginTransaction())
                {
                    try
                    {
                        using (SqlCommand cmd = new SqlCommand("UpdateFinalSachet", con, transaction))
                        {
                            cmd.CommandType = CommandType.StoredProcedure;

                            // Fixed parameter names (removed space after "@userid")

                            cmd.Parameters.AddWithValue("@Outid", EditModel.DraftId);

                         


                            await cmd.ExecuteNonQueryAsync();
                        }

                        // Retrieve validation message
                        using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con, transaction))
                        {
                            using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                            {
                                if (rdr.Read())
                                {
                                    EditModel.RetMessage = rdr["remarks"]?.ToString();
                                    EditModel.RetFlag = rdr["flag"]?.ToString();
                                }
                            }
                        }

                        transaction.Commit();  // Only commit if everything succeeds
                        return EditModel;
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();  // Rollback on error
                        EditModel.RetMessage = $"Error: {ex.Message}";
                        EditModel.RetFlag = "FALSE";
                        return EditModel;
                    }
                }
            }
        }

        public async Task<CompanyModel?> UpdateCrateIssue(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdateCrateIssue", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Cid", EditModel.CrissueId);
                    cmd.Parameters.AddWithValue("@Cdate", EditModel.CrateIssueDated);
                    cmd.Parameters.AddWithValue("@Partyname", EditModel.GrowerGroupName);
                    cmd.Parameters.AddWithValue("@GrowerName", EditModel.GrowerName);
                    cmd.Parameters.AddWithValue("@challanName", EditModel.ChallanName);

                    cmd.Parameters.AddWithValue("@userid ", EditModel.UserId);
                    cmd.Parameters.AddWithValue("@crateMark", EditModel.CrissueMark);
                    cmd.Parameters.AddWithValue("@Vehno", EditModel.Vehno);
                    cmd.Parameters.AddWithValue("@Remarks", EditModel.CrissueRemarks);
                    cmd.Parameters.AddWithValue("@Qty", EditModel.CrissueQty);
                    cmd.Parameters.AddWithValue("@crflag", EditModel.CrissueFlag);











                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }

        public async Task<CompanyModel?> UpdateCrateadj(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdateCrateadj", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Cid", EditModel.CrissueId);
                    cmd.Parameters.AddWithValue("@Cdate", EditModel.CrateIssueDated);
                    cmd.Parameters.AddWithValue("@Partyname", EditModel.GrowerGroupName);
                    cmd.Parameters.AddWithValue("@GrowerName", EditModel.GrowerName);
                    cmd.Parameters.AddWithValue("@Partynameto", EditModel.CrTransferGrowerGroup);
                    cmd.Parameters.AddWithValue("@Growernameto", EditModel.CrTransferGrower);

                    cmd.Parameters.AddWithValue("@userid ", EditModel.UserId);
                   
                    cmd.Parameters.AddWithValue("@Remarks", EditModel.CrissueRemarks);
                    cmd.Parameters.AddWithValue("@Qty", EditModel.CrissueQty);











                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }



        public async Task<CompanyModel?> UpdateCrateIssueout(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdateCrateIssueout", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Cid", EditModel.CrissueId);
                    cmd.Parameters.AddWithValue("@Cdate", EditModel.CrateIssueDated);
                    cmd.Parameters.AddWithValue("@Partyname", EditModel.GrowerGroupName);
                    cmd.Parameters.AddWithValue("@GrowerName", EditModel.GrowerName);
                    cmd.Parameters.AddWithValue("@challanName", EditModel.ChallanName);

                    cmd.Parameters.AddWithValue("@userid ", EditModel.UserId);
                    cmd.Parameters.AddWithValue("@crateMark", EditModel.CrissueMark);
                    cmd.Parameters.AddWithValue("@Vehno", EditModel.Vehno);
                    cmd.Parameters.AddWithValue("@Remarks", EditModel.CrissueRemarks);
                    cmd.Parameters.AddWithValue("@Qty", EditModel.CrissueQty);
                    cmd.Parameters.AddWithValue("@trflag", EditModel.CrissueFlag);












                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }




















        public async Task<CompanyModel?> UpdatePurchaseOrderItem(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdatePurchaseOrderItem", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@OrderId", EditModel.PurchaseOrderId);
                    cmd.Parameters.AddWithValue("@ItemName", EditModel.PurchaseItemName);
                    cmd.Parameters.AddWithValue("@ItemQty", EditModel.PurchaseOrderqty);
                    cmd.Parameters.AddWithValue("@otherdet", EditModel.PurchaseOrderItemDescrip);
                    cmd.Parameters.AddWithValue("@Idno", EditModel.PurchaseOrderItemId);









                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }

        public async Task<CompanyModel?> DeletePurchaseOrderItem(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("DeletePurchaseOrderItem", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@OrderId", EditModel.PurchaseOrderId);
                    
                    cmd.Parameters.AddWithValue("@Idno", EditModel.PurchaseOrderItemId);









                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }
        public async Task<CompanyModel?> PostPurchaseOrder(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("PostPurchaseOrder", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@OrderId", EditModel.PurchaseOrderId);









                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }



        public async Task<CompanyModel?> Processbill(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("Processbill", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                 








                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }



        public async Task<CompanyModel?> Processbillgrading(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("GradingPackingInvoiceFinal", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!


                    cmd.Parameters.AddWithValue("@DraftIrn", EditModel.DraftIrn);








                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }


        public async Task<CompanyModel?> ProcessbillgradingfInal(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("GradingPackingInvoiceFinalSave", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!


                    cmd.Parameters.AddWithValue("@DraftIrn", EditModel.DraftIrn);
                    cmd.Parameters.AddWithValue("@GrowerName", EditModel.GrowerName);
                    cmd.Parameters.AddWithValue("@Billdate", EditModel.Billdate);









                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }



















        public async Task<CompanyModel?> PROCESSBILLFINAL(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("PROCESSBILLFINAL", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!









                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }

        public async Task<CompanyModel?> UnPostPurchaseOrder(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UnPostPurchaseOrder", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@OrderId", EditModel.PurchaseOrderId);









                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }


        public async Task<CompanyModel?> AssignpackingId(string uname, int packingorder, CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("assignpackingorder", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@uname", uname);
                    cmd.Parameters.AddWithValue("@Pod", packingorder);









                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }







        public async Task<CompanyModel?>AddPurchaseGroup (CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("AddPurchaseGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@MaccGrp", EditModel.PurchGrp);
                    cmd.Parameters.AddWithValue("@MaccDetails", EditModel.PurchDetails);
                    cmd.Parameters.AddWithValue("@UserId", EditModel.UserId);










                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }



















        public async Task<CompanyModel?> AddVoucherGroup(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("AddVoucherName", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@MaccGrp", EditModel.VoucherName);
                    cmd.Parameters.AddWithValue("@MaccDetails", EditModel.VoucherRemarks);
                    cmd.Parameters.AddWithValue("@UserId", EditModel.UserId);










                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }


















        public async Task<CompanyModel?> AddMasterSubGroup(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("AddMasterSubGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@MaccGrp", EditModel.MaccGrp);
                    cmd.Parameters.AddWithValue("@MaccDetails", EditModel.SubaccDetails);
                    cmd.Parameters.AddWithValue("@UserId", EditModel.UserId);
                    cmd.Parameters.AddWithValue("@MaccSub", EditModel.SubaccGrp);










                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }

        public async Task<CompanyModel?> AddSubGroups(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("AddSubGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@MaccGrp", EditModel.SubaccGrp);
                    cmd.Parameters.AddWithValue("@MaccDetails", EditModel.SubGroupDetails);
                    cmd.Parameters.AddWithValue("@UserId", EditModel.UserId);
                    cmd.Parameters.AddWithValue("@MaccSub", EditModel.SubgroupName);










                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }




        public async Task<CompanyModel?> UpdateMasterGroup(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdateMasterAccountGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@MaccGrp", EditModel.MaccGrp);
                    cmd.Parameters.AddWithValue("@MaccDetails", EditModel.MaccDetails);
                    cmd.Parameters.AddWithValue("@UserId", EditModel.UserId);
                    cmd.Parameters.AddWithValue("@Mid", EditModel.Mid);











                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }

        public async Task<CompanyModel?> UpdateVeh(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdateVeh", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Vehno", EditModel.Vehno);
                    cmd.Parameters.AddWithValue("@Drname", EditModel.VehDriver);
                    cmd.Parameters.AddWithValue("@drcontact", EditModel.VehContact);
                    cmd.Parameters.AddWithValue("@vrtype", EditModel.Vehntype);
                    cmd.Parameters.AddWithValue("@Userid", EditModel.UserId);
                    cmd.Parameters.AddWithValue("@vid", EditModel.Vehid);











                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }




        public async Task<CompanyModel?> UpdatePurchaseGroup(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdatePurchaseGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@MaccGrp", EditModel.PurchGrp);
                    cmd.Parameters.AddWithValue("@MaccDetails", EditModel.PurchDetails);
                    cmd.Parameters.AddWithValue("@UserId", EditModel.UserId);
                    cmd.Parameters.AddWithValue("@Mid", EditModel.Pid);











                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }








        public async Task<CompanyModel?> UpdateVoucherGroup(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdateVoucherGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@MaccGrp", EditModel.VoucherName);
                    cmd.Parameters.AddWithValue("@MaccDetails", EditModel.VoucherRemarks);
                    cmd.Parameters.AddWithValue("@UserId", EditModel.UserId);
                    cmd.Parameters.AddWithValue("@Mid", EditModel.VoucherId);











                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }





















        public async Task<CompanyModel?> UpdateMasterSubGroup(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdateMasterSubAccountGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@MaccGrp", EditModel.MaccGrp);
                    cmd.Parameters.AddWithValue("@MaccDetails", EditModel.Subgdetails);
                    cmd.Parameters.AddWithValue("@UserId", EditModel.UserId);
                    cmd.Parameters.AddWithValue("@Mid", EditModel.SubAccid);
                    cmd.Parameters.AddWithValue("@SubAcgrp", EditModel.SubaccGrp);












                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }





        public async Task<CompanyModel?> UpdateItemGroup(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdateItemGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@PurchGrp", EditModel.PurchGrp);
                    cmd.Parameters.AddWithValue("@Itemname", EditModel.PurchaseItemName);
                    cmd.Parameters.AddWithValue("@ItemUom", EditModel.ItemUom);
                    cmd.Parameters.AddWithValue("@Itemid", EditModel.Itemid);
                    cmd.Parameters.AddWithValue("@Itemgst", EditModel.ItemGst);
                    cmd.Parameters.AddWithValue("@Itemhsn", EditModel.ItemHsn);
                    cmd.Parameters.AddWithValue("@Userid", EditModel.UserId);












                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }










        public async Task<CompanyModel?> UpdateChallanGrower(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("[UpdateChallanGroup]", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!

                    cmd.Parameters.AddWithValue("@ChallanId", EditModel.ChallanId);
                    cmd.Parameters.AddWithValue("@Chname", EditModel.ChallanName);
                    cmd.Parameters.AddWithValue("@Chaddress", EditModel.ChallanAddress);
                    cmd.Parameters.AddWithValue("@Chvillage", EditModel.ChallanVillage);
                    cmd.Parameters.AddWithValue("@Chcity", EditModel.ChallanCity);
                    cmd.Parameters.AddWithValue("@Chphone1", EditModel.ChallanPhone1);
                    cmd.Parameters.AddWithValue("@Chphone2", EditModel.ChallanPhone2);
                    cmd.Parameters.AddWithValue("@Chsms1", EditModel.ChallanSMS1);
                    cmd.Parameters.AddWithValue("@Chsms2", EditModel.ChallanSMS2);









                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }



















        public async Task<CompanyModel?> UpdateGrowerGroup(CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdateGrowerGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Growerid", companyModel.Growerid);

                    cmd.Parameters.AddWithValue("@GrowerGrp", companyModel.GrowerGroupName);
                    cmd.Parameters.AddWithValue("@GrowerName", companyModel.GrowerName);


                    cmd.Parameters.AddWithValue("@GrowerAddress", companyModel.GrowerAddress);
                    cmd.Parameters.AddWithValue("@GrowerCity", companyModel.GrowerCity);
                    cmd.Parameters.AddWithValue("@GrowerPincode", companyModel.GrowerPincode);
                    cmd.Parameters.AddWithValue("@GrowerState", companyModel.GrowerState);
                    cmd.Parameters.AddWithValue("@GrowerStatecode", companyModel.GrowerStatecode);
                    cmd.Parameters.AddWithValue("@GrowerEmail", companyModel.GrowerEmail);
                    cmd.Parameters.AddWithValue("@GrowerPan", companyModel.GrowerPan);
                    cmd.Parameters.AddWithValue("@GrowerGst", companyModel.GrowerGst);
                    cmd.Parameters.AddWithValue("@GrowerContact", companyModel.GrowerContact);
                    cmd.Parameters.AddWithValue("@GrowerStatus", companyModel.GrowerActive);
                    cmd.Parameters.AddWithValue("@Createdby", 1);
                    cmd.Parameters.AddWithValue("@Updatedby", 1);
                    cmd.Parameters.AddWithValue("@GrowerVillage", companyModel.GrowerVillage);
                    cmd.Parameters.AddWithValue("@graceperiod", companyModel.GrowerGrace);
                    cmd.Parameters.AddWithValue("@country", companyModel.GrowerCountry); // Assuming village is same as country? Check this logic.
                    cmd.Parameters.AddWithValue("@crateQtyLimit", companyModel.GrowerCrateissue);
                    cmd.Parameters.AddWithValue("@crateQtypercent", companyModel.GrowerCratelimit);
                    cmd.Parameters.AddWithValue("@GrowerisLock", companyModel.GrowerLock);
                    cmd.Parameters.AddWithValue("@Growerisflexi", companyModel.GrowerFlexi);

                    cmd.Parameters.AddWithValue("@growerRemarks", companyModel.GrowerRemarks);

                    await cmd.ExecuteNonQueryAsync();
                }
                _appState.NotifyStateChanged();
                // Send the updated list to all connected clients
                // await _hubContext.Clients.All.SendAsync("ReceiveUpdatedGrowerList", updatedGrowerList);

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }

        public async Task<CompanyModel?> UpdateAccountName(CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdateAccountName", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Growerid", companyModel.Accountid);

                    cmd.Parameters.AddWithValue("@GrowerGrp", companyModel.AccountGroup);
                    cmd.Parameters.AddWithValue("@GrowerName", companyModel.AccountName);


                    cmd.Parameters.AddWithValue("@GrowerAddress", companyModel.AccountAddress);
                    cmd.Parameters.AddWithValue("@GrowerCity", companyModel.AccountCity);
                    cmd.Parameters.AddWithValue("@GrowerPincode", companyModel.AccountPincode);
                    cmd.Parameters.AddWithValue("@GrowerState", companyModel.AccountState);
                    cmd.Parameters.AddWithValue("@GrowerStatecode", companyModel.AccountStatecode);
                    cmd.Parameters.AddWithValue("@GrowerEmail", companyModel.AccountEmail);
                    cmd.Parameters.AddWithValue("@GrowerPan", companyModel.AccountPan);
                    cmd.Parameters.AddWithValue("@GrowerGst", companyModel.AccountGst);
                    cmd.Parameters.AddWithValue("@GrowerContact", companyModel.AccountContact);
                    cmd.Parameters.AddWithValue("@GrowerStatus", companyModel.AccountActive);
                    cmd.Parameters.AddWithValue("@Createdby", 1);
                    cmd.Parameters.AddWithValue("@Updatedby", 1);
                    cmd.Parameters.AddWithValue("@GrowerVillage", companyModel.AccountVillage);
                    cmd.Parameters.AddWithValue("@country", companyModel.AccountCountry); // Assuming village is same as country? Check this logic.
                    cmd.Parameters.AddWithValue("@GrowerisLock", companyModel.AccountLock);
                   
                    cmd.Parameters.AddWithValue("@growerRemarks", companyModel.AccountRemarks);

                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }






        public async Task<CompanyModel?> GenerateGrowerPreview(CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("GenerateGrowerPreview", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Date1", companyModel.GrowerRepdate);
                    cmd.Parameters.AddWithValue("@Date2", companyModel.GrowerRepdateto);

                    cmd.Parameters.AddWithValue("@GrowerGrp", companyModel.GrowerGroupName);
                    cmd.Parameters.AddWithValue("@GrowerActive", companyModel.GrowerActive);



                    await cmd.ExecuteNonQueryAsync();
                    con.Close();
                    cmd.Dispose();
                }
                return companyModel;

           


            }

        }


        public async Task<CompanyModel?> GenerateContractPreview(CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("GenerateContractPreview", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Date1", companyModel.GrowerRepdate);
                    cmd.Parameters.AddWithValue("@Date2", companyModel.GrowerRepdateto);

                    cmd.Parameters.AddWithValue("@GrowerGrp", companyModel.GrowerGroupName);
                   


                    await cmd.ExecuteNonQueryAsync();
                    con.Close();
                    cmd.Dispose();
                }
                return companyModel;




            }

        }




        public async Task<CompanyModel?> GenerateCratePreview(int selectedGrowerId,CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("crateissueprint", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@cid", selectedGrowerId);
                    cmd.Parameters.AddWithValue("@crflag", companyModel.CrissueFlag);

                    await cmd.ExecuteNonQueryAsync();
                    con.Close();
                    cmd.Dispose();
                }
                return companyModel;




            }

        }


        public async Task<CompanyModel?> GeneratethermalPreview(int selectedGrowerId, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("thermalproc", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@lotno", selectedGrowerId);

                    await cmd.ExecuteNonQueryAsync();
                    con.Close();
                    cmd.Dispose();
                }
                return companyModel;




            }

        }


        

             public async Task<CompanyModel?> GenerateDraftPreview(int selectedGrowerId, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("RepackPrint", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@RPNO", selectedGrowerId);

                    await cmd.ExecuteNonQueryAsync();
                    con.Close();
                    cmd.Dispose();
                }
                return companyModel;




            }

        }

        




             public async Task<CompanyModel?> Cabillprint(int selectedGrowerId, int unit,CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("Cabillprint", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@RPNO", selectedGrowerId);
                    cmd.Parameters.AddWithValue("@unit", unit);

                    await cmd.ExecuteNonQueryAsync();
                    con.Close();
                    cmd.Dispose();
                }
                return companyModel;




            }

        }


        public async Task<CompanyModel?> Gradingbillprint(int selectedGrowerId, int unit, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("GradingBillprint", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@RPNO", selectedGrowerId);
                    await cmd.ExecuteNonQueryAsync();
                    con.Close();
                    cmd.Dispose();
                }
                return companyModel;




            }

        }


        public async Task<CompanyModel?>  Outwardprint(int selectedGrowerId, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("Outwardprintproc", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@RPNO", selectedGrowerId);

                    await cmd.ExecuteNonQueryAsync();
                    con.Close();
                    cmd.Dispose();
                }
                return companyModel;




            }

        }



        public async Task<CompanyModel?> GenerateDemandPreview(int selectedGrowerId, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("Demandproc", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@lotno", selectedGrowerId);

                    await cmd.ExecuteNonQueryAsync();
                    con.Close();
                    cmd.Dispose();
                }
                return companyModel;




            }

        }









        public async Task<CompanyModel?> UpdateNameGroup(CompanyModel companyModel,int GrowerId)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdateNameGrowerGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Growerid", GrowerId);

                    cmd.Parameters.AddWithValue("@GrowerGrp", companyModel.GrowerGroupSelectName);
                    cmd.Parameters.AddWithValue("@GrowerStatus", companyModel.GrowerActive);
                    cmd.Parameters.AddWithValue("@Updatedby", 1);
                    cmd.Parameters.AddWithValue("@GrowerisLock", companyModel.GrowerLock);
                    cmd.Parameters.AddWithValue("@Growerisflexi", companyModel.GrowerFlexi);

                    
                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }




















        public async Task<CompanyModel?> UpdateSubGrowerGroup(CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdateSubGrowerGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Growerid", companyModel.SubGrowerId);

                    cmd.Parameters.AddWithValue("@GrowerGrp", companyModel.GrowerGroupName);
                    cmd.Parameters.AddWithValue("@GrowerName", companyModel.GrowerName);


                    cmd.Parameters.AddWithValue("@GrowerAddress", companyModel.GrowerAddress);
                    cmd.Parameters.AddWithValue("@GrowerCity", companyModel.GrowerCity);
                    cmd.Parameters.AddWithValue("@GrowerPincode", companyModel.GrowerPincode);
                    cmd.Parameters.AddWithValue("@GrowerState", companyModel.GrowerState);
                    cmd.Parameters.AddWithValue("@GrowerStatecode", companyModel.GrowerStatecode);
                    cmd.Parameters.AddWithValue("@GrowerEmail", companyModel.GrowerEmail);
                    cmd.Parameters.AddWithValue("@GrowerPan", companyModel.GrowerPan);
                    cmd.Parameters.AddWithValue("@GrowerGst", companyModel.GrowerGst);
                    cmd.Parameters.AddWithValue("@GrowerContact", companyModel.GrowerContact);
                    cmd.Parameters.AddWithValue("@GrowerStatus", companyModel.GrowerActive);
                    cmd.Parameters.AddWithValue("@Createdby", 1);
                    cmd.Parameters.AddWithValue("@Updatedby", 1);
                    cmd.Parameters.AddWithValue("@GrowerVillage", companyModel.GrowerVillage);
                    cmd.Parameters.AddWithValue("@graceperiod", companyModel.GrowerGrace);
                    cmd.Parameters.AddWithValue("@country", companyModel.GrowerCountry); // Assuming village is same as country? Check this logic.
                    cmd.Parameters.AddWithValue("@crateQtyLimit", companyModel.GrowerCrateissue);
                    cmd.Parameters.AddWithValue("@crateQtypercent", companyModel.GrowerCratelimit);
                    cmd.Parameters.AddWithValue("@GrowerisLock", companyModel.GrowerLock);
                    cmd.Parameters.AddWithValue("@Growerisflexi", companyModel.GrowerFlexi);

                    cmd.Parameters.AddWithValue("@growerRemarks", companyModel.GrowerRemarks);

                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }





















        public async Task<CompanyModel?> DeleteSubGrowerGroup(int id, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("DeleteSubGrowerGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Growerid", companyModel.SubGrowerId);


                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }


        public async Task<CompanyModel?> DeleteAccountGroup(int id, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("DeleteAccountGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Growerid", companyModel.Growerid);


                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }



        public async Task<CompanyModel?> DeleteItemGroup(int id, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("DeleteItemGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Growerid", companyModel.Itemid);


                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }











        public async Task<CompanyModel?> DeleteGrowerGroup(int id, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("DeleteGrowerGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Growerid", companyModel.Growerid);

                  
                    await cmd.ExecuteNonQueryAsync();
                }
              
                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }
                _appState.NotifyStateChanged();
                return companyModel;
           
            }
        
        }

        public async Task<CompanyModel?> DeleteUserId(int id, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("DeleteUserId", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Growerid", companyModel.Userid);


                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }
                _appState.NotifyStateChanged();
                return companyModel;

            }

        }

        public async Task<CompanyModel?> DeleteMasterGroup(int id, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("DeleteMasterGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Mid", companyModel.Mid);


                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }

        public async Task<CompanyModel?> DeleteCrateIssue(int selectedGrowerId, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("DeleteCrateIssue", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Mid", selectedGrowerId);
                    cmd.Parameters.AddWithValue("@User", companyModel.GlobalUserName);
                    cmd.Parameters.AddWithValue("@crflag", companyModel.CrissueFlag);


                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }


        public async Task<CompanyModel?> DeleteOrderPallet(int selectedGrowerId, int packingid,CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("DeleteOrderPallet", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Mid", selectedGrowerId);
                    cmd.Parameters.AddWithValue("@User", companyModel.GlobalUserName);
                    cmd.Parameters.AddWithValue("@Pid", packingid);


                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }

        public async Task<CompanyModel?> DeleteDemandOrder(int selectedGrowerId, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("DeleteDemandOrder", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Mid", selectedGrowerId);
                    cmd.Parameters.AddWithValue("@User", companyModel.GlobalUserName);


                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }






       



        public async Task<CompanyModel?> DeleteDemandOrderRaw(int selectedGrowerId, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("DeleteDemandOrderRaw", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Mid", selectedGrowerId);
                    cmd.Parameters.AddWithValue("@User", companyModel.GlobalUserName);


                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }















        public async Task<CompanyModel?> Deleteoutward(int selectedGrowerId, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("Deleteoutward", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Mid", selectedGrowerId);
                    cmd.Parameters.AddWithValue("@User", companyModel.GlobalUserName);


                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }



        public async Task<CompanyModel?> DeletePackingOrder(int selectedGrowerId, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("DeletePackingOrder", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Mid", selectedGrowerId);
                    cmd.Parameters.AddWithValue("@User", companyModel.GlobalUserName);


                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }





        public async Task<CompanyModel?> DeleteAllocation(int selectedGrowerId, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("DeleteAllocation", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Chamberid", selectedGrowerId);
               


                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }
















        public async Task<CompanyModel?> DeleteCrateAdjustment(int selectedGrowerId, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("DeleteCrateAdjustment", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Mid", selectedGrowerId);


                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }
        


               public async Task<CompanyModel?> Deletedispatch(int id, CompanyModel companyModel,int unit)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("Deletedispatch", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Mid", id);
                    cmd.Parameters.AddWithValue("@unitid", unit);


                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }

        public async Task<CompanyModel?> DeleteVeh(int id, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("DeleteVehGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Mid", companyModel.Vehid);


                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }


        public async Task<CompanyModel?> DeletePurchaseGroup(int id, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("DeletePurchaseGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Mid", companyModel.Pid);


                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }






        public async Task<CompanyModel?> DeleteVoucherGroup(int id, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("DeleteVoucherGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Mid", companyModel.VoucherId);


                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }

















        public async Task<CompanyModel?> DeleteMasterSubGroup(int id, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("DeleteMasterSubGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Mid", companyModel.SubAccid);


                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }


        public async Task<CompanyModel?> DeleteSubGroup(int id, CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("DeleteSubGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Mid", companyModel.SubGroupId);


                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }



        public async Task<CompanyModel?> DeleteChallanGroup(int ChallanId , CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("DeleteChallanGroup", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@ChallanId", ChallanId);


                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }



























        public async Task<CompanyModel?> AddGrowerSub(CompanyModel companyModel)
        {
            if (companyModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("AddGrowerSub", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@GrowerGrp", companyModel.GrowerGroupSelectName);
                    cmd.Parameters.AddWithValue("@GrowerName", companyModel.GrowerName);


                    cmd.Parameters.AddWithValue("@GrowerAddress", companyModel.GrowerAddress);
                    cmd.Parameters.AddWithValue("@GrowerCity", companyModel.GrowerCity);
                    cmd.Parameters.AddWithValue("@GrowerPincode", companyModel.GrowerPincode);
                    cmd.Parameters.AddWithValue("@GrowerState", companyModel.GrowerState);
                    cmd.Parameters.AddWithValue("@GrowerStatecode", companyModel.GrowerStatecode);
                    cmd.Parameters.AddWithValue("@GrowerEmail", companyModel.GrowerEmail);
                    cmd.Parameters.AddWithValue("@GrowerPan", companyModel.GrowerPan);
                    cmd.Parameters.AddWithValue("@GrowerGst", companyModel.GrowerGst);
                    cmd.Parameters.AddWithValue("@GrowerContact", companyModel.GrowerContact);
                    cmd.Parameters.AddWithValue("@GrowerStatus", companyModel.GrowerActive);
                    cmd.Parameters.AddWithValue("@Createdby", 1);
                    cmd.Parameters.AddWithValue("@Updatedby", 1);
                    cmd.Parameters.AddWithValue("@GrowerVillage", companyModel.GrowerVillage);
                    cmd.Parameters.AddWithValue("@graceperiod", companyModel.GrowerGrace);
                    cmd.Parameters.AddWithValue("@country", companyModel.GrowerCountry); // Assuming village is same as country? Check this logic.
                    cmd.Parameters.AddWithValue("@crateQtyLimit", companyModel.GrowerCrateissue);
                    cmd.Parameters.AddWithValue("@crateQtypercent", companyModel.GrowerCratelimit);
                    cmd.Parameters.AddWithValue("@GrowerisLock", companyModel.GrowerLock);
                    cmd.Parameters.AddWithValue("@Growerisflexi", companyModel.GrowerFlexi);

                    cmd.Parameters.AddWithValue("@growerRemarks", companyModel.GrowerRemarks);

                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            companyModel.RetMessage = rdr["remarks"]?.ToString();
                            companyModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return companyModel;
            }
        }








        public async Task<CompanyModel?> SaveChamberAllocation(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("SaveChamberAllocation", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Chamberid", EditModel.ChamberId);
                    cmd.Parameters.AddWithValue("@GrowerName", EditModel.GrowerGroupName);


                    cmd.Parameters.AddWithValue("@Qty", EditModel.ChamberAllocation);
                   
                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }





        public async Task<CompanyModel?> UpdateChamberAllocation(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("UpdateChamberAllocation", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@Chamberid", EditModel.AllocationNo);
                     cmd.Parameters.AddWithValue("@Qty", EditModel.ChamberAllocation);

                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }























        public async Task<CompanyModel?> AddGrowerSubdirect(CompanyModel EditModel)
        {
            if (EditModel == null)
                return null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("AddGrowerSub", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@GrowerGrp", EditModel.GrowerGroupName);
                    cmd.Parameters.AddWithValue("@GrowerName", EditModel.GrowerName);


                    cmd.Parameters.AddWithValue("@GrowerAddress", EditModel.GrowerAddress);
                    cmd.Parameters.AddWithValue("@GrowerCity", "NA");
                    cmd.Parameters.AddWithValue("@GrowerPincode", "NA");
                    cmd.Parameters.AddWithValue("@GrowerState", "Jammu and Kashmir");
                    cmd.Parameters.AddWithValue("@GrowerStatecode","01");
                    cmd.Parameters.AddWithValue("@GrowerEmail", "NA");
                    cmd.Parameters.AddWithValue("@GrowerPan", "NA");
                    cmd.Parameters.AddWithValue("@GrowerGst", "NA");
                    cmd.Parameters.AddWithValue("@GrowerContact", EditModel.GrowerContact);
                    cmd.Parameters.AddWithValue("@GrowerStatus", 1);
                    cmd.Parameters.AddWithValue("@Createdby", 1);
                    cmd.Parameters.AddWithValue("@Updatedby", 1);
                    cmd.Parameters.AddWithValue("@GrowerVillage", "NA");
                    cmd.Parameters.AddWithValue("@graceperiod", 0);
                    cmd.Parameters.AddWithValue("@country", "India"); 
                    cmd.Parameters.AddWithValue("@crateQtyLimit", EditModel.GrowerCrateissue);
                    cmd.Parameters.AddWithValue("@crateQtypercent", EditModel.GrowerCratelimit);
                    cmd.Parameters.AddWithValue("@GrowerisLock", 0);
                    cmd.Parameters.AddWithValue("@Growerisflexi", 0);

                    cmd.Parameters.AddWithValue("@growerRemarks", "na");

                    await cmd.ExecuteNonQueryAsync();
                }

                // After stored procedure, retrieve message from dbo.svalidate
                using (SqlCommand cmd2 = new SqlCommand("SELECT TOP 1 flag,remarks FROM dbo.svalidate", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                        {
                            EditModel.RetMessage = rdr["remarks"]?.ToString();
                            EditModel.RetFlag = rdr["flag"]?.ToString();
                        }
                    }
                }

                return EditModel;
            }
        }










        public async Task<List<CompanyModel>> GetallCrateflagOut()
        {
            List<CompanyModel>  Cflaglist = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct name from dbo.CrateFlags where ftype='Grower' and srtype='OUT'";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                     

                        CrissueFlag = rdr["name"].ToString(),
                      
                    };
                    Cflaglist.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Cflaglist;
        }


        public async Task<List<CompanyModel>> GetallCrateflagall()
        {
            List<CompanyModel> Cflaglist = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct trflag as name from dbo.crateissue";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {


                        CrissueFlag = rdr["name"].ToString(),

                    };
                    Cflaglist.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Cflaglist;
        }



        public async Task<List<CompanyModel>> GetallCrateflag()
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select * from dbo.CrateFlags";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        Cfid = rdr.GetInt32(rdr.GetOrdinal("id")),

                        Cfname = rdr["name"].ToString(),
                        Cfstat = rdr["ftype"].ToString(),
                        Cflag = rdr["srtype"].ToString(),


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }

        

                    public async Task<List<CompanyModel>> GetAlladjCrn()
        {
            List<CompanyModel> Allcrn = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct  Trno from dbo.crateadjustment";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {


                        CrateCrn = rdr["Trno"].ToString(),



                    };
                    Allcrn.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Allcrn;
        }

        

         public async Task<List<CompanyModel>> GetAllunitDemands()
        {
            List<CompanyModel> DemandList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "SELECT distinct demandirn FROM LOTOUTTRANS WHERE flagdeleted=0 ";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
            
                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {


                        DemandIrn = rdr["demandirn"].ToString(),


                    };
                    DemandList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return DemandList;
        }





        public async Task<List<CompanyModel>> GetAllDemands(int UnitId)
        {
            List<CompanyModel> DemandList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "SELECT distinct demandirn FROM LOTOUTTRANS WHERE flagdeleted=0  and unitid=@Unitid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Unitid", UnitId);

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {


                        DemandIrn = rdr["demandirn"].ToString(),


                    };
                    DemandList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return DemandList;
        }

        public async Task<List<CompanyModel>> GetAllGrowerDemands(int unitid,String GrowerName)
        {
            List<CompanyModel> DemandList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT
    d.demandirn
FROM StoreOutTrans d
WHERE flagdeleted = 0 and partyid in(select partyid from  party where partytypeid  +'-'+ partyname=@Party)
GROUP BY d.demandirn
HAVING
    SUM(d.orderqty) >
    COALESCE((SELECT SUM(o.OrderQty)
              FROM(SELECT DISTINCT OutId, unitid FROM StoreOutTrans WHERE demandirn = d.demandirn AND flagdeleted = 0) s
              INNER JOIN DraftOutTrans o ON s.OutId = o.OutId AND s.unitid = o.unitid AND o.flagdeleted = 0), 0)
ORDER BY d.demandirn";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Unitid", unitid);

                cmd.Parameters.AddWithValue("@Party", GrowerName);


                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {


                        DemandIrn = rdr["demandirn"].ToString(),


                    };
                    DemandList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return DemandList;
        }

        public async Task<List<CompanyModel>> GetallDrafts(int UnitId)
        {
            List<CompanyModel> DraftList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "SELECT distinct Draftirn FROM DraftOutTrans WHERE flagdeleted=0  and unitid=@Unitid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Unitid", UnitId);

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {


                        DraftIrn = rdr["Draftirn"].ToString(),


                    };
                    DraftList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return DraftList;
        }




        public async Task<List<CompanyModel>> GetAllDemandsapprove(int UnitId)
        {
            List<CompanyModel> DemandList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = @"SELECT 
    d.demandirn
FROM StoreOutTrans d 
WHERE UnitId = Unitid 
    AND flagdeleted = 0
GROUP BY d.demandirn
HAVING 
    SUM(d.orderqty) > 
    COALESCE((SELECT SUM(o.OrderQty) 
              FROM (SELECT DISTINCT OutId, unitid FROM StoreOutTrans WHERE demandirn = d.demandirn AND flagdeleted = 0) s
              INNER JOIN DraftOutTrans o ON s.OutId = o.OutId AND s.unitid = o.unitid AND o.flagdeleted = 0), 0)
ORDER BY d.demandirn";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Unitid", UnitId);

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {


                        DemandIrn = rdr["demandirn"].ToString(),


                    };
                    DemandList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return DemandList;
        }





        public async Task<List<CompanyModel>> GetAllPackingOrders(int UnitId)
        {
            List<CompanyModel> PackingOrderList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "SELECT distinct packingorderno FROM packingorderitems WHERE flagdeleted=0 and unitid=@Unitid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Unitid", UnitId);

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {


                        PackingOrderIrn = rdr["packingorderno"].ToString(),


                    };
                    PackingOrderList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return PackingOrderList;
        }



















        public async Task<List<CompanyModel>> GetAllOrderby(int UnitId)
        {
            List<CompanyModel> GetbyOrderList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "SELECT distinct OrderByName FROM LOTOUTTRANS WHERE flagdeleted=0 and unitid=@Unitid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Unitid", UnitId);

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {


                        OrderBy = rdr["OrderByName"].ToString(),


                    };
                    GetbyOrderList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetbyOrderList;
        }








        public async Task<List<CompanyModel>> GetallSlots()
        {
            List<CompanyModel> Getallslot = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select sdate,sum(qty) as Qty from Grading_calendar WHERE flagdeleted=0 group by sdate order by sdate";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {


                        calendardate = rdr["sdate"] as DateTime? ?? DateTime.MinValue,

                        SlotQty = rdr.IsDBNull(rdr.GetOrdinal("Qty")) ? 0 : rdr.GetInt32(rdr.GetOrdinal("Qty")),


                    };
                    Getallslot.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Getallslot;
        }




















        public async Task<List<CompanyModel>> GetAllKhata()
        {
            List<CompanyModel> GetKhata = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct  KhataName from dbo.GateInTrans";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {


                        PreInwardKhata = rdr["KhataName"].ToString(),



                    };
                    GetKhata.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetKhata;
        }












        public async Task<List<CompanyModel>> GetAllCrn()
        {
            List<CompanyModel> Purchaseorderscrn = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select distinct  Trno from dbo.CRATEISSUE where Trflag='Crate Issue'";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };

                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {


                        CrateCrn = rdr["Trno"].ToString(),
                    


                    };
                    Purchaseorderscrn.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Purchaseorderscrn;
        }











        public async Task<CompanyModel?> GetGrowerIdAsync(int Growerid)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "SELECT * FROM party WHERE type='C' AND  partycode = @Id";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@Id", Growerid);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                // companyModel.Growerid = reader.GetInt32(reader.GetOrdinal("id")),




                                Growerid = reader.GetInt32(reader.GetOrdinal("partycode")),

                                GrowerGroupName = reader["partyname"] as string,
                                GrowerName = reader["GrowerName"] as string,
                                GrowerAddress = reader["address"] as string,
                                GrowerCity = reader["city"] as string,
                                GrowerPincode = reader["pincode"] as string,
                                GrowerState = reader["state"] as string,
                                GrowerStatecode = reader["statecode"] as string,
                                GrowerEmail = reader["email"] as string,
                                GrowerContact = reader["phone"] as string,
                                GrowerGst = reader["GSTNo"] as string,
                                GrowerPan= reader["panno"] as string,
                                GrowerRemarks = reader["remarks"] as string,
                                GrowerCrateissue = reader.GetDecimal(reader.GetOrdinal("CrateQtyLimit")),
                                GrowerCratelimit = reader.GetDecimal(reader.GetOrdinal("CrateIssueLimitPer")),
                                GrowerGrace = reader["greaseperiod"] as string,
                                GrowerCountry = reader["country"] as string,
                                GrowerVillage = reader["village"] as string,
                                GrowerRetLock = Convert.ToBoolean(reader["islock"]),
                                GrowerRetFlexi = Convert.ToBoolean(reader["IsFlexibleChamber"]),


                                GrowerRetAcitve = Convert.ToBoolean(reader["Status"])




                                //Gst = reader["gst"] as string,
                                //Regno = reader["regno"] as string,
                                //Pan = reader["pan"] as string,
                                //Website = reader["website"] as string,
                                //Caddress = reader["addr"] as string,

                                //City = reader["city"] as string,
                                //Phone = reader["Contact1"] as string,
                                //Mobile = reader["Contact1"] as string,
                                //State = reader["State"] as string,
                                //Pincode = reader["Pincode"] as string,
                                //Email = reader["email"] as string




                                // Map other columns as needed
                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }
        //GetAgreementByGrowerId



        public async Task<CompanyModel?> GetUserIdAsync(int Userid)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // First query: user info
                var userInfoSql = @"SELECT ci.userid, ci.username, ci.email, ci.status, 
                                   ug.name AS gname 
                            FROM USERS ci 
                            LEFT JOIN usergroup ug ON ci.usergroupid = ug.usergroupid 
                            WHERE ci.userid = @Id";

                using (var cmd = new SqlCommand(userInfoSql, con))
                {
                    cmd.Parameters.AddWithValue("@Id", Userid);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                //Userid = reader.GetInt32(reader.GetOrdinal("userid")),
                                UserName = reader["username"] as string,
                                Useremail = reader["email"] as string,
                                UserStatus = reader["status"] as string,
                                GlobalUserGroup = reader["gname"] as string
                            };
                        }
                    }
                }

                if (companyModel != null)
                {
                    // Second query: unit IDs
                    var unitSql = "SELECT UnitID FROM UserUnitMap WHERE UserID = @UserId";

                    using (var unitCmd = new SqlCommand(unitSql, con))
                    {
                        unitCmd.Parameters.AddWithValue("@UserId", Userid);

                        using (var unitReader = await unitCmd.ExecuteReaderAsync())
                        {
                            while (await unitReader.ReadAsync())
                            {
                                int unitId = unitReader.GetInt32(0);
                                switch (unitId)
                                {
                                    case 1: companyModel.Unit1 = true; break;
                                    case 2: companyModel.Unit2 = true; break;
                                    case 3: companyModel.Unit3 = true; break;
                                    case 4: companyModel.Unit4 = true; break;
                                    case 5: companyModel.Unit5 = true; break;
                                }
                            }
                        }
                    }
                }

                con.Close();
            }

            return companyModel;
        }


        public async Task<CompanyModel?> GetchamberIdAsync(int chamberid)
        {
            CompanyModel? EditModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                // First query: user info
                var userInfoSql = @"SELECT ctype,Qty,unitname
                            from chamber where chamberid = @Id";
            
                using (var cmd = new SqlCommand(userInfoSql, con))
                {
                    cmd.Parameters.AddWithValue("@Id", chamberid);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            EditModel = new CompanyModel
                            {
                                //Userid = reader.GetInt32(reader.GetOrdinal("userid")),
                                ChamberType = reader["ctype"] as string,
                                Capacity =  Convert.ToInt32(reader["Qty"]),
                                Unitname = reader["unitname"] as string
                            };
                        }
                    }
                }

                

                con.Close();
            }

            return EditModel;
        }


















        public async Task<CompanyModel?> GetTransactionIdAsync(int TransactionId)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                const string query = @"
SELECT t.tid as id,
    t.tdate,t.Remarks,t.ptype,t.refno,t.chno,
	vg.Mastername AS VoucherType,
    dp.[type]+'-'+dp.partytypeid  +'-'+ dp.partyname AS DebitPartyName,
    cp.[type]+'-'+cp.partytypeid  +'-'+ cp.partyname AS CreditPartyName,
t.remarks,
    t.Debit as Amount
    
FROM Transactions t 
LEFT JOIN party dp ON t.debitpartyid = dp.idno
LEFT JOIN party cp ON t.creditpartyid = cp.idno
LEFT JOIN vouchergroup vg ON t.Ttype = vg.id
where debit>0 and t.tid=@Id and t.flagdeleted=0";
                using (var cmd = new SqlCommand(query, con))
                {
                    cmd.Parameters.AddWithValue("@Id", TransactionId);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                // companyModel.Growerid = reader.GetInt32(reader.GetOrdinal("id")),




                                TransactionId = Convert.ToInt32(reader["id"]),
                                TransactionCredit = reader["CreditPartyName"].ToString(),
                                TransactionDebit = reader["DebitPartyName"].ToString(),

                                TransactionAmount = reader.GetDecimal(reader.GetOrdinal("Amount")),
                                TransactionType = reader["VoucherType"].ToString(),
                                TransactionRemarks = reader["Remarks"].ToString(),
                                TransactionPaymentType = reader["ptype"].ToString(),
                                TransactionDated = reader["tdate"] as DateTime? ?? DateTime.MinValue,
                                TransactionChequeno = reader["chno"].ToString(),
                                TransactionRefno = reader["refno"].ToString()








                                //Gst = reader["gst"] as string,
                                //Regno = reader["regno"] as string,
                                //Pan = reader["pan"] as string,
                                //Website = reader["website"] as string,
                                //Caddress = reader["addr"] as string,

                                //City = reader["city"] as string,
                                //Phone = reader["Contact1"] as string,
                                //Mobile = reader["Contact1"] as string,
                                //State = reader["State"] as string,
                                //Pincode = reader["Pincode"] as string,
                                //Email = reader["email"] as string




                                // Map other columns as needed
                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }



        public async Task<CompanyModel?> GetLastKhata(string Selectedpurchase,int growerid)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = @"WITH MarkaCTE AS(
    SELECT DISTINCT ISNULL(marka, '') as marka
    FROM RepackDraftItems where draftid = @growerid

    and GradeId in (select max(gradeid) from RepackDraftItems where draftid = @growerid and gradeid in (select id from itemgrades where gradename = @Selectedpurchase))
)
SELECT* FROM MarkaCTE
UNION ALL
SELECT ''
WHERE NOT EXISTS(SELECT 1 FROM MarkaCTE)";
                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@growerid", growerid);



                    cmd.Parameters.AddWithValue("@Selectedpurchase", Selectedpurchase);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                // companyModel.Growerid = reader.GetInt32(reader.GetOrdinal("id")),





                                ReceipeMarka = reader["marka"] != DBNull.Value ?
                                     reader["marka"] as string :
                                     string.Empty




                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }




        public async Task<CompanyModel?> GetAccountIdAsync(int growerid)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "SELECT party.*,b.subname FROM party, AccountSubGroups b WHERE party.masterid=b.id and type='V' AND  partycode = @Id";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@Id", growerid);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                // companyModel.Growerid = reader.GetInt32(reader.GetOrdinal("id")),




                                Accountid = reader.GetInt32(reader.GetOrdinal("partycode")),

                                AccountName = reader["partyname"] as string,
                                AccountAddress = reader["address"] as string,
                                AccountCity = reader["city"] as string,
                                AccountPincode = reader["pincode"] as string,
                                AccountState = reader["state"] as string,
                                AccountStatecode = reader["statecode"] as string,
                                AccountEmail = reader["email"] as string,
                                AccountContact = reader["phone"] as string,
                                AccountGst = reader["GSTNo"] as string,
                                AccountPan = reader["panno"] as string,
                                AccountRemarks = reader["remarks"] as string,
                                AccountCountry = reader["country"] as string,
                                AccountVillage = reader["village"] as string,
                                AccountRetLock = Convert.ToBoolean(reader["islock"]),
                                AccountGroup = reader["subname"] as string,

                                AccountRetActive = Convert.ToBoolean(reader["Status"])




                            };
                        }
                    }
                }
                con.Close();

            }

























































            return companyModel;

        }


        public async Task<CompanyModel?> Dashtotals()
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                const string sql = @"SELECT
    verified_total.total_verified_qty,
    order_total.total_order_qty,
    verified_total.total_verified_qty - order_total.total_order_qty AS balance_qty
FROM
    (SELECT COALESCE(SUM(verifiedqty), 0) AS total_verified_qty
     FROM gateintrans
     WHERE flagdeleted = 0) AS verified_total
CROSS JOIN
    (SELECT COALESCE(SUM(orderqty), 0) AS total_order_qty
     FROM lotouttrans
     WHERE flagdeleted = 0) AS order_total";

                using (var cmd = new SqlCommand(sql, con))
                {
                  

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                // companyModel.Growerid = reader.GetInt32(reader.GetOrdinal("id")),




                                TotInQty = reader.GetInt32(reader.GetOrdinal("total_verified_qty")),
                                TotOutQty = reader.GetInt32(reader.GetOrdinal("total_order_qty")),
                                TotBalQty = reader.GetInt32(reader.GetOrdinal("balance_qty")),






                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }















        public async Task<CompanyModel?> GetPackingDetails(string Packingno)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = @"SELECT distinct po.PackingOrderDate,c.partytypeid + '-' + c.partyname as PartyName,  CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName, CONVERT(VARCHAR(MAX), cm.id) + '-' + cm.ChallanName as ChallanName
,rtrim(vehno) + space(1)+'('+ rtrim(drivername)+space(1)+')'+space(1)+'('+rtrim(contactno)+')' as vehno
from packingorderitems po


left join party c on po.partyid= c.partyid
left join partysub ps on po.growerid= ps.partyid
left join vehinfo vi on po.Vehid= vi.vid
LEFT JOIN challanmaster cm ON  po.ChallanId= cm.Id 

where PackingOrderno=@Id";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@Id", Packingno);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                // companyModel.Growerid = reader.GetInt32(reader.GetOrdinal("id")),




                                OutwardGrowerGroup = reader["PartyName"] as string,
                                OutwardGrowerName = reader["GrowerName"] as string,
                                OutwardChallanName = reader["ChallanName"] as string,
                                Vehno = reader["vehno"] as string,
                                OutwardDate = Convert.ToDateTime(reader["PackingOrderDate"]),
                             ChallanName = reader["ChallanName"] as string





                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }


        public async Task<CompanyModel?> GetDemandbyAsync(int growerid)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = @"sELECT g.DemandStatus,g.tempid,
    g.LOTNO,g.lotirn,g.demandirn,g.orderdate,g.deliverydate,g.ordercontact,g.demandremarks,g.otype,g.Orderbyname,
    g.VerifiedQty AS GateInQty,c.partytypeid + '-' + c.partyname as PartyName,  CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
     g.verifiedQty ,G.ORDERQTY,prt.name as itemname, pt.name as package,g.khataname,pq.name as quality,g.locationchamberid,ur.username,
	isnull(FloorName + space(1) + lf.MatrixName + lf.RowName + space(1) + lf.ColumnName, 'NA') as tlocation,g.locationchamberid as chamber,cm.ChallanName,st.sname
FROM LotOutTrans g
LEFT JOIN users ur on g.Createdby = ur.userid
LEFT JOIN PARTY C ON G.PARTYID = C.PARTYID
LEFT JOIN PARTYsub ps ON G.GrowerId = PS.PARTYID
LEFT JOIN prodtype prt ON g.itemid = prt.id
LEFT JOIN PTYPE pt ON g.packageid = pt.id
LEFT JOIN prodqaul pq ON g.varietyid = pq.id
LEFT JOIN challanmaster cm ON g.challanid = cm.id
LEFT JOIN servicetypes st ON g.schemeid = st.id
LEFT JOIN locationFinal lf ON g.lotno = lf.lotno
where g.outid=@outid
GROUP BY g.tempid,g.DemandStatus,g.Orderbyname,g.otype,g.demandirn,g.LOTNO, g.VerifiedQty,c.partytypeid + '-' + c.partyname,convert(varchar(max), ps.partyid) + '-' + ps.partyname,prt.name ,pt.name,g.khataname,pq.name,cm.ChallanName,st.sname,
FloorName + space(1) + lf.MatrixName + lf.RowName + space(1) + lf.ColumnName,g.locationchamberid,g.lotirn,G.ORDERQTY,ur.username,g.orderdate,g.deliverydate,g.ordercontact,g.demandremarks

ORDER BY g.LOTNO"; 
                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@outid", growerid);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                // companyModel.Growerid = reader.GetInt32(reader.GetOrdinal("id")),




                           
                                GrowerGroupName = reader["partyname"] as string,
                                //GrowerName = reader["GrowerName"] as string,
                                DemandIrn = reader["demandirn"] as string,
                                //OrderDate = reader["OrderDate"] as DateTime? ?? DateTime.MinValue,
                                //DeliveryDate = reader["Ddeliverydate"] as DateTime? ?? DateTime.MinValue,
                                DemandStatus = reader["otype"] as string,
                                OrderBy = reader["Orderbyname"] as string,
                                DemandContact = reader["ordercontact"] as string,
                                DemandRemarks = reader["demandremarks"] as string,
                                OrderType = reader["DemandStatus"] as string,
                               TempOrderId = reader.GetInt32(reader.GetOrdinal("tempid")),
                              

                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }








        public async Task<CompanyModel?> GetRawDemandbyAsync(int growerid)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = @"sELECT g.DemandStatus,g.tempid,g.ItemMarka,
    g.LOTNO,g.lotirn,g.demandirn,g.orderdate,g.deliverydate,g.ordercontact,g.demandremarks,g.otype,g.Orderbyname,
    g.VerifiedQty AS GateInQty,c.partytypeid + '-' + c.partyname as PartyName,  CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
     g.verifiedQty ,G.ORDERQTY,prt.name as itemname, pt.name as package,g.khataname,pq.name as quality,g.locationchamberid,ur.username,
	isnull(FloorName + space(1) + lf.MatrixName + lf.RowName + space(1) + lf.ColumnName, 'NA') as tlocation,g.locationchamberid as chamber,cm.ChallanName,st.sname
FROM transferOutTrans g
LEFT JOIN users ur on g.Createdby = ur.userid
LEFT JOIN PARTY C ON G.PARTYID = C.PARTYID
LEFT JOIN PARTYsub ps ON G.ToGrowerId = PS.PARTYID
LEFT JOIN prodtype prt ON g.itemid = prt.id
LEFT JOIN PTYPE pt ON g.packageid = pt.id
LEFT JOIN prodqaul pq ON g.varietyid = pq.id
LEFT JOIN challanmaster cm ON g.challanid = cm.id
LEFT JOIN servicetypes st ON g.schemeid = st.id
LEFT JOIN locationFinal lf ON g.lotno = lf.lotno
where g.outid=@outid
GROUP BY g.ItemMarka,g.tempid,g.DemandStatus,g.Orderbyname,g.otype,g.demandirn,g.LOTNO, g.VerifiedQty,c.partytypeid + '-' + c.partyname,convert(varchar(max), ps.partyid) + '-' + ps.partyname,prt.name ,pt.name,g.khataname,pq.name,cm.ChallanName,st.sname,
FloorName + space(1) + lf.MatrixName + lf.RowName + space(1) + lf.ColumnName,g.locationchamberid,g.lotirn,G.ORDERQTY,ur.username,g.orderdate,g.deliverydate,g.ordercontact,g.demandremarks

ORDER BY g.LOTNO";
                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@outid", growerid);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                // companyModel.Growerid = reader.GetInt32(reader.GetOrdinal("id")),





                                GrowerGroupName = reader["partyname"] as string,
                                TransferTo = reader["GrowerName"] as string,
                                DemandIrn = reader["demandirn"] as string,
                                //OrderDate = reader["OrderDate"] as DateTime? ?? DateTime.MinValue,
                                //DeliveryDate = reader["Ddeliverydate"] as DateTime? ?? DateTime.MinValue,
                                TransferType = reader["otype"] as string,
                                OrderBy = reader["Orderbyname"] as string,
                                DemandContact = reader["ordercontact"] as string,
                                DemandRemarks = reader["demandremarks"] as string,
                                OrderType = reader["DemandStatus"] as string,
                                TempOrderId = reader.GetInt32(reader.GetOrdinal("tempid")),
                                Ratetype = reader["ItemMarka"] as string,

                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }























        public async Task<CompanyModel?> GetOutwardbyAsync(int growerid)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = @"sELECT distinct g.packingorderirn ,g.tempid,g.outwardtype,g.outwardirn,g.OutwardDate,g.packingorderid,g.outwardid,
  c.partytypeid + '-' + c.partyname as PartyName,  CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,rtrim(vehno) + space(1)+'('+ rtrim(drivername)+space(1)+')'+space(1)+'('+rtrim(contactno)+')'  as vehno,CONVERT(VARCHAR(MAX), cm.id) + '-' + cm.ChallanName as ChallanName
FROM outward g
LEFT JOIN users ur on g.Createdby = ur.userid
LEFT JOIN PARTY C ON G.PARTYID = C.PARTYID
LEFT JOIN PARTYsub ps ON G.GrowerId = PS.PARTYID
left join vehinfo vi on g.Vehid= vi.vid
LEFT JOIN challanmaster cm ON  g.ChallanId= cm.Id 

where g.outwardid=@outid";
                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@outid", growerid);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                // companyModel.Growerid = reader.GetInt32(reader.GetOrdinal("id")),




                                Outwardid = reader.GetInt32(reader.GetOrdinal("outwardid")),
                                PackingOrderIrn = reader["packingorderirn"] as string,
                                Outwardtype = reader["outwardtype"] as string,
                                OutwardIrn = reader["outwardirn"] as string,
                                Packingorderid = Convert.ToInt32(reader["packingorderid"]),
                                OutwardDate = Convert.ToDateTime(reader["OutwardDate"]),
                                TempOutwardId = reader.GetInt32(reader.GetOrdinal("tempid")),
                                OutwardGrowerGroup = reader["PartyName"] as string,
                                OutwardGrowerName = reader["GrowerName"] as string,
                                ChallanName = reader["ChallanName"] as string,
                                Vehno = reader["vehno"] as string,

                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }



        public async Task<CompanyModel?> GetPackingOrderbyAsync(int growerid)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = @"sELECT distinct g.PackingOrderDate,  p.partytypeid + '-' + p.partyname AS PartyInfo,g.PackingOrderno,
     convert(varchar(max),ps.partyid)  +'-'+ ps.partyname AS GrowerInfo,
	convert(varchar(max),cm.id)  +'-'+ cm.ChallanName as ChallanName ,rtrim(vehno) + space(1)+'('+ rtrim(drivername)+space(1)+')'+space(1)+'('+rtrim(contactno)+')' as vehno,g.Packingorderno
FROM PackingOrderItems g

LEFT JOIN PARTY p ON G.PARTYID = p.PARTYID
LEFT JOIN PARTYsub ps ON G.GrowerId = PS.PARTYID
LEFT JOIN vehinfo  prt ON g.Vehid = prt.vid


LEFT JOIN challanmaster cm ON g.challanid = cm.id

where g.PackingOrderId=@outid";
                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@outid", growerid);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                // companyModel.Growerid = reader.GetInt32(reader.GetOrdinal("id")),





                                GrowerGroupName = reader["PartyInfo"] as string,
                                GrowerName = reader["GrowerInfo"] as string,
                                Vehno = reader["vehno"] as string,
                                PackingOrderDate = reader["PackingOrderDate"] as DateTime? ?? DateTime.MinValue,
                               
                                ChallanName = reader["ChallanName"] as string,
                                 PackingOrderIrn = reader["PackingOrderno"] as string,



                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }


        public async Task<CompanyModel?> GetDraftIdbyAsync(int growerid)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = @"sELECT g.DraftIrn,g.DraftDate,
  c.partytypeid + '-' + c.partyname as PartyName,g.remarks,isnull(rd.weight,0) as weight
   
FROM DraftOutTrans g
LEFT JOIN repackdraftitems rd on rd.draftid = g.draftid
LEFT JOIN users ur on g.Createdby = ur.userid
LEFT JOIN PARTY C ON G.PARTYID = C.PARTYID
LEFT JOIN PARTYsub ps ON G.GrowerId = PS.PARTYID
LEFT JOIN prodtype prt ON g.itemid = prt.id
LEFT JOIN PTYPE pt ON g.packageid = pt.id
LEFT JOIN prodqaul pq ON g.varietyid = pq.id
LEFT JOIN challanmaster cm ON g.challanid = cm.id
LEFT JOIN servicetypes st ON g.schemeid = st.id
LEFT JOIN locationFinal lf ON g.lotno = lf.lotno
where g.Draftid=@outid";
                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@outid", growerid);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                // companyModel.Growerid = reader.GetInt32(reader.GetOrdinal("id")),





                                DraftIrn = reader["DraftIrn"] as string,
                              GrowerGroupName = reader["PartyName"] as string,
                                DraftDate = Convert.ToDateTime(reader["DraftDate"]),
                                DraftWeight= Convert.ToInt32(reader["weight"]),
                                Repackremarks = reader["remarks"] as string,
                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }








        public async Task<CompanyModel?> GetPrinter(string unitname)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "SELECT name from Sprinters WHERE unitname= @Id";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@Id", unitname);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                // companyModel.Growerid = reader.GetInt32(reader.GetOrdinal("id")),




                              

                                Sprinter = reader["name"] as string,
                              


                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }













        public async Task<List<CompanyModel>> GetAgreementByGrowerId(int Growerid)
        {
            List<CompanyModel>  GetgrowerIdAgreement = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {

            
                    const string query = "select rtrim(a.partyname) as Partyname,a.MainId,AgreementiD as Id,FyeariD as Yearid,Dated,RateType,StoreRent,BinRate,Craterental,LabourRate,GradingRate,PackingRate,Qty,b.sname as Type,c.name,a.RateType,a.Investment from GrowerAgreement a,servicetypes b , prodtype c where a.service=b.id and a.itemid=c.id and a.MainId =@GrowerId";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@GrowerId", Growerid);
                con.Open();
                SqlDataReader reader = await cmd.ExecuteReaderAsync();

                while (reader.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        AgreementId = reader.GetInt32(reader.GetOrdinal("Id")),

                        Fyear = reader["Yearid"] as string,
                        Adated = reader["Dated"] as DateTime? ?? DateTime.MinValue,
                        Aqty = Convert.ToDecimal(reader["Qty"]),

                        Atype = reader["Type"] as string,

                        Itemname = reader["name"] as string,
                        RentType = reader["RateType"] as string,
                        Investmentflag = reader.GetBoolean(reader.GetOrdinal("Investment")),

                        Growerid = reader.GetInt32(reader.GetOrdinal("MainId")),
                        GrowerGroupSelectName = reader["Partyname"] as string,
                        StoreRent = Convert.ToDecimal(reader["StoreRent"]),
                        BinRent = Convert.ToDecimal(reader["BinRate"]),
                        CrateRate = Convert.ToDecimal(reader["Craterental"]),
                        LabourRate = Convert.ToDecimal(reader["LabourRate"]),
                        GradingRent = Convert.ToDecimal(reader["GradingRate"]),
                        PackingRent = Convert.ToDecimal(reader["PackingRate"]),



                    };
                    GetgrowerIdAgreement.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetgrowerIdAgreement;
        }


        public async Task<List<CompanyModel>> GetDemand(int Growerid)
        {
            List<CompanyModel> Getdemandview = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {


                const string query = @"sELECT g.DemandStatus,
    g.LOTNO,g.lotirn,g.demandirn,g.orderdate,g.deliverydate,g.ordercontact,g.demandremarks,g.otype,g.Orderbyname,
    g.VerifiedQty AS GateInQty,c.partytypeid + '-' + c.partyname as PartyName,  CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
     g.verifiedQty ,G.ORDERQTY,prt.name as itemname, pt.name as package,g.khataname,pq.name as quality,g.locationchamberid,ur.username,
	isnull(FloorName + space(1) + lf.MatrixName + lf.RowName + space(1) + lf.ColumnName, 'NA') as tlocation,g.locationchamberid as chamber,cm.ChallanName,st.sname
FROM LotOutTrans g
LEFT JOIN users ur on g.Createdby = ur.userid
LEFT JOIN PARTY C ON G.PARTYID = C.PARTYID
LEFT JOIN PARTYsub ps ON G.GrowerId = PS.PARTYID
LEFT JOIN prodtype prt ON g.itemid = prt.id
LEFT JOIN PTYPE pt ON g.packageid = pt.id
LEFT JOIN prodqaul pq ON g.varietyid = pq.id
LEFT JOIN challanmaster cm ON g.challanid = cm.id
LEFT JOIN servicetypes st ON g.schemeid = st.id
LEFT JOIN locationFinal lf ON g.lotno = lf.lotno
where g.outid=@outid
GROUP BY g.DemandStatus,g.Orderbyname,g.otype,g.demandirn,g.LOTNO, g.VerifiedQty,c.partytypeid + '-' + c.partyname,convert(varchar(max), ps.partyid) + '-' + ps.partyname,prt.name ,pt.name,g.khataname,pq.name,cm.ChallanName,st.sname,
FloorName + space(1) + lf.MatrixName + lf.RowName + space(1) + lf.ColumnName,g.locationchamberid,g.lotirn,G.ORDERQTY,ur.username,g.orderdate,g.deliverydate,g.ordercontact,g.demandremarks

ORDER BY g.LOTNO";






                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@outid", Growerid);
                con.Open();
                SqlDataReader reader = await cmd.ExecuteReaderAsync();

                while (reader.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        GrowerGroupName = reader["partyname"] as string,
                        GrowerName = reader["GrowerName"] as string,
                        LotIrn = reader["LotIrn"] as string,
                       VerfiedQty = Convert.ToInt32(reader["GateInQty"]),
                        OrderQty = Convert.ToInt32(reader["ORDERQTY"]),
                        Alotbal = Convert.ToInt32(reader["GateInQty"]) - Convert.ToInt32(reader["ORDERQTY"]),

                        ItemName = reader["itemname"].ToString(),
                        Prodetails = reader["package"].ToString(),
                        PreInwardKhata = reader["khataname"].ToString(),
                        VarietyId = reader["quality"].ToString(),
                        ChamberId = Convert.ToInt32(reader["locationchamberid"]),
                        Templocation = reader["tlocation"].ToString(),
                        ChallanName = reader["ChallanName"].ToString(),
                        ServiceId = reader["sname"].ToString(),

                    };
                    Getdemandview.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Getdemandview;
        }




        public async Task<List<CompanyModel>> GetDraft(int Growerid)
        {
            List<CompanyModel> GetDailyPreinwardtemp = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {


                const string query = @"sELECT g.id,
    g.LOTNO,g.lotirn,g.demandirn,g.orderdate,g.deliverydate,g.ordercontact,g.demandremarks,g.otype,g.Orderbyname,
    g.VerifiedQty AS GateInQty,c.partytypeid + '-' + c.partyname as PartyName,  CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
     g.verifiedQty ,G.ORDERQTY,so.orderQty as Storeout,so.orderQty as demandQty,prt.name as itemname, pt.name as package,g.khataname,pq.name as quality,g.locationchamberid,ur.username,
	isnull(FloorName + space(1) + lf.MatrixName + lf.RowName + space(1) + lf.ColumnName, 'NA') as tlocation,g.locationchamberid as chamber,cm.ChallanName,st.sname
FROM DraftOutTrans g

LEFT JOIN StoreOutTrans so on so.demandirn = g.demandirn and so.LotNo=g.lotno
LEFT JOIN LotOutTrans  lt on lt.demandirn = g.demandirn and lt.LotNo=g.lotno

LEFT JOIN users ur on g.Createdby = ur.userid
LEFT JOIN PARTY C ON G.PARTYID = C.PARTYID
LEFT JOIN PARTYsub ps ON G.GrowerId = PS.PARTYID
LEFT JOIN prodtype prt ON g.itemid = prt.id
LEFT JOIN PTYPE pt ON g.packageid = pt.id
LEFT JOIN prodqaul pq ON g.varietyid = pq.id
LEFT JOIN challanmaster cm ON g.challanid = cm.id
LEFT JOIN servicetypes st ON g.schemeid = st.id
LEFT JOIN locationFinal lf ON g.lotno = lf.lotno
where g.Draftid =@outid and  g.flagdeleted=0

ORDER BY g.LOTNO";






                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@outid", Growerid);
                con.Open();
                SqlDataReader reader = await cmd.ExecuteReaderAsync();

                while (reader.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        DraftIdentity = Convert.ToInt32(reader["id"]),
                        GrowerGroupName = reader["partyname"] as string,
                        GrowerName = reader["GrowerName"] as string,
                        LotIrn = reader["LotIrn"] as string,
                        VerfiedQty = Convert.ToInt32(reader["GateInQty"]),
                        OrderQty = Convert.ToInt32(reader["ORDERQTY"]),
                        Alotbal = Convert.ToInt32(reader["demandQty"]) ,
                        TotalStoreOut = Convert.ToInt32(reader["Storeout"]),
                        DemandIrn= reader["demandirn"] as string,
                        GrowerCombine = reader["PartyName"].ToString() + " " + reader["GrowerName"].ToString(),
                        ItemName = reader["itemname"].ToString(),
                        Prodetails = reader["package"].ToString(),
                        PreInwardKhata = reader["khataname"].ToString(),
                        VarietyId = reader["quality"].ToString(),
                        ChamberId = Convert.ToInt32(reader["locationchamberid"]),
                        Templocation = reader["tlocation"].ToString(),
                        ChallanName = reader["ChallanName"].ToString(),
                        ServiceId = reader["sname"].ToString(),

                    };
                    GetDailyPreinwardtemp.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetDailyPreinwardtemp;
        }





        public async Task<List<CompanyModel>> GetRepack(int Growerid)
        {
            List<CompanyModel> GetpackingDraft = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {


                const string query = @"sELECT g.PackingDraftitemid,
  g.palletno, g.palletIrn,pr.itemname,rp.recipename,ig.Gradename,g.Qty,g.marka,pq.name,lf.name as Location
FROM REPACKDRAFTITEMS g


LEFT JOIN users ur on g.Createdby = ur.userid
LEFT JOIN Recipe rp on g.RecipeId = rp.RecipeId
LEFT JOIN itemgrades ig ON g.gradeid = ig.id
LEFT JOIN prodqaul pq ON g.brandid = pq.id
LEFT JOIN location_master lf ON g.locationid = lf.id
LEFT JOIN purchaseitem Pr ON g.packageid = Pr.id

where g.Draftid =@outid and g.flagdeleted=0

ORDER BY g.palletno";






                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@outid", Growerid);
                con.Open();
                SqlDataReader reader = await cmd.ExecuteReaderAsync();

                while (reader.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        DraftIdentity = Convert.ToInt32(reader["PackingDraftitemid"]),
                        PalletId = Convert.ToInt32(reader["palletno"]),
                        PalletName = reader["palletIrn"] as string,
                        ReceipeName = reader["recipename"] as string,
                        ReceipeGrade = reader["Gradename"] as string,
                        ReceipeQty = Convert.ToInt32(reader["Qty"]),
                        ReceipeMarka = reader["marka"] as string,
                        VarietyId = reader["name"] as string,
                        ReceipeLocation = reader["Location"] as string,
                        BoxBrand = reader["itemname"] as string,



                    };
                    GetpackingDraft.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetpackingDraft;
        }




















        public async Task<List<CompanyModel>> GetDemandwithstore(int Growerid)
        {
            List<CompanyModel> Getdemandview = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {


                const string query = @"SELECT 
    g.DemandStatus,
    g.LOTNO,
    g.lotirn,
    g.demandirn,
    g.orderdate,
    g.deliverydate,
    g.ordercontact,
    g.demandremarks,
    g.otype,
    g.Orderbyname,
    ISNULL(SUM(df.orderQty), 0) as DraftQty,  -- Changed to SUM
    g.VerifiedQty AS GateInQty,
    ISNULL(SO.ORDERQTY, 0) AS Storeout,
    c.partytypeid + '-' + c.partyname as PartyName,  
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,
    g.verifiedQty,
    G.ORDERQTY,
    prt.name as itemname,
    pt.name as package,
    g.khataname,
    pq.name as quality,
    g.locationchamberid,
    ur.username,
    ISNULL(FloorName + space(1) + lf.MatrixName + lf.RowName + space(1) + lf.ColumnName, 'NA') as tlocation,
    g.locationchamberid as chamber,
    cm.ChallanName,
    st.sname,SO.Remarks as frem
FROM LotOutTrans g
LEFT JOIN StoreOutTrans SO ON g.lotno = SO.lotno and g.OutId = SO.OutId 
LEFT JOIN DraftOutTrans df ON g.lotno = df.lotno and df.OutId = SO.OutId 
LEFT JOIN users ur on g.Createdby = ur.userid
LEFT JOIN PARTY C ON G.PARTYID = C.PARTYID
LEFT JOIN PARTYsub ps ON G.GrowerId = PS.PARTYID
LEFT JOIN prodtype prt ON g.itemid = prt.id
LEFT JOIN PTYPE pt ON g.packageid = pt.id
LEFT JOIN prodqaul pq ON g.varietyid = pq.id
LEFT JOIN challanmaster cm ON g.challanid = cm.id
LEFT JOIN servicetypes st ON g.schemeid = st.id
LEFT JOIN locationFinal lf ON g.lotno = lf.lotno
WHERE g.outid = @outid and g.flagdeleted = 0
GROUP BY 
    g.DemandStatus,
    g.LOTNO,
SO.Remarks,
    g.lotirn,
    g.demandirn,
    g.orderdate,
    g.deliverydate,
    g.ordercontact,
    g.demandremarks,
    g.otype,
    g.Orderbyname,
    g.VerifiedQty,
    SO.ORDERQTY,
    c.partytypeid + '-' + c.partyname,
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname,
    g.verifiedQty,
    G.ORDERQTY,
    prt.name,
    pt.name,
    g.khataname,
    pq.name,
    g.locationchamberid,
    ur.username,
    ISNULL(FloorName + space(1) + lf.MatrixName + lf.RowName + space(1) + lf.ColumnName, 'NA'),
    g.locationchamberid,
    cm.ChallanName,
    st.sname
ORDER BY g.LOTNO";






                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@outid", Growerid);
                con.Open();
                SqlDataReader reader = await cmd.ExecuteReaderAsync();

                while (reader.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {

                        GrowerGroupName = reader["partyname"] as string,
                        GrowerName = reader["GrowerName"] as string,
                        LotIrn = reader["LotIrn"] as string,
                        VerfiedQty = Convert.ToInt32(reader["GateInQty"]),
                        OrderQty = Convert.ToInt32(reader["ORDERQTY"]),
                        Alotbal = Convert.ToInt32(reader["GateInQty"]) - Convert.ToInt32(reader["ORDERQTY"]),
                        Lotno = Convert.ToInt32(reader["LOTNO"]),
                        PreStoreOut = Convert.ToInt32(reader["Storeout"]),
                        ItemName = reader["itemname"].ToString(),

                        ForceRemarks = reader["frem"].ToString(),

                        Prodetails = reader["package"].ToString(),
                        PreInwardKhata = reader["khataname"].ToString(),
                        VarietyId = reader["quality"].ToString(),
                        ChamberId = Convert.ToInt32(reader["locationchamberid"]),
                        Templocation = reader["tlocation"].ToString(),
                        ChallanName = reader["ChallanName"].ToString(),
                        ServiceId = reader["sname"].ToString(),
                        DraftedQty = Convert.ToInt32(reader["DraftQty"]),
                    };
                    Getdemandview.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return Getdemandview;
        }


        public async Task<List<CompanyModel>> GetLedgerDetailsNew(int Partyid)
        {
            List<CompanyModel> banks = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {


                const string query = @"SELECT 
    t.tid AS id,
    t.tdate,
    t.Remarks,
    t.ptype,
    vg.Mastername AS VoucherType,
    dp.[type] + '-' + dp.partytypeid + '-' + dp.partyname AS DebitPartyName,
    cp.[type] + '-' + cp.partytypeid + '-' + cp.partyname AS CreditPartyName,
    t.remarks,
    isnull(t.Debit,0) as Debit,
    ISNULL(t.Credit, 0) AS Credit,

    -- Calculate running total
    abs(SUM(ISNULL(t.Debit, 0) - ISNULL(t.Credit, 0)) OVER (ORDER BY t.tid ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)) AS RunningTotal,

    -- Determine type based on running total
    CASE 
        WHEN SUM(ISNULL(t.Debit, 0) - ISNULL(t.Credit, 0)) OVER (ORDER BY t.tid ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) >= 0 THEN 'Dr'
        ELSE 'Cr'
    END AS Type

FROM Transactions t
LEFT JOIN party dp ON t.debitpartyid = dp.idno
LEFT JOIN party cp ON t.creditpartyid = cp.idno
LEFT JOIN vouchergroup vg ON t.Ttype = vg.id
WHERE t.id = @Partyid AND t.flagdeleted = 0
ORDER BY t.tid desc";


                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@Partyid", Partyid);
                con.Open();
                SqlDataReader rdr = await cmd.ExecuteReaderAsync();

                while (rdr.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        TransactionId = Convert.ToInt32(rdr["id"]),
                        TransactionCredit = rdr["CreditPartyName"].ToString(),
                        TransactionDebit = rdr["DebitPartyName"].ToString(),
                        TransactionType = rdr["VoucherType"].ToString(),
                        TransactionRemarks = rdr["Remarks"].ToString(),
                        TransactionPaymentType = rdr["ptype"].ToString(),
                        TransactionDated = rdr["tdate"] as DateTime? ?? DateTime.MinValue,
                        TransactionRunning = rdr.GetDecimal(rdr.GetOrdinal("RunningTotal")),
                        TransactionDebitAmt = rdr.GetDecimal(rdr.GetOrdinal("Debit")),
                        TransactionCreditAmt = rdr.GetDecimal(rdr.GetOrdinal("Credit")),
                        BalanceType = rdr["Type"].ToString()


                    };
                    banks.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return banks;
        }

        public async Task<CompanyModel> GetLedgerSum(int Partyid)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                const string query = @"SELECT  dp.[type] + '-' + dp.partytypeid + '-' + dp.partyname AS DebitPartyName,
    CAST(ISNULL(SUM(Debit), 0) AS VARCHAR) AS TotalDebit,
    CAST(ISNULL(SUM(Credit), 0) AS VARCHAR) AS TotalCredit,
    CAST(ABS(ISNULL(SUM(Debit), 0) - ISNULL(SUM(Credit), 0)) AS VARCHAR)
        + ' ' +
    CASE 
        WHEN ISNULL(SUM(Debit), 0) - ISNULL(SUM(Credit), 0) >= 0 THEN 'Dr'
        ELSE 'Cr'
    END AS NetBalanceWithType
FROM Transactions a,party dp where a.id=dp.idno
and id = @Partyid group by  dp.[type] + '-' + dp.partytypeid + '-' + dp.partyname";


                using (var cmd = new SqlCommand(query, con))
                {
                    cmd.Parameters.AddWithValue("@Partyid", Partyid);

                    using (var rdr = await cmd.ExecuteReaderAsync())
                    {
                        if (await rdr.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                TransactionName= rdr["DebitPartyName"].ToString(),
                                TotalDebit = rdr["TotalDebit"].ToString(),
                                TotalCredit = rdr["TotalCredit"].ToString(),
                                TotalBalance = rdr["NetBalanceWithType"].ToString()



















                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }















       








        public async Task<List<CompanyModel>> GetAgreementByGrower(string GrowerGroupSelectName)
        {
            List<CompanyModel> GrowerAgreementList = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select AgreementiD as Id,FyeariD as Yearid,Dated,Qty,b.sname as Type,c.name,a.RateType,a.Investment from GrowerAgreement a,servicetypes b , prodtype c where a.service=b.id and a.itemid=c.id and a.MainId in(select partycode from party where partytypeid+'-'+rtrim(partyname)=@GrowerGrp)";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@GrowerGrp", GrowerGroupSelectName);
                con.Open();
                SqlDataReader reader = await cmd.ExecuteReaderAsync();

                while (reader.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        AgreementId = reader.GetInt32(reader.GetOrdinal("Id")),

                        Fyear = reader["Yearid"] as string,
                        Adated = reader["Dated"] as DateTime? ?? DateTime.MinValue,
                        Aqty = Convert.ToDecimal(reader["Qty"]),

                        Atype = reader["Type"] as string,

                        Itemname = reader["name"] as string,
                        RentType = reader["RateType"] as string,
                        Investmentflag = reader.GetBoolean(reader.GetOrdinal("Investment")),
                        



                    };
                    GrowerAgreementList.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GrowerAgreementList;
        }



      
























        public async Task<List<CompanyModel>> GetPurchaseOrder(int selectedGrowerId)
        {
            List<CompanyModel> GetOrderDetails = new List<CompanyModel>();

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                const string query = "select a.idno,OrderId,b.itemname,a.OtherDet,a.status,A.qty from PurchaseOrderDetails a,masteritems b where a.itemid=b.itemid and a.flagdeleted=0 and a.Orderid=@orderid";
                SqlCommand cmd = new SqlCommand(query, con)
                {
                    CommandType = CommandType.Text
                };
                cmd.Parameters.AddWithValue("@orderid", selectedGrowerId);
                con.Open();
                SqlDataReader reader = await cmd.ExecuteReaderAsync();

                while (reader.Read())
                {
                    CompanyModel companyModel = new CompanyModel
                    {
                        PurchaseOrderItemId = reader.GetInt32(reader.GetOrdinal("idno")),
                        PurchaseOrderId = reader.GetInt32(reader.GetOrdinal("OrderId")),
                        PurchaseItemName = reader["itemname"] as string ,
                        PurchaseOrderItemDescrip = reader["OtherDet"] as string,
                        PurchaseOrderStatus = reader["status"] as string,

                        PurchaseOrderqty = reader.GetDecimal(reader.GetOrdinal("qty")),
                        


                    };
                    GetOrderDetails.Add(companyModel);
                }
                con.Close();
                cmd.Dispose();
            }
            return GetOrderDetails;
        }


        public async Task<CompanyModel?> GetPurchaseOrderDet(int selectedGrowerId, int selectedItemid)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = @"SELECT 
    a.idno,
    a.OrderId,
    b.itemname,
    a.OtherDet,
    a.status,
    a.qty,
    pg.mastername
FROM 
    PurchaseOrderDetails a
INNER JOIN 
    masteritems b ON a.itemid = b.itemid
INNER JOIN 
    purchasegroup pg ON a.PurchaseGroupid = pg.id
WHERE a.flagdeleted=0 and
    a.OrderId = @orderid and a.idno=@itemid;
";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@orderid", selectedGrowerId);
                    cmd.Parameters.AddWithValue("@itemid", selectedItemid);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                // companyModel.Growerid = reader.GetInt32(reader.GetOrdinal("id")),




                        PurchaseOrderItemId = reader.GetInt32(reader.GetOrdinal("idno")),
                        PurchaseOrderId = reader.GetInt32(reader.GetOrdinal("OrderId")),
                        PurchaseItemName = reader["itemname"] as string,
                        PurchaseOrderItemDescrip = reader["OtherDet"] as string,
                        PurchaseOrderStatus = reader["status"] as string,

                        PurchaseOrderqty = reader.GetDecimal(reader.GetOrdinal("qty")),
                        PurchGrp = reader["mastername"] as string,




                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }



        public async Task<CompanyModel?> GetCrateIssueDet(int selectedGrowerId)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();
                //convert(varchar(max), ps.partyid) + '-' +
                var sql = @"SELECT
    ci.cid,
    ci.Dated,
	p.partytypeid  +'-'+ p.partyname AS PartyName,
   convert(varchar(max),ps.partyid)  +'-'+ ps.partyname  AS GrowerName,
    convert(varchar(max),cm.id)  +'-'+ cm.ChallanName as challanname,
   rtrim(vi.vehno) + space(1)+'('+ rtrim(vi.drivername)+space(1)+')'+space(1)+'('+rtrim(vi.contactno)+')' as vehno,

	ci.CrateMark,
    ci.qty,
    ci.trflag,
ci.Remarks
FROM crateissue ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.groowerid = ps.partyid
LEFT JOIN challanmaster cm ON ci.challanid = cm.id         
LEFT JOIN vehinfo vi ON ci.vehid = vi.vid
WHERE ci.cid=@orderid ";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@orderid", selectedGrowerId);
                  
                    using (var rdr = await cmd.ExecuteReaderAsync())
                    {
                        if (await rdr.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                // companyModel.Growerid = reader.GetInt32(reader.GetOrdinal("id")),




                                CrissueId = Convert.ToInt32(rdr["cid"]),
                                GrowerGroupName = rdr["PartyName"].ToString(),
                                GrowerName = rdr["GrowerName"].ToString(),
                                ChallanName = rdr["challanname"].ToString(),
                                Vehno = rdr["vehno"].ToString(),
                                CrissueMark = rdr["CrateMark"].ToString(),
                                CrissueQty = Convert.ToDecimal(rdr["qty"]),
                                CrateIssueDated = Convert.ToDateTime(rdr["Dated"]),
                                CrissueFlag = rdr["trflag"].ToString(),
                                CrissueRemarks = rdr["Remarks"].ToString()




                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }


        public async Task<CompanyModel?> GetCrateIssueDetAdj(int selectedGrowerId)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();
                //convert(varchar(max), ps.partyid) + '-' +
                var sql = @"SELECT 
    ca.Trno,ca.dated,ca.cid,
    p_from.partytypeid  +'-'+  p_from.partyname AS PartyName, -- Party name for partyid
    p_to.partytypeid  +'-'+ p_to.partyname AS transferGroupName,    -- Party name for partyidto
   convert(varchar(max), ps_groower.partyid)  +'-'+ ps_groower.partyname AS GrowerName, -- Partysub name for groowerid
  
	   convert(varchar(max), ps_grower_to.partyid)  +'-'+ ps_grower_to.partyname AS TransferGrowerName
	
	
	,ca.remarks,ca.qty
FROM 
    crateadjustment ca
-- Join to get party names for partyid and partyidto
LEFT JOIN party p_from ON ca.partyid = p_from.partyid
LEFT JOIN party p_to ON ca.partyidto = p_to.partyid
-- Join to get partysub names for groowerid and groweridto
LEFT JOIN partysub ps_groower ON ca.groowerid = ps_groower.partyid
LEFT JOIN partysub ps_grower_to ON ca.groweridto = ps_grower_to.partyid
WHERE ca.cid=@orderid";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@orderid", selectedGrowerId);

                    using (var rdr = await cmd.ExecuteReaderAsync())
                    {
                        if (await rdr.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                // companyModel.Growerid = reader.GetInt32(reader.GetOrdinal("id")),


                                CrissueId = Convert.ToInt32(rdr["cid"]),
                                CrateIssueDated = Convert.ToDateTime(rdr["dated"]),

                                GrowerGroupName = rdr["PartyName"].ToString(),
                                GrowerName = rdr["GrowerName"].ToString(),
                                CrTransferGrowerGroup = rdr["transferGroupName"].ToString(),
                                CrTransferGrower = rdr["TransferGrowerName"].ToString(),


                                CrissueQty = Convert.ToDecimal(rdr["qty"]),

                                CrissueRemarks = rdr["Remarks"].ToString(),
                                CrateCrn = rdr["Trno"].ToString(),





                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }





        public async Task<CompanyModel?> GetSlotdet(int selectedGrowerId)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();
                //convert(varchar(max), ps.partyid) + '-' +
                const string  sql = @"SELECT
      ci.sdate,p.partytypeid + '-' + p.partyname AS PartyName,
    CONVERT(varchar(max), ps.partyid) + '-' + ps.partyname AS GrowerName,ci.sdate,ci.Qty, ttime,ci.contact,ci.id
    
FROM Grading_calendar ci
LEFT JOIN party p ON ci.partyid = p.partyid
LEFT JOIN partysub ps ON ci.growerid = ps.partyid

WHERE 
 ci.id=@orderid and ci.flagdeleted=0

ORDER BY id";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@orderid", selectedGrowerId);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                // companyModel.Growerid = reader.GetInt32(reader.GetOrdinal("id")),

                                Slotno = reader.IsDBNull(reader.GetOrdinal("id")) ? 0 : reader.GetInt32(reader.GetOrdinal("id")),

                                calendardate = reader["sdate"] as DateTime? ?? DateTime.MinValue,
                                GrowerGroupName = reader["PartyName"] as string,
                                GrowerName = reader["GrowerName"] as string,
                                
                                SlotQty = reader.IsDBNull(reader.GetOrdinal("Qty")) ? 0 : reader.GetInt32(reader.GetOrdinal("Qty")),
                                GrowerContact = reader["contact"] as string,

                                calendartime = reader["ttime"] as DateTime? ?? DateTime.MinValue,





                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }












        public async Task<CompanyModel?> GetSubGrowerIdAsync(int SubGrowerId)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "SELECT b.partytypeid+'-'+ rtrim(b.partyname) as Groupname,a.* FROM partysub a,party b where a.Mainid=b.partycode and a.type='C' AND  a.flagdeleted = 0 and  a.partycode = @Id";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@Id", SubGrowerId);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                // companyModel.Growerid = reader.GetInt32(reader.GetOrdinal("id")),




                                 SubGrowerId = reader.GetInt32(reader.GetOrdinal("partycode")),

                                GrowerGroupName = reader["Groupname"] as string,
                                GrowerName = reader["GrowerName"] as string,
                                GrowerAddress = reader["address"] as string,
                                GrowerCity = reader["city"] as string,
                                GrowerPincode = reader["pincode"] as string,
                                GrowerState = reader["state"] as string,
                                GrowerStatecode = reader["statecode"] as string,
                                GrowerEmail = reader["email"] as string,
                                GrowerContact = reader["phone"] as string,
                                GrowerGst = reader["GSTNo"] as string,
                                GrowerPan = reader["panno"] as string,
                                GrowerRemarks = reader["remarks"] as string,
                                GrowerCrateissue = reader.GetDecimal(reader.GetOrdinal("CrateQtyLimit")),
                                GrowerCratelimit = reader.GetDecimal(reader.GetOrdinal("CrateIssueLimitPer")),
                                GrowerGrace = reader["greaseperiod"] as string,
                                GrowerCountry = reader["country"] as string,
                                GrowerVillage = reader["village"] as string,
                                GrowerRetLock = Convert.ToBoolean(reader["islock"]),
                                GrowerRetFlexi = Convert.ToBoolean(reader["IsFlexibleChamber"]),


                                GrowerRetAcitve = Convert.ToBoolean(reader["Status"])




                                //Gst = reader["gst"] as string,
                                //Regno = reader["regno"] as string,
                                //Pan = reader["pan"] as string,
                                //Website = reader["website"] as string,
                                //Caddress = reader["addr"] as string,

                                //City = reader["city"] as string,
                                //Phone = reader["Contact1"] as string,
                                //Mobile = reader["Contact1"] as string,
                                //State = reader["State"] as string,
                                //Pincode = reader["Pincode"] as string,
                                //Email = reader["email"] as string




                                // Map other columns as needed
                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }


        public async Task<CompanyModel?> GetGroupName(int GrowerId)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                const string query = "select  partytypeid  +'-'+ partyname as Grpname, rtrim(partyname) as Partyname,status,islock,IsFlexibleChamber from Party  where TYPE='C' AND partycode=@GrowerId";
                using (var cmd = new SqlCommand(query, con))
                {
                    cmd.Parameters.AddWithValue("@GrowerId", GrowerId);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                // companyModel.Growerid = reader.GetInt32(reader.GetOrdinal("id")),



                                GrowerGroupSelectName = reader["Partyname"] as string,
                                GrowerRetLock = Convert.ToBoolean(reader["islock"]),
                                GrowerRetFlexi = Convert.ToBoolean(reader["IsFlexibleChamber"]),
                                GrowerGroupName = reader["Grpname"] as string,


                                GrowerRetAcitve = Convert.ToBoolean(reader["Status"])




                                //Gst = reader["gst"] as string,
                                //Regno = reader["regno"] as string,
                                //Pan = reader["pan"] as string,
                                //Website = reader["website"] as string,
                                //Caddress = reader["addr"] as string,

                                //City = reader["city"] as string,
                                //Phone = reader["Contact1"] as string,
                                //Mobile = reader["Contact1"] as string,
                                //State = reader["State"] as string,
                                //Pincode = reader["Pincode"] as string,
                                //Email = reader["email"] as string




                                // Map other columns as needed
                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }

        public async Task<CompanyModel?> CheckPurchaseOrder(int selectedGrowerId)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                const string query = "select status from PurchaseOrder  where orderid=@GrowerId";
                using (var cmd = new SqlCommand(query, con))
                {
                    cmd.Parameters.AddWithValue("@GrowerId", selectedGrowerId);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                // companyModel.Growerid = reader.GetInt32(reader.GetOrdinal("id")),



                                PurchaseOrderStatus = reader["status"] as string,
                            





                                // Map other columns as needed
                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }



        public async Task<List<CompanyModel>> CheckCratesParty(string selectedPurchase)


        {
            List<CompanyModel> GetCrateAnalysis = new List<CompanyModel>();
            CompanyModel? companyModel = null;
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("CheckCratesParty", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@partyname", selectedPurchase);

                    await cmd.ExecuteNonQueryAsync();
                }



                using (SqlCommand cmd2 = new SqlCommand("select partyid,agreement,crateissue,CrateReceive,EmptyReceive,availqty as Available,partypending from CrateAnalysis", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                            companyModel = new CompanyModel
                            {
                                CrateAgreement = rdr.GetDecimal(rdr.GetOrdinal("agreement")),
                                CrateIssue = rdr.GetDecimal(rdr.GetOrdinal("crateissue")),
                                CrateReceive = rdr.GetDecimal(rdr.GetOrdinal("CrateReceive")),
                                EmptyReceive = rdr.GetDecimal(rdr.GetOrdinal("EmptyReceive")),
                                CrateAvailable = rdr.GetDecimal(rdr.GetOrdinal("Available")),
                                PartyPending = rdr.GetDecimal(rdr.GetOrdinal("partypending"))

                            };
                        GetCrateAnalysis.Add(companyModel);
                    }
                    con.Close();
                    cmd2.Dispose();
                }
                return GetCrateAnalysis;
            }
        }
       // CheckCratesAgreementonVqty
        public async Task<List<CompanyModel>> CheckCratesAgreement(string selectedPurchase)


        {
            List<CompanyModel> GetCrateAnalysis = new List<CompanyModel>();
            CompanyModel? companyModel = null;
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("CheckCratesAgreement", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@partyname", selectedPurchase);

                    await cmd.ExecuteNonQueryAsync();
                }



                using (SqlCommand cmd2 = new SqlCommand("select partyid,isnull(sum(AgreeQty),0)-isnull(sum(receiveQty),0) as Bookqty from CHECKCRATEQTY group by partyid", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                            companyModel = new CompanyModel
                            {
                                PrebookQty = rdr.GetDecimal(rdr.GetOrdinal("Bookqty")),
                                

                            };
                        GetCrateAnalysis.Add(companyModel);
                    }
                    con.Close();
                    cmd2.Dispose();
                }
                return GetCrateAnalysis;
            }
        }

        public async Task<List<CompanyModel>> CheckCratesAgreementonVqty(string selectedPurchase)


        {
            List<CompanyModel> GetCrateAnalysis = new List<CompanyModel>();
            CompanyModel? companyModel = null;
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("CheckCratesAgreementvqty", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@partyname", selectedPurchase);

                    await cmd.ExecuteNonQueryAsync();
                }



                using (SqlCommand cmd2 = new SqlCommand("select partyid,isnull(sum(AgreeQty),0)-isnull(sum(receiveQty),0) as Bookqty from CHECKCRATEQTY group by partyid", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                            companyModel = new CompanyModel
                            {
                                PrebookQty = rdr.GetDecimal(rdr.GetOrdinal("Bookqty")),


                            };
                        GetCrateAnalysis.Add(companyModel);
                    }
                    con.Close();
                    cmd2.Dispose();
                }
                return GetCrateAnalysis;
            }
        }



        public async Task<List<CompanyModel>> CheckChamberStatus(string selectedPurchase)


        {
            List<CompanyModel> GetchamberAnalysis = new List<CompanyModel>();
            CompanyModel? companyModel = null;
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("CheckChamberStatus", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@partyname", selectedPurchase);

                    await cmd.ExecuteNonQueryAsync();
                }



                using (SqlCommand cmd2 = new SqlCommand("select ChamberId,isnull(sum(AllotedQty),0)-isnull(sum(InQty),0) as ChamberQty from allotedQty group by ChamberId", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                            companyModel = new CompanyModel
                            {
                                ChamberAvailQty = rdr.GetDecimal(rdr.GetOrdinal("ChamberQty")),
                                ChamberId = rdr.GetInt32(rdr.GetOrdinal("ChamberId")),


                            };
                        GetchamberAnalysis.Add(companyModel);
                    }
                    con.Close();
                    cmd2.Dispose();
                }
                return GetchamberAnalysis;
            }
        }
























        public async Task<List<CompanyModel>> CheckChamberQty(string selectedPurchase,int chamberid)


        {
            List<CompanyModel> GetchamberAnalysis = new List<CompanyModel>();
            CompanyModel? companyModel = null;
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("CheckChamberQty", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@partyname", selectedPurchase);
                    cmd.Parameters.AddWithValue("@chamber", chamberid);

                    await cmd.ExecuteNonQueryAsync();
                }



                using (SqlCommand cmd2 = new SqlCommand("select ChamberId,isnull(sum(AllotedQty),0)-isnull(sum(InQty),0) as ChamberQty from allotedQty group by ChamberId", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                            companyModel = new CompanyModel
                            {
                                ChamberAvailQty = rdr.GetDecimal(rdr.GetOrdinal("ChamberQty")),
                                ChamberId = rdr.GetInt32(rdr.GetOrdinal("ChamberId")),


                            };
                        GetchamberAnalysis.Add(companyModel);
                    }
                    con.Close();
                    cmd2.Dispose();
                }
                return GetchamberAnalysis;
            }
        }




        public async Task<List<CompanyModel>> CheckChamber(int selectedNewchamber)


        {
            List<CompanyModel> GetchamberAnalysis = new List<CompanyModel>();
            CompanyModel? companyModel = null;
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("CheckChamber", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@chamber", selectedNewchamber);

                    await cmd.ExecuteNonQueryAsync();
                }



                using (SqlCommand cmd2 = new SqlCommand("select ChamberId,isnull(sum(AllotedQty),0)-isnull(sum(InQty),0) as ChamberQty from allotedQty group by ChamberId", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                            companyModel = new CompanyModel
                            {
                                ChamberAvailQty = rdr.GetDecimal(rdr.GetOrdinal("ChamberQty")),
                                ChamberId = rdr.GetInt32(rdr.GetOrdinal("ChamberId")),


                            };
                        GetchamberAnalysis.Add(companyModel);
                    }
                    con.Close();
                    cmd2.Dispose();
                }
                return GetchamberAnalysis;
            }
        }


        public async Task<List<CompanyModel>> CheckCratesPartyOut(string selectedPurchase,string selectedflag)


        {
            List<CompanyModel> GetCrateAnalysis = new List<CompanyModel>();
            CompanyModel? companyModel = null;
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("CheckCratesPartyout", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@partyname", selectedPurchase);
                    cmd.Parameters.AddWithValue("@trflag", selectedflag);

                    await cmd.ExecuteNonQueryAsync();
                }



                using (SqlCommand cmd2 = new SqlCommand("SELECT partyid ,AGREEMENT,CrateReceive+PettyReceive AS Receive ,GrowerReturn+PettyReturn as returned,((CrateReceive+PettyReceive)-(GrowerReturn+PettyReturn)) as Balance FROM CrateAnalysis ", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                            companyModel = new CompanyModel
                            {
                                CrateAgreement = rdr.GetDecimal(rdr.GetOrdinal("agreement")),
                                CrateIssue = 0,
                                CrateReceive = rdr.GetDecimal(rdr.GetOrdinal("Receive")),
                                EmptyReceive = rdr.GetDecimal(rdr.GetOrdinal("returned")),
                                CrateAvailable = rdr.GetDecimal(rdr.GetOrdinal("Balance"))

                            };
                        GetCrateAnalysis.Add(companyModel);
                    }
                    con.Close();
                    cmd2.Dispose();
                }
                return GetCrateAnalysis;
            }
        }
















        public async Task<List<CompanyModel>> CheckCratesPartyEmpty(string selectedPurchase)



        {
            List<CompanyModel> GetCrateAnalysis = new List<CompanyModel>();
            CompanyModel? companyModel = null;
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("CheckCratesParty", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@partyname", selectedPurchase);

                    await cmd.ExecuteNonQueryAsync();
                }



                using (SqlCommand cmd2 = new SqlCommand("select partyid,agreement,crateissue,CrateReceive,EmptyReceive,agreement-(agreement-(Crateissue -(CrateReceive+EmptyReceive))) as Available from CrateAnalysis", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                            companyModel = new CompanyModel
                            {
                                CrateAgreement = rdr.GetDecimal(rdr.GetOrdinal("agreement")),
                                CrateIssue = rdr.GetDecimal(rdr.GetOrdinal("crateissue")),
                                CrateReceive = rdr.GetDecimal(rdr.GetOrdinal("CrateReceive")),
                                EmptyReceive = rdr.GetDecimal(rdr.GetOrdinal("EmptyReceive")),
                                CrateAvailable = rdr.GetDecimal(rdr.GetOrdinal("Available"))

                            };
                        GetCrateAnalysis.Add(companyModel);
                    }
                    con.Close();
                    cmd2.Dispose();
                }
                return GetCrateAnalysis;
            }
        }

        public async Task<List<CompanyModel>> CheckCratesPartysub(string selectedPurchase, string SelectedSubgrower)


        {
            List<CompanyModel> GetCrateAnalysis = new List<CompanyModel>();
            CompanyModel? companyModel = null;
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("CheckCratesPartysub", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@partyname", selectedPurchase);
                    cmd.Parameters.AddWithValue("@growername", SelectedSubgrower);

                    await cmd.ExecuteNonQueryAsync();
                }



                using (SqlCommand cmd2 = new SqlCommand("select partyid,agreement,crateissue,CrateReceive,EmptyReceive,availqty as Available,growerpending from CrateAnalysis", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                            companyModel = new CompanyModel
                            {
                                CrateAgreement = rdr.GetDecimal(rdr.GetOrdinal("agreement")),
                                CrateIssue = rdr.GetDecimal(rdr.GetOrdinal("crateissue")),
                                CrateReceive = rdr.GetDecimal(rdr.GetOrdinal("CrateReceive")),
                                EmptyReceive = rdr.GetDecimal(rdr.GetOrdinal("EmptyReceive")),
                                CrateAvailable = rdr.GetDecimal(rdr.GetOrdinal("Available")),
                                GrowerPending = rdr.GetDecimal(rdr.GetOrdinal("GrowerPending")),
                                
                            };
                        GetCrateAnalysis.Add(companyModel);
                    }
                    con.Close();
                    cmd2.Dispose();
                }
                return GetCrateAnalysis;
            }
        }


        public async Task<List<CompanyModel>> CheckCratesPartysubEmpty(string selectedPurchase, string SelectedSubgrower)


        {
            List<CompanyModel> GetCrateAnalysis = new List<CompanyModel>();
            CompanyModel? companyModel = null;
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("CheckCratesPartysub", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@partyname", selectedPurchase);
                    cmd.Parameters.AddWithValue("@growername", SelectedSubgrower);

                    await cmd.ExecuteNonQueryAsync();
                }



                using (SqlCommand cmd2 = new SqlCommand("select partyid,agreement,crateissue,CrateReceive,EmptyReceive,agreement-(agreement-(Crateissue -(CrateReceive+EmptyReceive))) as Available from CrateAnalysis", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                            companyModel = new CompanyModel
                            {
                                CrateAgreement = rdr.GetDecimal(rdr.GetOrdinal("agreement")),
                                CrateIssue = rdr.GetDecimal(rdr.GetOrdinal("crateissue")),
                                CrateReceive = rdr.GetDecimal(rdr.GetOrdinal("CrateReceive")),
                                EmptyReceive = rdr.GetDecimal(rdr.GetOrdinal("EmptyReceive")),
                                CrateAvailable = rdr.GetDecimal(rdr.GetOrdinal("Available"))

                            };
                        GetCrateAnalysis.Add(companyModel);
                    }
                    con.Close();
                    cmd2.Dispose();
                }
                return GetCrateAnalysis;
            }
        }


        public async Task<List<CompanyModel>> CheckCratesPartysubOut(string selectedPurchase, string SelectedSubgrower, string selectedflag)


        {
            List<CompanyModel> GetCrateAnalysis = new List<CompanyModel>();
            CompanyModel? companyModel = null;
            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                using (SqlCommand cmd = new SqlCommand("CheckCratesPartysubout", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    // Make sure there are no extra spaces in parameter names!
                    cmd.Parameters.AddWithValue("@partyname", selectedPurchase);
                    cmd.Parameters.AddWithValue("@growername", SelectedSubgrower);
                    cmd.Parameters.AddWithValue("@trflag", selectedflag);

                    await cmd.ExecuteNonQueryAsync();
                }



                using (SqlCommand cmd2 = new SqlCommand("SELECT partyid ,AGREEMENT,CrateReceive+PettyReceive AS Receive ,GrowerReturn+PettyReturn as returned,((CrateReceive+PettyReceive)-(GrowerReturn+PettyReturn)) as Balancenew FROM CrateAnalysis", con))
                {
                    using (SqlDataReader rdr = await cmd2.ExecuteReaderAsync())
                    {
                        if (rdr.Read())
                            companyModel = new CompanyModel
                            {
                                CrateAgreement = rdr.GetDecimal(rdr.GetOrdinal("AGREEMENT")),
                                CrateIssue =0,
                                CrateReceive = rdr.GetDecimal(rdr.GetOrdinal("Receive")),
                                EmptyReceive = rdr.GetDecimal(rdr.GetOrdinal("returned")),
                                CrateAvailable = rdr.GetDecimal(rdr.GetOrdinal("Balancenew"))

                            };
                        GetCrateAnalysis.Add(companyModel);
                    }
                    con.Close();
                    cmd2.Dispose();
                }
                return GetCrateAnalysis;
            }
        }




        public async Task<CompanyModel?> GetCompanyByIdAsync(int companyId)
        {
            CompanyModel? companyModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "SELECT * FROM company WHERE cid = @Id";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@Id", 1);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            companyModel = new CompanyModel
                            {
                                Id = reader.GetInt32(reader.GetOrdinal("Cid")),



                                Name = reader["Cname"] as string,
                                Gst = reader["gst"] as string,
                                Regno = reader["regno"] as string,
                                Pan = reader["pan"] as string,
                                Website = reader["website"] as string,
                                Caddress = reader["addr"] as string,

                                City = reader["city"] as string,
                                Phone = reader["Contact1"] as string,
                                Mobile = reader["Contact1"] as string,
                                State = reader["State"] as string,
                                Pincode = reader["Pincode"] as string,
                                Email = reader["email"] as string




                                // Map other columns as needed
                            };
                        }
                    }
                }
                con.Close();

            }

            return companyModel;

        }




        public async Task<CompanyModel?> GetBoxDetails(int Id)
        {
            CompanyModel? EditModel = null;

            using (SqlConnection con = new SqlConnection(_configuration.Value))
            {
                await con.OpenAsync();

                var sql = "SELECT MAX(CASE WHEN pp.packageid = 6 THEN pi.itemname END) as Boxname,MAX(CASE WHEN pp.packageid = 7 THEN pi.itemname END) as Hcasename FROM packingOrderPackage pp LEFT JOIN purchaseitem pi ON pp.pid = pi.id WHERE pp.packingorderid=@Id and   pp.packageid IN (6, 7);";

                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@Id", Id);

                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            EditModel = new CompanyModel
                            {
                               

                                HcaseName = reader["Hcasename"] as string,
                                BoxName = reader["Boxname"] as string,
                               




                                // Map other columns as needed
                            };
                        }
                    }
                }
                con.Close();

            }

            return EditModel;

        }


































    }
}
