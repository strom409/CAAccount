@page "/PackingDraftReceipe/{Demandid:int}"
@inject ProtectedLocalStorage ProtectedLocalStore
@using Microsoft.AspNetCore.Components.Web
@using System.IO
@inject EmployeeAdoNetService EmployeeService
@using BlazorDemo.Pages.Definitions;
@using BlazorDemo.Services;
@using BlazorDemo;
@using System.Text.RegularExpressions
@inject UserSessionService UserSessionService
@inject IJSRuntime JS
@inject NavigationManager NavigationManager
<link href="_content/DevExpress.Blazor.Themes/blazing-berry.bs5.min.css" rel="stylesheet" />
<link rel="stylesheet" href="_content/DevExpress.Blazor.Reporting.Viewer/css/dx-blazor-reporting-components.bs5.css">
<PageTitle>Packing Draft Receipe</PageTitle>

<!-- ADAPTIVE RESPONSIVE STYLES -->
<style>
    /* ============================================
       BASE STYLES - Mobile First
       ============================================ */
    
    * {
        box-sizing: border-box;
    }

    /* Container adjustments */
    .container-fluid {
        padding-left: 10px;
        padding-right: 10px;
    }

    /* Responsive page header */
    .page-header {
        background-color: #F9F9F9;
        padding: 12px 10px;
        margin-bottom: 15px;
    }

    .page-header h6 {
        font-size: 16px;
        margin: 0;
        word-break: break-word;
    }

    /* ADAPTIVE BUTTON STYLING */
    .adaptive-button-container {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }

    /* Mobile: Full width buttons */
    .adaptive-btn {
        min-width: 44px;
        min-height: 44px;
        padding: 8px 16px;
        font-size: 14px;
        flex: 1 1 auto;
    }

    /* Responsive card styling */
    .card {
        margin-bottom: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .card.p-3 {
        padding: 12px !important;
    }

    /* Mobile-friendly form groups */
    .form-group-mobile {
        margin-bottom: 15px;
    }

    .form-group-mobile label {
        display: block;
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 14px;
    }

    .form-group-mobile input,
    .form-group-mobile select,
    .form-group-mobile .form-control {
        width: 100%;
        min-height: 44px;
        font-size: 16px;
        padding: 10px;
    }

    /* Crate Analysis - Responsive Cards */
    .crate-analysis-card {
        background: #fff;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .crate-analysis-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
    }

    .crate-stat {
        text-align: center;
    }

    .crate-stat label {
        display: block;
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
    }

    .crate-stat input {
        width: 100%;
        text-align: center;
        font-weight: bold;
        color: red;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 8px;
        font-size: 14px;
    }

    /* Grid Wrapper - Horizontal Scroll on Mobile */
    .grid-wrapper {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin-bottom: 20px;
    }

    .grid-wrapper::-webkit-scrollbar {
        height: 8px;
    }

    .grid-wrapper::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    .grid-wrapper .dxbl-grid {
        min-width: 600px;
    }

    /* Action buttons in grid */
    .grid-action-btn {
        display: inline-block;
        min-width: 44px;
        min-height: 44px;
        padding: 10px;
        text-align: center;
        color: inherit;
        text-decoration: none;
    }

    /* Modal improvements for mobile */
    .modal-dialog {
        margin: 10px;
        max-width: calc(100% - 20px);
    }

    .modal-content {
        border-radius: 8px;
    }

    .modal-header {
        padding: 15px;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    .modal-title {
        font-size: 18px;
        font-weight: 600;
    }

    .modal-body {
        padding: 15px;
        max-height: calc(100vh - 200px);
        overflow-y: auto;
    }

    .modal-footer {
        padding: 15px;
        gap: 10px;
    }

    /* Popup improvements */
    .dxbl-popup {
        max-width: calc(100vw - 20px) !important;
        margin: 10px !important;
    }

    /* Adaptive button pair */
    .button-pair {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }

    /* Zebra table styling */
    .zebra-table {
        width: 100%;
        border-collapse: collapse;
    }

    .zebra-table tbody tr:nth-child(odd) {
        background-color: white;
    }

    .zebra-table tbody tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    .zebra-table th,
    .zebra-table td {
        padding: 10px;
        text-align: left;
        font-size: 14px;
    }

    /* Icon buttons - Adaptive sizing */
    .icon-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 44px;
        min-height: 44px;
        padding: 10px;
        border: none;
        border-radius: 4px;
        background: #444;
        color: white;
        cursor: pointer;
    }

    .icon-btn i {
        font-size: 18px;
    }

    /* Alternative row styling */
    .alt-item {
        background-color: rgba(243, 244, 245, 1) !important;
    }

    .alt-item > td {
        --dxbl-grid-bg: rgba(243, 244, 245, 1) !important;
        background-color: rgba(243, 244, 245, 1) !important;
    }

    /* Green header grid styling */
    .green-header-grid .dxbl-grid-header {
        background-color: #F3F4F5 !important;
        color: black !important;
    }

    .green-header-grid .dxbl-grid-header-cell {
        background-color: #F3F4F5 !important;
        color: black !important;
    }

    /* Touch-friendly checkbox */
    input[type="checkbox"] {
        min-width: 24px;
        min-height: 24px;
        cursor: pointer;
    }

    /* Custom input height */
    .custom-input-height input {
        height: 44px !important;
        font-size: 16px;
        padding: 10px;
        box-sizing: border-box;
    }

    /* ============================================
       RESPONSIVE BREAKPOINTS
       ============================================ */

   
    @@media (max-width: 575px) {
        .page-header h6 {
            font-size: 14px;
        }

        .card.p-3 {
            padding: 10px !important;
        }

        .crate-analysis-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .row > [class*="col-"] {
            width: 100%;
            margin-bottom: 10px;
        }

        /* Full width buttons on small screens */
        .adaptive-button-container {
            flex-direction: column;
        }

        .adaptive-btn {
            width: 100%;
        }

        .button-pair .btn,
        .button-pair button {
            padding: 10px;
        }

        body {
            font-size: 14px;
        }

        input, select, textarea {
            font-size: 16px !important;
        }

        .dxbl-grid-data-column {
            padding: 5px !important;
        }
    }

    /* Medium phones (576px - 767px) */
    @@media (min-width: 576px) and (max-width: 767px) {
        .crate-analysis-grid {
            grid-template-columns: repeat(3, 1fr);
        }

        .row.g-3 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        /* Still fairly large buttons for medium phones */
        .adaptive-btn {
            min-width: 80px;
        }
    }

    /* Tablets (768px - 991px) - Start normalizing button sizes */
    @@media (min-width: 768px) {
        .crate-analysis-grid {
            grid-template-columns: repeat(4, 1fr);
        }

        .grid-wrapper .dxbl-grid {
            min-width: auto;
        }

        /* Normal button sizing starts here */
        .adaptive-btn {
            flex: 0 0 auto;
            min-width: auto;
            width: auto;
            padding: 8px 16px;
        }

        .adaptive-button-container {
            flex-direction: row;
        }

        /* Normal sized buttons in forms */
        .button-pair .btn,
        .button-pair button {
            padding: 6px 12px;
            font-size: 14px;
        }

        /* Form inputs can be slightly smaller */
        .form-group-mobile input,
        .form-group-mobile select,
        .form-group-mobile .form-control {
            min-height: 38px;
            font-size: 14px;
            padding: 6px 12px;
        }

        /* Icon buttons normal size */
        .icon-btn {
            min-width: 36px;
            min-height: 36px;
            padding: 8px;
        }

        .icon-btn i {
            font-size: 16px;
        }
    }

    /* Desktop (992px+) - Full desktop experience */
    @@media (min-width: 992px) {
        .container-fluid {
            padding-left: 15px;
            padding-right: 15px;
        }

        .crate-analysis-grid {
            grid-template-columns: repeat(7, 1fr);
        }

        /* Standard desktop button sizing */
        .adaptive-btn {
            padding: 6px 12px;
            font-size: 14px;
            min-height: 38px;
        }

        /* Standard form controls */
        .form-group-mobile input,
        .form-group-mobile select,
        .form-group-mobile .form-control {
            min-height: 38px;
            font-size: 14px;
        }

        /* Grid action buttons - standard size */
        .grid-action-btn {
            min-width: 36px;
            min-height: 36px;
            padding: 8px;
        }

        /* Icon buttons - standard desktop size */
        .icon-btn {
            min-width: 32px;
            min-height: 32px;
            padding: 6px;
        }

        .icon-btn i {
            font-size: 14px;
        }

        /* Modal sizing for desktop */
        .modal-dialog {
            margin: 30px auto;
            max-width: 100px;
        }
    }

    /* Extra large screens (1200px+) */
    @@media (min-width: 1200px) {
        .modal-dialog {
            max-width: 200px;
        }
    }

    /* ============================================
       UTILITY CLASSES
       ============================================ */

    .text-truncate {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .scrollable-x {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    /* Hide on mobile */
    @@media (max-width: 767px) {
        .hide-mobile {
            display: none !important;
        }
    }

    /* Show only on mobile */
    .show-mobile {
        display: none;
    }

    @@media (max-width: 767px) {
        .show-mobile {
            display: block !important;
        }
    }

    /* Loading indicator */
    .mobile-loading {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        font-size: 16px;
        color: #666;
    }
</style>

<!-- Page Header -->
<div class="page-header">
    <h6>
        <strong>
            Packing Draft Receipe Add <span style="color: green;">@EditModel?.DraftIrn</span>
        </strong>
    </h6>
</div>

<!-- Navigation Buttons - Adaptive sizing -->
<div class="adaptive-button-container">
    <button style="background-color:#5A5E60" @onclick="GoBack" class="btn btn-primary adaptive-btn">
        <i class="fa fa-arrow-left"></i>
    </button>
    <button type="button" class="btn btn-default adaptive-btn" style="color:white; background-color:#5A5E60; margin-left: auto;" @onclick="CloseDraft">
        <i class="fa fa-close"></i> Close Draft
    </button>
</div>

<!-- Crate Analysis Section - Responsive Cards -->
@if (TrickCrateAnalysis)
{
    <div class="container-fluid">
        @foreach (var company in GetCrateAnalysis)
        {
            <div class="crate-analysis-card">
                <h5 style="margin-bottom: 15px; font-size: 16px;">@company.Name</h5>
                
                <div class="crate-analysis-grid">
                    <div class="crate-stat">
                        <label>Crate Agreement</label>
                        <InputNumber class="form-control text-danger" style="color: red;"
                                     @bind-Value="company.CrateAgreement"
                                     disabled />
                    </div>

                    <div class="crate-stat">
                        <label>Crate Issue</label>
                        <InputNumber class="form-control text-danger" style="color: red;"
                                     @bind-Value="company.CrateIssue"
                                     disabled />
                    </div>

                    <div class="crate-stat">
                        <label>Crate Receive</label>
                        <InputNumber class="form-control text-danger" style="color: red;"
                                     @bind-Value="company.CrateReceive"
                                     disabled />
                    </div>

                    <div class="crate-stat">
                        <label>Empty Receive</label>
                        <InputNumber class="form-control text-danger" style="color: red;"
                                     @bind-Value="company.EmptyReceive"
                                     disabled />
                    </div>

                    <div class="crate-stat">
                        <label>Crate Available</label>
                        <InputNumber class="form-control text-danger" style="color: red;"
                                     @bind-Value="company.CrateAvailable"
                                     disabled />
                    </div>

                    <div class="crate-stat">
                        <label>Rec Pend Group</label>
                        <InputNumber class="form-control text-danger" style="color: red;"
                                     @bind-Value="company.PartyPending"
                                     disabled />
                    </div>

                    <div class="crate-stat">
                        <label>Rec Pend Grower</label>
                        <InputNumber class="form-control text-danger" style="color: red;"
                                     @bind-Value="company.GrowerPending"
                                     disabled />
                    </div>
                </div>
            </div>
        }
    </div>
}

<!-- Main Form Card - Responsive -->
<div class="card p-3 mb-4">
    <div class="row g-3">
        <div class="col-12 col-md-6 col-lg-3">
            <div class="form-group-mobile">
                <label for="date1">Dated</label>
                <DxDateEdit @bind-Date="EditModel.DraftDate"
                            Enabled="false" 
                            CssClass="w-100" 
                            MaxDate="@DateTime.Today"
                            InputId="date1" />
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg-3">
            <div class="form-group-mobile">
                <label>Grower Group</label>
                <InputText class="form-control"
                           @bind-Value="EditModel.GrowerGroupName"
                           placeholder="Group Name" readonly />
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg-2">
            <div class="form-group-mobile">
                <label for="crateQty">Weight</label>
                <InputNumber id="crateQty" 
                             min="0" 
                             placeholder="Weight"
                             class="form-control"
                             @bind-Value="EditModel.DraftWeight" />
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg-3">
            <div class="form-group-mobile">
                <label for="lastName">Variety</label>
                <DxComboBox Data="@banks"
                            SearchMode="@SearchMode"
                            SearchFilterCondition="@SearchFilterCondition"
                            SearchTextParseMode="@SearchTextParseMode"
                            @bind-Value="EditModel.VarietyId"
                            TextFieldName="Qname"
                            ValueFieldName="Qname"
                            placeholder="Select Variety"
                            CssClass="w-100"
                            InputId="cbFiltering"
                            Enabled="@isComboDisabled"
                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />
            </div>
        </div>

        <div class="col-12 col-lg-1">
            <div class="form-group-mobile">
                <label class="hide-mobile">&nbsp;</label>
                <div style="display: flex; gap: 8px;">
                    <button @onclick="Showmat" class="icon-btn">
                        <i class="fa fa-shopping-bag"></i>
                    </button>
                    <button @onclick="Showbox" class="icon-btn">
                        <i class="fas fa-box-open"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="form-group-mobile">
                <label for="remarks">Remarks</label>
                <InputText id="remarks" 
                           placeholder="Enter remarks"
                           class="form-control"
                           @bind-Value="EditModel.Repackremarks" />
            </div>
        </div>
    </div>
</div>

<!-- Store Out Details Grid -->
@if (ShowAddGrid)
{
    <h5 style="font-size: 16px; margin-bottom: 10px;">Store Out Details</h5>

    <div class="grid-wrapper">
        <DxGrid Data="@GetDailyPreinwardtemp" 
                CssClass="green-header-grid" 
                PageSize="100"
                PageSizeSelectorVisible="true"
                PageSizeSelectorItems="@(new int[] {5, 10, 25, 50, 100, 150, 200, 250, 300, 350, 400, 500 })"
                PageSizeSelectorAllRowsItemVisible="true" 
                ShowSearchBox="true"
                ShowGroupPanel="false"  
                FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Never"
                ColumnResizeMode="GridColumnResizeMode.NextColumn" 
                CustomizeElement="Grid_CustomizeElement" 
                TextWrapEnabled="true">
           
            <Columns>
                <DxGridDataColumn FieldName=@nameof(companyModel.DraftIdentity) Visible="false" MinWidth="80" Caption="ID" Width="8%" />
                <DxGridDataColumn FieldName=@nameof(companyModel.DemandNo) Visible="false" MinWidth="80" Caption="Demand" Width="8%" />
                <DxGridDataColumn FieldName=@nameof(companyModel.Lotno) Visible="false" MinWidth="80" Caption="Lot" Width="8%" />
                <DxGridDataColumn FieldName=@nameof(companyModel.LotIrn) MinWidth="100" Caption="Lot No" Width="10%" />
                <DxGridDataColumn FieldName=@nameof(companyModel.DemandIrn) MinWidth="120" Caption="Demand Order" Width="12%" />
                <DxGridDataColumn FieldName=@nameof(companyModel.GrowerGroupName) MinWidth="150" Caption="Party" Width="20%" />
                <DxGridDataColumn FieldName=@nameof(companyModel.GrowerName) MinWidth="150" Caption="Grower" Width="20%" />
                <DxGridDataColumn FieldName="@nameof(companyModel.OrderQty)" MinWidth="100" Caption="Grading Qty" Width="10%" />
                <DxGridDataColumn FieldName=@nameof(companyModel.TotalStoreOut) MinWidth="100" Caption="Store Out" Width="10%" />
                <DxGridDataColumn FieldName=@nameof(companyModel.Alotbal) MinWidth="100" Caption="Order Qty" Width="10%" />
                <DxGridDataColumn FieldName=@nameof(companyModel.VerfiedQty) MinWidth="100" Caption="Verified" Width="10%" />
                <DxGridDataColumn FieldName=@nameof(companyModel.ItemName) MinWidth="100" Caption="Item" Width="10%" />
                <DxGridDataColumn FieldName=@nameof(companyModel.Prodetails) MinWidth="100" Caption="Package" Width="12%" />
                <DxGridDataColumn FieldName=@nameof(companyModel.PreInwardKhata) MinWidth="100" Caption="Khata" Width="10%" />
                <DxGridDataColumn FieldName=@nameof(companyModel.VarietyId) MinWidth="100" Caption="Variety" Width="10%" />
                <DxGridDataColumn FieldName=@nameof(companyModel.ChamberId) MinWidth="80" Caption="Chamber" Width="8%" />
                <DxGridDataColumn FieldName=@nameof(companyModel.Templocation) MinWidth="100" Caption="Location" Width="10%" />
                <DxGridDataColumn FieldName=@nameof(companyModel.ChallanName) MinWidth="120" Caption="Challan" Width="12%" />

                <DxGridCommandColumn Caption="Actions" Width="8%">
                    <HeaderTemplate>
                        <strong>Del</strong>
                    </HeaderTemplate>
                    <CellDisplayTemplate>
                        <a title="Delete Receipe" 
                           class="grid-action-btn fa fa-trash text-danger" 
                           @onclick="@(() => Deletelot(((CompanyModel)context.DataItem).DraftIdentity))" 
                           href="javascript:void(0);"></a>
                    </CellDisplayTemplate>
                </DxGridCommandColumn>
            </Columns>  

            <TotalSummary>
                <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.OrderQty)" />
            </TotalSummary>
        </DxGrid>
    </div>
}

<!-- Receipe Items Grid -->
<h5 style="font-size: 16px; margin-bottom: 10px;">Receipe Items</h5>

<div class="grid-wrapper">
    <DxGrid Data="@GetpackingDraft" 
            CssClass="green-header-grid" 
            PageSize="1000"
            PageSizeSelectorVisible="true" 
            PagerPosition="GridPagerPosition.TopAndBottom"
            PageSizeSelectorItems="@(new int[] {5, 10, 25, 50, 100, 150, 200, 250, 300, 350, 400, 500 })"
            PageSizeSelectorAllRowsItemVisible="true" 
            ShowSearchBox="true" 
            ShowAllRows="true"
            ShowGroupPanel="false"  
            FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
            ColumnResizeMode="GridColumnResizeMode.NextColumn" 
            CustomizeElement="Grid_CustomizeElement" 
            TextWrapEnabled="true">
        
        <Columns>
            <DxGridDataColumn FieldName=@nameof(companyModel.DraftIdentity) Visible="false" MinWidth="80" Caption="ID" Width="8%" />
            <DxGridDataColumn FieldName=@nameof(companyModel.ReceipeId) Visible="false" MinWidth="80" Caption="Recipe ID" Width="8%" />
            <DxGridDataColumn FieldName=@nameof(companyModel.PalletId) Visible="false" MinWidth="80" Caption="Pallet ID" Width="8%" />
            <DxGridDataColumn FieldName=@nameof(companyModel.PalletName) MinWidth="100" Caption="Pallet No" Width="12%" />
            <DxGridDataColumn FieldName=@nameof(companyModel.ReceipeName) MinWidth="120" Caption="Recipe" Width="15%" />
            <DxGridDataColumn FieldName=@nameof(companyModel.ReceipeGrade) MinWidth="100" Caption="Grade" Width="12%" />
            <DxGridDataColumn FieldName=@nameof(companyModel.ReceipeMarka) MinWidth="100" Caption="Marka" Width="12%" />
            <DxGridDataColumn FieldName=@nameof(companyModel.VarietyId) MinWidth="100" Caption="Variety" Width="12%" />
            <DxGridDataColumn FieldName=@nameof(companyModel.ReceipeLocation) MinWidth="100" Caption="Location" Width="12%" />
            <DxGridDataColumn FieldName="@nameof(companyModel.ReceipeQty)" MinWidth="80" Caption="Qty" Width="10%" />

            <DxGridCommandColumn Caption="Edit" Width="6%">
                <HeaderTemplate>
                    <strong>Edit</strong>
                </HeaderTemplate>
                <CellDisplayTemplate>
                    <a title="Edit Receipe" 
                       class="grid-action-btn fas fa-pencil-alt" 
                       @onclick="@(() => EditItem(context.DataItem))" 
                       href="javascript:void(0);"></a>
                </CellDisplayTemplate>
            </DxGridCommandColumn>

            <DxGridCommandColumn Caption="Del" Width="6%">
                <HeaderTemplate>
                    <strong>Del</strong>
                </HeaderTemplate>
                <CellDisplayTemplate>
                    <a title="Delete Receipe" 
                       class="grid-action-btn fa fa-trash text-danger" 
                       @onclick="@(() => DeleteGrower(((CompanyModel)context.DataItem).DraftIdentity))" 
                       href="javascript:void(0);"></a>
                </CellDisplayTemplate>
            </DxGridCommandColumn>
        </Columns>
        
        <TotalSummary>
            <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.ReceipeQty)" />
        </TotalSummary>
    </DxGrid>
</div>

<!-- Recipe Entry Form - Adaptive sizing -->
<div class="card p-3 mb-4">
    <div class="row g-3">
        <div class="col-12 col-sm-6 col-lg-2">
            <div class="form-group-mobile">
                <label>Receipe Name</label>
                <DxComboBox Data="@Receipelist"
                            SearchMode="@SearchMode"
                            SearchFilterCondition="@SearchFilterCondition"
                            SearchTextParseMode="@SearchTextParseMode"
                            @bind-Value="EditModel.ReceipeName"
                            TextFieldName="ReceipeName"
                            ValueFieldName="ReceipeName"
                            placeholder="Select Recipe"
                            CssClass="w-100"
                            InputId="cbFiltering"
                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-2">
            <div class="form-group-mobile">
                <label>Qty</label>
                <InputNumber min="0" 
                             placeholder="Quantity"
                             class="form-control"
                             @bind-Value="EditModel.ReceipeQty" />
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-2">
            <div class="form-group-mobile">
                <label>Grade</label>
                <DxComboBox Data="@Rgrades"
                            SearchMode="@SearchMode"
                            SearchFilterCondition="@SearchFilterCondition"
                            SearchTextParseMode="@SearchTextParseMode"
                            ValueChanged="@(async (string? newValue) => await OnGradeGroupChanged(newValue))"
                            Value="EditModel.ReceipeGrade"
                            TextFieldName="ReceipeGrade"
                            ValueFieldName="ReceipeGrade"
                            placeholder="Select Grade"
                            CssClass="w-100"
                            InputId="cbFiltering"
                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-2">
            <div class="form-group-mobile">
                <label>Marka</label>
                <InputText placeholder="Marka"
                           class="form-control"
                           @bind-Value="EditModel.ReceipeMarka" />
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-2">
            <div class="form-group-mobile">
                <label>Location</label>
                <DxComboBox Data="@GetallLocation"
                            SearchMode="@SearchMode"
                            SearchFilterCondition="@SearchFilterCondition"
                            SearchTextParseMode="@SearchTextParseMode"
                            @bind-Value="EditModel.ReceipeLocation"
                            TextFieldName="Templocation"
                            ValueFieldName="Templocation"
                            placeholder="Select Location"
                            CssClass="w-100"
                            InputId="cbFiltering"
                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />
            </div>
        </div>

        <div class="col-12 col-lg-2">
            <div class="form-group-mobile">
                <label class="hide-mobile">&nbsp;</label>
                @if(ShowAdd==true)
                {
                    <button type="button" 
                            class="btn btn-primary adaptive-btn" 
                            @onclick="SaveUnit">
                        Add
                    </button>
                }
                @if(ShowEdit==true)
                {
                    <div class="button-pair">
                        <DxButton CssClass="btn btn-success" 
                                  Text="Save" 
                                  @onclick="UpdateUnit" />
                        <DxButton CssClass="btn btn-secondary" 
                                  Text="Cancel" 
                                  @onclick="CancelSave" />
                    </div>
                }
            </div>
        </div>
    </div>
</div>


<DxDialogProvider />

<!-- Confirmation Dialog -->
<DxPopup @bind-Visible="@isDialogVisible"
         HeaderText="Confirmation"
         ShowCloseButton="true"
         CssClass="validation-dialog">
    <Content>
        <p>Are you sure you want to change the status for Item ID: <strong>@selectedGrowerId</strong>?</p>
        <div class="button-pair" style="margin-top: 15px;">
            <DxButton RenderStyle="ButtonRenderStyle.Primary" Click="@OnConfirmYes">Yes</DxButton>
            <DxButton RenderStyle="ButtonRenderStyle.Secondary" Click="@OnConfirmNo">No</DxButton>
        </div>
    </Content>
</DxPopup>

<!-- Delete Dialog -->
<DxPopup @bind-Visible="@DeleteDialog"
         HeaderText="Confirmation"
         ShowCloseButton="true"
         CssClass="validation-dialog">
    <Content>
        <p>Are you sure you want to delete the Receipe Id: <strong>@selectedGrowerId</strong>?</p>
        <div class="button-pair" style="margin-top: 15px;">
            <DxButton RenderStyle="ButtonRenderStyle.Primary" Click="@OnConfirmYesDelete">Yes</DxButton>
            <DxButton RenderStyle="ButtonRenderStyle.Secondary" Click="@OnConfirmNoDelete">No</DxButton>
        </div>
    </Content>
</DxPopup>

<!-- Vehicle Popup -->
<DxPopup @bind-Visible="@IsVehvisible"
         HeaderText="Add New Vehicle"
         Width="min(500px, calc(100vw - 40px))">
    <Content>
        <EditForm Model="@EditModel">
            <DataAnnotationsValidator />
            
            <div class="row g-3">
                <div class="col-12 col-md-6">
                    <div class="form-group-mobile">
                        <label>Driver Name</label>
                        <InputText class="form-control"
                                   @bind-Value="EditModel.VehDriver"
                                   placeholder="Driver Name"/>
                    </div>
                </div>
                
                <div class="col-12 col-md-6">
                    <div class="form-group-mobile">
                        <label>Vehicle Number</label>
                        <InputText class="form-control"
                                   @bind-Value="EditModel.Vehno"
                                   placeholder="Vehicle No"/>
                    </div>
                </div>

                <div class="col-12 col-md-6">
                    <div class="form-group-mobile">
                        <label>Vehicle Type</label>
                        <InputText class="form-control"
                                   @bind-Value="EditModel.Vehntype"
                                   placeholder="Type"/>
                    </div>
                </div>
                
                <div class="col-12 col-md-6">
                    <div class="form-group-mobile">
                        <label>Contact Number</label>
                        <input type="text"
                               inputmode="numeric"
                               maxlength="10"
                               class="form-control"
                               @bind="FilteredPhoneNumber"
                               @bind:event="oninput"
                               placeholder="Phone No 10 Digits" />
                    </div>
                </div>
            </div>

            <div class="button-pair" style="margin-top: 20px;">
                <DxButton CssClass="btn btn-primary" Text="Save" @onclick="Savevehicle" />
                <DxButton CssClass="btn btn-secondary" Text="Cancel" @onclick="HideNewVehicle" />
            </div>
        </EditForm>
    </Content>
</DxPopup>

<!-- Add Grower Popup -->
<DxPopup @bind-Visible="@AddSub"
         HeaderText="Add New Grower"
         Width="min(500px, calc(100vw - 40px))">
    <Content>
        <EditForm Model="@EditModel">
            <DataAnnotationsValidator />

            <div class="row g-3">
                <div class="col-12 col-md-6">
                    <div class="form-group-mobile">
                        <label>Grower Group</label>
                        <InputText class="form-control"
                                   @bind-Value="EditModel.GrowerGroupName"
                                   placeholder="Group Name" readonly/>
                    </div>
                </div>
                
                <div class="col-12 col-md-6">
                    <div class="form-group-mobile">
                        <label>Grower Name</label>
                        <InputText class="form-control"
                                   @bind-Value="EditModel.GrowerName"
                                   placeholder="Grower Name" />
                    </div>
                </div>

                <div class="col-12 col-md-6">
                    <div class="form-group-mobile">
                        <label>Grower Address</label>
                        <InputText class="form-control"
                                   @bind-Value="EditModel.GrowerAddress"
                                   placeholder="Address" />
                    </div>
                </div>
                
                <div class="col-12 col-md-6">
                    <div class="form-group-mobile">
                        <label>Contact No</label>
                        <input type="text"
                               inputmode="numeric"
                               maxlength="10"
                               class="form-control"
                               @bind="FilteredPhoneNumbergrower"
                               @bind:event="oninput"
                               placeholder="Phone No 10 Digits" />
                    </div>
                </div>

                <div class="col-12 col-md-6">
                    <div class="form-group-mobile">
                        <label>Crate Issue Qty</label>
                        <InputNumber class="form-control"
                                     @bind-Value="EditModel.GrowerCrateissue"
                                     placeholder="Crate Issue Qty" />
                    </div>
                </div>
                
                <div class="col-12 col-md-6">
                    <div class="form-group-mobile">
                        <label>Crate Limit</label>
                        <InputNumber class="form-control"
                                     @bind-Value="EditModel.GrowerCratelimit"
                                     placeholder="Limit Percent" />
                    </div>
                </div>
            </div>

            <div class="button-pair" style="margin-top: 20px;">
                <DxButton CssClass="btn btn-primary" Text="Save" @onclick="SaveNewSub" />
                <DxButton CssClass="btn btn-secondary" Text="Close" @onclick="HideNewsub" />
            </div>
        </EditForm>
    </Content>
</DxPopup>

<!-- Add Challan Popup -->
<DxPopup @bind-Visible="@Addnewchallan"
         HeaderText="Add New Challan"
         Width="min(500px, calc(100vw - 40px))">
    <Content>
        <EditForm Model="@EditModel">
            <DataAnnotationsValidator />

            <div class="row g-3">
                <div class="col-12 col-md-6">
                    <div class="form-group-mobile">
                        <label>Grower Group</label>
                        <InputText class="form-control"
                                   @bind-Value="EditModel.GrowerGroupName"
                                   placeholder="Group Name" readonly />
                    </div>
                </div>
                
                <div class="col-12 col-md-6">
                    <div class="form-group-mobile">
                        <label>Grower Name</label>
                        <InputText class="form-control"
                                   @bind-Value="EditModel.GrowerName"
                                   placeholder="Grower Name" readonly />
                    </div>
                </div>

                <div class="col-12 col-md-6">
                    <div class="form-group-mobile">
                        <label>Challan Name</label>
                        <InputText class="form-control"
                                   @bind-Value="EditModel.ChallanName"
                                   placeholder="Challan Name" />
                    </div>
                </div>
                
                <div class="col-12 col-md-6">
                    <div class="form-group-mobile">
                        <label>Contact No</label>
                        <input type="text"
                               inputmode="numeric"
                               maxlength="10"
                               class="form-control"
                               @bind="FilteredPhoneNumberchallan"
                               @bind:event="oninput"
                               placeholder="Phone No 10 Digits" />
                    </div>
                </div>

                <div class="col-12">
                    <div class="form-group-mobile">
                        <label>Address</label>
                        <InputText class="form-control"
                                   @bind-Value="EditModel.ChallanAddress"
                                   placeholder="Address" />
                    </div>
                </div>
            </div>

            <div class="button-pair" style="margin-top: 20px;">
                <DxButton CssClass="btn btn-primary" Text="Save" @onclick="SaveNewChallan" />
                <DxButton CssClass="btn btn-secondary" Text="Close" @onclick="HideNewchallan" />
            </div>
        </EditForm>
    </Content>
</DxPopup>

<!-- Post Dialog -->
<DxPopup @bind-Visible="@PostDialog"
         HeaderText="Confirmation"
         ShowCloseButton="true"
         CssClass="validation-dialog">
    <Content>
        <p>Are you sure you want to close the Draft Id: <strong>@selectedGrowerId</strong>?</p>
        <div class="button-pair" style="margin-top: 15px;">
            <DxButton RenderStyle="ButtonRenderStyle.Primary" Click="@OnConfirmYesPost">Yes</DxButton>
            <DxButton RenderStyle="ButtonRenderStyle.Secondary" Click="@OnConfirmNoPost">No</DxButton>
        </div>
    </Content>
</DxPopup>

<!-- Delete Lot Dialog -->
<DxPopup @bind-Visible="@DeleteDialoglot"
         HeaderText="Confirmation"
         ShowCloseButton="true"
         CssClass="validation-dialog">
    <Content>
        <p>Are you sure you want to delete the lot?</p>
        <div class="button-pair" style="margin-top: 15px;">
            <DxButton RenderStyle="ButtonRenderStyle.Primary" Click="@OnConfirmDeletelot">Yes</DxButton>
            <DxButton RenderStyle="ButtonRenderStyle.Secondary" Click="@OnNoDeletelot">No</DxButton>
        </div>
    </Content>
</DxPopup>

<!-- Generate PreInward Dialog -->
<DxPopup @bind-Visible="@PurDialog"
         HeaderText="Confirmation"
         ShowCloseButton="true"
         CssClass="validation-dialog">
    <Content>
        <p>Are you sure you want to generate new PreInward?</p>
        <div class="button-pair" style="margin-top: 15px;">
            <DxButton RenderStyle="ButtonRenderStyle.Primary" Click="@OnConfirmYesGenerate">Yes</DxButton>
            <DxButton RenderStyle="ButtonRenderStyle.Secondary" Click="@OnConfirmNoGenerate">No</DxButton>
        </div>
    </Content>
</DxPopup>

<!-- Validation Error Dialog -->
@if (ShowEmptyFieldDialog)
{
    <DxPopup @bind-Visible="@ShowEmptyFieldDialog"
             HeaderText="Validation Error"
             ShowCloseButton="true"
             CssClass="validation-dialog">
        <Content>
            <p>@DialogMessage</p>
            <DxButton CssClass="btn btn-primary adaptive-btn" 
                      Text="OK" 
                      Click="@(() => ShowEmptyFieldDialog = false)" />
        </Content>
    </DxPopup>
}

<!-- Success Dialog -->
@if (ShowEmptyFieldDialogError)
{
    <DxPopup @bind-Visible="@ShowEmptyFieldDialogError"
             HeaderText="Confirmation Message"
             ShowCloseButton="true"
             CssClass="custom-popup-style">
        <Content>
            <p><strong>Success:</strong> @DialogMessage</p>
            <DxButton CssClass="btn btn-primary adaptive-btn" 
                      Text="OK" 
                      RenderStyle="ButtonRenderStyle.Primary" 
                      Click="@(() => ShowEmptyFieldDialogError = false)" />
        </Content>
    </DxPopup>
}

<!-- Sachet Modal -->
@if (ShowModal == true)
{
    <div class="modal" tabindex="-1" style="display:block; background: rgba(0,0,0,0.5);">
        <div class="modal-dialog" style="max-width: calc(100% - 20px); margin: 10px auto;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        Sachet and Bags Details 
                        <span style="color: green;">@EditModel?.DraftIrn</span>
                    </h5>
                </div>

                <div class="modal-body" style="padding: 10px;">
                    <div class="grid-wrapper">
                        <DxGrid Data="@GetTotalReceipeQty" 
                                CssClass="green-header-grid" 
                                PageSize="100"
                                PageSizeSelectorVisible="true" 
                                PagerPosition="GridPagerPosition.TopAndBottom"
                                PageSizeSelectorItems="@(new int[] {5, 10, 25, 50, 100})"
                                PageSizeSelectorAllRowsItemVisible="true" 
                                ShowSearchBox="true" 
                                ShowAllRows="true"
                                ShowGroupPanel="false" 
                                FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Never"
                                ColumnResizeMode="GridColumnResizeMode.NextColumn" 
                                CustomizeElement="Grid_CustomizeElement" 
                                TextWrapEnabled="false">
                            
                            <Columns>
                                <DxGridDataColumn FieldName=@nameof(companyModel.DraftId) Visible="false" MinWidth="80" Caption="ID" Width="10%" />
                                <DxGridDataColumn FieldName=@nameof(companyModel.ReceipeId) Visible="false" MinWidth="80" Caption="Recipe ID" Width="10%" />
                                <DxGridDataColumn FieldName=@nameof(companyModel.ReceipeName) MinWidth="150" Caption="Recipe" Width="40%" />
                                <DxGridDataColumn FieldName="@nameof(companyModel.TotalReceipeQty)" MinWidth="100" Caption="Draft Qty" Width="15%" />
                                
                                <DxGridDataColumn FieldName="IsSelected" MinWidth="80" Caption="Select" Width="10%">
                                    <CellDisplayTemplate Context="cellData">
                                        @{
                                            var isSelected = (bool)(cellData.Value ?? false);
                                            var itemId = ((CompanyModel)cellData.DataItem);
                                        }
                                        <input type="checkbox"
                                               checked="@isSelected"
                                               @onchange="(e) => OnCheckboxChanged(e, itemId)" />
                                    </CellDisplayTemplate>
                                </DxGridDataColumn>
                                
                                <DxGridDataColumn FieldName="@nameof(companyModel.SachetQty)" MinWidth="120" Caption="Sachet Qty" Width="25%">
                                    <CellDisplayTemplate Context="cellData">
                                        @{
                                            var companyModel = (CompanyModel)cellData.DataItem;
                                        }
                                        <input type="number"
                                               value="@companyModel.SachetQty"
                                               @oninput="async (e) => await OnOrderQtyChanged(companyModel, e)"
                                               class="form-control" 
                                               min="0"
                                               style="width: 100%; padding: 5px;" />
                                    </CellDisplayTemplate>
                                </DxGridDataColumn>
                            </Columns>

                            <TotalSummary>
                                <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.TotalReceipeQty)" />
                                <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.SachetQty)" />
                            </TotalSummary>
                        </DxGrid>
                    </div>
                </div>

                <div class="modal-footer">
                    <div class="button-pair" style="width: auto;">
                        <button type="button" class="btn btn-secondary" @onclick="Close">Close</button>
                        <button type="button" class="btn btn-primary" @onclick="UploadSachet">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Box Modal -->
<DxPopup @bind-Visible="@ShowBoxModal"
         Width="min(500px, calc(100vw - 40px))"
         HeaderText="Package Config" 
         ShowCloseButton="true">
    <Content>
        <h5 class="modal-title" style="margin-bottom: 15px;">
            Box Details 
            <span style="color: green;">@EditModel?.DraftIrn</span>
        </h5>
        
        <div class="row g-3">
            <div class="col-12 col-md-6">
                <div class="form-group-mobile">
                    <label>Type:</label>
                    <DxTextBox @bind-Text="@EditModel.HCASE" ReadOnly="true" />
                </div>
            </div>
            
            <div class="col-12 col-md-6">
                <div class="form-group-mobile">
                    <label>Box Name:</label>
                    <DxComboBox @key="OrderGroupKey" 
                                Data="@Hcaselist"
                                SearchMode="@SearchMode"
                                AllowUserInput="true"
                                SearchFilterCondition="@SearchFilterCondition"
                                SearchTextParseMode="@SearchTextParseMode"
                                TextFieldName="HcaseName"
                                @bind-Value="EditModel.HcaseName"
                                ValueFieldName="HcaseName"
                                TextChanged="OnKhataMarkChanged"
                                InputId="cbFiltering"
                                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />
                </div>
            </div>

            <div class="col-12 col-md-6">
                <div class="form-group-mobile">
                    <label>Type:</label>
                    <DxTextBox @bind-Text="@EditModel.BOX" ReadOnly="true" />
                </div>
            </div>
            
            <div class="col-12 col-md-6">
                <div class="form-group-mobile">
                    <label>Box Name:</label>
                    <DxComboBox @key="OrderGroupKey" 
                                Data="@Boxlist"
                                SearchMode="@SearchMode"
                                AllowUserInput="true"
                                SearchFilterCondition="@SearchFilterCondition"
                                SearchTextParseMode="@SearchTextParseMode"
                                TextFieldName="BoxName"
                                @bind-Value="EditModel.BoxName"
                                ValueFieldName="BoxName"
                                TextChanged="OnKhataMarkChanged"
                                InputId="cbFiltering"
                                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />
                </div>
            </div>
        </div>

        <div class="button-pair" style="margin-top: 20px;">
            <DxButton Text="Save" Click="SaveBox" />
            <DxButton Text="Cancel" Click="@(() => ShowBoxModal = false)" />
        </div>
    </Content>
</DxPopup>


@code {
    [Parameter] public int Demandid { get; set; }
    private bool ShowBoxModal = false;
    private string ModalDisplay = "none;";
    private string ModalClass = "";
    public bool ShowModal { get; set; }
    public bool DeleteDialoglot { get; set; }

    public void Show()
    {
        ModalDisplay = "block";
        ModalClass = "show";
    }

    public void Close()
    {
        ShowModal= false;
    }

    public async void Showbox()
    {

        EditModel = await EmployeeService.GetBoxDetails(Demandid);

        // Boxlist = await EmployeeService.GetBox();
        //        Hcaselist = await EmployeeService.GetHcase();


        ShowBoxModal= true;
        StateHasChanged();
    }

    public string FilteredPhoneNumber
    {
        get => EditModel.VehContact;
        set => EditModel.VehContact = string.IsNullOrEmpty(value) ? "" : new string(value.Where(char.IsDigit).ToArray());
    }


    public string FilteredPhoneNumbergrower
    {
        get => EditModel.GrowerContact;
        set => EditModel.GrowerContact = string.IsNullOrEmpty(value) ? "" : new string(value.Where(char.IsDigit).ToArray());
    }

    public string FilteredPhoneNumberchallan
    {
        get => EditModel.DemandContact;
        set => EditModel.DemandContact = string.IsNullOrEmpty(value) ? "" : new string(value.Where(char.IsDigit).ToArray());
    }



    private bool ShowAdd = true;
    private bool ShowEdit = false;

    private bool isComboDisabled = true;
    ListSearchMode SearchMode { get; set; } = ListSearchMode.AutoSearch;
    ListSearchFilterCondition SearchFilterCondition { get; set; } = ListSearchFilterCondition.Contains;
    ListSearchTextParseMode SearchTextParseMode { get; set; } = ListSearchTextParseMode.GroupWordsByAnd;
    List<CompanyModel> GetmasterGroup = new List<CompanyModel>();
    List<CompanyModel> GetgrowerList = new List<CompanyModel>();
    List<CompanyModel> Purchaseorders = new List<CompanyModel>();

    List<CompanyModel> Boxlist = new List<CompanyModel>();
    List<CompanyModel> GetTotalReceipeQty = new List<CompanyModel>();

    List<CompanyModel> GetchamberAnalysis = new List<CompanyModel>();
    List<CompanyModel> GetLots = new List<CompanyModel>();
    List<CompanyModel> Receipelist = new List<CompanyModel>();
    List<CompanyModel> Rgrades = new List<CompanyModel>();
    List<CompanyModel> GetpackingDraft = new List<CompanyModel>();

    List<CompanyModel> GetallLocation = new List<CompanyModel>();
    List<CompanyModel> Hcaselist = new List<CompanyModel>();


    List<CompanyModel> DemandList = new List<CompanyModel>();
    List<CompanyModel> GetChambers = new List<CompanyModel>();

    List<CompanyModel> GetVehlist = new List<CompanyModel>();

    List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();
    List<CompanyModel> GetDailyPreinwardtemp = new List<CompanyModel>();

    List<CompanyModel> GetDailyCrates = new List<CompanyModel>();
    string AvailGrower ="";
    bool showQty = false;
    bool showReport = false;
    bool TrickCrateAnalysis=false;
    bool ShowBoth = false;
    bool ShowButtonAdd = true;
    bool ShowOtherButtons = false;
    string DemandGroupKey = Guid.NewGuid().ToString();
    string OrderGroupKey = Guid.NewGuid().ToString();
    private System.Timers.Timer dismissTimer;
    bool ShowAddGrid=false;
    string SelectGrower  ="";

    private bool IsServiceTypeDisabled = false;
    List<CompanyModel> GetCrateMark = new List<CompanyModel>();
    List<CompanyModel> GetChallanGroup = new List<CompanyModel>();
    List<CompanyModel> GetInsertedQty = new List<CompanyModel>();

    List<CompanyModel> CrateAnalysis = new List<CompanyModel>();
    List<CompanyModel> GetSubGrowerGroup = new List<CompanyModel>();


    // DxReportViewer? reportViewer;
    // XtraReport? Report;
    // private void ShowReport()
    // {



    //     Report = XtraReport.FromFile(Path.Combine(Directory.GetCurrentDirectory(),
    //          @"Reports\XtraReport11.repx"));

    //     showReport = true;
    // }

    private void OnCrateCrnChanged(string value)
    {
        EditModel.PreCrateType = value;

        ShowBoth = value == "BOTH";
    }


    private async void OnCheckboxChanged(ChangeEventArgs e, CompanyModel itemid)
    {
        bool isChecked = (bool)(e.Value ?? false);
        itemid.IsSelected = isChecked;

        if (isChecked)
        {

            itemid.SachetQty = (int)itemid.TotalReceipeQty;

            //itemid.OrderQty = 0;// Remove the cast if VerifiedQty is already int
            StateHasChanged();
        }


        if (!isChecked)
        {


            selectedItems.Remove(itemid);
            itemid.SachetQty = 0; // Remove the cast if VerifiedQty is already int
            StateHasChanged();
        }

    }

    private void ValidateItemname()
    {
        if (string.IsNullOrWhiteSpace(EditModel.Itemname))
        {
            // Handle empty item name case
        }
        else if (EditModel.Itemname.Equals("APPLE", StringComparison.OrdinalIgnoreCase))
        {
            EditModel.PreInwardUom = "CRATES";
        }
        else if (EditModel.Itemname.Equals("PETTI", StringComparison.OrdinalIgnoreCase))
        {
            EditModel.PreInwardUom = "PETTI";
        }
    }
    private void OnItemChanged(string Value)
    {
        selectedIrn = Value;
    }

    private async Task OnGradeGroupChanged(string? newCountryId)
    {
            string selectedPurchase = "";
            selectedPurchase = newCountryId;

            int draftid = Demandid;
        EditModel.ReceipeGrade = newCountryId;
            companyModel = await EmployeeService.GetLastKhata(selectedPurchase,draftid);
            EditModel.ReceipeMarka= companyModel.ReceipeMarka;
            StateHasChanged();
    }














    public class ComboItem
    {
        public string DisplayText { get; set; }  // What appears in the dropdown
        public string ValueType { get; set; }     // "Company", "Both", or "Own"
    }

    private bool selectAll = false; // Change selectcheck to selectAll

    private void OnSelectAllChanged(bool isChecked)
    {
        selectAll = isChecked;
        if (GetDailyPreinward != null)
        {
            foreach (var item in GetDailyPreinward)
            {
                item.IsSelected = isChecked;
                if (isChecked)
                {
                    item.Lotbalance = (int)item.VerfiedQty;
                }
            }
            StateHasChanged();
        }
    }
    private async Task OnOrderQtyChanged(object dataItem, ChangeEventArgs e)
    {
        if (dataItem is CompanyModel companyModel)
        {
            // Store the new order quantity


            // Access the verified quantity
            var verifiedQty = companyModel.TotalReceipeQty;
            string inputValue = e.Value?.ToString();


            if (string.IsNullOrWhiteSpace(inputValue))
            {
                // companyModel.Lotbalance = (int)companyModel.Alotbal;

                //  companyModel.OrderQty = 0;
                companyModel.IsSelected = false;

                StateHasChanged();
                return;
            }


            // await JS.InvokeVoidAsync("alert", "YY");

            if (int.TryParse(e.Value?.ToString(), out int newQty))
            {

                //  await JS.InvokeVoidAsync("alert","MM");
                companyModel.SachetQty = newQty;


                if (newQty < 0)
                {
                    //companyModel.OrderQty = 0;
                    // companyModel.Lotbalance = (int)companyModel.Alotbal;
                    companyModel.IsSelected = false;
                    StateHasChanged();
                    // await ShowErrorMessage("Order quantity cannot be negative");
                }
                else if (newQty == 0)
                {
                    // companyModel.OrderQty = 0;
                    companyModel.IsSelected = false;
                    return;

                }
                else if (newQty > verifiedQty)
                {
                    companyModel.SachetQty = 0;
                    companyModel.IsSelected = false;
                    StateHasChanged();
                    return;

                }
                else
                {
                    companyModel.IsSelected =true;
                    // companyModel.Lotbalance= (int)(verifiedQty - newQty);
                    StateHasChanged();
                }

                // Refresh UI if needed
                StateHasChanged();
            }
        }
        else
        {
            // Handle parsing error
            // await ShowErrorMessage("Please enter a valid number");
        }
    }

    private async Task HandleEnterKey(CompanyModel EditModel, KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            //   await JS.InvokeVoidAsync("alert", companyModel.TempOrderId);


            EditModel.TempOrderId=companyModel.TempOrderId;

            int selectedId = EditModel.TempOrderId;

            int unit = UserSessionService.UnitId;


            await EmployeeService.UpdateLotOrderQuantity(EditModel);
            GetDailyPreinwardtemp = await EmployeeService.GenerateTempLotReport(EditModel, unit, selectedId);



            StateHasChanged();
            return;










        }
    }


    private bool selectcheck = false;

    private async Task OnOrderTempQtyChanged(object dataItem, ChangeEventArgs e)
    {
        if (dataItem is CompanyModel companyModel)
        {
            // Store the new order quantity


            // Access the verified quantity
            var verifiedQty = companyModel.Alotbal;
            string inputValue = e.Value?.ToString();


            if (string.IsNullOrWhiteSpace(inputValue))
            {
                companyModel.Lotbalance = (int)companyModel.Alotbal;

                //  companyModel.OrderQty = 0;
                companyModel.IsSelected = false;

                StateHasChanged();
                return;
            }


            // await JS.InvokeVoidAsync("alert", "YY");

            if (int.TryParse(e.Value?.ToString(), out int newQty))
            {

                //  await JS.InvokeVoidAsync("alert","MM");
                companyModel.OrderQty = newQty;


                if (newQty < 0)
                {
                    //companyModel.OrderQty = 0;
                    companyModel.Lotbalance = (int)companyModel.Alotbal;
                    companyModel.IsSelected = false;
                    StateHasChanged();
                    // await ShowErrorMessage("Order quantity cannot be negative");
                }
                else if (newQty == 0)
                {
                    await JS.InvokeVoidAsync("alert", "Invalid Qty");
                    companyModel.Lotbalance = (int)companyModel.Alotbal;
                    // companyModel.OrderQty = 0;
                    companyModel.IsSelected = false;
                    return;

                }
                else if (newQty > verifiedQty)
                {
                    await JS.InvokeVoidAsync("alert", "Invalid Qty");
                    companyModel.Lotbalance = (int)companyModel.Alotbal;
                    companyModel.OrderQty = 0;
                    companyModel.IsSelected = false;
                    StateHasChanged();
                    return;

                }
                else
                {
                    companyModel.IsSelected = true;
                    companyModel.Lotbalance = (int)(verifiedQty - newQty);
                    StateHasChanged();
                }

                // Refresh UI if needed
                StateHasChanged();
            }
        }
        else
        {
            // Handle parsing error
            // await ShowErrorMessage("Please enter a valid number");
        }
    }

    private void OnSelectcheckChanged(CompanyModel item, bool isChecked)
    {
        // Deselect all other rows first
        if (isChecked && GetDailyPreinward != null)
        {
            foreach (var row in GetDailyPreinward)
            {
                row.IsSelected = (row == item); // Only select the current item
            }
        }
        else
        {
            item.IsSelected = isChecked;
        }

        // Update Lotbalance if selected
        if (isChecked)
        {
            item.Lotbalance = (int)item.VerfiedQty;
        }

        StateHasChanged();
    }






    private void OnIndividualCheckboxChanged(CompanyModel item, bool isChecked)
    {
        // item.IsSelected = isChecked;
        // if (isChecked)
        // {
        //     item.Lotbalance = item.VerfiedQty;
        // }
        // StateHasChanged();
    }
    private List<ComboItem> CrateType = new List<ComboItem>
    {
        new ComboItem { DisplayText = "COMPANY", ValueType = "COMPANY" },
        new ComboItem { DisplayText = "BOTH", ValueType = "BOTH" },
        new ComboItem { DisplayText = "OWN", ValueType = "OWN" }
    };


    private decimal AvailableBookQty = 0;
    private string selectedIrn="";

    private decimal AvailableSubGrower = 0;

    private CompanyModel EditModel = new();
    private string DialogMessage { get; set; } = "";
    private bool ShowEmptyFieldDialogError { get; set; }
    private string ChallanGroup { get; set; } = "";
    string GrowerGroupKey = Guid.NewGuid().ToString();
    string GrowerNameKey = Guid.NewGuid().ToString();
    string ChallanKey = Guid.NewGuid().ToString();
    private bool IsVehvisible { get; set; } = false;

    private bool AddSub { get; set; } = false;
    private bool ShowEmptyFieldDialog { get; set; }
    private bool ShowCrateAnalysis { get; set; } = false;
    private bool Addnewchallan { get; set; } = false;
    async Task Savevehicle()

    {

        if (string.IsNullOrWhiteSpace(EditModel.Vehno) || string.IsNullOrWhiteSpace(EditModel.VehDriver))
        {
            DialogMessage = "Please fill in all required fields.";
            ShowEmptyFieldDialog = true;
            return;
        }

        if (string.IsNullOrWhiteSpace(EditModel.VehContact) || string.IsNullOrWhiteSpace(EditModel.VehContact))
        {
            DialogMessage = "Mobile no required";
            ShowEmptyFieldDialog = true;
            return;
        }
        if (string.IsNullOrWhiteSpace(EditModel.Vehntype) || string.IsNullOrWhiteSpace(EditModel.Vehntype))
        {
            EditModel.Vehntype = "";
        }
        if (string.IsNullOrWhiteSpace(EditModel.VehDriver) || string.IsNullOrWhiteSpace(EditModel.VehDriver))
        {
            DialogMessage = "Driver Name required";
            ShowEmptyFieldDialog = true;
            return;
        }
        await EmployeeService.Addveh(EditModel);
        ShowEmptyFieldDialogError = true;
        DialogMessage = "Vehicle saved successfully.";
        IsVehvisible = false;
        GetVehlist = await EmployeeService.GetallVeh();
        EditModel.Vehno = String.Empty;
        EditModel.Vehntype = String.Empty;
        EditModel.VehContact = String.Empty;
        EditModel.VehDriver = String.Empty;
    }


    private async Task HandleFocusOrder(FocusEventArgs e)
    {
        if (!isDropDownVisible)
        {
            isDropDownVisible = true;
        }

        if (!dataLoaded)
        {
            await Task.Delay(500); // Simulate async delay
            int unit = UserSessionService.UnitId;
            GetbyOrderList = await EmployeeService.GetAllOrderby(unit);

        }
    }



    private string selectedgroup;
    private string SelectedGrower;
    private async Task OnDropDownVisibleChangedOrder(bool isVisible)
    {
        if (isVisible)
        {
            await Task.Delay(500); // Simulate async data fetch

            int unit = UserSessionService.UnitId;
            GetbyOrderList = await EmployeeService.GetAllOrderby(unit);
            StateHasChanged();
        }
    }


    private void Addnewchallanproc()
    {
        if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            DialogMessage = "Please Select  valid Grower Group Name";
            ShowEmptyFieldDialog = true;
            return;

        }
        selectedgroup = EditModel.GrowerGroupName;
        if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
        {
            DialogMessage = "Please Select  valid Grower  Name";
            ShowEmptyFieldDialog = true;
            return;

        }
        SelectedGrower = EditModel.GrowerName;



        Addnewchallan = true;


    }


    private void AddNewSub()
    {
        if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            DialogMessage = "Please Select  valid Grower Group Name";
            ShowEmptyFieldDialog = true;
            return;

        }
        selectedgroup = EditModel.GrowerGroupName;




        AddSub = true;


    }



    private async void SaveNewSub()



    {

        EditModel.GrowerGroupName = selectedgroup;



        if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
        {
            DialogMessage = "Please Select  valid Grower  Name";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.GrowerAddress))
        {
            DialogMessage = "Please Select  valid Grower Address";
            ShowEmptyFieldDialog = true;
            return;

        }


        if (string.IsNullOrWhiteSpace(EditModel.GrowerContact))
        {
            DialogMessage = "Please Select  valid Grower Contact";
            ShowEmptyFieldDialog = true;
            return;

        }


        if (EditModel.GrowerCrateissue < 0)
        {

            DialogMessage = "Valid Crate issue qty is Required";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (EditModel.GrowerCratelimit < 0)
        {

            DialogMessage = "Valid Crate issue Limit percent is Required";
            ShowEmptyFieldDialog = true;
            return;

        }
        var result = await EmployeeService.AddGrowerSubdirect(EditModel);




        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {


            AddSub = false;

            EditModel.GrowerName = string.Empty;
            EditModel.GrowerAddress = string.Empty;
            EditModel.GrowerContact = string.Empty;
            EditModel.GrowerCrateissue = 0;
            EditModel.GrowerCratelimit = 0;
            StateHasChanged();


            return;
        }


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to Update grower group.";
            ShowEmptyFieldDialog = true;

            return;
        }









    }

    // private void AddNewSub()
    // {
    //     if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
    //     {
    //         DialogMessage = "Please Select  valid Grower Group Name";
    //         ShowEmptyFieldDialog = true;
    //         return;

    //     }
    //     selectedgroup = EditModel.GrowerGroupName;




    //     AddSub = true;


    // }



    private async void SaveNewChallan()



    {

        EditModel.GrowerGroupName = selectedgroup;



        if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
        {
            DialogMessage = "Please Select  valid Grower  Name";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.ChallanAddress))
        {
            DialogMessage = "Please Select  valid Grower Address";
            ShowEmptyFieldDialog = true;
            return;

        }


        if (string.IsNullOrWhiteSpace(EditModel.ChallanPhone1))
        {
            DialogMessage = "Please Select  valid Grower Contact";
            ShowEmptyFieldDialog = true;
            return;

        }


        var result = await EmployeeService.AddChallandirect(EditModel);




        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {


            AddSub = false;

            EditModel.GrowerName = string.Empty;
            EditModel.GrowerGroupName = string.Empty;
            EditModel.ChallanName = string.Empty;
            EditModel.ChallanPhone1 = string.Empty;
            EditModel.ChallanAddress= string.Empty;
            StateHasChanged();


            return;
        }


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to Update grower group.";
            ShowEmptyFieldDialog = true;

            return;
        }









    }

    private void AddNewVehicle()
    {
        // selectedGrowerId = growerId;
        IsVehvisible = true;


    }



    private void HideNewchallan()
    {
        // selectedGrowerId = growerId;
        Addnewchallan = true;


    }
    private void HideNewVehicle()
    {
        // selectedGrowerId = growerId;
        IsVehvisible = false;


    }


    private void HideNewsub()
    {
        // selectedGrowerId = growerId;
        AddSub = false;


    }

     private async void Deletelot(int tid)
    {
        selectedGrowerId = tid;

        DeleteDialoglot = true;



    }

    private async void DeleteGrower(int Trid)
    {
        selectedGrowerId = Trid;

        DeleteDialog = true;



    }
    private void ViewGrower(int growerId)
    {
        companyModel.Growerid = growerId;


        NavigationManager.NavigateTo($"/ViewGrower/{growerId}");

    }
    private async Task OnCountryChanged(string? newCountryId)
    {
        string selectedPurchase = "";
        selectedPurchase = newCountryId;




        EditModel.PurchGrp = selectedPurchase;
        GetItemGroup = await EmployeeService.GetItemNameByGroup(selectedPurchase);
        GetVehlist = await EmployeeService.GetallVeh();


    }


    private async Task OnGrowerGroupChanged(string? newCountryId)
    {














        string selectedPurchase = "";
        selectedPurchase = newCountryId;
        selectedDemand = newCountryId;
        companyModel = await EmployeeService.GetDemandGrower(selectedPurchase);
        EditModel.GrowerGroupName=companyModel.GrowerGroupName;





        GetDailyPreinward = await EmployeeService.GenerateLotDraftReportopen(Demandid, selectedPurchase);


        // StateHasChanged();



    }


    private int? GetNumberAfterSecondSlash(string input)
    {
        if (string.IsNullOrWhiteSpace(input))
            return null;

        // Split the string by slashes
        var parts = input.Split('/');
        if (parts.Length < 3)
            return null;

        // Get the part after the second slash and remove leading zeros
        var numberPart = parts[2].TrimStart('0');

        if (int.TryParse(numberPart, out int result))
            return result;

        return null;
    }

    private async Task OnSubgrowerChanged(string? newCountryId)
    {
        string selectedPurchase = newCountryId;
        GetChallanGroup.Clear();
        EditModel.ChallanName = String.Empty;
        StateHasChanged();

        string SelectedSubgrower = AvailGrower;
        // await JS.InvokeVoidAsync("alert",selectedPurchase);
        //          await JS.InvokeVoidAsync("alert",AvailGrower);

        if (!string.IsNullOrWhiteSpace(selectedPurchase) && !string.IsNullOrWhiteSpace(SelectedSubgrower))
        {
            EditModel.GrowerName = selectedPurchase;


            GetChallanGroup = await EmployeeService.GetChallanByGroup(selectedPurchase, SelectedSubgrower);

            GetCrateAnalysis = await EmployeeService.CheckCratesPartysub(selectedPurchase, SelectedSubgrower);
            selectedSubgrower = selectedPurchase;
            AvailableSubGrower = companyModel?.CrateAvailable ?? 0;
            ShowCrateAnalysis = true;
        }
        else
        {
            // Optionally reset related values
            ShowCrateAnalysis = false;
            AvailableSubGrower = 0;
        }

    }

    protected async Task GeneratePreview()
    {
        await JS.InvokeVoidAsync("window.open", "/Thermal", "_blank"); 

    }
    protected async Task CancelSave()
    {

        EditModel.ReceipeName = String.Empty;
        EditModel.ReceipeGrade = String.Empty;
        // EditModel.CrissueMark = String.Empty;

        EditModel.ReceipeQty = 0;
        EditModel.ReceipeLocation = String.Empty;

        ShowAdd=true;

        ShowEdit = false;

    }


    protected async Task GeneratePreviewbyid(int growerId)
    {


        // if  (EditModel.CrissueId <= 0)
        // {
        //     DialogMessage = "Please enter a valid idno greater than 0.";
        //     ShowEmptyFieldDialog = true;
        //     return;
        // }
        selectedGrowerId = growerId;
        //  selectedGrowerId = EditModel.CrissueId;

        await EmployeeService.GenerateCratePreview(selectedGrowerId,EditModel);

        // Report = XtraReport.FromFile(Path.Combine(Directory.GetCurrentDirectory(),
        //   @"Reports\CrateSlip.repx"));



        // showReport = true;

    }

    void OnKhataMarkChanged(string newValue)
    {
        // Check if the new value is not already in the data source
        EditModel.OrderBy = newValue;

        // Check if the value exists already
        if (!string.IsNullOrWhiteSpace(newValue) &&
            !GetbyOrderList.Any(x => x.OrderBy.Equals(newValue, StringComparison.OrdinalIgnoreCase)))
        {
            GetbyOrderList.Add(new CompanyModel { OrderBy = newValue });
        }
    }




    private void AddGrowerAgreement(int growerId)
    {
        companyModel.Growerid = growerId;


        NavigationManager.NavigateTo($"/EditGrowerAgreement/{growerId}");

    }






    private void ViewSubGrower(int growerId)
    {
        companyModel.Growerid = growerId;


        NavigationManager.NavigateTo($"/ViewSubGrower/{growerId}");

    }


    void OnCrissueMarkChanged(string newValue)
    {
        // Check if the new value is not already in the data source
        EditModel.CrissueMark = newValue;

        // Check if the value exists already
        if (!string.IsNullOrWhiteSpace(newValue) &&
            !GetCrateMark.Any(x => x.CrissueMark.Equals(newValue, StringComparison.OrdinalIgnoreCase)))
        {
            GetCrateMark.Add(new CompanyModel { CrissueMark = newValue });
        }
    }


    private void AddGrower(int growerId)
    {
        companyModel.Growerid = growerId;


        NavigationManager.NavigateTo($"/AddGrower");

    }
    private string selectedDemand;

    private async Task EditItem(object dataItem)
    {
        if (dataItem is CompanyModel companyModel)
        {
            // EditModel.TempGateInId = companyModel.TempGateInId;
            selectedGrowerId = companyModel.DraftIdentity;


            companyModel = await EmployeeService.DraftIdentity(selectedGrowerId);


            GetGstList = await EmployeeService.GetServicesfromAgreement(AvailGrower);
            EditModel.DraftIdentity = companyModel.DraftIdentity;
            EditModel.PalletId = companyModel.PalletId;
            EditModel.PalletName = companyModel.PalletName;
            EditModel.ReceipeName = companyModel.ReceipeName;
            EditModel.VarietyId = companyModel.VarietyId;
            EditModel.ReceipeQty = companyModel.ReceipeQty;
            EditModel.ReceipeMarka = companyModel.ReceipeMarka;
            EditModel.ReceipeLocation = companyModel.ReceipeLocation;
            EditModel.ReceipeGrade = companyModel.ReceipeGrade;
            EditModel.BoxBrand = companyModel.BoxBrand;

            ShowAdd = false;
            ShowEdit=true;

            // ShowOtherButtons = true;
            // ShowButtonAdd = false;

            StateHasChanged();









        }
    }

    // private async void EditGrower(int growerId)
    // {
    //     // selectedGrowerId=companyModel.Mid ;

    //     // companyModel = await EmployeeService.GetMasterName(companyModel.Mid);



    // }
    protected async Task OnConfirmYes()
    {


        companyModel.Itemid = selectedGrowerId;
        await EmployeeService.UpdateItemStatus(selectedGrowerId, companyModel);


        banks = await EmployeeService.GetallItemGroup();


        StateHasChanged();
        isDialogVisible = false;

    }


    protected async Task OnConfirmNoPost()
    {
        PostDialog = false;
        StateHasChanged();
    }

    protected async Task OnConfirmYesPost()
    {

        int wt=(int)EditModel.DraftWeight;

        var validationResult = await EmployeeService.CloseDraftDetails(EditModel, Demandid,wt);
        if (validationResult != null && validationResult.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = validationResult.RetMessage ?? "Action Failed.";
            ShowEmptyFieldDialog = true;

            return;
        }



        PostDialog = false;
        StateHasChanged();

        NavigationManager.NavigateTo($"/DraftMain");

        return;



















    }
    protected async Task OnConfirmYesUnpost()
    {


        // var validationResult = await EmployeeService.CloseDraftDetails(EditModel, Demandid);
        //           if (validationResult != null && validationResult.RetFlag.Trim() == "FALSE")
        //           {

        //               DialogMessage = validationResult.RetMessage ?? "Action Failed.";
        //               ShowEmptyFieldDialog = true;

        //               return;
        //           }



        //            NavigationManager.NavigateTo($"/DraftMain");

        isDialogVisible = false;
    }
    private string selectedValue = "Company";

    // Flag that will be true ONLY when "Both" is selected
    private bool isBothSelected = false;

    // private void OnCrValueChanged(string newValue)
    // {
    //     selectedValue = newValue;
    //     isBothSelected = (newValue == "Both");
    // }






    protected async Task OnConfirmYesDelete()
    {
        // if (EditModel.CrissueId <= 0)
        // {
        //     DialogMessage = "Please enter a valid Id No";
        //     ShowEmptyFieldDialog = true;
        //     return;
        // }

        var validationResult = await EmployeeService.ValidatePackingDraftpellet(selectedGrowerId, Demandid,companyModel);
        if (validationResult != null && validationResult.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = validationResult.RetMessage ?? "Action Failed.";
            ShowEmptyFieldDialog = true;

            return;
        }



        // await JS.InvokeVoidAsync("alert", selectedGrowerId);
        // await JS.InvokeVoidAsync("alert", selectedItemid);

        var result = await EmployeeService.DeletePalletId(selectedGrowerId, Demandid);
        GetpackingDraft = await EmployeeService.GetRepack(Demandid);


        DeleteDialog = false;












        StateHasChanged();
        isDialogVisible = false;
        return;

    }

    protected async Task OnConfirmYesGenerate()
    {



        var result = await EmployeeService.GeneratePreinward(EditModel);
        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {
            companyModel = await EmployeeService.GetPreinwardNo();

            EditModel.TempGateInIrn = companyModel.TempGateInIrn;


            EditModel.TempGateInId = companyModel.TempGateInId;
            PurDialog = false;
            // DialogMessage = result.RetMessage;
            // ShowEmptyFieldDialogError = true;
            // /// await Task.Delay(1000); 
            //  ShowEmptyFieldDialogError = false;

            //    StateHasChanged();
            // Close the delete confirmation dialog
            return;
        }



        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to Create Purchase Order.";
            ShowEmptyFieldDialog = true;
            PurDialog = false;
            return;
        }

















        StateHasChanged();
        isDialogVisible = false;

    }


     protected async Task OnNoDeletelot()
    {
        DeleteDialoglot = false;
    }



    protected async Task OnConfirmDeletelot()
    {
        

        var result = await EmployeeService.DeletePalletlot(selectedGrowerId, Demandid);
        GetpackingDraft = await EmployeeService.GetRepack(Demandid);


        DeleteDialoglot = false;

        GetDailyPreinwardtemp = await EmployeeService.GetDraft(Demandid);












        StateHasChanged();
        isDialogVisible = false;
        return;

    }







    private void OnConfirmNoDelete()
    {
        DeleteDialog = false;
    }






    private void ViewSubList(int growerId)
    {
        companyModel.Growerid = growerId;


        NavigationManager.NavigateTo($"/ViewSubGrower/{growerId}");

    }
    private async Task GoBack()
    {
        await JS.InvokeVoidAsync("history.back");
    }
    private void OnConfirmNoGenerate()
    {
        isDialogVisible = false;
    }


    private void OnConfirmNo()
    {
        isDialogVisible = false;
    }

    string GetRowCssClass(object dataItem, int visibleIndex)
    {
        return visibleIndex % 2 == 0 ? "even-row" : "odd-row";
    }

    private bool DeleteDialog = false;
    private bool PurDialog = false;
    private bool UnPostDialog = false;
    private bool PostDialog = false;
    private bool isDialogVisible = false;
    private int selectedGrowerId;
    private int selectedItemid;
    private string selectetGrowerGroup = null;
    private string selectedSubgrower = null;
    private decimal actualidqty = 0;
    private string Growerselect = null;
    private string selectedPurchaseGroup = null;
    private void ShowConfirmDialog(int GrowerId)
    {
        selectedGrowerId = GrowerId;
        isDialogVisible = true;


    }
    private void GoToAddGrowerPage()
    {
        NavigationManager.NavigateTo("/AddGrower");
    }






    void ChangeSearchMode(string key)
    {
        // CurrentSearchTextParseModeDisplayText = key;
        // CurrentSearchTextParseMode = SearchTextParseModes[key];
    }

    public void ShowDetails(int employeeId)
    {

    }
    public void ShowDetails1(string ename)
    {

    }
    public void ShowDetails2(string dept)
    {

    }
    // private string activeBreakpoint { get; set; }

    // // private List<Order> orders { get; set; }

    // private bool enableAdaptiveUIMode { get; set; }
    // private RowDirection renderingMode { get; set; }
    CompanyModel companyModel = new CompanyModel();
    IGrid MyGrid { get; set; }
    List<CompanyModel> Growers = new List<CompanyModel>();
    private HashSet<CompanyModel> selectedItems = new HashSet<CompanyModel>();
    private bool IsEmpty => selectedItems.Count == 0;
    List<CompanyModel> banks = new List<CompanyModel>();
    List<CompanyModel> GetGstList = new List<CompanyModel>();
    List<CompanyModel> GetUomList = new List<CompanyModel>();
    List<CompanyModel> GetItemGroup = new List<CompanyModel>();
    List<CompanyModel> GetOrderDetails = new List<CompanyModel>();
    List<CompanyModel> GetCrateAnalysis = new List<CompanyModel>();
    List<CompanyModel> GetMaxCrateId = new List<CompanyModel>();
    List<CompanyModel> GetKhata = new List<CompanyModel>();


    List<CompanyModel> GetbyOrderList = new List<CompanyModel>();
    List<CompanyModel> Purchaseorderscrn = new List<CompanyModel>();
    private async Task OnDropDownVisibleChanged(bool isVisible)
    {
        if (isVisible)
        {
            await Task.Delay(500); // Simulate async data fetch

            GetgrowerList = await EmployeeService.GetallGrowerlist();
            StateHasChanged(); // Force re-render
        }
    }



    private async Task OnDropDownLotsVisibleChanged(bool isVisible)
    {
        if (isVisible)
        {
            await Task.Delay(500); // Simulate async data fetch
            int unit = UserSessionService.UnitId;

            GetLots = await EmployeeService.GetLots(unit);
            StateHasChanged(); // Force re-render
        }
    }



    private async Task OnSubDropDownChanged(bool isVisible)
    {
        // Exit if dropdown is closing or EditModel is null
        if (!isVisible || EditModel == null)
            return;

        // Early exit if GrowerGroupName is null/empty (before any other logic)
        if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            return;
        }

        // Debug alert (remove in production)
        // await JS.InvokeVoidAsync("alert", EditModel.GrowerGroupName);

        string selectedPurchase = EditModel.GrowerGroupName.Trim();
        AvailGrower = selectedPurchase;

        await Task.Delay(500); // Simulate async data fetch

        GetSubGrowerGroup = await EmployeeService.GetSubGrowerByGroup(selectedPurchase);
        AvailGrower = selectedPurchase;

        StateHasChanged();
    }

    private async Task OnChallanDropDownChanged(bool isVisible)
    {
        // Early exit if dropdown is closing or required data is missing
        if (!isVisible ||
            EditModel == null ||
            string.IsNullOrWhiteSpace(EditModel.GrowerName) ||
            string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            return;
        }

        try
        {
            // Trim inputs to avoid whitespace issues
            var growerName = EditModel.GrowerName.Trim();
            var growerGroup = EditModel.GrowerGroupName.Trim();

            // Optional: Show loading indicator
            // isLoading = true;
            // StateHasChanged();

            await Task.Delay(500); // Remove in production (only for simulation)

            GetChallanGroup = await EmployeeService.GetChallanByGroup(growerName, growerGroup);
        }
        catch (Exception ex)
        {
            // Handle errors (log, show user message, etc.)
            Console.WriteLine($"Error loading challan data: {ex.Message}");

            // Optional: Reset dropdown on error
            // isDropDownVisible = false;
        }
        finally
        {
            // Optional: Hide loading indicator
            // isLoading = false;
            StateHasChanged(); // Update UI
        }
    }



    private async Task OnVehDropDownChanged(bool isVisible)
    {
        if (isVisible)
        {
            await Task.Delay(500); // Simulate async data fetch

            GetVehlist = await EmployeeService.GetallVeh();
            StateHasChanged(); // Force re-render
        }
    }


    private async Task HandleFocuslots(FocusEventArgs e)
    {
        if (!isDropDownVisible)
        {
            isDropDownVisible = true;
        }

        if (!dataLoaded)
        {
            await Task.Delay(500); // Simulate async delay
            int unit = UserSessionService.UnitId;

            GetLots = await EmployeeService.GetLots(unit);
        }
    }

    private async Task HandleFocus(FocusEventArgs e)
    {
        if (!isDropDownVisible)
        {
            isDropDownVisible = true;
        }

        if (!dataLoaded)
        {
            await Task.Delay(500); // Simulate async delay
            GetgrowerList = await EmployeeService.GetallGrowerlist();
        }
    }

    private async Task HandleFocusVeh(FocusEventArgs e)
    {
        if (!isDropDownVisible)
        {
            isDropDownVisible = true;
        }

        if (!dataLoaded)
        {
            await Task.Delay(500); // Simulate async delay
            GetVehlist = await EmployeeService.GetallVeh();
        }
    }


    private async Task HandleFocusSub(FocusEventArgs e)
    {
        // Early exit if EditModel or GrowerGroupName is invalid
        if (EditModel == null || string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            return;
        }

        // Only proceed if dropdown isn't already visible
        if (!isDropDownVisible)
        {
            isDropDownVisible = true;
        }

        // Load data only if not already loaded
        if (!dataLoaded)
        {
            try
            {
                await Task.Delay(500); // Simulate async delay
                GetSubGrowerGroup = await EmployeeService.GetSubGrowerByGroup(EditModel.GrowerGroupName.Trim());
                dataLoaded = true; // Remember to set this flag after successful load
            }
            catch (Exception ex)
            {
                // Handle errors (log, show message, etc.)
                Console.WriteLine($"Error loading sub-grower groups: {ex.Message}");
            }
        }
    }



    private async Task HandleFocusChallan(FocusEventArgs e)
    {
        // Early exit if EditModel or required fields are null/empty
        if (EditModel == null ||
            string.IsNullOrWhiteSpace(EditModel.GrowerName) ||
            string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            return;
        }

        // Only open dropdown if not already visible
        if (!isDropDownVisible)
        {
            isDropDownVisible = true;
        }

        // Load data only if not already loaded
        if (!dataLoaded)
        {
            try
            {
                await Task.Delay(500); // Simulate async delay (optional)

                // Trim inputs to avoid whitespace issues
                string growerName = EditModel.GrowerName.Trim();
                string growerGroup = EditModel.GrowerGroupName.Trim();

                GetChallanGroup = await EmployeeService.GetChallanByGroup(growerName, growerGroup);
                dataLoaded = true; // Mark data as loaded to prevent redundant calls
            }
            catch (Exception ex)
            {
                // Log error (or show user feedback)
                Console.WriteLine($"Error loading challan data: {ex.Message}");

                // Optional: Reset dropdown state on failure
                isDropDownVisible = false;
            }
        }
    }
    private bool isDropDownVisible = false;
    private bool dataLoaded = false;

    protected override async Task OnInitializedAsync()
    {


        isComboDisabled = true;

        ShowButtonAdd = true;


        ShowAddGrid = true;

        ShowAdd = true;
        ShowEdit=false;


        ShowButtonAdd = true;
        ShowOtherButtons = false;
        var userResult13 = await ProtectedLocalStore.GetAsync<string>("UserGroup");
        string GlobalUserGroup = userResult13.Success ? userResult13.Value : null;
        companyModel = await EmployeeService.GetPreinwardPriv(GlobalUserGroup);
        EditModel = await EmployeeService.GetDraftIdbyAsync(Demandid);
        AvailGrower = EditModel.GrowerGroupName;
        
        GetDailyPreinwardtemp = await EmployeeService.GetDraft(Demandid);

        banks = await EmployeeService.GetallQuality();
        Receipelist = await EmployeeService.GetallReceipe();
        Rgrades = await EmployeeService.Getallrecepegrades();

        GetallLocation = await EmployeeService.GetTemplocations();
        Boxlist = await EmployeeService.GetBox();
        Hcaselist = await EmployeeService.GetHcase();
        GetpackingDraft = await EmployeeService.GetRepack(Demandid);

        var checkedItems = GetpackingDraft.Where(x => !x.IsSelected).ToList();

        if (checkedItems.Any())


        {
            string result = GetpackingDraft.FirstOrDefault()?.VarietyId?.ToString() ?? "0";
            EditModel.VarietyId = result;
            isComboDisabled = false;
        }




    }



    private async Task HandleFocusDemand(FocusEventArgs e)
    {
        if (!isDropDownVisible)
        {
            isDropDownVisible = true;
        }

        if (!dataLoaded)
        {
            await Task.Delay(500); // Simulate async delay
            var Unitid = await ProtectedLocalStore.GetAsync<string>("Unitidno");


            int unit = Convert.ToInt32(Unitid.Value);
            DemandList = await EmployeeService.GetAllGrowerDemands(unit,AvailGrower);
        }
    }



    private async Task OnDropDownChangedDemand(bool isVisible)
    {
        if (isVisible)
        {
            await Task.Delay(500); // Simulate async data fetch

            var Unitid = await ProtectedLocalStore.GetAsync<string>("Unitidno");


            int unit = Convert.ToInt32(Unitid.Value);
            DemandList = await EmployeeService.GetAllGrowerDemands(unit, AvailGrower);
            StateHasChanged(); // Force re-render
        }
    }
    private async Task EditHandler(Employee employee)
    {
        // await Grid.SelectRowAsync(companyModel.chid);
        // await Grid.StartEditAsync();
    }


    private async Task DeleteHandler(Employee employee)
    {

    }

    protected async Task ViewOrder()
    {
        if (EditModel.PurchaseOrderId <= 0)
        {
            DialogMessage = "Please enter  valid Order No";
            ShowEmptyFieldDialog = true;
            return;
        }
        selectedGrowerId = EditModel.PurchaseOrderId;
        GetOrderDetails = await EmployeeService.GetPurchaseOrder(selectedGrowerId);

        companyModel = await EmployeeService.GetOrderhead(selectedGrowerId);
        EditModel.PurchaseOrderDated=companyModel.PurchaseOrderDated;
        EditModel.AccountName = companyModel.AccountName;
        EditModel.PurchaseOrderBillto = companyModel.PurchaseOrderBillto;
        EditModel.PurchaseOrderDel = companyModel.PurchaseOrderDel;
        EditModel.PurchaseOrderRemarks = companyModel.PurchaseOrderRemarks;






        StateHasChanged();
        return;



    }

    protected async Task ToggleUnit()
    {
        ShowOtherButtons = false;
        ShowButtonAdd = true;
    }


    protected async Task Showmat()
    {

        GetTotalReceipeQty= await EmployeeService.GetRecipeQty(Demandid);

        ShowModal = true;
    }


    protected async Task CloseDraft()
    {


        if (EditModel.DraftWeight <= 0)
        {
            DialogMessage = "Please enter  valid Draft Weight.";
            ShowEmptyFieldDialog = true;
            return;
        }
        ///  await JS.InvokeVoidAsync("alert",Demandid);
        var validationResult = await EmployeeService.VerifyDraft(EditModel, Demandid);
        if (validationResult != null && validationResult.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = validationResult.RetMessage ?? "Action Failed.";
            ShowEmptyFieldDialog = true;

            return;
        }


        selectedGrowerId = Demandid;

        PostDialog = true;

        StateHasChanged();


    }










     protected async Task SaveBox()
    {

        
        if (string.IsNullOrWhiteSpace(EditModel.HcaseName))
        {
            DialogMessage = "Please Select  valid Half Case Name";
            ShowEmptyFieldDialog = true;
            return;

        }

  
     if (string.IsNullOrWhiteSpace(EditModel.BoxName))
        {
            DialogMessage = "Please Select  valid Box  Name";
            ShowEmptyFieldDialog = true;
            return;

        }
    
        var result = await EmployeeService.AddBoxDetails(EditModel,Demandid);
    
            ShowBoxModal= false;
        StateHasChanged();
    
    }


    protected async Task SaveItem()
    {

        if (string.IsNullOrWhiteSpace(EditModel.PurchGrp))
        {
            DialogMessage = "Please Select  valid Purchase Group";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.PurchaseItemName))
        {
            DialogMessage = "Please Select  valid Item Group";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (string.IsNullOrWhiteSpace(EditModel.PurchaseOrderItemDescrip))
        {
            EditModel.PurchaseOrderItemDescrip = "";


        }


        if (!EditModel.PurchaseOrderqty.HasValue || EditModel.PurchaseOrderqty <= 0)
        {
            DialogMessage = "Please enter a valid quantity greater than 0.";
            ShowEmptyFieldDialog = true;
            return;
        }
        if (EditModel.PurchaseOrderId <= 0)
        {
            DialogMessage = "Please enter a valid Order No";
            ShowEmptyFieldDialog = true;
            return;
        }

        var result = await EmployeeService.AddPurchaseOrderItem(EditModel);
        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {
            DialogMessage = result.RetMessage;
            ShowEmptyFieldDialogError = true;


            companyModel = new CompanyModel();
            selectedGrowerId = EditModel.PurchaseOrderId;
            GetOrderDetails = await EmployeeService.GetPurchaseOrder(selectedGrowerId);

            StateHasChanged();
            return;
        }


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to add order item.";
            ShowEmptyFieldDialog = true;

            return;
        }




    }

    protected async Task UpdateTrid()
    {
        EditModel.GrowerGroupName = AvailGrower;
        EditModel.Trid = selectedGrowerId;
        if (string.IsNullOrWhiteSpace(EditModel.TempGateInIrn))
        {
            DialogMessage = "Please generate  valid Id";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            DialogMessage = "Please Select  valid Grower Group Name";
            ShowEmptyFieldDialog = true;
            return;

        }


        if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
        {
            DialogMessage = "Please Select  valid Grower  Name";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.ChallanName))
        {
            DialogMessage = "Please Select  valid Challan  Name";
            ShowEmptyFieldDialog = true;
            return;

        }


        if (string.IsNullOrWhiteSpace(EditModel.PreInwardKhata))
        {
            DialogMessage = "Please Select  valid Khata  Name";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (string.IsNullOrWhiteSpace(EditModel.Itemname))
        {
            DialogMessage = "Please Select  valid Item  Name";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (string.IsNullOrWhiteSpace(EditModel.ChallanNo))
        {
            DialogMessage = "Please Select  valid Challan  No";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.Vehno))
        {
            DialogMessage = "Please Select  valid Vehicle No";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.ServiceId))
        {
            DialogMessage = "Please Select  valid Scheme";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.VarietyId))
        {
            DialogMessage = "Please Select  valid Variety name";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (string.IsNullOrWhiteSpace(EditModel.PreInwardRemarks))
        {
            EditModel.PreInwardRemarks = "";

        }
        if (string.IsNullOrWhiteSpace(EditModel.PreCrateType))
        {
            DialogMessage = "Please Select  valid Crate Type";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (!EditModel.PreInwardQty.HasValue || EditModel.PreInwardQty <= 0)
        {
            DialogMessage = "Please enter a valid quantity greater than 0.";
            ShowEmptyFieldDialog = true;
            return;
        }
        if (EditModel.PreCrateType == "BOTH")
        {
            if (EditModel.OwnQty == 0 || EditModel.StoreQty == 0)
            {
                DialogMessage = "Invalid Qty for Both crate type option";
                ShowEmptyFieldDialog = true;
                return;
            }

            if (EditModel.PreCrateType == "BOTH")
            {



                decimal total = (EditModel.OwnQty ?? 0) + (EditModel.StoreQty ?? 0);

                if (total != EditModel.PreInwardQty)
                {
                    DialogMessage = "Invalid Qty for Both crate type option";
                    ShowEmptyFieldDialog = true;
                    return;
                }
            }

        }
        selectetGrowerGroup = EditModel.GrowerGroupName;
        var result = await EmployeeService.CheckChamberAllocation(selectetGrowerGroup);


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Error";
            ShowEmptyFieldDialog = true;

            return;
        }


        GetCrateAnalysis = await EmployeeService.CheckCratesAgreement(selectetGrowerGroup);


        companyModel = await EmployeeService.CheckInsertedQty(EditModel.TempGateInId);

        EditModel.TempInsertedQty = companyModel.TempInsertedQty;


        // decimal insertedQty = companyModel.TempInsertedQty ?? 0;

        //  decimal insertedQty2 = EditModel.TempInsertedQty ?? 0;

        AvailableBookQty = GetCrateAnalysis.FirstOrDefault()?.PrebookQty ?? 0;
        AvailableBookQty = AvailableBookQty + actualidqty;

        decimal TotalQty = (EditModel.PreInwardQty ?? 0) + (EditModel.TempInsertedQty ?? 0);





        if (TotalQty > AvailableBookQty)
        {
            DialogMessage = $"Entered quantity exceeds the available Booking Qty";
            ShowEmptyFieldDialog = true;

            return;
        }


        GetchamberAnalysis = await EmployeeService.CheckChamberStatus(selectetGrowerGroup);

        decimal ActiveChamberQty = GetchamberAnalysis.FirstOrDefault()?.ChamberAvailQty ?? 0;
        int Chamberid = GetchamberAnalysis.FirstOrDefault()?.ChamberId ?? 0;

        EditModel.ChamberId = Chamberid;
        EditModel.ChamberAvailQty = ActiveChamberQty+ actualidqty;


        if (TotalQty > EditModel.ChamberAvailQty)
        {
            DialogMessage = $"Entered quantity cannot exceed available Active Chamber ({Chamberid}) quantity ({ActiveChamberQty}).";
            ShowEmptyFieldDialog = true;
            return;
        }


        if (EditModel.PreCrateType == "OWN")
        {
            EditModel.OwnQty = EditModel.PreInwardQty;
            EditModel.StoreQty = 0;
        }

        if (EditModel.PreCrateType == "COMPANY")
        {
            EditModel.StoreQty = EditModel.PreInwardQty;
            EditModel.OwnQty = 0;
        }

        EditModel.GrowerGroupName = selectetGrowerGroup;



        var resultUpload = await EmployeeService.UpdateTrid(EditModel);
        if (resultUpload != null && resultUpload.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(resultUpload.RetMessage))
        {
            DialogMessage = resultUpload.RetMessage;
            ShowEmptyFieldDialogError = true;

            ShowCrateAnalysis = false;

            string CuserName = EditModel.GlobalUserName;
            GetDailyPreinwardtemp = await EmployeeService.GetDailyPreinwardProctemp(EditModel.TempGateInId);

            //
            // // GetCrateMark=await EmployeeService.GetallCrateMarks();
            //      companyModel = await EmployeeService.GetCrateOrderNo();
            // GrowerGroupKey = Guid.NewGuid().ToString();

            // EditModel.GrowerGroupName = String.Empty;
            // EditModel.ChallanName = String.Empty;
            // // EditModel.CrissueMark = String.Empty;
            // EditModel.PreInwardRemarks = "";
            EditModel.PreInwardQty = 0;
            EditModel.PreInwardKhata = String.Empty;
            EditModel.PreCrateType = String.Empty;
            // EditModel.GrowerName = String.Empty;
            EditModel.VarietyId = String.Empty;
            // EditModel.Itemname = String.Empty;
            // EditModel.ServiceId = String.Empty;
            //   EditModel.Prodname  = String.Empty;
            // EditModel.Vehno = String.Empty;
            //EditModel.PreInwardUom = String.Empty;


            // selectedSubgrower= String.Empty;
            ShowBoth = false;
            // Purchaseorders = await EmployeeService.GetCrateorders();
            // GetMaxCrateId = await EmployeeService.GetMaxCrateIdno();
            // int cid=0;
            // cid= GetMaxCrateId.FirstOrDefault()?.CrissueId ?? 0;
            // EditModel.CrissueId = cid;

            // await  GeneratePreviewbyid(EditModel.CrissueId);
            // StateHasChanged();
            return;
        }
    }

    protected async Task UpdateItem()
    {

        selectedItemid= EditModel.PurchaseOrderItemId;   
        //   await JS.InvokeVoidAsync("alert", selectedItemid);
        if (string.IsNullOrWhiteSpace(EditModel.PurchGrp))
        {
            DialogMessage = "Please Select  valid Purchase Group";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.PurchaseItemName))
        {
            DialogMessage = "Please Select  valid Item Group";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (string.IsNullOrWhiteSpace(EditModel.PurchaseOrderItemDescrip))
        {
            EditModel.PurchaseOrderItemDescrip = "";


        }


        if (!EditModel.PurchaseOrderqty.HasValue || EditModel.PurchaseOrderqty <= 0)
        {
            DialogMessage = "Please enter a valid quantity greater than 0.";
            ShowEmptyFieldDialog = true;
            return;
        }
        if (EditModel.PurchaseOrderId <= 0)
        {
            DialogMessage = "Please enter a valid Order No";
            ShowEmptyFieldDialog = true;
            return;
        }

        var result = await EmployeeService.UpdatePurchaseOrderItem(EditModel);
        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {
            DialogMessage = result.RetMessage;
            ShowEmptyFieldDialogError = true;


            companyModel = new CompanyModel();
            selectedGrowerId = EditModel.PurchaseOrderId;
            GetOrderDetails = await EmployeeService.GetPurchaseOrder(selectedGrowerId);

            StateHasChanged();
            return;
        }


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to add order item.";
            ShowEmptyFieldDialog = true;

            return;
        }




    }





    protected async Task  SearchCrates()


    {
        DateTime DateFrom = EditModel.CrateDatefrom ?? DateTime.Now;
        DateTime Dateto = EditModel.CrateDateto ?? DateTime.Now;

        GetDailyCrates=await EmployeeService.GetDailyCratesProcBydate(DateFrom,Dateto);

    }

    private int? GetNumberBeforeHyphen(string input)
    {
        if (string.IsNullOrWhiteSpace(input))
            return null;

        var match = Regex.Match(input, @"^0*(\d+)-");
        if (!match.Success)
            return null;

        if (int.TryParse(match.Groups[1].Value, out int result))
            return result;

        return null;
    }




    protected async Task SearchLots()


    {

        if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            companyModel.Partyid = 0;
        }
        else
        {
            var partyId = GetNumberBeforeHyphen(EditModel.GrowerGroupName);
            companyModel.Partyid = partyId.HasValue ? partyId.Value : 0;
        }



        if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
        {
            companyModel.Growerid = 0;
        }
        else
        {
            var subPartyId = GetNumberBeforeHyphen(EditModel.GrowerName);
            companyModel.Growerid = subPartyId.HasValue ? subPartyId.Value : 0;

        }


        if (string.IsNullOrWhiteSpace(EditModel.LotIrn))
        {
            companyModel.LotIrn = "PAX2";
        }


        if (string.IsNullOrWhiteSpace(EditModel.ChamberName))
        {
            companyModel.ChamberName = "PAX2";
        }



        if (string.IsNullOrWhiteSpace(EditModel.VarietyId))
        {
            companyModel.VarietyId = "PAX2";
        }


        EditModel.Partyid = companyModel.Partyid;
        EditModel.Growerid = companyModel.Growerid;
        EditModel.LotIrn = selectedIrn;
        //  await JS.InvokeVoidAsync("alert",  EditModel.LotIrn);
        int unit = UserSessionService.UnitId;
        if (EditModel.TempOrderId == 0)
        {

            GetDailyPreinward = await EmployeeService.GenerateLotReport(EditModel, unit);
        }
        else
        {
            int tempid= EditModel.TempOrderId;

            GetDailyPreinward = await EmployeeService.GenerateLotReportwithtemp(EditModel, unit,tempid);


        }



    }



    private bool isProcessing = false;

    async Task SaveUnit()
    {
        if (isProcessing) return;
        isProcessing = true;

        try 


        {
            EditModel.DemandIrn=selectedDemand;

            if (string.IsNullOrWhiteSpace(EditModel.VarietyId))
            {
                DialogMessage = "Please select valid variety Name";
                ShowEmptyFieldDialog = true;
                return;

            }


            // if (string.IsNullOrWhiteSpace(EditModel.BoxBrand))
            // {
            //     DialogMessage = "Please select valid Box Brand Name";
            //     ShowEmptyFieldDialog = true;
            //     return;

            // }
            if (string.IsNullOrWhiteSpace(EditModel.ReceipeName))
            {
                DialogMessage = "Please select valid Receipe Name";
                ShowEmptyFieldDialog = true;
                return;

            }
            if (string.IsNullOrWhiteSpace(EditModel.ReceipeMarka))
            {
                DialogMessage = "Please select valid Marka Name";
                ShowEmptyFieldDialog = true;
                return;

            }
            if (EditModel.ReceipeQty <= 0)
            {
                DialogMessage = "Please enter a valid quantity greater than 0.";
                ShowEmptyFieldDialog = true;
                return;
            }


            if (EditModel.ReceipeQty >80)
            {
                DialogMessage = "Please enter a valid quantity less than 80.";
                ShowEmptyFieldDialog = true;
                return;
            }


            if (string.IsNullOrWhiteSpace(EditModel.ReceipeLocation))
            {
                DialogMessage = "Please select valid Receipe Location";
                ShowEmptyFieldDialog = true;
                return;

            }



            if (string.IsNullOrWhiteSpace(EditModel.ReceipeGrade))
            {
                DialogMessage = "Please select valid Receipe Grade";
                ShowEmptyFieldDialog = true;
                return;

            }


            if (EditModel.ReceipeQty < 0)
            {

                DialogMessage = "Valid ReceipeQty required";
                ShowEmptyFieldDialog = true;
                return;
            }

            int draftid=Demandid;
            EditModel.DraftId = draftid;

            var validationResult = await EmployeeService.ValidatePackingDraft(EditModel);
            if (validationResult != null && validationResult.RetFlag.Trim() == "FALSE")
            {

                DialogMessage = validationResult.RetMessage ?? "Action Failed.";
                ShowEmptyFieldDialog = true;

                return;
            }

















            // var validationResultnew = await EmployeeService.ValidateDraftQty(companyModel);
            // if (validationResultnew != null && validationResultnew.RetFlag.Trim() == "FALSE")
            // {

            //     DialogMessage = validationResultnew.RetMessage ?? "Action Failed.";
            //     ShowEmptyFieldDialog = true;

            //     return;
            // }









            var userResult13 = await ProtectedLocalStore.GetAsync<string>("UserGroup");


            string GlobalUserGroup = userResult13.Success ? userResult13.Value : null;
            var userName = await ProtectedLocalStore.GetAsync<string>("Username");

            string cusername = userName.Success ? userName.Value : null;

            var Unitid = await ProtectedLocalStore.GetAsync<string>("Unitidno");


            EditModel.GlobalUserName = cusername;   
            EditModel.GlobalUnitId= Convert.ToInt32(Unitid.Value);



            int selecteddraftid;
            selecteddraftid = Demandid;

            int selectedId = Demandid;

            int unit = UserSessionService.UnitId;


            EditModel.DraftId = Demandid;

            EditModel.GlobalUnitId = unit;



            //     EditModel.Lotno = item.Lotno;

            //     EditModel.GradingQty = item.GradingQty;
            //      EditModel.DemandNo = item.DemandNo;
            //     EditModel.DraftId = Demandid;





            await EmployeeService.AddDraftitem(EditModel);
            isComboDisabled = false;
            StateHasChanged();
            GetpackingDraft = await EmployeeService.GetRepack(Demandid);

            EditModel.ReceipeName = String.Empty;
            EditModel.ReceipeGrade = String.Empty;
            // EditModel.CrissueMark = String.Empty;

            EditModel.ReceipeQty = 0;
            EditModel.ReceipeLocation = String.Empty;






            return;













            selectetGrowerGroup=EditModel.GrowerGroupName;
            var result = await EmployeeService.AddFinalDraft(EditModel);

            NavigationManager.NavigateTo($"/DraftMain");
            if (result != null && result.RetFlag.Trim() == "FALSE")
            {

                DialogMessage = result.RetMessage ?? "Error";
                ShowEmptyFieldDialog = true;

                return;
            }












        }
        finally
        {
            isProcessing = false;
        }
    }


    async Task UpdateUnit()
    {
        if (isProcessing) return;
        isProcessing = true;

        try


        {
            EditModel.DemandIrn = selectedDemand;

            if (string.IsNullOrWhiteSpace(EditModel.VarietyId))
            {
                DialogMessage = "Please select valid variety Name";
                ShowEmptyFieldDialog = true;
                return;

            }
            if (string.IsNullOrWhiteSpace(EditModel.ReceipeName))
            {
                DialogMessage = "Please select valid Receipe Name";
                ShowEmptyFieldDialog = true;
                return;

            }
            if (string.IsNullOrWhiteSpace(EditModel.ReceipeMarka))
            {
                DialogMessage = "Please select valid Marka Name";
                ShowEmptyFieldDialog = true;
                return;

            }


         

            if (EditModel.ReceipeQty <= 0)
            {
                DialogMessage = "Please enter a valid quantity greater than 0.";
                ShowEmptyFieldDialog = true;
                return;
            }


            if (EditModel.ReceipeQty > 80)
            {
                DialogMessage = "Please enter a valid quantity less than 80.";
                ShowEmptyFieldDialog = true;
                return;
            }
            if (string.IsNullOrWhiteSpace(EditModel.ReceipeLocation))
            {
                DialogMessage = "Please select valid Receipe Location";
                ShowEmptyFieldDialog = true;
                return;

            }



            if (string.IsNullOrWhiteSpace(EditModel.ReceipeGrade))
            {
                DialogMessage = "Please select valid Receipe Grade";
                ShowEmptyFieldDialog = true;
                return;

            }


            if (EditModel.ReceipeQty < 0)
            {

                DialogMessage = "Valid ReceipeQty required";
                ShowEmptyFieldDialog = true;
                return;
            }

            int draftid = Demandid;
            EditModel.DraftId = draftid;

            var validationResult = await EmployeeService.ValidatePackingDraft(EditModel);
            if (validationResult != null && validationResult.RetFlag.Trim() == "FALSE")
            {

                DialogMessage = validationResult.RetMessage ?? "Action Failed.";
                ShowEmptyFieldDialog = true;

                return;
            }

















            // var validationResultnew = await EmployeeService.ValidateDraftQty(companyModel);
            // if (validationResultnew != null && validationResultnew.RetFlag.Trim() == "FALSE")
            // {

            //     DialogMessage = validationResultnew.RetMessage ?? "Action Failed.";
            //     ShowEmptyFieldDialog = true;

            //     return;
            // }









            var userResult13 = await ProtectedLocalStore.GetAsync<string>("UserGroup");


            string GlobalUserGroup = userResult13.Success ? userResult13.Value : null;
            var userName = await ProtectedLocalStore.GetAsync<string>("Username");

            string cusername = userName.Success ? userName.Value : null;

            var Unitid = await ProtectedLocalStore.GetAsync<string>("Unitidno");


            EditModel.GlobalUserName = cusername;
            EditModel.GlobalUnitId = Convert.ToInt32(Unitid.Value);



            int selecteddraftid;
            selecteddraftid = Demandid;

            int selectedId = Demandid;

            int unit = UserSessionService.UnitId;


            EditModel.DraftId = Demandid;

            EditModel.GlobalUnitId = unit;



            //     EditModel.Lotno = item.Lotno;

            //     EditModel.GradingQty = item.GradingQty;
            //      EditModel.DemandNo = item.DemandNo;
            //     EditModel.DraftId = Demandid;

            var result2 = await EmployeeService.UpdateDraftitem(EditModel);
           

      
            if (result2 != null && result2.RetFlag.Trim() == "FALSE")
            {

                DialogMessage = result2.RetMessage ?? "Error";
                ShowEmptyFieldDialog = true;

                return;
            }



         
         
            
            isComboDisabled = false;
            StateHasChanged();
            GetpackingDraft = await EmployeeService.GetRepack(Demandid);

            EditModel.ReceipeName = String.Empty;
            EditModel.ReceipeGrade = String.Empty;
            // EditModel.CrissueMark = String.Empty;
            EditModel.BoxBrand = String.Empty;

            EditModel.ReceipeQty = 0;
            EditModel.ReceipeLocation = String.Empty;

            ShowAdd=true;
            ShowEdit = false;




            return;













            selectetGrowerGroup = EditModel.GrowerGroupName;
            var result = await EmployeeService.AddFinalDraft(EditModel);

            NavigationManager.NavigateTo($"/DraftMain");
            if (result != null && result.RetFlag.Trim() == "FALSE")
            {

                DialogMessage = result.RetMessage ?? "Error";
                ShowEmptyFieldDialog = true;

                return;
            }












        }
        finally
        {
            isProcessing = false;
        }
    }









    async Task SaveLot()
    {
        if (isProcessing) return;
        isProcessing = true;

        try


        {


            if (IsEmpty)
            {
                await JS.InvokeVoidAsync("alert", "Please select atleast one Lot");
                return;
            }





            if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
            {
                GetgrowerList = await EmployeeService.GetallGrowerlist();
                EditModel.GrowerGroupName = SelectGrower;
                isComboDisabled = false;
                StateHasChanged();

            }

            if (EditModel.TempOrderId == 0)
            {



                var result1 = await EmployeeService.GeneratePreDemand(EditModel);
                if (result1 != null && result1.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result1.RetMessage))
                {
                    companyModel = await EmployeeService.GetPreDemandNo();
                    //  await JS.InvokeVoidAsync("alert", companyModel.TempOrderId);
                    EditModel.TempOrderId = companyModel.TempOrderId;

                    StateHasChanged();


                }
            }


            var checkedItems = GetDailyPreinward.Where(x => x.IsSelected).ToList();

            if (!checkedItems.Any())
            {
                Console.WriteLine("No items selected");
                return;
            }

            // Add all checked items to database using ADO.NET
            int tempid = EditModel.TempOrderId;
            await EmployeeService.AddCheckedItemsToDatabase(checkedItems, tempid);
            int unit = UserSessionService.UnitId;
            GetDailyPreinwardtemp = await EmployeeService.GenerateTempLotReport(EditModel, unit, tempid);
            isComboDisabled = false;

            ShowAddGrid = true;
            GetDailyPreinward = await EmployeeService.GenerateLotReportwithtemp(EditModel, unit, tempid);


        }
        finally
        {
            isProcessing = false;
        }
    }




    async Task UploadSachet()
    {
        if (isProcessing) return;
        isProcessing = true;

        try


        {
            var checkedItems = GetTotalReceipeQty.Where(x => x.IsSelected).ToList();


       

            if (!checkedItems.Any())
            {
                DialogMessage = "Please select at least  one item";
                ShowEmptyFieldDialog = true;
                return;
            }

        
            foreach (var item in checkedItems)
            {
                companyModel = new CompanyModel();

                companyModel.ReceipeId = item.ReceipeId;
                companyModel.DraftId = Demandid;
                companyModel.SachetQty = item.SachetQty;
                companyModel.SachetQty = item.TotalReceipeQty;

                var validationResult = await EmployeeService.ValidateSachetEditQty(companyModel);
                if (validationResult != null && validationResult.RetFlag.Trim() == "FALSE")
                {

                    DialogMessage = validationResult.RetMessage ?? "Action Failed.";
                    ShowEmptyFieldDialog = true;

                    return;
                }



            }
        


            foreach (var item in checkedItems)
            {
                EditModel.DraftId = Demandid;


                EditModel.ReceipeId = item.ReceipeId;

                EditModel.SachetQty = item.SachetQty;


                await EmployeeService.UpdateSachetQty(EditModel);

            }



           



            EditModel.DraftId = Demandid;
            var result = await EmployeeService.UpdateFinalSachet(EditModel);
 ShowModal = false;
            if (result != null && result.RetFlag.Trim() == "FALSE")
            {

                DialogMessage = result.RetMessage ?? "Error";
                ShowEmptyFieldDialog = true;

                return;
            }

        }
        finally
        {
            isProcessing = false;
        }
    }











    protected async Task PostOrder()
    {
        if (EditModel.PurchaseOrderId <= 0)
        {
            DialogMessage = "Please enter a valid Order No";
            ShowEmptyFieldDialog = true;
            return;
        }
        selectedGrowerId = EditModel.PurchaseOrderId;
        companyModel = await EmployeeService.CheckPurchaseOrder(selectedGrowerId);


        string Orderstat = companyModel.PurchaseOrderStatus;

        if (Orderstat== "POST")
        {
            DialogMessage = "Order is already Posted";
            ShowEmptyFieldDialog = true;
            return;
        }

        if (Orderstat == "UNPOST")
        {

            PostDialog = true;
            return;
        }


    }
    protected async Task UnpostOrder()
    {
        if (EditModel.PurchaseOrderId <= 0)
        {
            DialogMessage = "Please enter a valid Order No";
            ShowEmptyFieldDialog = true;
            return;
        }
        selectedGrowerId = EditModel.PurchaseOrderId;
        companyModel = await EmployeeService.CheckPurchaseOrder(selectedGrowerId);


        string Orderstat = companyModel.PurchaseOrderStatus;

        if (Orderstat == "UNPOST")
        {
            DialogMessage = "Order is not Posted";
            ShowEmptyFieldDialog = true;
            return;
        }

        if (Orderstat == "POST")
        {

            UnPostDialog = true;
            return;
        }


    }
    protected async Task CreatePrin()
    {
        EditModel.GrowerGroupName = AvailGrower;
        if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            DialogMessage = "Please Select  valid Grower Group Name";
            ShowEmptyFieldDialog = true;
            return;

        }


        if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
        {
            DialogMessage = "Please Select  valid Grower  Name";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.ChallanName))
        {
            DialogMessage = "Please Select  valid Challan  Name";
            ShowEmptyFieldDialog = true;
            return;

        }



        if (string.IsNullOrWhiteSpace(EditModel.ChallanNo))
        {
            DialogMessage = "Please Select  valid Challan  No";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.Vehno))
        {
            DialogMessage = "Please Select  valid Vehicle No";
            ShowEmptyFieldDialog = true;
            return;

        }




        if (string.IsNullOrWhiteSpace(EditModel.PreInwardRemarks))
        {
            EditModel.PreInwardRemarks = "";

        }

        selectetGrowerGroup = EditModel.GrowerGroupName;
        var result = await EmployeeService.CheckChamberAllocation(selectetGrowerGroup);


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Error";
            ShowEmptyFieldDialog = true;

            return;
        }








        PurDialog = true;




        // selectetGrowerGroup = EditModel.GrowerGroupName;
        // var result = await EmployeeService.CheckChamberAllocation(selectetGrowerGroup);


    }
    

    async Task PostPrn()
    {
        if (isProcessing) return;
        isProcessing = true;

        try


        {
            EditModel.GrowerGroupName = AvailGrower;

            if (string.IsNullOrWhiteSpace(EditModel.TempGateInIrn))
            {
                DialogMessage = "Please generate  valid Id";
                ShowEmptyFieldDialog = true;
                return;

            }

            if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
            {
                DialogMessage = "Please Select  valid Grower Group Name";
                ShowEmptyFieldDialog = true;
                return;

            }


            if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
            {
                DialogMessage = "Please Select  valid Grower  Name";
                ShowEmptyFieldDialog = true;
                return;

            }

            if (string.IsNullOrWhiteSpace(EditModel.ChallanName))
            {
                DialogMessage = "Please Select  valid Challan  Name";
                ShowEmptyFieldDialog = true;
                return;

            }




            if (string.IsNullOrWhiteSpace(EditModel.ChallanNo))
            {
                DialogMessage = "Please Select  valid Challan  No";
                ShowEmptyFieldDialog = true;
                return;

            }

            if (string.IsNullOrWhiteSpace(EditModel.Vehno))
            {
                DialogMessage = "Please Select  valid Vehicle No";
                ShowEmptyFieldDialog = true;
                return;

            }

            if (string.IsNullOrWhiteSpace(EditModel.PreInwardRemarks))
            {
                EditModel.PreInwardRemarks = "";

            }
            selectetGrowerGroup = EditModel.GrowerGroupName;



            var result = await EmployeeService.CheckChamberAllocation(selectetGrowerGroup);


            if (result != null && result.RetFlag.Trim() == "FALSE")
            {

                DialogMessage = result.RetMessage ?? "Error";
                ShowEmptyFieldDialog = true;

                return;
            }


            GetCrateAnalysis = await EmployeeService.CheckCratesAgreement(selectetGrowerGroup);


            companyModel = await EmployeeService.CheckInsertedQty(EditModel.TempGateInId);

            EditModel.TempInsertedQty = companyModel.TempInsertedQty;

            if (EditModel.TempInsertedQty == 0)
            {
                DialogMessage = "Please enter one item with qty";
                ShowEmptyFieldDialog = true;
                return;
            }

            AvailableBookQty = GetCrateAnalysis.FirstOrDefault()?.PrebookQty ?? 0;


            decimal TotalQty = (EditModel.PreInwardQty ?? 0) + (EditModel.TempInsertedQty ?? 0);





            if (TotalQty > AvailableBookQty)
            {
                DialogMessage = $"Entered quantity exceeds the available Booking Qty";
                ShowEmptyFieldDialog = true;

                return;
            }


            GetchamberAnalysis = await EmployeeService.CheckChamberStatus(selectetGrowerGroup);

            decimal ActiveChamberQty = GetchamberAnalysis.FirstOrDefault()?.ChamberAvailQty ?? 0;
            int Chamberid = GetchamberAnalysis.FirstOrDefault()?.ChamberId ?? 0;

            EditModel.ChamberId = Chamberid;
            EditModel.ChamberAvailQty = ActiveChamberQty;


            if (TotalQty > EditModel.ChamberAvailQty)
            {
                DialogMessage = $"Entered quantity cannot exceed available Active Chamber ({Chamberid}) quantity ({ActiveChamberQty}).";
                ShowEmptyFieldDialog = true;
                return;
            }



            EditModel.GrowerGroupName = selectetGrowerGroup;



            var resultUpload = await EmployeeService.PostPrn(EditModel);
            if (resultUpload != null && resultUpload.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(resultUpload.RetMessage))
            {
                await JS.InvokeVoidAsync("window.open", "/Thermal", "_blank");

                ShowCrateAnalysis = false;

                string CuserName = EditModel.GlobalUserName;
                dismissTimer = new System.Timers.Timer(3000); // 3 seconds
                dismissTimer.Elapsed += (sender, e) =>
                {
                    // This will run on a different thread, so we need to use InvokeAsync
                    InvokeAsync(() =>
                    {
                        ShowEmptyFieldDialogError = false;
                        StateHasChanged();
                        dismissTimer.Dispose();
                    });
                };
                    
                    
                    //   GetDailyPreinwardtemp = await EmployeeService.GetDailyPreinwardProctemp(EditModel.TempGateInId);

                    //
                    // // GetCrateMark=await EmployeeService.GetallCrateMarks();
                    //      companyModel = await EmployeeService.GetCrateOrderNo();
                    // GrowerGroupKey = Guid.NewGuid().ToString();

                    EditModel.GrowerGroupName = String.Empty;
                    EditModel.ChallanName = String.Empty;
                    // EditModel.CrissueMark = String.Empty;
                    EditModel.PreInwardRemarks = "";
                    EditModel.PreInwardQty = 0;
                    EditModel.PreInwardKhata = String.Empty;
                    EditModel.PreCrateType = String.Empty;
                    EditModel.GrowerName = String.Empty;
                    EditModel.VarietyId = String.Empty;
                    EditModel.Itemname = String.Empty;
                    EditModel.ServiceId = String.Empty;
                      EditModel.Prodname  = String.Empty;
                    EditModel.Vehno = String.Empty;
                EditModel.TempGateInIrn = String.Empty;
                    EditModel.PreInwardUom = String.Empty;
                ShowOtherButtons = false;
                ShowButtonAdd = true;

         

                    // selectedSubgrower= String.Empty;
                    ShowBoth = false;
                    // Purchaseorders = await EmployeeService.GetCrateorders();
                    // GetMaxCrateId = await EmployeeService.GetMaxCrateIdno();
                    // int cid=0;
                    // cid= GetMaxCrateId.FirstOrDefault()?.CrissueId ?? 0;
                    // EditModel.CrissueId = cid;

                    // await  GeneratePreviewbyid(EditModel.CrissueId);
                    // StateHasChanged();
                    return;
                }


                if (resultUpload != null && resultUpload.RetFlag.Trim() == "FALSE")
                {

                    DialogMessage = resultUpload.RetMessage ?? "Failed to add Master Group.";
                    ShowEmptyFieldDialog = true;

                    return;
                }


            }
            finally
            {
                isProcessing = false;
            }
    
    }



    protected async Task UpdateCrateIssue()
    {

      //  EditModel.GrowerGroupName = AvailGrower;

        selectedGrowerId = EditModel.CrissueId;
        if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            DialogMessage = "Please Select  valid Grower Group Name";
            ShowEmptyFieldDialog = true;
            return;

        }

        if  (EditModel.CrissueId <= 0)
        {
            DialogMessage = "Please enter a valid idno greater than 0.";
            ShowEmptyFieldDialog = true;
            return;
        }

        if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
        {
            DialogMessage = "Please Select  valid Grower  Name";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.ChallanName))
        {
            DialogMessage = "Please Select  valid Challan  Name";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.CrissueMark))
        {
            DialogMessage = "Please Select  valid Crate  Mark";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.Vehno))
        {
            DialogMessage = "Please Select  valid Vehicle No";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (string.IsNullOrWhiteSpace(EditModel.CrissueRemarks))
        {
            EditModel.CrissueRemarks = "";

        }

        if (!EditModel.CrissueQty.HasValue || EditModel.CrissueQty <= 0)
        {
            DialogMessage = "Please enter a valid quantity greater than 0.";
            ShowEmptyFieldDialog = true;
            return;
        }

        selectetGrowerGroup=EditModel.GrowerGroupName;
        GetCrateAnalysis = await EmployeeService.CheckCratesParty(selectetGrowerGroup);
        decimal GrowerAvail = GetCrateAnalysis.FirstOrDefault()?.CrateAvailable ?? 0;
        GrowerAvail = GrowerAvail + actualidqty;

        if (EditModel.CrissueQty > GrowerAvail)
        {
            DialogMessage = $"Entered quantity cannot exceed available grower group quantity ({GrowerAvail}).";
            ShowEmptyFieldDialog = true;
            return;
        }


        selectedSubgrower=EditModel.GrowerName;
        GetCrateAnalysis = await EmployeeService.CheckCratesPartysub(selectedSubgrower,selectetGrowerGroup);

        decimal SubGrowerAvail = GetCrateAnalysis.FirstOrDefault()?.CrateAvailable ?? 0;
        SubGrowerAvail = SubGrowerAvail + actualidqty;


        if (EditModel.CrissueQty > SubGrowerAvail)
        {
            DialogMessage = $"Entered quantity cannot exceed available grower quantity ({SubGrowerAvail}).";
            ShowEmptyFieldDialog = true;
            return;
        }

       
        var result = await EmployeeService.UpdateCrateIssue(EditModel);
        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {
            DialogMessage = result.RetMessage;
            ShowEmptyFieldDialogError = true;

            ShowCrateAnalysis = false;



            GetDailyCrates=await EmployeeService.GetDailyCratesProc();

            //      //  
            //      // // GetCrateMark=await EmployeeService.GetallCrateMarks();
            //      //      companyModel = await EmployeeService.GetCrateOrderNo();
            //GrowerGroupKey = Guid.NewGuid().ToString();
        
            EditModel.GrowerGroupName = String.Empty;
            EditModel.ChallanName = String.Empty;
           // EditModel.CrissueMark = String.Empty;
            EditModel.CrissueRemarks = "";
             EditModel.CrissueQty = 0;
             EditModel.CrissueMark = String.Empty;
             EditModel.Vehno = String.Empty;
               EditModel.GrowerName = String.Empty;
               selectedSubgrower= String.Empty;
               Purchaseorders = await EmployeeService.GetCrateorders();
               companyModel = await EmployeeService.GetCrateOrderNo();
            StateHasChanged();
            return;
        }


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to add Master Group.";
            ShowEmptyFieldDialog = true;

            return;
        }




        






    }



    void Grid_CustomizeElement(GridCustomizeElementEventArgs e)
    {
        if (e.ElementType == GridElementType.DataRow && e.VisibleIndex % 2 == 1)
        {
            e.CssClass = "alt-item";
        }
        if (e.ElementType == GridElementType.HeaderCell)
        {
            e.Style = "background-color: var(--DS-color-surface-neutral-default-selected)";
            e.CssClass = "header-bold";
        }


    }


    public class Order
    {
        public int? OrderID { get; set; }
        public string CustomerID { get; set; }
        public DateTime? OrderDate { get; set; }
        public double? Freight { get; set; }
    }
}
}