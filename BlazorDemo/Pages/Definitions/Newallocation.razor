@page "/Newallocation"
@inject ProtectedLocalStorage ProtectedLocalStore
@using DevExpress.XtraReports.UI
@using DevExpress.Blazor.Reporting
@using Microsoft.AspNetCore.Components.Web
@using System.IO
@inject EmployeeAdoNetService EmployeeService
@using BlazorDemo.Pages.Definitions;
@using BlazorDemo.Services;
@using BlazorDemo;

@inject IJSRuntime JS
@inject NavigationManager NavigationManager
<link href="_content/DevExpress.Blazor.Themes/blazing-berry.bs5.min.css" rel="stylesheet" />
<link rel="stylesheet" href="_content/DevExpress.Blazor.Reporting.Viewer/css/dx-blazor-reporting-components.bs5.css">




<div class="chambers-container">
    <div class="row">
        @foreach (var chamber in Chamberlist)
        {
            <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12 mb-4">
                <div class="chamber-card @chamber.CardColorClass @chamber.TextColorClass">
                    <div class="card-header">
                        <h5>@chamber.Name</h5>
                        <span class="status-badge">@chamber.Status</span>
                    </div>
                    <div class="card-body">
                        <div class="qty-info">
                            <div class="qty-item">
                                <label>Total Capacity:</label>
                                <span class="value">@chamber.Capacity</span>
                            </div>
                            <div class="qty-item">
                                <label>Allocated Qty:</label>
                                <span class="value allocated">@chamber.AllocatedQty</span>
                            </div>
                            <div class="qty-item">
                                <label>Remaining Qty:</label>
                                <span class="value remaining">@chamber.RemainingQty</span>
                            </div>
                            <div class="qty-item">
                                <label>Available Qty:</label>
                                <span class="value available">@chamber.AvailableQty</span>
                            </div>
                            <div class="qty-item">
                                <label>Utilization:</label>
                                <span class="value">@chamber.UtilizationRate.ToString("P0")</span>
                            </div>
                        </div>

                        <!-- Utilization Progress Bar -->
                        <div class="progress-section">
                            <label>Capacity Utilization</label>
                            <DxProgressBar Value="@(chamber.UtilizationRate * 100)"
                                           Height="15px"
                                           CssClass="utilization-progress" />
                            <div class="progress-stats">
                                <span>Used: @chamber.AllocatedQty</span>
                                <span>Free: @chamber.RemainingQty</span>
                            </div>
                        </div>

                        <!-- Availability Status -->
                        <div class="availability-status">
                            @if (chamber.RemainingQty <= 0)
                            {
                                <span class="badge bg-danger">FULLY ALLOCATED</span>
                            }
                            else if (chamber.RemainingQty < chamber.Capacity * 0.1)
                            {
                                <span class="badge bg-warning">ALMOST FULL</span>
                            }
                            else
                            {
                                <span class="badge bg-success">AVAILABLE</span>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>









@code {
    public string FilteredPhoneNumber
    {
        get => EditModel.VehContact;
        set => EditModel.VehContact = string.IsNullOrEmpty(value) ? "" : new string(value.Where(char.IsDigit).ToArray());
    }


    public string FilteredPhoneNumbergrower
    {
        get => EditModel.GrowerContact;
        set => EditModel.GrowerContact = string.IsNullOrEmpty(value) ? "" : new string(value.Where(char.IsDigit).ToArray());
    }

    public string FilteredPhoneNumberchallan
    {
        get => EditModel.ChallanPhone1;
        set => EditModel.ChallanPhone1 = string.IsNullOrEmpty(value) ? "" : new string(value.Where(char.IsDigit).ToArray());
    }





    ListSearchMode SearchMode { get; set; } = ListSearchMode.AutoSearch;
    ListSearchFilterCondition SearchFilterCondition { get; set; } = ListSearchFilterCondition.Contains;
    ListSearchTextParseMode SearchTextParseMode { get; set; } = ListSearchTextParseMode.GroupWordsByAnd;
    List<CompanyModel> GetmasterGroup = new List<CompanyModel>();
    List<CompanyModel> GetgrowerList = new List<CompanyModel>();
    List<CompanyModel> Purchaseorders = new List<CompanyModel>();

    List<CompanyModel> GetchamberAnalysis = new List<CompanyModel>();
    List<CompanyModel> GetVehlist = new List<CompanyModel>();

    List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();
    List<CompanyModel> GetDailyPreinwardtemp = new List<CompanyModel>();

    List<CompanyModel> GetDailyCrates = new List<CompanyModel>();
    string AvailGrower ="";
    bool showQty = false;
    bool showReport = false;
    bool TrickCrateAnalysis=false;
    bool ShowBoth = false;
    bool ShowButtonAdd = true;
    bool ShowOtherButtons = false;
    private System.Timers.Timer dismissTimer;


    private bool IsServiceTypeDisabled = false;
    List<CompanyModel> GetCrateMark = new List<CompanyModel>();
    List<CompanyModel> GetChallanGroup = new List<CompanyModel>();
    List<CompanyModel> GetInsertedQty = new List<CompanyModel>();

    List<CompanyModel> CrateAnalysis = new List<CompanyModel>();
    List<CompanyModel> GetSubGrowerGroup = new List<CompanyModel>();


    DxReportViewer? reportViewer;
    XtraReport? Report;
    private void ShowReport()
    {



        Report = XtraReport.FromFile(Path.Combine(Directory.GetCurrentDirectory(),
             @"Reports\XtraReport11.repx"));

        showReport = true;
    }

    private void OnCrateCrnChanged(string value)
    {
        EditModel.PreCrateType = value;

        ShowBoth = value == "BOTH";
    }
    private void ValidateItemname()
    {
        if (string.IsNullOrWhiteSpace(EditModel.Itemname))
        {
            // Handle empty item name case
        }
        else if (EditModel.Itemname.Equals("APPLE", StringComparison.OrdinalIgnoreCase))
        {
            EditModel.PreInwardUom = "CRATES";
        }
        else if (EditModel.Itemname.Equals("PETTI", StringComparison.OrdinalIgnoreCase))
        {
            EditModel.PreInwardUom = "PETTI";
        }
    }
    private void OnItemChanged(string Value)
    {
        EditModel.Itemname = Value?.ToString();
        ValidateItemname();

    }

    public class ComboItem
    {
        public string DisplayText { get; set; }  // What appears in the dropdown
        public string ValueType { get; set; }     // "Company", "Both", or "Own"
    }

    private List<ComboItem> CrateType = new List<ComboItem>
    {
        new ComboItem { DisplayText = "COMPANY", ValueType = "COMPANY" },
        new ComboItem { DisplayText = "BOTH", ValueType = "BOTH" },
        new ComboItem { DisplayText = "OWN", ValueType = "OWN" }
    };


    private decimal AvailableBookQty = 0;


    private decimal AvailableSubGrower = 0;

    private CompanyModel EditModel = new();
    private string DialogMessage { get; set; } = "";
    private bool ShowEmptyFieldDialogError { get; set; }
    private string ChallanGroup { get; set; } = "";
    string GrowerGroupKey = Guid.NewGuid().ToString();
    string GrowerNameKey = Guid.NewGuid().ToString();
    string ChallanKey = Guid.NewGuid().ToString();
    private bool IsVehvisible { get; set; } = false;

    private bool AddSub { get; set; } = false;
    private bool ShowEmptyFieldDialog { get; set; }
    private bool ShowCrateAnalysis { get; set; } = false;
    private bool Addnewchallan { get; set; } = false;
    async Task Savevehicle()

    {

        if (string.IsNullOrWhiteSpace(EditModel.Vehno) || string.IsNullOrWhiteSpace(EditModel.VehDriver))
        {
            DialogMessage = "Please fill in all required fields.";
            ShowEmptyFieldDialog = true;
            return;
        }

        if (string.IsNullOrWhiteSpace(EditModel.VehContact) || string.IsNullOrWhiteSpace(EditModel.VehContact))
        {
            DialogMessage = "Mobile no required";
            ShowEmptyFieldDialog = true;
            return;
        }
        if (string.IsNullOrWhiteSpace(EditModel.Vehntype) || string.IsNullOrWhiteSpace(EditModel.Vehntype))
        {
            EditModel.Vehntype = "";
        }
        if (string.IsNullOrWhiteSpace(EditModel.VehDriver) || string.IsNullOrWhiteSpace(EditModel.VehDriver))
        {
            DialogMessage = "Driver Name required";
            ShowEmptyFieldDialog = true;
            return;
        }
        await EmployeeService.Addveh(EditModel);
        ShowEmptyFieldDialogError = true;
        DialogMessage = "Vehicle saved successfully.";
        IsVehvisible = false;
        GetVehlist = await EmployeeService.GetallVeh();
        EditModel.Vehno = String.Empty;
        EditModel.Vehntype = String.Empty;
        EditModel.VehContact = String.Empty;
        EditModel.VehDriver = String.Empty;
    }

    private string selectedgroup;
    private string SelectedGrower;


    private void Addnewchallanproc()
    {
        if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            DialogMessage = "Please Select  valid Grower Group Name";
            ShowEmptyFieldDialog = true;
            return;

        }
        selectedgroup = EditModel.GrowerGroupName;
        if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
        {
            DialogMessage = "Please Select  valid Grower  Name";
            ShowEmptyFieldDialog = true;
            return;

        }
        SelectedGrower = EditModel.GrowerName;



        Addnewchallan = true;
     

    }


    private void AddNewSub()
    {
        if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            DialogMessage = "Please Select  valid Grower Group Name";
            ShowEmptyFieldDialog = true;
            return;

        }
        selectedgroup = EditModel.GrowerGroupName;




        AddSub = true;


    }



    private async void SaveNewSub()



    {

        EditModel.GrowerGroupName = selectedgroup;



        if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
        {
            DialogMessage = "Please Select  valid Grower  Name";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.GrowerAddress))
        {
            DialogMessage = "Please Select  valid Grower Address";
            ShowEmptyFieldDialog = true;
            return;

        }


        if (string.IsNullOrWhiteSpace(EditModel.GrowerContact))
        {
            DialogMessage = "Please Select  valid Grower Contact";
            ShowEmptyFieldDialog = true;
            return;

        }


        if (EditModel.GrowerCrateissue < 0)
        {

            DialogMessage = "Valid Crate issue qty is Required";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (EditModel.GrowerCratelimit < 0)
        {

            DialogMessage = "Valid Crate issue Limit percent is Required";
            ShowEmptyFieldDialog = true;
            return;

        }
        var result = await EmployeeService.AddGrowerSubdirect(EditModel);




        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {


            AddSub = false;

            EditModel.GrowerName = string.Empty;
            EditModel.GrowerAddress = string.Empty;
            EditModel.GrowerContact = string.Empty;
            EditModel.GrowerCrateissue = 0;
            EditModel.GrowerCratelimit = 0;
            StateHasChanged();

          
            return;
        }


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {
           
            DialogMessage = result.RetMessage ?? "Failed to Update grower group.";
            ShowEmptyFieldDialog = true;

            return;
        }









    }

    // private void AddNewSub()
    // {
    //     if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
    //     {
    //         DialogMessage = "Please Select  valid Grower Group Name";
    //         ShowEmptyFieldDialog = true;
    //         return;

    //     }
    //     selectedgroup = EditModel.GrowerGroupName;




    //     AddSub = true;


    // }



    private async void SaveNewChallan()



    {

        EditModel.GrowerGroupName = selectedgroup;



        if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
        {
            DialogMessage = "Please Select  valid Grower  Name";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.ChallanAddress))
        {
            DialogMessage = "Please Select  valid Grower Address";
            ShowEmptyFieldDialog = true;
            return;

        }


        if (string.IsNullOrWhiteSpace(EditModel.ChallanPhone1))
        {
            DialogMessage = "Please Select  valid Grower Contact";
            ShowEmptyFieldDialog = true;
            return;

        }


        var result = await EmployeeService.AddChallandirect(EditModel);




        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {


            AddSub = false;

            EditModel.GrowerName = string.Empty;
            EditModel.GrowerGroupName = string.Empty;
            EditModel.ChallanName = string.Empty;
            EditModel.ChallanPhone1 = string.Empty;
            EditModel.ChallanAddress= string.Empty;
            StateHasChanged();


            return;
        }


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to Update grower group.";
            ShowEmptyFieldDialog = true;

            return;
        }









    }
    
    private void AddNewVehicle()
    {
        // selectedGrowerId = growerId;
        IsVehvisible = true;


    }



    private void HideNewchallan()
    {
        // selectedGrowerId = growerId;
        Addnewchallan = true;


    }
    private void HideNewVehicle()
    {
        // selectedGrowerId = growerId;
        IsVehvisible = false;


    }


     private void HideNewsub()
    {
        // selectedGrowerId = growerId;
        AddSub = false;


    }
    private async void DeleteGrower(int Trid)
    {
        int SelectedTrid = Trid;
        int selectedId = EditModel.TempGateInId;

        var result = await EmployeeService.DeleteTrid(Trid, selectedId);
        GetDailyPreinwardtemp = await EmployeeService.GetDailyPreinwardProctemp(EditModel.TempGateInId);


        StateHasChanged();


        return;



    }
    private void ViewGrower(int growerId)
    {
        companyModel.Growerid = growerId;


        NavigationManager.NavigateTo($"/ViewGrower/{growerId}");

    }
    private async Task OnCountryChanged(string? newCountryId)
    {
        string selectedPurchase = "";
        selectedPurchase = newCountryId;




        EditModel.PurchGrp = selectedPurchase;
        GetItemGroup = await EmployeeService.GetItemNameByGroup(selectedPurchase);
        GetVehlist = await EmployeeService.GetallVeh();


    }


    private async Task OnGrowerGroupChanged(string? newCountryId)
    {
        string selectedPurchase = "";
        selectedPurchase = newCountryId;
        GetSubGrowerGroup.Clear();
        EditModel.GrowerName = String.Empty;
        EditModel.ChallanName = String.Empty;
        var resultnew = await EmployeeService.DeleteAllTrid(EditModel.TempGateInId);
        GetDailyPreinwardtemp = await EmployeeService.GetDailyPreinwardProctemp(EditModel.TempGateInId);

        StateHasChanged();
        if (!string.IsNullOrWhiteSpace(selectedPurchase))

        {
            var result = await EmployeeService.CheckChamberAllocation(selectedPurchase);


            if (result != null && result.RetFlag.Trim() == "FALSE")
            {

                DialogMessage = result.RetMessage ?? "Error";
                ShowEmptyFieldDialog = true;
                EditModel.GrowerGroupName = string.Empty;
                selectedPurchase = string.Empty;
                return;
            }


            GetGstList = await EmployeeService.GetServicesfromAgreement(selectedPurchase);
            if (GetGstList.Count == 1)
            {
                EditModel.ServiceId = GetGstList[0].Atype;  // Auto-select the only option
                IsServiceTypeDisabled = true;              // Disable ComboBox
            }
            else
            {
                EditModel.ServiceId = null;              // Clear selection
                IsServiceTypeDisabled = false;             // Enable ComboBox
            }       






            GetSubGrowerGroup = await EmployeeService.GetSubGrowerByGroup(selectedPurchase);
            AvailGrower =selectedPurchase;
            EditModel.GrowerGroupName = AvailGrower;






            GetCrateAnalysis = await EmployeeService.CheckCratesAgreement(selectedPurchase);




            AvailableBookQty = GetCrateAnalysis.FirstOrDefault()?.PrebookQty ?? 0;



            showQty = true;
        }
    }


    private int? GetNumberAfterSecondSlash(string input)
    {
        if (string.IsNullOrWhiteSpace(input))
            return null;

        // Split the string by slashes
        var parts = input.Split('/');
        if (parts.Length < 3)
            return null;

        // Get the part after the second slash and remove leading zeros
        var numberPart = parts[2].TrimStart('0');

        if (int.TryParse(numberPart, out int result))
            return result;

        return null;
    }

    private async Task OnSubgrowerChanged(string? newCountryId)
    {
        string selectedPurchase = newCountryId;
        GetChallanGroup.Clear();
        EditModel.ChallanName = String.Empty;
        StateHasChanged();

        string SelectedSubgrower = AvailGrower;
        // await JS.InvokeVoidAsync("alert",selectedPurchase);
        //          await JS.InvokeVoidAsync("alert",AvailGrower);

        if (!string.IsNullOrWhiteSpace(selectedPurchase) && !string.IsNullOrWhiteSpace(SelectedSubgrower))
        {
            EditModel.GrowerName = selectedPurchase;


            GetChallanGroup = await EmployeeService.GetChallanByGroup(selectedPurchase, SelectedSubgrower);

            GetCrateAnalysis = await EmployeeService.CheckCratesPartysub(selectedPurchase, SelectedSubgrower);
            selectedSubgrower = selectedPurchase;
            AvailableSubGrower = companyModel?.CrateAvailable ?? 0;
            ShowCrateAnalysis = true;
        }
        else
        {
            // Optionally reset related values
            ShowCrateAnalysis = false;
            AvailableSubGrower = 0;
        }

    }

    protected async Task GeneratePreview()
    {
        await JS.InvokeVoidAsync("window.open", "/Thermal", "_blank"); 

    }



    protected async Task GeneratePreviewbyid(int growerId)
    {


        // if  (EditModel.CrissueId <= 0)
        // {
        //     DialogMessage = "Please enter a valid idno greater than 0.";
        //     ShowEmptyFieldDialog = true;
        //     return;
        // }
        selectedGrowerId = growerId;
        //  selectedGrowerId = EditModel.CrissueId;

        await EmployeeService.GenerateCratePreview(selectedGrowerId,EditModel);

        Report = XtraReport.FromFile(Path.Combine(Directory.GetCurrentDirectory(),
          @"Reports\CrateSlip.repx"));



        showReport = true;

    }

    void OnKhataMarkChanged(string newValue)
    {
        // Check if the new value is not already in the data source
        EditModel.PreInwardKhata = newValue;

        // Check if the value exists already
        if (!string.IsNullOrWhiteSpace(newValue) &&
            !GetKhata.Any(x => x.PreInwardKhata.Equals(newValue, StringComparison.OrdinalIgnoreCase)))
        {
            GetKhata.Add(new CompanyModel { PreInwardKhata = newValue });
        }
    }




    private void AddGrowerAgreement(int growerId)
    {
        companyModel.Growerid = growerId;


        NavigationManager.NavigateTo($"/EditGrowerAgreement/{growerId}");

    }






    private void ViewSubGrower(int growerId)
    {
        companyModel.Growerid = growerId;


        NavigationManager.NavigateTo($"/ViewSubGrower/{growerId}");

    }


    void OnCrissueMarkChanged(string newValue)
    {
        // Check if the new value is not already in the data source
        EditModel.CrissueMark = newValue;

        // Check if the value exists already
        if (!string.IsNullOrWhiteSpace(newValue) &&
            !GetCrateMark.Any(x => x.CrissueMark.Equals(newValue, StringComparison.OrdinalIgnoreCase)))
        {
            GetCrateMark.Add(new CompanyModel { CrissueMark = newValue });
        }
    }


    private void AddGrower(int growerId)
    {
        companyModel.Growerid = growerId;


        NavigationManager.NavigateTo($"/AddGrower");

    }


    private async Task EditItem(object dataItem)
    {
        if (dataItem is CompanyModel companyModel)
        {
            // EditModel.TempGateInId = companyModel.TempGateInId;
            selectedGrowerId = companyModel.Trid;
            int selectedId = EditModel.TempGateInId;

            companyModel = await EmployeeService.GetTridDet(selectedGrowerId, selectedId);


            GetGstList = await EmployeeService.GetServicesfromAgreement(AvailGrower);
            EditModel.ServiceId = GetGstList[0].Atype;
            EditModel.PreInwardKhata = companyModel.PreInwardKhata;
            EditModel.PreCrateType = companyModel.PreCrateType;
            EditModel.PreInwardQty = companyModel.PreInwardQty;
            EditModel.VarietyId = companyModel.VarietyId;
            EditModel.Trid = companyModel.Trid;

            actualidqty = EditModel.PreInwardQty ?? 0;
            if (EditModel.PreCrateType == "BOTH")
            {
                ShowBoth = true;
            }
            ShowOtherButtons = true;
            ShowButtonAdd = false;

            StateHasChanged();









        }
    }

    // private async void EditGrower(int growerId)
    // {
    //     // selectedGrowerId=companyModel.Mid ;

    //     // companyModel = await EmployeeService.GetMasterName(companyModel.Mid);



    // }
    protected async Task OnConfirmYes()
    {


        companyModel.Itemid = selectedGrowerId;
        await EmployeeService.UpdateItemStatus(selectedGrowerId, companyModel);


        banks = await EmployeeService.GetallItemGroup();


        StateHasChanged();
        isDialogVisible = false;

    }

    protected async Task OnConfirmYesPost()
    {
        if (EditModel.PurchaseOrderId <= 0)
        {
            DialogMessage = "Please enter a valid Order No";
            ShowEmptyFieldDialog = true;
            return;
        }
        selectedGrowerId = EditModel.PurchaseOrderId;


        selectedItemid = EditModel.PurchaseOrderItemId;

        //  await JS.InvokeVoidAsync("alert", selectedGrowerId);
        // await JS.InvokeVoidAsync("alert", selectedItemid);

        var result = await EmployeeService.PostPurchaseOrder(EditModel);
        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {
            GetOrderDetails = await EmployeeService.GetPurchaseOrder(selectedGrowerId);

            DialogMessage = result.RetMessage;
            ShowEmptyFieldDialogError = true;


            StateHasChanged();
            PostDialog = false; // Close the delete confirmation dialog
            return;
        }



        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to delete Item group.";
            ShowEmptyFieldDialog = true;
            PostDialog = false;
            return;
        }

















        StateHasChanged();
        isDialogVisible = false;


    }
    protected async Task OnConfirmYesUnpost()
    {
        if (EditModel.PurchaseOrderId <= 0)
        {
            DialogMessage = "Please enter a valid Order No";
            ShowEmptyFieldDialog = true;
            return;
        }
        selectedGrowerId = EditModel.PurchaseOrderId;


        selectedItemid = EditModel.PurchaseOrderItemId;

        //  await JS.InvokeVoidAsync("alert", selectedGrowerId);
        // await JS.InvokeVoidAsync("alert", selectedItemid);

        var result = await EmployeeService.UnPostPurchaseOrder(EditModel);
        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {
            GetOrderDetails = await EmployeeService.GetPurchaseOrder(selectedGrowerId);

            DialogMessage = result.RetMessage;
            ShowEmptyFieldDialogError = true;


            StateHasChanged();
            UnPostDialog = false; // Close the delete confirmation dialog
            return;
        }



        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to Unpost.";
            ShowEmptyFieldDialog = true;
            UnPostDialog = false;
            return;
        }

















        StateHasChanged();
        isDialogVisible = false;
    }
    private string selectedValue = "Company";

    // Flag that will be true ONLY when "Both" is selected
    private bool isBothSelected = false;

    // private void OnCrValueChanged(string newValue)
    // {
    //     selectedValue = newValue;
    //     isBothSelected = (newValue == "Both");
    // }






    protected async Task OnConfirmYesDelete()
    {
        // if (EditModel.CrissueId <= 0)
        // {
        //     DialogMessage = "Please enter a valid Id No";
        //     ShowEmptyFieldDialog = true;
        //     return;
        // }




        // await JS.InvokeVoidAsync("alert", selectedGrowerId);
        // await JS.InvokeVoidAsync("alert", selectedItemid);

        var result = await EmployeeService.DeleteCrateIssue(selectedGrowerId,EditModel);
        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {

            GetDailyCrates=await EmployeeService.GetDailyCratesProc();

            DialogMessage = result.RetMessage;
            ShowEmptyFieldDialogError = true;


            StateHasChanged();
            DeleteDialog = false; // Close the delete confirmation dialog
            return;
        }



        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to delete Item group.";
            ShowEmptyFieldDialog = true;
            DeleteDialog = false;
            return;
        }

















        StateHasChanged();
        isDialogVisible = false;

    }

    protected async Task OnConfirmYesGenerate()
    {



        var result = await EmployeeService.GeneratePreinward(EditModel);
        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {
            companyModel = await EmployeeService.GetPreinwardNo();

            EditModel.TempGateInIrn = companyModel.TempGateInIrn;


            EditModel.TempGateInId = companyModel.TempGateInId;
            PurDialog = false;
            // DialogMessage = result.RetMessage;
            // ShowEmptyFieldDialogError = true;
            // /// await Task.Delay(1000); 
            //  ShowEmptyFieldDialogError = false;

            //    StateHasChanged();
            // Close the delete confirmation dialog
            return;
        }



        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to Create Purchase Order.";
            ShowEmptyFieldDialog = true;
            PurDialog = false;
            return;
        }

















        StateHasChanged();
        isDialogVisible = false;

    }














    private void OnConfirmNoDelete()
    {
        DeleteDialog = false;
    }






    private void ViewSubList(int growerId)
    {
        companyModel.Growerid = growerId;


        NavigationManager.NavigateTo($"/ViewSubGrower/{growerId}");

    }
    private async Task GoBack()
    {
        await JS.InvokeVoidAsync("history.back");
    }
    private void OnConfirmNoGenerate()
    {
        isDialogVisible = false;
    }


    private void OnConfirmNo()
    {
        isDialogVisible = false;
    }

    string GetRowCssClass(object dataItem, int visibleIndex)
    {
        return visibleIndex % 2 == 0 ? "even-row" : "odd-row";
    }

    private bool DeleteDialog = false;
    private bool PurDialog = false;
    private bool UnPostDialog = false;
    private bool PostDialog = false;
    private bool isDialogVisible = false;
    private int selectedGrowerId;
    private int selectedItemid;
    private string selectetGrowerGroup = null;
    private string selectedSubgrower = null;
    private decimal actualidqty = 0;
    private string Growerselect = null;
    private string selectedPurchaseGroup = null;
    private void ShowConfirmDialog(int GrowerId)
    {
        selectedGrowerId = GrowerId;
        isDialogVisible = true;


    }
    private void GoToAddGrowerPage()
    {
        NavigationManager.NavigateTo("/AddGrower");
    }






    void ChangeSearchMode(string key)
    {
        // CurrentSearchTextParseModeDisplayText = key;
        // CurrentSearchTextParseMode = SearchTextParseModes[key];
    }

    public void ShowDetails(int employeeId)
    {

    }
    public void ShowDetails1(string ename)
    {

    }
    public void ShowDetails2(string dept)
    {

    }
    // private string activeBreakpoint { get; set; }

    // // private List<Order> orders { get; set; }

    // private bool enableAdaptiveUIMode { get; set; }
    // private RowDirection renderingMode { get; set; }
    CompanyModel companyModel = new CompanyModel();
    IGrid MyGrid { get; set; }
    List<CompanyModel> Growers = new List<CompanyModel>();
    List<CompanyModel> banks = new List<CompanyModel>();
    List<CompanyModel> GetGstList = new List<CompanyModel>();
    List<CompanyModel> GetUomList = new List<CompanyModel>();
    List<CompanyModel> GetItemGroup = new List<CompanyModel>();
    List<CompanyModel> GetOrderDetails = new List<CompanyModel>();
    List<CompanyModel> GetCrateAnalysis = new List<CompanyModel>();
    List<CompanyModel> GetMaxCrateId = new List<CompanyModel>();
    List<CompanyModel> GetKhata = new List<CompanyModel>();
      List<CompanyModel> Chamberlist = new List<CompanyModel>();

    List<CompanyModel> Purchaseorderscrn = new List<CompanyModel>();
    private async Task OnDropDownVisibleChanged(bool isVisible)
    {
        if (isVisible)
        {
            await Task.Delay(500); // Simulate async data fetch

            GetgrowerList = await EmployeeService.GetallGrowerlist();
            StateHasChanged(); // Force re-render
        }
    }


    private async Task OnSubDropDownChanged(bool isVisible)
    {
        // Exit if dropdown is closing or EditModel is null
        if (!isVisible || EditModel == null)
            return;

        // Early exit if GrowerGroupName is null/empty (before any other logic)
        if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            return;
        }

        // Debug alert (remove in production)
        // await JS.InvokeVoidAsync("alert", EditModel.GrowerGroupName);

        string selectedPurchase = EditModel.GrowerGroupName.Trim();
        AvailGrower = selectedPurchase;

        await Task.Delay(500); // Simulate async data fetch

        GetSubGrowerGroup = await EmployeeService.GetSubGrowerByGroup(selectedPurchase);
        AvailGrower = selectedPurchase;

        StateHasChanged();
    }

    private async Task OnChallanDropDownChanged(bool isVisible)
    {
        // Early exit if dropdown is closing or required data is missing
        if (!isVisible ||
            EditModel == null ||
            string.IsNullOrWhiteSpace(EditModel.GrowerName) ||
            string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            return;
        }

        try
        {
            // Trim inputs to avoid whitespace issues
            var growerName = EditModel.GrowerName.Trim();
            var growerGroup = EditModel.GrowerGroupName.Trim();

            // Optional: Show loading indicator
            // isLoading = true;
            // StateHasChanged();

            await Task.Delay(500); // Remove in production (only for simulation)

            GetChallanGroup = await EmployeeService.GetChallanByGroup(growerName, growerGroup);
        }
        catch (Exception ex)
        {
            // Handle errors (log, show user message, etc.)
            Console.WriteLine($"Error loading challan data: {ex.Message}");

            // Optional: Reset dropdown on error
            // isDropDownVisible = false;
        }
        finally
        {
            // Optional: Hide loading indicator
            // isLoading = false;
            StateHasChanged(); // Update UI
        }
    }



    private async Task OnVehDropDownChanged(bool isVisible)
    {
        if (isVisible)
        {
            await Task.Delay(500); // Simulate async data fetch

            GetVehlist = await EmployeeService.GetallVeh();
            StateHasChanged(); // Force re-render
        }
    }


    private async Task HandleFocus(FocusEventArgs e)
    {
        if (!isDropDownVisible)
        {
            isDropDownVisible = true;
        }

        if (!dataLoaded)
        {
            await Task.Delay(500); // Simulate async delay
            GetgrowerList = await EmployeeService.GetallGrowerlist();
        }
    }

    private async Task HandleFocusVeh(FocusEventArgs e)
    {
        if (!isDropDownVisible)
        {
            isDropDownVisible = true;
        }

        if (!dataLoaded)
        {
            await Task.Delay(500); // Simulate async delay
            GetVehlist = await EmployeeService.GetallVeh();
        }
    }


    private async Task HandleFocusSub(FocusEventArgs e)
    {
        // Early exit if EditModel or GrowerGroupName is invalid
        if (EditModel == null || string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            return;
        }

        // Only proceed if dropdown isn't already visible
        if (!isDropDownVisible)
        {
            isDropDownVisible = true;
        }

        // Load data only if not already loaded
        if (!dataLoaded)
        {
            try
            {
                await Task.Delay(500); // Simulate async delay
                GetSubGrowerGroup = await EmployeeService.GetSubGrowerByGroup(EditModel.GrowerGroupName.Trim());
                dataLoaded = true; // Remember to set this flag after successful load
            }
            catch (Exception ex)
            {
                // Handle errors (log, show message, etc.)
                Console.WriteLine($"Error loading sub-grower groups: {ex.Message}");
            }
        }
    }



    private async Task HandleFocusChallan(FocusEventArgs e)
    {
        // Early exit if EditModel or required fields are null/empty
        if (EditModel == null ||
            string.IsNullOrWhiteSpace(EditModel.GrowerName) ||
            string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            return;
        }

        // Only open dropdown if not already visible
        if (!isDropDownVisible)
        {
            isDropDownVisible = true;
        }

        // Load data only if not already loaded
        if (!dataLoaded)
        {
            try
            {
                await Task.Delay(500); // Simulate async delay (optional)

                // Trim inputs to avoid whitespace issues
                string growerName = EditModel.GrowerName.Trim();
                string growerGroup = EditModel.GrowerGroupName.Trim();

                GetChallanGroup = await EmployeeService.GetChallanByGroup(growerName, growerGroup);
                dataLoaded = true; // Mark data as loaded to prevent redundant calls
            }
            catch (Exception ex)
            {
                // Log error (or show user feedback)
                Console.WriteLine($"Error loading challan data: {ex.Message}");

                // Optional: Reset dropdown state on failure
                isDropDownVisible = false;
            }
        }
    }
    private bool isDropDownVisible = false;
    private bool dataLoaded = false;

    protected override async Task OnInitializedAsync()
    {


       
        
        
        
        
        




        //Chamberlist = await EmployeeService.GetChambersAsync();

    }
    // SfGrid<CompanyModel> Grid;

    // FilterSettings filterSettings = new FilterSettings { Type = FilterType.Excel };


    private async Task EditHandler(Employee employee)
    {
        // await Grid.SelectRowAsync(companyModel.chid);
        // await Grid.StartEditAsync();
    }


    private async Task DeleteHandler(Employee employee)
    {

    }

    protected async Task ViewOrder()
    {
        if (EditModel.PurchaseOrderId <= 0)
        {
            DialogMessage = "Please enter  valid Order No";
            ShowEmptyFieldDialog = true;
            return;
        }
        selectedGrowerId = EditModel.PurchaseOrderId;
        GetOrderDetails = await EmployeeService.GetPurchaseOrder(selectedGrowerId);

        companyModel = await EmployeeService.GetOrderhead(selectedGrowerId);
        EditModel.PurchaseOrderDated=companyModel.PurchaseOrderDated;
        EditModel.AccountName = companyModel.AccountName;
        EditModel.PurchaseOrderBillto = companyModel.PurchaseOrderBillto;
        EditModel.PurchaseOrderDel = companyModel.PurchaseOrderDel;
        EditModel.PurchaseOrderRemarks = companyModel.PurchaseOrderRemarks;






        StateHasChanged();
        return;



    }

    protected async Task ToggleUnit()
    {
        ShowOtherButtons = false;
        ShowButtonAdd = true;
    }


    protected async Task SaveItem()
    {

        if (string.IsNullOrWhiteSpace(EditModel.PurchGrp))
        {
            DialogMessage = "Please Select  valid Purchase Group";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.PurchaseItemName))
        {
            DialogMessage = "Please Select  valid Item Group";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (string.IsNullOrWhiteSpace(EditModel.PurchaseOrderItemDescrip))
        {
            EditModel.PurchaseOrderItemDescrip = "";


        }


        if (!EditModel.PurchaseOrderqty.HasValue || EditModel.PurchaseOrderqty <= 0)
        {
            DialogMessage = "Please enter a valid quantity greater than 0.";
            ShowEmptyFieldDialog = true;
            return;
        }
        if (EditModel.PurchaseOrderId <= 0)
        {
            DialogMessage = "Please enter a valid Order No";
            ShowEmptyFieldDialog = true;
            return;
        }

        var result = await EmployeeService.AddPurchaseOrderItem(EditModel);
        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {
            DialogMessage = result.RetMessage;
            ShowEmptyFieldDialogError = true;


            companyModel = new CompanyModel();
            selectedGrowerId = EditModel.PurchaseOrderId;
            GetOrderDetails = await EmployeeService.GetPurchaseOrder(selectedGrowerId);

            StateHasChanged();
            return;
        }


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to add order item.";
            ShowEmptyFieldDialog = true;

            return;
        }




    }

    protected async Task UpdateTrid()
    {
        EditModel.GrowerGroupName = AvailGrower;
        EditModel.Trid = selectedGrowerId;
        if (string.IsNullOrWhiteSpace(EditModel.TempGateInIrn))
        {
            DialogMessage = "Please generate  valid Id";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            DialogMessage = "Please Select  valid Grower Group Name";
            ShowEmptyFieldDialog = true;
            return;

        }


        if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
        {
            DialogMessage = "Please Select  valid Grower  Name";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.ChallanName))
        {
            DialogMessage = "Please Select  valid Challan  Name";
            ShowEmptyFieldDialog = true;
            return;

        }


        if (string.IsNullOrWhiteSpace(EditModel.PreInwardKhata))
        {
            DialogMessage = "Please Select  valid Khata  Name";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (string.IsNullOrWhiteSpace(EditModel.Itemname))
        {
            DialogMessage = "Please Select  valid Item  Name";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (string.IsNullOrWhiteSpace(EditModel.ChallanNo))
        {
            DialogMessage = "Please Select  valid Challan  No";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.Vehno))
        {
            DialogMessage = "Please Select  valid Vehicle No";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.ServiceId))
        {
            DialogMessage = "Please Select  valid Scheme";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.VarietyId))
        {
            DialogMessage = "Please Select  valid Variety name";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (string.IsNullOrWhiteSpace(EditModel.PreInwardRemarks))
        {
            EditModel.PreInwardRemarks = "";

        }
        if (string.IsNullOrWhiteSpace(EditModel.PreCrateType))
        {
            DialogMessage = "Please Select  valid Crate Type";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (!EditModel.PreInwardQty.HasValue || EditModel.PreInwardQty <= 0)
        {
            DialogMessage = "Please enter a valid quantity greater than 0.";
            ShowEmptyFieldDialog = true;
            return;
        }
        if (EditModel.PreCrateType == "BOTH")
        {
            if (EditModel.OwnQty == 0 || EditModel.StoreQty == 0)
            {
                DialogMessage = "Invalid Qty for Both crate type option";
                ShowEmptyFieldDialog = true;
                return;
            }

            if (EditModel.PreCrateType == "BOTH")
            {



                decimal total = (EditModel.OwnQty ?? 0) + (EditModel.StoreQty ?? 0);

                if (total != EditModel.PreInwardQty)
                {
                    DialogMessage = "Invalid Qty for Both crate type option";
                    ShowEmptyFieldDialog = true;
                    return;
                }
            }

        }
        selectetGrowerGroup = EditModel.GrowerGroupName;
        var result = await EmployeeService.CheckChamberAllocation(selectetGrowerGroup);


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Error";
            ShowEmptyFieldDialog = true;

            return;
        }


        GetCrateAnalysis = await EmployeeService.CheckCratesAgreement(selectetGrowerGroup);


        companyModel = await EmployeeService.CheckInsertedQty(EditModel.TempGateInId);

        EditModel.TempInsertedQty = companyModel.TempInsertedQty;


        // decimal insertedQty = companyModel.TempInsertedQty ?? 0;

        //  decimal insertedQty2 = EditModel.TempInsertedQty ?? 0;

        AvailableBookQty = GetCrateAnalysis.FirstOrDefault()?.PrebookQty ?? 0;
        AvailableBookQty = AvailableBookQty + actualidqty;

        decimal TotalQty = (EditModel.PreInwardQty ?? 0) + (EditModel.TempInsertedQty ?? 0);





        if (TotalQty > AvailableBookQty)
        {
            DialogMessage = $"Entered quantity exceeds the available Booking Qty";
            ShowEmptyFieldDialog = true;

            return;
        }


        GetchamberAnalysis = await EmployeeService.CheckChamberStatus(selectetGrowerGroup);

        decimal ActiveChamberQty = GetchamberAnalysis.FirstOrDefault()?.ChamberAvailQty ?? 0;
        int Chamberid = GetchamberAnalysis.FirstOrDefault()?.ChamberId ?? 0;

        EditModel.ChamberId = Chamberid;
        EditModel.ChamberAvailQty = ActiveChamberQty+ actualidqty;


        if (TotalQty > EditModel.ChamberAvailQty)
        {
            DialogMessage = $"Entered quantity cannot exceed available Active Chamber ({Chamberid}) quantity ({ActiveChamberQty}).";
            ShowEmptyFieldDialog = true;
            return;
        }


        if (EditModel.PreCrateType == "OWN")
        {
            EditModel.OwnQty = EditModel.PreInwardQty;
            EditModel.StoreQty = 0;
        }

        if (EditModel.PreCrateType == "COMPANY")
        {
            EditModel.StoreQty = EditModel.PreInwardQty;
            EditModel.OwnQty = 0;
        }

        EditModel.GrowerGroupName = selectetGrowerGroup;



        var resultUpload = await EmployeeService.UpdateTrid(EditModel);
        if (resultUpload != null && resultUpload.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(resultUpload.RetMessage))
        {
            DialogMessage = resultUpload.RetMessage;
            ShowEmptyFieldDialogError = true;

            ShowCrateAnalysis = false;

            string CuserName = EditModel.GlobalUserName;
            GetDailyPreinwardtemp = await EmployeeService.GetDailyPreinwardProctemp(EditModel.TempGateInId);

            //
            // // GetCrateMark=await EmployeeService.GetallCrateMarks();
            //      companyModel = await EmployeeService.GetCrateOrderNo();
            // GrowerGroupKey = Guid.NewGuid().ToString();

            // EditModel.GrowerGroupName = String.Empty;
            // EditModel.ChallanName = String.Empty;
            // // EditModel.CrissueMark = String.Empty;
            // EditModel.PreInwardRemarks = "";
            EditModel.PreInwardQty = 0;
            EditModel.PreInwardKhata = String.Empty;
            EditModel.PreCrateType = String.Empty;
            // EditModel.GrowerName = String.Empty;
            EditModel.VarietyId = String.Empty;
            // EditModel.Itemname = String.Empty;
            // EditModel.ServiceId = String.Empty;
            //   EditModel.Prodname  = String.Empty;
            // EditModel.Vehno = String.Empty;
            //EditModel.PreInwardUom = String.Empty;


            // selectedSubgrower= String.Empty;
            ShowBoth = false;
            // Purchaseorders = await EmployeeService.GetCrateorders();
            // GetMaxCrateId = await EmployeeService.GetMaxCrateIdno();
            // int cid=0;
            // cid= GetMaxCrateId.FirstOrDefault()?.CrissueId ?? 0;
            // EditModel.CrissueId = cid;

            // await  GeneratePreviewbyid(EditModel.CrissueId);
            // StateHasChanged();
            return;
        }
    }

    protected async Task UpdateItem()
    {

        selectedItemid= EditModel.PurchaseOrderItemId;   
        //   await JS.InvokeVoidAsync("alert", selectedItemid);
        if (string.IsNullOrWhiteSpace(EditModel.PurchGrp))
        {
            DialogMessage = "Please Select  valid Purchase Group";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.PurchaseItemName))
        {
            DialogMessage = "Please Select  valid Item Group";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (string.IsNullOrWhiteSpace(EditModel.PurchaseOrderItemDescrip))
        {
            EditModel.PurchaseOrderItemDescrip = "";


        }


        if (!EditModel.PurchaseOrderqty.HasValue || EditModel.PurchaseOrderqty <= 0)
        {
            DialogMessage = "Please enter a valid quantity greater than 0.";
            ShowEmptyFieldDialog = true;
            return;
        }
        if (EditModel.PurchaseOrderId <= 0)
        {
            DialogMessage = "Please enter a valid Order No";
            ShowEmptyFieldDialog = true;
            return;
        }

        var result = await EmployeeService.UpdatePurchaseOrderItem(EditModel);
        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {
            DialogMessage = result.RetMessage;
            ShowEmptyFieldDialogError = true;


            companyModel = new CompanyModel();
            selectedGrowerId = EditModel.PurchaseOrderId;
            GetOrderDetails = await EmployeeService.GetPurchaseOrder(selectedGrowerId);

            StateHasChanged();
            return;
        }


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to add order item.";
            ShowEmptyFieldDialog = true;

            return;
        }




    }





    protected async Task  SearchCrates()


    {
        DateTime DateFrom = EditModel.CrateDatefrom ?? DateTime.Now;
        DateTime Dateto = EditModel.CrateDateto ?? DateTime.Now;

        GetDailyCrates=await EmployeeService.GetDailyCratesProcBydate(DateFrom,Dateto);

    }
    private bool isProcessing = false;

    async Task SaveUnit()
    {
        if (isProcessing) return;
        isProcessing = true;

        try 


        {
            EditModel.GrowerGroupName = AvailGrower;

            if (string.IsNullOrWhiteSpace(EditModel.TempGateInIrn))
            {
                DialogMessage = "Please generate  valid Id";
                ShowEmptyFieldDialog = true;
                return;

            }

            if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
            {
                DialogMessage = "Please Select  valid Grower Group Name";
                ShowEmptyFieldDialog = true;
                return;

            }


            if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
            {
                DialogMessage = "Please Select  valid Grower  Name";
                ShowEmptyFieldDialog = true;
                return;

            }

            if (string.IsNullOrWhiteSpace(EditModel.ChallanName))
            {
                DialogMessage = "Please Select  valid Challan  Name";
                ShowEmptyFieldDialog = true;
                return;

            }


            if (string.IsNullOrWhiteSpace(EditModel.PreInwardKhata))
            {
                DialogMessage = "Please Select  valid Khata  Name";
                ShowEmptyFieldDialog = true;
                return;

            }
            if (string.IsNullOrWhiteSpace(EditModel.Itemname))
            {
                DialogMessage = "Please Select  valid Item  Name";
                ShowEmptyFieldDialog = true;
                return;

            }
            if (string.IsNullOrWhiteSpace(EditModel.ChallanNo))
            {
                DialogMessage = "Please Select  valid Challan  No";
                ShowEmptyFieldDialog = true;
                return;

            }

            if (string.IsNullOrWhiteSpace(EditModel.Vehno))
            {
                DialogMessage = "Please Select  valid Vehicle No";
                ShowEmptyFieldDialog = true;
                return;

            }

            if (string.IsNullOrWhiteSpace(EditModel.ServiceId))
            {
                DialogMessage = "Please Select  valid Scheme";
                ShowEmptyFieldDialog = true;
                return;

            }

            if (string.IsNullOrWhiteSpace(EditModel.VarietyId))
            {
                DialogMessage = "Please Select  valid Variety name";
                ShowEmptyFieldDialog = true;
                return;

            }
            if (string.IsNullOrWhiteSpace(EditModel.PreInwardRemarks))
            {
                EditModel.PreInwardRemarks = "";

            }
            if (string.IsNullOrWhiteSpace(EditModel.PreCrateType))
            {
                DialogMessage = "Please Select  valid Crate Type";
                ShowEmptyFieldDialog = true;
                return;

            }
            if (!EditModel.PreInwardQty.HasValue || EditModel.PreInwardQty <= 0)
            {
                DialogMessage = "Please enter a valid quantity greater than 0.";
                ShowEmptyFieldDialog = true;
                return;
            }
            if (EditModel.PreCrateType == "BOTH")
            {
                if (EditModel.OwnQty == 0 || EditModel.StoreQty == 0)
                {
                    DialogMessage = "Invalid Qty for Both crate type option";
                    ShowEmptyFieldDialog = true;
                    return;
                }

                if (EditModel.PreCrateType == "BOTH")
                {



                    decimal total = (EditModel.OwnQty ?? 0) + (EditModel.StoreQty ?? 0);

                    if (total != EditModel.PreInwardQty)
                    {
                        DialogMessage = "Invalid Qty for Both crate type option";
                        ShowEmptyFieldDialog = true;
                        return;
                    }
                }

            }
            selectetGrowerGroup=EditModel.GrowerGroupName;
            var result = await EmployeeService.CheckChamberAllocation(selectetGrowerGroup);


            if (result != null && result.RetFlag.Trim() == "FALSE")
            {

                DialogMessage = result.RetMessage ?? "Error";
                ShowEmptyFieldDialog = true;

                return;
            }


            GetCrateAnalysis = await EmployeeService.CheckCratesAgreement(selectetGrowerGroup);


            companyModel=await EmployeeService.CheckInsertedQty(EditModel.TempGateInId);

            EditModel.TempInsertedQty = companyModel.TempInsertedQty;


            // decimal insertedQty = companyModel.TempInsertedQty ?? 0;

            //  decimal insertedQty2 = EditModel.TempInsertedQty ?? 0;

            AvailableBookQty = GetCrateAnalysis.FirstOrDefault()?.PrebookQty ?? 0;


            decimal TotalQty = (EditModel.PreInwardQty ?? 0) + (EditModel.TempInsertedQty ?? 0);





            if (TotalQty > AvailableBookQty)
            {
                DialogMessage = $"Entered quantity exceeds the available Booking Qty";
                ShowEmptyFieldDialog = true;

                return;
            }


            // GetchamberAnalysis = await EmployeeService.CheckChamberStatus(selectetGrowerGroup);

            // decimal   ActiveChamberQty = GetchamberAnalysis.FirstOrDefault()?.ChamberAvailQty ?? 0;
            // int Chamberid=GetchamberAnalysis.FirstOrDefault()?.ChamberId ?? 0;

            // EditModel.ChamberId = Chamberid;
            // EditModel.ChamberAvailQty = ActiveChamberQty;


            // if (TotalQty > EditModel.ChamberAvailQty)
            // {
            //     DialogMessage = $"Entered quantity cannot exceed available Active Chamber ({Chamberid}) quantity ({ActiveChamberQty}).";
            //     ShowEmptyFieldDialog = true;
            //     return;
            // }


            if (EditModel.PreCrateType == "OWN")
            {
                EditModel.OwnQty= EditModel.PreInwardQty;
                EditModel.StoreQty = 0;
            }

            if (EditModel.PreCrateType == "COMPANY")
            {
                EditModel.StoreQty= EditModel.PreInwardQty;
                EditModel.OwnQty=0;
            }

            EditModel.GrowerGroupName = selectetGrowerGroup;



            var resultUpload = await EmployeeService.AddPreinward(EditModel);
            if (resultUpload != null && resultUpload.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(resultUpload.RetMessage))
            {
                DialogMessage = resultUpload.RetMessage;
                ShowEmptyFieldDialogError = true;

                ShowCrateAnalysis = false;

                string CuserName = EditModel.GlobalUserName;
                GetDailyPreinwardtemp = await EmployeeService.GetDailyPreinwardProctemp(EditModel.TempGateInId);

                //  
                // // GetCrateMark=await EmployeeService.GetallCrateMarks();
                //      companyModel = await EmployeeService.GetCrateOrderNo();
                // GrowerGroupKey = Guid.NewGuid().ToString();

                // EditModel.GrowerGroupName = String.Empty;
                // EditModel.ChallanName = String.Empty;
                // // EditModel.CrissueMark = String.Empty;
                // EditModel.PreInwardRemarks = "";
                EditModel.PreInwardQty = 0;
                EditModel.PreInwardKhata = String.Empty;
                EditModel.PreCrateType = String.Empty;
                // EditModel.GrowerName = String.Empty;
                EditModel.VarietyId = String.Empty;
                // EditModel.Itemname = String.Empty;
                // EditModel.ServiceId = String.Empty;
                //   EditModel.Prodname  = String.Empty;
                // EditModel.Vehno = String.Empty;
                //EditModel.PreInwardUom = String.Empty;


                // selectedSubgrower= String.Empty;
                ShowBoth = false;
                // Purchaseorders = await EmployeeService.GetCrateorders();
                // GetMaxCrateId = await EmployeeService.GetMaxCrateIdno();
                // int cid=0;
                // cid= GetMaxCrateId.FirstOrDefault()?.CrissueId ?? 0;
                // EditModel.CrissueId = cid;

                // await  GeneratePreviewbyid(EditModel.CrissueId);
                // StateHasChanged();
                return;
            }


            if (resultUpload != null && resultUpload.RetFlag.Trim() == "FALSE")
            {

                DialogMessage = resultUpload.RetMessage ?? "Failed to add Master Group.";
                ShowEmptyFieldDialog = true;

                return;
            }


        }
        finally
        {
            isProcessing = false;
        }
    }














    protected async Task PostOrder()
    {
        if (EditModel.PurchaseOrderId <= 0)
        {
            DialogMessage = "Please enter a valid Order No";
            ShowEmptyFieldDialog = true;
            return;
        }
        selectedGrowerId = EditModel.PurchaseOrderId;
        companyModel = await EmployeeService.CheckPurchaseOrder(selectedGrowerId);


        string Orderstat = companyModel.PurchaseOrderStatus;

        if (Orderstat== "POST")
        {
            DialogMessage = "Order is already Posted";
            ShowEmptyFieldDialog = true;
            return;
        }

        if (Orderstat == "UNPOST")
        {

            PostDialog = true;
            return;
        }


    }
    protected async Task UnpostOrder()
    {
        if (EditModel.PurchaseOrderId <= 0)
        {
            DialogMessage = "Please enter a valid Order No";
            ShowEmptyFieldDialog = true;
            return;
        }
        selectedGrowerId = EditModel.PurchaseOrderId;
        companyModel = await EmployeeService.CheckPurchaseOrder(selectedGrowerId);


        string Orderstat = companyModel.PurchaseOrderStatus;

        if (Orderstat == "UNPOST")
        {
            DialogMessage = "Order is not Posted";
            ShowEmptyFieldDialog = true;
            return;
        }

        if (Orderstat == "POST")
        {

            UnPostDialog = true;
            return;
        }


    }
    protected async Task CreatePrin()
    {
        EditModel.GrowerGroupName = AvailGrower;
        if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            DialogMessage = "Please Select  valid Grower Group Name";
            ShowEmptyFieldDialog = true;
            return;

        }


        if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
        {
            DialogMessage = "Please Select  valid Grower  Name";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.ChallanName))
        {
            DialogMessage = "Please Select  valid Challan  Name";
            ShowEmptyFieldDialog = true;
            return;

        }



        if (string.IsNullOrWhiteSpace(EditModel.ChallanNo))
        {
            DialogMessage = "Please Select  valid Challan  No";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.Vehno))
        {
            DialogMessage = "Please Select  valid Vehicle No";
            ShowEmptyFieldDialog = true;
            return;

        }




        if (string.IsNullOrWhiteSpace(EditModel.PreInwardRemarks))
        {
            EditModel.PreInwardRemarks = "";

        }

        selectetGrowerGroup = EditModel.GrowerGroupName;
        var result = await EmployeeService.CheckChamberAllocation(selectetGrowerGroup);


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Error";
            ShowEmptyFieldDialog = true;

            return;
        }








        PurDialog = true;




        // selectetGrowerGroup = EditModel.GrowerGroupName;
        // var result = await EmployeeService.CheckChamberAllocation(selectetGrowerGroup);


    }
    

    async Task PostPrn()
    {
        if (isProcessing) return;
        isProcessing = true;

        try


        {
            EditModel.GrowerGroupName = AvailGrower;

            if (string.IsNullOrWhiteSpace(EditModel.TempGateInIrn))
            {
                DialogMessage = "Please generate  valid Id";
                ShowEmptyFieldDialog = true;
                return;

            }

            if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
            {
                DialogMessage = "Please Select  valid Grower Group Name";
                ShowEmptyFieldDialog = true;
                return;

            }


            if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
            {
                DialogMessage = "Please Select  valid Grower  Name";
                ShowEmptyFieldDialog = true;
                return;

            }

            if (string.IsNullOrWhiteSpace(EditModel.ChallanName))
            {
                DialogMessage = "Please Select  valid Challan  Name";
                ShowEmptyFieldDialog = true;
                return;

            }




            if (string.IsNullOrWhiteSpace(EditModel.ChallanNo))
            {
                DialogMessage = "Please Select  valid Challan  No";
                ShowEmptyFieldDialog = true;
                return;

            }

            if (string.IsNullOrWhiteSpace(EditModel.Vehno))
            {
                DialogMessage = "Please Select  valid Vehicle No";
                ShowEmptyFieldDialog = true;
                return;

            }

            if (string.IsNullOrWhiteSpace(EditModel.PreInwardRemarks))
            {
                EditModel.PreInwardRemarks = "";

            }
            selectetGrowerGroup = EditModel.GrowerGroupName;



            var result = await EmployeeService.CheckChamberAllocation(selectetGrowerGroup);


            if (result != null && result.RetFlag.Trim() == "FALSE")
            {

                DialogMessage = result.RetMessage ?? "Error";
                ShowEmptyFieldDialog = true;

                return;
            }


            GetCrateAnalysis = await EmployeeService.CheckCratesAgreement(selectetGrowerGroup);


            companyModel = await EmployeeService.CheckInsertedQty(EditModel.TempGateInId);

            EditModel.TempInsertedQty = companyModel.TempInsertedQty;

            if (EditModel.TempInsertedQty == 0)
            {
                DialogMessage = "Please enter one item with qty";
                ShowEmptyFieldDialog = true;
                return;
            }

            AvailableBookQty = GetCrateAnalysis.FirstOrDefault()?.PrebookQty ?? 0;


            decimal TotalQty = (EditModel.PreInwardQty ?? 0) + (EditModel.TempInsertedQty ?? 0);





            if (TotalQty > AvailableBookQty)
            {
                DialogMessage = $"Entered quantity exceeds the available Booking Qty";
                ShowEmptyFieldDialog = true;

                return;
            }


            GetchamberAnalysis = await EmployeeService.CheckChamberStatus(selectetGrowerGroup);

            decimal ActiveChamberQty = GetchamberAnalysis.FirstOrDefault()?.ChamberAvailQty ?? 0;
            int Chamberid = GetchamberAnalysis.FirstOrDefault()?.ChamberId ?? 0;

            EditModel.ChamberId = Chamberid;
            EditModel.ChamberAvailQty = ActiveChamberQty;


            if (TotalQty > EditModel.ChamberAvailQty)
            {
                DialogMessage = $"Entered quantity cannot exceed available Active Chamber ({Chamberid}) quantity ({ActiveChamberQty}).";
                ShowEmptyFieldDialog = true;
                return;
            }



            EditModel.GrowerGroupName = selectetGrowerGroup;



            var resultUpload = await EmployeeService.PostPrn(EditModel);
            if (resultUpload != null && resultUpload.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(resultUpload.RetMessage))
            {
                await JS.InvokeVoidAsync("window.open", "/Thermal", "_blank");

                ShowCrateAnalysis = false;

                string CuserName = EditModel.GlobalUserName;
                dismissTimer = new System.Timers.Timer(3000); // 3 seconds
                dismissTimer.Elapsed += (sender, e) =>
                {
                    // This will run on a different thread, so we need to use InvokeAsync
                    InvokeAsync(() =>
                    {
                        ShowEmptyFieldDialogError = false;
                        StateHasChanged();
                        dismissTimer.Dispose();
                    });
                };
                    
                    
                    //   GetDailyPreinwardtemp = await EmployeeService.GetDailyPreinwardProctemp(EditModel.TempGateInId);

                    //
                    // // GetCrateMark=await EmployeeService.GetallCrateMarks();
                    //      companyModel = await EmployeeService.GetCrateOrderNo();
                    // GrowerGroupKey = Guid.NewGuid().ToString();

                    EditModel.GrowerGroupName = String.Empty;
                    EditModel.ChallanName = String.Empty;
                    // EditModel.CrissueMark = String.Empty;
                    EditModel.PreInwardRemarks = "";
                    EditModel.PreInwardQty = 0;
                    EditModel.PreInwardKhata = String.Empty;
                    EditModel.PreCrateType = String.Empty;
                    EditModel.GrowerName = String.Empty;
                    EditModel.VarietyId = String.Empty;
                    EditModel.Itemname = String.Empty;
                    EditModel.ServiceId = String.Empty;
                      EditModel.Prodname  = String.Empty;
                    EditModel.Vehno = String.Empty;
                EditModel.TempGateInIrn = String.Empty;
                    EditModel.PreInwardUom = String.Empty;
                ShowOtherButtons = false;
                ShowButtonAdd = true;

         

                    // selectedSubgrower= String.Empty;
                    ShowBoth = false;
                    // Purchaseorders = await EmployeeService.GetCrateorders();
                    // GetMaxCrateId = await EmployeeService.GetMaxCrateIdno();
                    // int cid=0;
                    // cid= GetMaxCrateId.FirstOrDefault()?.CrissueId ?? 0;
                    // EditModel.CrissueId = cid;

                    // await  GeneratePreviewbyid(EditModel.CrissueId);
                    // StateHasChanged();
                    return;
                }


                if (resultUpload != null && resultUpload.RetFlag.Trim() == "FALSE")
                {

                    DialogMessage = resultUpload.RetMessage ?? "Failed to add Master Group.";
                    ShowEmptyFieldDialog = true;

                    return;
                }


            }
            finally
            {
                isProcessing = false;
            }
    
    }



    protected async Task UpdateCrateIssue()
    {

      //  EditModel.GrowerGroupName = AvailGrower;

        selectedGrowerId = EditModel.CrissueId;
        if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            DialogMessage = "Please Select  valid Grower Group Name";
            ShowEmptyFieldDialog = true;
            return;

        }

        if  (EditModel.CrissueId <= 0)
        {
            DialogMessage = "Please enter a valid idno greater than 0.";
            ShowEmptyFieldDialog = true;
            return;
        }

        if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
        {
            DialogMessage = "Please Select  valid Grower  Name";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.ChallanName))
        {
            DialogMessage = "Please Select  valid Challan  Name";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.CrissueMark))
        {
            DialogMessage = "Please Select  valid Crate  Mark";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.Vehno))
        {
            DialogMessage = "Please Select  valid Vehicle No";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (string.IsNullOrWhiteSpace(EditModel.CrissueRemarks))
        {
            EditModel.CrissueRemarks = "";

        }

        if (!EditModel.CrissueQty.HasValue || EditModel.CrissueQty <= 0)
        {
            DialogMessage = "Please enter a valid quantity greater than 0.";
            ShowEmptyFieldDialog = true;
            return;
        }

        selectetGrowerGroup=EditModel.GrowerGroupName;
        GetCrateAnalysis = await EmployeeService.CheckCratesParty(selectetGrowerGroup);
        decimal GrowerAvail = GetCrateAnalysis.FirstOrDefault()?.CrateAvailable ?? 0;
        GrowerAvail = GrowerAvail + actualidqty;

        if (EditModel.CrissueQty > GrowerAvail)
        {
            DialogMessage = $"Entered quantity cannot exceed available grower group quantity ({GrowerAvail}).";
            ShowEmptyFieldDialog = true;
            return;
        }


        selectedSubgrower=EditModel.GrowerName;
        GetCrateAnalysis = await EmployeeService.CheckCratesPartysub(selectedSubgrower,selectetGrowerGroup);

        decimal SubGrowerAvail = GetCrateAnalysis.FirstOrDefault()?.CrateAvailable ?? 0;
        SubGrowerAvail = SubGrowerAvail + actualidqty;


        if (EditModel.CrissueQty > SubGrowerAvail)
        {
            DialogMessage = $"Entered quantity cannot exceed available grower quantity ({SubGrowerAvail}).";
            ShowEmptyFieldDialog = true;
            return;
        }

       
        var result = await EmployeeService.UpdateCrateIssue(EditModel);
        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {
            DialogMessage = result.RetMessage;
            ShowEmptyFieldDialogError = true;

            ShowCrateAnalysis = false;



            GetDailyCrates=await EmployeeService.GetDailyCratesProc();

            //      //  
            //      // // GetCrateMark=await EmployeeService.GetallCrateMarks();
            //      //      companyModel = await EmployeeService.GetCrateOrderNo();
            //GrowerGroupKey = Guid.NewGuid().ToString();
        
            EditModel.GrowerGroupName = String.Empty;
            EditModel.ChallanName = String.Empty;
           // EditModel.CrissueMark = String.Empty;
            EditModel.CrissueRemarks = "";
             EditModel.CrissueQty = 0;
             EditModel.CrissueMark = String.Empty;
             EditModel.Vehno = String.Empty;
               EditModel.GrowerName = String.Empty;
               selectedSubgrower= String.Empty;
               Purchaseorders = await EmployeeService.GetCrateorders();
               companyModel = await EmployeeService.GetCrateOrderNo();
            StateHasChanged();
            return;
        }


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to add Master Group.";
            ShowEmptyFieldDialog = true;

            return;
        }




        






    }



    void Grid_CustomizeElement(GridCustomizeElementEventArgs e)
    {
        if (e.ElementType == GridElementType.DataRow && e.VisibleIndex % 2 == 1)
        {
            e.CssClass = "alt-item";
        }
        if (e.ElementType == GridElementType.HeaderCell)
        {
            e.Style = "background-color: var(--DS-color-surface-neutral-default-selected)";
            e.CssClass = "header-bold";
        }


    }


    public class Order
    {
        public int? OrderID { get; set; }
        public string CustomerID { get; set; }
        public DateTime? OrderDate { get; set; }
        public double? Freight { get; set; }
    }
}
<style>

    /* Updated Color Coding based on Utilization */
    .high-utilization {
        background: linear-gradient(135deg, #dc3545, #c82333);
        border-left: 4px solid #bd2130;
    }

    .medium-utilization {
        background: linear-gradient(135deg, #fd7e14, #e55a00);
        border-left: 4px solid #cc4c00;
    }

    .low-utilization {
        background: linear-gradient(135deg, #ffc107, #e0a800);
        border-left: 4px solid #d39e00;
    }

    .very-low-utilization {
        background: linear-gradient(135deg, #28a745, #218838);
        border-left: 4px solid #1e7e34;
    }

    /* Quantity Value Styling */
    .qty-item .value.allocated {
        color: #dc3545 !important;
        font-weight: bold;
    }

    .qty-item .value.remaining {
        color: #28a745 !important;
        font-weight: bold;
    }

    .qty-item .value.available {
        color: #17a2b8 !important;
        font-weight: bold;
    }

    /* Progress Section */
    .progress-section {
        margin: 15px 0;
    }

        .progress-section label {
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 5px;
            display: block;
        }

    .progress-stats {
        display: flex;
        justify-content: space-between;
        font-size: 0.8em;
        margin-top: 5px;
    }

    /* Availability Status */
    .availability-status {
        text-align: center;
        margin-top: 10px;
    }

        .availability-status .badge {
            font-size: 0.8em;
            padding: 4px 8px;
        }

</style>