@page "/DockInspection/{Growerid:int}"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Hosting
@using Microsoft.Extensions.Hosting
@inject IWebHostEnvironment Env
@inject IWebHostEnvironment Environment
@inject NavigationManager NavigationManager
@inject HttpClient Http
@inject EmployeeAdoNetService EmployeeService
@using Syncfusion.Blazor
@inject NavigationManager NavigationManager
@using System.IO
@using Syncfusion.Blazor.DropDowns
@using DevExpress.XtraReports.UI
@using DevExpress.Blazor.Reporting
@using BlazorDemo.Services;
@using BlazorDemo;
@inject IJSRuntime JS
<link href="_content/DevExpress.Blazor.Themes/blazing-berry.bs5.min.css" rel="stylesheet" />
<link rel="stylesheet" href="_content/DevExpress.Blazor.Reporting.Viewer/css/dx-blazor-reporting-components.bs5.css">
 <PageTitle>Dock Inspection</PageTitle>
<style>
    .custom-messagebox {
        border: 2px solid #0078D4; /* Blue border */
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* Optional shadow */
    }

    label {
        font-weight: 600;
    }
    /* Slightly darker but still subtle placeholder */
    .input-placeholder-dim::placeholder {
        color: rgba(130, 130, 130, 0.3) !important; /* dim gray, 30% opacity */
        opacity: 1 !important;
    }

    /* Dark gray border on focus, no shadow */
    .input-focus-dark:focus {
        border-color: #343a40; /* dark gray */
        box-shadow: none !important;
        outline: none;
    }

    .table-responsive {
        overflow-x: auto;
        width: 100%;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem; /* optional small font */
    }

        .table th, .table td {
            padding: 0.5rem;
            text-align: left;
        }

    .zebra-table tbody tr:nth-child(odd) {
        background-color: white;
    }

    .zebra-table tbody tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    .page-header {
        background-color: #1e1e2f; /* Dark background */
        color: white; /* Makes all text inside white */
        padding: 15px 20px;
        border-bottom: 1px solid #444;
    }

        .page-header h2 {
            margin: 0;
            font-weight: 600;
            color: white; /* Optional, to ensure specificity */
            font-size: 1rem;
        }


    /* Custom small font */
    .small-font {
        font-size: 0.82rem;
    }

    .control-wrapper {
        max-width: 250px;
        margin: 0 auto;
        padding: 50px 0px 0px;
    }

    .example-label {
        font-size: 14px;
        margin-bottom: 6px;
        /* Standardize form control styles for horizontal alignment */
        input .form-control, .e-input-group, .e-control-wrapper, .e-autocomplete, .e-input

    {
        min-height: 38px; /* Bootstrap default */
        line-height: 1.5;
        font-size: 14px;
        font-family: 'Source Sans Pro', sans-serif;
        padding: 6px 12px;
        box-sizing: border-box;
    }

    /* Optional: Align content inside Syncfusion AutoComplete */
    .e-autocomplete .e-input {
        padding: 6px 12px !important;
    }

    /* Remove extra bottom spacing in SfAutoComplete wrapper */
    .e-autocomplete.e-control-wrapper {
        margin-bottom: 0 !important;
    }

    /* Align labels consistently */
    label.form-label {
        font-size: 14px;
        margin-bottom: 4px;
        font-family: 'Source Sans Pro', sans-serif;
    }

    /* Remove extra vertical margin if any Syncfusion adds it */
    .e-control-wrapper {
        margin-top: 0 !important;
        margin-bottom: 0 !important;
    }

</style>

<EditForm Model="@EditModel">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="wrapper row-offcanvas row-offcanvas-left">
        <div class="row">
            <div class="col-md-12">
                       <div class="card p-3 mb-4" style="border: 2px solid darkgrey; background-color: white;">

                            <h4 class="box-title">Dockyard Inspection <small>- Edit</small></h4>
                         
                        <div class="d-flex justify-content-end gap-2">
                            <button @onclick="PostQuality" class="btn btn-primary btn-sm">Save</button>
                        <a @onclick="GoBack" class="btn btn-info btn-sm text-white">
                                <i class="fa fa-arrow-left"></i> Back
                            </a>
                        </div>
                    </div>
                </div>
            </div>
    </div> 
            <div class="col-md-12">
                <input type="hidden" value="@EditModel.PreInwardCode" />
            </div>

            <div class="col-md-12">
                <div class="box box-primary">
                    <div class="box-body">
                        <div class="form-group">
                            <div class="row">
                                <div class="col-sm-12">
                                    <table id="example2">
                                        <tbody>
                                            <tr>
                                                <td style="text-align: left;">
                                                    <b>Grower Group : </b>@EditModel.GrowerGroupName
                                                    @if (EditModel.IsInvestor)
                                                    {
                                                        <span class="redtext">@EditModel.InvestorText</span>
                                                    }
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="text-align: left;"><b>Grower Name : </b>@EditModel.GrowerName</td>
                                            </tr>
                                    <tr>
                                        <td style="text-align: left;"><b>Challan Name : </b>@EditModel.ChallanName</td>
                                    </tr>

                                    <tr>
                                        <td style="text-align: left;"><b>Challan No : </b>@EditModel.ChallanNo</td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: left;"><b>Remarks : </b>@EditModel.PreInwardRemarks</td>
                                    </tr>
                                    <tr>
                                                <td style="text-align: left;"><b>Lot : </b>@EditModel.LotIrn</td>
                                            </tr>
                                            <tr>
                                                <td style="text-align: left;"><b>Item Name : </b>@EditModel.Itemname</td>
                                            </tr>
                                    <tr>
                                        <td style="text-align: left;"><b>Chamber No : </b>@EditModel.ChamberId</td>
                                    </tr>
                                            <tr>
                                                <td style="text-align: left;"><b>Variety : </b>@EditModel.VarietyId</td>
                                            </tr>
                                            <tr>
                                                <td style="text-align: left;"><b>PreInward Date : </b>@EditModel.PreInwardDate.ToShortDateString()</td>
                                            </tr>

                                    <tr>
                                        <td style="text-align: left;"><b>Tentative Qty : </b>@EditModel.PreInwardQty</td>
                                    </tr>
                                
                                    <tr>
                                        <td style="text-align: left;"><b>UOM : </b>@EditModel.PreInwardUom</td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: left;"><b>Quality Checked : </b>@EditModel.PreinwardStatus</td>
                                    </tr>
                                  

                                </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                  

                                    <div class="form-group">
                                        <label for="lotNo"><span class="redtext">*</span></label>
                                        <input class="form-control input-placeholder-dim input-focus-dark"type="text" value="@EditModel.LotNo" disabled />
                                    </div>

                                   <br />

                                    <div class="form-group">
                <label for="brand">Location<span class="redtext">*</span></label>
                <DxComboBox Data="@GetallLocation"
                            SearchMode="@SearchMode"
                            SearchFilterCondition="@SearchFilterCondition"
                            SearchTextParseMode="@SearchTextParseMode"
                            @bind-Value="EditModel.Templocation"
                            TextFieldName="Templocation"
                            ValueFieldName="Templocation"
                            CssClass="custom-input-height"
                            InputId="cbFiltering"
                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />


                <br />


                <label for="avgWeight1">Verified Qty</label>
                <input type="number"  min="0" @bind="EditModel.VerfiedQty" @bind:event="oninput" class="form-control input-placeholder-dim input-focus-dark" />


                <br />

                <label for="avgWeight1">Verified Own Crates</label>
                <input type="number" min="0" @bind="EditModel.VerfiedOwnCrates" @bind:event="oninput" class="form-control input-placeholder-dim input-focus-dark" />


<br />
                <label for="avgWeight1">Verified Company Crates</label>
<input type="number" min="0" @bind="EditModel.VerfiedCompanyCrates" @bind:event="oninput" class="form-control input-placeholder-dim input-focus-dark" />


<br />
<label for="avgWeight1">Verified Wooden Petties</label>
<input type="number" min="0" @bind="EditModel.Verfiedpetties" @bind:event="oninput" class="form-control input-placeholder-dim input-focus-dark" />


<br />
                <label for="Crate Marka">Crate Marka</label>
                <input type="text" @bind="EditModel.CrateMarka" @bind:event="oninput" class="form-control input-placeholder-dim input-focus-dark" />


                <br />

                <label for="brand">Variety<span class="redtext">*</span></label>
                                     <DxComboBox Data="@banks"
                        SearchMode="@SearchMode"
                        SearchFilterCondition="@SearchFilterCondition"
                        SearchTextParseMode="@SearchTextParseMode"
                        @bind-Value="EditModel.VarietyId"
                        TextFieldName="Qname"
                        ValueFieldName="Qname"
                            CssClass="custom-input-height"
                        InputId="cbFiltering"

                        ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />


                <br />


                <label for="avgWeight1">No of Pallets ?</label>
                <input type="number" min="0" @bind="EditModel.Verfiedpallets" @bind:event="oninput" class="form-control input-placeholder-dim input-focus-dark" />
                <br />


                <label for="avgWeight1">No of Bins?</label>
                <input type="number" min="0" @bind="EditModel.Verfiedbins" @bind:event="oninput" class="form-control input-placeholder-dim input-focus-dark" />




            </div>
                                      
                                </div>

</div>

<br />
    <div class="col-md-4 d-flex align-items-center">
        <label for="chk1" class="me-2 mb-0">For Grading??</label>
        <input type="checkbox" id="chk1" @bind="EditModel.IsGrading" />
    </div>

    <br />
            <div class="col-md-12">
                <div class="box-footer btnfloat">
                    <button @onclick="PostQuality" class="btn btn-primary btn-sm">Save</button>
            <button @onclick="PostQualitywithprint" class="btn btn-primary btn-sm">Save & Print</button>

                </div>
            </div>
    
</EditForm>
@if (ShowEmptyFieldDialog)
{
<DxPopup @bind-Visible="@ShowEmptyFieldDialog"
         HeaderText="Validation Error"
         ShowCloseButton="true"
         CssClass="validation-dialog">
    <Content>
        <p>@DialogMessage</p>
        <DxButton Text="OK" Click="@(() => ShowEmptyFieldDialog = false)" />
    </Content>
</DxPopup>
}


<!-- Image Modal -->
@if (showModal && !string.IsNullOrEmpty(modalImageUrl))
{
    <div class="modal fade show" style="display: block;" id="imagemodal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <button type="button" class="btn-close" @onclick="CloseModal" aria-label="Close"></button>
                    <br /><br />
                    <div class="box box-solid">
                        <div class="box-body">
                        
                            <img src="@modalImageUrl?v=@DateTime.Now.Ticks" alt="Preview Image" />
                            <div class="carousel slide" data-ride="carousel">
                               
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
 
<DxPopup @bind-Visible="@StickVisible"
         HeaderText="Print Stickers"
         Width="500px">
    <Content>
        
            <!-- First Row -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Unit Name</label>
                <DxComboBox Data="@GetAllUnits"
                          
                            SearchMode="@SearchMode"
                            SearchFilterCondition="@SearchFilterCondition"
                            SearchTextParseMode="@SearchTextParseMode"
                            @bind-Value="EditModel.Unitname"
                            TextFieldName="Unitname"
                            ValueFieldName="Unitname"
                            placeholder="No"
                            CssClass="cw-480"
                            InputId="cbFiltering"
                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />




            </div>
                <div class="col-md-6">
                    <label class="form-label">No of Stickers</label>
                    <input type="number" min="0" id="remarks"
                               style="font-size: 14px; height: 30px; font-family: 'Source Sans Pro', sans-serif;"
                               class="form-control input-placeholder-dim input-focus-dark"
                               @bind="EditModel.StickerNo"
                               placeholder="No of stickers" />
                </div>
            </div>

            <div class="modal-footer" style="display: flex; justify-content: space-between; flex-direction: row-reverse;">
                <div class="d-flex gap-2">
                    <DxButton class="btn btn-primary btn-sm" Text="Print" @onclick="PrintSticker" />
                <DxButton class="btn btn-primary btn-sm" Text="Cancel" @onclick="HideSticker" />
                </div>
            </div>
     
    </Content>
</DxPopup>




@* @if (showModal && !string.IsNullOrEmpty(modalImageUrl))
{
  
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Image Preview</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal" aria-label="Close"></button>
              
                </div>
                <div class="modal-body text-center">
                    <img src="@modalImageUrl" class="img-fluid" />
                </div>
            </div>
        </div>
    </div>
}

 *@

@code 
{
    [Parameter] public int Growerid { get; set; }
    bool ShowImageModal { get; set; } = false;
    private CompanyModel EditModel = new();
    bool image1 { get; set; } = false;
    bool image2 { get; set; } = false;
    bool image3 { get; set; } = false;
    private string? image1File, image2File, image3File;
    CompanyModel companyModel = new CompanyModel();
    ListSearchMode SearchMode { get; set; } = ListSearchMode.AutoSearch;
    ListSearchFilterCondition SearchFilterCondition { get; set; } = ListSearchFilterCondition.Contains;
    ListSearchTextParseMode SearchTextParseMode { get; set; } = ListSearchTextParseMode.GroupWordsByAnd;
    List<CompanyModel> banks = new List<CompanyModel>();
    private bool StickVisible { get; set; } = false;

    private decimal AvailableBookQty = 0;
  
    List<CompanyModel> GetAllUnits = new List<CompanyModel>();
    List<CompanyModel> Runningchambers = new List<CompanyModel>();

    List<CompanyModel> GetallLocation = new List<CompanyModel>();
    List<CompanyModel> GetCrateAnalysis = new List<CompanyModel>();
    private string selectetGrowerGroup = null;
    private bool showModal = false;
    private string? modalImageUrl;
    private string? Path1;
    private string? Extensionnew;
    private string AverageWeight => CalculateAverageweight();
    private string AverageBgrade => CalculateAverageBgrade();
    @code {
        private bool SelectAll;
        private bool ShowEmptyFieldDialog { get; set; }
        private bool ShowEmptyFieldDialogError { get; set; }



        private void ToggleAllDefects(Microsoft.AspNetCore.Components.ChangeEventArgs e)
        {
            bool isChecked = (bool)e.Value;

            EditModel.HasWaterCore = isChecked;
            EditModel.HasScab = isChecked;
            EditModel.HasBitterRot = isChecked;
            EditModel.HasOlla = isChecked;
            EditModel.HasFlySpeck = isChecked;
            EditModel.HasRusting = isChecked;
            EditModel.HasBitterPit = isChecked;
            EditModel.HasBlouch = isChecked;
            EditModel.HasSanjose = isChecked;
            EditModel.HasTouch = isChecked;
            EditModel.HasSunburn = isChecked;
            EditModel.HasInsectHole = isChecked;
            EditModel.HasScar = isChecked;
        }
    }


    public static string ConvertFilePathToUrl(string filePath, string baseLocalPath, string baseUrlPath)
    {
    string relativePath = filePath.Substring(baseLocalPath.Length).TrimStart(Path.DirectorySeparatorChar);
    return baseUrlPath.TrimEnd('/') + "/" + relativePath.Replace(Path.DirectorySeparatorChar, '/');
    }

    private string CalculateAverageBgrade()
    {
    if (EditModel.BGradeAvg1.HasValue &&
        EditModel.BGradeAvg2.HasValue)
    {
        var avg = (EditModel.BGradeAvg1.Value +
                   EditModel.BGradeAvg2.Value)
           / 2;
        EditModel.BGradeAvgValue = Math.Round(avg, 2);
        return Math.Round(avg, 2).ToString();
    }
    EditModel.BGradeAvgValue = null;
    return string.Empty;
    }



    private string AveragePressure => CalculateAveragePressure();
    private async void ShowModal(string filePath)
    {
    var extensions = new[] { ".jpg", ".jpeg", ".png", ".bmp" };
    var uploadsPath = Path.Combine(Env.WebRootPath, "uploads");
    string extensionsn = ".jpeg";
    int selectedlot = EditModel.Lotno;

    image1 = CheckIfImageExists($"{selectedlot}-1", uploadsPath, extensions);


    Path1 = Path.Combine(uploadsPath, $"{selectedlot}-1" + Extensionnew);




    string imageUrl = ConvertFilePathToUrl(Path1, uploadsPath, "/uploads/");
    modalImageUrl = imageUrl;

    showModal = true;
    }

        List<CompanyModel> GetchamberAnalysis = new List<CompanyModel>();
   decimal TotalQty=0;
        decimal actualidqty = 0;


            private async void ShowModal2(string filePath)
    {
    var extensions = new[] { ".jpg", ".jpeg", ".png", ".bmp" };
    var uploadsPath = Path.Combine(Env.WebRootPath, "uploads");
    string extensionsn = ".jpeg";
    int selectedlot = EditModel.Lotno;

    image2 = CheckIfImageExists($"{selectedlot}-2", uploadsPath, extensions);



    Path1 = Path.Combine(uploadsPath, $"{selectedlot}-2" + Extensionnew);




    string imageUrl = ConvertFilePathToUrl(Path1, uploadsPath, "/uploads/");
    modalImageUrl = imageUrl;

    showModal = true;
    }



    private  void ShowModal3(string filePath)
    {
    var extensions = new[] { ".jpg", ".jpeg", ".png", ".bmp" };
    var uploadsPath = Path.Combine(Env.WebRootPath, "uploads");

    int selectedlot = EditModel.Lotno;
    image3 = CheckIfImageExists($"{selectedlot}-3", uploadsPath, extensions);



    Path1 = Path.Combine(uploadsPath, $"{selectedlot}-3" + Extensionnew);




    string imageUrl = ConvertFilePathToUrl(Path1, uploadsPath, "/uploads/");
    modalImageUrl = imageUrl;

    showModal = true;
    }





    private void CloseModal()
    {
    //
    modalImageUrl = null;
    showModal = false;

    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
    var file = e.File;

    if (file != null)
    {
        var extension = Path.GetExtension(file.Name);
        var fname = EditModel.Lotno + "-1";
        var customFileName = $"{fname}{extension}";
        var resizedImage = await file.RequestImageFileAsync("image/jpeg", 800, 800); // Resize to 800x800 max
        var stream = resizedImage.OpenReadStream(1024 * 1024); // Limit to 1MB stream (optional)

        var streamContent = new StreamContent(stream);
        streamContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("image/jpeg");

        var content = new MultipartFormDataContent();



        content.Add(streamContent, "file", customFileName);

        try
        {

            var url = NavigationManager.BaseUri + $"api/upload?filename={Uri.EscapeDataString(customFileName)}";
            var response = await Http.PostAsync(url, content);
            // var response = await Http.PostAsync($"/api/upload?filename={Uri.EscapeDataString(customFileName)}", content);

            if (response.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("alert", "Upload successful!");
                image1 =true;
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Upload failed: {response.StatusCode}\n{errorMsg}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Exception: {ex.Message}");
        }
    }
    }   

    private async Task HandleFileSelected2(InputFileChangeEventArgs e)
    {
    var file = e.File;

    if (file != null)
    {
        var extension = Path.GetExtension(file.Name);
        var fname = EditModel.Lotno + "-2";
        var customFileName = $"{fname}{extension}";
        var resizedImage = await file.RequestImageFileAsync("image/jpeg", 800, 800); // Resize to 800x800 max
        var stream = resizedImage.OpenReadStream(1024 * 1024); // Limit to 1MB stream (optional)

        var streamContent = new StreamContent(stream);
        streamContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("image/jpeg");

        var content = new MultipartFormDataContent();



        content.Add(streamContent, "file", customFileName);

        try
        {

            var url = NavigationManager.BaseUri + $"api/upload?filename={Uri.EscapeDataString(customFileName)}";
            var response = await Http.PostAsync(url, content);
            // var response = await Http.PostAsync($"/api/upload?filename={Uri.EscapeDataString(customFileName)}", content);

            if (response.IsSuccessStatusCode)
            {
                image2 = true;
                await JS.InvokeVoidAsync("alert", "Upload successful!");
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Upload failed: {response.StatusCode}\n{errorMsg}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Exception: {ex.Message}");
        }
    }
    }
    private async Task HandleFileSelected3(InputFileChangeEventArgs e)
    {
    var file = e.File;

    if (file != null)
    {
        var extension = Path.GetExtension(file.Name);
        var fname = EditModel.Lotno + "-3";
        var customFileName = $"{fname}{extension}";
        var resizedImage = await file.RequestImageFileAsync("image/jpeg", 800, 800); // Resize to 800x800 max
        var stream = resizedImage.OpenReadStream(1024 * 1024); // Limit to 1MB stream (optional)

        var streamContent = new StreamContent(stream);
        streamContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("image/jpeg");

        var content = new MultipartFormDataContent();



        content.Add(streamContent, "file", customFileName);

        try
        {

            var url = NavigationManager.BaseUri + $"api/upload?filename={Uri.EscapeDataString(customFileName)}";
            var response = await Http.PostAsync(url, content);
            // var response = await Http.PostAsync($"/api/upload?filename={Uri.EscapeDataString(customFileName)}", content);

            if (response.IsSuccessStatusCode)
            {
                image3 = true;
                await JS.InvokeVoidAsync("alert", "Upload successful!");
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Upload failed: {response.StatusCode}\n{errorMsg}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Exception: {ex.Message}");
        }
    }
    }

        DxReportViewer? reportViewer;
        XtraReport? Report;

     private async Task PrintSticker()
        {

            
    if (string.IsNullOrWhiteSpace(EditModel.Unitname) || string.IsNullOrWhiteSpace(EditModel.Unitname))
        {
            DialogMessage = "Please Enter the valid Printer Location";
            ShowEmptyFieldDialog = true;
            return;
        }

    if (string.IsNullOrWhiteSpace(EditModel.Unitname) || string.IsNullOrWhiteSpace(EditModel.Unitname))
    {
        DialogMessage = "Please Enter the valid Printer Location";
        ShowEmptyFieldDialog = true;
        return;
    }

    if (!EditModel.StickerNo.HasValue || EditModel.StickerNo < 0)

    {
        DialogMessage = "Please enter Valid sticker no";
        ShowEmptyFieldDialog = true;
        return;
    }


    await EmployeeService.GetPrinter(EditModel.Unitname);


    string printername=companyModel.Sprinter;

  
    await EmployeeService.GenerateStickers(EditModel.Lotno, EditModel.Unitname, EditModel.StickerNo??0);






    Report = XtraReport.FromFile(Path.Combine(Directory.GetCurrentDirectory(),
    @"Reports\Fstickers.repx"));
    Report.Print(printername);


   
        
        }



        private async Task HideSticker()
        {
  
        }





        private async Task GoBack()
        {
    await JS.InvokeVoidAsync("history.back");
        }

    protected override async Task OnInitializedAsync()
    {
    int selectedGrowerId=Growerid;

    EditModel = await EmployeeService.GetLotFullDet(selectedGrowerId);
    int selectedlot=EditModel.Lotno;

    banks = await EmployeeService.GetallQuality();
    GetAllUnits = await EmployeeService.GetallUnits();

    int selectedid = EditModel.Partyid;

     GetallLocation = await EmployeeService.GetTemplocations();



    }
        private string DialogMessage { get; set; } = "";

    private bool CheckIfImageExists(string baseFileName, string folderPath, string[] extensions)
    {
    foreach (var ext in extensions)
    {
        var fullPath = Path.Combine(folderPath, baseFileName + ext);
        if (System.IO.File.Exists(fullPath))
        {
            Extensionnew = ext;

            return true;
        }
    }
    return false;
    }

        private bool isProcessing = false;


        async Task PostQuality()
        {
    if (isProcessing) return;
    isProcessing = true;

    try


    {



        if (string.IsNullOrWhiteSpace(EditModel.Templocation) || string.IsNullOrWhiteSpace(EditModel.Templocation))
        {
            DialogMessage = "Please Enter the valid Location";
            ShowEmptyFieldDialog = true;
            return;
        }
        @* EditModel.AvgPressure *@

        if (!EditModel.VerfiedQty.HasValue || EditModel.VerfiedQty < 0)

        {
            DialogMessage = "Please enter Valid Verified Qty";
            ShowEmptyFieldDialog = true;
            return;
        }


        if (!EditModel.VerfiedCompanyCrates.HasValue || EditModel.VerfiedCompanyCrates < 0)

        {
            EditModel.VerfiedCompanyCrates ??= 0;
        }

        

        if (!EditModel.VerfiedOwnCrates.HasValue || EditModel.VerfiedOwnCrates < 0)
        {
            EditModel.VerfiedOwnCrates ??= 0;
        }
        
        
        if (!EditModel.Verfiedpetties.HasValue || EditModel.Verfiedpetties < 0)
        {
            EditModel.Verfiedpetties ??= 0;
        }



        decimal totalCrates =
     (EditModel.VerfiedCompanyCrates ?? 0) +
     (EditModel.VerfiedOwnCrates ?? 0) +
     (EditModel.Verfiedpetties ?? 0);

      @*   await JS.InvokeVoidAsync("alert", totalCrates);
        await JS.InvokeVoidAsync("alert", EditModel.VerfiedOwnCrates);
        await JS.InvokeVoidAsync("alert", EditModel.VerfiedQty);




 *@
        if (EditModel.VerfiedQty != totalCrates)
        {
            DialogMessage = "Verified Qty must equal the sum of Company Crates, Own Crates, and Wooden Petties.";
            ShowEmptyFieldDialog = true;
            return;
        }

        if (!EditModel.Verfiedbins.HasValue || EditModel.Verfiedbins < 0)

        {
            DialogMessage = "Please enter Valid Bin Qty";
            ShowEmptyFieldDialog = true;
            return;
        }

        if (!EditModel.Verfiedpallets.HasValue || EditModel.Verfiedpallets < 0)

        {
            DialogMessage = "Please enter Valid pallet Qty";
            ShowEmptyFieldDialog = true;
            return;
        }

        if (string.IsNullOrWhiteSpace(EditModel.CrateMarka) || string.IsNullOrWhiteSpace(EditModel.CrateMarka))
        {
            DialogMessage = "Please Enter the lot variety";
            ShowEmptyFieldDialog = true;
            return;
        }
        selectetGrowerGroup = EditModel.GrowerGroupName;
        GetCrateAnalysis = await EmployeeService.CheckCratesAgreementonVqty(selectetGrowerGroup);



        AvailableBookQty = GetCrateAnalysis.FirstOrDefault()?.PrebookQty ?? 0;


        decimal TotalQty = (EditModel.VerfiedQty ?? 0);





        if (TotalQty > AvailableBookQty)
        {
            DialogMessage = $"Entered quantity exceeds the available Booking Qty";
            ShowEmptyFieldDialog = true;

            return;
        }
        int chamberid = EditModel.ChamberId;

        GetchamberAnalysis = await EmployeeService.CheckChamberQty(selectetGrowerGroup, chamberid);

        decimal ActiveChamberQty = GetchamberAnalysis.FirstOrDefault()?.ChamberAvailQty ?? 0;
        EditModel.ChamberAvailQty = ActiveChamberQty;
        ActiveChamberQty = ActiveChamberQty + EditModel.PreInwardQty??0;

        if (TotalQty > EditModel.ChamberAvailQty)
        {
            DialogMessage = $"Entered quantity cannot exceed available Active Chamber ({chamberid}) quantity ({ActiveChamberQty}).";
            ShowEmptyFieldDialog = true;
            return;
        }





       
















    
    
    
    int selectedlot = EditModel.Lotno;

        var result = await EmployeeService.UpdateDock(EditModel);
        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {
            NavigationManager.NavigateTo("/DockyardMain", forceLoad: true);




                       return;
        }


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to add Master Group.";
            ShowEmptyFieldDialog = true;

            return;
        }





    }
    finally
    {
        isProcessing = false;
    }
        }

        async Task PostQualitywithprint()
        {
    if (isProcessing) return;
    isProcessing = true;

    try


    {



        if (string.IsNullOrWhiteSpace(EditModel.Templocation) || string.IsNullOrWhiteSpace(EditModel.Templocation))
        {
            DialogMessage = "Please Enter the valid Location";
            ShowEmptyFieldDialog = true;
            return;
        }
        @* EditModel.AvgPressure *@

        if (!EditModel.VerfiedQty.HasValue || EditModel.VerfiedQty < 0)

        {
            DialogMessage = "Please enter Valid Verified Qty";
            ShowEmptyFieldDialog = true;
            return;
        }
        if (!EditModel.VerfiedCompanyCrates.HasValue || EditModel.VerfiedCompanyCrates < 0)

        {
            EditModel.VerfiedCompanyCrates ??= 0;
        }



        if (!EditModel.VerfiedOwnCrates.HasValue || EditModel.VerfiedOwnCrates < 0)
        {
            EditModel.VerfiedOwnCrates ??= 0;
        }


        if (!EditModel.Verfiedpetties.HasValue || EditModel.Verfiedpetties < 0)
        {
            EditModel.Verfiedpetties ??= 0;
        }


        decimal totalCrates =
      (EditModel.VerfiedCompanyCrates ?? 0) +
      (EditModel.VerfiedOwnCrates ?? 0) +
      (EditModel.Verfiedpetties ?? 0);
        if (EditModel.VerfiedQty != totalCrates)
        {
            DialogMessage = "Verified Qty must equal the sum of Company Crates, Own Crates, and Wooden Petties.";
            ShowEmptyFieldDialog = true;
            return;
        }

        if (!EditModel.Verfiedbins.HasValue || EditModel.Verfiedbins < 0)

        {
            DialogMessage = "Please enter Valid Bin Qty";
            ShowEmptyFieldDialog = true;
            return;
        }

        if (!EditModel.Verfiedpallets.HasValue || EditModel.Verfiedpallets < 0)

        {
            DialogMessage = "Please enter Valid Bin Qty";
            ShowEmptyFieldDialog = true;
            return;
        }

        if (string.IsNullOrWhiteSpace(EditModel.CrateMarka) || string.IsNullOrWhiteSpace(EditModel.CrateMarka))
        {
            DialogMessage = "Please Enter the lot variety";
            ShowEmptyFieldDialog = true;
            return;
        }
        selectetGrowerGroup = EditModel.GrowerGroupName;
        GetCrateAnalysis = await EmployeeService.CheckCratesAgreementonVqty(selectetGrowerGroup);



        AvailableBookQty = GetCrateAnalysis.FirstOrDefault()?.PrebookQty ?? 0;


        decimal TotalQty = (EditModel.VerfiedQty ?? 0);





        if (TotalQty > AvailableBookQty)
        {
            DialogMessage = $"Entered quantity exceeds the available Booking Qty";
            ShowEmptyFieldDialog = true;

            return;
        }
        int chamberid = EditModel.ChamberId;

        GetchamberAnalysis = await EmployeeService.CheckChamberQty(selectetGrowerGroup, chamberid);

        decimal ActiveChamberQty = GetchamberAnalysis.FirstOrDefault()?.ChamberAvailQty ?? 0;
        EditModel.ChamberAvailQty = ActiveChamberQty;
        ActiveChamberQty = ActiveChamberQty + EditModel.PreInwardQty ?? 0;

        if (TotalQty > EditModel.ChamberAvailQty)
        {
            DialogMessage = $"Entered quantity cannot exceed available Active Chamber ({chamberid}) quantity ({ActiveChamberQty}).";
            ShowEmptyFieldDialog = true;
            return;
        }

























        int selectedlot = EditModel.Lotno;

        var result = await EmployeeService.UpdateDock(EditModel);
        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {
            StickVisible = true;



            return;
        }


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to add Master Group.";
            ShowEmptyFieldDialog = true;

            return;
        }





    }
    finally
    {
        isProcessing = false;
    }
        }


    private string CalculateAveragePressure()
    {
    if (EditModel.Pressure1.HasValue &&
        EditModel.Pressure2.HasValue &&
        EditModel.Pressure3.HasValue)
    {
        var avg = (EditModel.Pressure1.Value +
                   EditModel.Pressure2.Value +
                   EditModel.Pressure3.Value) / 3;
        EditModel.AvgPressure = Math.Round(avg, 2);
        return Math.Round(avg, 2).ToString();

    }

    return string.Empty;
    }



    private string CalculateAverageweight()
    {
    if (EditModel.AvgWeight1.HasValue &&
        EditModel.AvgWeight2.HasValue &&
        EditModel.AvgWeight3.HasValue)
    {
        var avg = (EditModel.AvgWeight1.Value +
                   EditModel.AvgWeight2.Value +
                   EditModel.AvgWeight3.Value) / 3;
        EditModel.AvgWeight= Math.Round(avg, 2);
        return Math.Round(avg, 2).ToString();
    }
    EditModel.AvgWeight = null;
    return string.Empty;
    }
}





 































<script>

    function calculateAvgPressure() {
        debugger
        var divideNo = 3;
        var strError = "";
        var isValid = true;
        var avg1 = $("#txtPressure1").val();
        var avg2 = $("#txtPressure2").val();
        var avg3 = $("#txtPressure3").val();
        if (avg1 != "") {
            if (isNaN(avg1)) {
                strError += 'Please valid Avg Pressure1<br/>';
                $('#txtPressure1').addClass("redborder");
                isValid = false;
            }
            else
                $('#txtPressure1').removeClass("redborder");
        }
        else {
            avg1 = "0";
            divideNo = divideNo - 1;
        }

        if (avg2 != "") {
            if (isNaN(avg2)) {
                strError += 'Please valid Avg Pressure2<br/>';
                $('#txtPressure2').addClass("redborder");
                isValid = false;
            }
            else
                $('#txtPressure2').removeClass("redborder");
        }
        else {
            avg2 = "0";
            divideNo = divideNo - 1;
        }

        if (avg3 != "") {
            if (isNaN(avg3)) {
                strError += 'Please valid Avg Pressure3<br/>';
                $('#txtPressure3').addClass("redborder");
                isValid = false;
            }
            else
                $('#txtPressure3').removeClass("redborder");
        }
        else {
            avg3 = "0";
            divideNo = divideNo - 1;
        }

        if (!isValid) {
            mAlert(strError, 'Error');
            setTimeout(function () { mAlertClose() }, 10000);
        }
        else if (divideNo > 0) {
            $("#txtPressure").val(((parseFloat(avg1) + parseFloat(avg2) + parseFloat(avg3)) / divideNo).toFixed(2));
        }
        else {
            $("#txtPressure").val("");
        }
    }
</script>