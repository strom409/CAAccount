@page "/EditGrowerAgreement/{GrowerId:int}"

@inject EmployeeAdoNetService EmployeeService
@using Syncfusion.Blazor
@using Syncfusion.Blazor.DropDowns
@inject NavigationManager NavigationManager
@using BlazorDemo.Services;
@using BlazorDemo;
@inject IJSRuntime JS
 <PageTitle>Edit Agreement Aggregate</PageTitle>
<style>
    @@media (max-width: 768px) {
        .dxbl-grid {
            width: 768px; /* Force minimum width */
        }
    }



    .alt-item {
        background-color: rgba(243, 244, 245, 1) !important;
    }

        .alt-item > td {
            --dxbl-grid-bg: rgba(243, 244, 245, 1) !important;
            background-color: rgba(243, 244, 245, 1) !important;
        }
</style>

<style>
    .custom-messagebox {
        border: 2px solid #0078D4; /* Blue border */
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* Optional shadow */
    }

    label {
        font-weight: 600;
    }
    /* Slightly darker but still subtle placeholder */
    .input-placeholder-dim::placeholder {
        color: rgba(130, 130, 130, 0.3) !important; /* dim gray, 30% opacity */
        opacity: 1 !important;
    }

    /* Dark gray border on focus, no shadow */
    .input-focus-dark:focus {
        border-color: #343a40; /* dark gray */
        box-shadow: none !important;
        outline: none;
    }

    .table-responsive {
        overflow-x: auto;
        width: 100%;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem; /* optional small font */
    }

        .table th, .table td {
            padding: 0.5rem;
            text-align: left;
        }

    .zebra-table tbody tr:nth-child(odd) {
        background-color: white;
    }

    .zebra-table tbody tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    .page-header {
        background-color: #1e1e2f; /* Dark background */
        color: white; /* Makes all text inside white */
        padding: 15px 20px;
        border-bottom: 1px solid #444;
    }

        .page-header h2 {
            margin: 0;
            font-weight: 600;
            color: white; /* Optional, to ensure specificity */
            font-size: 1rem;
        }


    /* Custom small font */
    .small-font {
        font-size: 0.82rem;
    }

    .control-wrapper {
        max-width: 250px;
        margin: 0 auto;
        padding: 50px 0px 0px;
    }

    .example-label {
        font-size: 14px;
        margin-bottom: 6px;
        /* Standardize form control styles for horizontal alignment */
        input .form-control, .e-input-group, .e-control-wrapper, .e-autocomplete, .e-input

    {
        min-height: 38px; /* Bootstrap default */
        line-height: 1.5;
        font-size: 14px;
        font-family: 'Source Sans Pro', sans-serif;
        padding: 6px 12px;
        box-sizing: border-box;
    }

    /* Optional: Align content inside Syncfusion AutoComplete */
    .e-autocomplete .e-input {
        padding: 6px 12px !important;
    }

    /* Remove extra bottom spacing in SfAutoComplete wrapper */
    .e-autocomplete.e-control-wrapper {
        margin-bottom: 0 !important;
    }

    /* Align labels consistently */
    label.form-label {
        font-size: 14px;
        margin-bottom: 4px;
        font-family: 'Source Sans Pro', sans-serif;
    }

    /* Remove extra vertical margin if any Syncfusion adds it */
    .e-control-wrapper {
        margin-top: 0 !important;
        margin-bottom: 0 !important;
    }

</style>

@if (ShowAlert)
{
    <div class="alert alert-danger alert-dismissible fade show position-fixed top-0 end-0 m-4 shadow"
         role="alert" style="z-index: 1050; min-width: 250px;">
        <alertmessage>Hello dear</alertmessage>

        <button type="button" class="btn-close" @onclick="() => ShowAlert = false"></button>
    </div>
}

@* <div class="target-container" @onclick="@OpenConfirmDialogAsync">
    <p class="target-caption">CLICK TO SHOW A MESSAGE BOX WINDOW</p>
    <p>RESULT: @(result is not null ? result.ToString() : "No result")</p>
</div> *@
<DxDialogProvider />


<div class="row g-4">
    <!-- Left Form (Single Column) -->
    <div class="d-flex justify-content-between align-items-center p-3 bg-light border-bottom">

        <div>
            <DxButton @onclick="UploadGrower">Save</DxButton>
            <DxButton @onclick="GoToAddGrowerPage">Grower Group</DxButton>


        </div>
      
    </div>

    <div class="d-flex justify-content-end gap-1">
        <!-- gap-3 = 1rem (~16px) spacing -->

        <button @onclick="GoBack" class="btn btn-primary">
            <i class="fa fa-arrow-left"></i>
        </button>

    </div>





    <div class="page-header">
        <h2>Grower Details</h2>
    </div>
    
     <div class="col-12 col-md-6">
     <EditForm Model="@companyModel">
         <div class="card shadow-sm">
                         <div class="card-body">
                 <div class="col-sm-12">
                     
                         <label for="txtCompanyCode" class="mb-2">
                             Grower Group Name<span class="redtext"></span>
                         </label>
                               <div class="col-sm-12">
            
                <InputText id="Mail" placeholder="Grower Group" style="font-size: 14px;height:30px; font-family: 'Source Sans Pro', sans-serif;" class="form-control input-placeholder-dim input-focus-dark" @bind-Value="companyModel.GrowerGroupSelectName" />

                        </div>




                    </div>        
 
     
     
     
     </div>
              
            </div>
        
        
        </EditForm>     
   </div>
   
















    


    <!-- Right Form (Two Columns) -->
    <div class="col-12 col-md-6">
        <EditForm Model="@companyModel">
            <div class="card shadow-sm">
                <div class="card-body">
                <div class="row g-2">
                           
                    <div class="col-sm-4">
                                <label style="font-size: 12px; color: black; font-weight: 500; display: inline-flex; align-items: center;">
                                    <input type="checkbox" @onchange="OnLockGroupChanged"   name="Lockparty"  style="margin-right: 6px;" />
                                    <span>Lock Grower?</span>
                                </label>
                            
                            </div>
                    
                            <div class="col-sm-4">
                                <label style="font-size: 12px; color: black; font-weight: 500; display: inline-flex; align-items: center;">
                                    <input type="checkbox" @onchange="IsflexiChanged" name="Flexi"  style="margin-right: 6px;" />
                                    <span>Flexible Chambers</span>
                                </label>
                            
                            
                            </div>

                      
                        
                       <div class="d-flex align-items-center gap-3">
                            <label class="form-label me-3">Status:</label>
                            <div class="form-check">
                                <input class="form-check-input"  checked="@("1" == currentOption)" type="radio" name="radioGroup" id="radio1"
                                       value="1"  />
                                <label class="form-check-label" for="radio1">Active</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" checked="@("0" == currentOption)" type="radio" name="radioGroup" id="radio2"
                                       value="0" />
                                <label class="form-check-label" for="radio2">Inactive</label>
                            </div>
                        </div>

                        @*   <div class="row g-2">
                            <div class="col-sm-6">
                                <label for="txtCompanyCode">Phone II<span class="redtext"></span></label>
                                <input type="text" style="font-size: 14px; font-family: 'Source Sans Pro', sans-serif;" class="form-control input-placeholder-dim input-focus-dark" @bind="@companyModel.Mobile" id="txtCompanyCode" name="txtCompanyCode" onkeypress="return alphaOnly(event);" placeholder="Enter Mobile no" />
                            </div>
                            <div class="col-sm-6">
                                <label for="txtCompanyCode">Email<span class="redtext"></span></label>
                                <input type="text" style="font-size: 14px; font-family: 'Source Sans Pro', sans-serif;" class="form-control input-placeholder-dim input-focus-dark" @bind="@companyModel.Email" id="txtCompanyCode" name="txtCompanyCode" onkeypress="return alphaOnly(event);" placeholder="Enter Email Id" />
                            </div>

                        </div> *@









                    </div>
                </div>

            </div>
        </EditForm>

    </div>
</div>

<br />


<div class="row g-4">
    <!-- Left Form (Single Column) -->
    <div class="d-flex justify-content-between align-items-center px-3 py-1" style="background-color: #f9f9f9; border-bottom: 1px solid #ccc; height: 40px;">

        <h6><strong>Agreement Details</strong></h6>
    </div>

   
    <div class="card p-3 mb-4">
        <div class="row g-3">




               <div class="col-sm-2">

                    <label for="lastName" class="form-label">Financial Year</label>
                <DxComboBox Data="@GetFinyearList"
                            SearchMode="@SearchMode"
                            NullText="Select Financial year..."
                            SearchFilterCondition="@SearchFilterCondition"
                            SearchTextParseMode="@SearchTextParseMode"
                            @bind-Value="EditModel.Fyear"
                            TextFieldName="Fyear"
                            ValueFieldName="Fyear"
                            CssClass="cw-480"
                            InputId="cbFiltering"
                            style="height:30px"/>
                
                </div>



            

            <div class="col-sm-2">

                <label for="lastName" class="form-label">Dated</label>
                <DxDateEdit @bind-Date="EditModel.Adated"
                            CssClass="cw-320" MaxDate="@DateTime.Today"
                            InputId="deOverview" />
            </div>


            <div class="col-sm-2">

                <label for="lastName" class="form-label">In-Date Estimate</label>
                <DxDateEdit @bind-Date="EditModel.Idated"
                            CssClass="cw-320"
                            InputId="deOverview" />
            </div>
           
            
            <div class="col-sm-2">
                <label for="email" class="form-label">Crate Qty</label>
                <InputNumber id="email" min="0" placeholder="Agreement Qty" style="font-size: 14px;height:30px; font-family: 'Source Sans Pro', sans-serif;" class="form-control input-placeholder-dim input-focus-dark" @bind-Value="EditModel.Aqty" />
            
            </div>
                <div class="col-12 col-md-2">
                    <label for="phone1" class="form-label">Agreement by</label>
                <InputText disabled="true" id="phone1" placeholder="Order by" style="font-size: 14px;height:30px;font-family: 'Source Sans Pro' , sans-serif;"
                               class="form-control input-placeholder-dim input-focus-dark
"
                               @bind-Value="EditModel.Orderby" />

            </div>
                <div class="col-12 col-md-2">
                    <label for="phone2" class="form-label">Item Type</label>
                <DxComboBox Data="@GetItemList"
                            SearchMode="@SearchMode"
                            SearchFilterCondition="@SearchFilterCondition"
                            SearchTextParseMode="@SearchTextParseMode"
                            @bind-Value="EditModel.Itemname"
                            TextFieldName="Itemname"
                            ValueFieldName="Itemname"
                            CssClass="cw-480"
                            InputId="cbFiltering"
                            style="height:30px" placeholder="Order by" />
                
                
                
            
                           
                           
                           </div>





            <div class="col-sm-2">

                <label for="lastName" class="form-label">Agreement Type</label>

                <DxComboBox Data="@GetServiceList"
                            SearchMode="@SearchMode"
                            SearchFilterCondition="@SearchFilterCondition"
                            SearchTextParseMode="@SearchTextParseMode"
                            @bind-Value="EditModel.Atype"
                            TextFieldName="Atype"
                            ValueFieldName="Atype"
                            CssClass="cw-480"
                            InputId="cbFiltering"
                            style="height:30px"  placeholder="Service type" />


            </div>


            <div class="col-sm-2">

                <label for="lastName" class="form-label">Rate Type</label>
                <div class="position-relative">
                    <InputSelect id="rentType"
                                 @bind-Value="EditModel.RentType"
                                 class="form-select form-control input-placeholder-dim input-focus-dark"
                                 style="font-size: 13px; height: 30px; font-family: 'Source Sans Pro', sans-serif;">
                       placeholder="Order by"
                        <option value="KG">Kg</option>
                        <option value="CRATES">Nags</option>
               
                    </InputSelect>
                </div>
            
            </div>
            
            <div class="col-sm-2">

                <label for="lastName" class="form-label">Store Rent</label>
                <InputNumber min="0" TValue="decimal?" id="lastName" step="0.1"
                           format="F2" placeholder="Store Rent" style="font-size: 14px;height:30px; 'Source Sans Pro', sans-serif;" class="form-control input-placeholder-dim input-focus-dark" @bind-Value="EditModel.StoreRent" />
            
                       </div>
            
            <div class="col-sm-2">

                <label for="lastName" class="form-label">Crate Rent</label>
                <InputNumber min="0" id="lastName" placeholder="Crate Rent" style="font-size: 14px;height:30px; 'Source Sans Pro', sans-serif;" class="form-control input-placeholder-dim input-focus-dark" @bind-Value="EditModel.CrateRate" />
            </div>
            
            <div class="col-sm-2">

                <label for="lastName" class="form-label">Labour Rent</label>
                <InputNumber min="0" id="lastName" placeholder="Labour Rent" style="font-size: 14px;height:30px; 'Source Sans Pro', sans-serif;" class="form-control input-placeholder-dim input-focus-dark" @bind-Value="EditModel.LabourRate" />
            </div>

            <div class="col-sm-2">

                <label for="lastName" class="form-label">Grading Rent</label>
                <InputNumber  min="0" id="lastName" placeholder="Grading Rent" style="font-size: 14px;height:30px; 'Source Sans Pro', sans-serif;" class="form-control input-placeholder-dim input-focus-dark" @bind-Value="EditModel.GradingRent" />
            </div>
            <div class="col-sm-2">

                <label for="lastName" class="form-label">Bin Rent</label>
                <InputNumber min="0" id="lastName" placeholder="Bin Rent" style="font-size: 14px;height:30px; 'Source Sans Pro', sans-serif;" class="form-control input-placeholder-dim input-focus-dark" @bind-Value="EditModel.BinRent" />
            </div>

            <div class="col-sm-2">

                <label for="lastName"  class="form-label">Packing Charges</label>
                <InputNumber min="0" id="lastName" placeholder="Packing Rent" style="font-size:14px;height:30px; 'Source Sans Pro', sans-serif;" class="form-control input-placeholder-dim input-focus-dark" @bind-Value="EditModel.PackingRent" />
            </div>
            <div class="col-sm-2">

                <label for="lastName" class="form-label">Chambers</label>
                <InputText id="lastName" disabled="true"  placeholder="Chambers" style="font-size: 14x;height:30px; 'Source Sans Pro', sans-serif;" class="form-control input-placeholder-dim input-focus-dark" @bind-Value="EditModel.Achambers" />
            </div>
            <div class="col-sm-2">

                <label for="lastName" class="form-label">SalesType</label>
                <InputSelect id="rentType"
                             @bind-Value="EditModel.SalesType"
                             class="form-select form-control input-placeholder-dim input-focus-dark"
                             style="font-size: 13px; height: 30px; font-family: 'Source Sans Pro', sans-serif;">

                    <option value="NA">NA</option>            @* Default selected *@
                    <option value="OnQuality">On Quality</option>
                    <option value="PreGrading">PreGrading</option>
                </InputSelect>
            
            
            </div>
           
            <div style="display: flex; align-items: center; margin-top: 20px;">
                <input type="checkbox"  @bind="showInvestmentDetails"  style="margin-right: 6px;" />
                <label style="font-size: 14px; font-weight: 500; margin-bottom: 0;">For Investment</label>
            </div>










        </div>
            </div>
     </div>


<br/>



@if (showInvestmentDetails)
{


    <div class="row g-4">
        <!-- Left Form (Single Column) -->
        <div class="d-flex justify-content-between align-items-center px-3 py-1" style="background-color: #f9f9f9; border-bottom: 1px solid #ccc; height: 40px;">

            <h5><strong>INVESTMENT DETAILS</strong></h5>
        </div>


        <div class="card p-3 mb-4">
            <div class="row g-3">




                <div class="col-sm-2">

                    <label for="lastName" class="form-label">Crate Qty(Inv)</label>
                    <InputNumber id="lastName" @onblur="CalculateTotalOnBlur" placeholder="Crate Qty" style="font-size: 14px; font-family: 'Source Sans Pro', sans-serif;" class="form-control input-placeholder-dim input-focus-dark" @bind-Value="EditModel.InvestQty" />
                </div>
                 <div class="col-sm-2">

                    <label for="lastName" class="form-label">Rate per Crate</label>
                    <InputNumber id="lastName" @onblur="CalculateTotalOnBlur" placeholder="Rate Per Crate" style="font-size: 14px; font-family: 'Source Sans Pro', sans-serif;" class="form-control input-placeholder-dim input-focus-dark" @bind-Value="EditModel.InvestRate" />
                </div>
                 <div class="col-sm-2">

                    <label for="lastName" class="form-label">Total</label>
                    <InputNumber id="lastName" placeholder="Total" disabled="true" style="font-size: 14px; font-family: 'Source Sans Pro', sans-serif;" class="form-control input-placeholder-dim input-focus-dark" @bind-Value="EditModel.TotalValue" />
                </div>
                 <div class="col-sm-2">

                    <label for="lastName"  class="form-label">Comm Amount</label>
                    <InputNumber id="lastName" placeholder="Comm Amount" disabled="true" style="font-size: 14px; font-family: 'Source Sans Pro', sans-serif;" class="form-control input-placeholder-dim input-focus-dark" @bind-Value="EditModel.DoubleValue" />
                </div>
                 <div class="col-sm-2">

                    <label for="lastName" class="form-label">Comm %</label>
                    <InputNumber id="lastName" @onblur="CalculatePercentOnBlur" placeholder="Comm %" style="font-size: 14px; font-family: 'Source Sans Pro', sans-serif;" class="form-control input-placeholder-dim input-focus-dark" @bind-Value="EditModel.Invpercent" />
                </div>
                <div class="col-sm-2">

                    <label for="lastName" class="form-label">Total Commission</label>
                    <InputNumber id="lastName" placeholder="Total comm" disabled="true" style="font-size: 14px; font-family: 'Source Sans Pro', sans-serif;" class="form-control input-placeholder-dim input-focus-dark" @bind-Value="EditModel.percentvalue" />
                </div>

                <div class="col-sm-2">

                    <label for="lastName" class="form-label">Return Total</label>
                    <InputNumber id="lastName" placeholder="Return Total" disabled="true" style="font-size: 14px; font-family: 'Source Sans Pro', sans-serif;" class="form-control input-placeholder-dim input-focus-dark" @bind-Value="EditModel.Returnvalue" />
                </div>



                <div class="d-flex align-items-center gap-3">
                    <label class="form-label me-3">Type:</label>
                    <div class="form-check">
                        <input class="form-check-input" @onchange="UpdateValue" type="radio" name="radioGroup" id="radio1"
                               value="1" checked />
                        <label class="form-check-label" for="radio1">Pre-Investment</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" @onchange="UpdateValue" type="radio" name="radioGroup" id="radio2"
                               value="0" />
                        <label class="form-check-label" for="radio2">Post-Investment</label>
                    </div>
                </div>
              @*   <div class="col-sm-2">

                    <label for="lastName" class="form-label">Total Commission</label>
                    <InputNumber id="lastName" placeholder="Total comm" disabled="true" style="font-size: 14px; font-family: 'Source Sans Pro', sans-serif;" class="form-control input-placeholder-dim input-focus-dark" @bind-Value="EditModel.percentvalue" />
                </div>

                <div class="col-sm-2">

                    <label for="lastName" class="form-label">Return Total</label>
                    <InputNumber id="lastName" placeholder="Return Total" disabled="true" style="font-size: 14px; font-family: 'Source Sans Pro', sans-serif;" class="form-control input-placeholder-dim input-focus-dark" @bind-Value="EditModel.Returnvalue" />
                </div>
 *@














            </div>
         
        </div>
    </div>

    }

    @if (showInvestmentDetails)
{



    <div class="row" style="@(ShowInstallmentSection ? "" : "display:none;")" id="divInstallment">
        <div class="col-md-12">
            <input type="hidden" id="hdnInstallmentRowCount" value="@InstallmentRows.Count" />
            <input type="hidden" id="hdndeletedInstallmentRows" value="@string.Join(",", DeletedInstallmentRows)" />
            <input type="hidden" id="hdndeletedInstallmentIds" value="@string.Join(",", DeletedInstallmentIds)" />

            <h6>Installment Setup</h6>

            <div id="divInstallmentRows">
                @foreach (var installment in InstallmentRows)
                {
                    <div class="row mb-2 installment-row" key="@installment.Id">
                        <div class="col-md-2">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-control form-control-sm" @bind="installment.DueDate" />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Amount</label>
                            <div class="input-group">
                                <input type="number" class="form-control form-control-sm" @bind="installment.Amount" />
                                @if (!IsViewMode)
                                {
                                    <button class="btn btn-danger btn-sm" style=" background-color: darkred; color: white;" 
                                    @onclick="() => RemoveInstallment(installment)"
                                    title="Remove installment">
                                        <i class="oi oi-x"></i>
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    @if (!IsViewMode)
    {
        <div class="row mt-2">
            <div class="col-md-12">
                <button class="btn btn-success btn-sm" style=" background-color: darkgreen; color: white;" @onclick="AddInstallment">
                    <i class="oi oi-plus"></i>
                </button>
                <button class="btn btn-danger btn-sm" style=" background-color: darkred; color: white;" @onclick="ClearInstallmentData">
                    <i class="oi oi-x"></i>

                </button>
            </div>
        </div>
    }

}
<div class="row">
    <div class="col-12 d-flex justify-content-end gap-2">
        <DxButton class="btn btn-primary btn-sm" @onclick="SaveAgreement">Save</DxButton>
        <DxButton class="btn btn-primary btn-sm" @onclick="UpdateAgreements">Update</DxButton>
    </div>
</div>
<br/>










<div style="overflow-x:auto; width:100%;">

    <DxGrid Data=@GetgrowerIdAgreement PageSize="10" ShowSearchBox="false"
            ShowGroupPanel="false" FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Never"
            ColumnResizeMode="GridColumnResizeMode.NextColumn" CustomizeElement="Grid_CustomizeElement" TextWrapEnabled="true">

        <Columns>
            <DxGridDataColumn FieldName=@nameof(companyModel.AgreementId) MinWidth="100" Caption="Id" Width="5%" />
            <DxGridDataColumn FieldName=@nameof(companyModel.Fyear) MinWidth="100" Caption="YearId" Width="5%" />
            <DxGridDataColumn FieldName=@nameof(companyModel.Adated) MinWidth="100" Caption="Dated" Width="5%" />

            <DxGridDataColumn FieldName="@nameof(companyModel.Aqty)" MinWidth="100" Caption="Qty" Width="4%" />
            <DxGridDataColumn FieldName="@nameof(companyModel.Atype)" MinWidth="100" Caption="Service" Width="4%"/>
            
            <DxGridDataColumn FieldName="@nameof(companyModel.Itemname)" MinWidth="100" Caption="Item" Width="5%"/>
              <DxGridDataColumn FieldName="@nameof(companyModel.RentType)" MinWidth="100" Caption="Rent Type" Width="5%" />
            <DxGridDataColumn FieldName="@nameof(companyModel.StoreRent)" MinWidth="100" Caption="Storage Rent/(crate)/kg " Width="5%" />
             <DxGridDataColumn FieldName="@nameof(companyModel.BinRent)" MinWidth="100" Caption="Bin Rent /Month" Width="5%" />
            <DxGridDataColumn FieldName="@nameof(companyModel.CrateRate)" MinWidth="100" Caption="Crate Rent /Month" Width="5%" />
             <DxGridDataColumn FieldName="@nameof(companyModel.LabourRate)" MinWidth="100" Caption="Labour Rent" Width="5%" />
            <DxGridDataColumn FieldName="@nameof(companyModel.GradingRent)" MinWidth="100" Caption="Grading" Width="5%" />
            <DxGridDataColumn FieldName="@nameof(companyModel.PackingRent)" MinWidth="100" Caption="Packing" Width="5%" />

            <DxGridDataColumn FieldName="@nameof(companyModel.Investmentflag)" MinWidth="100" Caption="Investment" Width="5%" >



          
                

            </DxGridDataColumn>
            <DxGridCommandColumn Width="7%">
                <HeaderTemplate>
                    <strong>Actions</strong>
                    @* <a class="oi oi-action"  style="text-decoration: none;" href="javascript:void(0);"></a> *@
                </HeaderTemplate>
                <CellDisplayTemplate>
                <a class="oi oi-pencil" style="cursor: pointer;" 
           @onclick="@(() => EditItem(context.DataItem))"></a>   <a class="oi oi-x"  style="cursor: pointer;"></a>
                   
                </CellDisplayTemplate>
            </DxGridCommandColumn>





            @*   <DxGridCommandColumn Caption="" Width="5%">

            <CellDisplayTemplate >
            <a class="oi oi-pencil" @onclick="@(() => MyGrid.StartEditRowAsync(context.VisibleIndex))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>

            <DxGridCommandColumn Caption="Del" Width="5%">
            <CellDisplayTemplate>
            <a class="oi oi-x" @onclick="@(() => MyGrid.ShowDataItemDeleteConfirmation(context.DataItem))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>
            <DxGridCommandColumn Caption="View" Width="5%">
            <CellDisplayTemplate>
            <a class="oi oi-eye" @onclick="@(() => MyGrid.ShowDataItemDeleteConfirmation(context.DataItem))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>
            <DxGridCommandColumn Caption="Add" Width="5%">
            <CellDisplayTemplate>
            <a class="oi oi-plus" @onclick="@(() => MyGrid.ShowDataItemDeleteConfirmation(context.DataItem))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>

            <DxGridCommandColumn Caption="Agreement" Width="5%">
            <CellDisplayTemplate>
            <a class="oi oi-document" @onclick="@(() => MyGrid.ShowDataItemDeleteConfirmation(context.DataItem))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>

            <DxGridCommandColumn Width="5%">
            <CellDisplayTemplate>
            <a class="oi oi-person" Caption="List" @onclick="@(() => MyGrid.ShowDataItemDeleteConfirmation(context.DataItem))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>
            *@
        </Columns>

        <TotalSummary>
            <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.Aqty)" />

        </TotalSummary>


    </DxGrid>
</div>



















@if (ShowEmptyFieldDialog)
{
    <DxPopup @bind-Visible="@ShowEmptyFieldDialog"
             HeaderText="Validation Error"
             ShowCloseButton="true"
             CssClass="validation-dialog">
        <Content>
            <p>@DialogMessage</p>
            <DxButton Text="OK" Click="@(() => ShowEmptyFieldDialog = false)" />
        </Content>
    </DxPopup>
}
<style>
    .custom-popup-style {
        background-color: #fdfdfd;
        border: 2px solid #0078d4;
        border-radius: 12px;
        padding: 10px;
        font-family: 'Segoe UI', sans-serif;
    }

        .custom-popup-style .dxbs-popup-header {
            background-color: #0078d4;
            color: white;
            font-weight: bold;
            border-bottom: none;
        }

        .custom-popup-style .dxbs-popup-content {
            font-size: 15px;
            padding: 15px;
        }
</style>
@if (ShowEmptyFieldDialogError)
{
    <DxPopup @bind-Visible="@ShowEmptyFieldDialogError"
             HeaderText="Confirmation Message"
             ShowCloseButton="true"
             CssClass="custom-popup-style">



        <Content>
            <p><strong>Success </strong>@DialogMessage</p>
            <DxButton Text="OK"  RenderStyle="ButtonRenderStyle.Primary" Click="@(() => ShowEmptyFieldDialogError = false)" />
        </Content>
    </DxPopup>
}








<style>
    .validation-dialog .dxbl-popup-content {
        border: 2px solid #ff6a00;
        border-radius: 8px;
        padding: 20px;
    }
</style>













@code {

    private bool ShowInstallmentSection { get; set; } = false;
    private List<Installment> InstallmentRows { get; set; } = new List<Installment>();
    private List<int> DeletedInstallmentRows { get; set; } = new List<int>();
    private List<int> DeletedInstallmentIds { get; set; } = new List<int>();
    private List<int> GrowerAgreementId { get; set; } = new List<int>();

    


[Parameter] public bool IsViewMode { get; set; } = false;


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var uri = new Uri(NavigationManager.Uri);
            var pageSegment = uri.AbsolutePath.Trim('/'); // "login", "dashboard", etc.

            string pageName = string.IsNullOrWhiteSpace(pageSegment)
                ? "Home"
                : System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(pageSegment.Replace("-", " "));
            pageName = "Edit Agreement";
            string title = $"Cold Store | {pageName}";
            await JS.InvokeVoidAsync("setDocumentTitle", title);
        }
    }

    private bool showInvestmentDetails = false;

    public string Gender { get; set; } = "Male";
    private bool IsReadOnly { get; set; } = true;
    private bool ShowAlert = false;
    private bool ShowInputError = false;
    // private FormModel formModel = new();
    //private List<FormModel> rows = new();
    private int editIndex = -1;
    private String alertmessage = "";
    private CompanyModel SelectedEmployee { get; set; } = new CompanyModel();
    private CompanyModel editingBank = null!; // row being edited
    private CompanyModel editingBackup = null!; // optional: backup to cancel
}




@code {

    private void GoToAddGrowerPage()
    {
        NavigationManager.NavigateTo("/GrowerRef");
    }

    private string selectedStateCode;
    private string selectedStateNumericCode;

    public IndianState SelectedState { get; set; }
    int? Value { get; set; }
    private string selectedCode;
    private string selectedName;
    private string selectedOptionId = "01";

    private string selectedOptionText = "Jammu and Kashmir";
    private void AddInstallment()
    {

        decimal TotalInstallment = 0;



        decimal invcrate = EditModel?.InvestQty ?? 0m;


        decimal AgreeQty = EditModel?.Aqty ?? 0m;


        if (invcrate>AgreeQty){

            DialogMessage = "Invalid Qty";
            ShowEmptyFieldDialog = true;
            return;


        }

        TotalInstallment=InstallmentRows.Sum(i => i.Amount);

        companyModel.StoreRent = TotalInstallment;

        if (TotalInstallment > EditModel.TotalValue)
        {

            DialogMessage = "Invalid Installment value";
            ShowEmptyFieldDialog = true;
            return;


        }




        InstallmentRows.Add(new Installment
{
Id = InstallmentRows.Count + 1,
DueDate = DateTime.Now.AddMonths(InstallmentRows.Count + 1),
Amount = CalculateDefaultAmount()
});
        ShowInstallmentSection = true;
    }

    private void RemoveInstallment(Installment installment)
    {
        InstallmentRows.Remove(installment);
        if (installment.IsPersisted)
        {
            DeletedInstallmentIds.Add(installment.PersistedId);
        }
        DeletedInstallmentRows.Add(installment.Id);
    }

    private void ClearInstallmentData()
    {
        InstallmentRows.Clear();
        ShowInstallmentSection = false;
    }

    private CompanyModel selectedAgreement;
    private CompanyModel EditModel = new();
    private bool IsEditMode = false;
    private int selectedagreementId = 0;


    private async Task EditItem(object dataItem)
    {
        if (dataItem is CompanyModel companyModel)
        {
        
            EditModel = await EmployeeService.GetAgreementId(companyModel.AgreementId);
            // optional edit change

            if (EditModel.Investmentflag == true) 
            {
                InstallmentRows.Clear();
                ShowInstallmentSection = false;
                showInvestmentDetails = true;

                EditModel.TotalValue = (EditModel.InvestQty ?? 0) * (EditModel.InvestRate ?? 0);
                EditModel.DoubleValue = 2 * (EditModel.InvestQty ?? 0) * (EditModel.InvestRate ?? 0);
                EditModel.percentvalue = (EditModel.TotalValue ?? 0) * (EditModel.Invpercent ?? 0) / 100;

                EditModel.Returnvalue = EditModel.percentvalue + EditModel.TotalValue;

                selectedagreementId = companyModel.AgreementId;
                var installments = await EmployeeService.GetInstallmentsByGrowerAsync(companyModel.AgreementId);
                InstallmentRows = installments?.ToList() ?? new List<Installment>();

                ShowInstallmentSection = InstallmentRows.Any();
                ShowInstallmentSection =true;
                StateHasChanged();

            }

            selectedagreementId = companyModel.AgreementId;
            IsEditMode = true;

            ///  await JS.InvokeVoidAsync("alert", EditModel.BinRent);
            await InvokeAsync(StateHasChanged);
        }
    }






    private async Task GoBack()
    {
        await JS.InvokeVoidAsync("history.back");
    }





    private decimal CalculateDefaultAmount()
    {
        // Your logic to calculate default installment amount
        return 0; // Replace with actual calculation
    }

    public class Installment
    {
        public int Id { get; set; }
        public int PersistedId { get; set; }
        public bool IsPersisted => PersistedId > 0;
        public DateTime DueDate { get; set; }
        public decimal Amount { get; set; }
    }













    private void GetSelectedOption()
    {
        var selectedOption = IndianStates.FirstOrDefault(o => o.Code == selectedOptionId);
        selectedOptionText = selectedOption?.Name ?? "Not selected";
    }


    private void OnStateChanged(ChangeEventArgs e)
    {
        selectedCode = e?.Value?.ToString();

        var selected = IndianStates.FirstOrDefault(x => x.Code == selectedCode);
        if (selected != null)
        {
            selectedName = selected.Name;
        }


    }

    //  var state = IndianStates.FirstOrDefault(s => s.Code == newCode);

    private bool isPartyAsGroup = false;
    [Inject] IDialogService DialogService { get; set; }

    string currentOption = "1";

    private void UpdateValue(ChangeEventArgs e)
    {
        currentOption = e.Value.ToString();
    }

    private void OnPartyGroupChanged(ChangeEventArgs e)
    {
        isPartyAsGroup = e.Value is bool b && b;



    }
    void Grid_CustomizeElement(GridCustomizeElementEventArgs e)
    {
        if (e.ElementType == GridElementType.DataRow && e.VisibleIndex % 2 == 1)
        {
            e.CssClass = "alt-item";
        }
        if (e.ElementType == GridElementType.HeaderCell)
        {
            e.Style = "background-color: var(--DS-color-surface-neutral-default-selected)";
            e.CssClass = "header-bold";
        }
    }

    private bool islockGrower = false;

    private void OnLockGroupChanged(ChangeEventArgs e)
    {
        islockGrower = e.Value is bool b && b;



    }


    private bool Isflexi = false;
    private bool isms1 = false;
    private bool isms2 = false;

    private void isSms1(ChangeEventArgs e)
    {
        isms1 = e.Value is bool b && b;



    }


    private void isSms2(ChangeEventArgs e)
    {
        isms2 = e.Value is bool b && b;



    }





    private void IsflexiChanged(ChangeEventArgs e)
    {
        Isflexi = e.Value is bool b && b;



    }





    private bool? result { get; set; } = null;
    private bool ShowEmptyFieldDialogError { get; set; }

    private bool ShowEmptyFieldDialog { get; set; }
    private string DialogMessage { get; set; } = "";

    private string Lockstatus { get; set; } = "";
    private string flexistatus { get; set; } = "";


    private async Task UploadGrower()
    {
        var selectedOption = IndianStates.FirstOrDefault(o => o.Code == selectedOptionId);
        selectedOptionText = selectedOption?.Name ?? "Not selected";


        companyModel.GrowerState = selectedOptionText;

        companyModel.GrowerStatecode = selectedOption.Code;
        if (islockGrower)
        {
            companyModel.GrowerLock = "1";
        }
        else
        {
            companyModel.GrowerLock = "0";
        }



        if (Isflexi)
        {
            companyModel.GrowerFlexi = "1";
        }
        else
        {
            companyModel.GrowerFlexi = "0";
        }




        companyModel.GrowerActive = currentOption;




        if (string.IsNullOrWhiteSpace(companyModel.GrowerGroupSelectName))
        {

            DialogMessage = "Please enter  Grower Group name";
            ShowEmptyFieldDialog = true;
            return;
        }



        companyModel.Growerid = GrowerId;

     
            var result = await EmployeeService.UpdateNameGroup(companyModel,companyModel.Growerid);
            if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
            {
                DialogMessage = result.RetMessage;
                ShowEmptyFieldDialogError = true;
                companyModel = new CompanyModel();

                StateHasChanged();
                return;
            }



            if (result != null && result.RetFlag.Trim() == "FALSE")
            {

                DialogMessage = result.RetMessage ?? "Failed to Update grower group.";
                ShowEmptyFieldDialog = true;

                return;
            }


        











    }
    private bool isChecked = false;
    ListSearchMode SearchMode { get; set; } = ListSearchMode.AutoSearch;
    ListSearchFilterCondition SearchFilterCondition { get; set; } = ListSearchFilterCondition.Contains;
    ListSearchTextParseMode SearchTextParseMode { get; set; } = ListSearchTextParseMode.GroupWordsByAnd;
    void EditBank(CompanyModel banklist)
    {
        editingBackup = new CompanyModel
            {
                Bid = banklist.Bid,
                Bname = banklist.Bname,
                Accno = banklist.Accno,
                Branch = banklist.Branch,
                Ifsc = banklist.Ifsc,
                Accname = banklist.Accname
            };
        editingBank = banklist;
    }
    protected async Task SaveEdit(CompanyModel companyModel)
    {

        if (string.IsNullOrWhiteSpace(editingBank.Bname))
        {
            await JS.InvokeVoidAsync("alert", "Bank Name Required.");


            return;
        }


        if (string.IsNullOrWhiteSpace(editingBank.Accno))
        {
            await JS.InvokeVoidAsync("alert", "Account No Required.");



            return;
        }
        if (string.IsNullOrWhiteSpace(editingBank.Accname))
        {
            await JS.InvokeVoidAsync("alert", "Account Name Required.");



            return;

        }
        if (string.IsNullOrWhiteSpace(editingBank.Branch))
        {
            await JS.InvokeVoidAsync("alert", "Branch Name Required.");



            return;
        }
        if (string.IsNullOrWhiteSpace(editingBank.Ifsc))
        {
            await JS.InvokeVoidAsync("alert", "Ifsc Code Required.");



            return;
        }

        await EmployeeService.updatebank(id, companyModel);
        IsReadOnly = true;
        banks = await EmployeeService.GetBanks();
        await JS.InvokeVoidAsync("alert", "Bank Saved successfully.");

        StateHasChanged();


        editingBank = null!;
    }
    void CancelEdit()
    {
        if (editingBank is not null && editingBackup is not null)
        {
            editingBank.Bname = editingBackup.Bname;
            editingBank.Branch = editingBackup.Branch;
            editingBank.Ifsc = editingBackup.Ifsc;
            editingBank.Accname = editingBackup.Accname;
        }
        editingBank = null!;
    }
    protected async Task DeleteBank(CompanyModel companyModel)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", $"Are you sure you want to delete item with ID {id}?");
        if (confirmed)
        {


            await EmployeeService.DeleteBank(id, companyModel);
            IsReadOnly = true;
            banks = await EmployeeService.GetBanks();
            await JS.InvokeVoidAsync("alert", "Bank Deleted successfully.");

            StateHasChanged();


            editingBank = null!;
        }


    }











    public class GameFields
    {
        public string Id { get; set; } = "";
        public string Text { get; set; } = "";
    }
    public List<GameFields> Games = new List<GameFields>()
    {
        new GameFields() { Id = "Game1", Text = "State Bank of India" },
        new GameFields() { Id = "Game2", Text = "J&K Bank" },
        new GameFields() { Id = "Game3", Text = "HDFC bank" },
        new GameFields() { Id = "Game4", Text = "ICICI Bank" },
        new GameFields() { Id = "Game5", Text = "Indus Ind Bank" },
        new GameFields() { Id = "Game6", Text = "Punjab National Bank" },
        new GameFields() { Id = "Game7", Text = "Axis Bank" },
        new GameFields() { Id = "Game8", Text = "Canara Bank" },
        new GameFields() { Id = "Game9", Text = "Kotak Mahindra Bank" },
        new GameFields() { Id = "Game10", Text = "IDBI Bank" }
    };



    [Parameter]
    public int companyId { get; set; } = 1;
    [Parameter] public int GrowerId { get; set; }

    CompanyModel companyModel = new CompanyModel();
    List<CompanyModel> ChallanList = new List<CompanyModel>();
    List<CompanyModel> GrowerAgreementList = new List<CompanyModel>();


    List<CompanyModel> banks = new List<CompanyModel>();

    List<CompanyModel> GetgrowerList = new List<CompanyModel>();

    List<CompanyModel> GetgrowerIdAgreement = new List<CompanyModel>();


    List<CompanyModel> GetFinyearList = new List<CompanyModel>();

    List<CompanyModel> GetServiceList = new List<CompanyModel>();

    List<CompanyModel> GetItemList = new List<CompanyModel>();


    private void CalculateTotalOnBlur(FocusEventArgs e)
    {

        EditModel.TotalValue = (EditModel.InvestQty ?? 0) * (EditModel.InvestRate ?? 0);
        EditModel.DoubleValue = 2 * (EditModel.InvestQty ?? 0) * (EditModel.InvestRate ?? 0);
        EditModel.percentvalue = (EditModel.TotalValue ?? 0) * (EditModel.Invpercent ?? 0) / 100;

        EditModel.Returnvalue = EditModel.percentvalue + EditModel.TotalValue;


    }



    private void CalculatePercentOnBlur(FocusEventArgs e)
    {
        EditModel.percentvalue = (EditModel.TotalValue ?? 0) * (EditModel.Invpercent ?? 0)/100;

        EditModel.Returnvalue = EditModel.percentvalue + EditModel.TotalValue;



    }


    protected override async Task OnInitializedAsync()
    {
        // companyModel = await EmployeeService.GetCompanyByIdAsync(companyId);
        companyModel = new CompanyModel
            {
                GrowerStatecode = "01", // Default to Maharashtra
                GrowerState = "Jammu and Kashmir"
            };
        // GetgrowerList = await EmployeeService.GetallGrowerlist();

        GetFinyearList = await EmployeeService.GetFinyear();

        GetServiceList = await EmployeeService.GetServices();
        GetItemList = await EmployeeService.GetItemname();




        companyModel.Growerid = GrowerId;




        companyModel = await EmployeeService.GetGroupName(GrowerId);
        bool islock = companyModel.GrowerRetLock;
        bool isflex = companyModel.GrowerRetFlexi;
        bool isactive = companyModel.GrowerRetAcitve;


        islockGrower = companyModel?.GrowerRetLock ?? false;
        Isflexi = companyModel?.GrowerRetFlexi ?? false;
        isactive = companyModel?.GrowerRetAcitve ?? false;

       
      
     
        GetgrowerIdAgreement = await EmployeeService.GetAgreementByGrowerId(GrowerId);

      //  companyModel = await EmployeeService.GetGrowerIdAsync(GrowerId);
        currentOption = companyModel.GrowerRetAcitve ? "1" : "0";
        
        
        StateHasChanged();

    }




    private void MakeReadOnly()
    {
        IsReadOnly = false;
    }

    public int id { get; set; } = 1;

    private string Caddress = "";

    protected async Task GetAgreements()
    {

        if (string.IsNullOrWhiteSpace(companyModel.GrowerGroupSelectName))
        {
            DialogMessage = "Please Select valid Grower group";
            ShowEmptyFieldDialog = true;
            return;

        }


        bool iflag = false;



        string selectedgroup = companyModel.GrowerGroupSelectName;

        // companyModel = await EmployeeService.GetCompanyByIdAsync(companyId);
        GrowerAgreementList = await EmployeeService.GetAgreementByGrower(selectedgroup);









        if (iflag == false)
        {
            showInvestmentDetails = false;
        }
        else
        {
            showInvestmentDetails = true;
        }

        StateHasChanged();

    }
    protected async Task UpdateCompany()
    {

        if (string.IsNullOrWhiteSpace(companyModel.Caddress))
        {
            ShowAlert = true;
            ShowInputError = true;

            await Task.Delay(3000);
            ShowAlert = false;
            StateHasChanged();
            return;
        }


        if (string.IsNullOrWhiteSpace(companyModel.Name))
        {
            ShowAlert = true;
            ShowInputError = true;

            await Task.Delay(3000);
            ShowAlert = false;
            StateHasChanged();
            return;
        }



        await EmployeeService.EditCompany(id, companyModel);
        IsReadOnly = true;
        await JS.InvokeVoidAsync("alert", "Company updated successfully.");

        // // Optional: auto-hide the alert after a few seconds
        // await Task.Delay(3000);
        // ShowAlert = false;
        // StateHasChanged();
    }

    private string ChallanGroup { get; set; } = ""; // Default to "1" (Active)
    protected async Task ViewChallanlist()
    {
        if (string.IsNullOrWhiteSpace(companyModel.GrowerGroupSelectName))
        {
            DialogMessage = "Please Select valid Grower group";
            ShowEmptyFieldDialog = true;
            return;

        }

        ChallanGroup = companyModel.GrowerGroupSelectName;
        // await JS.InvokeVoidAsync("alert", ChallanGroup);

       // banks = await EmployeeService.GetallChallanlist(ChallanGroup);
        await JS.InvokeVoidAsync("alert", banks);

    }

    protected async Task SaveAgreement()
    {

        if (string.IsNullOrWhiteSpace(companyModel.GrowerGroupSelectName))
        {
            DialogMessage = "Please Select valid Grower group";
            ShowEmptyFieldDialog = true;
            return;

        }
        EditModel.GrowerGroupSelectName = companyModel.GrowerGroupSelectName;
        EditModel.Growerid =GrowerId;

        if (string.IsNullOrWhiteSpace(EditModel.Fyear))
        {
            DialogMessage = "Please select  Valid Financial year";
            ShowEmptyFieldDialog = true;
            return;

        }





        if (string.IsNullOrWhiteSpace(EditModel.Itemname))
        {
            DialogMessage = "Please select  Valid Item Type";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.Atype))
        {
            DialogMessage = "Please select  Valid service Type";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (!EditModel.Aqty.HasValue || EditModel.Aqty <= 0)
        {
            DialogMessage = "Please enter a valid quantity greater than 0.";
            ShowEmptyFieldDialog = true;
            return;
        }

        if (string.IsNullOrWhiteSpace(EditModel.RentType))
        {
            DialogMessage = "Please select  Valid Rent Type";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (!EditModel.StoreRent.HasValue || EditModel.StoreRent <= 0)
        {
            EditModel.StoreRent = 0;
        }

        if (!EditModel.CrateRate.HasValue || EditModel.CrateRate <= 0)
        {
            EditModel.CrateRate = 0;
        }


        if (!EditModel.LabourRate.HasValue || EditModel.LabourRate <= 0)
        {
            EditModel.LabourRate = 0;
        }



        if (!EditModel.PackingRent.HasValue || EditModel.PackingRent <= 0)
        {
            EditModel.PackingRent = 0;
        }

        if (!EditModel.GradingRent.HasValue || EditModel.GradingRent <= 0)
        {
            EditModel.GradingRent = 0;
        }

        if (!EditModel.GradingRent.HasValue || EditModel.GradingRent <= 0)
        {
            EditModel.GradingRent = 0;
        }

        if (!EditModel.BinRent.HasValue || EditModel.BinRent <= 0)
        {
            EditModel.BinRent = 0;
        }

        if (!EditModel.PackingRent.HasValue || EditModel.PackingRent <= 0)
        {
            EditModel.PackingRent = 0;
        }

        if (string.IsNullOrWhiteSpace(EditModel.Achambers))
        {
            companyModel.Achambers = "";
        }


        if (string.IsNullOrWhiteSpace(EditModel.SalesType))
        {
            DialogMessage = "Please select  Valid Sales Type";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (showInvestmentDetails)
            EditModel.InvestFlag = "1";

        else
        {
            EditModel.InvestFlag = "0";
            EditModel.InvestQty=0;
            EditModel.InvestRate = 0;
            EditModel.Invpercent = 0;

        }







        if (showInvestmentDetails)
        {
            if (!EditModel.InvestQty.HasValue || EditModel.InvestQty <= 0)
            {
                DialogMessage = "Please enter a valid Investment quantity";
                ShowEmptyFieldDialog = true;
                return;
            }

            if (!EditModel.InvestRate.HasValue || EditModel.InvestRate <= 0)
            {
                DialogMessage = "Please enter a valid Investment Rate";
                ShowEmptyFieldDialog = true;
                return;
            }

            if (!EditModel.InvestRate.HasValue || EditModel.InvestRate <= 0)
            {
                DialogMessage = "Please enter a valid Investment Rate";
                ShowEmptyFieldDialog = true;
                return;
            }
            if (!EditModel.Invpercent.HasValue || EditModel.Invpercent <= 0)
            {
                DialogMessage = "Please enter a valid Comm Percent";
                ShowEmptyFieldDialog = true;
                return;
            }

            decimal TotalInstallment = 0;



            decimal invcrate = EditModel?.InvestQty ?? 0m;


            decimal AgreeQty = EditModel?.Aqty ?? 0m;


            if (invcrate > AgreeQty)
            {

                DialogMessage = "Invalid Qty";
                ShowEmptyFieldDialog = true;
                return;


            }

            TotalInstallment = InstallmentRows.Sum(i => i.Amount);

            //  companyModel.StoreRent = TotalInstallment;

            if (TotalInstallment != EditModel.TotalValue)
            {

                DialogMessage = "Invalid Installment value";
                ShowEmptyFieldDialog = true;
                return;


            }











        }
        ///    EditModel.StoreRent = 11.90m;
        var result = await EmployeeService.AddAgreement(EditModel);



        if (showInvestmentDetails)
        {

            await EmployeeService.BulkInsertInstallmentsAsync(InstallmentRows, EditModel);
        }







        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {
            // GetgrowerList = await EmployeeService.GetallChallanlist(companyModel.GrowerGroupSelectName);
            DialogMessage = result.RetMessage;
            ShowEmptyFieldDialogError = true;

            isms1 = false;
            isms2 = false;
            companyModel = new CompanyModel();
            companyModel.Growerid = GrowerId;
            companyModel = await EmployeeService.GetGroupName(GrowerId);
            GetgrowerIdAgreement = await EmployeeService.GetAgreementByGrowerId(GrowerId);


            StateHasChanged();
            return;
        }


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to add Agreement.";
            ShowEmptyFieldDialog = true;

            return;
        }


    }

    /// <summary>
    /// update agreement
    /// </summary>




    protected async Task UpdateAgreements()
    {

        if (string.IsNullOrWhiteSpace(companyModel.GrowerGroupSelectName))
        {
            DialogMessage = "Please Select valid Grower group";
            ShowEmptyFieldDialog = true;
            return;

        }
        EditModel.GrowerGroupSelectName = companyModel.GrowerGroupSelectName;
        EditModel.Growerid = GrowerId;
        EditModel.AgreementId = selectedagreementId;
        if (string.IsNullOrWhiteSpace(EditModel.Fyear))
        {
            DialogMessage = "Please select  Valid Financial year";
            ShowEmptyFieldDialog = true;
            return;

        }





        if (string.IsNullOrWhiteSpace(EditModel.Itemname))
        {
            DialogMessage = "Please select  Valid Item Type";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.Atype))
        {
            DialogMessage = "Please select  Valid service Type";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (!EditModel.Aqty.HasValue || EditModel.Aqty <= 0)
        {
            DialogMessage = "Please enter a valid quantity greater than 0.";
            ShowEmptyFieldDialog = true;
            return;
        }

        if (string.IsNullOrWhiteSpace(EditModel.RentType))
        {
            DialogMessage = "Please select  Valid Rent Type";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (!EditModel.StoreRent.HasValue || EditModel.StoreRent <= 0)
        {
            EditModel.StoreRent = 0;
        }

        if (!EditModel.CrateRate.HasValue || EditModel.CrateRate <= 0)
        {
            EditModel.CrateRate = 0;
        }


        if (!EditModel.LabourRate.HasValue || EditModel.LabourRate <= 0)
        {
            EditModel.LabourRate = 0;
        }



        if (!EditModel.PackingRent.HasValue || EditModel.PackingRent <= 0)
        {
            EditModel.PackingRent = 0;
        }

        if (!EditModel.GradingRent.HasValue || EditModel.GradingRent <= 0)
        {
            EditModel.GradingRent = 0;
        }

        if (!EditModel.GradingRent.HasValue || EditModel.GradingRent <= 0)
        {
            EditModel.GradingRent = 0;
        }

        if (!EditModel.BinRent.HasValue || EditModel.BinRent <= 0)
        {
            EditModel.BinRent = 0;
        }

        if (!EditModel.PackingRent.HasValue || EditModel.PackingRent <= 0)
        {
            EditModel.PackingRent = 0;
        }

        if (string.IsNullOrWhiteSpace(EditModel.Achambers))
        {
            companyModel.Achambers = "";
        }


        if (string.IsNullOrWhiteSpace(EditModel.SalesType))
        {
            DialogMessage = "Please select  Valid Sales Type";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (showInvestmentDetails)
            EditModel.InvestFlag = "1";

        else
        {
            EditModel.InvestFlag = "0";
            EditModel.InvestQty = 0;
            EditModel.InvestRate = 0;
            EditModel.Invpercent = 0;

        }







        if (showInvestmentDetails)
        {
            if (!EditModel.InvestQty.HasValue || EditModel.InvestQty <= 0)
            {
                DialogMessage = "Please enter a valid Investment quantity";
                ShowEmptyFieldDialog = true;
                return;
            }

            if (!EditModel.InvestRate.HasValue || EditModel.InvestRate <= 0)
            {
                DialogMessage = "Please enter a valid Investment Rate";
                ShowEmptyFieldDialog = true;
                return;
            }

            if (!EditModel.InvestRate.HasValue || EditModel.InvestRate <= 0)
            {
                DialogMessage = "Please enter a valid Investment Rate";
                ShowEmptyFieldDialog = true;
                return;
            }
            if (!EditModel.Invpercent.HasValue || EditModel.Invpercent <= 0)
            {
                DialogMessage = "Please enter a valid Comm Percent";
                ShowEmptyFieldDialog = true;
                return;
            }

            decimal TotalInstallment = 0;



            decimal invcrate = EditModel?.InvestQty ?? 0m;


            decimal AgreeQty = EditModel?.Aqty ?? 0m;


            if (invcrate > AgreeQty)
            {

                DialogMessage = "Invalid Qty";
                ShowEmptyFieldDialog = true;
                return;


            }

            TotalInstallment = InstallmentRows.Sum(i => i.Amount);

            //  companyModel.StoreRent = TotalInstallment;

            if (TotalInstallment != EditModel.TotalValue)
            {

                DialogMessage = "Invalid Installment value";
                ShowEmptyFieldDialog = true;
                return;


            }











        }
     
     

        var result = await EmployeeService.UpdateAgreement(EditModel, selectedagreementId);



        if (showInvestmentDetails)
        {

            await EmployeeService.BulkInsertInstallmentsAsync(InstallmentRows, EditModel);
        }







        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {
            // GetgrowerList = await EmployeeService.GetallChallanlist(companyModel.GrowerGroupSelectName);
            DialogMessage = result.RetMessage;
            ShowEmptyFieldDialogError = true;

            isms1 = false;
            isms2 = false;
            companyModel = new CompanyModel();
            companyModel.Growerid = GrowerId;
            companyModel = await EmployeeService.GetGroupName(GrowerId);
            GetgrowerIdAgreement = await EmployeeService.GetAgreementByGrowerId(GrowerId);


            StateHasChanged();
            return;
        }


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to add Agreement.";
            ShowEmptyFieldDialog = true;

            return;
        }


    }








    public class IndianState
    {
        public string Code { get; set; }  // e.g., "27"
        public string Name { get; set; }  // e.g., "Maharashtra"
    }

    public List<IndianState> IndianStates = new()
{
    new() { Code = "01", Name = "Jammu and Kashmir" },
    new() { Code = "02", Name = "Himachal Pradesh" },
    new() { Code = "03", Name = "Punjab" },
    new() { Code = "04", Name = "Chandigarh" },
    new() { Code = "05", Name = "Uttarakhand" },
    new() { Code = "06", Name = "Haryana" },
    new() { Code = "07", Name = "Delhi" },
    new() { Code = "08", Name = "Rajasthan" },
    new() { Code = "09", Name = "Uttar Pradesh" },
    new() { Code = "10", Name = "Bihar" },
    new() { Code = "11", Name = "Sikkim" },
    new() { Code = "12", Name = "Arunachal Pradesh" },
    new() { Code = "13", Name = "Nagaland" },
    new() { Code = "14", Name = "Manipur" },
    new() { Code = "15", Name = "Mizoram" },
    new() { Code = "16", Name = "Tripura" },
    new() { Code = "17", Name = "Meghalaya" },
    new() { Code = "18", Name = "Assam" },
    new() { Code = "19", Name = "West Bengal" },
    new() { Code = "20", Name = "Jharkhand" },
    new() { Code = "21", Name = "Odisha" },
    new() { Code = "22", Name = "Chhattisgarh" },
    new() { Code = "23", Name = "Madhya Pradesh" },
    new() { Code = "24", Name = "Gujarat" },
    new() { Code = "25", Name = "Daman and Diu" },
    new() { Code = "26", Name = "Dadra and Nagar Haveli" },
    new() { Code = "27", Name = "Maharashtra" },
    new() { Code = "28", Name = "Andhra Pradesh (Old)" },
    new() { Code = "29", Name = "Karnataka" },
    new() { Code = "30", Name = "Goa" },
    new() { Code = "31", Name = "Lakshadweep" },
    new() { Code = "32", Name = "Kerala" },
    new() { Code = "33", Name = "Tamil Nadu" },
    new() { Code = "34", Name = "Puducherry" },
    new() { Code = "35", Name = "Andaman and Nicobar Islands" },
    new() { Code = "36", Name = "Telangana" },
    new() { Code = "37", Name = "Andhra Pradesh (New)" },
    new() { Code = "38", Name = "Ladakh" }
};












}




