@page "/ViewCrateSubGrower/{Partyid:int}"
@using Microsoft.AspNetCore.Components.Web

@inject EmployeeAdoNetService EmployeeService
@using DevExpress.XtraReports.UI
@using DevExpress.Blazor.Reporting
@using System.IO
@using ClosedXML.Excel;
@using BlazorDemo.Services;
@using BlazorDemo;
@inject IJSRuntime JS
@inject NavigationManager NavigationManager


<link href="_content/DevExpress.Blazor.Themes/blazing-berry.bs5.min.css" rel="stylesheet" />

<link rel="stylesheet" href="_content/DevExpress.Blazor.Reporting.Viewer/css/dx-blazor-reporting-components.bs5.css">
<PageTitle>Grower Summary</PageTitle>

<div class="row g-4">
    <!-- Left Form (Single Column) -->
    @* // <div class="d-flex justify-content-between align-items-center p-3 bg-light border-bottom"> *@
    <div class="col-xl-4 col-lg-6 col-xs-12">
        <h5><strong>Crate summary Ledger</strong></h5>
    </div>

    <div class="d-flex justify-content-end gap-1">
        <button @onclick="ExportToExcel" class="btn btn-primary" style="background-color: green; border-color: green;">
            <i class="fas fa-file-excel"></i>
        </button>
        <button class="btn btn-primary" @onclick="GeneratePreview" style="background-color:  #616567; border-color:  #616567;">Print</button>
        <button @onclick="GoBack" class="btn btn-primary" style="background-color:  #616567; border-color:  #616567;">
            <i class="fa fa-arrow-left"></i>
        </button>
     
    </div>
</div>

@*    <style>
    .grid-container {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    }

        /* Optional: Make the grid itself wider than viewport */
        .grid-container .dxbl-grid {
            min-width: 800px; /* Adjust based on your total column widths */
        }
</style>
 *@

<style>
    @@media (max-width: 768px) {
        .dxbl-grid {
            width: 768px; /* Force minimum width */
        }
    }

    .alt-item {
        background-color: rgba(243, 244, 245, 1) !important;
    }

        .alt-item > td {
            --dxbl-grid-bg: rgba(243, 244, 245, 1) !important;
            background-color: rgba(243, 244, 245, 1) !important;
        }
</style>
<div style="overflow-x:auto; width:100%;">

    <DxGrid Data="@Growers" PageSize="10000000" ShowSearchBox="true"
            ShowGroupPanel="false" FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
            ColumnResizeMode="GridColumnResizeMode.NextColumn" CustomizeElement="Grid_CustomizeElement" TextWrapEnabled="true">

        <Columns>
           <DxGridDataColumn FieldName=@nameof(companyModel.GrowerName)  MinWidth="100" Caption="Group" Width="12%" />
            
            
            />
           <DxGridDataColumn FieldName=@nameof(companyModel.CrateIssue) MinWidth="100" Caption="Issued Qty" Width="7%" />
           
            <DxGridDataColumn FieldName=@nameof(companyModel.CrateReceive) MinWidth="100" Caption="Rec Comp Crates" Width="7%" />
            <DxGridDataColumn FieldName="@nameof(companyModel.SelfCrateReceive)" MinWidth="100" Caption="Rec Own Crates" Width="7%" />
            <DxGridDataColumn FieldName="@nameof(companyModel.PettyReceive)" MinWidth="100" Caption="Rec Petty Qty" Width="7%" />
            <DxGridDataColumn FieldName="@nameof(companyModel.TotalInwardQty)" MinWidth="100" Caption="Total Inward Qty" Width="7%" />
            <DxGridDataColumn FieldName=@nameof(companyModel.EmptyReceive) MinWidth="100" Caption="Empty Receive" Width="7%" />
            <DxGridDataColumn FieldName=@nameof(companyModel.CrateAdjustmentTaken) MinWidth="100" Caption="Crate Adj Taken" Width="7%" />
            <DxGridDataColumn FieldName=@nameof(companyModel.CrateAdjustmentGiven) MinWidth="100" Caption="Crate Adj Given" Width="7%" />
            <DxGridDataColumn FieldName="@nameof(companyModel.CrateBalance)" MinWidth="100" Caption="Pen. to Rec Qty" Width="7%" />
            <DxGridDataColumn FieldName="@nameof(companyModel.EmptyReturn)" MinWidth="100" Caption="Return Own Crates" Width="7%" />
            <DxGridDataColumn FieldName="@nameof(companyModel.SelfCrateBalance)" MinWidth="100" Caption="Pen. to Rec Own Qty" Width="7%" />
            <DxGridDataColumn FieldName="@nameof(companyModel.PettyReturn)" MinWidth="100" Caption="Petty Return" Width="7%" />
            <DxGridDataColumn FieldName="@nameof(companyModel.PettyBalance)" MinWidth="100" Caption="Petty Balance" Width="7%" />




            <DxGridCommandColumn MinWidth="100">
                <HeaderTemplate>
                    <strong>Actions</strong>
                    @* <a class="oi oi-action"  style="text-decoration: none;" href="javascript:void(0);"></a> *@
                </HeaderTemplate>
                <CellDisplayTemplate>
                    <a title="View Grower List" class="oi oi-person" @onclick="@(() =>ViewSummaryCrateGrowers(((CompanyModel)context.DataItem).GrowerGroupName))" style="cursor: pointer;"></a>

                </CellDisplayTemplate>
            </DxGridCommandColumn>



            <style>
                .even-row {
                    background-color: #f5f5f5; /* light gray */
                }

                .odd-row {
                    background-color: white;
                }
            </style>

            @*   <DxGridCommandColumn Caption="" Width="5%">

            <CellDisplayTemplate >
            <a class="oi oi-pencil" @onclick="@(() => MyGrid.StartEditRowAsync(context.VisibleIndex))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>

            <DxGridCommandColumn Caption="Del" Width="5%">
            <CellDisplayTemplate>
            <a class="oi oi-x" @onclick="@(() => MyGrid.ShowDataItemDeleteConfirmation(context.DataItem))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>
            <DxGridCommandColumn Caption="View" Width="5%">
            <CellDisplayTemplate>
            <a class="oi oi-eye" @onclick="@(() => MyGrid.ShowDataItemDeleteConfirmation(context.DataItem))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>
            <DxGridCommandColumn Caption="Add" Width="5%">
            <CellDisplayTemplate>
            <a class="oi oi-plus" @onclick="@(() => MyGrid.ShowDataItemDeleteConfirmation(context.DataItem))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>

            <DxGridCommandColumn Caption="Agreement" Width="5%">
            <CellDisplayTemplate>
            <a class="oi oi-document" @onclick="@(() => MyGrid.ShowDataItemDeleteConfirmation(context.DataItem))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>

            <DxGridCommandColumn Width="5%">
            <CellDisplayTemplate>
            <a class="oi oi-person" Caption="List" @onclick="@(() => MyGrid.ShowDataItemDeleteConfirmation(context.DataItem))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>
            *@
        </Columns>

        <TotalSummary>
            <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.CrateAgreement)" />
            <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.CrateIssue)" />
            <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.CrateReceive)" />
            <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.EmptyReceive)" />
            <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.CrateBalance)" />
            <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.SelfCrateReceive)" />
            <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.EmptyReturn)" />
            <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.SelfCrateBalance)" />
            <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.PettyReceive)" />
            <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.PettyReturn)" />
            <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.PettyBalance)" />
            <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.CrateAdjustmentGiven)" />
              <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.CrateAdjustmentTaken)" />



        </TotalSummary>


    </DxGrid>
</div>




    @if (showReport)
    {
        <div style="overflow-x:auto; width:100%;">
            <DxReportViewer @ref="reportViewer" Report="@Report">
            </DxReportViewer>
        </div>
    }



<DxDialogProvider />

<DxPopup @bind-Visible="@isDialogVisible"
         HeaderText="Confirmation"
         ShowCloseButton="true"
         CssClass="validation-dialog">
    <Content>
        Are you sure you want to change the status for Grower ID: <strong>@selectedGrowerId</strong>?
        <div>
            <DxButton RenderStyle="ButtonRenderStyle.Primary" Click="@OnConfirmYes">Yes</DxButton>
            <DxButton RenderStyle="ButtonRenderStyle.Secondary" Click="@OnConfirmNo">No</DxButton>
        </div>
    </Content>

</DxPopup>


<DxPopup @bind-Visible="@DeleteDialog"
         HeaderText="Confirmation"
         ShowCloseButton="true"
         CssClass="validation-dialog">
    <Content>
        Are you sure you want to delete the  Grower ID: <strong>@selectedGrowerId</strong>?
        <div>
            <DxButton RenderStyle="ButtonRenderStyle.Primary" Click="@OnConfirmYesDelete">Yes</DxButton>
            <DxButton RenderStyle="ButtonRenderStyle.Secondary" Click="@OnConfirmNoDelete">No</DxButton>
        </div>
    </Content>

</DxPopup>





@if (ShowEmptyFieldDialog)
{
    <DxPopup @bind-Visible="@ShowEmptyFieldDialog"
             HeaderText="Validation Error"
             ShowCloseButton="true"
             CssClass="validation-dialog">
        <Content>
            <p>@DialogMessage</p>
            <DxButton Text="OK" Click="@(() => ShowEmptyFieldDialog = false)" />
        </Content>
    </DxPopup>
}
<style>
    .custom-popup-style {
        background-color: #fdfdfd;
        border: 2px solid #0078d4;
        border-radius: 12px;
        padding: 10px;
        font-family: 'Segoe UI', sans-serif;
    }

        .custom-popup-style .dxbs-popup-header {
            background-color: #0078d4;
            color: white;
            font-weight: bold;
            border-bottom: none;
        }

        .custom-popup-style .dxbs-popup-content {
            font-size: 15px;
            padding: 15px;
        }
</style>
@if (ShowEmptyFieldDialogError)
{
    <DxPopup @bind-Visible="@ShowEmptyFieldDialogError"
             HeaderText="Confirmation Message"
             ShowCloseButton="true"
             CssClass="custom-popup-style">



        <Content>
            <p><strong>Success </strong>@DialogMessage</p>
            <DxButton Text="OK" RenderStyle="ButtonRenderStyle.Primary" Click="@(() => ShowEmptyFieldDialogError = false)" />
        </Content>
    </DxPopup>
}











@code {
    [Parameter] public int Partyid { get; set; }
    public string GrowerGroupName { get; set; } = "";
    bool showReport = false;
    DxReportViewer? reportViewer;
    XtraReport? Report;
    private string DialogMessage { get; set; } = "";
    private bool ShowEmptyFieldDialogError { get; set; }
    private string ChallanGroup { get; set; } = "";

    private bool isExporting = false;
    private string successMessage = string.Empty;
    private string errorMessage = string.Empty;

    private bool ShowEmptyFieldDialog { get; set; }
    protected async Task GeneratePreview()
    {
        string GrowerGroupNameCrates = GrowerGroupName;

        ///   await JS.InvokeVoidAsync("alert", GrowerGroupNameCrates);
        Growers = await EmployeeService.GetCrateSummarySubgrower(GrowerGroupNameCrates);

        Report = XtraReport.FromFile(Path.Combine(Directory.GetCurrentDirectory(),
          @"Reports\SubCrateSummary.repx"));



        showReport = true;

    }


    private void DeleteGrower(int growerId)
    {
        selectedGrowerId = growerId;
        DeleteDialog = true;


    }
    private void ViewGrower(int growerId)
    {
        companyModel.Growerid = growerId;


        NavigationManager.NavigateTo($"/ViewGrower/{growerId}");

    }


    private void AddGrowerAgreement(int growerId)
    {
        companyModel.Growerid = growerId;


        NavigationManager.NavigateTo($"/EditGrowerAgreement/{growerId}");

    }






    private void ViewSubGrower(int growerId)
    {
        companyModel.Growerid = growerId;


        NavigationManager.NavigateTo($"/ViewSubGrower/{growerId}");

    }


    private void AddGrower(int growerId)
    {
        companyModel.Growerid = growerId;


        NavigationManager.NavigateTo($"/AddGrower");

    }

    private async Task<byte[]> ExportCrateSummaryToExcel()

    {

        companyModel.GrowerGroupName = GrowerGroupName;
        companyModel.GrowerGroupName = selectedrefname;
        var data = await EmployeeService.GetCrateSummarySubgrower(GrowerGroupName);




        using (var workbook = new XLWorkbook())
        {
            var worksheet = workbook.Worksheets.Add("Crate Analysis Summary");

            // Add headers with styling
            var headers = new string[]
            {
            "Party Name", "Agreement", "Crate Issue", "Crate Receive", "Empty Receive",
            "Crate Adjustment Given", "Crate Adjustment Taken", "Crate Balance",
            "Self Crate Receive", "Empty Return", "Self Crate Balance",
            "Petty Receive", "Petty Return", "Petty Balance"
            };
            for (int i = 0; i < headers.Length; i++)
            {
                var cell = worksheet.Cell(1, i + 1);
                cell.Value = headers[i];
                cell.Style.Font.Bold = true;
                cell.Style.Fill.BackgroundColor = XLColor.LightGray;
                cell.Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Center;
                cell.Style.Border.OutsideBorder = XLBorderStyleValues.Thin;
            }

            int row = 2;
            foreach (var item in data)
            {
                worksheet.Cell(row, 1).Value = item.GrowerName;
                worksheet.Cell(row, 2).Value = item.CrateAgreement;
                worksheet.Cell(row, 3).Value = item.CrateIssue;
                worksheet.Cell(row, 4).Value = item.CrateReceive;
                worksheet.Cell(row, 5).Value = item.EmptyReceive;
                worksheet.Cell(row, 6).Value = item.CrateAdjustmentGiven;
                worksheet.Cell(row, 7).Value = item.CrateAdjustmentTaken;
                worksheet.Cell(row, 8).Value = item.CrateBalance;
                worksheet.Cell(row, 9).Value = item.SelfCrateReceive;
                worksheet.Cell(row, 10).Value = item.EmptyReturn;
                worksheet.Cell(row, 11).Value = item.SelfCrateBalance;
                worksheet.Cell(row, 12).Value = item.PettyReceive;
                worksheet.Cell(row, 13).Value = item.PettyReturn;
                worksheet.Cell(row, 14).Value = item.PettyBalance;
                row++;
            }

            for (int col = 2; col <= headers.Length; col++)
            {
                worksheet.Column(col).Style.NumberFormat.NumberFormatId = 0; // Number format
            }
            worksheet.Columns().AdjustToContents();

            // Add borders to all cells
            var dataRange = worksheet.Range(1, 1, row - 1, headers.Length);
            dataRange.Style.Border.InsideBorder = XLBorderStyleValues.Thin;
            dataRange.Style.Border.OutsideBorder = XLBorderStyleValues.Medium;
            using (var stream = new MemoryStream())
            {
                workbook.SaveAs(stream);
                return stream.ToArray();
            }
        }
    }

    private async Task ExportToExcel()
    {
        try
        {
            isExporting = true;
            successMessage = string.Empty;
            errorMessage = string.Empty;
            StateHasChanged();

            // Call the export method directly from your repository
            var fileBytes = await ExportCrateSummaryToExcel();
            var fileName = $"Crate_Analysis_Summary_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";

            await JS.InvokeVoidAsync("downloadFile",
              Convert.ToBase64String(fileBytes),
              fileName);

            successMessage = "Excel file downloaded successfully!";
        }
        catch (Exception ex)
        {
            errorMessage = $"Export failed: {ex.Message}";
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }


    private void EditGrower(int growerId)
    {
        companyModel.Growerid = growerId;


        NavigationManager.NavigateTo($"/EditGrower/{growerId}");

    }
    protected async Task OnConfirmYes()
    {


        companyModel.Growerid = selectedGrowerId;
        await EmployeeService.UpdateGrowerStatus(selectedGrowerId, companyModel);


        Growers = await EmployeeService.GetallGrowers();


        StateHasChanged();
        isDialogVisible = false;

    }

    protected async Task OnConfirmYesDelete()
    {


        companyModel.Growerid = selectedGrowerId;

        var result = await EmployeeService.DeleteGrowerGroup(selectedGrowerId, companyModel);
        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {
            Growers = await EmployeeService.GetallGrowers();
            DialogMessage = result.RetMessage;
            ShowEmptyFieldDialogError = true;


            StateHasChanged();
            DeleteDialog = false; // Close the delete confirmation dialog
            return;
        }



        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to Update grower group.";
            ShowEmptyFieldDialog = true;
            DeleteDialog = false;
            return;
        }















        Growers = await EmployeeService.GetallGrowers();


        StateHasChanged();
        isDialogVisible = false;

    }


    private void OnConfirmNoDelete()
    {
        DeleteDialog = false;
    }






    private void ViewSummaryCrateGrowers(string growerGroupName)
    {
        companyModel.GrowerGroupName = growerGroupName;


        NavigationManager.NavigateTo($"/ViewCrateSubGrower/{growerGroupName}");

    }
    private async Task GoBack()
    {
        await JS.InvokeVoidAsync("history.back");
    }



    private void OnConfirmNo()
    {
        isDialogVisible = false;
    }

    string GetRowCssClass(object dataItem, int visibleIndex)
    {
        return visibleIndex % 2 == 0 ? "even-row" : "odd-row";
    }

    private bool DeleteDialog = false;
    private bool isDialogVisible = false;
    private int selectedGrowerId;
    private void ShowConfirmDialog(int growerId)
    {
        selectedGrowerId = growerId;
        isDialogVisible = true;


    }
    private void GoToAddGrowerPage()
    {
        NavigationManager.NavigateTo("/AddGrower");
    }






    void ChangeSearchMode(string key)
    {
        // CurrentSearchTextParseModeDisplayText = key;
        // CurrentSearchTextParseMode = SearchTextParseModes[key];
    }

    public void ShowDetails(int employeeId)
    {

    }
    public void ShowDetails1(string ename)
    {

    }
    public void ShowDetails2(string dept)
    {

    }
    // private string activeBreakpoint { get; set; }

    // // private List<Order> orders { get; set; }

    // private bool enableAdaptiveUIMode { get; set; }
    // private RowDirection renderingMode { get; set; }empl
    CompanyModel companyModel = new CompanyModel();
    IGrid MyGrid { get; set; }
    List<CompanyModel> Growers = new List<CompanyModel>();
    private string selectedrefname  ;
    protected override async Task OnInitializedAsync()
    {
        companyModel = await EmployeeService.GetGroupName(Partyid);
        GrowerGroupName = companyModel.GrowerGroupName;
      
        // companyModel.GrowerGroupName = GrowerGroupName;
        // companyModel.GrowerGroupName = selectedrefname;
        Growers = await EmployeeService.GetCrateSummarySubgrower(GrowerGroupName);
        StateHasChanged();

    }
    // SfGrid<CompanyModel> Gri

    // FilterSettings filterSettings = new FilterSettings { Type = FilterType.Excel };


    private async Task EditHandler(Employee employee)
    {
        // await Grid.SelectRowAsync(companyModel.chid);
        // await Grid.StartEditAsync();
    }


    private async Task DeleteHandler(Employee employee)
    {

    }
    protected async Task SaveUnit()
    {
    }
    void Grid_CustomizeElement(GridCustomizeElementEventArgs e)
    {
        if (e.ElementType == GridElementType.DataRow && e.VisibleIndex % 2 == 1)
        {
            e.CssClass = "alt-item";
        }
        if (e.ElementType == GridElementType.HeaderCell)
        {
            e.Style = "background-color: var(--DS-color-surface-neutral-default-selected)";
            e.CssClass = "header-bold";
        }


    }


    public class Order
    {
        public int? OrderID { get; set; }
        public string CustomerID { get; set; }
        public DateTime? OrderDate { get; set; }
        public double? Freight { get; set; }
    }
}