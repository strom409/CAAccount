@page "/ViewOutward/{Demandid:int}"


@inject ProtectedLocalStorage ProtectedLocalStore
@using Microsoft.AspNetCore.Components.Web
@using System.IO
@inject EmployeeAdoNetService EmployeeService
@using BlazorDemo.Pages.Definitions;
@using BlazorDemo.Services;
@using BlazorDemo;
@using System.Text.RegularExpressions
@inject UserSessionService UserSessionService
@using Syncfusion.Blazor.DropDowns

@inject IJSRuntime JS
@inject NavigationManager NavigationManager
<link href="_content/DevExpress.Blazor.Themes/blazing-berry.bs5.min.css" rel="stylesheet" />
<link rel="stylesheet" href="_content/DevExpress.Blazor.Reporting.Viewer/css/dx-blazor-reporting-components.bs5.css">
<PageTitle>@EditModel.Vehno</PageTitle>
<div style="background-color: #7B7575; height: 1.0cm; width: 100%; position: relative;">
    <h6 style="color: white; position: absolute; left: 15px; top: 50%; transform: translateY(-50%); margin: 0;">Edit Outward</h6>
</div>

<style>
    .flat-multiselect .e-input-group,
    .flat-multiselect .e-input-group.e-control-wrapper {
        border-radius: 0;
        border: 1px solid #ccc;
        box-shadow: none;
    }

        .flat-multiselect .e-input-group:focus,
        .flat-multiselect .e-input-group.e-control-wrapper:focus,
        .flat-multiselect .e-input-group.e-control-wrapper.e-input-focus {
            border-color: #0078d4;
            box-shadow: none;
        }
</style>
<style>
    .control-section {
        min-height: 370px;
    }

    .control-wrapper {
        max-width: 300px;
        margin: 0 auto;
        padding: 50px 0px 0px;
    }

    .example-label {
        font-size: 14px;
        margin-bottom: 6px;
    }

    .property-panel-content {
        padding: 0px 0px 15px 0px;
    }

        .property-panel-content:last-child {
            padding: 0px 0px 40px 0px;
        }
</style>

@* <style>
    label {
        font-weight: bold;

    }
</style> *@

<div class="page-header">
</div>


<!-- Left-aligned buttons -->
<div class="d-flex justify-content-between align-items-center gap-2">
    <button style="background-color:#5A5E60" @onclick="GoBack" class="btn btn-primary">
        <i class="fa fa-arrow-left"></i>
    </button>

    <div class="d-flex gap-2">
       
    </div>
</div>

<div class="page-header">
    <h5>
        <strong>
           <span style="color: green;" class="d-none">@EditModel?.TempOutwardId</span>
        </strong>
    </h5>
</div>



<style>
    .custom-width {
        width: 30%; /* Or a fixed width like 300px */
    }


    .custom-input-height input {
        height: 35px !important;
        font-size: 16px;
        padding: 10px;
        box-sizing: border-box;
    }

    .input-group {
        display: flex;
        flex-direction: column;
        width: 100%;
    }

    .full-width {
        width: 100%;
    }

    .disabled-number-input {
        background-color: #f5f5f5;
        color: red;
        border: 1px solid #ccc;
        padding: 8px;
        font-size: 1rem;
</style>

@if (TrickCrateAnalysis)
{
    <div class="container-fluid">
        @foreach (var company in GetCrateAnalysis)
        {
            <div class="row mb-3">
                <div class="col-12">
                    <h5 class="mb-3">@company.Name</h5> <!-- Optional: show company name -->
                </div>

                <div class="col-md-4 col-lg-2">
                    <label class="form-label">Crate Agreement</label>
                    <InputNumber style="color: red;" class="form-control text-danger"
                                 @bind-Value="company.CrateAgreement"
                                 disabled />
                </div>

                <div class="col-md-4 col-lg-2">
                    <label class="form-label">Crate Issue</label>
                    <InputNumber style="color: red;" class="form-control text-danger"
                                 @bind-Value="company.CrateIssue"
                                 disabled />
                </div>

                <div class="col-md-4 col-lg-2">
                    <label class="form-label">Crate Receive</label>
                    <InputNumber style="color: red;" class="form-control text-danger"
                                 @bind-Value="company.CrateReceive"
                                 disabled />
                </div>

                <div class="col-md-4 col-lg-2">
                    <label class="form-label">Empty Receive</label>
                    <InputNumber style="color: red;" class="form-control text-danger"
                                 @bind-Value="company.EmptyReceive"
                                 disabled />
                </div>

                <div class="col-md-4 col-lg-2">
                    <label class="form-label">Crate Available</label>
                    <InputNumber style="color: red;" class="form-control text-danger"
                                 @bind-Value="company.CrateAvailable"
                                 disabled />
                </div>
                <div class="col-md-4 col-lg-2">
                    <label class="form-label">Rec Pend Grower Group</label>
                    <InputNumber style="color: red;" class="form-control text-danger"
                                 @bind-Value="company.PartyPending"
                                 disabled />
                </div>

                <div class="col-md-4 col-lg-2">
                    <label class="form-label">Rec. Pend Grower</label>
                    <InputNumber style="color: red;" class="form-control text-danger"
                                 @bind-Value="company.GrowerPending"
                                 disabled />
                </div>



            </div>
            <hr />
        }
    </div>




}

<style>
    .green-header-grid .dxbl-grid-header {
        background-color: #FFFFFF !important;
        color: black !important;
    }

    .green-header-grid .dxbl-grid-header-cell {
        background-color: #FFFFFF !important;
        color: black !important;
    }
</style>


<style>
    @@media (max-width: 768px) {
        .dxbl-grid {
            width: 768px; /* Force minimum width */
        }
    }

    .alt-item {
        background-color: rgba(243, 244, 245, 1) !important;
    }

        .alt-item > td {
            --dxbl-grid-bg: rgba(243, 244, 245, 1) !important;
            background-color: rgba(243, 244, 245, 1) !important;
        }
</style>





<style>
    .centered-field {
        display: flex;
        flex-direction: column;
        align-items: center; /* centers children horizontally */
    }

        .centered-field label {
            text-align: center; /* centers the label’s text */
            width: 100%; /* ensure the label fills the container */
            margin-bottom: .5rem;
        }

        .centered-field input {
            width: 200px; /* or whatever width you like */
        }

    /* Slightly darker but still subtle placeholder */
    .input-placeholder-dim::placeholder {
        color: rgba(130, 130, 130, 0.3) !important; /* dim gray, 30% opacity */
        opacity: 1 !important;
    }

    /* Dark gray border on focus, no shadow */
    .input-focus-dark:focus {
        border-color: #343a40; /* dark gray */
        box-shadow: none !important;
        outline: none;
    }

    .table-responsive {
        overflow-x: auto;
        width: 100%;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem; /* optional small font */
    }

        .table th, .table td {
            padding: 0.5rem;
            text-align: left;
        }

    .zebra-table tbody tr:nth-child(odd) {
        background-color: white;
    }

    .zebra-table tbody tr:nth-child(even) {
        background-color: #f9f9f9;
    }




    /* Custom small font */
    .small-font {
        font-size: 0.82rem;
    }

    .control-wrapper {
        max-width: 250px;
        margin: 0 auto;
        padding: 50px 0px 0px;
    }

    .example-label {
        font-size: 14px;
        margin-bottom: 6px;
        /* Standardize form control styles for horizontal alignment */
        input .form-control, .e-input-group, .e-control-wrapper, .e-autocomplete, .e-input

    {
        min-height: 38px; /* Bootstrap default */
        line-height: 1.5;
        font-size: 14px;
        font-family: 'Source Sans Pro', sans-serif;
        padding: 6px 12px;
        box-sizing: border-box;
    }

    /* Optional: Align content inside Syncfusion AutoComplete */
    .e-autocomplete .e-input {
        padding: 6px 12px !important;
    }

    /* Remove extra bottom spacing in SfAutoComplete wrapper */
    .e-autocomplete.e-control-wrapper {
        margin-bottom: 0 !important;
    }

    /* Align labels consistently */
    label.form-label {
        font-size: 14px;
        margin-bottom: 4px;
        font-family: 'Source Sans Pro', sans-serif;
    }

    /* Remove extra vertical margin if any Syncfusion adds it */
    .e-control-wrapper {
        margin-top: 0 !important;
        margin-bottom: 0 !important;
    }

</style>


<style>
    .alt-item {
        background-color: rgba(243, 244, 245, 1) !important;
    }

        .alt-item > td {
            --dxbl-grid-bg: rgba(243, 244, 245, 1) !important;
            background-color: rgba(243, 244, 245, 1) !important;
        }
</style>

<style>
    /* Remove all shadows and gradients */
    .flat-style .e-input-group,
    .flat-style .e-input-group.e-control-wrapper {
        border-radius: 0;
        border: 1px solid #d1d1d1;
        box-shadow: none;
        background: #fff;
    }

        /* Focus state */
        .flat-style .e-input-group:focus-within,
        .flat-style .e-input-group.e-control-wrapper.e-input-focus {
            border-color: #0078d4;
            box-shadow: none;
            outline: none;
        }

    /* Remove dropdown arrow styling */
    .flat-style .e-input-group-icon {
        border: none;
        background: transparent;
    }

    /* Popup styling */
    .flat-style .e-multiselect.e-popup {
        border-radius: 0;
        border: 1px solid #d1d1d1;
        box-shadow: none;
    }

    /* List items */
    .flat-style .e-list-item {
        border-radius: 0;
    }

        .flat-style .e-list-item:hover {
            background-color: #f5f5f5;
        }

        .flat-style .e-list-item.e-item-focus {
            background-color: #e6e6e6;
        }
</style>

<div class="card p-3 mb-4">
    <div class="row g-3 align-items-end">

        <div class="col-md-2 col-sm-6">
            <label for="crateType" class="form-label">Outward Type</label>
            <select id="crateType" class="form-select form-select-sm w-100"
                    style="height: 33px;" @bind="EditModel.Outwardtype" required>
                <option disabled selected value="">Select</option>
                <option value="Grading">Grading</option>
                <option value="Outside">Outside</option>


            </select>
        </div>

         <div class="col-md-3 col-sm-6">
            <label for="lastName" class="form-label">Order No</label>
            <SfAutoComplete style="height: 30px;"
                            ShowPopupButton="true"
                            TValue="string"
                            DebounceDelay=300
                          
                            CssClass="flat-style no-focus-shadow"
                            TItem="CompanyModel"
                            Value="@EditModel.PackingOrderIrn"
                            ValueChanged="@((string value) => OnPackingOrderIrnChanged(value))"
                            Placeholder="Packing order"
                            DataSource="@PackingOrderist">
                 
                 
                 
                 <AutoCompleteFieldSettings Text="PackingOrderIrn" Value="PackingOrderIrn"></AutoCompleteFieldSettings>
                <AutoCompleteEvents TValue="string"
                                    TItem="CompanyModel"
                                 
                                    Focus="OnFocus" />
</SfAutoComplete>


        </div>





        <div class="col-md-3 col-sm-6">
            
            <label for="lastName" class="form-label">Grower Group Name</label>
    <DxComboBox @key="GrowerGroupKey" Data="@GetgrowerList"
                SearchMode="@SearchMode"
                SearchFilterCondition="@SearchFilterCondition"
                NullText="Select..."
                SearchTextParseMode="@SearchTextParseMode"
                ValueChanged="@(async (string? newValue) => await OnGrowerGroupChanged(newValue))"
                TextFieldName="GrowerName"
                DropDownVisibleChanged="OnDropDownVisibleChanged"
                @onfocus="HandleFocus"
                ValueFieldName="GrowerName"
                CssClass="small-input"
                Value="@EditModel.GrowerGroupName"
                Enabled="@isComboDisabled"
                InputId="cbFiltering"
             
                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />
               









        </div>

     <div class="col-sm-2">
     <label for="lastName" class="form-label">Grower Name</label>
     <DxComboBox @key="GrowerNameKey" Data="@GetSubGrowerGroup"
            NullText="Select..."
                 SearchMode="@SearchMode"
                 SearchFilterCondition="@SearchFilterCondition"
                 SearchTextParseMode="@SearchTextParseMode"
                 Value="@EditModel.GrowerName"
                 ValueChanged="@(async (string? newValue) => await OnSubgrowerChanged(newValue))"
                 TextFieldName="GrowerName"
                 ValueFieldName="GrowerName"
                 DropDownVisibleChanged="OnSubDropDownChanged"
                 @onfocus="HandleFocusSub"
                 InputCssClass="small-input"
                 InputId="cbFiltering"
                 ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />
 </div>




       <div class="col-sm-1 d-flex align-items-end">
          @*   <button type="button" class="btn btn-sm btn-default me-2" style="min-width: 80px; color:white; background-color:#5A5E60" @onclick="SearchLots">
                <i class="fa fa-search"></i> Search
            </button> *@

        </div>



           <div class="col-md-2">
            <label for="txtToDate">To Date<span style="color: red">*</span></label>
            <InputDate @bind-Value="@companyModel.OutwardDate" style="height: 30px;" class="form-control" id="txtToDate" />
        </div>



        <div class="col-md-2">
            <label for="lastName" class="form-label">Grower Group</label>

            <SfAutoComplete style="height: 30px;"
                            ShowPopupButton="true"
                            TValue="string"
                            DebounceDelay=300
                            CssClass="flat-style no-focus-shadow"
                            TItem="CompanyModel"
                            Value="@EditModel.OutwardGrowerGroup"
                            ValueChanged="@((string value) => Onoutwardgroup(value))"
                            Placeholder="Packing order"
                            DataSource="@outwardgrowerlist">



                <AutoCompleteFieldSettings Text="OutwardGrowerGroup" Value="OutwardGrowerGroup"></AutoCompleteFieldSettings>
                <AutoCompleteEvents TValue="string"
                                    TItem="CompanyModel"
                                    Focus="OnFocus" />
            </SfAutoComplete>




        </div>

           
        <div class="col-md-2">
            <label for="lastName" class="form-label">Grower Name</label>

            <SfAutoComplete style="height: 30px;"
                            ShowPopupButton="true"
                            TValue="string"
                            DebounceDelay=300
                            CssClass="flat-style no-focus-shadow"
                            TItem="CompanyModel"
                            Value="@EditModel.OutwardGrowerName"
                            ValueChanged="@((string value) => Onoutwardgrower(value))"
                            Placeholder="Packing order"
                            DataSource="@GetSubGrowerGroup">



                <AutoCompleteFieldSettings Text="OutwardGrowerName" Value="OutwardGrowerName"></AutoCompleteFieldSettings>
                <AutoCompleteEvents TValue="string"
                                    TItem="CompanyModel"
                                    Focus="OnFocus" />
            </SfAutoComplete>





        </div>

        <div class="col-md-2">
            <label for="lastName" class="form-label">Challan</label>

            <SfAutoComplete style="height: 30px;" ShowPopupButton="true" TValue="string" DebounceDelay=300 CssClass="flat-style no-focus-shadow" TItem="CompanyModel" @bind-Value="EditModel.ChallanName" Placeholder="Packing locaton" DataSource="@GetChallanGroup">
                <AutoCompleteFieldSettings Text="ChallanName" Value="ChallanName" />
            </SfAutoComplete>





        </div>
           
        <div class="col-md-2">
            <label for="lastName" class="form-label">Vehicle No</label>
            <div class="d-flex align-items-center">
                <div class="flex-grow-1 me-1">
                    <DxComboBox Data="@GetVehlist"
                                SearchMode="@SearchMode"
                                ListRenderMode="ListRenderMode.Virtual"
                                SearchFilterCondition="@SearchFilterCondition"
                                SearchTextParseMode="@SearchTextParseMode"
                                @bind-Value="EditModel.Vehno"
                                TextFieldName="Vehno"
                                ValueFieldName="Vehno"
                                DropDownVisibleChanged="OnVehDropDownChanged"
                                @onfocus="HandleFocusVeh"
                                CssClass="custom-input-height"
                                InputId="cbFiltering"
                                style="width: 100%;"
                                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />
                </div>

             

                    <button class="btn btn-dark btn-sm"
                            type="button"
                            @onclick="AddNewVehicle"
                            style="height: 31px;">
                        <i class="fas fa-plus"></i>
                    </button>

                

            </div>
        </div>


        

        <!-- Button Column - Now inline with the inputs -->
    @*     <div class="col-sm-2 d-flex align-items-end">
            <button type="button" class="btn btn-sm btn-default me-2" style="min-width: 80px; color:white; background-color:#5A5E60" @onclick="SearchLots">
                <i class="fa fa-search"></i> Search
            </button>

            <button type="button" class="btn btn-sm btn-default" style="min-width: 80px; color:black; background-color:lightgrey" @onclick="ClearParam">
                Clear
            </button>
        </div>

 *@


        <style>
            /* Remove focus shadow from AutoComplete */
            .no-focus-shadow.e-input-group:not(.e-success):not(.e-warning):not(.e-error):not(.e-float-icon-left),
            .no-focus-shadow.e-input-group.e-float-icon-left:not(.e-success):not(.e-warning):not(.e-error) {
                box-shadow: none !important;
            }

            #pallet-autocomplete.e-input-group.e-control-wrapper {
                height: 30px !important;
            }

            #pallet-autocomplete .e-input-group {
                height: 30px !important;
            }

            #pallet-autocomplete input.e-input {
                height: 30px !important;
                padding: 0 12px 0 10px !important;
            }

            .no-focus-shadow.e-input-group:focus,
            .no-focus-shadow.e-input-group:focus-within,
            .no-focus-shadow.e-input-group.e-control-wrapper:focus,
            .no-focus-shadow.e-input-group.e-control-wrapper:focus-within {
                box-shadow: none !important;
                border-color: #ddd !important; /* Optional: Set a custom border color */
            }

            /* If you want to remove ALL focus styling including outline */
            .no-focus-shadow.e-input-group.e-input-focus:not(.e-success):not(.e-warning):not(.e-error),
            .no-focus-shadow.e-input-group.e-input-focus:not(.e-success):not(.e-warning):not(.e-error):hover {
                box-shadow: none !important;
                outline: none !important;
                border-color: #ced4da !important; /* Match your design */
            }
        </style>

        <style>
            .centered-field {
                display: flex;
                flex-direction: column;
                align-items: center; /* centers children horizontally */
            }

                .centered-field label {
                    text-align: center; /* centers the label’s text */
                    width: 100%; /* ensure the label fills the container */
                    margin-bottom: .5rem;
                }

                .centered-field input {
                    width: 200px; /* or whatever width you like */
                }

            /* Slightly darker but still subtle placeholder */
            .input-placeholder-dim::placeholder {
                color: rgba(130, 130, 130, 0.3) !important; /* dim gray, 30% opacity */
                opacity: 1 !important;
            }

            /* Dark gray border on focus, no shadow */
            .input-focus-dark:focus {
                border-color: #343a40; /* dark gray */
                box-shadow: none !important;
                outline: none;
            }

            .table-responsive {
                overflow-x: auto;
                width: 100%;
            }

            .table {
                width: 100%;
                border-collapse: collapse;
                font-size: 0.875rem; /* optional small font */
            }

                .table th, .table td {
                    padding: 0.5rem;
                    text-align: left;
                }

            .zebra-table tbody tr:nth-child(odd) {
                background-color: white;
            }

            .zebra-table tbody tr:nth-child(even) {
                background-color: #f9f9f9;
            }




            /* Custom small font */
            .small-font {
                font-size: 0.82rem;
            }

            .control-wrapper {
                max-width: 250px;
                margin: 0 auto;
                padding: 50px 0px 0px;
            }

            .example-label {
                font-size: 14px;
                margin-bottom: 6px;
                /* Standardize form control styles for horizontal alignment */
                input .form-control, .e-input-group, .e-control-wrapper, .e-autocomplete, .e-input

            {
                min-height: 38px; /* Bootstrap default */
                line-height: 1.5;
                font-size: 14px;
                font-family: 'Source Sans Pro', sans-serif;
                padding: 6px 12px;
                box-sizing: border-box;
            }

            /* Optional: Align content inside Syncfusion AutoComplete */
            .e-autocomplete .e-input {
                padding: 6px 12px !important;
            }

            /* Remove extra bottom spacing in SfAutoComplete wrapper */
            .e-autocomplete.e-control-wrapper {
                margin-bottom: 0 !important;
            }

            /* Align labels consistently */
            label.form-label {
                font-size: 14px;
                margin-bottom: 4px;
                font-family: 'Source Sans Pro', sans-serif;
            }

            /* Remove extra vertical margin if any Syncfusion adds it */
            .e-control-wrapper {
                margin-top: 0 !important;
                margin-bottom: 0 !important;
            }

        </style>















    </div>
</div>
@if (ShowAddGrid)
{

    <div style="overflow-x:auto; width:100%;">

        <DxGrid Data="@GetPackingStockTemp" CssClass="green-header-grid" ShowSearchBox="true"PageSize="1000"
            PageSizeSelectorVisible="true" PagerPosition="GridPagerPosition.TopAndBottom"
            PageSizeSelectorItems="@(new int[] {5, 10, 25, 50, 100, 150, 200, 250, 300, 350, 400, 500 })"
        ShowGroupPanel="false" FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
        ColumnResizeMode="GridColumnResizeMode.NextColumn" CustomizeElement="Grid_CustomizeElement" TextWrapEnabled="true">
            <ToolbarTemplate>
                @*   <div class="d-flex align-items-center gap-4 w-100">
            <button type="button" class="btn btn-sm " style="min-width: 80px; color:white; background-color:#5A5E60" @onclick="SaveLot">
            Save
            </button>

            </div> *@
            </ToolbarTemplate>
            <Columns>


                  <DxGridDataColumn FieldName=@nameof(companyModel.Outwardid) Visible="false" MinWidth="100" Caption="Idno" Width="10%" />
                <DxGridDataColumn FieldName=@nameof(companyModel.DispatcherId) Visible="false" MinWidth="100" Caption="Idno" Width="10%" />


            @*     <DxGridDataColumn FieldName="IsSelected" MinWidth="50" Caption="Add" Width="5%">

                    <CellDisplayTemplate Context="cellData">
                        @{
                            var isSelected = (bool)(cellData.Value ?? false);
                            var itemId = ((CompanyModel)cellData.DataItem);
                        }
                        <input type="checkbox"
                        checked="@isSelected"
                        @onchange="(e) => OnCheckboxChanged(e, itemId)" />

                    </CellDisplayTemplate>



                </DxGridDataColumn>
 *@
@* 
                <DxGridDataColumn FieldName="IsReturned" MinWidth="50" Caption="Return" Width="5%">

                    <CellDisplayTemplate Context="cellData">
                        @{
                            var isSelected = (bool)(cellData.Value ?? false);
                            var itemId = ((CompanyModel)cellData.DataItem);
                        }
                        <input type="checkbox"
                        checked="@isSelected"
                        @onchange="(e) => OnCheckboxChangedReturn(e, itemId)" />

                    </CellDisplayTemplate>



                </DxGridDataColumn> *@


                <DxGridDataColumn FieldName=@nameof(companyModel.Packingorderid) Visible="false" MinWidth="100" Caption="Lotno" Width="10%" />
                <DxGridDataColumn FieldName=@nameof(companyModel.PalletId) Visible="false" MinWidth="100" Caption="Lotno" Width="10%" />

                <DxGridDataColumn FieldName=@nameof(companyModel.PackingOrderIrn) MinWidth="100" Caption="Packing Order No" Width="10%" />
                <DxGridDataColumn FieldName=@nameof(companyModel.GrowerGroupName) MinWidth="100" Caption="Party" Width="20%" />

                <DxGridDataColumn FieldName=@nameof(companyModel.PalletName) MinWidth="100" Caption="Pallet No" Width="5%" />
                <DxGridDataColumn FieldName="@nameof(companyModel.DispatchQty)" MinWidth="100" Caption="Dispatch Qty" Width="10%" />
                <DxGridDataColumn FieldName="@nameof(companyModel.OutwardQty)" MinWidth="100" Caption="Outward Qty" Width="10%">


                    <CellDisplayTemplate Context="cellData">
                        @{
                            var companyModel = (CompanyModel)cellData.DataItem;
                        }
                        <input type="number"
                        value="@companyModel.OutwardQty"
                        @oninput="async (e) => await OnOrderQtyChanged(companyModel, e)"
                        class="form-control input-placeholder-dim input-focus-dark" min=0 disabled
                        style="background-color: white; border: 1px solid #ddd; padding: 2px 5px;" />
                    </CellDisplayTemplate>


                </DxGridDataColumn>
                <DxGridDataColumn FieldName="@nameof(companyModel.Outwardbalance)" MinWidth="100" Caption="Availabale Qty" Width="10" />
                <DxGridDataColumn FieldName="@nameof(companyModel.OutwardPackingbalance)" Visible="false" MinWidth="100" Caption="Availabale Qty" Width="10" />

                <DxGridDataColumn FieldName="@nameof(companyModel.ReceipeName)" MinWidth="100" Caption="Recipe Name" Width="18%" />


                <DxGridDataColumn FieldName=@nameof(companyModel.ReceipeMarka) MinWidth="100" Caption="Marka" Width="5%" />
                <DxGridDataColumn FieldName="@nameof(companyModel.ReceipeGrade)" MinWidth="100" Caption="Grade" Width="5%" />

                <DxGridDataColumn FieldName="@nameof(companyModel.VarietyId)" MinWidth="100" Caption="Variety" Width="10%" />
                <DxGridDataColumn FieldName="@nameof(companyModel.Vehno)" MinWidth="100" Caption="Vehno" Width="10%" />





                <style>
                    @@media (max-width: 768px) {
                    .dxbl-grid {
                    width: 768px; /* Force minimum width */
                    }
                    }

                    .alt-item {
                    background-color: rgba(243, 244, 245, 1) !important;
                    }

                    .alt-item > td {
                    --dxbl-grid-bg: rgba(243, 244, 245, 1) !important;
                    background-color: rgba(243, 244, 245, 1) !important;
                    }
                </style>


                 <DxGridCommandColumn Caption="" Width="5%">

            <CellDisplayTemplate >
                <a title="Delete Receipe" class="fa fa-trash text-red" @onclick="@(() => DeleteGrower(((CompanyModel)context.DataItem).Outwardid))" style="text-decoration: none;" href="javascript:void(0);"></a>
                    

            </CellDisplayTemplate>
            </DxGridCommandColumn>

                @*  <DxGridCommandColumn Caption="Del" Width="5%">
            <CellDisplayTemplate>
            <a class="oi oi-x" @onclick="@(() => MyGrid.ShowDataItemDeleteConfirmation(context.DataItem))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>
            <DxGridCommandColumn Caption="View" Width="5%">
            <CellDisplayTemplate>
            <a class="oi oi-eye" @onclick="@(() => MyGrid.ShowDataItemDeleteConfirmation(context.DataItem))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>
            <DxGridCommandColumn Caption="Add" Width="5%">
            <CellDisplayTemplate>
            <a class="oi oi-plus" @onclick="@(() => MyGrid.ShowDataItemDeleteConfirmation(context.DataItem))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>

            <DxGridCommandColumn Caption="Agreement" Width="5%">
            <CellDisplayTemplate>
            <a class="oi oi-document" @onclick="@(() => MyGrid.ShowDataItemDeleteConfirmation(context.DataItem))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>

            <DxGridCommandColumn Width="5%">
            <CellDisplayTemplate>
            <a class="oi oi-person" Caption="List" @onclick="@(() => MyGrid.ShowDataItemDeleteConfirmation(context.DataItem))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>
            *@
            </Columns>

            <TotalSummary>
                <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.ReceipeQty)" />


                <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.PackingQty)" />
                <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.Recipebalance)" />

            </TotalSummary>
        </DxGrid>
    </div>
}
<style>
    .wide-combobox {
        width: 100% !important; /* Force full width of parent container */
        min-width: 250px; /* Set a minimum width */
    }

    /* Alternative: If you want to target the specific component */
    #cbFiltering {
        width: 100% !important;
    }

    /* If the above doesn't work, try targeting the DevExpress wrapper */
    .dxbs-combo-box {
        width: 100% !important;
    }
</style>
<div style="overflow-x:auto; width:100%;">

    <DxGrid Data="@GetPackingStock" CssClass="green-header-grid" PageSize="10" ShowSearchBox="true"
            ShowGroupPanel="false" FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
            ColumnResizeMode="GridColumnResizeMode.NextColumn" CustomizeElement="Grid_CustomizeElement" TextWrapEnabled="true">
        <ToolbarTemplate>
          @*   <div class="d-flex align-items-center gap-4 w-100">
                <button type="button" class="btn btn-sm " style="min-width: 80px; color:white; background-color:#5A5E60" @onclick="SaveLot">
                    Save
                </button>

            </div> *@
        </ToolbarTemplate>
        <Columns>


            <DxGridDataColumn FieldName=@nameof(companyModel.DispatcherId) Visible="false" MinWidth="100" Caption="Idno" Width="10%" />


            <DxGridDataColumn FieldName="IsSelected" MinWidth="50" Caption="Add" Width="5%">

                <CellDisplayTemplate Context="cellData">
                    @{
                        var isSelected = (bool)(cellData.Value ?? false);
                        var itemId = ((CompanyModel)cellData.DataItem);
                    }
                    <input type="checkbox"
                           checked="@isSelected"
                           @onchange="(e) => OnCheckboxChanged(e, itemId)" />

                </CellDisplayTemplate>



            </DxGridDataColumn>


            <DxGridDataColumn FieldName="IsReturned" MinWidth="50" Caption="Return" Width="5%">

                <CellDisplayTemplate Context="cellData">
                    @{
                        var isSelected = (bool)(cellData.Value ?? false);
                        var itemId = ((CompanyModel)cellData.DataItem);
                    }
                    <input type="checkbox"
                           checked="@isSelected"
                           @onchange="(e) => OnCheckboxChangedReturn(e, itemId)" />

                </CellDisplayTemplate>



            </DxGridDataColumn>


            <DxGridDataColumn FieldName=@nameof(companyModel.Packingorderid) Visible="false" MinWidth="100" Caption="Lotno" Width="10%" />
            <DxGridDataColumn FieldName=@nameof(companyModel.PalletId) Visible="false" MinWidth="100" Caption="Lotno" Width="10%" />

            <DxGridDataColumn FieldName=@nameof(companyModel.PackingOrderIrn) MinWidth="100" Caption="Packing Order No" Width="10%" />
            <DxGridDataColumn FieldName=@nameof(companyModel.GrowerGroupName) MinWidth="100" Caption="Party" Width="20%" />

            <DxGridDataColumn FieldName=@nameof(companyModel.PalletName) MinWidth="100" Caption="Pallet No" Width="5%" />
            <DxGridDataColumn FieldName="@nameof(companyModel.DispatchQty)" MinWidth="100" Caption="Dispatch Qty" Width="10%" />
            <DxGridDataColumn FieldName="@nameof(companyModel.OutwardQty)" MinWidth="100" Caption="Outward Qty" Width="10%">


                <CellDisplayTemplate Context="cellData">
                    @{
                        var companyModel = (CompanyModel)cellData.DataItem;
                    }
                    <input type="number"
                           value="@companyModel.OutwardQty"
                           @oninput="async (e) => await OnOrderQtyChanged(companyModel, e)"
                           class="form-control input-placeholder-dim input-focus-dark" min=0
                           style="background-color: white; border: 1px solid #ddd; padding: 2px 5px;" />
                </CellDisplayTemplate>


            </DxGridDataColumn>
            <DxGridDataColumn FieldName="@nameof(companyModel.Outwardbalance)" MinWidth="100" Caption="Availabale Qty" Width="10" />
            <DxGridDataColumn FieldName="@nameof(companyModel.OutwardPackingbalance)" Visible="false" MinWidth="100" Caption="Availabale Qty" Width="10" />

            <DxGridDataColumn FieldName="@nameof(companyModel.ReceipeName)" MinWidth="100" Caption="Recipe Name" Width="18%" />


            <DxGridDataColumn FieldName=@nameof(companyModel.ReceipeMarka) MinWidth="100" Caption="Marka" Width="5%" />
            <DxGridDataColumn FieldName="@nameof(companyModel.ReceipeGrade)" MinWidth="100" Caption="Grade" Width="5%" />

            <DxGridDataColumn FieldName="@nameof(companyModel.VarietyId)" MinWidth="100" Caption="Variety" Width="10%" />
            <DxGridDataColumn FieldName="@nameof(companyModel.Vehno)" MinWidth="100" Caption="Vehno" Width="10%" />
          




            <style>
                @@media (max-width: 768px) {
                    .dxbl-grid {
                        width: 768px; /* Force minimum width */
                    }
                }

                .alt-item {
                    background-color: rgba(243, 244, 245, 1) !important;
                }

                    .alt-item > td {
                        --dxbl-grid-bg: rgba(243, 244, 245, 1) !important;
                        background-color: rgba(243, 244, 245, 1) !important;
                    }
            </style>


            @*   <DxGridCommandColumn Caption="" Width="5%">

            <CellDisplayTemplate >
            <a class="oi oi-pencil" @onclick="@(() => MyGrid.StartEditRowAsync(context.VisibleIndex))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>

            <DxGridCommandColumn Caption="Del" Width="5%">
            <CellDisplayTemplate>
            <a class="oi oi-x" @onclick="@(() => MyGrid.ShowDataItemDeleteConfirmation(context.DataItem))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>
            <DxGridCommandColumn Caption="View" Width="5%">
            <CellDisplayTemplate>
            <a class="oi oi-eye" @onclick="@(() => MyGrid.ShowDataItemDeleteConfirmation(context.DataItem))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>
            <DxGridCommandColumn Caption="Add" Width="5%">
            <CellDisplayTemplate>
            <a class="oi oi-plus" @onclick="@(() => MyGrid.ShowDataItemDeleteConfirmation(context.DataItem))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>

            <DxGridCommandColumn Caption="Agreement" Width="5%">
            <CellDisplayTemplate>
            <a class="oi oi-document" @onclick="@(() => MyGrid.ShowDataItemDeleteConfirmation(context.DataItem))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>

            <DxGridCommandColumn Width="5%">
            <CellDisplayTemplate>
            <a class="oi oi-person" Caption="List" @onclick="@(() => MyGrid.ShowDataItemDeleteConfirmation(context.DataItem))" style="text-decoration: none;" href="javascript:void(0);"></a>

            </CellDisplayTemplate>
            </DxGridCommandColumn>
            *@
        </Columns>

        <TotalSummary>
            <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.ReceipeQty)" />


            <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.PackingQty)" />
            <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="@nameof(companyModel.Recipebalance)" />

        </TotalSummary>
    </DxGrid>
    <div class="d-flex justify-content-end">
     @*    <input type="button" id="btnAdd" class="btn btn-success" style="width: 65px;" value="Add" @onclick="SaveLot"> *@
    </div>
</div>



@* @if (showReport)
{
  <div style="overflow-x:auto; width:100%;">
    <DxReportViewer @ref="reportViewer" Report="@Report">
    </DxReportViewer>
</div>
}
 *@

<div class="card p-3 mb-4" style="border: 1px solid lightgray; background-color: #f5f5f5;">

    <div class="row g-3">



        <div class="col-sm-2" style="display: none;">


            <label for="lastName" class="form-label">Cr Issue No</label>
            <DxComboBox Data="@Purchaseorderscrn"
                        ShowDropDownButton=false
                        SearchMode="@SearchMode"
                        SearchFilterCondition="@SearchFilterCondition"
                        SearchTextParseMode="@SearchTextParseMode"
                        @bind-Value="EditModel.PreInwardId"
                        TextFieldName="CrateCrn"
                        ValueFieldName="CrateCrn"
                        placeholder="No"
                        CssClass="cw-480"
                        InputId="cbFiltering"
                        ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />




        </div>





    </div>
</div>















<DxDialogProvider />


<DxPopup @bind-Visible="@isDialogVisible"
         HeaderText="Confirmation"
         ShowCloseButton="true"
         CssClass="validation-dialog">
    <Content>
        Are you sure you want to change the status for Item ID: <strong>@selectedGrowerId</strong>?
        <div>
            <DxButton RenderStyle="ButtonRenderStyle.Primary" Click="@OnConfirmYes">Yes</DxButton>
            <DxButton RenderStyle="ButtonRenderStyle.Secondary" Click="@OnConfirmNo">No</DxButton>
        </div>
    </Content>

</DxPopup>


<DxPopup @bind-Visible="@DeleteDialog"
         HeaderText="Confirmation"
         ShowCloseButton="true"
         CssClass="validation-dialog">
    <Content>
        Are you sure you want to delete the  Item Id: <strong>@selectedGrowerId</strong>?
        <div>
            <DxButton RenderStyle="ButtonRenderStyle.Primary" Click="@OnConfirmYesDelete">Yes</DxButton>
            <DxButton RenderStyle="ButtonRenderStyle.Secondary" Click="@OnConfirmNoDelete">No</DxButton>
        </div>
    </Content>

</DxPopup>


<DxPopup @bind-Visible="@IsVehvisible"
         HeaderText="Add New Vehicle"
         Width="500px">
    <Content>
        <EditForm Model="@EditModel">
            <DataAnnotationsValidator />

            <!-- First Row -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Driver Name</label>
                    <InputText id="remarks"
                               style="font-size: 14px; height: 30px; font-family: 'Source Sans Pro', sans-serif;"
                               class="form-control input-placeholder-dim input-focus-dark"
                               @bind-Value="EditModel.VehDriver"
                               placeholder="Driver Name" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Vehicle Number</label>
                    <InputText id="remarks"
                               style="font-size: 14px; height: 30px; font-family: 'Source Sans Pro', sans-serif;"
                               class="form-control input-placeholder-dim input-focus-dark"
                               @bind-Value="EditModel.Vehno"
                               placeholder="Vehicle No" />
                </div>
            </div>

            <!-- Second Row -->
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Vehicle Type</label>
                    <InputText id="remarks"
                               style="font-size: 14px; height: 30px; font-family: 'Source Sans Pro', sans-serif;"
                               class="form-control input-placeholder-dim input-focus-dark"
                               @bind-Value="EditModel.Vehntype"
                               placeholder="Type" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Contact Number</label>
                    <input type="text"
                           inputmode="numeric"
                           maxlength="10"
                           style="font-size: 14px; font-family: 'Source Sans Pro', sans-serif;"
                           class="form-control input-placeholder-dim input-focus-dark"
                           @bind="FilteredPhoneNumber"
                           @bind:event="oninput"
                           placeholder="Phone No 10 Digits" />

                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between; flex-direction: row-reverse;">
                <div class="d-flex gap-2">
                    <DxButton class="btn btn-primary btn-sm" Text="Save" @onclick="Savevehicle" />
                    <DxButton class="btn btn-primary btn-sm" Text="Cancel" @onclick="HideNewVehicle" />
                </div>
            </div>
        </EditForm>
    </Content>
</DxPopup>





<DxPopup @bind-Visible="@AddSub"
         HeaderText="Add New Grower"
         Width="500px">
    <Content>
        <EditForm Model="@EditModel">
            .
            <DataAnnotationsValidator />

            <!-- First Row -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Grower Group</label>
                    <InputText id="remarks"
                               style="font-size: 14px; height: 30px; font-family: 'Source Sans Pro', sans-serif;"
                               class="form-control input-placeholder-dim input-focus-dark"
                               @bind-Value="EditModel.GrowerGroupName"
                               placeholder="Group Name" readonly />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Grower Name</label>
                    <InputText id="remarks"
                               style="font-size: 14px; height: 30px; font-family: 'Source Sans Pro', sans-serif;"
                               class="form-control input-placeholder-dim input-focus-dark"
                               @bind-Value="EditModel.GrowerName"
                               placeholder="Grower Name" />
                </div>
            </div>

            <!-- Second Row -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Grower Address</label>
                    <InputText id="remarks"
                               style="font-size: 14px; height: 30px; font-family: 'Source Sans Pro', sans-serif;"
                               class="form-control input-placeholder-dim input-focus-dark"
                               @bind-Value="EditModel.GrowerAddress"
                               placeholder="Address" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Contact No</label>
                    <input type="text"
                           inputmode="numeric"
                           maxlength="10"
                           style="font-size: 14px; font-family: 'Source Sans Pro', sans-serif;"
                           class="form-control input-placeholder-dim input-focus-dark"
                           @bind="FilteredPhoneNumbergrower"
                           @bind:event="oninput"
                           placeholder="Phone No 10 Digits" />

                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Crate Issue Qty</label>
                    <InputNumber id="remarks"
                                 style="font-size: 14px; height: 30px; font-family: 'Source Sans Pro', sans-serif;"
                                 class="form-control input-placeholder-dim input-focus-dark"
                                 @bind-Value="EditModel.GrowerCrateissue"
                                 placeholder="Crate Issue Qty" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Crate Limit</label>
                    <InputNumber id="remarks"
                                 style="font-size: 14px; height: 30px; font-family: 'Source Sans Pro', sans-serif;"
                                 class="form-control input-placeholder-dim input-focus-dark"
                                 @bind-Value="EditModel.GrowerCratelimit"
                                 placeholder="Limit Percent" />
                </div>


            </div>



            <div class="modal-footer" style="display: flex; justify-content: space-between; flex-direction: row-reverse;">
                <div class="d-flex gap-2">
                    <DxButton class="btn btn-primary btn-sm" Text="Save" @onclick="SaveNewSub" />
                    <DxButton class="btn btn-primary btn-sm" Text="Close" @onclick="HideNewsub" />
                </div>
            </div>
        </EditForm>
    </Content>
</DxPopup>


<DxPopup @bind-Visible="@Addnewchallan"
         HeaderText="Add New Challan"
         Width="500px">
    <Content>
        <EditForm Model="@EditModel">
            .
            <DataAnnotationsValidator />

            <!-- First Row -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Grower Group</label>
                    <InputText id="remarks"
                               style="font-size: 14px; height: 30px; font-family: 'Source Sans Pro', sans-serif;"
                               class="form-control input-placeholder-dim input-focus-dark"
                               @bind-Value="EditModel.GrowerGroupName"
                               placeholder="Group Name" readonly />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Grower Name</label>
                    <InputText id="remarks"
                               style="font-size: 14px; height: 30px; font-family: 'Source Sans Pro', sans-serif;"
                               class="form-control input-placeholder-dim input-focus-dark"
                               @bind-Value="EditModel.GrowerName"
                               placeholder="Grower Name" readonly />
                </div>
            </div>

            <!-- Second Row -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Challan Name</label>
                    <InputText id="remarks"
                               style="font-size: 14px; height: 30px; font-family: 'Source Sans Pro', sans-serif;"
                               class="form-control input-placeholder-dim input-focus-dark"
                               @bind-Value="EditModel.ChallanName"
                               placeholder="Address" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Contact No</label>
                    <input type="text"
                           inputmode="numeric"
                           maxlength="10"
                           style="font-size: 14px; font-family: 'Source Sans Pro', sans-serif;"
                           class="form-control input-placeholder-dim input-focus-dark"
                           @bind="FilteredPhoneNumberchallan"
                           @bind:event="oninput"
                           placeholder="Phone No 10 Digits" />

                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Adddress</label>
                    <InputText id="remarks"
                               style="font-size: 14px; height: 30px; font-family: 'Source Sans Pro', sans-serif;"
                               class="form-control input-placeholder-dim input-focus-dark"
                               @bind-Value="EditModel.ChallanAddress"
                               placeholder="Crate Issue Qty" />
                </div>
                @* <div class="col-md-6">
                <label class="form-label">Crate Limit</label>
                <InputNumber id="remarks"
                style="font-size: 14px; height: 30px; font-family: 'Source Sans Pro', sans-serif;"
                class="form-control input-placeholder-dim input-focus-dark"
                @bind-Value="EditModel.GrowerCratelimit"
                placeholder="Limit Percent" />
                </div> *@


            </div>



            <div class="modal-footer" style="display: flex; justify-content: space-between; flex-direction: row-reverse;">
                <div class="d-flex gap-2">
                    <DxButton class="btn btn-primary btn-sm" Text="Save" @onclick="SaveNewChallan" />
                    <DxButton class="btn btn-primary btn-sm" Text="Close" @onclick="HideNewchallan" />
                </div>
            </div>
        </EditForm>
    </Content>
</DxPopup>

































<DxPopup @bind-Visible="@PostDialog"
         HeaderText="Confirmation"
         ShowCloseButton="true"
         CssClass="validation-dialog">
    <Content>
        Are you sure you want to Post the  Order Id: <strong>@selectedGrowerId</strong>?
        <div>
            <DxButton RenderStyle="ButtonRenderStyle.Primary" Click="@OnConfirmYesPost">Yes</DxButton>
            <DxButton RenderStyle="ButtonRenderStyle.Secondary" Click="@OnConfirmNoDelete">No</DxButton>
        </div>
    </Content>

</DxPopup>




<DxPopup @bind-Visible="@UnPostDialog"
         HeaderText="Confirmation"
         ShowCloseButton="true"
         CssClass="validation-dialog">
    <Content>
        Are you sure you want to UnPost the  Order Id: <strong>@selectedGrowerId</strong>?
        <div>
            <DxButton RenderStyle="ButtonRenderStyle.Primary" Click="@OnConfirmYesUnpost">Yes</DxButton>
            <DxButton RenderStyle="ButtonRenderStyle.Secondary" Click="@OnConfirmNoDelete">No</DxButton>
        </div>
    </Content>

</DxPopup>











<DxPopup @bind-Visible="@PurDialog"
         HeaderText="Confirmation"
         ShowCloseButton="true"
         CssClass="validation-dialog">
    <Content>
        Are you sure you want to generate new PreInward?
        <div>
            <DxButton RenderStyle="ButtonRenderStyle.Primary" Click="@OnConfirmYesGenerate">Yes</DxButton>
            <DxButton RenderStyle="ButtonRenderStyle.Secondary" Click="@OnConfirmNoGenerate">No</DxButton>
        </div>
    </Content>

</DxPopup>






@if (ShowEmptyFieldDialog)
{
    <DxPopup @bind-Visible="@ShowEmptyFieldDialog"
             HeaderText="Validation Error"
             ShowCloseButton="true"
             CssClass="validation-dialog">
        <Content>
            <p>@DialogMessage</p>
            <DxButton Text="OK" Click="@(() => ShowEmptyFieldDialog = false)" />
        </Content>
    </DxPopup>
}
<style>
    .custom-popup-style {
        background-color: #fdfdfd;
        border: 2px solid #0078d4;
        border-radius: 12px;
        padding: 10px;
        font-family: 'Segoe UI', sans-serif;
    }

        .custom-popup-style .dxbs-popup-header {
            background-color: #0078d4;
            color: white;
            font-weight: bold;
            border-bottom: none;
        }

        .custom-popup-style .dxbs-popup-content {
            font-size: 15px;
            padding: 15px;
        }
</style>
@if (ShowEmptyFieldDialogError)
{
    <DxPopup @bind-Visible="@ShowEmptyFieldDialogError"
             HeaderText="Confirmation Message"
             ShowCloseButton="true"
             CssClass="custom-popup-style">



        <Content>
            <p><strong>Success </strong>@DialogMessage</p>
            <DxButton Text="OK" RenderStyle="ButtonRenderStyle.Primary" Click="@(() => ShowEmptyFieldDialogError = false)" />
        </Content>
    </DxPopup>
}











@code {
    private IEnumerable<CompanyModel> SelectedBankObjects { get; set; } = new List<CompanyModel>();
    private string[] selectedBankIds { get; set; } = Array.Empty<string>();
    private string[] selectedGradeIds { get; set; } = Array.Empty<string>();

    private string[] selectedRecipeIds { get; set; } = Array.Empty<string>();



    bool ShowCheckboxes { get; set; } = true;
    bool ShowSelectAllCheckbox { get; set; } = true;
    public string FilteredPhoneNumber
    {
        get => EditModel.VehContact;
        set => EditModel.VehContact = string.IsNullOrEmpty(value) ? "" : new string(value.Where(char.IsDigit).ToArray());
    }


    public string FilteredPhoneNumbergrower
    {
        get => EditModel.GrowerContact;
        set => EditModel.GrowerContact = string.IsNullOrEmpty(value) ? "" : new string(value.Where(char.IsDigit).ToArray());
    }
    //  private string selectedValue;
    public string FilteredPhoneNumberchallan
    {
        get => EditModel.DemandContact;
        set => EditModel.DemandContact = string.IsNullOrEmpty(value) ? "" : new string(value.Where(char.IsDigit).ToArray());
    }


    string GetDisplayText(DropDownBoxQueryDisplayTextContext context)
    {
        if (SelectedBankObjects?.Any() == true)
        {
            var selectedNames = SelectedBankObjects.Select(b => b.VarietyId);
            return string.Join(", ", selectedNames);
        }
        return "Select banks...";
    }

    void OnSelectionChanged(IEnumerable<CompanyModel> newSelection)
    {
        // 1. Store the selected objects
        SelectedBankObjects = newSelection;

        // 2. Convert to string format for your EditModel
        EditModel.VarietyId = string.Join(",", newSelection.Select(b => b.VarietyId));

        StateHasChanged();
    }


    [Parameter] public int Demandid { get; set; }
    private int selectedGrowerId;

    private bool isChamberComboDisabled = false;
    private bool isComboDisabled = false;
    ListSearchMode SearchMode { get; set; } = ListSearchMode.AutoSearch;
    ListSearchFilterCondition SearchFilterCondition { get; set; } = ListSearchFilterCondition.Contains;
    ListSearchTextParseMode SearchTextParseMode { get; set; } = ListSearchTextParseMode.GroupWordsByAnd;
    List<CompanyModel> GetmasterGroup = new List<CompanyModel>();
    List<CompanyModel> GetgrowerList = new List<CompanyModel>();
    List<CompanyModel> Purchaseorders = new List<CompanyModel>();
    List<CompanyModel> GetallLocation = new List<CompanyModel>();
    List<CompanyModel> GetchamberAnalysis = new List<CompanyModel>();
    List<CompanyModel> GetLots = new List<CompanyModel>();
    List<CompanyModel> polist = new List<CompanyModel>();
    List<CompanyModel> outwardgrowerlist = new List<CompanyModel>();




    List<CompanyModel> Recipelist = new List<CompanyModel>();
    List<CompanyModel> PackingOrderist = new List<CompanyModel>();

    List<CompanyModel> GetAllpellets = new List<CompanyModel>();


    List<CompanyModel> GradeList = new List<CompanyModel>();
    List<CompanyModel> Draftlist = new List<CompanyModel>();

    List<CompanyModel> GetChambers = new List<CompanyModel>();

    List<CompanyModel> GetVehlist = new List<CompanyModel>();
    List<CompanyModel> GetPackingStock = new List<CompanyModel>();
    List<CompanyModel> GetDailyPreinward = new List<CompanyModel>();
    List<CompanyModel> GetDailyPreinwardtemp = new List<CompanyModel>();

    List<CompanyModel> GetDailyCrates = new List<CompanyModel>();
    string AvailGrower = "";
    bool showQty = false;
    bool showReport = false;
    bool TrickCrateAnalysis = false;
    bool ShowBoth = false;
    bool ShowButtonAdd = true;
    bool ShowOtherButtons = false;
    string DemandGroupKey = Guid.NewGuid().ToString();
    string OrderGroupKey = Guid.NewGuid().ToString();
    private System.Timers.Timer dismissTimer;
    bool ShowAddGrid = false;
    string SelectGrower = "";

    private bool IsServiceTypeDisabled = false;
    List<CompanyModel> GetCrateMark = new List<CompanyModel>();
    List<CompanyModel> GetChallanGroup = new List<CompanyModel>();
    List<CompanyModel> GetInsertedQty = new List<CompanyModel>();
    List<CompanyModel> GetPackingStockTemp = new List<CompanyModel>();

    List<CompanyModel> CrateAnalysis = new List<CompanyModel>();
    List<CompanyModel> GetSubGrowerGroup = new List<CompanyModel>();
    private SfAutoComplete<string, CompanyModel> autoCompleteRef;


    // DxReportViewer? reportViewer;
    // XtraReport? Report;
    // private void ShowReport()
    // {



    //     Report = XtraReport.FromFile(Path.Combine(Directory.GetCurrentDirectory(),
    //          @"Reports\XtraReport11.repx"));

    //     showReport = true;
    // }

    private async Task Onoutwardgroup(string value)
    {
        // Update the model
        EditModel.OutwardGrowerGroup = value;

        string selectedPurchase = value;

        if (!string.IsNullOrWhiteSpace(selectedPurchase))

        {





            GetSubGrowerGroup = await EmployeeService.GetSubGrowerByGroup(selectedPurchase);
            AvailGrower = selectedPurchase;
            ///   EditModel.GrowerGroupName = AvailGrower;


        }



        // Also update other parts of your model
        //  await UpdateModelDetails(value);
    }


    private async Task Onoutwardgrower(string value)
    {
        // Update the model
        EditModel.OutwardGrowerName = value;

        string selectedPurchase = value;
        string SelectedSubgrower = AvailGrower;
        if (!string.IsNullOrWhiteSpace(selectedPurchase) && !string.IsNullOrWhiteSpace(SelectedSubgrower))
        {
            EditModel.GrowerName = selectedPurchase;


            GetChallanGroup = await EmployeeService.GetChallanByGroup(selectedPurchase, SelectedSubgrower);




            // Also update other parts of your model
            //  await UpdateModelDetails(value);
        }





    }




    private async Task OnPackingOrderIrnChanged(string value)
    {
        // Update the model
        EditModel.PackingOrderIrn = value;

        // Also update other parts of your model
        await UpdateModelDetails(value);
    }
    private async Task UpdateModelDetails(string packingOrderIrn)
    {
        if (!string.IsNullOrEmpty(packingOrderIrn))
        {
            EditModel = await EmployeeService.GetPackingDetails(packingOrderIrn);

            GetVehlist = await EmployeeService.GetallVeh();

            // Map details to your model
            // EditModel.CompanyName = details.CompanyName;
            // EditModel.Qty = details.Qty;
            // EditModel.UnitId = details.UnitId;
            EditModel.PackingOrderIrn = packingOrderIrn;

            StateHasChanged();
        }
    }
    private void OnCrateCrnChanged(string value)
    {
        EditModel.PreCrateType = value;

        ShowBoth = value == "BOTH";
    }
    private async void OnValueChange(Object args)
    {

        if (!string.IsNullOrEmpty(selectedValue))
        {
            // Store the value before updating EditModel
            var tempValue = selectedValue;

            // Get details from service
            EditModel = await EmployeeService.GetPackingDetails(tempValue);

            // Restore the selected value
            selectedValue = tempValue;
            EditModel.PackingOrderIrn = tempValue;
            StateHasChanged();
        }

    }

    private async Task OnFocus()
    {
        // Show dropdown when user clicks on the field
        if (autoCompleteRef != null)
        {
            await Task.Delay(50); // Small delay
            await autoCompleteRef.ShowPopupAsync();
        }
    }
    private async void OnCheckboxChanged(ChangeEventArgs e, CompanyModel itemid)
    {
        bool isChecked = (bool)(e.Value ?? false);
        itemid.IsSelected = isChecked;

        if (isChecked)
        {

            itemid.OutwardQty = (int)itemid.Outwardbalance;
            // SelectGrower = itemid.GrowerGroupName;
            // AvailGrower = itemid.GrowerGroupName;
            selectedItems.Add(itemid);
            //itemid.OrderQty = 0;// Remove the cast if VerifiedQty is already int
            StateHasChanged();
        }


        if (!isChecked)
        {

            itemid.Outwardbalance = (int)itemid.OutwardPackingbalance;
            selectedItems.Remove(itemid);
            itemid.OutwardQty = 0; // Remove the cast if VerifiedQty is already int
            StateHasChanged();
        }

    }








    private async void OnCheckboxChangedReturn(ChangeEventArgs e, CompanyModel itemid)
    {
        bool isChecked = (bool)(e.Value ?? false);
        itemid.IsReturned = isChecked;

        if (isChecked)
        {

            // itemid.OutwardQty = (int)itemid.Outwardbalance;

            // selectedItems.Add(itemid);

            StateHasChanged();
        }


        if (!isChecked)
        {

            // itemid.Outwardbalance = (int)itemid.OutwardPackingbalance;
            // selectedItems.Remove(itemid);
            // itemid.OutwardQty = 0; // Remove the cast if VerifiedQty is already int
            StateHasChanged();
        }

    }






    private void ValidateItemname()
    {
        if (string.IsNullOrWhiteSpace(EditModel.Itemname))
        {
            // Handle empty item name case
        }
        else if (EditModel.Itemname.Equals("APPLE", StringComparison.OrdinalIgnoreCase))
        {
            EditModel.PreInwardUom = "CRATES";
        }
        else if (EditModel.Itemname.Equals("PETTI", StringComparison.OrdinalIgnoreCase))
        {
            EditModel.PreInwardUom = "PETTI";
        }
    }
    private void OnItemChanged(string Value)
    {
        selectedIrn = Value;
    }


    private void ClearParam()
    {
        EditModel.PackingOrderIrn = null;
        EditModel.PackingOrderStatus = null;
        EditModel.ReceipeLocation = null;

    }
    public class ComboItem
    {
        public string DisplayText { get; set; }  // What appears in the dropdown
        public string ValueType { get; set; }     // "Company", "Both", or "Own"
    }

    private bool selectAll = false; // Change selectcheck to selectAll

    private void OnSelectAllChanged(bool isChecked)
    {
        selectAll = isChecked;
        if (GetDailyPreinward != null)
        {
            foreach (var item in GetDailyPreinward)
            {
                item.IsSelected = isChecked;
                if (isChecked)
                {
                    item.Lotbalance = (int)item.VerfiedQty;
                }
            }
            StateHasChanged();
        }
    }
    private async Task OnOrderQtyChanged(object dataItem, ChangeEventArgs e)
    {
        if (dataItem is CompanyModel companyModel)
        {
            // Store the new order quantity


            // Access the verified quantity
            var verifiedQty = companyModel.OutwardPackingbalance;
            string inputValue = e.Value?.ToString();


            if (string.IsNullOrWhiteSpace(inputValue))
            {


                //  companyModel.OrderQty = 0;
                companyModel.IsSelected = false;

                StateHasChanged();
                return;
            }


            // await JS.InvokeVoidAsync("alert", "YY");

            if (int.TryParse(e.Value?.ToString(), out int newQty))
            {

                //  await JS.InvokeVoidAsync("alert","MM");
                companyModel.OutwardQty = newQty;


                if (newQty < 0)
                {
                    companyModel.OutwardQty = 0;
                    companyModel.IsSelected = false;
                    StateHasChanged();

                }
                else if (newQty == 0)
                {
                    await JS.InvokeVoidAsync("alert", "Invalid Qty");
                    //   companyModel.Lotbalance = (int)companyModel.Alotbal;
                    // companyModel.OrderQty = 0;
                    companyModel.IsSelected = false;
                    return;

                }
                else if (newQty > verifiedQty)
                {
                    await JS.InvokeVoidAsync("alert", "Invalid Qty");
                    companyModel.OutwardQty = 0;
                    companyModel.Outwardbalance = (int)companyModel.OutwardPackingbalance;
                    companyModel.IsSelected = false;
                    StateHasChanged();
                    return;

                }
                else
                {
                    companyModel.IsSelected = true;
                    companyModel.Outwardbalance = (int)(verifiedQty - newQty);
                    StateHasChanged();
                }

                // Refresh UI if needed
                StateHasChanged();
            }
        }
        else
        {
            // Handle parsing error
            // await ShowErrorMessage("Please enter a valid number");
        }
    }

    private async Task HandleEnterKey(CompanyModel EditModel, KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            //   await JS.InvokeVoidAsync("alert", companyModel.TempOrderId);


            EditModel.TempOrderId = companyModel.TempOrderId;

            int selectedId = EditModel.TempOrderId;

            int unit = UserSessionService.UnitId;


            await EmployeeService.UpdateLotOrderQuantity(EditModel);
            GetDailyPreinwardtemp = await EmployeeService.GenerateTempLotReport(EditModel, unit, selectedId);




            StateHasChanged();
            return;










        }
    }


    private bool selectcheck = false;

    private async Task OnOrderTempQtyChanged(object dataItem, ChangeEventArgs e)
    {
        if (dataItem is CompanyModel companyModel)
        {
            // Store the new order quantity


            // Access the verified quantity
            var verifiedQty = companyModel.Alotbal;
            string inputValue = e.Value?.ToString();


            if (string.IsNullOrWhiteSpace(inputValue))
            {
                companyModel.Lotbalance = (int)companyModel.Alotbal;

                //  companyModel.OrderQty = 0;
                companyModel.IsSelected = false;

                StateHasChanged();
                return;
            }


            // await JS.InvokeVoidAsync("alert", "YY");

            if (int.TryParse(e.Value?.ToString(), out int newQty))
            {

                //  await JS.InvokeVoidAsync("alert","MM");
                companyModel.OrderQty = newQty;


                if (newQty < 0)
                {
                    //companyModel.OrderQty = 0;
                    companyModel.Lotbalance = (int)companyModel.Alotbal;
                    companyModel.IsSelected = false;
                    StateHasChanged();
                    // await ShowErrorMessage("Order quantity cannot be negative");
                }
                else if (newQty == 0)
                {
                    await JS.InvokeVoidAsync("alert", "Invalid Qty");
                    companyModel.Lotbalance = (int)companyModel.Alotbal;
                    // companyModel.OrderQty = 0;
                    companyModel.IsSelected = false;
                    return;

                }
                else if (newQty > verifiedQty)
                {
                    await JS.InvokeVoidAsync("alert", "Invalid Qty");
                    companyModel.Lotbalance = (int)companyModel.Alotbal;
                    companyModel.OrderQty = 0;
                    companyModel.IsSelected = false;
                    StateHasChanged();
                    return;

                }
                else
                {
                    companyModel.IsSelected = true;
                    companyModel.Lotbalance = (int)(verifiedQty - newQty);
                    StateHasChanged();
                }

                // Refresh UI if needed
                StateHasChanged();
            }
        }
        else
        {
            // Handle parsing error
            // await ShowErrorMessage("Please enter a valid number");
        }
    }

    private void OnSelectcheckChanged(CompanyModel item, bool isChecked)
    {
        // Deselect all other rows first
        if (isChecked && GetDailyPreinward != null)
        {
            foreach (var row in GetDailyPreinward)
            {
                row.IsSelected = (row == item); // Only select the current item
            }
        }
        else
        {
            item.IsSelected = isChecked;
        }

        // Update Lotbalance if selected
        if (isChecked)
        {
            item.Lotbalance = (int)item.VerfiedQty;
        }

        StateHasChanged();
    }






    private void OnIndividualCheckboxChanged(CompanyModel item, bool isChecked)
    {
        // item.IsSelected = isChecked;
        // if (isChecked)
        // {
        //     item.Lotbalance = item.VerfiedQty;
        // }
        // StateHasChanged();
    }
    private List<ComboItem> CrateType = new List<ComboItem>
    {
        new ComboItem { DisplayText = "COMPANY", ValueType = "COMPANY" },
        new ComboItem { DisplayText = "BOTH", ValueType = "BOTH" },
        new ComboItem { DisplayText = "OWN", ValueType = "OWN" }
    };


    private decimal AvailableBookQty = 0;
    private string selectedIrn = "";

    private decimal AvailableSubGrower = 0;

    private CompanyModel EditModel = new();
    private string DialogMessage { get; set; } = "";
    private bool ShowEmptyFieldDialogError { get; set; }
    private string ChallanGroup { get; set; } = "";
    string GrowerGroupKey = Guid.NewGuid().ToString();
    string GrowerNameKey = Guid.NewGuid().ToString();
    string ChallanKey = Guid.NewGuid().ToString();
    private bool IsVehvisible { get; set; } = false;

    private bool AddSub { get; set; } = false;
    private bool ShowEmptyFieldDialog { get; set; }
    private bool ShowCrateAnalysis { get; set; } = false;
    private bool Addnewchallan { get; set; } = false;
    async Task Savevehicle()

    {

        if (string.IsNullOrWhiteSpace(EditModel.Vehno) || string.IsNullOrWhiteSpace(EditModel.VehDriver))
        {
            DialogMessage = "Please fill in all required fields.";
            ShowEmptyFieldDialog = true;
            return;
        }

        if (string.IsNullOrWhiteSpace(EditModel.VehContact) || string.IsNullOrWhiteSpace(EditModel.VehContact))
        {
            DialogMessage = "Mobile no required";
            ShowEmptyFieldDialog = true;
            return;
        }
        if (string.IsNullOrWhiteSpace(EditModel.Vehntype) || string.IsNullOrWhiteSpace(EditModel.Vehntype))
        {
            EditModel.Vehntype = "";
        }
        if (string.IsNullOrWhiteSpace(EditModel.VehDriver) || string.IsNullOrWhiteSpace(EditModel.VehDriver))
        {
            DialogMessage = "Driver Name required";
            ShowEmptyFieldDialog = true;
            return;
        }
        await EmployeeService.Addveh(EditModel);
        ShowEmptyFieldDialogError = true;
        DialogMessage = "Vehicle saved successfully.";
        IsVehvisible = false;
        GetVehlist = await EmployeeService.GetallVeh();
        EditModel.Vehno = String.Empty;
        EditModel.Vehntype = String.Empty;
        EditModel.VehContact = String.Empty;
        EditModel.VehDriver = String.Empty;
    }


    private async Task HandleFocusOrder(FocusEventArgs e)
    {
        if (!isDropDownVisible)
        {
            isDropDownVisible = true;
        }

        if (!dataLoaded)
        {
            await Task.Delay(500); // Simulate async delay
            int unit = UserSessionService.UnitId;
            GetbyOrderList = await EmployeeService.GetAllOrderby(unit);

        }
    }



    private string selectedgroup;
    private string SelectedGrower;
    private async Task OnDropDownVisibleChangedOrder(bool isVisible)
    {
        if (isVisible)
        {
            await Task.Delay(500); // Simulate async data fetch

            int unit = UserSessionService.UnitId;
            GetbyOrderList = await EmployeeService.GetAllOrderby(unit);
            StateHasChanged();
        }
    }


    private void Addnewchallanproc()
    {
        if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            DialogMessage = "Please Select  valid Grower Group Name";
            ShowEmptyFieldDialog = true;
            return;

        }
        selectedgroup = EditModel.GrowerGroupName;
        if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
        {
            DialogMessage = "Please Select  valid Grower  Name";
            ShowEmptyFieldDialog = true;
            return;

        }
        SelectedGrower = EditModel.GrowerName;



        Addnewchallan = true;


    }


    private void AddNewSub()
    {
        if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            DialogMessage = "Please Select  valid Grower Group Name";
            ShowEmptyFieldDialog = true;
            return;

        }
        selectedgroup = EditModel.GrowerGroupName;




        AddSub = true;


    }



    private async void SaveNewSub()



    {

        EditModel.GrowerGroupName = selectedgroup;



        if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
        {
            DialogMessage = "Please Select  valid Grower  Name";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.GrowerAddress))
        {
            DialogMessage = "Please Select  valid Grower Address";
            ShowEmptyFieldDialog = true;
            return;

        }


        if (string.IsNullOrWhiteSpace(EditModel.GrowerContact))
        {
            DialogMessage = "Please Select  valid Grower Contact";
            ShowEmptyFieldDialog = true;
            return;

        }


        if (EditModel.GrowerCrateissue < 0)
        {

            DialogMessage = "Valid Crate issue qty is Required";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (EditModel.GrowerCratelimit < 0)
        {

            DialogMessage = "Valid Crate issue Limit percent is Required";
            ShowEmptyFieldDialog = true;
            return;

        }
        var result = await EmployeeService.AddGrowerSubdirect(EditModel);




        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {


            AddSub = false;

            EditModel.GrowerName = string.Empty;
            EditModel.GrowerAddress = string.Empty;
            EditModel.GrowerContact = string.Empty;
            EditModel.GrowerCrateissue = 0;
            EditModel.GrowerCratelimit = 0;
            StateHasChanged();


            return;
        }


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to Update grower group.";
            ShowEmptyFieldDialog = true;

            return;
        }









    }

    // private void AddNewSub()
    // {
    //     if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
    //     {
    //         DialogMessage = "Please Select  valid Grower Group Name";
    //         ShowEmptyFieldDialog = true;
    //         return;

    //     }
    //     selectedgroup = EditModel.GrowerGroupName;




    //     AddSub = true;


    // }



    private async void SaveNewChallan()



    {

        EditModel.GrowerGroupName = selectedgroup;



        if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
        {
            DialogMessage = "Please Select  valid Grower  Name";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.ChallanAddress))
        {
            DialogMessage = "Please Select  valid Grower Address";
            ShowEmptyFieldDialog = true;
            return;

        }


        if (string.IsNullOrWhiteSpace(EditModel.ChallanPhone1))
        {
            DialogMessage = "Please Select  valid Grower Contact";
            ShowEmptyFieldDialog = true;
            return;

        }


        var result = await EmployeeService.AddChallandirect(EditModel);




        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {


            AddSub = false;

            EditModel.GrowerName = string.Empty;
            EditModel.GrowerGroupName = string.Empty;
            EditModel.ChallanName = string.Empty;
            EditModel.ChallanPhone1 = string.Empty;
            EditModel.ChallanAddress = string.Empty;
            StateHasChanged();


            return;
        }


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to Update grower group.";
            ShowEmptyFieldDialog = true;

            return;
        }









    }

    private void AddNewVehicle()
    {
        // selectedGrowerId = growerId;
        IsVehvisible = true;


    }



    private void HideNewchallan()
    {
        // selectedGrowerId = growerId;
        Addnewchallan = true;


    }
    private void HideNewVehicle()
    {
        // selectedGrowerId = growerId;
        IsVehvisible = false;


    }


    private void HideNewsub()
    {
        // selectedGrowerId = growerId;
        AddSub = false;


    }
    private async void DeleteGrower(int Trid)
    {
        int SelectedTrid = Trid;
        int selectedId = EditModel.TempOutwardId;

        var result = await EmployeeService.DeleteTempOutward(Trid, selectedId);
        var Unitid = await ProtectedLocalStore.GetAsync<string>("Unitidno");


        int unit = Convert.ToInt32(Unitid.Value);

        int orderid = EditModel.Packingorderid;
        GetPackingStockTemp = await EmployeeService.GenerateOutwardReporttemp(selectedId, unit, orderid);


        GetPackingStock = await EmployeeService.GenerateOutwardwithtemp(selectedId, unit, orderid);






        if (GetPackingStockTemp == null || !GetPackingStockTemp.Any())

        {
            ShowAddGrid = false;

        }
        StateHasChanged();
        return;



    }

    private async void Fetchdata()
    {
        if (EditModel.TempOutwardId != 0)
        {
            int selectedId = EditModel.TempOutwardId;

            var Unitid = await ProtectedLocalStore.GetAsync<string>("Unitidno");


            int unit = Convert.ToInt32(Unitid.Value);

            int orderid = EditModel.Packingorderid;
            GetPackingStockTemp = await EmployeeService.GenerateOutwardReporttemp(selectedId, unit, orderid);


            GetPackingStock = await EmployeeService.GenerateOutwardwithtemp(selectedId, unit, orderid);






            if (GetPackingStockTemp == null || !GetPackingStockTemp.Any())

            {
                ShowAddGrid = false;

            }
            StateHasChanged();
            return;
        }


    }

    private void ViewGrower(int growerId)
    {
        companyModel.Growerid = growerId;


        NavigationManager.NavigateTo($"/ViewGrower/{growerId}");

    }
    private async Task OnCountryChanged(string? newCountryId)
    {
        string selectedPurchase = "";
        selectedPurchase = newCountryId;




        EditModel.PurchGrp = selectedPurchase;
        GetItemGroup = await EmployeeService.GetItemNameByGroup(selectedPurchase);
        GetVehlist = await EmployeeService.GetallVeh();


    }
    private async Task ClearGrowerGroupSelection()
    {
        EditModel.GrowerGroupName = null;
        AvailGrower = null;
        GetSubGrowerGroup.Clear();
        EditModel.GrowerName = string.Empty;
        EditModel.ChallanName = string.Empty;

        int unit = UserSessionService.UnitId;
        GetChambers = await EmployeeService.GetallChamberslist(unit);

        StateHasChanged();
    }
    private async Task OnChamberGroupChanged(string? newCountryId)
    {
        string selectedIrn = "";
        selectedIrn = newCountryId;
        int unit = UserSessionService.UnitId;

        if (string.IsNullOrEmpty(newCountryId))
        {
            await ClearChamberGroupSelection();
            return;
        }
        EditModel.ChamberName = selectedIrn;

        if (!string.IsNullOrWhiteSpace(selectedIrn))
        {


            banks = await EmployeeService.GetallchamberQuality(selectedIrn);
            GetgrowerList = await EmployeeService.GetallchamberGrowerlist(selectedIrn);



        }
        else
        {
            GetChambers = await EmployeeService.GetallChamberslist(unit);
            banks = await EmployeeService.GetallQuality();
            GetgrowerList = await EmployeeService.GetallGrowerlist();




        }


        // GetCrateAnalysis = await EmployeeService.CheckCratesAgreement(selectedPurchase);




        // AvailableBookQty = GetCrateAnalysis.FirstOrDefault()?.PrebookQty ?? 0;



        // showQty = true;
    }

    private async Task OnOrderGroupChanged(string? newCountryId)
    {
        await JS.InvokeVoidAsync("alert", newCountryId);

    }


    private async Task OnGrowerGroupChanged(string? newCountryId)
    {
        string selectedPurchase = "";
        selectedPurchase = newCountryId;
        GetSubGrowerGroup.Clear();

        if (string.IsNullOrEmpty(newCountryId))
        {
            await ClearGrowerGroupSelection();
            return;
        }
        EditModel.GrowerName = String.Empty;
        EditModel.ChallanName = String.Empty;
        var resultnew = await EmployeeService.DeleteAllTrid(EditModel.TempGateInId);
        GetDailyPreinwardtemp = await EmployeeService.GetDailyPreinwardProctemp(EditModel.TempGateInId);

        StateHasChanged();



        if (!string.IsNullOrWhiteSpace(selectedPurchase))

        {





            int unit = UserSessionService.UnitId;

            GetSubGrowerGroup = await EmployeeService.GetSubGrowerByGroup(selectedPurchase);
            AvailGrower = selectedPurchase;
            EditModel.GrowerGroupName = AvailGrower;

            if (!string.IsNullOrWhiteSpace(AvailGrower))
            {
                GetChambers = await EmployeeService.GetallChambersParty(unit, AvailGrower);
                banks = await EmployeeService.GetallpartyQuality(unit, AvailGrower);

            }
            else
            {
                GetChambers = await EmployeeService.GetallChamberslist(unit);
                banks = await EmployeeService.GetallQuality();
            }


            // GetCrateAnalysis = await EmployeeService.CheckCratesAgreement(selectedPurchase);




            // AvailableBookQty = GetCrateAnalysis.FirstOrDefault()?.PrebookQty ?? 0;



            // showQty = true;
        }
    }


    private int? GetNumberAfterSecondSlash(string input)
    {
        if (string.IsNullOrWhiteSpace(input))
            return null;

        // Split the string by slashes
        var parts = input.Split('/');
        if (parts.Length < 3)
            return null;

        // Get the part after the second slash and remove leading zeros
        var numberPart = parts[2].TrimStart('0');

        if (int.TryParse(numberPart, out int result))
            return result;

        return null;
    }

    private async Task OnSubgrowerChanged(string? newCountryId)
    {
        string selectedPurchase = newCountryId;
        GetChallanGroup.Clear();
        EditModel.ChallanName = String.Empty;
        StateHasChanged();

        string SelectedSubgrower = AvailGrower;
        // await JS.InvokeVoidAsync("alert",selectedPurchase);
        //          await JS.InvokeVoidAsync("alert",AvailGrower);

        if (!string.IsNullOrWhiteSpace(selectedPurchase) && !string.IsNullOrWhiteSpace(SelectedSubgrower))
        {
            EditModel.GrowerName = selectedPurchase;


            GetChallanGroup = await EmployeeService.GetChallanByGroup(selectedPurchase, SelectedSubgrower);

            GetCrateAnalysis = await EmployeeService.CheckCratesPartysub(selectedPurchase, SelectedSubgrower);
            selectedSubgrower = selectedPurchase;
            AvailableSubGrower = companyModel?.CrateAvailable ?? 0;
            ShowCrateAnalysis = true;
        }
        else
        {
            // Optionally reset related values
            ShowCrateAnalysis = false;
            AvailableSubGrower = 0;
        }

    }

    protected async Task GeneratePreview()
    {
        await JS.InvokeVoidAsync("window.open", "/Thermal", "_blank");

    }



    protected async Task GeneratePreviewbyid(int growerId)
    {


        // if  (EditModel.CrissueId <= 0)
        // {
        //     DialogMessage = "Please enter a valid idno greater than 0.";
        //     ShowEmptyFieldDialog = true;
        //     return;
        // }
        selectedGrowerId = growerId;
        //  selectedGrowerId = EditModel.CrissueId;

        await EmployeeService.GenerateCratePreview(selectedGrowerId, EditModel);

        // Report = XtraReport.FromFile(Path.Combine(Directory.GetCurrentDirectory(),
        //   @"Reports\CrateSlip.repx"));



        // showReport = true;

    }

    void OnKhataMarkChanged(string newValue)
    {
        // Check if the new value is not already in the data source
        EditModel.OrderBy = newValue;

        // Check if the value exists already
        if (!string.IsNullOrWhiteSpace(newValue) &&
            !GetbyOrderList.Any(x => x.OrderBy.Equals(newValue, StringComparison.OrdinalIgnoreCase)))
        {
            GetbyOrderList.Add(new CompanyModel { OrderBy = newValue });
        }
    }




    private void AddGrowerAgreement(int growerId)
    {
        companyModel.Growerid = growerId;


        NavigationManager.NavigateTo($"/EditGrowerAgreement/{growerId}");

    }






    private void ViewSubGrower(int growerId)
    {
        companyModel.Growerid = growerId;


        NavigationManager.NavigateTo($"/ViewSubGrower/{growerId}");

    }


    void OnCrissueMarkChanged(string newValue)
    {
        // Check if the new value is not already in the data source
        EditModel.CrissueMark = newValue;

        // Check if the value exists already
        if (!string.IsNullOrWhiteSpace(newValue) &&
            !GetCrateMark.Any(x => x.CrissueMark.Equals(newValue, StringComparison.OrdinalIgnoreCase)))
        {
            GetCrateMark.Add(new CompanyModel { CrissueMark = newValue });
        }
    }


    private void AddGrower(int growerId)
    {
        companyModel.Growerid = growerId;


        NavigationManager.NavigateTo($"/AddGrower");

    }


    private async Task EditItem(object dataItem)
    {
        if (dataItem is CompanyModel companyModel)
        {
            // EditModel.TempGateInId = companyModel.TempGateInId;
            selectedGrowerId = companyModel.Trid;
            int selectedId = EditModel.TempGateInId;

            companyModel = await EmployeeService.GetTridDet(selectedGrowerId, selectedId);


            GetGstList = await EmployeeService.GetServicesfromAgreement(AvailGrower);
            EditModel.ServiceId = GetGstList[0].Atype;
            EditModel.PreInwardKhata = companyModel.PreInwardKhata;
            EditModel.PreCrateType = companyModel.PreCrateType;
            EditModel.PreInwardQty = companyModel.PreInwardQty;
            EditModel.VarietyId = companyModel.VarietyId;
            EditModel.Trid = companyModel.Trid;

            actualidqty = EditModel.PreInwardQty ?? 0;
            if (EditModel.PreCrateType == "BOTH")
            {
                ShowBoth = true;
            }
            ShowOtherButtons = true;
            ShowButtonAdd = false;

            StateHasChanged();









        }
    }

    // private async void EditGrower(int growerId)
    // {
    //     // selectedGrowerId=companyModel.Mid ;

    //     // companyModel = await EmployeeService.GetMasterName(companyModel.Mid);



    // }
    protected async Task OnConfirmYes()
    {


        companyModel.Itemid = selectedGrowerId;
        await EmployeeService.UpdateItemStatus(selectedGrowerId, companyModel);


        banks = await EmployeeService.GetallItemGroup();


        StateHasChanged();
        isDialogVisible = false;

    }

    protected async Task OnConfirmYesPost()
    {
        if (EditModel.PurchaseOrderId <= 0)
        {
            DialogMessage = "Please enter a valid Order No";
            ShowEmptyFieldDialog = true;
            return;
        }
        selectedGrowerId = EditModel.PurchaseOrderId;


        selectedItemid = EditModel.PurchaseOrderItemId;

        //  await JS.InvokeVoidAsync("alert", selectedGrowerId);
        // await JS.InvokeVoidAsync("alert", selectedItemid);

        var result = await EmployeeService.PostPurchaseOrder(EditModel);
        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {
            GetOrderDetails = await EmployeeService.GetPurchaseOrder(selectedGrowerId);

            DialogMessage = result.RetMessage;
            ShowEmptyFieldDialogError = true;


            StateHasChanged();
            PostDialog = false; // Close the delete confirmation dialog
            return;
        }



        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to delete Item group.";
            ShowEmptyFieldDialog = true;
            PostDialog = false;
            return;
        }

















        StateHasChanged();
        isDialogVisible = false;


    }
    protected async Task OnConfirmYesUnpost()
    {
        if (EditModel.PurchaseOrderId <= 0)
        {
            DialogMessage = "Please enter a valid Order No";
            ShowEmptyFieldDialog = true;
            return;
        }
        selectedGrowerId = EditModel.PurchaseOrderId;


        selectedItemid = EditModel.PurchaseOrderItemId;

        //  await JS.InvokeVoidAsync("alert", selectedGrowerId);
        // await JS.InvokeVoidAsync("alert", selectedItemid);

        var result = await EmployeeService.UnPostPurchaseOrder(EditModel);
        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {
            GetOrderDetails = await EmployeeService.GetPurchaseOrder(selectedGrowerId);

            DialogMessage = result.RetMessage;
            ShowEmptyFieldDialogError = true;


            StateHasChanged();
            UnPostDialog = false; // Close the delete confirmation dialog
            return;
        }



        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to Unpost.";
            ShowEmptyFieldDialog = true;
            UnPostDialog = false;
            return;
        }

















        StateHasChanged();
        isDialogVisible = false;
    }
    private string selectedValue = "Company";

    // Flag that will be true ONLY when "Both" is selected
    private bool isBothSelected = false;

    // private void OnCrValueChanged(string newValue)
    // {
    //     selectedValue = newValue;
    //     isBothSelected = (newValue == "Both");
    // }






    protected async Task OnConfirmYesDelete()
    {
        // if (EditModel.CrissueId <= 0)
        // {
        //     DialogMessage = "Please enter a valid Id No";
        //     ShowEmptyFieldDialog = true;
        //     return;
        // }




        // await JS.InvokeVoidAsync("alert", selectedGrowerId);
        // await JS.InvokeVoidAsync("alert", selectedItemid);

        var result = await EmployeeService.DeleteCrateIssue(selectedGrowerId, EditModel);
        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {

            GetDailyCrates = await EmployeeService.GetDailyCratesProc();

            DialogMessage = result.RetMessage;
            ShowEmptyFieldDialogError = true;


            StateHasChanged();
            DeleteDialog = false; // Close the delete confirmation dialog
            return;
        }



        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to delete Item group.";
            ShowEmptyFieldDialog = true;
            DeleteDialog = false;
            return;
        }

















        StateHasChanged();
        isDialogVisible = false;

    }

    protected async Task OnConfirmYesGenerate()
    {



        var result = await EmployeeService.GeneratePreinward(EditModel);
        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {
            companyModel = await EmployeeService.GetPreinwardNo();

            EditModel.TempGateInIrn = companyModel.TempGateInIrn;


            EditModel.TempGateInId = companyModel.TempGateInId;
            PurDialog = false;
            // DialogMessage = result.RetMessage;
            // ShowEmptyFieldDialogError = true;
            // /// await Task.Delay(1000);
            //  ShowEmptyFieldDialogError = false;

            //    StateHasChanged();
            // Close the delete confirmation dialog
            return;
        }



        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to Create Purchase Order.";
            ShowEmptyFieldDialog = true;
            PurDialog = false;
            return;
        }

















        StateHasChanged();
        isDialogVisible = false;

    }














    private void OnConfirmNoDelete()
    {
        DeleteDialog = false;
    }






    private void ViewSubList(int growerId)
    {
        companyModel.Growerid = growerId;


        NavigationManager.NavigateTo($"/ViewSubGrower/{growerId}");

    }
    private async Task GoBack()
    {
        await JS.InvokeVoidAsync("history.back");
    }
    private void OnConfirmNoGenerate()
    {
        isDialogVisible = false;
    }


    private void OnConfirmNo()
    {
        isDialogVisible = false;
    }

    string GetRowCssClass(object dataItem, int visibleIndex)
    {
        return visibleIndex % 2 == 0 ? "even-row" : "odd-row";
    }

    private bool DeleteDialog = false;
    private bool PurDialog = false;
    private bool UnPostDialog = false;
    private bool PostDialog = false;
    private bool isDialogVisible = false;
    // private int selectedGrowerId;
    private int selectedItemid;
    private string selectetGrowerGroup = null;
    private string selectedSubgrower = null;
    private decimal actualidqty = 0;
    private string Growerselect = null;
    private string selectedPurchaseGroup = null;
    private void ShowConfirmDialog(int GrowerId)
    {
        selectedGrowerId = GrowerId;
        isDialogVisible = true;


    }
    private void GoToAddGrowerPage()
    {
        NavigationManager.NavigateTo("/AddGrower");
    }






    void ChangeSearchMode(string key)
    {
        // CurrentSearchTextParseModeDisplayText = key;
        // CurrentSearchTextParseMode = SearchTextParseModes[key];
    }

    public void ShowDetails(int employeeId)
    {

    }
    public void ShowDetails1(string ename)
    {

    }
    public void ShowDetails2(string dept)
    {

    }
    // private string activeBreakpoint { get; set; }

    // // private List<Order> orders { get; set; }

    // private bool enableAdaptiveUIMode { get; set; }
    // private RowDirection renderingMode { get; set; }
    CompanyModel companyModel = new CompanyModel();
    IGrid MyGrid { get; set; }
    List<CompanyModel> Growers = new List<CompanyModel>();
    private HashSet<CompanyModel> selectedItems = new HashSet<CompanyModel>();
    private bool IsEmpty => selectedItems.Count == 0;
    List<CompanyModel> banks = new List<CompanyModel>();
    List<CompanyModel> GetGstList = new List<CompanyModel>();
    List<CompanyModel> GetUomList = new List<CompanyModel>();
    List<CompanyModel> GetItemGroup = new List<CompanyModel>();
    List<CompanyModel> GetOrderDetails = new List<CompanyModel>();
    List<CompanyModel> GetCrateAnalysis = new List<CompanyModel>();
    List<CompanyModel> GetMaxCrateId = new List<CompanyModel>();
    List<CompanyModel> GetKhata = new List<CompanyModel>();


    List<CompanyModel> GetbyOrderList = new List<CompanyModel>();
    List<CompanyModel> Purchaseorderscrn = new List<CompanyModel>();
    private async Task OnDropDownVisibleChanged(bool isVisible)
    {
        if (isVisible)
        {
            await Task.Delay(500); // Simulate async data fetch



            if (string.IsNullOrEmpty(EditModel.ChamberName))
            {
                GetgrowerList = await EmployeeService.GetallGrowerlist();
            }
            else
            {
                var selectedIrn = EditModel.ChamberName;
                GetgrowerList = await EmployeeService.GetallchamberGrowerlist(selectedIrn);
            }

            StateHasChanged(); // Force re-render
        }




    }



    private async Task OnDropDownLotsVisibleChanged(bool isVisible)
    {
        if (isVisible)
        {
            await Task.Delay(500); // Simulate async data fetch
            int unit = UserSessionService.UnitId;

            GetLots = await EmployeeService.GetLots(unit);
            StateHasChanged(); // Force re-render
        }
    }



    private async Task OnSubDropDownChanged(bool isVisible)
    {
        // Exit if dropdown is closing or EditModel is null
        if (!isVisible || EditModel == null)
            return;

        // Early exit if GrowerGroupName is null/empty (before any other logic)
        if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            return;
        }

        // Debug alert (remove in production)
        // await JS.InvokeVoidAsync("alert", EditModel.GrowerGroupName);

        string selectedPurchase = EditModel.GrowerGroupName.Trim();
        AvailGrower = selectedPurchase;

        await Task.Delay(500); // Simulate async data fetch

        GetSubGrowerGroup = await EmployeeService.GetSubGrowerByGroup(selectedPurchase);
        AvailGrower = selectedPurchase;

        StateHasChanged();
    }

    private async Task OnChallanDropDownChanged(bool isVisible)
    {
        // Early exit if dropdown is closing or required data is missing
        if (!isVisible ||
            EditModel == null ||
            string.IsNullOrWhiteSpace(EditModel.GrowerName) ||
            string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            return;
        }

        try
        {
            // Trim inputs to avoid whitespace issues
            var growerName = EditModel.GrowerName.Trim();
            var growerGroup = EditModel.GrowerGroupName.Trim();

            // Optional: Show loading indicator
            // isLoading = true;
            // StateHasChanged();

            await Task.Delay(500); // Remove in production (only for simulation)

            GetChallanGroup = await EmployeeService.GetChallanByGroup(growerName, growerGroup);
        }
        catch (Exception ex)
        {
            // Handle errors (log, show user message, etc.)
            Console.WriteLine($"Error loading challan data: {ex.Message}");

            // Optional: Reset dropdown on error
            // isDropDownVisible = false;
        }
        finally
        {
            // Optional: Hide loading indicator
            // isLoading = false;
            StateHasChanged(); // Update UI
        }
    }



    private async Task OnVehDropDownChanged(bool isVisible)
    {
        if (isVisible)
        {
            await Task.Delay(500); // Simulate async data fetch

            GetVehlist = await EmployeeService.GetallVeh();
            StateHasChanged(); // Force re-render
        }
    }


    private async Task HandleFocuslots(FocusEventArgs e)
    {
        if (!isDropDownVisible)
        {
            isDropDownVisible = true;
        }

        if (!dataLoaded)
        {
            await Task.Delay(500); // Simulate async delay
            int unit = UserSessionService.UnitId;

            GetLots = await EmployeeService.GetLots(unit);
        }
    }

    private async Task HandleFocus(FocusEventArgs e)
    {
        if (!isDropDownVisible)
        {
            isDropDownVisible = true;
        }

        if (!dataLoaded)
        {
            if (string.IsNullOrEmpty(EditModel.ChamberName))
            {
                GetgrowerList = await EmployeeService.GetallGrowerlist();
            }
            else
            {
                var selectedIrn = EditModel.ChamberName;
                GetgrowerList = await EmployeeService.GetallchamberGrowerlist(selectedIrn);
            }

            StateHasChanged(); // Force re-render
        }


    }

    private async Task HandleFocusVeh(FocusEventArgs e)
    {
        if (!isDropDownVisible)
        {
            isDropDownVisible = true;
        }

        if (!dataLoaded)
        {
            await Task.Delay(500); // Simulate async delay
            GetVehlist = await EmployeeService.GetallVeh();
        }
    }


    private async Task HandleFocusSub(FocusEventArgs e)
    {
        // Early exit if EditModel or GrowerGroupName is invalid
        if (EditModel == null || string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            return;
        }

        // Only proceed if dropdown isn't already visible
        if (!isDropDownVisible)
        {
            isDropDownVisible = true;
        }

        // Load data only if not already loaded
        if (!dataLoaded)
        {
            try
            {
                await Task.Delay(500); // Simulate async delay
                GetSubGrowerGroup = await EmployeeService.GetSubGrowerByGroup(EditModel.GrowerGroupName.Trim());
                dataLoaded = true; // Remember to set this flag after successful load
            }
            catch (Exception ex)
            {
                // Handle errors (log, show message, etc.)
                Console.WriteLine($"Error loading sub-grower groups: {ex.Message}");
            }
        }
    }



    private async Task HandleFocusChallan(FocusEventArgs e)
    {
        // Early exit if EditModel or required fields are null/empty
        if (EditModel == null ||
            string.IsNullOrWhiteSpace(EditModel.GrowerName) ||
            string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            return;
        }

        // Only open dropdown if not already visible
        if (!isDropDownVisible)
        {
            isDropDownVisible = true;
        }

        // Load data only if not already loaded
        if (!dataLoaded)
        {
            try
            {
                await Task.Delay(500); // Simulate async delay (optional)

                // Trim inputs to avoid whitespace issues
                string growerName = EditModel.GrowerName.Trim();
                string growerGroup = EditModel.GrowerGroupName.Trim();

                GetChallanGroup = await EmployeeService.GetChallanByGroup(growerName, growerGroup);
                dataLoaded = true; // Mark data as loaded to prevent redundant calls
            }
            catch (Exception ex)
            {
                // Log error (or show user feedback)
                Console.WriteLine($"Error loading challan data: {ex.Message}");

                // Optional: Reset dropdown state on failure
                isDropDownVisible = false;
            }
        }
    }
    private bool isDropDownVisible = false;
    private bool dataLoaded = false;

    protected override async Task OnInitializedAsync()
    {


        isComboDisabled = true;


        EditModel.TempOutwardId = 0;







        ShowButtonAdd = true;
        ShowOtherButtons = false;
        var userResult13 = await ProtectedLocalStore.GetAsync<string>("UserGroup");
        string GlobalUserGroup = userResult13.Success ? userResult13.Value : null;
        var Avuser = await ProtectedLocalStore.GetAsync<string>("Username");
        string Packuser = Avuser.Success ? Avuser.Value : null;



        companyModel = await EmployeeService.GetPreinwardPriv(GlobalUserGroup);
        // await JS.InvokeVoidAsync("alert", companyModel.PreEdit);

        //     await JS.InvokeVoidAsync("alert", companyModel.PreDel);

        var Unitid = await ProtectedLocalStore.GetAsync<string>("Unitidno");


        int unit = Convert.ToInt32(Unitid.Value);
        GetallLocation = await EmployeeService.GetTemplocations();

        string CuserName = GlobalUserGroup;




        PackingOrderist = await EmployeeService.GetallStockPacking(unit,Packuser);
        outwardgrowerlist= await EmployeeService.GetallGrowerlist();

        EditModel = await EmployeeService.GetOutwardbyAsync(Demandid);
        int tempid = EditModel.TempOutwardId;
        int orderid = EditModel.Packingorderid;
        int outwardid = EditModel.Outwardid;


        GetVehlist = await EmployeeService.GetallVeh();

        GetPackingStockTemp = await EmployeeService.GenerateOutwardwithtempEdit(tempid, unit, orderid);

        ShowAddGrid = true;




    }
    // SfGrid<CompanyModel> Grid;

    // FilterSettings filterSettings = new FilterSettings { Type = FilterType.Excel };



    private async Task EditHandler(Employee employee)
    {
        // await Grid.SelectRowAsync(companyModel.chid);
        // await Grid.StartEditAsync();
    }


    private async Task DeleteHandler(Employee employee)
    {

    }

    protected async Task ViewOrder()
    {
        if (EditModel.PurchaseOrderId <= 0)
        {
            DialogMessage = "Please enter  valid Order No";
            ShowEmptyFieldDialog = true;
            return;
        }
        selectedGrowerId = EditModel.PurchaseOrderId;
        GetOrderDetails = await EmployeeService.GetPurchaseOrder(selectedGrowerId);

        companyModel = await EmployeeService.GetOrderhead(selectedGrowerId);
        EditModel.PurchaseOrderDated = companyModel.PurchaseOrderDated;
        EditModel.AccountName = companyModel.AccountName;
        EditModel.PurchaseOrderBillto = companyModel.PurchaseOrderBillto;
        EditModel.PurchaseOrderDel = companyModel.PurchaseOrderDel;
        EditModel.PurchaseOrderRemarks = companyModel.PurchaseOrderRemarks;






        StateHasChanged();
        return;



    }

    protected async Task ToggleUnit()
    {
        ShowOtherButtons = false;
        ShowButtonAdd = true;
    }


    protected async Task SaveItem()
    {

        if (string.IsNullOrWhiteSpace(EditModel.PurchGrp))
        {
            DialogMessage = "Please Select  valid Purchase Group";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.PurchaseItemName))
        {
            DialogMessage = "Please Select  valid Item Group";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (string.IsNullOrWhiteSpace(EditModel.PurchaseOrderItemDescrip))
        {
            EditModel.PurchaseOrderItemDescrip = "";


        }


        if (!EditModel.PurchaseOrderqty.HasValue || EditModel.PurchaseOrderqty <= 0)
        {
            DialogMessage = "Please enter a valid quantity greater than 0.";
            ShowEmptyFieldDialog = true;
            return;
        }
        if (EditModel.PurchaseOrderId <= 0)
        {
            DialogMessage = "Please enter a valid Order No";
            ShowEmptyFieldDialog = true;
            return;
        }

        var result = await EmployeeService.AddPurchaseOrderItem(EditModel);
        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {
            DialogMessage = result.RetMessage;
            ShowEmptyFieldDialogError = true;


            companyModel = new CompanyModel();
            selectedGrowerId = EditModel.PurchaseOrderId;
            GetOrderDetails = await EmployeeService.GetPurchaseOrder(selectedGrowerId);

            StateHasChanged();
            return;
        }


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to add order item.";
            ShowEmptyFieldDialog = true;

            return;
        }




    }

    protected async Task UpdateTrid()
    {
        EditModel.GrowerGroupName = AvailGrower;
        EditModel.Trid = selectedGrowerId;
        if (string.IsNullOrWhiteSpace(EditModel.TempGateInIrn))
        {
            DialogMessage = "Please generate  valid Id";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            DialogMessage = "Please Select  valid Grower Group Name";
            ShowEmptyFieldDialog = true;
            return;

        }


        if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
        {
            DialogMessage = "Please Select  valid Grower  Name";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.ChallanName))
        {
            DialogMessage = "Please Select  valid Challan  Name";
            ShowEmptyFieldDialog = true;
            return;

        }


        if (string.IsNullOrWhiteSpace(EditModel.PreInwardKhata))
        {
            DialogMessage = "Please Select  valid Khata  Name";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (string.IsNullOrWhiteSpace(EditModel.Itemname))
        {
            DialogMessage = "Please Select  valid Item  Name";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (string.IsNullOrWhiteSpace(EditModel.ChallanNo))
        {
            DialogMessage = "Please Select  valid Challan  No";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.Vehno))
        {
            DialogMessage = "Please Select  valid Vehicle No";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.ServiceId))
        {
            DialogMessage = "Please Select  valid Scheme";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.VarietyId))
        {
            DialogMessage = "Please Select  valid Variety name";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (string.IsNullOrWhiteSpace(EditModel.PreInwardRemarks))
        {
            EditModel.PreInwardRemarks = "";

        }
        if (string.IsNullOrWhiteSpace(EditModel.PreCrateType))
        {
            DialogMessage = "Please Select  valid Crate Type";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (!EditModel.PreInwardQty.HasValue || EditModel.PreInwardQty <= 0)
        {
            DialogMessage = "Please enter a valid quantity greater than 0.";
            ShowEmptyFieldDialog = true;
            return;
        }
        if (EditModel.PreCrateType == "BOTH")
        {
            if (EditModel.OwnQty == 0 || EditModel.StoreQty == 0)
            {
                DialogMessage = "Invalid Qty for Both crate type option";
                ShowEmptyFieldDialog = true;
                return;
            }

            if (EditModel.PreCrateType == "BOTH")
            {



                decimal total = (EditModel.OwnQty ?? 0) + (EditModel.StoreQty ?? 0);

                if (total != EditModel.PreInwardQty)
                {
                    DialogMessage = "Invalid Qty for Both crate type option";
                    ShowEmptyFieldDialog = true;
                    return;
                }
            }

        }
        selectetGrowerGroup = EditModel.GrowerGroupName;
        var result = await EmployeeService.CheckChamberAllocation(selectetGrowerGroup);


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Error";
            ShowEmptyFieldDialog = true;

            return;
        }


        GetCrateAnalysis = await EmployeeService.CheckCratesAgreement(selectetGrowerGroup);


        companyModel = await EmployeeService.CheckInsertedQty(EditModel.TempGateInId);

        EditModel.TempInsertedQty = companyModel.TempInsertedQty;


        // decimal insertedQty = companyModel.TempInsertedQty ?? 0;

        //  decimal insertedQty2 = EditModel.TempInsertedQty ?? 0;

        AvailableBookQty = GetCrateAnalysis.FirstOrDefault()?.PrebookQty ?? 0;
        AvailableBookQty = AvailableBookQty + actualidqty;

        decimal TotalQty = (EditModel.PreInwardQty ?? 0) + (EditModel.TempInsertedQty ?? 0);





        if (TotalQty > AvailableBookQty)
        {
            DialogMessage = $"Entered quantity exceeds the available Booking Qty";
            ShowEmptyFieldDialog = true;

            return;
        }


        GetchamberAnalysis = await EmployeeService.CheckChamberStatus(selectetGrowerGroup);

        decimal ActiveChamberQty = GetchamberAnalysis.FirstOrDefault()?.ChamberAvailQty ?? 0;
        int Chamberid = GetchamberAnalysis.FirstOrDefault()?.ChamberId ?? 0;

        EditModel.ChamberId = Chamberid;
        EditModel.ChamberAvailQty = ActiveChamberQty + actualidqty;


        if (TotalQty > EditModel.ChamberAvailQty)
        {
            DialogMessage = $"Entered quantity cannot exceed available Active Chamber ({Chamberid}) quantity ({ActiveChamberQty}).";
            ShowEmptyFieldDialog = true;
            return;
        }


        if (EditModel.PreCrateType == "OWN")
        {
            EditModel.OwnQty = EditModel.PreInwardQty;
            EditModel.StoreQty = 0;
        }

        if (EditModel.PreCrateType == "COMPANY")
        {
            EditModel.StoreQty = EditModel.PreInwardQty;
            EditModel.OwnQty = 0;
        }

        EditModel.GrowerGroupName = selectetGrowerGroup;



        var resultUpload = await EmployeeService.UpdateTrid(EditModel);
        if (resultUpload != null && resultUpload.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(resultUpload.RetMessage))
        {
            DialogMessage = resultUpload.RetMessage;
            ShowEmptyFieldDialogError = true;

            ShowCrateAnalysis = false;

            string CuserName = EditModel.GlobalUserName;
            GetDailyPreinwardtemp = await EmployeeService.GetDailyPreinwardProctemp(EditModel.TempGateInId);

            //
            // // GetCrateMark=await EmployeeService.GetallCrateMarks();
            //      companyModel = await EmployeeService.GetCrateOrderNo();
            // GrowerGroupKey = Guid.NewGuid().ToString();

            // EditModel.GrowerGroupName = String.Empty;
            // EditModel.ChallanName = String.Empty;
            // // EditModel.CrissueMark = String.Empty;
            // EditModel.PreInwardRemarks = "";
            EditModel.PreInwardQty = 0;
            EditModel.PreInwardKhata = String.Empty;
            EditModel.PreCrateType = String.Empty;
            // EditModel.GrowerName = String.Empty;
            EditModel.VarietyId = String.Empty;
            // EditModel.Itemname = String.Empty;
            // EditModel.ServiceId = String.Empty;
            //   EditModel.Prodname  = String.Empty;
            // EditModel.Vehno = String.Empty;
            //EditModel.PreInwardUom = String.Empty;


            // selectedSubgrower= String.Empty;
            ShowBoth = false;
            // Purchaseorders = await EmployeeService.GetCrateorders();
            // GetMaxCrateId = await EmployeeService.GetMaxCrateIdno();
            // int cid=0;
            // cid= GetMaxCrateId.FirstOrDefault()?.CrissueId ?? 0;
            // EditModel.CrissueId = cid;

            // await  GeneratePreviewbyid(EditModel.CrissueId);
            // StateHasChanged();
            return;
        }
    }

    protected async Task UpdateItem()
    {

        selectedItemid = EditModel.PurchaseOrderItemId;
        //   await JS.InvokeVoidAsync("alert", selectedItemid);
        if (string.IsNullOrWhiteSpace(EditModel.PurchGrp))
        {
            DialogMessage = "Please Select  valid Purchase Group";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.PurchaseItemName))
        {
            DialogMessage = "Please Select  valid Item Group";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (string.IsNullOrWhiteSpace(EditModel.PurchaseOrderItemDescrip))
        {
            EditModel.PurchaseOrderItemDescrip = "";


        }


        if (!EditModel.PurchaseOrderqty.HasValue || EditModel.PurchaseOrderqty <= 0)
        {
            DialogMessage = "Please enter a valid quantity greater than 0.";
            ShowEmptyFieldDialog = true;
            return;
        }
        if (EditModel.PurchaseOrderId <= 0)
        {
            DialogMessage = "Please enter a valid Order No";
            ShowEmptyFieldDialog = true;
            return;
        }

        var result = await EmployeeService.UpdatePurchaseOrderItem(EditModel);
        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {
            DialogMessage = result.RetMessage;
            ShowEmptyFieldDialogError = true;


            companyModel = new CompanyModel();
            selectedGrowerId = EditModel.PurchaseOrderId;
            GetOrderDetails = await EmployeeService.GetPurchaseOrder(selectedGrowerId);

            StateHasChanged();
            return;
        }


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to add order item.";
            ShowEmptyFieldDialog = true;

            return;
        }




    }





    protected async Task SearchCrates()


    {
        DateTime DateFrom = EditModel.CrateDatefrom ?? DateTime.Now;
        DateTime Dateto = EditModel.CrateDateto ?? DateTime.Now;

        GetDailyCrates = await EmployeeService.GetDailyCratesProcBydate(DateFrom, Dateto);

    }

    private int? GetNumberBeforeHyphen(string input)
    {
        if (string.IsNullOrWhiteSpace(input))
            return null;

        var match = Regex.Match(input, @"^0*(\d+)-");
        if (!match.Success)
            return null;

        if (int.TryParse(match.Groups[1].Value, out int result))
            return result;

        return null;
    }




    protected async Task SearchLots()


    {
        if (string.IsNullOrWhiteSpace(EditModel.PackingOrderIrn))
        {

            DialogMessage = "Please Select valid Packing Order No";
            ShowEmptyFieldDialog = true;
            return;
        }

        string packGrowerParam = string.IsNullOrWhiteSpace(EditModel.PackingOrderIrn) ? null : EditModel.PackingOrderIrn;

        var Unitid = await ProtectedLocalStore.GetAsync<string>("Unitidno");

        int unit = Convert.ToInt32(Unitid.Value);


        GetPackingStock = await EmployeeService.GenerateOutwardReport(


            packGrowerParam, unit, EditModel
        );

    }



    private bool isProcessing = false;

    async Task SaveUnit()
    {

        await JS.InvokeVoidAsync("alert", $"Selected IDs: {string.Join(", ", selectedBankIds)}");

        await JS.InvokeVoidAsync("alert", $"Selected IDs: {string.Join(", ", selectedGradeIds)}");

        await JS.InvokeVoidAsync("alert", $"Selected IDs: {string.Join(", ", selectedRecipeIds)}");


        if (isProcessing) return;
        isProcessing = true;

        try


        {

            if (GetDailyPreinwardtemp == null || !GetDailyPreinwardtemp.Any())

            {
                DialogMessage = "Please select at least  one lot";
                ShowEmptyFieldDialog = true;
                return;

            }



            if (string.IsNullOrWhiteSpace(EditModel.OrderBy))
            {
                DialogMessage = "Please select valid Order by ";
                ShowEmptyFieldDialog = true;
                return;

            }

            if (string.IsNullOrWhiteSpace(EditModel.DemandStatus))
            {
                DialogMessage = "Please Select  valid demand Type";
                ShowEmptyFieldDialog = true;
                return;

            }


            if (string.IsNullOrWhiteSpace(EditModel.DemandContact))
            {
                EditModel.DemandContact = "";

            }

            if (string.IsNullOrWhiteSpace(EditModel.DemandRemarks))
            {
                EditModel.DemandRemarks = "";

            }



            var checkedItems = GetDailyPreinwardtemp.ToList();

            EditModel.TempOrderId = companyModel.TempOrderId;

            int selectedId = EditModel.TempOrderId;

            int unit = UserSessionService.UnitId;



            foreach (var item in checkedItems)
            {


                EditModel.Lotno = item.Lotno;

                EditModel.OrderQty = item.OrderQty;


                await EmployeeService.UpdateLotOrderQuantity(EditModel);


            }



















            selectetGrowerGroup = EditModel.GrowerGroupName;
            var result = await EmployeeService.AddFinalDemand(EditModel);

            NavigationManager.NavigateTo($"/DemandMain");
            if (result != null && result.RetFlag.Trim() == "FALSE")
            {

                DialogMessage = result.RetMessage ?? "Error";
                ShowEmptyFieldDialog = true;

                return;
            }












        }
        finally
        {
            isProcessing = false;
        }
    }


    async Task Saveoutward()
    {
        if (isProcessing) return;
        isProcessing = true;

        try


        {

            var checkedpellet = GetPackingStockTemp.ToList();

            if (!checkedpellet.Any())
            {
                await JS.InvokeVoidAsync("alert", "Please select atleast one Pellet");
                return;
            }




            if (string.IsNullOrWhiteSpace(EditModel.Outwardtype))
            {
                DialogMessage = "Please Select  valid outward type";
                ShowEmptyFieldDialog = true;
                return;

            }



            if (string.IsNullOrWhiteSpace(EditModel.PackingOrderIrn))
            {
                DialogMessage = "Please Select  valid Valid Packing Order";
                ShowEmptyFieldDialog = true;
                return;

            }


            if (string.IsNullOrWhiteSpace(EditModel.OutwardGrowerGroup))
            {
                DialogMessage = "Please Select  valid Delivered to Grower Group";
                ShowEmptyFieldDialog = true;
                return;

            }

            if (string.IsNullOrWhiteSpace(EditModel.OutwardGrowerName))
            {
                DialogMessage = "Please Select  valid Delivered to Grower Name";
                ShowEmptyFieldDialog = true;
                return;

            }


            if (string.IsNullOrWhiteSpace(EditModel.ChallanName))
            {
                DialogMessage = "Please Select  valid Delivered to Challan";
                ShowEmptyFieldDialog = true;
                return;

            }


            if (string.IsNullOrWhiteSpace(EditModel.Vehno))
            {
                DialogMessage = "Please Select  valid Vehicle No";
                ShowEmptyFieldDialog = true;
                return;

            }

            var Unitid = await ProtectedLocalStore.GetAsync<string>("Unitidno");


            int unit = Convert.ToInt32(Unitid.Value);







            var userResult13 = await ProtectedLocalStore.GetAsync<string>("UserGroup");


            string GlobalUserGroup = userResult13.Success ? userResult13.Value : null;
            var userName = await ProtectedLocalStore.GetAsync<string>("Username");

            string cusername = userName.Success ? userName.Value : null;



            EditModel.GlobalUserName = cusername;



            companyModel = await EmployeeService.GetOutwardNo();
            StateHasChanged();
            int outwardid = EditModel.Outwardid;

            EditModel.Outwardno = outwardid;





            await EmployeeService.truncoutward(EditModel,unit,outwardid);


      

            foreach (var item in checkedpellet)
            {



                EditModel.PalletId = item.PalletId;
                EditModel.OutwardQty = item.OutwardQty;
                EditModel.ReceipeName = item.ReceipeName;
                EditModel.DispatcherId = item.DispatcherId;
                EditModel.OutwardFixid = item.Outwardid;


                //await EmployeeService.UpdateFinaloutward(EditModel, unit);

            }












            // return;
            // await EmployeeService.UpdateLotOrderQuantity(EditModel);
            NavigationManager.NavigateTo($"/GatePassMain");


            // StateHasChanged();
            // return;




            //  await EmployeeService.AddCheckedItemsToDatabase(checkedItems, tempid);
            //  int unit = UserSessionService.UnitId;
            //  GetDailyPreinwardtemp = await EmployeeService.GenerateTempLotReport(EditModel, unit, tempid);
            // isComboDisabled = false;

            //  ShowAddGrid = true;
            //  GetDailyPreinward = await EmployeeService.GenerateLotReportwithtemp(EditModel, unit, tempid);


        }
        finally
        {
            isProcessing = false;






        }
    }

    
    
    






//////save temp

    async Task SaveLot()
    {
        if (isProcessing) return;
        isProcessing = true;

        try


        {

            var checkedpellet = GetPackingStock.Where(x => x.IsSelected).ToList();

            if (!checkedpellet.Any())
            {
                await JS.InvokeVoidAsync("alert", "Please select atleast one Pellet");
                return;
            }


            if (EditModel.TempOutwardId == 0)
            {



                var result1 = await EmployeeService.GeneratePreOutward(EditModel);
                if (result1 != null && result1.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result1.RetMessage))
                {
                    companyModel = await EmployeeService.GetPreOutwardNo();
                    //  await JS.InvokeVoidAsync("alert", companyModel.TempOrderId);
                    EditModel.TempOutwardId = companyModel.TempOutwardId;

                    StateHasChanged();


                }
            }







            var Unitid = await ProtectedLocalStore.GetAsync<string>("Unitidno");


            int unit = Convert.ToInt32(Unitid.Value);
            int tempid = EditModel.TempOutwardId;


            foreach (var item in checkedpellet)
            {
                companyModel = new CompanyModel();

                companyModel.PalletId = item.PalletId;

                companyModel.OutwardQty = item.OutwardQty;

                var validationResult = await EmployeeService.ValidatePelletoutward(companyModel, unit,tempid);
                if (validationResult != null && validationResult.RetFlag.Trim() == "FALSE")
                {

                    DialogMessage = validationResult.RetMessage ?? "Action Failed.";
                    ShowEmptyFieldDialog = true;

                    return;
                }


                var userResult13 = await ProtectedLocalStore.GetAsync<string>("UserGroup");


                string GlobalUserGroup = userResult13.Success ? userResult13.Value : null;
                var userName = await ProtectedLocalStore.GetAsync<string>("Username");

                string cusername = userName.Success ? userName.Value : null;


                EditModel.GlobalUserName = cusername;


            }
      
            foreach (var item in checkedpellet)
            {


                EditModel.Packingorderid = item.Packingorderid;

                EditModel.PalletId = item.PalletId;
                EditModel.OutwardQty = item.OutwardQty;
                EditModel.ReceipeName = item.ReceipeName;
                EditModel.DispatcherId = item.DispatcherId;
                await EmployeeService.Addoutwardtemp(EditModel, unit,tempid);

            }

            int orderid= EditModel.Packingorderid;
            GetPackingStockTemp = await EmployeeService.GenerateOutwardReporttemp(tempid, unit, orderid);

            GetPackingStock = await EmployeeService.GenerateOutwardwithtemp(tempid, unit, orderid);

         
            ShowAddGrid = true;
          









          
          //  await SearchLots();


            StateHasChanged();
            // return;




            //  await EmployeeService.AddCheckedItemsToDatabase(checkedItems, tempid);
            //  int unit = UserSessionService.UnitId;
            //  GetDailyPreinwardtemp = await EmployeeService.GenerateTempLotReport(EditModel, unit, tempid);
            // isComboDisabled = false;

            //  ShowAddGrid = true;
            //  GetDailyPreinward = await EmployeeService.GenerateLotReportwithtemp(EditModel, unit, tempid);


        }
        finally
        {
            isProcessing = false;
        }


    }
    private async Task ClearChamberGroupSelection()
    {
        EditModel.ChamberName = null;
        selectedIrn = null;
        EditModel.GrowerName = string.Empty;
        EditModel.GrowerName = string.Empty;
        EditModel.ChallanName = string.Empty;

        int unit = UserSessionService.UnitId;
        GetChambers = await EmployeeService.GetallChamberslist(unit);
        banks = await EmployeeService.GetallQuality();

        GetgrowerList = await EmployeeService.GetallGrowerlist();
        StateHasChanged();
    }


















    protected async Task PostOrder()
    {
        if (EditModel.PurchaseOrderId <= 0)
        {
            DialogMessage = "Please enter a valid Order No";
            ShowEmptyFieldDialog = true;
            return;
        }
        selectedGrowerId = EditModel.PurchaseOrderId;
        companyModel = await EmployeeService.CheckPurchaseOrder(selectedGrowerId);


        string Orderstat = companyModel.PurchaseOrderStatus;

        if (Orderstat == "POST")
        {
            DialogMessage = "Order is already Posted";
            ShowEmptyFieldDialog = true;
            return;
        }

        if (Orderstat == "UNPOST")
        {

            PostDialog = true;
            return;
        }


    }
    protected async Task UnpostOrder()
    {
        if (EditModel.PurchaseOrderId <= 0)
        {
            DialogMessage = "Please enter a valid Order No";
            ShowEmptyFieldDialog = true;
            return;
        }
        selectedGrowerId = EditModel.PurchaseOrderId;
        companyModel = await EmployeeService.CheckPurchaseOrder(selectedGrowerId);


        string Orderstat = companyModel.PurchaseOrderStatus;

        if (Orderstat == "UNPOST")
        {
            DialogMessage = "Order is not Posted";
            ShowEmptyFieldDialog = true;
            return;
        }

        if (Orderstat == "POST")
        {

            UnPostDialog = true;
            return;
        }


    }
    protected async Task CreatePrin()
    {
        EditModel.GrowerGroupName = AvailGrower;
        if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            DialogMessage = "Please Select  valid Grower Group Name";
            ShowEmptyFieldDialog = true;
            return;

        }


        if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
        {
            DialogMessage = "Please Select  valid Grower  Name";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.ChallanName))
        {
            DialogMessage = "Please Select  valid Challan  Name";
            ShowEmptyFieldDialog = true;
            return;

        }



        if (string.IsNullOrWhiteSpace(EditModel.ChallanNo))
        {
            DialogMessage = "Please Select  valid Challan  No";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.Vehno))
        {
            DialogMessage = "Please Select  valid Vehicle No";
            ShowEmptyFieldDialog = true;
            return;

        }




        if (string.IsNullOrWhiteSpace(EditModel.PreInwardRemarks))
        {
            EditModel.PreInwardRemarks = "";

        }

        selectetGrowerGroup = EditModel.GrowerGroupName;
        var result = await EmployeeService.CheckChamberAllocation(selectetGrowerGroup);


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Error";
            ShowEmptyFieldDialog = true;

            return;
        }








        PurDialog = true;




        // selectetGrowerGroup = EditModel.GrowerGroupName;
        // var result = await EmployeeService.CheckChamberAllocation(selectetGrowerGroup);


    }


    async Task PostPrn()
    {
        if (isProcessing) return;
        isProcessing = true;

        try


        {
            EditModel.GrowerGroupName = AvailGrower;

            if (string.IsNullOrWhiteSpace(EditModel.TempGateInIrn))
            {
                DialogMessage = "Please generate  valid Id";
                ShowEmptyFieldDialog = true;
                return;

            }

            if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
            {
                DialogMessage = "Please Select  valid Grower Group Name";
                ShowEmptyFieldDialog = true;
                return;

            }


            if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
            {
                DialogMessage = "Please Select  valid Grower  Name";
                ShowEmptyFieldDialog = true;
                return;

            }

            if (string.IsNullOrWhiteSpace(EditModel.ChallanName))
            {
                DialogMessage = "Please Select  valid Challan  Name";
                ShowEmptyFieldDialog = true;
                return;

            }




            if (string.IsNullOrWhiteSpace(EditModel.ChallanNo))
            {
                DialogMessage = "Please Select  valid Challan  No";
                ShowEmptyFieldDialog = true;
                return;

            }

            if (string.IsNullOrWhiteSpace(EditModel.Vehno))
            {
                DialogMessage = "Please Select  valid Vehicle No";
                ShowEmptyFieldDialog = true;
                return;

            }

            if (string.IsNullOrWhiteSpace(EditModel.PreInwardRemarks))
            {
                EditModel.PreInwardRemarks = "";

            }
            selectetGrowerGroup = EditModel.GrowerGroupName;



            var result = await EmployeeService.CheckChamberAllocation(selectetGrowerGroup);


            if (result != null && result.RetFlag.Trim() == "FALSE")
            {

                DialogMessage = result.RetMessage ?? "Error";
                ShowEmptyFieldDialog = true;

                return;
            }


            GetCrateAnalysis = await EmployeeService.CheckCratesAgreement(selectetGrowerGroup);


            companyModel = await EmployeeService.CheckInsertedQty(EditModel.TempGateInId);

            EditModel.TempInsertedQty = companyModel.TempInsertedQty;

            if (EditModel.TempInsertedQty == 0)
            {
                DialogMessage = "Please enter one item with qty";
                ShowEmptyFieldDialog = true;
                return;
            }

            AvailableBookQty = GetCrateAnalysis.FirstOrDefault()?.PrebookQty ?? 0;


            decimal TotalQty = (EditModel.PreInwardQty ?? 0) + (EditModel.TempInsertedQty ?? 0);





            if (TotalQty > AvailableBookQty)
            {
                DialogMessage = $"Entered quantity exceeds the available Booking Qty";
                ShowEmptyFieldDialog = true;

                return;
            }


            GetchamberAnalysis = await EmployeeService.CheckChamberStatus(selectetGrowerGroup);

            decimal ActiveChamberQty = GetchamberAnalysis.FirstOrDefault()?.ChamberAvailQty ?? 0;
            int Chamberid = GetchamberAnalysis.FirstOrDefault()?.ChamberId ?? 0;

            EditModel.ChamberId = Chamberid;
            EditModel.ChamberAvailQty = ActiveChamberQty;


            if (TotalQty > EditModel.ChamberAvailQty)
            {
                DialogMessage = $"Entered quantity cannot exceed available Active Chamber ({Chamberid}) quantity ({ActiveChamberQty}).";
                ShowEmptyFieldDialog = true;
                return;
            }



            EditModel.GrowerGroupName = selectetGrowerGroup;



            var resultUpload = await EmployeeService.PostPrn(EditModel);
            if (resultUpload != null && resultUpload.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(resultUpload.RetMessage))
            {
                await JS.InvokeVoidAsync("window.open", "/Thermal", "_blank");

                ShowCrateAnalysis = false;

                string CuserName = EditModel.GlobalUserName;
                dismissTimer = new System.Timers.Timer(3000); // 3 seconds
                dismissTimer.Elapsed += (sender, e) =>
                {
                    // This will run on a different thread, so we need to use InvokeAsync
                    InvokeAsync(() =>
                    {
                        ShowEmptyFieldDialogError = false;
                        StateHasChanged();
                        dismissTimer.Dispose();
                    });
                };


                //   GetDailyPreinwardtemp = await EmployeeService.GetDailyPreinwardProctemp(EditModel.TempGateInId);

                //
                // // GetCrateMark=await EmployeeService.GetallCrateMarks();
                //      companyModel = await EmployeeService.GetCrateOrderNo();
                // GrowerGroupKey = Guid.NewGuid().ToString();

                EditModel.GrowerGroupName = String.Empty;
                EditModel.ChallanName = String.Empty;
                // EditModel.CrissueMark = String.Empty;
                EditModel.PreInwardRemarks = "";
                EditModel.PreInwardQty = 0;
                EditModel.PreInwardKhata = String.Empty;
                EditModel.PreCrateType = String.Empty;
                EditModel.GrowerName = String.Empty;
                EditModel.VarietyId = String.Empty;
                EditModel.Itemname = String.Empty;
                EditModel.ServiceId = String.Empty;
                EditModel.Prodname = String.Empty;
                EditModel.Vehno = String.Empty;
                EditModel.TempGateInIrn = String.Empty;
                EditModel.PreInwardUom = String.Empty;
                ShowOtherButtons = false;
                ShowButtonAdd = true;



                // selectedSubgrower= String.Empty;
                ShowBoth = false;
                // Purchaseorders = await EmployeeService.GetCrateorders();
                // GetMaxCrateId = await EmployeeService.GetMaxCrateIdno();
                // int cid=0;
                // cid= GetMaxCrateId.FirstOrDefault()?.CrissueId ?? 0;
                // EditModel.CrissueId = cid;

                // await  GeneratePreviewbyid(EditModel.CrissueId);
                // StateHasChanged();
                return;
            }


            if (resultUpload != null && resultUpload.RetFlag.Trim() == "FALSE")
            {

                DialogMessage = resultUpload.RetMessage ?? "Failed to add Master Group.";
                ShowEmptyFieldDialog = true;

                return;
            }


        }
        finally
        {
            isProcessing = false;
        }

    }



    protected async Task UpdateCrateIssue()
    {

        //  EditModel.GrowerGroupName = AvailGrower;

        selectedGrowerId = EditModel.CrissueId;
        if (string.IsNullOrWhiteSpace(EditModel.GrowerGroupName))
        {
            DialogMessage = "Please Select  valid Grower Group Name";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (EditModel.CrissueId <= 0)
        {
            DialogMessage = "Please enter a valid idno greater than 0.";
            ShowEmptyFieldDialog = true;
            return;
        }

        if (string.IsNullOrWhiteSpace(EditModel.GrowerName))
        {
            DialogMessage = "Please Select  valid Grower  Name";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.ChallanName))
        {
            DialogMessage = "Please Select  valid Challan  Name";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.CrissueMark))
        {
            DialogMessage = "Please Select  valid Crate  Mark";
            ShowEmptyFieldDialog = true;
            return;

        }

        if (string.IsNullOrWhiteSpace(EditModel.Vehno))
        {
            DialogMessage = "Please Select  valid Vehicle No";
            ShowEmptyFieldDialog = true;
            return;

        }
        if (string.IsNullOrWhiteSpace(EditModel.CrissueRemarks))
        {
            EditModel.CrissueRemarks = "";

        }

        if (!EditModel.CrissueQty.HasValue || EditModel.CrissueQty <= 0)
        {
            DialogMessage = "Please enter a valid quantity greater than 0.";
            ShowEmptyFieldDialog = true;
            return;
        }

        selectetGrowerGroup = EditModel.GrowerGroupName;
        GetCrateAnalysis = await EmployeeService.CheckCratesParty(selectetGrowerGroup);
        decimal GrowerAvail = GetCrateAnalysis.FirstOrDefault()?.CrateAvailable ?? 0;
        GrowerAvail = GrowerAvail + actualidqty;

        if (EditModel.CrissueQty > GrowerAvail)
        {
            DialogMessage = $"Entered quantity cannot exceed available grower group quantity ({GrowerAvail}).";
            ShowEmptyFieldDialog = true;
            return;
        }


        selectedSubgrower = EditModel.GrowerName;
        GetCrateAnalysis = await EmployeeService.CheckCratesPartysub(selectedSubgrower, selectetGrowerGroup);

        decimal SubGrowerAvail = GetCrateAnalysis.FirstOrDefault()?.CrateAvailable ?? 0;
        SubGrowerAvail = SubGrowerAvail + actualidqty;


        if (EditModel.CrissueQty > SubGrowerAvail)
        {
            DialogMessage = $"Entered quantity cannot exceed available grower quantity ({SubGrowerAvail}).";
            ShowEmptyFieldDialog = true;
            return;
        }


        var result = await EmployeeService.UpdateCrateIssue(EditModel);
        if (result != null && result.RetFlag.Trim() == "TRUE" && !string.IsNullOrEmpty(result.RetMessage))
        {
            DialogMessage = result.RetMessage;
            ShowEmptyFieldDialogError = true;

            ShowCrateAnalysis = false;



            GetDailyCrates = await EmployeeService.GetDailyCratesProc();

            //      //
            //      // // GetCrateMark=await EmployeeService.GetallCrateMarks();
            //      //      companyModel = await EmployeeService.GetCrateOrderNo();
            //GrowerGroupKey = Guid.NewGuid().ToString();

            EditModel.GrowerGroupName = String.Empty;
            EditModel.ChallanName = String.Empty;
            // EditModel.CrissueMark = String.Empty;
            EditModel.CrissueRemarks = "";
            EditModel.CrissueQty = 0;
            EditModel.CrissueMark = String.Empty;
            EditModel.Vehno = String.Empty;
            EditModel.GrowerName = String.Empty;
            selectedSubgrower = String.Empty;
            Purchaseorders = await EmployeeService.GetCrateorders();
            companyModel = await EmployeeService.GetCrateOrderNo();
            StateHasChanged();
            return;
        }


        if (result != null && result.RetFlag.Trim() == "FALSE")
        {

            DialogMessage = result.RetMessage ?? "Failed to add Master Group.";
            ShowEmptyFieldDialog = true;

            return;
        }











    }



    void Grid_CustomizeElement(GridCustomizeElementEventArgs e)
    {
        if (e.ElementType == GridElementType.DataRow && e.VisibleIndex % 2 == 1)
        {
            e.CssClass = "alt-item";
        }
        if (e.ElementType == GridElementType.HeaderCell)
        {
            e.Style = "background-color: var(--DS-color-surface-neutral-default-selected)";
            e.CssClass = "header-bold";
        }


    }


    public class Order
    {
        public int? OrderID { get; set; }
        public string CustomerID { get; set; }
        public DateTime? OrderDate { get; set; }
        public double? Freight { get; set; }
    }
}
