@page "/Grid/DragDropRows/Accessible"
@layout DataProviderAccessArea<INwindDataProvider>
@using System.Collections.ObjectModel;

<DemoPageSectionComponent Id="Grid-DragDropRows-Accessible" ShowSizeMode="true">
    <ChildContentWithParameters Context="Params">
        @inject NwindDataService NwindDataService
        <div class="grid-container">
            <DxGrid @ref="@InStockGrid"
                    Data="InStockProducts"
                    AllowSort="false"
                    AllowSelectRowByClick="true"
                    AllowDragRows="true"
                    FocusedRowEnabled="true"
                    AllowedDropTarget="GridAllowedDropTarget.All"
                    SizeMode="Params.SizeMode"
                    ShowAllRows="true"
                    ItemsDropped="Grid_ItemsDropped">
                <Columns>
                    <DxGridSelectionColumn Width="40px" />
                    <DxGridDataColumn FieldName="ProductName" MinWidth="50" />
                    <DxGridDataColumn FieldName="UnitPrice" Width="100px" DisplayFormat="c2" />
                    <DxGridCommandColumn Width="50px" NewButtonVisible="false">
                        <CellDisplayTemplate>
                            <div class="grid-cell-align-center">
                                <DxButton IconCssClass="grid-icon grid-icon-reorder-up"
                                          RenderStyle="ButtonRenderStyle.Link"
                                          aria-label="Move up"
                                          @onclick:stopPropagation="true"
                                          Click="@(() => Grid_ReorderRow(context.Grid, context.DataItem, false))" />
                            </div>
                        </CellDisplayTemplate>
                    </DxGridCommandColumn>
                    <DxGridCommandColumn Width="50px" NewButtonVisible="false">
                        <CellDisplayTemplate>
                            <div class="grid-cell-align-center">
                                <DxButton IconCssClass="grid-icon grid-icon-reorder-down"
                                          RenderStyle="ButtonRenderStyle.Link"
                                          aria-label="Move down"
                                          @onclick:stopPropagation="true"
                                          Click="@(() => Grid_ReorderRow(context.Grid, context.DataItem, true))" />
                            </div>
                        </CellDisplayTemplate>
                    </DxGridCommandColumn>
                    <DxGridCommandColumn Width="50px" NewButtonVisible="false">
                        <CellDisplayTemplate>
                            <div class="grid-cell-align-center">
                                <DxButton IconCssClass="grid-icon grid-icon-move-right"
                                          RenderStyle="ButtonRenderStyle.Link"
                                          aria-label="Move to Right Grid"
                                          @onclick:stopPropagation="true"
                                          Click="@(() => Grid_MoveRow(context.Grid, context.DataItem))" />
                            </div>
                        </CellDisplayTemplate>
                    </DxGridCommandColumn>
                </Columns>
            </DxGrid>

            <DxGrid @ref="@OutOfStockGrid"
                    Data="DiscontinuedProducts"
                    AllowSort="false"
                    AllowSelectRowByClick="true"
                    AllowDragRows="true"
                    AllowedDropTarget="GridAllowedDropTarget.All"
                    FocusedRowEnabled="true"
                    SizeMode="Params.SizeMode"
                    ShowAllRows="true"
                    ItemsDropped="Grid_ItemsDropped">
                <Columns>
                    <DxGridSelectionColumn Width="40px" />
                    <DxGridDataColumn FieldName="ProductName" MinWidth="50" />
                    <DxGridDataColumn FieldName="UnitPrice" Width="100px" DisplayFormat="c2" />
                    <DxGridCommandColumn Width="50px" NewButtonVisible="false">
                        <CellDisplayTemplate>
                            <div class="grid-cell-align-center">
                                <DxButton IconCssClass="grid-icon grid-icon-reorder-up"
                                          RenderStyle="ButtonRenderStyle.Link"
                                          aria-label="Move up"
                                          @onclick:stopPropagation="true"
                                          Click="@(() => Grid_ReorderRow(context.Grid, context.DataItem, false))" />
                            </div>
                        </CellDisplayTemplate>
                    </DxGridCommandColumn>
                    <DxGridCommandColumn Width="50px" NewButtonVisible="false">
                        <CellDisplayTemplate>
                            <div class="grid-cell-align-center">
                                <DxButton IconCssClass="grid-icon grid-icon-reorder-down"
                                          RenderStyle="ButtonRenderStyle.Link"
                                          aria-label="Move down"
                                          @onclick:stopPropagation="true"
                                          Click="@(() => Grid_ReorderRow(context.Grid, context.DataItem, true))" />
                            </div>
                        </CellDisplayTemplate>
                    </DxGridCommandColumn>
                    <DxGridCommandColumn Width="50px" NewButtonVisible="false">
                        <CellDisplayTemplate>
                            <div class="grid-cell-align-center">
                                <DxButton IconCssClass="grid-icon grid-icon-move-left"
                                          RenderStyle="ButtonRenderStyle.Link"
                                          aria-label="Move to Right Grid"
                                          @onclick:stopPropagation="true"
                                          Click="@(() => Grid_MoveRow(context.Grid, context.DataItem))" />
                            </div>
                        </CellDisplayTemplate>
                    </DxGridCommandColumn>
                </Columns>
            </DxGrid>
        </div>

        @code {
            IGrid InStockGrid { get; set; }
            IGrid OutOfStockGrid { get; set; }

            ObservableCollection<Product> InStockProducts { get; set; }
            ObservableCollection<Product> DiscontinuedProducts { get; set; }

            protected override async Task OnInitializedAsync() {
                var products = await NwindDataService.GetProductsAsync();
                InStockProducts = new ObservableCollection<Product>(products.Where(p => p.InStock));
                DiscontinuedProducts = new ObservableCollection<Product>(products.Where(p => p.Discontinued));
            }

            void Grid_ItemsDropped(GridItemsDroppedEventArgs evt) {
                var sourceProducts = GetProductCollection(evt.SourceComponent);
                RemoveDroppedItems(sourceProducts, evt.DroppedItems);

                var destinationProducts = GetProductCollection(evt.Grid);
                var targetProduct = (Product)evt.TargetItem;
                var index = targetProduct != null
                    ? destinationProducts.IndexOf(targetProduct) + (evt.DropPosition == GridItemDropPosition.After ? 1 : 0)
                    : destinationProducts.Count;

                InsertDroppedItems(destinationProducts, evt.DroppedItems, index);
            }

            void Grid_ReorderRow(IGrid grid, object dataItem, bool down) {
                var collection = GetProductCollection(grid);
                var oldIndex = collection.IndexOf((Product)dataItem);
                var newIndex = oldIndex + (down ? 1 : -1);
                if(newIndex >= 0 && newIndex < collection.Count) {
                    collection.Move(oldIndex, newIndex);
                    grid.MakeRowVisible(newIndex);
                    grid.SetFocusedRowIndex(newIndex);
                }
            }

            void Grid_MoveRow(IGrid grid, object dataItem) {
                if(grid.SelectedDataItems.Contains(dataItem))
                    MoveRows(grid, grid.SelectedDataItems);
                else
                    MoveRows(grid, new[] { dataItem });
            }

            void MoveRows(IGrid grid, IEnumerable<object> items) {
                var sourceProducts = GetProductCollection(grid);
                RemoveDroppedItems(sourceProducts, items);
                var destinationGrid = grid == InStockGrid ? OutOfStockGrid : InStockGrid;
                var destinationProducts = GetProductCollection(destinationGrid);
                InsertDroppedItems(destinationProducts, items, destinationProducts.Count);
                var rowIndex = destinationProducts.Count - 1;
                destinationGrid.MakeRowVisible(rowIndex);
                destinationGrid.SetFocusedRowIndex(rowIndex);
            }

            ObservableCollection<Product> GetProductCollection(object grid) {
                return grid == InStockGrid ? InStockProducts : DiscontinuedProducts;
            }

            void RemoveDroppedItems(IList<Product> sourceProducts, IEnumerable<object> droppedItems) {
                foreach(var item in droppedItems)
                    sourceProducts.Remove((Product)item);
            }

            void InsertDroppedItems(IList<Product> destinationProducts, IEnumerable<object> droppedItems, int index) {
                foreach(var item in droppedItems.Reverse())
                    destinationProducts.Insert(index, (Product)item);
            }
        }
    </ChildContentWithParameters>
</DemoPageSectionComponent>
