@page "/TreeList/EditData/EditRow"

<DemoPageSectionComponent Id="TreeList-Editing-EditRow" ShowSizeMode="true">
    <ChildContentWithParameters Context="Params">
        @inject IEmployeeTaskDataProvider EmployeeTaskDataProvider
        <DxTreeList Data="DataSource"
                    KeyFieldName="Id"
                    ParentKeyFieldName="ParentId"
                    HasChildrenFieldName="HasChildren"
                    VirtualScrollingEnabled="true"
                    ColumnResizeMode="TreeListColumnResizeMode.NextColumn"
                    TextWrapEnabled="false"
                    SizeMode="Params.SizeMode"
                    CssClass="max-h-480"
                    ValidationEnabled="false"
                    EditModelSaving="TreeList_EditModelSaving"
                    DataItemDeleting="TreeList_DataItemDeleting"
                    CustomizeEditModel="TreeList_CustomizeEditModel"
                    HighlightRowOnHover="true">
            <Columns>
                <DxTreeListCommandColumn Width="200px"/>
                <DxTreeListDataColumn FieldName="Name" Caption="Task"/>
                <DxTreeListDataColumn FieldName="StartDate" Width="120px"/>
                <DxTreeListDataColumn FieldName="DueDate" Width="120px"/>
                <DxTreeListDataColumn FieldName="Priority" Width="80px" CaptionAlignment="TreeListTextAlignment.Center" TextAlignment="TreeListTextAlignment.Center">
                    <CellDisplayTemplate>
                        @{
                            var displayText = TreeListRenderHelper.EmployeeTaskPriorityToString((EmployeeTask)context.DataItem);
                        }
                        <span title="@displayText priority">@displayText</span>
                    </CellDisplayTemplate>
                    <EditSettings>
                        <DxComboBoxSettings Data="Priorities" ValueFieldName="Value" TextFieldName="Text"/>
                    </EditSettings>
                </DxTreeListDataColumn>
                <DxTreeListDataColumn Caption="Progress" FieldName="Status" Width="100px" CaptionAlignment="TreeListTextAlignment.Center" TextAlignment="TreeListTextAlignment.Center">
                    <CellDisplayTemplate>
                        <DxProgressBar Value="Convert.ToDouble(context.Value)"
                                       MinValue="0"
                                       MaxValue="100"
                                       CssClass="status-progress"
                                       Thickness="0.875em"
                                       Size="100%"
                                       ShowLabel="false"/>
                    </CellDisplayTemplate>
                </DxTreeListDataColumn>
            </Columns>
        </DxTreeList>
    </ChildContentWithParameters>

    @code {
        IList<EmployeeTask> DataSource { get; set; }
        object[] Priorities { get; } = new[] {
            new { Text = "High", Value = 1 },
            new { Text = "Medium", Value = 0 },
            new { Text = "Low", Value = -1 }
        };

        protected override void OnInitialized() {
            DataSource = EmployeeTaskDataProvider.GenerateData();
        }
        void TreeList_CustomizeEditModel(TreeListCustomizeEditModelEventArgs e) {
            if(e.IsNew) {
                var newTask = (EmployeeTask)e.EditModel;
                newTask.Id = DataSource.Max(x => x.Id) + 1;
                newTask.Name = "New task";
                newTask.StartDate = DateTime.Today;
                newTask.DueDate = DateTime.Today.AddDays(7);
                if(e.ParentDataItem != null) {
                    newTask.ParentId = ((EmployeeTask)e.ParentDataItem).Id;
                }
            }
        }
        void TreeList_EditModelSaving(TreeListEditModelSavingEventArgs e) {
            if(e.IsNew) {
                DataSource.Add((EmployeeTask)e.EditModel);
            } else {
                e.CopyChangesToDataItem();
            }
        }
        void TreeList_DataItemDeleting(TreeListDataItemDeletingEventArgs e) {
            DataSource.Remove((EmployeeTask)e.DataItem);
        }
    }
</DemoPageSectionComponent>
