@page "/TreeList/EditData/NewItemRow"
@using System.Collections.ObjectModel

<DemoPageSectionComponent Id="TreeList-Editing-NewItemRow" ShowSizeMode="true">
    <ChildContentWithParameters Context="Params">
        @inject IEmployeeTaskDataProvider EmployeeTaskDataProvider

        <DxTreeList Data="DataSource"
                    KeyFieldName="Id"
                    ParentKeyFieldName="ParentId"
                    HasChildrenFieldName="HasChildren"
                    AllowDragRows="true"
                    ShowAllRows="true"
                    ColumnResizeMode="TreeListColumnResizeMode.NextColumn"
                    TextWrapEnabled="false"
                    SizeMode="Params.SizeMode"
                    CssClass="max-h-480"
                    ValidationEnabled="false"
                    EditMode="TreeListEditMode.EditCell"
                    EditModelSaving="TreeList_EditModelSaving"
                    CustomizeEditModel="TreeList_CustomizeEditModel"
                    ItemsDropped="TreeList_ItemsDropped"
                    EditNewRootRowPosition="NewItemRowPosition.Value"
                    HighlightRowOnHover="true">
            <Columns>
                <DxTreeListDataColumn FieldName="Name" Caption="Task"/>
                <DxTreeListDataColumn FieldName="StartDate" Width="120px"/>
                <DxTreeListDataColumn FieldName="DueDate" Width="120px"/>
                <DxTreeListDataColumn FieldName="Priority" Width="80px" CaptionAlignment="TreeListTextAlignment.Center" TextAlignment="TreeListTextAlignment.Center">
                    <CellDisplayTemplate>
                        @{
                            var displayText = TreeListRenderHelper.TaskPriorityToString((int)context.GetRowValue("Priority"));
                        }
                        <span title="@displayText priority">@displayText</span>
                    </CellDisplayTemplate>
                    <EditSettings>
                        <DxComboBoxSettings Data="Priorities" ValueFieldName="Value" TextFieldName="Text"/>
                    </EditSettings>
                </DxTreeListDataColumn>
                <DxTreeListDataColumn Caption="Progress" FieldName="Status" Width="100px" CaptionAlignment="TreeListTextAlignment.Center" TextAlignment="TreeListTextAlignment.Center">
                    <CellDisplayTemplate>
                        <DxProgressBar Value="Convert.ToDouble(context.Value)"
                                       MinValue="0"
                                       MaxValue="100"
                                       Thickness="0.875em"
                                       Size="100%"
                                       ShowLabel="false"/>
                    </CellDisplayTemplate>
                    <EditSettings>
                        <DxSpinEditSettings MinValue="0" MaxValue="100" InputCssClass="dxbl-align-right" />
                    </EditSettings>
                </DxTreeListDataColumn>
            </Columns>
            <ToolbarTemplate>
                <DxToolbar ItemRenderStyleMode="ToolbarRenderStyleMode.Plain" SizeMode="Params.SizeMode">
                    <Items>
                        <DxToolbarItem BeginGroup="true" Alignment="ToolbarItemAlignment.Left">
                            <Template Context="toolbar_item_context">
                                <div class="d-flex flex-row align-items-center h-100">
                                    <div class="me-2">New Item Row Position:</div>
                                    <DxComboBox Data="TreeListNewRootItemRowPositions" TextFieldName="Name" @bind-Value="NewItemRowPosition" />
                                </div>
                            </Template>
                        </DxToolbarItem>
                    </Items>
                </DxToolbar>
            </ToolbarTemplate>
        </DxTreeList>
    </ChildContentWithParameters>

    @code {
        ObservableCollection<EmployeeTask> DataSource { get; set; }
        object[] Priorities { get; } = new[] {
            new { Text = "High", Value = 1 },
            new { Text = "Medium", Value = 0 },
            new { Text = "Low", Value = -1 }
        };

        IEnumerable<TreeListEditNewRootRowPositionItem> TreeListNewRootItemRowPositions { get; } = new[] {
            TreeListEditNewRootRowPositionItem.Create(TreeListEditNewRootRowPosition.FixedOnTop),
            TreeListEditNewRootRowPositionItem.Create(TreeListEditNewRootRowPosition.LastRow)
        };
        TreeListEditNewRootRowPositionItem NewItemRowPosition { get; set; }

        protected override void OnInitialized() {
            DataSource = new ObservableCollection<EmployeeTask>(EmployeeTaskDataProvider.GenerateData());
            NewItemRowPosition = TreeListNewRootItemRowPositions.First();
        }
        void TreeList_CustomizeEditModel(TreeListCustomizeEditModelEventArgs e) {
            if(e.IsNew) {
                var newTask = (EmployeeTask)e.EditModel;
                newTask.Id = DataSource.Max(x => x.Id) + 1;
                newTask.Name = "New task";
                newTask.StartDate = DateTime.Today;
                newTask.DueDate = DateTime.Today.AddDays(7);
                if(e.ParentDataItem != null) {
                    newTask.ParentId = ((EmployeeTask)e.ParentDataItem).Id;
                }
            }
        }
        void TreeList_EditModelSaving(TreeListEditModelSavingEventArgs e) {
            if(e.IsNew) {
                DataSource.Add((EmployeeTask)e.EditModel);
            } else {
                e.CopyChangesToDataItem();
            }
        }
        void TreeList_ItemsDropped(TreeListItemsDroppedEventArgs evt) {
            if(evt.TargetItem == null)
                return;

            var droppedTask = (EmployeeTask)evt.DroppedItems[0];
            DataSource.Remove(droppedTask);

            var targetTask = (EmployeeTask)evt.TargetItem;
            droppedTask.ParentId = evt.DropPosition == TreeListItemDropPosition.Inside
                ? targetTask.Id
                : targetTask.ParentId;

            var index = DataSource.IndexOf(targetTask) + (evt.DropPosition == TreeListItemDropPosition.After ? 1 : 0);
            DataSource.Insert(index, droppedTask);
        }

        record TreeListEditNewRootRowPositionItem(string Name, TreeListEditNewRootRowPosition Value) {
            public static TreeListEditNewRootRowPositionItem Create(TreeListEditNewRootRowPosition mode) =>
                new (SplitTextHelper.SplitPascalCaseString(mode.ToString()), mode);
        }
    }
</DemoPageSectionComponent>
