@page "/abraq/master/bank-master"
@using BlazorDemo.AbraqAccount.Models
@using BlazorDemo.AbraqAccount.Services.Interfaces
@using BlazorDemo.Components.AbraqAccount.Common
@using Microsoft.AspNetCore.Mvc.Rendering
@inject IBankMasterService BankMasterService
@inject IJSRuntime JS
@layout MainLayout

<ConfirmationModal @ref="confirmModal" OnConfirm="HandleDeleteConfirm" />
<AlertModal @ref="alertModal" />

<div class="container-fluid">
    <div class="bank-master-header">
        <div class="bank-master-title-section">
            <h1>Accounts <small class="subtitle" style="color: #999; font-size: 0.9rem; font-weight: normal;">Control panel</small></h1>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <button class="btn btn-outline-info btn-sm" @onclick="RunMigration" title="Run Database Migration">
                <i class="bi bi-gear-fill"></i> Migrate
            </button>
            <button type="button" class="add-button" @onclick="OpenCreateModal" title="Add New Account">
                <i class="bi bi-plus-lg"></i>
            </button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert" style="margin: 1rem 0;">
            @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
        </div>
    }

    <div class="table-card">
        <div class="table-wrapper">
            <table class="table-bank-master">
                <thead>
                    <tr>
                        <th style="min-width: 180px;">
                            <ColumnFilter Title="Account Name" TItem="BankMaster" TValue="string" Items="originalBanks" Property="@(x => x.AccountName)" OnFilter="@(v => HandleColumnFilter("AccountName", v))" Align="left" />
                        </th>
                        <th style="min-width: 120px;">
                            <ColumnFilter Title="Group" TItem="BankMaster" TValue="string" Items="originalBanks" Property="@(x => x.Group?.Name ?? "-")" OnFilter="@(v => HandleColumnFilter("Group", v))" Align="left" />
                        </th>
                        <th style="min-width: 150px;">
                            <ColumnFilter Title="Address" TItem="BankMaster" TValue="string" Items="originalBanks" Property="@(x => x.Address ?? "-")" OnFilter="@(v => HandleColumnFilter("Address", v))" />
                        </th>
                        <th style="min-width: 110px;">
                            <ColumnFilter Title="Phone" TItem="BankMaster" TValue="string" Items="originalBanks" Property="@(x => x.Phone ?? "-")" OnFilter="@(v => HandleColumnFilter("Phone", v))" />
                        </th>
                        <th style="min-width: 100px;">
                            <ColumnFilter Title="Bank Account" TItem="BankMaster" TValue="string" Items="originalBanks" Property="@(x => x.AccountNumber ?? "-")" OnFilter="@(v => HandleColumnFilter("AccountNumber", v))" />
                        </th>
                        <th style="min-width: 90px;">
                            <ColumnFilter Title="IFSC" TItem="BankMaster" TValue="string" Items="originalBanks" Property="@(x => x.IfscCode ?? "-")" OnFilter="@(v => HandleColumnFilter("IfscCode", v))" />
                        </th>
                        <th style="min-width: 120px;">
                            <ColumnFilter Title="Branch" TItem="BankMaster" TValue="string" Items="originalBanks" Property="@(x => x.BranchName ?? "-")" OnFilter="@(v => HandleColumnFilter("BranchName", v))" />
                        </th>
                        <th style="min-width: 80px;">
                            <ColumnFilter Title="Status" TItem="BankMaster" TValue="string" Items="originalBanks" Property="@(x => x.Status ?? "Inactive")" OnFilter="@(v => HandleColumnFilter("Status", v))" />
                        </th>
                        <th class="sticky-column" style="width: 80px;">Action</th>
                    </tr>
                </thead>
                <tbody>
                    @if (filteredBanks == null)
                    {
                        <tr><td colspan="9" style="text-align: center; padding: 2rem;">Loading...</td></tr>
                    }
                    else if (!filteredBanks.Any())
                    {
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 2rem; color: #999;">
                                No accounts found. <button class="btn-link" @onclick="OpenCreateModal">Create a new account</button>
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var account in filteredBanks)
                        {
                            <tr>
                                <td class="text-truncate" title="@account.AccountName">@account.AccountName</td>
                                <td class="text-truncate" title="@(account.Group?.Name ?? "-")">@(account.Group?.Name ?? "-")</td>
                                <td class="text-truncate" title="@(account.Address ?? "-")">@(account.Address ?? "-")</td>
                                <td class="text-truncate">@(account.Phone ?? "-")</td>
                                <td class="text-truncate">@(account.AccountNumber ?? "-")</td>
                                <td class="text-truncate">@(account.IfscCode ?? "-")</td>
                                <td class="text-truncate" title="@(account.BranchName ?? "-")">@(account.BranchName ?? "-")</td>
                                <td>
                                    <span class="status-badge @(account.Status == "1" ? "status-active" : "status-inactive")">
                                        @(account.Status == "1" ? "Active" : "Inactive")
                                    </span>
                                </td>
                                <td class="sticky-column">
                                    <div class="action-icons">
                                        <button type="button" @onclick="() => OpenEditModal(account)" class="action-icon" title="Edit">
                                            <i class="bi bi-pencil-square"></i>
                                        </button>
                                        <button type="button" @onclick="() => DeleteBank(account.Id)" class="action-icon text-danger" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Form Modal -->
@if (showFormModal)
{
    <div class="modal-overlay show">
        <div class="form-modal" style="max-width: 800px;">
            <div class="modal-header">
                <h3>@(editingBank.Id == 0 ? "Create Account" : "Edit Account")</h3>
                <button type="button" class="modal-close" @onclick="CloseFormModal">&times;</button>
            </div>
            <div class="modal-body">
                <EditForm Model="editingBank" OnValidSubmit="SaveBank">
                    <DataAnnotationsValidator />
                    
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Account Name<span class="required">*</span></label>
                            <InputText @bind-Value="editingBank.AccountName" class="form-control" placeholder="Enter Account Name" />
                            <ValidationMessage For="() => editingBank.AccountName" class="text-danger" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Group<span class="required">*</span></label>
                            <select @bind="editingBank.GroupId" class="form-control" required>
                                <option value="0">-- Select Group --</option>
                                @if (groups != null)
                                {
                                    @foreach (var g in groups)
                                    {
                                        <option value="@g.Value">@g.Text</option>
                                    }
                                }
                            </select>
                            @if (editingBank.GroupId == 0 && submitted)
                            {
                                <span class="text-danger">Group is required.</span>
                            }
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Status<span class="required">*</span></label>
                            <select @bind="editingBank.Status" class="form-control">
                                <option value="1">Active</option>
                                <option value="0">Inactive</option>
                            </select>
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label">Address</label>
                            <InputTextArea @bind-Value="editingBank.Address" class="form-control" placeholder="Enter Address" />
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Phone</label>
                            <InputText @bind-Value="editingBank.Phone" class="form-control" placeholder="Enter Phone" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Email</label>
                            <InputText @bind-Value="editingBank.Email" class="form-control" type="email" placeholder="Enter Email" />
                            <ValidationMessage For="() => editingBank.Email" class="text-danger" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Bank Account No</label>
                            <InputText @bind-Value="editingBank.AccountNumber" class="form-control" placeholder="Enter Bank Account No" />
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">IFSC</label>
                            <InputText @bind-Value="editingBank.IfscCode" class="form-control" placeholder="Enter IFSC Code" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Branch Name</label>
                            <InputText @bind-Value="editingBank.BranchName" class="form-control" placeholder="Enter Branch Name" />
                        </div>
                    </div>

                    <div class="mt-4 d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" @onclick="CloseFormModal">Cancel</button>
                        <button type="submit" class="btn btn-primary" @onclick="() => submitted = true">Save changes</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

<style>
    .bank-master-header {
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;
        padding: 1.5rem; background-color: white; margin: -2rem -2rem 1.5rem -2rem; border-bottom: 1px solid #e0e0e0;
    }
    .bank-master-title-section h1 { font-size: 2rem; font-weight: bold; margin: 0; color: #333; }
    
    .add-button {
        width: 40px; height: 40px; background-color: #6c757d; border: none; border-radius: 4px;
        display: flex; align-items: center; justify-content: center; cursor: pointer;
        font-size: 1.25rem; color: white; transition: background-color 0.3s;
    }
    .add-button:hover { background-color: #5a6268; }

    .table-card { 
        background: white; 
        border: 1px solid #e0e0e0; 
        border-radius: 8px; 
        padding: 1.5rem; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .table-wrapper { 
        overflow-x: auto;
        border-radius: 6px;
    }
    
    .table-bank-master { 
        width: 100%; 
        border-collapse: collapse;
        font-size: 0.9rem;
    }
    
    .table-bank-master th { 
        padding: 0.6rem 0.5rem;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #dee2e6;
        white-space: nowrap;
        background-color: #f8f9fa;
    }
    
    .table-bank-master td { 
        padding: 0.6rem 0.5rem;
        border-bottom: 1px solid #f0f0f0;
        color: #555;
        max-width: 200px;
    }
    
    .table-bank-master tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .text-truncate {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Modern Status Badges */
    .status-badge { 
        display: inline-block;
        padding: 0.25rem 0.6rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .status-active { 
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .status-inactive { 
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .action-icons { display: flex; gap: 0.5rem; justify-content: center; }
    .action-icon { 
        background: none;
        border: none;
        color: #6c757d;
        font-size: 1rem;
        cursor: pointer;
        padding: 0.25rem;
        transition: all 0.2s;
    }
    .action-icon:hover { 
        color: #007bff;
        transform: scale(1.1);
    }
    .action-icon.text-danger:hover { 
        color: #dc3545;
        transform: scale(1.1);
    }

    /* Sticky Action Column */
    .sticky-column {
        position: sticky;
        right: 0;
        background-color: white;
        z-index: 10;
        box-shadow: -2px 0 4px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .table-bank-master thead .sticky-column {
        background-color: #f8f9fa;
        z-index: 11;
    }
    
    .table-bank-master tbody tr:hover .sticky-column {
        background-color: #f8f9fa;
    }

    .required { color: red; margin-left: 2px; }

    /* Modal */
    .modal-overlay {
        display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;
    }
    .modal-overlay.show { display: flex; }
    .form-modal {
        background-color: white; border-radius: 8px; width: 90%; max-height: 90vh;
        display: flex; flex-direction: column; box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    .modal-header {
        background-color: #6c757d; color: white; padding: 1rem 1.5rem; display: flex;
        justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0;
    }
    .modal-header h3 { margin: 0; font-size: 1.25rem; }
    .modal-close { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
    .modal-body { padding: 1.5rem; overflow-y: auto; flex: 1; }
</style>

@code {
    private List<BankMaster>? filteredBanks;
    private List<BankMaster> originalBanks = new();
    private List<SelectListItem>? groups;
    private BankMaster editingBank = new();
    private bool showFormModal = false;
    private string? successMessage;
    private bool submitted = false;
    private Dictionary<string, object> activeColumnFilters = new();
    private ConfirmationModal? confirmModal;
    private AlertModal? alertModal;
    private int deleteId = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        groups = (await BankMasterService.GetGroupsSelectListAsync()).ToList();
    }

    private async Task LoadData()
    {
        var result = await BankMasterService.GetAllActiveBankMastersAsync();
        originalBanks = result.ToList();
        filteredBanks = originalBanks.ToList();
        if (activeColumnFilters.Any()) FilterLocalData();
    }

    private void HandleColumnFilter<T>(string column, List<T> selectedValues)
    {
        if (selectedValues == null || !selectedValues.Any()) 
            activeColumnFilters.Remove(column);
        else 
            activeColumnFilters[column] = selectedValues;

        FilterLocalData();
    }

    private void FilterLocalData()
    {
        if (originalBanks == null) return;
        
        var query = originalBanks.AsEnumerable();

        foreach(var kvp in activeColumnFilters)
        {
             var col = kvp.Key;
             var filterValues = kvp.Value as System.Collections.IEnumerable;
             if (filterValues == null) continue;
             
             query = query.Where(item => {
                 object? val = col switch {
                     "AccountName" => item.AccountName,
                     "Group" => item.Group?.Name ?? "-",
                     "Address" => item.Address ?? "-",
                     "Phone" => item.Phone ?? "-",
                     "Email" => item.Email ?? "-",
                     "AccountNumber" => item.AccountNumber ?? "-",
                     "IfscCode" => item.IfscCode ?? "-",
                     "BranchName" => item.BranchName ?? "-",
                     "Status" => item.Status ?? "Inactive",
                     _ => null
                 };
                 
                 foreach(var f in filterValues) {
                     if (object.Equals(f, val)) return true;
                 }
                 return false;
             });
        }
        
        filteredBanks = query.ToList();
    }

    private void OpenCreateModal()
    {
        editingBank = new BankMaster();
        submitted = false;
        showFormModal = true;
    }

    private void OpenEditModal(BankMaster bank)
    {
        editingBank = new BankMaster
        {
            Id = bank.Id,
            AccountName = bank.AccountName,
            GroupId = bank.GroupId,
            Address = bank.Address,
            Phone = bank.Phone,
            Email = bank.Email,
            AccountNumber = bank.AccountNumber,
            IfscCode = bank.IfscCode,
            BranchName = bank.BranchName,
            Status = bank.Status,
            CreatedBy = bank.CreatedBy,
            CreatedDate = bank.CreatedDate,
            IsActive = bank.IsActive
        };
        submitted = false;
        showFormModal = true;
    }

    private void CloseFormModal()
    {
        showFormModal = false;
    }



    private async Task SaveBank()
    {
        if (editingBank.GroupId == 0) return;

        
        if (editingBank.Id == 0)
        {
            await BankMasterService.CreateBankMasterAsync(editingBank, "");
            successMessage = "Account created successfully!";
        }
        else
        {
            await BankMasterService.UpdateBankMasterAsync(editingBank.Id, editingBank);
            successMessage = "Account updated successfully!";
        }

        showFormModal = false;
        await LoadData();
    }

    private void DeleteBank(int id)
    {
        deleteId = id;
        confirmModal?.Show("Delete Confirmation", "Are you sure you want to delete this account?", "Delete", "btn-danger");
    }

    private async Task HandleDeleteConfirm()
    {
        try
        {
            var result = await BankMasterService.DeleteBankMasterAsync(deleteId);
            if (result)
            {
                await LoadData();
                alertModal?.Show("Account deleted successfully!", "Success", AlertModal.MessageType.Success);
            }
            else
            {
                alertModal?.Show("Account not found.", "Error", AlertModal.MessageType.Error);
            }
        }
        catch (InvalidOperationException ex)
        {
            alertModal?.Show(ex.Message, "Cannot Delete", AlertModal.MessageType.Error);
        }
        catch (Exception ex)
        {
            alertModal?.Show("Error deleting account: " + ex.Message, "Error", AlertModal.MessageType.Error);
        }
    }

    private async Task RunMigration()
    {
        var result = await BankMasterService.MigrateDatabaseAsync();
        if (result.success)
        {
            await JS.InvokeVoidAsync("alert", "Migration completed successfully:\n" + string.Join("\n", result.steps));
            await LoadData();
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Migration failed: " + result.message);
        }
    }
}
