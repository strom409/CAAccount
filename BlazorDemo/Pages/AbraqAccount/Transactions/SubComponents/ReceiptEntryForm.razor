@using BlazorDemo.AbraqAccount.Models
@using BlazorDemo.AbraqAccount.Services.Interfaces
@using BlazorDemo.Components.AbraqAccount.Common
@inject IReceiptEntryService ReceiptService
@inject IGeneralEntryService GeneralEntryService
@inject ISettingsService SettingsService
@inject NavigationManager Navigation

<div class="form-container">
    <div class="form-section-title">
        Receipt Entry - @(IsReadOnly ? "Details" : (IsEdit ? "Edit" : "Add"))
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    <!-- Header Fields -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="form-group-custom">
                <label class="form-label text-muted">Receipt Date</label>
                @if (IsReadOnly)
                {
                    <div class="fw-bold fs-6">@model.ReceiptDate.ToString("dd/MM/yyyy")</div>
                }
                else
                {
                    <input type="date" @bind="model.ReceiptDate" class="form-control-custom" />
                }
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-group-custom">
                <label class="form-label text-muted">Entry For</label>
                @if (IsReadOnly)
                {
                    <div class="fw-bold fs-6">@(entryProfiles?.FirstOrDefault(p => p.Id == selectedProfileId)?.Name ?? "-")</div>
                }
                else
                {
                    <select @onchange="OnProfileChanged" class="form-control-custom">
                        <option value="">Select Entry Profile</option>
                        @if (entryProfiles != null)
                        {
                            @foreach (var profile in entryProfiles)
                            {
                                <option value="@profile.Id" selected="@(selectedProfileId == profile.Id)">@profile.Name</option>
                            }
                        }
                    </select>
                }
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-group-custom">
                <label class="form-label text-muted">Unit <span class="text-danger">*</span></label>
                @if (IsReadOnly)
                {
                    <div class="fw-bold fs-6">@selectedUnit</div>
                }
                else
                {
                    <select @bind="selectedUnit" class="form-control-custom">
                        @foreach (var unit in unitList)
                        {
                            <option value="@unit">@unit</option>
                        }
                    </select>
                }
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-group-custom">
                <label class="form-label text-muted">Mobile No.</label>
                @if (IsReadOnly)
                {
                    <div class="fw-bold fs-6">@model.MobileNo</div>
                }
                else
                {
                    <input type="text" @bind="model.MobileNo" class="form-control-custom" placeholder="Enter Mobile No" />
                }
            </div>
        </div>
    </div>

    <!-- Transaction Details Section -->
    @if (!IsReadOnly)
    {
    <div class="transaction-details-section">
        <div class="section-subtitle mb-3">Transaction Details</div>
        <div class="row mb-3">
            <div class="col-md-2">
                <div class="form-group-custom">
                    <label>Type <span class="text-danger">*</span></label>
                    <select @bind="EntryType" class="form-control-custom" disabled="@(selectedProfileId == null || selectedProfileId == 0)">
                        <option value="Credit">Credit</option>
                        <option value="Debit">Debit</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group-custom">
                    <label>Account <span class="text-danger">*</span></label>
                    <AccountSearch 
                        Placeholder="Search Account Name" 
                        SearchFunc="SearchAccountsForNew"
                        OnAccountSelected="OnAccountSelectedForNew"
                        InitialValue="@newEntry.AccountName"
                        CssClass="form-control-custom"
                        Disabled="@(selectedProfileId == null || selectedProfileId == 0)" />
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group-custom">
                    <label>Payment Type <span class="text-danger">*</span></label>
                    <select @bind="newEntry.PaymentType" class="form-control-custom" disabled="@(selectedProfileId == null || selectedProfileId == 0)">
                        <option value="">Select</option>
                        @foreach (var type in paymentTypes)
                        {
                            <option value="@type.Name">@type.Name</option>
                        }
                    </select>
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group-custom">
                    <label>Amount <span class="text-danger">*</span></label>
                    <input type="number" step="0.01" @bind="newEntry.Amount" class="form-control-custom" placeholder="Enter Amount" disabled="@(selectedProfileId == null || selectedProfileId == 0)" />
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group-custom">
                    <label>Ref. No. Cheque/UTR</label>
                    <input type="text" @bind="newEntry.RefNo" class="form-control-custom" placeholder="Enter Ref. No. Cheque/UTR" disabled="@(selectedProfileId == null || selectedProfileId == 0)" />
                </div>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-12">
                <div class="form-group-custom">
                    <label>Narration</label>
                    <textarea @bind="newEntry.Narration" class="form-control-custom" rows="2" placeholder="Enter Narration" disabled="@(selectedProfileId == null || selectedProfileId == 0)"></textarea>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-end gap-2 mb-4">
            <button type="button" class="btn-add-custom" @onclick="AddNewRow" disabled="@(selectedProfileId == null || selectedProfileId == 0)">
                @(editingItem != null ? "Update" : "Add")
            </button>
            <button type="button" class="btn-clear-row-custom" @onclick="ClearNewEntry">Clear</button>
        </div>
    </div>
    }

    <!-- Details Table -->
    <div class="details-table-section">
        <div class="section-subtitle mb-3">Receipt Entry Details</div>
        <div class="table-responsive">
            <table class="table table-custom-bordered">
                <thead>
                    <tr>
                        <th>Unit</th>
                        <th>Type</th>
                        <th>Account</th>
                        <th>Debit(Rs)</th>
                        <th>Credit(Rs)</th>
                        <th>Payment From</th>
                        <th>Payment Type</th>
                        <th>Ref. No. Cheque/UTR</th>
                        <th>Narration</th>
                        <th>Adjust</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!uiEntries.Any())
                    {
                        <tr>
                            <td colspan="11" class="text-center text-muted py-4">No entries added yet. Use the form below to add entries.</td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var entry in uiEntries)
                        {
                            <tr class="@(entry == editingItem ? "table-active" : "")">
                                <td>@entry.Unit</td>
                                <td>@entry.Type</td>
                                <td>@entry.AccountName</td>
                                <td class="text-end">@entry.Debit.ToString("N2")</td>
                                <td class="text-end">@entry.Credit.ToString("N2")</td>
                                <td>-</td>
                                <td>@entry.PaymentType</td>
                                <td>@entry.RefNo</td>
                                <td>@entry.Narration</td>
                                <td>-</td>
                                <td>
                                    @if (!IsReadOnly)
                                    {
                                        <button class="btn-edit-row me-2" @onclick="() => EditEntry(entry)" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn-delete-row" @onclick="() => RemoveEntry(entry)" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    }
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" class="text-end fw-bold">Total</td>
                        <td class="text-end fw-bold">@TotalDebit.ToString("N2")</td>
                        <td class="text-end fw-bold">@TotalCredit.ToString("N2")</td>
                        <td colspan="6"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <div class="form-footer-actions">
        @if (!IsReadOnly)
        {
            <button type="button" class="btn-save-custom" @onclick="SubmitForm" disabled="@(isSubmitting || !IsBalanced)">
                @if (isSubmitting) { <span class="spinner-border spinner-border-sm me-1"></span> }
                Save
            </button>
            <button type="button" class="btn-cancel-custom" @onclick="Cancel">Cancel</button>
        }
        else
        {
            <a href="/transactions/entries?noteType=Receipt" class="btn-cancel-custom text-decoration-none d-inline-flex align-items-center">
                <i class="bi bi-arrow-left me-1"></i> Back to List
            </a>
        }
    </div>
</div>

<style>
    .form-container { background: white; padding: 1.5rem; border: 1px solid #e0e0e0; border-radius: 4px; }
    .form-section-title { font-size: 1.1rem; font-weight: 500; color: #495057; margin-bottom: 2rem; padding-bottom: 0.75rem; border-bottom: 1px solid #f0f0f0; }
    .section-subtitle { font-size: 1rem; font-weight: 600; color: #444; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; }
    .form-group-custom { margin-bottom: 1rem; }
    .form-group-custom label { display: block; font-size: 0.85rem; font-weight: 600; color: #333; margin-bottom: 0.4rem; }
    .form-control-custom { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9rem; }
    .btn-add-custom { background-color: #28a745; color: white; border: none; padding: 0.5rem 2rem; border-radius: 4px; font-weight: 500; }
    .btn-clear-row-custom { background-color: #f8f9fa; color: #333; border: 1px solid #ced4da; padding: 0.5rem 2rem; border-radius: 4px; font-weight: 500; }
    .table-custom-bordered { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .table-custom-bordered th { background: #f8f9fa; padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; }
    .table-custom-bordered td { padding: 0.75rem; border: 1px solid #dee2e6; }
    .btn-delete-row { background: none; border: none; color: #dc3545; cursor: pointer; }
    .btn-edit-row { background: none; border: none; color: #ffc107; cursor: pointer; }
    .form-footer-actions { display: flex; justify-content: flex-end; gap: 0.5rem; padding-top: 1.5rem; border-top: 1px solid #f0f0f0; margin-top: 2rem; }
    .btn-save-custom { background-color: #6c757d; color: white; border: none; padding: 0.5rem 2rem; border-radius: 4px; font-weight: 500; }
    .btn-cancel-custom { background-color: #e9ecef; color: #495057; border: none; padding: 0.5rem 2rem; border-radius: 4px; font-weight: 500; }
</style>

@code {
    [Parameter] public string? VoucherNo { get; set; }
    [Parameter] public bool IsReadOnly { get; set; }
    [Parameter] public EventCallback OnSaved { get; set; }
    private ReceiptEntryBatchModel model = new() { ReceiptDate = DateTime.Now };
    private List<UIEntry> uiEntries = new();
    private List<PaymentType> paymentTypes = new(); // Added this
    private UIEntry? editingItem; // Track item being edited

    private string EntryType
    {
        get => newEntry.Type;
        set
        {
            if (newEntry.Type != value)
            {
                newEntry.Type = value;
                // Clear Account when Type changes
                newEntry.AccountId = 0;
                newEntry.AccountName = "";
                newEntry.AccountType = ""; // Reset derived type
            }
        }
    }
    
    private UIEntry newEntry = new() { Type = "Credit", PaymentType = "" };
    private string selectedUnit = "";
    private List<string> unitList = new(); 
    private bool IsEdit => !string.IsNullOrEmpty(VoucherNo);
    private bool isSubmitting;
    private string? errorMessage;
    private IEnumerable<LookupItem>? entryProfiles;
    private int? selectedProfileId;

    private decimal TotalDebit => uiEntries.Sum(e => e.Debit);
    private decimal TotalCredit => uiEntries.Sum(e => e.Credit);
    private bool IsBalanced => Math.Abs(TotalDebit - TotalCredit) < 0.01m && uiEntries.Count > 0;

    protected override async Task OnInitializedAsync()
    {
        entryProfiles = await ReceiptService.GetEntryProfilesAsync();
        unitList = await GeneralEntryService.GetUnitNamesAsync();
        paymentTypes = await SettingsService.GetPaymentTypesAsync();
        
        if (unitList.Any()) selectedUnit = unitList.First();
        
        if (IsEdit)
        {
            var entries = await ReceiptService.GetReceiptEntriesByVoucherNoAsync(VoucherNo!);
            if (entries != null && entries.Any())
            {
                model.ReceiptDate = entries.First().ReceiptDate;
                model.MobileNo = entries.First().MobileNo;
                selectedProfileId = entries.First().EntryForId;
                selectedUnit = entries.First().Unit ?? "Unit 1";

                foreach (var e in entries)
                {
                    var name = await ReceiptService.GetAccountNameAsync(e.AccountId, e.AccountType);
                    uiEntries.Add(new UIEntry {
                        Type = e.Type,
                        AccountId = e.AccountId,
                        AccountType = e.AccountType,
                        AccountName = name,
                        PaymentType = e.PaymentType,
                        Debit = e.Type == "Debit" ? e.Amount : 0,
                        Credit = e.Type == "Credit" ? e.Amount : 0,
                        Amount = e.Amount,
                        RefNo = e.RefNoChequeUTR ?? "",
                        Narration = e.Narration ?? "",
                        Unit = e.Unit
                    });
                }
            }
        }
    }

    private async Task<IEnumerable<LookupItem>> SearchAccountsForNew(string term)
    {
        return await ReceiptService.GetAccountsAsync(term, selectedProfileId, newEntry.Type);
    }

    private void OnAccountSelectedForNew(LookupItem account)
    {
        newEntry.AccountId = account.Id;
        newEntry.AccountType = account.Type ?? "SubGroupLedger";
        newEntry.AccountName = account.Name;
    }

    private void AddNewRow()
    {
        if (newEntry.AccountId == 0 || newEntry.Amount <= 0)
        {
            errorMessage = "Please select account and enter amount.";
            return;
        }

        if (editingItem != null)
        {
            // Update existing item
            editingItem.Unit = selectedUnit;
            editingItem.Type = newEntry.Type;
            editingItem.AccountId = newEntry.AccountId;
            editingItem.AccountType = newEntry.AccountType;
            editingItem.AccountName = newEntry.AccountName;
            editingItem.PaymentType = newEntry.PaymentType;
            editingItem.Amount = newEntry.Amount;
            editingItem.Debit = newEntry.Type == "Debit" ? newEntry.Amount : 0;
            editingItem.Credit = newEntry.Type == "Credit" ? newEntry.Amount : 0;
            editingItem.RefNo = newEntry.RefNo;
            editingItem.Narration = newEntry.Narration;
            
            editingItem = null; // Exit edit mode
        }
        else
        {
            // Add new item
            var entryToAdd = new UIEntry
            {
                Unit = selectedUnit,
                Type = newEntry.Type,
                AccountId = newEntry.AccountId,
                AccountType = newEntry.AccountType,
                AccountName = newEntry.AccountName,
                PaymentType = newEntry.PaymentType,
                Amount = newEntry.Amount,
                Debit = newEntry.Type == "Debit" ? newEntry.Amount : 0,
                Credit = newEntry.Type == "Credit" ? newEntry.Amount : 0,
                RefNo = newEntry.RefNo,
                Narration = newEntry.Narration
            };
            uiEntries.Add(entryToAdd);
        }

        ClearNewEntry();
        errorMessage = null;
    }

    private void ClearNewEntry()
    {
        newEntry = new UIEntry { Type = "Credit", PaymentType = "" };
        editingItem = null; // Clear edit mode
    }

    private void RemoveEntry(UIEntry entry)
    {
        uiEntries.Remove(entry);
        if (editingItem == entry)
        {
            ClearNewEntry();
        }
    }

    private void EditEntry(UIEntry entry)
    {
        editingItem = entry; // Track editing item

        // Set type first
        EntryType = entry.Type;
        
        newEntry.AccountId = entry.AccountId;
        newEntry.AccountType = entry.AccountType;
        newEntry.AccountName = entry.AccountName;
        newEntry.PaymentType = entry.PaymentType;
        newEntry.Amount = entry.Amount;
        newEntry.RefNo = entry.RefNo;
        newEntry.Narration = entry.Narration;
        
        if (!string.IsNullOrEmpty(entry.Unit) && unitList.Contains(entry.Unit))
        {
            selectedUnit = entry.Unit;
        }

        // Do NOT remove from list
    }

    private void OnProfileChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int profileId))
        {
            selectedProfileId = profileId;
        }
        else
        {
            selectedProfileId = null;
        }
    }

    public async Task SubmitForm()
    {
        if (!IsBalanced)
        {
            errorMessage = "Entries are not balanced. (Debit must equal Credit)";
            return;
        }

        isSubmitting = true;
        errorMessage = null;

        model.Entries = uiEntries.Select(e => new ReceiptEntryItemModel
        {
            Type = e.Type,
            AccountId = e.AccountId,
            AccountType = e.AccountType,
            PaymentType = e.PaymentType,
            Amount = e.Amount,
            RefNoChequeUTR = e.RefNo,
            Narration = e.Narration,
            EntryForId = selectedProfileId,
            EntryForName = entryProfiles?.FirstOrDefault(p => p.Id == selectedProfileId)?.Name,
            Unit = e.Unit
        }).ToList();

        var result = IsEdit 
            ? await ReceiptService.UpdateReceiptVoucherAsync(VoucherNo!, model)
            : await ReceiptService.CreateMultipleReceiptsAsync(model);

        if (result.success)
        {
            if (OnSaved.HasDelegate)
            {
                await OnSaved.InvokeAsync();
            }
            else
            {
                Navigation.NavigateTo("/abraq/transactions/entries?noteType=Receipt");
            }
        }
        else
        {
            errorMessage = result.message;
        }
        isSubmitting = false;
    }

    private async Task Cancel()
    {
        if (OnSaved.HasDelegate)
        {
            await OnSaved.InvokeAsync();
        }
        else
        {
            Navigation.NavigateTo("/abraq/transactions/entries?noteType=Receipt");
        }
    }

    private class UIEntry
    {
        public string Type { get; set; } = "Credit";
        public int AccountId { get; set; }
        public string AccountType { get; set; } = "";
        public string AccountName { get; set; } = "";
        public string PaymentType { get; set; } = "";
        public decimal Amount { get; set; }
        public decimal Debit { get; set; }
        public decimal Credit { get; set; }
        public string RefNo { get; set; } = "";
        public string Narration { get; set; } = "";
        public string? Unit { get; set; }
    }
}
