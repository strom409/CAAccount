@using BlazorDemo.AbraqAccount.Models
@using BlazorDemo.AbraqAccount.Services.Interfaces
@inject IPurchaseMasterService PurchaseService
@inject NavigationManager Navigation

<div class="item-group-form-container">
    <!-- Header Section -->
    <div class="card shadow-sm border-0 mb-4 bg-white rounded-0 border-bottom">
        <div class="card-body py-3 d-flex justify-content-between align-items-center">
            <h5 class="m-0 fw-bold text-dark">Purchase Item Group - @(IsEdit ? "Edit" : "Add")</h5>
            <button class="btn btn-back" @onclick="Cancel"><i class="bi bi-arrow-left"></i></button>
        </div>
    </div>

    <!-- Main Card Section -->
    <div class="card shadow-sm border-0">
        <div class="card-body p-5">
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger mb-4">@errorMessage</div>
            }

            <div class="row mb-4">
                <div class="col-12">
                    <label class="form-label fw-bold">Inventory Item Group Name <span class="text-danger">*</span></label>
                    <input type="text" @bind="model.Name" class="form-control form-control-custom" placeholder="Enter Inventory Item Group Name" />
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-12">
                    <label class="form-label fw-bold">Status <span class="text-danger">*</span></label>
                    <div class="d-flex gap-4">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="statusActive" checked="@(model.IsActive)" @onclick="() => model.IsActive = true">
                            <label class="form-check-label" for="statusActive">Active</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="statusInactive" checked="@(!model.IsActive)" @onclick="() => model.IsActive = false">
                            <label class="form-check-label" for="statusInactive">Inactive</label>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="my-4 text-muted opacity-25" />

            <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-save px-4" @onclick="SubmitForm" disabled="@isSubmitting">
                    @if (isSubmitting) { <span class="spinner-border spinner-border-sm me-1"></span> }
                    Save
                </button>
                <button class="btn btn-cancel px-4" @onclick="Cancel">Cancel</button>
            </div>
        </div>
    </div>
</div>

<style>
    .item-group-form-container { background: #f4f7f6; min-height: 100vh; }
    .btn-back { background: #e9ecef; border: none; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; color: #6c757d; }
    .form-control-custom { border: 1px solid #ced4da; border-radius: 4px; padding: 10px 15px; font-size: 0.95rem; }
    .form-control-custom:focus { border-color: #6c757d; box-shadow: none; }
    .form-label { font-size: 0.9rem; color: #333; margin-bottom: 8px; }
    .btn-save { background: #6c757d; color: white; border: none; font-weight: 500; }
    .btn-cancel { background: #e9ecef; color: #333; border: none; font-weight: 500; }
    .btn-save:hover { background: #5a6268; color: white; }
    .btn-cancel:hover { background: #dde2e6; }
</style>

@code {
    [Parameter] public int? Id { get; set; }
    private PurchaseItemGroup model = new() { IsActive = true, CreatedAt = DateTime.Now };
    private bool IsEdit => Id.HasValue;
    private bool isSubmitting;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        if (IsEdit)
        {
            var existing = await PurchaseService.GetPurchaseItemGroupByIdAsync(Id!.Value);
            if (existing != null)
            {
                model = existing;
            }
            else
            {
                errorMessage = "Group not found.";
            }
        }
    }

    private async Task SubmitForm()
    {
        if (string.IsNullOrWhiteSpace(model.Name))
        {
            errorMessage = "Group Name is required.";
            return;
        }

        isSubmitting = true;
        errorMessage = null;

        var user = "Admin"; 
        var result = IsEdit 
            ? await PurchaseService.UpdatePurchaseItemGroupAsync(Id!.Value, model, user)
            : await PurchaseService.CreatePurchaseItemGroupAsync(model, user);

        if (result.success)
        {
            Navigation.NavigateTo("/abraq/inventory/item-groups");
        }
        else
        {
            errorMessage = result.message;
        }
        isSubmitting = false;
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/abraq/inventory/item-groups");
    }
}
