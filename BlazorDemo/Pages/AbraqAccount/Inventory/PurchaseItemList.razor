@page "/abraq/inventory/items"
@using BlazorDemo.AbraqAccount.Models
@using BlazorDemo.AbraqAccount.Services.Interfaces
@inject IPurchaseMasterService PurchaseService
@inject NavigationManager Navigation

<div class="content-header shadow-sm mb-4">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-sm-6">
                <h1 class="m-0 text-dark">Purchase Item <small class="text-muted fw-light" style="font-size: 0.6em;">Control panel</small></h1>
            </div>
            <div class="col-sm-6 text-end">
                <nav aria-label="breadcrumb" class="d-inline-block">
                    <ol class="breadcrumb bg-transparent p-0 m-0">
                        <li class="breadcrumb-item"><i class="bi bi-house-door me-1"></i>Home</li>
                        <li class="breadcrumb-item active">Purchase Item</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="card shadow-sm border-0 rounded-3 mb-4">
        <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0 text-primary">Purchase Item - <small class="text-muted fw-normal">List</small></h5>
            <div class="d-flex gap-2 align-items-center">
                <div class="search-box position-relative">
                    <input type="text" class="form-control form-control-sm pe-5" placeholder="Enter Search Criteria" 
                           @bind="searchTerm" @bind:event="oninput" @onkeyup="HandleSearch" style="width: 250px; border-radius: 4px;" />
                    <i class="bi bi-search position-absolute top-50 end-0 translate-middle-y me-2 text-muted"></i>
                </div>
                <button class="btn btn-dark btn-sm shadow-sm" style="border-radius: 4px; padding: 4px 10px;">
                    <i class="bi bi-file-earmark-excel"></i>
                </button>
                <button class="btn btn-secondary btn-sm shadow-sm" style="border-radius: 4px; padding: 4px 10px;" @onclick="CreateNew">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 custom-table">
                    <thead class="bg-light-blue py-2">
                        <tr>
                            <th class="ps-4">Vendor <i class="bi bi-arrow-down-up ms-1 small opacity-50"></i></th>
                            <th>Inventory Item Code <i class="bi bi-arrow-down-up ms-1 small opacity-50"></i></th>
                            <th>Inventory Item Group Name <i class="bi bi-arrow-down-up ms-1 small opacity-50"></i></th>
                            <th>Item Name <i class="bi bi-arrow-down-up ms-1 small opacity-50"></i></th>
                            <th>UOM <i class="bi bi-arrow-down-up ms-1 small opacity-50"></i></th>
                            <th>Actual Costing <i class="bi bi-arrow-down-up ms-1 small opacity-50"></i></th>
                            <th>GST <i class="bi bi-arrow-down-up ms-1 small opacity-50"></i></th>
                            <th class="text-center">Status</th>
                            <th class="text-center pe-4">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (items == null)
                        {
                            <tr><td colspan="9" class="text-center py-5"><div class="spinner-border spinner-border-sm text-primary"></div> Loading...</td></tr>
                        }
                        else if (!items.Any())
                        {
                            <tr><td colspan="9" class="text-center py-4 text-muted">No items found.</td></tr>
                        }
                        else
                        {
                            @foreach (var item in items)
                            {
                                <tr>
                                    <td class="ps-4">@(item.Vendor?.AccountName ?? "N/A")</td>
                                    <td>@item.Code</td>
                                    <td>@(item.PurchaseItemGroup?.Name ?? "N/A")</td>
                                    <td>@item.ItemName</td>
                                    <td>@item.UOM</td>
                                    <td>@item.PurchaseCostingPerNos.ToString("N2")</td>
                                    <td>@item.GST</td>
                                    <td class="text-center">
                                        @if (item.IsActive)
                                        {
                                            <i class="bi bi-check-circle-fill text-success fs-5"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-x-circle-fill text-danger fs-5"></i>
                                        }
                                    </td>
                                    <td class="text-center pe-4">
                                        <div class="action-buttons d-flex justify-content-center gap-2">
                                            <button class="btn btn-link btn-sm p-0 action-icon" @onclick="() => Edit(item.Id)" title="Edit">
                                                <i class="bi bi-pencil-square text-secondary fs-5"></i>
                                            </button>
                                            <button class="btn btn-link btn-sm p-0 action-icon" @onclick="() => ViewHistory(item)" title="View">
                                                <i class="bi bi-eye text-secondary fs-5"></i>
                                            </button>
                                            <button class="btn btn-link btn-sm p-0 action-icon" title="Info">
                                                <i class="bi bi-info-circle text-secondary fs-5"></i>
                                            </button>
                                            <button class="btn btn-link btn-sm p-0 action-icon" @onclick="() => Delete(item)" title="Delete">
                                                <i class="bi bi-trash text-danger fs-5"></i>
                                            </button>
                                            <button class="btn btn-link btn-sm p-0 action-icon" title="Add">
                                                <i class="bi bi-plus-lg text-danger fs-5"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@if (selectedItemForHistory != null)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5); z-index: 1050;">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold">History: @selectedItemForHistory.ItemName</h5>
                    <button type="button" class="btn-close" @onclick="CloseHistory"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-3">Action</th>
                                    <th>User</th>
                                    <th>Date</th>
                                    <th>Remarks</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (history == null)
                                {
                                    <tr><td colspan="4" class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></td></tr>
                                }
                                else
                                {
                                    @foreach (dynamic h in history)
                                    {
                                        <tr>
                                            <td class="ps-3">@h.action</td>
                                            <td>@h.user</td>
                                            <td>@h.dateTime</td>
                                            <td>@h.remarks</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer bg-light py-2">
                    <button type="button" class="btn btn-secondary btn-sm px-4" @onclick="CloseHistory">Close</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .content-header { background: #fff; padding: 0.75rem 0; margin-bottom: 0; }
    .breadcrumb-item { font-size: 0.85rem; color: #6c757d; }
    .breadcrumb-item + .breadcrumb-item::before { content: ">"; padding: 0 0.5rem; color: #adb5bd; }

    .card { border-radius: 8px; overflow: hidden; }
    .card-header .card-title { font-size: 1.1rem; font-weight: 500; }
    
    .bg-light-blue { background-color: #f8f9fa; }
    .custom-table thead th { 
        font-weight: 500; 
        font-size: 0.85rem; 
        color: #444; 
        border-top: none;
        padding: 12px 8px;
        white-space: nowrap;
    }
    .custom-table tbody td { 
        font-size: 0.85rem; 
        color: #555; 
        padding: 12px 8px;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .action-icon { transition: transform 0.2s; }
    .action-icon:hover { transform: scale(1.2); }
    
    .search-box input:focus { 
        border-color: #0d6efd; 
        box-shadow: 0 0 0 0.2rem rgba(13,110,253,0.1); 
    }
</style>

@code {
    private List<PurchaseItem>? items;
    private string searchTerm = "";
    private PurchaseItem? selectedItemForHistory;
    private IEnumerable<object>? history;

    protected override async Task OnInitializedAsync()
    {
        await LoadItems();
    }

    private async Task LoadItems()
    {
        items = await PurchaseService.GetPurchaseItemsAsync(searchTerm);
    }

    private async Task HandleSearch(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await LoadItems();
        }
    }

    private void CreateNew() => Navigation.NavigateTo("/abraq/inventory/items/create");
    private void Edit(int id) => Navigation.NavigateTo($"/abraq/inventory/items/edit/{id}");

    private async Task ViewHistory(PurchaseItem item)
    {
        selectedItemForHistory = item;
        history = null;
        history = await PurchaseService.GetPurchaseItemHistoryAsync(item.Id);
    }

    private void CloseHistory()
    {
        selectedItemForHistory = null;
        history = null;
    }

    private async Task Delete(PurchaseItem item)
    {
        var result = await PurchaseService.DeletePurchaseItemAsync(item.Id);
        if (result.success) await LoadItems();
    }
}
